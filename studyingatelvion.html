<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Elvion LMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Your Elvion University learning dashboard. Track progress, access courses, and update your profile." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ---------------------- 1. THEME & GLOBALS ---------------------- */
    :root {
      --cyan: #00ffff;
      --blue: #0090ff;
      --dark-blue: #0a1128;
      --card-bg: rgba(18,26,48,0.97);
      --header-bg: rgba(18,26,48,0.99);
      --border-glow: 0 0 11px var(--cyan), 0 0 24px var(--blue);
      --radius: 15px;
      --bg: #0a1128;
      --text: #e0e0e0;
      --muted: #a7b2c3;
      --success: #00ff88;
      --warning: #ffa500;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(120deg, #181d32 50%, #132142 100%);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      transition: margin-left .3s;
    }
    
    /* ---------------------- 2. HEADER & PROFILE ---------------------- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 24px 4vw 8px 4vw; background: var(--header-bg); 
      box-shadow: var(--border-glow); border-radius:0 0 28px 28px;
    }
    .title { font-family:Orbitron,sans-serif; font-size:1.63em; color:var(--cyan); text-shadow:var(--border-glow);}
    .profile {
      display:flex; align-items:center; gap:13px; 
      background: #181e36; border-radius:12px; padding:8px 17px;
      box-shadow: 0 0 16px 2px #00ffff07;
    }
    .profile-img {
      width:52px; height:52px; border-radius:50%; background:#232857;
      object-fit:cover; border:2px solid var(--cyan);
    }
    .profile-info b { color:var(--cyan);}
    .prof-actions { margin-left:14px; display: flex; gap: 7px;}
    .prof-actions button {
      background: none; border:none; color:var(--cyan); cursor:pointer;
      font-size:1.25em; opacity:.85; transition: opacity .2s;
      vertical-align: middle;
    }
    .prof-actions button:hover { opacity: 1; text-shadow: 0 0 5px var(--cyan);}
    
    /* ---------------------- 3. CURRENT LEARNING BANNER ---------------------- */
    .current-learning-banner {
      max-width:1060px; margin:28px auto 0 auto; padding:20px;
      background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,144,255,0.1) 100%);
      border-radius: var(--radius); border: 2px solid var(--cyan);
      box-shadow: var(--border-glow);
      display: none; /* Hidden until user has active course */
    }
    .current-learning-banner.active { display: block; }
    .banner-content {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 15px;
    }
    .banner-info h3 {
      font-family: Orbitron, sans-serif; color: var(--cyan);
      margin: 0 0 8px 0; font-size: 1.3em;
    }
    .banner-info p { margin: 5px 0; color: var(--muted); }
    .banner-progress {
      flex: 1; min-width: 200px; max-width: 400px;
    }
    .progress-bar-large {
      height: 12px; background: rgba(255,255,255,0.1);
      border-radius: 8px; overflow: hidden; margin: 8px 0;
    }
    .progress-fill-large {
      height: 100%; background: linear-gradient(90deg, var(--cyan), var(--blue));
      transition: width 0.5s ease-out; box-shadow: 0 0 8px var(--cyan);
    }
    .continue-btn {
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      color: #161d28; border: none; border-radius: 12px;
      padding: 12px 32px; font-size: 1.1em;
      font-family:'Orbitron',sans-serif; font-weight:700;
      cursor:pointer; box-shadow: 0 0 15px #00c3ff99;
      text-transform:uppercase; letter-spacing:.04em;
      transition: all .2s;
    }
    .continue-btn:hover { 
      background: var(--blue); color:#fff; 
      transform:scale(1.05); box-shadow: 0 0 25px var(--cyan);
    }
    
    /* ---------------------- 4. MAIN CONTENT & GRID ---------------------- */
    main { max-width:1060px; margin:20px auto 0 auto; padding:20px;}
    h2 { 
      font-family:Orbitron,sans-serif; color:var(--cyan); 
      margin-bottom:15px; font-size: 1.5em;
    }
    .section-description {
      color: var(--muted); margin-bottom: 25px; 
      font-size: 1.05em; line-height: 1.6;
    }
    .courses-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); 
      gap:2em; margin-bottom:28px;
    }
    .course-card {
      background: var(--card-bg); border-radius:var(--radius); 
      padding:20px 16px; box-shadow: var(--border-glow);
      display: flex; flex-direction:column; gap:13px;
      cursor: pointer; transition: all .2s;
      border:2.1px solid #131b30; position: relative;
    }
    .course-card:hover {
      box-shadow: 0 0 22px var(--cyan),0 0 44px #00c2ff49;
      border:2.1px solid var(--cyan);
      transform: scale(1.02); z-index:4;
    }
    .course-card.completed { 
      border-color: var(--success); 
      box-shadow: 0 0 10px #00ff8855; 
    }
    .course-card.locked {
      opacity: 0.5; cursor: not-allowed;
      filter: grayscale(50%);
    }
    .course-card.locked:hover {
      transform: none; box-shadow: var(--border-glow);
    }

    .course-header { 
      display: flex; align-items: center; 
      justify-content: space-between; 
    }
    .course-title {
      font-size:1.19em; font-weight:700; color:#fff; 
      font-family:Orbitron,sans-serif; 
    }
    .course-icon { font-size: 1.5em; color: var(--cyan); }
    .course-intro {font-size:.97em; color:var(--muted); flex-grow: 1;}
    .course-meta { font-size:.92em; color:var(--cyan);}
    .course-duration {
      font-size: 0.85em; color: var(--warning);
      margin-top: 5px; font-weight: 600;
    }
    
    /* Lock Badge */
    .lock-badge {
      position: absolute; top: 15px; right: 15px;
      background: rgba(255,165,0,0.2); color: var(--warning);
      padding: 5px 12px; border-radius: 20px;
      font-size: 0.75em; font-weight: 700;
      border: 1px solid var(--warning);
      display: none;
    }
    .course-card.locked .lock-badge { display: block; }
    
    /* PROGRESS BAR STYLES */
    .progress-container {
      height: 7px; background: rgba(255, 255, 255, 0.1);
      border-radius: 5px; margin-top: 5px;
      overflow: hidden; margin-bottom: 7px;
    }
    .progress-bar {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      transition: width 0.5s ease-out;
      box-shadow: 0 0 5px var(--cyan);
    }
    .progress-text {
      font-size: 0.9em; font-weight: 600;
      color: var(--cyan); text-align: right;
      font-family: Orbitron, sans-serif;
    }

    /* START BUTTON */
    .start-btn {
      margin-top:9px;
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      color: #161d28; border: none; border-radius: 12px; 
      padding: 10px 0; font-size: 1em; 
      font-family:'Orbitron',sans-serif; font-weight:700; 
      cursor:pointer; box-shadow: 0 0 13px #00c3ff99;
      text-transform:uppercase; letter-spacing:.04em;
      transition: all .15s;
    }
    .start-btn:hover { 
      background: var(--blue); color:#fff; transform:scale(1.02);
    }
    .start-btn:active { transform:scale(0.99);}
    .course-card.locked .start-btn {
      background: #333; color: #666; cursor: not-allowed;
      box-shadow: none;
    }
    .course-card.locked .start-btn:hover {
      background: #333; transform: none;
    }
    
    /* ---------------------- 5. EDIT MODAL ---------------------- */
    .edit-modal-bg {
      position: fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(5,19,38,.85); display:none; 
      align-items:center; justify-content:center; z-index:5000;
    }
    .edit-modal {
      background:rgba(18,27,38,0.99); color:#e0e0e0; 
      border-radius:14px; padding:27px 21px; min-width:320px;
      box-shadow:0 0 30px #00fff2,0 0 12px #0071cf55; 
      position:relative; max-width:500px; width: 90%;
    }
    .edit-modal h3 {
      color:var(--cyan); text-align:center; margin-top:0;
      font-family: Orbitron, sans-serif;
    }
    .edit-modal label {
      color:var(--cyan); font-family:Orbitron,sans-serif;
      font-size:.97em; margin-bottom:3px; display:block;
      margin-top: 10px;
    }
    .edit-modal input,.edit-modal textarea{
      width:100%; padding:10px; border-radius:8px; 
      border:1.5px solid #274355;
      background:#131c2c; color:#f5f5f5; 
      font-size:1em; font-family:Inter,sans-serif;
      margin-bottom:13px;
    }   
    .edit-modal .btns { 
      text-align:right; margin-top:15px; display: flex;
      gap: 10px; justify-content: flex-end;
    }
    .edit-modal .btns button {
      background:var(--cyan); color:#222; border:none; 
      border-radius:7px; font-family:Orbitron,sans-serif;
      padding:10px 24px; font-weight:700; 
      text-transform:uppercase; font-size: 0.95em; 
      letter-spacing:.04em; box-shadow:0 0 4px #0fffff60; 
      cursor:pointer; transition:all .15s;
    }
    .edit-modal .btns button:hover {
      background: var(--blue); color: #fff;
    }
    .edit-modal .btns button.cancel {
      background:#19243c; color:#aee;
    }
    .edit-modal .btns button.cancel:hover {
      background: #243044;
    }
    .edit-close {
      position:absolute; right:14px; top:14px;
      font-size:1.7em; color:#00ffff; cursor:pointer;
      transition: transform .2s;
    }
    .edit-close:hover { transform: rotate(90deg); }
    
    /* ---------------------- 6. RESPONSIVENESS ---------------------- */
    @media (max-width:768px){ 
      header {flex-direction: column; gap: 15px; text-align: center;}
      .banner-content {flex-direction: column;}
      .courses-grid {grid-template-columns: 1fr;}
    }
    @media (max-width:650px){ 
      header, main {padding:13px!important;}
    }
    @media (max-width:410px){ 
      .profile-img{width:38px;height:38px;} 
      .edit-modal{padding:4vw;}
    }

    /* ---------------------- 7. STARS BACKGROUND ---------------------- */
    #stars-container {
      position: fixed; width: 100%; height: 100%; 
      top: 0; left: 0; z-index: -1;
    }
    .star {
      position: absolute; background: #fff; border-radius: 50%; 
      box-shadow: 0 0 4px 1px var(--cyan);
      opacity: 0; animation: blink 2s infinite alternate;
    }
    @keyframes blink { 
      0% { opacity: 0; } 
      50% { opacity: 1; } 
      100% { opacity: 0; }
    }

    /* ---------------------- 8. LOADING SPINNER ---------------------- */
    .spinner {
      border: 3px solid rgba(0,255,255,0.1);
      border-top: 3px solid var(--cyan);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin: 50px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
<div id="stars-container"></div>

<header>
  <span class="title">ELVION LMS</span>
  <div class="profile">
    <img id="profile-img" src="https://i.pravatar.cc/150?img=12" class="profile-img" alt="profile image" />
    <div class="profile-info">
      <div><b id="displayName">Loading...</b></div>
      <small style="color:#aee;" id="user-email">user@elvion.edu</small>
    </div>
    <div class="prof-actions">
      <button title="Notifications"><i class="fa fa-bell"></i></button>
      <button title="Edit profile" id="edit-profile-btn"><i class="fa fa-user-edit"></i></button>
      <button title="Logout" id="logout-btn"><i class="fa fa-sign-out-alt"></i></button>
    </div>
  </div>
</header>

<!-- Current Learning Banner -->
<div class="current-learning-banner" id="current-learning-banner">
  <div class="banner-content">
    <div class="banner-info">
      <h3><i class="fa fa-graduation-cap"></i> Continue Your Learning Journey</h3>
      <p><strong id="current-course-name">Course Name</strong></p>
      <p id="current-progress-text">Week 1, Day 1 of 7</p>
    </div>
    <div class="banner-progress">
      <div class="progress-text" id="banner-progress-percentage">0%</div>
      <div class="progress-bar-large">
        <div class="progress-fill-large" id="banner-progress-fill"></div>
      </div>
    </div>
    <button class="continue-btn" id="continue-learning-btn">
      <i class="fa fa-play-circle"></i> Continue Learning
    </button>
  </div>
</div>

<main>
  <h2>Learning Path</h2>
  <p class="section-description">
    Progress through courses sequentially, one week at a time. Complete each course to unlock the next.
  </p>

  <div id="loading-spinner" class="spinner"></div>
  <div class="courses-grid" id="courses-grid" style="display:none;"></div>
</main>

<!-- Edit Profile Modal -->
<div class="edit-modal-bg" id="edit-modal-bg">
  <form class="edit-modal" id="edit-modal" onsubmit="return false;">
    <span class="edit-close" id="modal-close-btn">&times;</span>
    <h3>Edit Profile</h3>
    <label for="edit-name">Name</label>
    <input type="text" id="edit-name" required>
    <label for="edit-photo">Photo URL</label>
    <input type="url" id="edit-photo" placeholder="https://link.to/photo.jpg">
    <label for="edit-dob">Date of Birth</label>
    <input type="date" id="edit-dob">
    <label for="edit-bio">Bio/About Me</label>
    <textarea id="edit-bio" rows="3" placeholder="A few words about you"></textarea>
    <div class="btns">
      <button type="button" class="cancel" id="cancel-profile-btn">Cancel</button>
      <button type="button" id="save-profile-btn">Save</button>
    </div>
  </form>
</div>

<script type="module">
  // ================= STAR BACKGROUND =================
  document.addEventListener('DOMContentLoaded', () => {
    const starsContainer = document.getElementById('stars-container');
    const numStars = 50, minSize = 1, maxSize = 2.5;
    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * (maxSize - minSize) + minSize;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 4) + 's';
      star.style.animationDuration = (2.4 + Math.random() * 1.8) + 's';
      starsContainer.appendChild(star);
    }
  });

  // ================= FIREBASE SETUP =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.firebasestorage.app",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ================= COURSE STRUCTURE =================
  const courses = [
    { 
      key: "cs101", 
      title: "Introduction to Programming", 
      intro: "Learn programming fundamentals, algorithms, and problem-solving with Python.", 
      code: "CSC 101", 
      meta: "Computer Science", 
      icon: "fa-laptop-code",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs102", 
      title: "Data Structures", 
      intro: "Master arrays, linked lists, stacks, queues, trees, and graphs.", 
      code: "CSC 102", 
      meta: "Computer Science", 
      icon: "fa-project-diagram",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs201", 
      title: "Object-Oriented Programming", 
      intro: "Deep dive into OOP concepts: classes, inheritance, polymorphism, and design patterns.", 
      code: "CSC 201", 
      meta: "Computer Science", 
      icon: "fa-cube",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs202", 
      title: "Database Systems", 
      intro: "SQL, database design, normalization, transactions, and modern NoSQL databases.", 
      code: "CSC 202", 
      meta: "Computer Science", 
      icon: "fa-database",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs301", 
      title: "Software Engineering", 
      intro: "SDLC, agile methodologies, testing, version control, and project management.", 
      code: "CSC 301", 
      meta: "Computer Science", 
      icon: "fa-code-branch",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs302", 
      title: "Computer Networks", 
      intro: "Network protocols, TCP/IP, routing, switching, and network security fundamentals.", 
      code: "CSC 302", 
      meta: "Computer Science", 
      icon: "fa-network-wired",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs401", 
      title: "Artificial Intelligence", 
      intro: "Machine learning, neural networks, natural language processing, and AI ethics.", 
      code: "CSC 401", 
      meta: "Computer Science", 
      icon: "fa-brain",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "cs402", 
      title: "Final Year Project", 
      intro: "Apply all your knowledge to build a comprehensive software project from scratch.", 
      code: "CSC 402", 
      meta: "Computer Science", 
      icon: "fa-rocket",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "law101", 
      title: "Constitutional Law", 
      intro: "Study constitutional principles, government structure, and fundamental rights.", 
      code: "LAW 101", 
      meta: "Faculty of Law", 
      icon: "fa-scale-balanced",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "eng101", 
      title: "English & Literary Studies", 
      intro: "Explore English structure, world literature, and creative writing techniques.", 
      code: "ENG 101", 
      meta: "Arts & Humanities", 
      icon: "fa-book-open-reader",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "his101", 
      title: "History & Strategic Studies", 
      intro: "Modern world history, military strategy, and global affairs analysis.", 
      code: "HIS 101", 
      meta: "Arts & Humanities", 
      icon: "fa-landmark",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "mass101", 
      title: "Mass Communication", 
      intro: "Broadcasting, journalism, public relations, and media production fundamentals.", 
      code: "MASS 101", 
      meta: "Social Sciences", 
      icon: "fa-satellite-dish",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "bus101", 
      title: "Business Administration", 
      intro: "Management principles, entrepreneurship, finance, and strategic planning.", 
      code: "BUS 101", 
      meta: "Social Sciences", 
      icon: "fa-chart-line",
      weeks: 1,
      daysPerWeek: 7
    },
    { 
      key: "swe101", 
      title: "Software Engineering Fundamentals", 
      intro: "Requirements analysis, design patterns, testing strategies, and software lifecycle.", 
      code: "SWE 101", 
      meta: "Software Engineering", 
      icon: "fa-tools",
      weeks: 1,
      daysPerWeek: 7
    }
  ];

  // ================= GLOBAL STATE =================
  let currentUser = null;
  let userDocRef = null;
  let userProgress = {
    currentCourseIndex: 0,
    currentWeek: 1,
    currentDay: 1,
    completedCourses: []
  };

  // ================= USER PROGRESS FUNCTIONS =================
  async function loadUserProgress() {
    if (!currentUser || currentUser.uid === "demo-user") {
      // Demo mode - use localStorage
      const saved = localStorage.getItem('elvion_progress');
      if (saved) {
        userProgress = JSON.parse(saved);
      }
      return;
    }

    try {
      const progressDoc = await getDoc(doc(db, "userProgress", currentUser.uid));
      if (progressDoc.exists()) {
        userProgress = progressDoc.data();
      } else {
        // Initialize progress for new user
        await setDoc(doc(db, "userProgress", currentUser.uid), userProgress);
      }
    } catch (error) {
      console.error("Error loading progress:", error);
    }
  }

  async function saveUserProgress() {
    if (!currentUser || currentUser.uid === "demo-user") {
      localStorage.setItem('elvion_progress', JSON.stringify(userProgress));
      return;
    }

    try {
      await setDoc(doc(db, "userProgress", currentUser.uid), userProgress);
    } catch (error) {
      console.error("Error saving progress:", error);
    }
  }

  function calculateCourseProgress(courseIndex) {
    if (userProgress.completedCourses.includes(courseIndex)) {
      return 100;
    }
    if (courseIndex === userProgress.currentCourseIndex) {
      const course = courses[courseIndex];
      const totalDays = course.weeks * course.daysPerWeek;
      const completedDays = (userProgress.currentWeek - 1) * course.daysPerWeek + (userProgress.currentDay - 1);
      return Math.min(Math.round((completedDays / totalDays) * 100), 99);
    }
    return 0;
  }

  function isCourseUnlocked(courseIndex) {
    return courseIndex === 0 || userProgress.completedCourses.includes(courseIndex - 1);
  }

  // ================= RENDER FUNCTIONS =================
  function renderCourses() {
    const grid = document.getElementById("courses-grid");
    const spinner = document.getElementById("loading-spinner");
    
    grid.innerHTML = courses.map((course, index) => {
      const progress = calculateCourseProgress(index);
      const isUnlocked = isCourseUnlocked(index);
      const isCompleted = userProgress.completedCourses.includes(index);
      const isCurrent = index === userProgress.currentCourseIndex;
      
      let statusClass = '';
      let buttonText = 'Start Course';
      
      if (isCompleted) {
        statusClass = 'completed';
        buttonText = 'Review Course';
      } else if (isCurrent) {
        statusClass = 'in-progress';
        buttonText = 'Continue';
      } else if (!isUnlocked) {
        statusClass = 'locked';
        buttonText = 'Locked';
      }

      return `
        <div class="course-card ${statusClass}" data-index="${index}">
          <span class="lock-badge"><i class="fa fa-lock"></i> Locked</span>
          <div class="course-header">
            <div class="course-title">${course.title}</div>
            <i class="fa ${course.icon} course-icon" title="${course.meta}"></i>
          </div>
          <div class="course-meta">${course.code} &middot; ${course.meta}</div>
          <div class="course-duration">
            <i class="fa fa-clock"></i> ${course.weeks} Week • ${course.daysPerWeek} Days
          </div>
          <div class="progress-text">${isCompleted ? 'Completed!' : progress + '% Complete'}</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${progress}%;"></div>
          </div>
          <div class="course-intro">${course.intro}</div>
          <button class="start-btn" data-index="${index}" ${!isUnlocked ? 'disabled' : ''}>
            ${buttonText}
          </button>
        </div>
      `;
    }).join('');
    
    spinner.style.display = 'none';
    grid.style.display = 'grid';
    
    // Attach event listeners
    document.querySelectorAll('.start-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(btn.dataset.index);
        if (isCourseUnlocked(index)) {
          startCourse(index);
        }
      });
    });
  }

  function updateCurrentLearningBanner() {
    const banner = document.getElementById('current-learning-banner');
    const currentCourse = courses[userProgress.currentCourseIndex];
    
    if (userProgress.currentCourseIndex < courses.length && 
        !userProgress.completedCourses.includes(userProgress.currentCourseIndex)) {
      
      banner.classList.add('active');
      document.getElementById('current-course-name').textContent = 
        `${currentCourse.title} (${currentCourse.code})`;
      
      const progressText = `Week ${userProgress.currentWeek}, Day ${userProgress.currentDay} of ${currentCourse.daysPerWeek}`;
      document.getElementById('current-progress-text').textContent = progressText;
      
      const progress = calculateCourseProgress(userProgress.currentCourseIndex);
      document.getElementById('banner-progress-percentage').textContent = progress + '%';
      document.getElementById('banner-progress-fill').style.width = progress + '%';
      
    } else {
      banner.classList.remove('active');
    }
  }

  function startCourse(index) {
    const course = courses[index];
    // Redirect to lessons page with course info
    window.location.href = `lessons.html?course=${course.key}&week=${userProgress.currentWeek}&day=${userProgress.currentDay}`;
  }

  // ================= AUTH & PROFILE =================
  onAuthStateChanged(auth, async user => {
    if (!user) {
      // Demo mode for testing
      currentUser = { 
        uid: "demo-user", 
        displayName: "Demo Student", 
        email: "demo@elvion.edu", 
        photoURL: 'https://i.pravatar.cc/150?img=12' 
      };
    } else {
      currentUser = user;
      userDocRef = doc(db, "users", user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const extra = snap.data();
        document.getElementById('edit-dob').value = extra.dob || "";
        document.getElementById('edit-bio').value = extra.bio || "";
      }
    }
    
    document.getElementById("displayName").textContent = 
      currentUser.displayName || currentUser.email.split('@')[0];
    document.getElementById("user-email").textContent = currentUser.email || "";
    document.getElementById("profile-img").src = 
      currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||'User')}&background=0a1128&color=00ffff&bold=true&rounded=true&size=128`;
    
    await loadUserProgress();
    updateCurrentLearningBanner();
    renderCourses();
  });

  // Continue Learning Button
  document.getElementById('continue-learning-btn').addEventListener('click', () => {
    startCourse(userProgress.currentCourseIndex);
  });

  // Logout
  document.getElementById('logout-btn').addEventListener('click', () => {
    if (currentUser.uid === "demo-user") {
      alert("Logged out! (Demo mode)");
      location.reload();
    } else {
      signOut(auth).then(() => {
        window.location.href = "enroll.html";
      });
    }
  });

  // ================= PROFILE MODAL =================
  const modalBg = document.getElementById('edit-modal-bg');
  const editName = document.getElementById('edit-name');
  const editPhoto = document.getElementById('edit-photo');

  function openEditModal() {
    modalBg.style.display = "flex";
    editName.value = currentUser.displayName || "";
    editPhoto.value = currentUser.photoURL || "";
    editName.focus();
  }
  
  function closeEditModal() {
    modalBg.style.display = "none";
  }

  document.getElementById('edit-profile-btn').addEventListener('click', openEditModal);
  document.getElementById('modal-close-btn').addEventListener('click', closeEditModal);
  document.getElementById('cancel-profile-btn').addEventListener('click', closeEditModal);

  document.getElementById('save-profile-btn').addEventListener('click', async () => {
    const name = editName.value.trim();
    const photo = editPhoto.value.trim();
    const dob = document.getElementById('edit-dob').value;
    const bio = document.getElementById('edit-bio').value.trim();
    
    const saveButton = document.getElementById('save-profile-btn');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    try {
      if (currentUser.uid !== "demo-user") {
        await updateProfile(currentUser, {
          displayName: name || currentUser.displayName,
          photoURL: photo || currentUser.photoURL
        });
        await setDoc(userDocRef, { 
          name, dob, bio, photoURL: photo, 
          email: currentUser.email, 
          updatedAt: new Date()
        }, { merge: true });
      }

      document.getElementById('displayName').textContent = name;
      document.getElementById('profile-img').src = photo || document.getElementById('profile-img').src;

      closeEditModal();
      alert('Profile updated successfully!');
    } catch(error) {
      console.error("Error saving profile:", error);
      alert("Failed to save profile.");
    } finally {
      saveButton.textContent = 'Save';
      saveButton.disabled = false;
    }
  });

</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
