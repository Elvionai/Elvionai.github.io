<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Developer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #00ffff; --secondary: #ff00ff; --bg-dark: #050a14;
      --glass-bg: rgba(16, 24, 45, 0.85); --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff; --text-muted: #94a3b8; --success: #00e676; --danger: #ff1744; --warning: #ffae42;
    }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; overflow-x: hidden; }
    #stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--duration) linear infinite; opacity: 0; }
    @keyframes twinkle { 0% { opacity: 0; } 50% { opacity: 0.8; } 100% { opacity: 0; } }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand img { width: 50px; height: 50px; border-radius: 12px; }
    .brand h1 { font-family: 'Orbitron'; font-size: 1.5rem; margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .user-info { display: flex; align-items: center; gap: 20px; }
    .logout-btn { background: rgba(255, 23, 68, 0.1); color: var(--danger); border: 1px solid rgba(255, 23, 68, 0.3); padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: 600; }
    .logout-btn:hover { background: var(--danger); color: white; }

    .card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 25px; margin-bottom: 30px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-family: 'Orbitron'; font-size: 1.2rem; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 10px; }

    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
    .metric-box { display: flex; flex-direction: column; gap: 5px; }
    .metric-value { font-family: 'Orbitron'; font-size: 2.5rem; font-weight: 700; color: white; }
    
    .btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #000; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px rgba(0, 255, 255, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 12px; }
    .btn-outline:hover { background: rgba(0, 255, 255, 0.1); }

    .table-container { overflow-x: auto; max-height: 400px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; color: var(--primary); font-family: 'Orbitron'; font-size: 0.85rem; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; background: rgba(16, 24, 45, 0.95); z-index: 2; }
    td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: var(--text-muted); font-size: 0.9rem; }
    
    .amount-positive { color: var(--success); font-family: 'Orbitron'; font-weight: bold; }
    .amount-negative { color: var(--danger); font-family: 'Orbitron'; font-weight: bold; }

    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-active { background: rgba(0, 230, 118, 0.15); color: var(--success); }
    .badge-revoked { background: rgba(255, 23, 68, 0.15); color: var(--danger); }

    .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .admin-box { background: rgba(255, 174, 66, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 174, 66, 0.2); }
    input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 10px; border-radius: 6px; width: 100%; margin-top: 10px; }

    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: rgba(16, 24, 45, 0.95); border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; min-width: 300px; animation: slideIn 0.3s; backdrop-filter: blur(10px); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal { background: #0f1623; border: 1px solid var(--primary); padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; position: relative; animation: popIn 0.3s; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: white; cursor: pointer; font-size: 1.5rem; }
    .key-display { background: black; padding: 15px; border-radius: 8px; font-family: monospace; color: var(--secondary); word-break: break-all; margin: 20px 0; }
    
    .loader { width: 20px; height: 20px; border: 2px solid white; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    .btn.loading .loader { display: inline-block; }
    .btn.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) { .metrics, .admin-controls { grid-template-columns: 1fr; } header { flex-direction: column; text-align: center; gap: 15px; } }
  </style>
</head>
<body>

<div id="stars"></div>
<div id="toast-container"></div>

<div class="container">
  <header>
    <div class="brand">
      <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Logo">
      <h1>Developer Console</h1>
    </div>
    <div class="user-info">
      <span style="color:var(--text-muted);" id="user-email">Loading...</span>
      <button class="logout-btn" id="logout-btn"><i class="fas fa-power-off"></i></button>
    </div>
  </header>

  <!-- Metrics -->
  <div class="card">
    <div class="metrics">
      <div class="metric-box">
        <span style="color:var(--text-muted); text-transform:uppercase; font-size:0.8rem;">Available Credits</span>
        <span class="metric-value" id="balance-display">...</span>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn" id="fund-wallet-btn">
              <i class="fas fa-bolt"></i> Fund Wallet
            </button>
            <button class="btn btn-outline" id="transfer-btn" style="padding: 12px;">
              <i class="fas fa-paper-plane"></i> Transfer
            </button>
        </div>
      </div>
      <div class="metric-box" style="align-items: flex-end; text-align: right;">
        <span style="color:var(--text-muted); text-transform:uppercase; font-size:0.8rem;">Active Keys</span>
        <span class="metric-value" id="active-keys-display">...</span>
      </div>
    </div>
  </div>

  <!-- Real-Time Activity History (Fix for Problems 2 & 3) -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-history"></i> Activity Feed</h3>
      <button class="btn-outline" onclick="loadAllData()" title="Refresh Data">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    <div class="table-container">
      <table id="activity-table">
        <thead>
          <tr>
            <th>Action / Service</th>
            <th>Amount (Cr)</th>
            <th>Timestamp (UTC)</th>
          </tr>
        </thead>
        <tbody id="activity-list">
          <!-- JS will render rows here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- API Keys -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-key"></i> API Keys</h3>
      <button class="btn" id="generate-key-btn">
        <span class="btn-text">New Key (100 Cr)</span><div class="loader"></div>
      </button>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Key</th><th>Status</th><th>Created</th><th>Action</th></tr></thead>
        <tbody id="key-list"><tr><td colspan="4" style="text-align:center;">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Admin -->
  <div class="card" id="admin-panel" style="display: none; border-color: var(--warning);">
    <div class="card-header"><h3 class="card-title" style="color: var(--warning);"><i class="fas fa-user-shield"></i> Admin</h3></div>
    <div class="admin-controls">
      <div class="admin-box">
        <h4 style="color: var(--warning); margin-top: 0;">Self Refill</h4>
        <button class="btn" id="grant-self-btn" style="background: var(--warning); width: 100%; margin-top:10px;">
          <span class="btn-text">Set 100k Balance</span><div class="loader"></div>
        </button>
      </div>
      <div class="admin-box">
        <h4 style="color: var(--primary); margin-top: 0;">Gift User</h4>
        <input type="email" id="gift-email" placeholder="Email">
        <input type="number" id="gift-amount" placeholder="Amount">
        <button class="btn btn-outline" id="gift-btn" style="width: 100%; margin-top: 10px;">
          <span class="btn-text">Send</span><div class="loader"></div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="payment-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('payment-modal')">&times;</button>
    <h3><i class="fas fa-wallet"></i> Fund Wallet</h3>
    <p style="color: var(--text-muted);">Secure payment via Korapay. 1 Credit = ₦1.</p>
    <div style="margin: 20px 0;">
      <label style="color: var(--primary); font-size: 0.8rem;">Amount (₦)</label>
      <input type="number" id="fund-amount" value="1000" min="100" style="font-size: 1.5rem; text-align: center;">
    </div>
    <button class="btn" id="proceed-pay-btn" style="width: 100%;">
      <span class="btn-text">Proceed to Checkout</span><div class="loader"></div>
    </button>
  </div>
</div>

<div class="modal-overlay" id="transfer-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('transfer-modal')">&times;</button>
    <h3><i class="fas fa-paper-plane"></i> Transfer Credits</h3>
    <p style="color: var(--text-muted);">Gift credits to another Elvion AI developer.</p>
    <div style="margin: 20px 0;">
      <label>Recipient Email</label>
      <input type="email" id="transfer-email" placeholder="friend@example.com">
      <label>Amount to Send</label>
      <input type="number" id="transfer-amount" placeholder="e.g., 500">
    </div>
    <button class="btn" id="proceed-transfer-btn" style="width: 100%;">
      <span class="btn-text">Confirm & Send</span><div class="loader"></div>
    </button>
  </div>
</div>

<div class="modal-overlay" id="key-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('key-modal')">&times;</button>
    <h3><i class="fas fa-check-circle" style="color: var(--success);"></i> Key Generated</h3>
    <div class="key-display" id="new-key-text"></div>
    <button class="btn" id="copy-key-btn" style="width: 100%;">Copy & Close</button>
  </div>
</div>

<script type="module">
  const BACKEND_URL = "https://web-production-9a18.up.railway.app";
  const ADMIN_EMAIL = "koladhino@gmail.com";
  
  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  let userToken = null;

  const dom = {
    balance: document.getElementById('balance-display'),
    activeKeys: document.getElementById('active-keys-display'),
    activityList: document.getElementById('activity-list'),
    keyList: document.getElementById('key-list'),
    email: document.getElementById('user-email'),
    adminPanel: document.getElementById('admin-panel')
  };

  onIdTokenChanged(auth, async (user) => {
    if (user) {
      userToken = await user.getIdToken(true);
      dom.email.textContent = user.email;
      if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) dom.adminPanel.style.display = 'block';
      
      // Load all dashboard data
      await loadAllData();
      
      // CRITICAL: Check for payment redirect on page load
      checkPaymentReturn();
      
      window.loadAllData = loadAllData;
    } else {
      window.location.href = 'developer-login.html';
    }
  });

  document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

  async function apiCall(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json', 'X-Firebase-Token': userToken };
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    const res = await fetch(`${BACKEND_URL}${endpoint}`, config);
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Request failed');
    return data;
  }

  async function loadAllData() {
    try {
      const [metrics, activity] = await Promise.all([
        apiCall('/api/user/keys-and-balance'),
        apiCall('/api/user/activity') // Use the new combined endpoint
      ]);

      dom.balance.textContent = (metrics.balance || 0).toLocaleString();
      dom.activeKeys.textContent = metrics.keys.filter(k => k.is_active).length;
      renderKeys(metrics.keys);
      renderActivity(activity.activity);
    } catch (e) {
      console.error(e);
      showToast('Dashboard sync failed: ' + e.message, 'error');
    }
  }

  function renderKeys(keys) {
    dom.keyList.innerHTML = '';
    if (!keys.length) return dom.keyList.innerHTML = '<tr><td colspan="4" style="text-align:center;">No keys found.</td></tr>';
    keys.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    keys.forEach(k => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="font-family:monospace; color:var(--secondary);">${k.api_key.slice(0, 8)}...${k.api_key.slice(-4)}</td>
        <td><span class="badge ${k.is_active ? 'badge-active' : 'badge-revoked'}">${k.is_active ? 'Active' : 'Revoked'}</span></td>
        <td>${new Date(k.created_at).toLocaleDateString()}</td>
        <td>${k.is_active ? `<button class="btn-outline" onclick="revokeKey('${k.api_key}')" style="padding:4px 8px; font-size:0.7rem;">Revoke</button>` : '-'}</td>
      `;
      dom.keyList.appendChild(row);
    });
  }
  
  // FIX FOR PROBLEM 2 & 3: Renders the combined activity feed
  function renderActivity(logs) {
    dom.activityList.innerHTML = '';
    if (!logs || !logs.length) {
      dom.activityList.innerHTML = '<tr><td colspan="3" style="text-align:center;">No recent activity.</td></tr>';
      return;
    }
    logs.forEach(log => {
      const isCredit = log.amount > 0;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="color: var(--text-main); font-weight: 500;">${log.description}</td>
        <td class="${isCredit ? 'amount-positive' : 'amount-negative'}">
            ${isCredit ? '+' : ''} ${log.amount.toLocaleString()} Cr
        </td>
        <td style="font-size: 0.85rem;">${new Date(log.timestamp).toLocaleString()}</td>
      `;
      dom.activityList.appendChild(row);
    });
  }

  // --- ACTIONS ---
  const genBtn = document.getElementById('generate-key-btn');
  genBtn.addEventListener('click', async () => {
    setLoading(genBtn, true);
    try {
      const res = await apiCall('/api/user/create-api-key', 'POST');
      document.getElementById('new-key-text').textContent = res.api_key;
      openModal('key-modal');
      await loadAllData();
      showToast('Key Generated (-100 Credits)', 'success');
    } catch (e) { showToast(e.message, 'error'); }
    finally { setLoading(genBtn, false); }
  });

  window.revokeKey = async function(key) {
    if(!confirm("Are you sure you want to revoke this key? This action is permanent.")) return;
    try { 
      await apiCall('/api/user/revoke-api-key', 'POST', { api_key: key }); 
      await loadAllData(); 
      showToast('API Key has been revoked.', 'success'); 
    } catch (e) { showToast(e.message, 'error'); }
  }

  document.getElementById('grant-self-btn').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    setLoading(btn, true);
    try { 
      const res = await apiCall('/api/admin/grant-credits', 'POST'); 
      await loadAllData(); 
      showToast(res.message, 'success'); 
    } catch(err) { showToast(err.message, 'error'); }
    finally { setLoading(btn, false); }
  });

  document.getElementById('gift-btn').addEventListener('click', async (e) => {
    const email = document.getElementById('gift-email').value;
    const amount = parseInt(document.getElementById('gift-amount').value);
    if(!email || !amount) return showToast('Email and amount are required.', 'error');
    const btn = e.target.closest('button');
    setLoading(btn, true);
    try { 
      const res = await apiCall('/api/admin/gift-credits', 'POST', { target_email: email, amount }); 
      showToast(res.message, 'success'); 
      document.getElementById('gift-email').value = '';
      document.getElementById('gift-amount').value = '';
    } catch(err) { showToast(err.message, 'error'); }
    finally { setLoading(btn, false); }
  });

  // FIX FOR PROBLEM 1: Payment logic
  document.getElementById('proceed-pay-btn').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    const amount = parseInt(document.getElementById('fund-amount').value);
    if(amount < 100) return showToast('Minimum funding is ₦100.', 'error');
    
    setLoading(btn, true);
    try {
      const res = await apiCall('/api/payments/initiate', 'POST', { amount });
      showToast('Redirecting to secure checkout...', 'success');
      window.location.href = res.checkout_url;
    } catch(e) { 
      showToast(e.message, 'error'); 
      setLoading(btn, false); 
    }
  });

  async function checkPaymentReturn() {
    const params = new URLSearchParams(window.location.search);
    const ref = params.get('reference') || params.get('trxref');
    if (ref) {
      window.history.replaceState({}, document.title, window.location.pathname);
      showToast('Verifying your payment, please wait...', 'warning');
      try {
        const res = await apiCall(`/api/payments/verify?transaction_ref=${ref}`);
        if(res.status === 'success') {
          showToast(`Payment successful! ${res.credits_added} credits added.`, 'success');
          await loadAllData(); // Refresh all data to show new balance and transaction
        } else {
          showToast('Payment not yet confirmed or failed.', 'error');
        }
      } catch(e) { 
        showToast('Payment verification failed. Please contact support.', 'error'); 
      }
    }
  }

  // FIX FOR PROBLEM 4: User-to-user transfer
  document.getElementById('proceed-transfer-btn').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      const email = document.getElementById('transfer-email').value;
      const amount = parseInt(document.getElementById('transfer-amount').value);
      if(!email || !amount || amount <= 0) return showToast('Please enter a valid email and amount.', 'error');

      setLoading(btn, true);
      try {
          const res = await apiCall('/api/user/transfer-credits', 'POST', { recipient_email: email, amount: amount });
          await loadAllData();
          closeModal('transfer-modal');
          showToast(res.message, 'success');
      } catch(err) {
          showToast(err.message, 'error');
      } finally {
          setLoading(btn, false);
      }
  });

  // UI Utils
  function showToast(msg, type='success') {
    const t = document.createElement('div');
    t.className = `toast`;
    t.style.borderLeftColor = type === 'success' ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : 'var(--danger)');
    t.innerHTML = `<span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 5000);
  }
  
  function setLoading(btn, isLoading) { btn.disabled = isLoading; btn.classList.toggle('loading', isLoading); }
  
  window.openModal = (id) => document.getElementById(id).style.display = 'flex';
  window.closeModal = (id) => document.getElementById(id).style.display = 'none';
  document.getElementById('fund-wallet-btn').addEventListener('click', () => openModal('payment-modal'));
  document.getElementById('transfer-btn').addEventListener('click', () => openModal('transfer-modal'));
  document.getElementById('copy-key-btn').addEventListener('click', () => { 
      navigator.clipboard.writeText(document.getElementById('new-key-text').textContent); 
      closeModal('key-modal'); 
      showToast('API Key copied!', 'success');
  });

  const stars = document.getElementById('stars');
  for(let i=0; i<60; i++) {
    const s = document.createElement('div'); s.className = 'star';
    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
    s.style.width = Math.random()*3+'px'; s.style.height = s.style.width;
    s.style.setProperty('--duration', (Math.random()*3+2)+'s');
    stars.appendChild(s);
  }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
