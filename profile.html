<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elvion AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Highlight.js (syntax highlighting) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // initialize once; we'll also call hljs.highlightElement on new blocks
      if (window.hljs) hljs.configure({ignoreUnescapedHTML: true});
    });
  </script>

  <style>
    :root {
      --cyan:#00ffff; --blue:#0090ff; --bg:#191a26; --card:#181e2e; --radius:18px; --text:#e0e0e0;
      --muted:#b3b3b3; --shadow:0 0 31px #00fff2a4;
    }

    html, body {
      width:100vw; height:100vh; margin:0; padding:0;
      font-family:'Roboto', 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: radial-gradient(circle, #23233a 66%, #0a1128 100%);
      color:var(--text);
    }
    body { display:flex; align-items:center; justify-content:center; overflow:hidden; }

    /* Stars */
    #stars-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;}
    .star{position:absolute;background:rgba(255,255,255,.7);border-radius:50%;opacity:0;animation:twinkle 4.9s infinite linear;}
    @keyframes twinkle{0%,100%{opacity:.13;}54%{opacity:.97;}}
     /* --- Copy/Share Inline Buttons --- */
.inline-copy-btn, .inline-share-btn {
  padding: 5px 11px 5px 11px;
  margin-top: 2px;
  background: linear-gradient(90deg, #00ffff, #0090ff);
  border: none;
  border-radius: 7px;
  color: #23233a;
  font-family: 'Inter', 'Orbitron', Arial, sans-serif;
  font-size: 0.99em;
  font-weight: bold;
  box-shadow: 0 1px 4px #00fff244;
  cursor: pointer;
  transition: background 0.18s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.inline-copy-btn:hover, .inline-share-btn:hover {
  background: #0090ff;
  color: #fff;
}
/* Optional: keep inline buttons more compact inside messages */
.chat-message.ai .inline-copy-btn,
.chat-message.ai .inline-share-btn {
  font-size: 0.97em;
  padding: 5px 10px;
  margin-right: 4px;
  margin-left: 0;
}

    /* Card */
    .card-container {
      background:var(--card); border-radius:var(--radius); max-width:420px; width:98vw; min-width:270px;
      height:79vh; min-height:420px; max-height:98vh; display:flex; flex-direction:column; align-items:center;
      box-shadow:var(--shadow); transition:all .20s; position:relative; z-index:2;
    }
    .fullscreen {position:fixed !important; top:0; left:0; width:100vw; height:100vh; min-height:100dvh; max-width:none; max-height:none; padding:0; border-radius:0; z-index:10; box-shadow:none;}

    /* Header */
    .header-bar {width:99%; display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px 6px; flex-shrink:0;}
    .menu-btn, .fullscreen-btn {
      background:none; border:none; color:var(--cyan); cursor:pointer;
      padding:0 11px;
    }
    .menu-btn { font-size:2em; }
    .fullscreen-btn { font-size:1.19em; margin-left:11px; }
    .fullscreen-btn:hover,.menu-btn:hover{background:var(--cyan); color:#23233a; border-radius:12px;}

    .site-heading{
      font-family:'Orbitron', sans-serif; font-size:1.06em; font-weight:700; letter-spacing:.38px;
      background:linear-gradient(90deg,#00ffff,#fff,#0090ff); background-size:200% auto; -webkit-background-clip:text;
      -webkit-text-fill-color:transparent; animation:shine 4s linear infinite; text-shadow:0 0 13px #00ffff43;
    }
    @keyframes shine{to{background-position:200% center;}}

    .profile-greet{color:#aee; font-size:.97em; margin:.3em auto; text-align:center; max-width:70vw;}

    /* Switch bar */
    #chatSwitchBar{width:97%; display:flex; align-items:center; gap:4px; margin:0 auto 7px auto;}
    #chatSelector{padding:8px 7px; border-radius:10px; border:1.3px solid #00ffff; font-size:1em; background:var(--bg); color:var(--text);}
    #newChatBtn,.delChatBtn{
      padding:4px 9px 5px 10px; border-radius:13px; border:none; cursor:pointer;
      background:linear-gradient(95deg,#00ffff 69%,#0090ff 100%); font-family:'Orbitron'; font-size:.98em;
      color:#23233a; font-weight:600; box-shadow:0 0 11px #00fff2c7;
    }
    .delChatBtn{background:none; color:#ffd500a7;}
    .delChatBtn:hover{color:#ff3131; background:#23233a;}

    /* Chat */
    .chat-box{
      flex:1 1 auto; overflow-y:auto; max-height:66vh; width:95%; margin:0 auto 1px auto; border-radius:13px;
      padding:9px 7px 8px 9px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth;
    }
    .chat-message{display:flex; align-items:flex-end; gap:12px;}
    .chat-message.user{justify-content:flex-end;}
    .chat-message .msg{
      background:linear-gradient(90deg,#23233a 91%,#23233a 100%);
      color:#e0e0e0; padding:10px 14px; border-radius:13px 14px 7px 13px; max-width:77%;
      font-size:1.03em; line-height:1.45;
      word-wrap:break-word; white-space:pre-wrap;
    }
    .chat-message.user .msg{
      background:linear-gradient(90deg,#00ffff 49%,#0090ff 100%); color:#23233a; border-radius:13px 12px 13px 7px; font-weight:700;
    }
    .chat-message img,.chat-message video{max-width:115px; max-height:100px; border-radius:7px; background:#fff;}

    /* Rich text inside AI messages */
    .chat-message.ai .msg strong { font-weight:800; color:#e8faff; }
    .chat-message.ai .msg em { opacity:0.95; }
    .chat-message.ai .msg code:not(pre code) {
      background:#0f1426; border:1px solid #26324d; padding:.12em .35em; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95em;
    }
    .chat-message.ai .msg pre {
      position:relative; background:#0b1224; border:1px solid #26324d; border-radius:12px; padding:12px 12px 14px 12px; overflow:auto;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .chat-message.ai .msg pre code {
      display:block; font-size:.96em; line-height:1.4;
    }
    .copy-btn{
      position:absolute; top:8px; right:8px; border:none; border-radius:9px; padding:6px 9px; cursor:pointer;
      background:linear-gradient(90deg,#00ffff,#0090ff); color:#132; font-weight:800; font-size:.85em; box-shadow:0 2px 7px #00ffff33;
    }
    .copy-btn:hover{filter:brightness(1.05);}

    /* File preview */
    .file-preview{width:94%; margin:11px auto 0; border-radius:8px; overflow:hidden; background:rgba(35,35,58,.7); border:1px solid rgba(255,255,255,0.20);}
    .file-preview img,.file-preview video{max-width:96%; max-height:100px; display:block; margin:0 auto;}
    .file-preview .file-info{padding:7px; display:flex; align-items:center; font-size:.98em; color:var(--muted);}
    .file-preview .file-info i{margin-right:7px;}

    /* Input row w/ textarea */
    .chat-input-row{
      width:92%; display:flex; gap:7px; align-items:flex-end; background:#23233a; border-radius:9px; padding:8px 9px;
      border:1.1px solid #00ffff21; box-shadow:0 2px 9px #00fff215; margin:3px auto 7px auto;
    }
    .chat-input-row input[type="file"]{display:none;}
    .chat-input-row label{cursor:pointer; color:var(--cyan); font-size:1.15em; padding:0 5px;}
    .chat-input-row label:hover{color:var(--blue);}
    .chat-input-row textarea{
      flex:1; min-height:42px; max-height:168px; resize:none; padding:9px 10px; border-radius:8px;
      border:1.1px solid #23233a; background:#242b3f; color:#e0e0e0; font-size:1.02em; line-height:1.45;
      scrollbar-width:thin;
    }
    .chat-input-row textarea:focus{outline:none; border:1.15px solid var(--cyan);}
    .chat-input-row button{
      background:linear-gradient(90deg,#00ffff,#0090ff); color:#23233a; border:none; border-radius:8px; padding:9px 12px; font-size:1.05em;
      font-weight:800; cursor:pointer; box-shadow:0 2px 7px #00ffff33;
    }
    .chat-input-row button:hover{background:#0090ff; color:#fff;}

    .status-message{color:#ffd700; font-size:.94em; text-align:center; min-height:16px;}

    /* Side panels */
    .panel-bg{display:none; position:fixed; z-index:221; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.59);}
    .panel-bg.active{display:flex;}
    .side-panel{background:var(--card); width:99vw; max-width:320px; height:100vh; box-shadow:-2px 0 26px #00ffffcf; display:flex; flex-direction:column; transition:transform .17s; overflow-y:auto; transform:translateX(340px);}
    .side-panel.active{transform:translateX(0);}
    .panel-header{display:flex; flex-direction:column; align-items:center; padding:24px 0 10px;}
    .panel-header img{width:42px; height:42px; border-radius:55%; object-fit:cover;}
    .panel-header .username{font-weight:800; font-size:1em; color:var(--cyan);}
    .panel-header .email{font-size:.93em; color:var(--muted);}
    .edit-form{display:flex; flex-direction:column; gap:10px;}
    .edit-form label{color:#00ffff; font-size:.92em; margin-bottom:2px;}
    .edit-form input{border:none; border-bottom:2px solid #23233a; background:#181d2c; color:#eee; font-size:.98em; padding:7px 4px 7px 9px; margin-bottom:3px; border-radius:8px;}
    .edit-form input:focus{border-color:#00ffff;}
    .profile-photo-tip{color:#b3b3b3; font-size:.91em; margin-bottom:4px;}
    .panel-links{display:flex; flex-direction:column; gap:1px; margin-top:11px; align-items:flex-start;}
    .panel-links a{color:var(--text); text-decoration:none; font-weight:700; font-size:1.02em; padding:8px 15px 8px 13px; border-radius:0 11px 11px 0; transition:background .14s;}
    .panel-links a:hover{background:var(--cyan); color:#23233a;}

    /* Typing dots (inline bubble) */
    .typing-bubble { display:inline-flex; gap:6px; align-items:center; }
    .dot-anim{display:inline-block; width:10px; height:10px; margin-right:2px; background:#00ffff; border-radius:50%; animation:bounceDot .95s infinite;}
    .dot-anim:nth-child(2){animation-delay:.11s;}
    .dot-anim:nth-child(3){animation-delay:.2s;}
    @keyframes bounceDot{0%,100%{transform:translateY(0);}55%{transform:translateY(-7px);}}

    /* Responsive */
    @media(max-width:600px){
      .card-container{max-width:99vw; width:100vw; min-height:97vw; height:95vh;}
      .chat-input-row{width:99vw;}
      .chat-box{max-height:57vh;}
    }
    @media(max-width:400px){
      .card-container{max-width:100vw; width:100vw;}
      .chat-input-row{width:99vw;}
      .chat-box{font-size:.97em;}
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="card-container" id="mainContainer">
    <div class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <span class="site-heading" style="flex:1;text-align:center;">Philadelphia AI</span>
      <button class="fullscreen-btn" id="fullscreenBtn" aria-label="Toggle fullscreen"><i class="fa-solid fa-expand"></i></button>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </div>

    <div class="profile-greet" id="greetMsg">Welcome!</div>

    <div id="chatSwitchBar">
      <select id="chatSelector"></select>
      <button id="newChatBtn" title="New chat"><i class="fa-solid fa-plus"></i></button>
      <button class="delChatBtn" id="delChatBtn" title="Delete"><i class="fa-solid fa-trash"></i></button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <div id="filePreview" class="file-preview" style="display:none;"></div>

    <!-- CHAT INPUT -->
    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <label for="chatFile" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
      <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple>
      <textarea id="chatInput" placeholder="Type here… (Shift+Enter = new line)"></textarea>
      <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
      <button type="button" id="voiceInputBtn" title="Record voice"><i class="fa-solid fa-microphone"></i></button>
    </form>

    <div class="status-message" id="statusMsg"></div>
  </div>

  <!-- Profile Menu Modal -->
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 18px;">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Paste image link">
        <span class="profile-photo-tip">For photo, <a href="https://postimg.cc/" target="_blank" style="color:#00ffff;">upload at postimg.cc</a> and paste link here.</span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#19192a;color:#00ffff;">Logout</button>
    </nav>
  </div>

  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:85px;max-width:320px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;">
  <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
  <div id="ai-image-container"></div>
  <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
</div>

  <!-- Link Menu Modal -->
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
        <div class="username">Elvion AI</div>
      </div>
      <div class="panel-links">
        <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </nav>
  </div>
  <script type="module">
    /* ---------- Fixed/Refactored profile script ---------- Key fixes made:

All DOM access / event wiring moved into DOMContentLoaded to avoid null refs voiceBtn and imageBtn are created before any handler uses them Unified file-upload handling (uploadedFiles + uploadData) and removed duplicate handlers Added defensive checks (?.) to avoid throwing when elements are missing Kept original functionality; minor cleanup and comments added */ 

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"; import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = { apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk", authDomain: "elvionai.firebaseapp.com", projectId: "elvionai", storageBucket: "elvionai.appspot.com", messagingSenderId: "161078300830", appId: "1:161078300830:web:f460df8591704eb0e96b8f" }; const app = initializeApp(firebaseConfig); const auth = getAuth(app);

// Run DOM-related setup after DOM is ready window.addEventListener('DOMContentLoaded', () => { // Short helper const $ = id => document.getElementById(id);

/* ---------- Elements (may be null if markup is different) ---------- */ const starsContainer = $('stars-container'); const mainContainer = $('mainContainer'); const fullscreenBtn = $('fullscreenBtn'); const profileMenuBg = $('profileMenuBg'); const profileMenu = $('profileMenu'); const linkMenuBg = $('linkMenuBg'); const linkMenu = $('linkMenu'); const logoutBtn = $('logoutBtn'); const greetMsg = $('greetMsg'); const profileMenuUser = $('profileMenuUser'); const profileMenuEmail = $('profileMenuEmail'); const editName = $('edit-name'); const editPhoto = $('edit-photo'); const profilePicPreview = $('profilePicPreview'); const profileForm = $('profileForm'); const chatBox = $('chatBox'); const chatSelector = $('chatSelector'); const newChatBtn = $('newChatBtn'); const delChatBtn = $('delChatBtn'); const chatForm = $('chatForm'); const chatInput = $('chatInput'); const sendBtn = $('sendBtn'); const chatFile = $('chatFile'); const filePreview = $('filePreview'); const voiceInputBtn = $('voiceInputBtn');

/* ---------- Stars ---------- */ if (starsContainer) { for (let i = 0; i < 34; i++) { const s = document.createElement('div'); s.className = 'star'; const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px'; s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%'; s.style.animationDelay = (Math.random() * 3.69) + 's'; s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's'; starsContainer.appendChild(s); } }

/* ---------- Fullscreen toggle ---------- */ if (fullscreenBtn && mainContainer) { let isFull = false; fullscreenBtn.addEventListener('click', () => { isFull = !isFull; mainContainer.classList.toggle('fullscreen', isFull); fullscreenBtn.innerHTML = isFull ? '' : ''; }); }

/* ---------- Panels/Modals ---------- */ if (profileMenuBg && profileMenu && $('openProfileMenu')) { $('openProfileMenu').addEventListener('click', () => { profileMenuBg.classList.add('active'); setTimeout(() => profileMenu.classList.add('active'), 10); }); profileMenuBg.addEventListener('click', e => { if (e.target === profileMenuBg) { profileMenu.classList.remove('active'); setTimeout(() => profileMenuBg.classList.remove('active'), 110); } }); } if (linkMenuBg && linkMenu && $('openLinksMenu')) { $('openLinksMenu').addEventListener('click', () => { linkMenuBg.classList.add('active'); setTimeout(() => linkMenu.classList.add('active'), 10); }); linkMenuBg.addEventListener('click', e => { if (e.target === linkMenuBg) { linkMenu.classList.remove('active'); setTimeout(() => linkMenuBg.classList.remove('active'), 110); } }); } if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = 'signup-login.html');

/* ---------- Firebase Auth (profile only) ---------- */ let currentUser = null;

onAuthStateChanged(auth, user => { if (!user) { // Not logged in window.location.href = "signup-login.html"; return; } currentUser = user; if (greetMsg) greetMsg.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]) + "!"; if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User"; if (profileMenuEmail) profileMenuEmail.textContent = user.email || ""; if (editName) editName.value = user.displayName || ""; if (editPhoto) editPhoto.value = user.photoURL || ""; if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

// Render chat UI if functions exist try { renderChatSelector(); } catch (e) { console.warn('renderChatSelector error', e); } try { renderChatBox(chats[currentChatIdx]?.history || []); } catch (e) { console.warn('renderChatBox error', e); } 

});

if (editPhoto && profilePicPreview) { editPhoto.addEventListener('input', function () { profilePicPreview.src = this.value || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg"; }); }

if (profileForm) { profileForm.addEventListener('submit', async function (e) { e.preventDefault(); if (!currentUser) return; const status = $('profileStatusMsg'); if (status) status.textContent = ''; const name = (editName ? editName.value.trim() : ''); const photoURL = (editPhoto ? editPhoto.value.trim() : ''); try { await updateProfile(currentUser, { displayName: name, photoURL }); await auth.currentUser.reload(); if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; } setTimeout(() => { profileMenu?.classList.remove('active'); profileMenuBg?.classList.remove('active'); }, 650); if (greetMsg) greetMsg.textContent = "Welcome, " + (auth.currentUser.displayName || (auth.currentUser.email || '').split('@')[0]) + "!"; } catch (err) { if (status) { status.textContent = err.message || "Update failed"; status.style.color = "#ffd700"; } } }); }

/* ---------- LocalStorage Chat Logic, Excluding Images ---------- */ let chats = JSON.parse(localStorage.getItem("elvion_chats") || "[]"); let currentChatIdx = chats.length - 1 >= 0 ? chats.length - 1 : 0;

function saveChats() { try { let sanitized = JSON.parse(JSON.stringify(chats)); sanitized.forEach(chat => { chat.history.forEach(msg => { if (msg.text && typeof msg.text === 'string' && msg.text.includes("data:image")) { msg.text = "[image omitted]"; } }); }); localStorage.setItem("elvion_chats", JSON.stringify(sanitized)); } catch (e) { console.warn('saveChats failed', e); } }

function renderChatSelector() { if (!chatSelector) return; chatSelector.innerHTML = ""; chats.forEach((chat, idx) => { const option = document.createElement("option"); option.value = idx; option.textContent = chat.name || (chat.history?.[0]?.text?.slice(0, 25) || "Untitled"); chatSelector.appendChild(option); }); if (typeof currentChatIdx === 'number') chatSelector.value = currentChatIdx; }

if (chatSelector) { chatSelector.addEventListener('change', function () { currentChatIdx = parseInt(this.value) || 0; renderChatBox(chats[currentChatIdx]?.history || []); }); }

function loadChat(idx) { currentChatIdx = idx || 0; renderChatBox(chats[idx]?.history || []); }

/* ---------- Markdown, Code, Copy, Share ---------- */ const escapeHTML = (str = '') => String(str).replaceAll('&', '&').replaceAll('<', '<').replaceAll('>', '>');

function renderMarkdown(text = '') { const codeBlockRegex = /(\w+)?\n([\s\S]*?)/g; let html = ''; let lastIndex = 0; text = text || '';

text.replace(codeBlockRegex, (match, lang, code, offset) => { const before = text.slice(lastIndex, offset); html += inlineMarkdown(before); const language = (lang || '').toLowerCase().trim(); const safe = escapeHTML(code); const blockId = 'code_' + Math.random().toString(36).slice(2); html += `<pre data-block-id="${blockId}">\n <button class="copy-btn" data-copy="${blockId}">Copy</button>\n <code class="language-${language || 'plaintext'}">${safe}</code>\n</pre>`; lastIndex = offset + match.length; return match; }); html += inlineMarkdown(text.slice(lastIndex)); return { html }; 

}

function inlineMarkdown(t = '') { let s = String(t).replace(/([^]+?)/g, (_, a) => ${escapeHTML(a)}`); s = s.replace(/**([^]+?)**/g, '$1'); s = s.replace(/(^|[\s(])*([^]+?)*(?=[\s).,!?:;]|$)/g, '$1$2'); s = s.replace(/[([^]]+)]((https?://[^\s)]+))/g, '$1'); return s.replace(/\n/g, '
'); }

function enhanceCodeBlocks(container) { if (!container) return; container.querySelectorAll('pre').forEach(pre => { const codeEl = pre.querySelector('code'); if (window.hljs && codeEl) try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ } const btn = pre.querySelector('.copy-btn'); if (btn && codeEl) { btn.addEventListener('click', async () => { try { await navigator.clipboard.writeText(codeEl.innerText); const prev = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = prev, 800); } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); } }); } }); }

/* ---------- Chat Rendering with Copy/Share ---------- */ function renderChatBox(messages) { if (!chatBox) return; chatBox.innerHTML = ""; (messages || []).forEach((msg, mi) => { const div = document.createElement('div'); div.className = "chat-message " + (msg.role === "user" ? "user" : "ai"); if (msg.text && /^([File]|image:)/.test(msg.text)) { div.innerHTML = msg.text.replace('image:', ''); } else if (msg.role === "ai") { const { html } = renderMarkdown(msg.text || ''); div.innerHTML = <div class="msg">${html}\n <div style="display:flex;justify-content:end;gap:8px;margin-top:4px;">\n <button class="inline-copy-btn" title="Copy whole AI response" data-idx="ai-${mi}">□ Copy</button>\n <button class="inline-share-btn" title="Share this reply" data-idx="ai-${mi}"><i class="fa-solid fa-share"></i> Share</button>\n </div></div>; } else { div.innerHTML = <div class="msg">${escapeHTML(msg.text || '')}</div>; } chatBox.appendChild(div); }); enhanceCodeBlocks(chatBox);

// Copy/share handlers chatBox.querySelectorAll('.inline-copy-btn').forEach(btn => { btn.onclick = function () { const idx = parseInt(btn.getAttribute('data-idx').replace('ai-', '')); const text = (chats[currentChatIdx]?.history[idx]?.text) || ""; navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, "")); const prev = btn.textContent; btn.textContent = "Copied!"; setTimeout(() => btn.textContent = prev, 900); }; }); chatBox.querySelectorAll('.inline-share-btn').forEach(btn => { btn.onclick = async function () { const idx = parseInt(btn.getAttribute('data-idx').replace('ai-', '')); const text = (chats[currentChatIdx]?.history[idx]?.text) || ""; if (navigator.share) { try { await navigator.share({ title: "Philadelphia AI", text }); } catch (e) { /* ignore */ } } else { prompt("Copy and share:", text.replace(/<\/?[^>]+(>|$)/g, "")); } }; }); chatBox.scrollTop = chatBox.scrollHeight; 

}

/* ------- Typing / Animation Utilities ---- */ let typingNode = null; function showTypingAtNext() { removeTyping(); if (!chatBox) return; typingNode = document.createElement('div'); typingNode.className = 'chat-message ai'; typingNode.innerHTML = <div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>; chatBox.appendChild(typingNode); chatBox.scrollTop = chatBox.scrollHeight; } function removeTyping() { if (typingNode && typingNode.parentNode) { typingNode.parentNode.removeChild(typingNode); typingNode = null; } }

async function typeBotMessage(text, onDone) { removeTyping(); if (!chatBox) return; const div = document.createElement('div'); div.className = "chat-message ai"; const msgdiv = document.createElement('div'); msgdiv.className = 'msg'; div.appendChild(msgdiv); chatBox.appendChild(div); let sofar = ''; for (const ch of text) { sofar += ch; msgdiv.innerHTML = renderMarkdown(sofar).html; chatBox.scrollTop = chatBox.scrollHeight; await new Promise(res => setTimeout(res, 6 + Math.random() * 18)); } msgdiv.innerHTML = renderMarkdown(text).html + \n <div style="display:flex;justify-content:end;gap:8px;margin-top:4px;">\n <button class="inline-copy-btn" title="Copy whole AI response">□ Copy</button>\n <button class="inline-share-btn" title="Share this reply"><i class="fa-solid fa-share"></i> Share</button>\n </div>; enhanceCodeBlocks(msgdiv);

// attach handlers to the newly appended buttons const copyBtn = msgdiv.querySelector('.inline-copy-btn'); if (copyBtn) copyBtn.onclick = () => { navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, "")); copyBtn.textContent = "Copied!"; setTimeout(() => copyBtn.textContent = "□ Copy", 900); }; const shareBtn = msgdiv.querySelector('.inline-share-btn'); if (shareBtn) shareBtn.onclick = async () => { if (navigator.share) { try { await navigator.share({ title: "Philadelphia AI", text }); } catch (e) { /* ignore */ } } else { prompt("Copy and share:", text.replace(/<\/?[^>]+(>|$)/g, "")); } }; if (onDone) onDone(); 

}

/* ---------- New/Delete Chat ---------- */ if (newChatBtn) newChatBtn.addEventListener('click', function () { const name = "Chat " + (chats.length + 1); chats.push({ name, history: [] }); currentChatIdx = chats.length - 1; saveChats(); renderChatSelector(); loadChat(currentChatIdx); }); if (delChatBtn) delChatBtn.addEventListener('click', function () { if (!chats.length) return; if (!confirm("Delete this chat?")) return; chats.splice(currentChatIdx, 1); if (currentChatIdx >= chats.length) currentChatIdx = chats.length - 1; saveChats(); renderChatSelector(); loadChat(currentChatIdx); });

/* ---------- File Preview (images not saved) & Uploaded files state ---------- */ let uploadedFiles = []; let uploadData = null; // keep legacy name used in submit logic

function renderFilePreview() { if (!filePreview) return; if (!uploadedFiles.length) { filePreview.style.display = 'none'; filePreview.innerHTML = ''; return; } filePreview.style.display = 'block'; filePreview.innerHTML = uploadedFiles.map((file, idx) => { let icon = file.type.startsWith('image/') ? '🖼️' : (file.type === 'application/pdf' ? '📄' : '📁'); return <div style="display:flex;align-items:center;gap:10px;border-radius:7px;margin-bottom:2px;">\n <span style="font-size:1.25em;">${icon}</span>\n <span style="color:#aee;font-size:.99em;">${file.name}</span>\n <button type="button" data-idx="${idx}" class="remove-file-btn" style="color:#fff;background:#d23;border:none;border-radius:12px;padding:0 9px;cursor:pointer;font-weight:bold;font-size:1.18em;">&times;</button>\n</div>; }).join('');

// Attach remove handlers filePreview.querySelectorAll('.remove-file-btn').forEach(btn => { btn.addEventListener('click', (e) => { const idx = parseInt(btn.getAttribute('data-idx')); uploadedFiles.splice(idx, 1); uploadData = uploadedFiles[0] || null; if (!uploadedFiles.length && chatFile) chatFile.value = ''; renderFilePreview(); }); }); 

}

if (chatFile) { chatFile.addEventListener('change', function () { const files = Array.from(this.files || []); uploadedFiles = files; uploadData = files[0] || null; // Quick inline preview for first image/video if (filePreview && uploadData) { if (uploadData.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = e => { filePreview.style.display = 'block'; filePreview.innerHTML = <img src="${e.target.result}" alt="Selected image" style="max-width:200px;border-radius:8px;">; }; reader.readAsDataURL(uploadData); } else if (uploadData.type.startsWith('video/')) { const reader = new FileReader(); reader.onload = e => { filePreview.style.display = 'block'; filePreview.innerHTML = <video src="${e.target.result}" controls style="max-width:200px;border-radius:8px;"></video>; }; reader.readAsDataURL(uploadData); } else { renderFilePreview(); } } else { renderFilePreview(); } }); }

/* ---------- Voice Input (browser speech recognition) ---------- */ if (voiceInputBtn && chatInput) { let recognition = null; voiceInputBtn.addEventListener('click', function () { if ('webkitSpeechRecognition' in window) { recognition = new webkitSpeechRecognition(); recognition.continuous = false; recognition.interimResults = false; recognition.lang = 'en-US'; this.innerHTML = ''; recognition.onresult = (e) => { chatInput.value += (chatInput.value ? ' ' : '') + e.results[0][0].transcript; chatInput.dispatchEvent(new Event('input')); this.innerHTML = ''; }; recognition.onend = () => { voiceInputBtn.innerHTML = ''; }; recognition.onerror = () => { voiceInputBtn.innerHTML = ''; }; recognition.start(); } else alert('Speech recognition not supported in your browser.'); }); }

/* ---------- Textarea auto-resize ---------- */ if (chatInput) { function autoResizeTextarea() { chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px'; } chatInput.addEventListener('input', autoResizeTextarea); autoResizeTextarea(); chatInput.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBtn?.click(); } }); }

/* ---------- IMAGE & VOICE BUTTONS (create before handlers) ---------- */ const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore", "gemini6"]; let currentModelIdx = 0; let imageBtn = document.createElement('button'); imageBtn.type = 'button'; imageBtn.id = 'imageBtn'; imageBtn.title = 'Generate image'; imageBtn.innerHTML = ''; let voiceGenBtn = document.createElement('button'); voiceGenBtn.type = 'button'; voiceGenBtn.id = 'voiceBtn'; voiceGenBtn.title = 'Generate voice'; voiceGenBtn.innerHTML = ''; if (chatForm && sendBtn) chatForm.insertBefore(imageBtn, sendBtn); if (chatForm && sendBtn) chatForm.insertBefore(voiceGenBtn, sendBtn);

// Image model cycling imageBtn.addEventListener('click', function () { currentModelIdx = (currentModelIdx + 1) % thenaModels.length; let model = thenaModels[currentModelIdx]; let prevInput = (chatInput ? chatInput.value.replace(/^/image\s+\w+\s*/i, "").replace(/^/imagine\s*/i, "") : ""); if (model === 'gemini6') { if (chatInput) chatInput.value = /imagine ${prevInput}.trim(); imageBtn.innerHTML = ''; } else { if (chatInput) chatInput.value = /image ${model} ${prevInput}.trim(); imageBtn.innerHTML = ''; } chatInput?.focus(); setTimeout(() => { try { chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); } catch (_) { } }, 0); });

/* ---------- Voice Note Generation (use voiceGenBtn created above) ---------- */ voiceGenBtn.addEventListener('click', async function () { if (!chatInput) return; let msgText = chatInput.value.trim(); if (!msgText) { chatInput.focus(); return; } let style = $('voiceStyle') ? $('voiceStyle').value : 'podcast'; showTypingAtNext(); try { let fd = new FormData(); fd.append('text', msgText); fd.append('style', style); let res = await fetch('https://web-production-9a18.up.railway.app/voicegen', { method: 'POST', body: fd }); if (!res.ok) { let err = {}; try { err = await res.json(); } catch (_) { } removeTyping(); await typeBotMessage('❌ Voice generation failed: ' + (err.error || res.statusText)); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Voice generation failed.' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return; } let blob = await res.blob(); let url = URL.createObjectURL(blob); let audioPlayer = <audio controls src="${url}" style="width:99%;margin:8px 0 3px 0;border-radius:14px;"></audio>; removeTyping(); chats[currentChatIdx].history.push({ role: 'ai', text: 🗣️ Voice generated in *${style}* style:<br>${audioPlayer} }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } catch (err) { removeTyping(); await typeBotMessage('❌ Voice API/network error'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Voice API/network error' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } });

/* ---------- File / Upload handling and main chat submit ---------- */ if (chatForm) { chatForm.addEventListener('submit', async function (e) { e.preventDefault(); const file = uploadData; // first file if any const fp = filePreview; let msgText = (chatInput ? chatInput.value.trim() : '');

// Ensure at least one chat exists if (currentChatIdx < 0 || !chats.length) { chats.push({ name: 'Chat 1', history: [] }); currentChatIdx = 0; saveChats(); } if (!msgText && !file) return; if (chatInput) { chatInput.value = ''; chatInput.dispatchEvent(new Event('input')); } // --------- 1. /imagine handler --------- if (/^\/imagine\s+/i.test(msgText)) { const imaginePrompt = msgText.replace(/^\/imagine\s+/i, '').trim(); const fd = new FormData(); fd.append('prompt', imaginePrompt); if (uploadedFiles.length && /^image\//.test(uploadedFiles[0].type)) fd.append('file', uploadedFiles[0]); showTypingAtNext(); try { const res = await fetch('https://web-production-9a18.up.railway.app/imagine', { method: 'POST', body: fd }); if (!res.ok) { let err = {}; try { err = await res.json(); } catch (_) { } removeTyping(); await typeBotMessage('❌ Image generation failed: ' + (err.error || res.statusText)); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Image generation failed.' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } else { const blob = await res.blob(); const url = URL.createObjectURL(blob); showAIImagePreview(url, 'Your new Philadelphia AI image! (click Download if you like it)'); removeTyping(); chats[currentChatIdx].history.push({ role: 'ai', text: '✅ Image generated! Use the floating image box below to view or download. (Not stored in chat history.)' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } } catch (err) { removeTyping(); await typeBotMessage('❌ Philadelphia image API/network error'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Vision 6 image API/network error' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } // reset if (chatFile) chatFile.value = ''; uploadedFiles = []; uploadData = null; renderFilePreview(); return; } // ----------- 2. FILE UPLOAD LOGIC: Multiple or Single ----------- if (uploadedFiles && uploadedFiles.length) { showTypingAtNext(); try { const pdfs = uploadedFiles.filter(f => f.type === 'application/pdf'); const images = uploadedFiles.filter(f => /^image\//.test(f.type)); const audios = uploadedFiles.filter(f => /^audio\//.test(f.type)); const videos = uploadedFiles.filter(f => /^video\//.test(f.type)); if (pdfs.length) { let fd = new FormData(); fd.append('prompt', msgText ? msgText : (pdfs.length > 1 ? 'Please summarize and compare these documents:' : 'Summarize this document.')); pdfs.forEach(f => fd.append('files', f)); let res = await fetch('https://web-production-9a18.up.railway.app/understand-pdf', { method: 'POST', body: fd }); let txt = await res.text(); let data; try { data = JSON.parse(txt); } catch (err) { removeTyping(); chats[currentChatIdx].history.push({ role: 'user', text: `[PDF] ${pdfs.map(f => f.name).join(', ')}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ PDF API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return; } removeTyping(); chats[currentChatIdx].history.push({ role: 'user', text: `[PDF] ${pdfs.map(f => f.name).join(', ')}${msgText ? ': ' + msgText : ''}` }); if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the PDF(s).'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the PDF(s).' }); } } for (const img of images) { let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Describe this image in detail.'); fd.append('file', img); let res = await fetch('https://web-production-9a18.up.railway.app/understand-image', { method: 'POST', body: fd }); let txt = await res.text(); let data; try { data = JSON.parse(txt); } catch (err) { chats[currentChatIdx].history.push({ role: 'user', text: `[Image] ${img.name}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ Image API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); continue; } chats[currentChatIdx].history.push({ role: 'user', text: `[Image] ${img.name}${msgText ? ': ' + msgText : ''}` }); if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the image.'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the image.' }); } } for (const audio of audios) { let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Transcribe and summarize this audio file in simple English.'); fd.append('file', audio); let res = await fetch('https://web-production-9a18.up.railway.app/understand-audio', { method: 'POST', body: fd }); let txt = await res.text(); let data; try { data = JSON.parse(txt); } catch (err) { chats[currentChatIdx].history.push({ role: 'user', text: `[Audio] ${audio.name}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ Audio API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); continue; } chats[currentChatIdx].history.push({ role: 'user', text: `[Audio] ${audio.name}${msgText ? ': ' + msgText : ''}` }); if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the audio.'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the audio.' }); } } for (const vid of videos) { let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Watch this video and explain what it’s about in simple English. Give a visual description and audio transcript if possible.'); fd.append('file', vid); let res = await fetch('https://web-production-9a18.up.railway.app/understand-video', { method: 'POST', body: fd }); let txt = await res.text(); let data; try { data = JSON.parse(txt); } catch (err) { chats[currentChatIdx].history.push({ role: 'user', text: `[Video] ${vid.name}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ Video API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); continue; } chats[currentChatIdx].history.push({ role: 'user', text: `[Video] ${vid.name}${msgText ? ': ' + msgText : ''}` }); if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the video.'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the video.' }); } } if (chatFile) chatFile.value = ''; uploadedFiles = []; uploadData = null; renderFilePreview(); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return; } catch (err) { removeTyping(); chats[currentChatIdx].history.push({ role: 'ai', text: '[File upload failed] ' + (err.message || 'no net') }); if (chatFile) chatFile.value = ''; uploadedFiles = []; uploadData = null; renderFilePreview(); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return; } } // ----------- 3. TEXT/COMMAND CHAT LOGIC ----------- chats[currentChatIdx].history.push({ role: 'user', text: msgText }); if (chats[currentChatIdx].history.length === 1) { chats[currentChatIdx].name = msgText.slice(0, 25) + "..."; renderChatSelector(); } renderChatBox(chats[currentChatIdx]?.history || []); showTypingAtNext(); try { let res, data; if (/^\/image\s+/i.test(msgText)) { let imagePrompt = msgText.replace(/^\/image\s+/i, ''); res = await fetch('https://web-production-9a18.up.railway.app/generate-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(imagePrompt) }); try { data = await res.json(); } catch (_) { data = {}; } removeTyping(); if (data.image_b64) { showAIImagePreview('data:image/png;base64,' + data.image_b64, '(Your image—download or close)'); chats[currentChatIdx].history.push({ role: 'ai', text: '✅ Image generated! (Use the floating preview box below to view or download. This image is NOT stored in chat history.)' }); } else { chats[currentChatIdx].history.push({ role: 'ai', text: data.error || '❌ Image generation failed. Try another prompt.' }); } saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } else { const history = chats[currentChatIdx].history.map(m => ({ role: m.role, content: m.text })); res = await fetch('https://web-production-9a18.up.railway.app/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msgText, user_id: currentUser?.uid || 'user', history }) }); try { data = await res.json(); } catch (_) { data = {}; } removeTyping(); if (data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('🤖 Bot replied (no response).'); chats[currentChatIdx].history.push({ role: 'ai', text: '🤖 Bot replied (no response).' }); } saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } } catch (err) { removeTyping(); await typeBotMessage('Sorry, bot error: ' + err.message); chats[currentChatIdx].history.push({ role: 'ai', text: 'Sorry, bot error: ' + err.message }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); } }); 

}

/* ---------- AI Image preview UI ---------- */ const aiPrevBox = $('ai-image-preview'); const aiPrevClose = $('ai-image-close'); const aiPrevDLBtn = $('ai-image-dl'); const aiPrevImgBox = $('ai-image-container');

if (aiPrevClose && aiPrevBox && aiPrevImgBox) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; aiPrevImgBox.innerHTML = ''; }); if (aiPrevDLBtn && aiPrevImgBox) aiPrevDLBtn.addEventListener('click', () => { const img = aiPrevImgBox.querySelector('img'); if (img) { const url = img.src; const a = document.createElement('a'); a.href = url; a.download = 'generated_image.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a); } });

function showAIImagePreview(srcUrlOrBase64, caption = '') { if (!aiPrevBox || !aiPrevImgBox) return; let src = (typeof srcUrlOrBase64 === 'string' && (srcUrlOrBase64.startsWith('data:') || srcUrlOrBase64.startsWith('blob:'))) ? srcUrlOrBase64 : 'data:image/png;base64,' + srcUrlOrBase64; aiPrevImgBox.innerHTML = <img src="${src}" alt="AI gen" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;"> + (caption ? ' 

' + caption + '

' : ''); aiPrevBox.style.display = 'block'; } 

// Initial small UI setup: prefill chatInput with /image photoreal currentModelIdx = 0; if (chatInput) { chatInput.value = '/image photoreal '; chatInput.focus(); try { chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); } catch (_) { } }

});
</script>
</body>
</html>
