<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Philadelphia AI</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    /* === Base Reset === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Inter", sans-serif;
      background: #0a0f1c;
      color: #eee;
      overflow: hidden;
    }

    /* === Header === */
    header {
      padding: 15px;
      text-align: center;
      font-size: 1.5em;
      color: #0ff;
      text-shadow: 0 0 12px #00ffffcc;
      font-weight: bold;
    }
    #welcome-user {
      font-size: 0.9em;
      color: #aaa;
    }

    /* === Main Layout === */
    .container {
      display: flex;
      height: calc(100vh - 60px);
      position: relative;
    }
    .sidebar, .rightbar {
      width: 260px;
      background: #101522;
      border-right: 1px solid #1f2b44;
      padding: 15px;
      overflow-y: auto;
    }
    .rightbar {
      border-right: none;
      border-left: 1px solid #1f2b44;
    }
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0d1424;
    }

    /* === Sidebar === */
    .sidebar h3, .rightbar h3 {
      margin-bottom: 10px;
      color: #0ff;
      font-size: 1.1em;
    }
    .chat-list {
      list-style: none;
    }
    .chat-list li {
      padding: 8px;
      margin-bottom: 6px;
      background: #141b2f;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-list li span {
      flex: 1;
    }
    .chat-list li button {
      background: none;
      border: none;
      color: #ff4444;
      cursor: pointer;
    }

    /* === Chat Window === */
    .chat-window {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .message {
      margin-bottom: 15px;
    }
    .message.user {
      text-align: right;
    }
    .message.ai {
      text-align: left;
    }
    .message .bubble {
      display: inline-block;
      padding: 12px;
      border-radius: 12px;
      max-width: 70%;
      line-height: 1.4;
    }
    .message.user .bubble {
      background: #0077ff;
      color: #fff;
    }
    .message.ai .bubble {
      background: #141b2f;
      border: 1px solid #1f2b44;
      color: #eee;
      position: relative;
    }
    .msg-actions {
      margin-top: 6px;
      display: flex;
      gap: 10px;
      font-size: 0.9em;
    }
    .msg-actions i {
      cursor: pointer;
      color: #888;
    }
    .msg-actions i:hover {
      color: #0ff;
    }

    /* === Input Bar === */
    .input-bar {
      padding: 10px;
      border-top: 1px solid #1f2b44;
      display: flex;
      align-items: center;
      gap: 10px;
      background: #0f172a;
    }
    .input-bar input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      outline: none;
      background: #141b2f;
      color: #eee;
    }
    .input-bar button {
      border: none;
      background: #0077ff;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
    }
    .input-bar i {
      color: #0ff;
      font-size: 1.2em;
      cursor: pointer;
    }

    /* === Modal (Profile & Nav) === */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #0d1424;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      color: #eee;
    }
    .modal-content h2 {
      margin-bottom: 15px;
      color: #0ff;
    }
    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      color: #ff4444;
      font-size: 1.5em;
      cursor: pointer;
    }

    /* === AI Call Modal === */
    #ai-call-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.92);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #ai-call-modal .call-box {
      width: 96%;
      max-width: 460px;
      background: #0d1424;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 0 40px #00ffff55;
      position: relative;
    }
    #ai-call-modal #avatarPulse {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 20px auto;
      background: #222 url('https://i.postimg.cc/5yZ6THqK/IMG-20250824-133336-309.jpg') center/cover no-repeat;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0px #00ffff44; }
      50% { box-shadow: 0 0 35px #00ffffaa; }
      100% { box-shadow: 0 0 0px #00ffff44; }
    }
    .call-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
    }
    .call-controls button {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
    }
    #callEnd { background: #ff4444; color: #fff; }
    #callMuteBtn { background: #ffaa00; color: #111; }
    #callDownloadBtn { background: #00ff99; color: #111; }
    #callStatus, #callTimer { margin-top: 10px; color: #aaa; }
  </style>
</head>
<body>
  <header>
    ‚ú® Philadelphia AI ‚ú®
    <div id="welcome-user">Welcome, <span id="username">Guest</span></div>
  </header>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Your Chats</h3>
      <ul class="chat-list" id="chatList"></ul>
      <button id="newChatBtn">+ New Chat</button>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
      <div class="chat-window" id="chatWindow"></div>
      <div class="input-bar">
        <i class="fa-regular fa-face-smile" id="emojiBtn"></i>
        <input type="text" id="userInput" placeholder="Type a message...">
        <i class="fa-solid fa-image" id="imgGenBtn"></i>
        <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
        <button id="callBtn"><i class="fa-solid fa-phone-volume"></i></button>
      </div>
    </div>

    <!-- Rightbar -->
    <div class="rightbar">
      <h3>Menu</h3>
      <ul>
        <li><a href="#">üè† Home</a></li>
        <li><a href="#">‚ÑπÔ∏è About</a></li>
        <li><a href="#">üîí Privacy Policy</a></li>
      </ul>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal" id="profileModal">
    <div class="modal-content">
      <span class="modal-close" id="profileClose">&times;</span>
      <h2>Profile</h2>
      <p><b>Name:</b> <span id="profileName">Guest</span></p>
      <p><b>Email:</b> <span id="profileEmail">guest@example.com</span></p>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- AI Call Modal -->
  <div id="ai-call-modal">
    <div class="call-box">
      <div id="avatarPulse"></div>
      <div id="callTranscript"></div>
      <div class="call-controls">
        <button id="callMuteBtn"><i class="fa-solid fa-microphone-slash"></i></button>
        <button id="callDownloadBtn"><i class="fa-solid fa-download"></i></button>
        <button id="callEnd"><i class="fa-solid fa-phone-slash"></i></button>
      </div>
      <div id="callStatus">Connecting...</div>
      <div id="callTimer"></div>
    </div>
  </div>
  <script>
    // ==== Philadelphia AI Script ====

document.addEventListener("DOMContentLoaded", () => {
  const chatWindow = document.getElementById("chatWindow");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const imgGenBtn = document.getElementById("imgGenBtn");
  const emojiBtn = document.getElementById("emojiBtn");
  const callBtn = document.getElementById("callBtn");
  const chatList = document.getElementById("chatList");
  const newChatBtn = document.getElementById("newChatBtn");

  let chats = [];
  let currentChat = { id: Date.now(), title: "New Chat", messages: [] };

  // === Utility ===
  function addMessage(role, text) {
    const msgDiv = document.createElement("div");
    msgDiv.className = `message ${role}`;
    msgDiv.innerHTML = `
      <div class="bubble">${text}</div>
      ${role === "ai" ? `
        <div class="msg-actions">
          <i class="fa-solid fa-copy" title="Copy"></i>
          <i class="fa-solid fa-share" title="Share"></i>
          <i class="fa-solid fa-rotate-right" title="Regenerate"></i>
        </div>` : ""}
    `;
    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    if (role === "ai") {
      const copyBtn = msgDiv.querySelector(".fa-copy");
      const shareBtn = msgDiv.querySelector(".fa-share");
      const regenBtn = msgDiv.querySelector(".fa-rotate-right");

      copyBtn.onclick = () => navigator.clipboard.writeText(text);
      shareBtn.onclick = () => {
        const shareText = `${text}\n\nShared from Philadelphia AI: ${location.href}`;
        navigator.clipboard.writeText(shareText);
        alert("Copied to clipboard for sharing!");
      };
      regenBtn.onclick = () => sendToAI(currentChat.messages[currentChat.messages.length - 2].text);
    }
  }

  function saveChat() {
    if (!chats.find(c => c.id === currentChat.id)) {
      chats.push(currentChat);
    }
    renderChatList();
  }

  function renderChatList() {
    chatList.innerHTML = "";
    chats.forEach(chat => {
      const li = document.createElement("li");
      li.innerHTML = `<span contenteditable="true">${chat.title}</span>
        <button><i class="fa-solid fa-trash"></i></button>`;
      li.querySelector("span").onblur = e => chat.title = e.target.textContent;
      li.querySelector("button").onclick = () => {
        chats = chats.filter(c => c.id !== chat.id);
        renderChatList();
      };
      li.onclick = () => {
        currentChat = chat;
        chatWindow.innerHTML = "";
        chat.messages.forEach(m => addMessage(m.role, m.text));
      };
      chatList.appendChild(li);
    });
  }

  // === Send Message ===
  async function sendToAI(text) {
    addMessage("user", text);
    currentChat.messages.push({ role: "user", text });

    const typingDiv = document.createElement("div");
    typingDiv.className = "message ai";
    typingDiv.innerHTML = `<div class="bubble">...</div>`;
    chatWindow.appendChild(typingDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;

    try {
      const res = await fetch("https://web-production-9a18.up.railway.app/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      });
      const data = await res.json();
      const reply = data.reply || data.response || "Hmm... I couldn‚Äôt process that.";
      typingDiv.remove();
      addMessage("ai", reply);
      currentChat.messages.push({ role: "ai", text: reply });
      saveChat();
    } catch (err) {
      typingDiv.remove();
      addMessage("ai", "‚ö†Ô∏è Error reaching AI service.");
    }
  }

  sendBtn.onclick = () => {
    if (userInput.value.trim()) {
      sendToAI(userInput.value.trim());
      userInput.value = "";
    }
  };

  userInput.addEventListener("keypress", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  // === Image Generation ===
  imgGenBtn.onclick = async () => {
    const prompt = userInput.value.trim();
    if (!prompt) return;
    addMessage("user", `[Image Request] ${prompt}`);
    userInput.value = "";
    try {
      const res = await fetch("https://web-production-9a18.up.railway.app/imagegen", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt, style: "anime" })
      });
      const data = await res.json();
      const imgUrl = data.url || "";
      const msgDiv = document.createElement("div");
      msgDiv.className = "message ai";
      msgDiv.innerHTML = `
        <div class="bubble"><img src="${imgUrl}" alt="Generated Image" style="max-width:100%"></div>
        <div class="msg-actions">
          <i class="fa-solid fa-copy" title="Copy"></i>
          <i class="fa-solid fa-share" title="Share"></i>
        </div>
      `;
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    } catch (err) {
      addMessage("ai", "‚ö†Ô∏è Image generation failed.");
    }
  };

  // === Emojis (simple) ===
  emojiBtn.onclick = () => {
    userInput.value += "üòä";
    userInput.focus();
  };

  // === New Chat ===
  newChatBtn.onclick = () => {
    currentChat = { id: Date.now(), title: "New Chat", messages: [] };
    chatWindow.innerHTML = "";
    renderChatList();
  };

  // === Profile Modal ===
  const profileModal = document.getElementById("profileModal");
  const profileClose = document.getElementById("profileClose");
  profileClose.onclick = () => profileModal.style.display = "none";

  // === Logout ===
  document.getElementById("logoutBtn").onclick = () => {
    alert("Logged out!");
  };

  // ==== AI CALL FEATURE ====
  const aiCallModal = document.getElementById("ai-call-modal");
  const callEndBtn = document.getElementById("callEnd");
  const callMuteBtn = document.getElementById("callMuteBtn");
  const callDownloadBtn = document.getElementById("callDownloadBtn");
  const transcriptEl = document.getElementById("callTranscript");
  const callStatus = document.getElementById("callStatus");
  const callTimer = document.getElementById("callTimer");

  let callActive = false, recognition, mediaStream, muted = false;
  let callStartTime, timerInterval;

  function appendTranscript(role, text) {
    const div = document.createElement("div");
    div.innerHTML = `<b style="color:${role === "ai" ? "#0ff" : "#fff"}">${role.toUpperCase()}:</b> ${text}`;
    transcriptEl.appendChild(div);
    transcriptEl.scrollTop = transcriptEl.scrollHeight;
  }

  function startTimer() {
    callStartTime = Date.now();
    timerInterval = setInterval(() => {
      const diff = Math.floor((Date.now() - callStartTime) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, "0");
      const s = String(diff % 60).padStart(2, "0");
      callTimer.textContent = `Call Duration: ${m}:${s}`;
    }, 1000);
  }
  function stopTimer() { clearInterval(timerInterval); callTimer.textContent = ""; }

  async function speakAI(text) {
    callStatus.textContent = "Speaking...";
    try {
      const vres = await fetch("https://web-production-9a18.up.railway.app/voicegen", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, voice: "podcast" })
      });
      const blob = await vres.blob();
      const audio = new Audio(URL.createObjectURL(blob));
      return new Promise(res => {
        audio.onended = () => { callStatus.textContent = "Listening..."; if (callActive && !muted) startRecognition(); res(); };
        audio.play();
      });
    } catch (err) { appendTranscript("ai", "‚ö†Ô∏è Voice error."); }
  }

  function startRecognition() {
    if (!callActive || muted) return;
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-US";
    recognition.continuous = false;

    recognition.onresult = async e => {
      const userText = e.results[0][0].transcript;
      appendTranscript("user", userText);
      callStatus.textContent = "Thinking...";
      try {
        const res = await fetch("https://web-production-9a18.up.railway.app/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: userText })
        });
        const data = await res.json();
        const reply = data.reply || data.response || "Hmm...";
        appendTranscript("ai", reply);
        await speakAI(reply);
      } catch (err) { appendTranscript("ai", "‚ö†Ô∏è Error."); }
    };
    recognition.onend = () => { if (callActive && !muted) setTimeout(startRecognition, 500); };
    recognition.start();
  }

  callBtn.onclick = () => {
    if (callActive) return;
    callActive = true;
    aiCallModal.style.display = "flex";
    transcriptEl.innerHTML = "";
    callStatus.textContent = "Ringing...";
    const ringtone = new Audio("https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg");
    ringtone.loop = true; ringtone.play();
    setTimeout(async () => {
      ringtone.pause(); ringtone.currentTime = 0;
      appendTranscript("ai", "Hello, this is Philadelphia AI. You're now connected.");
      callStatus.textContent = "Listening...";
      startTimer();
      startRecognition();
    }, 3000);
  };

  callEndBtn.onclick = () => {
    callActive = false;
    aiCallModal.style.display = "none";
    stopTimer();
    if (recognition) recognition.stop();
    if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
  };

  callMuteBtn.onclick = () => {
    muted = !muted;
    callStatus.textContent = muted ? "Muted" : "Listening...";
    callMuteBtn.innerHTML = muted
      ? '<i class="fa-solid fa-microphone-slash"></i>'
      : '<i class="fa-solid fa-microphone"></i>';
  };

  callDownloadBtn.onclick = () => {
    const blob = new Blob([transcriptEl.innerText], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "call_transcript.txt";
    a.click();
    URL.revokeObjectURL(url);
  };
});
  </script>
</body>
</html>
