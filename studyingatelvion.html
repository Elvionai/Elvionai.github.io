<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Elvion LMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Your Elvion University learning dashboard. Track progress, access courses, and update your profile." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ---------------------- 1. THEME & GLOBALS ---------------------- */
    :root {
      --cyan: #00ffff;
      --blue: #0090ff;
      --dark-blue: #0a1128;
      --card-bg: rgba(18,26,48,0.97);
      --header-bg: rgba(18,26,48,0.99);
      --border-glow: 0 0 11px var(--cyan), 0 0 24px var(--blue);
      --radius: 15px;
      --bg: #0a1128;
      --text: #e0e0e0;
      --muted: #a7b2c3;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(120deg, #181d32 50%, #132142 100%);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      transition: margin-left .3s; /* For sidebar integration */
    }
    
    /* ---------------------- 2. HEADER & PROFILE ---------------------- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 24px 4vw 8px 4vw; background: var(--header-bg); 
      box-shadow: var(--border-glow); border-radius:0 0 28px 28px;
      position: sticky; top: 0; z-index: 100; /* Sticky header for better UX */
    }
    .title { font-family:Orbitron,sans-serif; font-size:1.63em; color:var(--cyan); text-shadow:var(--border-glow);}
    .profile {
      display:flex; align-items:center; gap:13px; 
      background: #181e36; border-radius:12px; padding:8px 17px;
      box-shadow: 0 0 16px 2px #00ffff07;
    }
    .profile-img {
      width:52px; height:52px; border-radius:50%; background:#232857;
      object-fit:cover; border:2px solid var(--cyan);
    }
    .profile-info b { color:var(--cyan);}
    .prof-actions { margin-left:14px; display: flex; gap: 7px;}
    .prof-actions button {
      background: none; border:none; color:var(--cyan); cursor:pointer;
      font-size:1.25em; opacity:.85; transition: opacity .2s;
      vertical-align: middle;
    }
    .prof-actions button:hover { opacity: 1; text-shadow: 0 0 5px var(--cyan);}
    
    /* ---------------------- 3. MAIN CONTENT & GRID ---------------------- */
    main { max-width:1060px; margin:28px auto 0 auto; padding:20px;}
    h2 { font-family:Orbitron,sans-serif; color:var(--cyan); margin-bottom:20px; }
    .courses-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:2em;
      margin-bottom:28px;
    }
    .course-card {
      background: var(--card-bg); border-radius:var(--radius); padding:20px 16px;
      box-shadow: var(--border-glow);
      display: flex; flex-direction:column; gap:13px;
      cursor: pointer; transition: box-shadow .17s, transform .19s, border .17s;
      border:2.1px solid #131b30;
      position: relative;
    }
    /* LOCKED STATE STYLES */
    .course-card.locked { 
        cursor: not-allowed;
        opacity: 0.55;
        box-shadow: 0 0 5px #ff000030;
        border-color: #ff000030;
    }
    .course-card.locked:hover {
        box-shadow: 0 0 5px #ff000030;
        border-color: #ff000030;
        transform: none;
    }
    /* NORMAL HOVER STATE */
    .course-card:not(.locked):hover {
      box-shadow: 0 0 22px var(--cyan),0 0 44px #00c2ff49;
      border:2.1px solid var(--cyan);
      transform: scale(1.02);
      z-index:4;
    }
    .course-card.completed { border-color: #00ff88; box-shadow: 0 0 10px #00ff8855; }

    .course-header { display: flex; align-items: center; justify-content: space-between; }
    .course-title {font-size:1.19em; font-weight:700; color:#fff; font-family:Orbitron,sans-serif; }
    .course-icon { font-size: 1.5em; color: var(--cyan); }
    .course-intro {font-size:.97em; color:var(--muted); flex-grow: 1;}
    .course-meta { font-size:.92em; color:var(--cyan);}
    
    /* PROGRESS BAR STYLES */
    .progress-container {
      height: 7px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
      margin-bottom: 7px;
    }
    .progress-bar {
      height: 100%;
      width: 0%; /* Dynamic via JS */
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      transition: width 0.5s ease-out;
      box-shadow: 0 0 5px var(--cyan);
    }
    .progress-text {
      font-size: 0.9em;
      font-weight: 600;
      color: var(--cyan);
      text-align: right;
      font-family: Orbitron, sans-serif;
    }

    /* START BUTTON */
    .start-btn {
      margin-top:9px;
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      color: #161d28; border: none; border-radius: 12px; padding: 8px 0;
      font-size: 1em; font-family:'Orbitron',sans-serif; font-weight:700; cursor:pointer;
      box-shadow: 0 0 13px #00c3ff99;
      text-transform:uppercase;
      letter-spacing:.04em;
      transition: background .11s, transform .10s;
    }
    .start-btn:hover { background: var(--blue); color:#fff; transform:scale(1.02);}
    .start-btn:active { transform:scale(0.99);}
    .start-btn:disabled {
        background: #333;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        color: #999;
    }
    
    /* ---------------------- 4. COURSE DETAILS, MODAL, & STUDY SCREEN ---------------------- */
    .course-details {
      padding:23px 19px 11px 19px; margin:20px auto; background:rgba(15,32,60,0.91);
      border-radius:14px; box-shadow:0 0 19px #0090ff18;
      max-width:600px; display:none; animation:fadeInDetail .85s;
    }
    @keyframes fadeInDetail {from{opacity:0;transform:translateY(15px);}to{opacity:1; transform:translateY(0);}}
    
    /* STUDY SCREEN STYLES */
    #study-content h4 { color: var(--cyan); margin-top: 20px;}
    #study-content code { background: #0c152a; color: #00ff88; padding: 2px 5px; border-radius: 4px; font-family: monospace;}
    #study-content b { color: var(--blue); }

    /* Modal styles remain the same */
    .edit-modal-bg {
      position: fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(5,19,38,.69); display:none; align-items:center; justify-content:center; z-index:5000;
    }
    .edit-modal {
      background:rgba(18,27,38,0.99); color:#e0e0e0; border-radius:14px; padding:27px 21px; min-width:320px;
      box-shadow:0 0 30px #00fff2,0 0 12px #0071cf55; position:relative; max-width:98vw;
    }
    .edit-modal label {color:var(--cyan);font-family:Orbitron,sans-serif;font-size:.97em;margin-bottom:3px;display:block;}
    .edit-modal input,.edit-modal textarea{
      width:100%; max-width:400px; padding:7px 10px; border-radius:8px; border:1.5px solid #274355;
      background:#131c2c; color:#f5f5f5; font-size:1em; font-family:Inter,sans-serif;margin-bottom:13px;
    }   
    .edit-modal .btns { text-align:right;margin-top:7px;}
    .edit-modal .btns button {
      background:var(--cyan); color:#222; border:none; border-radius:7px; font-family:Orbitron,sans-serif;
      padding:7.2px 26px; margin-left:7px; font-weight:700; text-transform:uppercase; font-size: 1em; letter-spacing:.04em;
      box-shadow:0 0 4px #0fffff60; cursor:pointer;
      transition:background .11s;
    }
    .edit-modal .btns button.cancel {background:#19243c; color:#aee;}
    .edit-close {position:absolute;right:14px;top:14px;font-size:1.7em;color:#00ffff;cursor:pointer;}
    
    /* ---------------------- 5. RESPONSIVENESS & STARS ---------------------- */
    @media (max-width:650px){ header,main{padding:13px!important;} .course-details{padding:12px 7px;}}
    @media (max-width:410px){ .profile-img{width:38px;height:38px;} .edit-modal{padding:4vw;}}

    /* STAR BG STYLES (Simple for demo) */
    #stars-container {position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;}
    .star {
      position: absolute; background: #fff; border-radius: 50%; 
      box-shadow: 0 0 4px 1px var(--cyan);
      opacity: 0; animation: blink 2s infinite alternate;
    }
    @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; }}

  </style>
</head>
<body>
<div id="stars-container"></div>
<header>
  <span class="title">ELVION LMS</span>
  <div class="profile">
    <img id="profile-img" src="https://i.pravatar.cc/150?img=12" class="profile-img" alt="profile image" />
    <div class="profile-info">
      <div><b id="displayName">User Name</b></div>
      <small style="color:#aee;" id="user-email">user@elvion.edu</small>
    </div>
    <div class="prof-actions">
      <button title="Notifications"><i class="fa fa-bell"></i></button>
      <button title="Edit profile" id="edit-profile-btn"><i class="fa fa-user-edit"></i></button>
      <button title="Logout" id="logout-btn"><i class="fa fa-sign-out-alt"></i></button>
    </div>
  </div>
</header>
<main>
  <h2>My Computer Science Learning Path</h2>
  <p style="color:var(--muted); margin-bottom: 25px;">Progress is sequential. Complete the current course to unlock the next one. Click 'Continue Studying' to resume your daily lesson.</p>

  <div class="courses-grid" id="courses-grid"></div>
  
  <div class="course-details" id="course-details"></div>

  <section id="study-screen" style="display: none; padding: 25px 20px; background: var(--card-bg); border-radius: var(--radius); max-width: 800px; margin: 20px auto; box-shadow: var(--border-glow);">
    <button id="back-to-dashboard" style="background: none; border: none; color: var(--cyan); font-size: 1em; cursor: pointer; margin-bottom: 20px;"><i class="fa fa-arrow-left"></i> Back to Dashboard</button>
    <h2 id="study-course-title" style="margin-top: 0;"></h2>
    <h3 id="study-module-title" style="color: var(--blue);"></h3>
    
    <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
        <button id="audio-toggle-btn" class="start-btn" style="padding: 6px 15px; margin: 0; background: #19243c; color: var(--cyan); box-shadow: none; font-size: 0.9em; width: auto;">
            <i class="fa fa-volume-up"></i> Audio Read
        </button>
        <span id="tts-status" style="color: var(--muted); font-size: 0.85em;">Ready.</span>
    </div>

    <div id="study-content" style="background: #181d32; padding: 20px; border-radius: 10px; border: 1px solid #00ffff33; margin-bottom: 20px; line-height: 1.6;">
        <p style="color: var(--muted);">Content loading...</p>
    </div>

    <button id="mark-as-complete-btn" class="start-btn" style="width: 100%; margin: 0;">
        <i class="fa fa-check"></i> Mark Day Complete
    </button>
  </section>
</main>

<div class="edit-modal-bg" id="edit-modal-bg">
  <form class="edit-modal" id="edit-modal" onsubmit="return false;">
    <span class="edit-close" id="modal-close-btn">&times;</span>
    <h3 style="color:var(--cyan);text-align:center;margin-top:0">Edit Profile</h3>
    <label for="edit-name">Name</label>
    <input type="text" id="edit-name" required>
    <label for="edit-photo">Photo URL</label>
    <input type="url" id="edit-photo" placeholder="https://link.to/photo.jpg">
    <label for="edit-dob">Date of Birth</label>
    <input type="date" id="edit-dob">
    <label for="edit-bio">Bio/About Me</label>
    <textarea id="edit-bio" rows="2" placeholder="A few words about you"></textarea>
    <div class="btns">
      <button type="button" id="save-profile-btn">Save</button>
      <button type="button" class="cancel" id="cancel-profile-btn">Cancel</button>
    </div>
  </form>
</div>

<script type="module">
  // STAR BG (Simplified for efficiency)
  document.addEventListener('DOMContentLoaded', () => {
    const starsContainer = document.getElementById('stars-container');
    const numStars = 45, minSize = 1, maxSize = 2.5;
    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * (maxSize - minSize) + minSize;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 4) + 's';
      star.style.animationDuration = (2.4 + Math.random() * 1.8) + 's';
      starsContainer.appendChild(star);
    }
  });

  // ----------------- FIREBASE SETUP (PLACEHOLDERS) -----------------
  // NOTE: In a real app, move API key management to environment variables!
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.firebasestorage.app",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let userProgress = {}; // Stores user's course progress data (simulated from Firestore/localStorage)
  let currentUser = null; // Global user object
  window.markDayComplete = null; // Defined in onAuthStateChanged

  // -------- NEW SEQUENTIAL COURSE LIST (Computer Science Path)
  const csPath = [
    { key: "csc101", title: "Introduction to Programming", code: "CSC 101", intro: "Foundations of software, programming, and digital algorithms.", icon: "fa-laptop-code", days: [
      { title: "Day 1: What is Code? & Setup", content: "<h4>What is Programming?</h4><p>Welcome! **Code** is a set of instructions a computer follows—think of it as a recipe. It tells the computer exactly what to do. Today, we focus on understanding the concept and setting up our environment.</p><p><b>Task:</b> Install Python (for this course) and a code editor like VS Code.</p>" },
      { title: "Day 2: Variables & Data Types", content: "<h4>Storing Information</h4><p>A **variable** is a reserved memory location to store values. In Python, you don't declare the type, but the data has a type.</p><p><b>Examples:</b> <ul><li><code>age = 25</code> (Integer)</li><li><code>name = 'Elvion'</code> (String/Text)</li><li><code>is_student = True</code> (Boolean)</li></ul></p>" },
      { title: "Day 3: Basic Input and Output", content: "<h4>Talking to the User</h4><p>The **Output** function, <code>print()</code>, displays information on the screen. The **Input** function, <code>input()</code>, gets data from the user and stores it in a variable.</p><p><b>Code Snippet:</b> <code>user_name = input('What is your name? ')</code></p>" },
      { title: "Day 4: Assignment Review", content: "<h4>Week 1 Checkpoint</h4><p>You have completed the first module! Review the concepts of variables, data types, and I/O. **Next week** you will start Control Flow.</p><p><b>Goal:</b> Ensure you can write a simple program that takes a user's name and prints a greeting.</p>" }
    ]},
    { key: "csc102", title: "Data Structures", code: "CSC 102", intro: "Organizing and managing data efficiently for algorithms.", icon: "fa-sitemap", days: [
      { title: "Day 1: Arrays & Lists Introduction", content: "<h4>Ordered Collections</h4><p>**Arrays** (or **Lists** in Python) are data structures that store a collection of items, accessed by an index (starting from 0). They are fundamental for storing sequential data.</p>" },
      { title: "Day 2: Stacks (LIFO)", content: "<h4>Last-In, First-Out</h4><p>A **Stack** is an abstract data type where the last element added is the first element taken out (LIFO). Think of a stack of plates.</p>" }
    ]},
    { key: "csc201", title: "Object-Oriented Programming", code: "CSC 201", intro: "Designing software using 'objects' that bundle data and methods.", icon: "fa-cubes" , days: [
        { title: "Day 1: Classes & Objects", content: "<h4>Blueprints and Instances</h4><p>An **Object** is an instance of a **Class**. A Class is a blueprint for creating objects, providing initial values for state (member variables) and implementations of behavior (member functions/methods).</p>" }
    ]},
    { key: "csc202", title: "Database Systems", code: "CSC 202", intro: "Relational theory, SQL, and database management.", icon: "fa-database" , days: [
        { title: "Day 1: SQL Basics (SELECT)", content: "<h4>Querying Data</h4><p>**SQL (Structured Query Language)** is the standard language for relational database management. The primary command for retrieval is the <code>SELECT</code> statement.</p>" }
    ]},
    { key: "csc301", title: "Software Engineering", code: "CSC 301", intro: "Systematic approach to software design, development, and maintenance.", icon: "fa-rocket" , days: [{ title: "Day 1: Agile & Scrum", content: "<h4>Iterative Development</h4><p>**Agile** is an iterative approach to project management. **Scrum** is a lightweight framework within Agile that helps teams work together on complex products.</p>" }]},
    { key: "csc302", title: "Computer Networks", code: "CSC 302", intro: "Concepts of networking, protocols, and the internet architecture.", icon: "fa-network-wired" , days: [{ title: "Day 1: OSI Model Overview", content: "<h4>7 Layers of Communication</h4><p>The **OSI (Open Systems Interconnection)** Model describes the functions of a telecommunication system by dividing it into 7 layers, from Physical to Application.</p>" }]},
    { key: "csc401", title: "Artificial Intelligence", code: "CSC 401", intro: "Machine learning, neural networks, and intelligent systems.", icon: "fa-brain" , days: [{ title: "Day 1: Introduction to AI", content: "<h4>What is Intelligence?</h4><p>**Artificial Intelligence** is a wide-ranging branch of computer science concerned with building smart machines capable of performing tasks that typically require human intelligence.</p>" }]},
    { key: "csc402", title: "Final Year Project", code: "CSC 402", intro: "Capstone project to apply all learned concepts.", icon: "fa-trophy" , days: [{ title: "Day 1: Proposal Phase", content: "<h4>Defining the Project</h4><p>Today's focus is on defining your problem, scope, objectives, and proposed solution. This proposal will guide your development over the semester.</p>" }]}
  ];


  // ----------------- CORE LMS FUNCTIONS -----------------
  
  // Calculates overall progress for a course based on completed days
  function calculateCourseProgress(courseKey) {
    const course = csPath.find(c => c.key === courseKey);
    if (!course) return 0;
    const totalDays = course.days.length;
    const completedDays = userProgress[courseKey]?.completedDays || 0;
    return totalDays > 0 ? Math.floor((completedDays / totalDays) * 100) : 100; // Return 100 if days is 0 (shouldn't happen here)
  }

  // Find the key for the next module/day to study in a course
  function findNextModule(courseKey) {
      const course = csPath.find(c => c.key === courseKey);
      if (!course) return null;
      const completedDays = userProgress[courseKey]?.completedDays || 0;
      
      // If completedDays is less than total days, return the next one
      if (completedDays < course.days.length) {
          return {
              moduleIndex: completedDays,
              moduleData: course.days[completedDays]
          };
      }
      return null; // Course is fully completed
  }


  // Populate course grid with progress bars and dynamic buttons
  function renderCourses() {
    const cg = document.getElementById("courses-grid");
    cg.innerHTML = ""; // Clear existing content
    let isPreviousCompleted = true; // Sequential check flag
    
    csPath.forEach((c, index) => {
        const overallProgress = calculateCourseProgress(c.key);
        const isCompleted = overallProgress >= 100;
        const isLocked = !isPreviousCompleted;
        const nextModule = findNextModule(c.key);

        // Determine status and button text
        let statusClass = isCompleted ? 'completed' : (isLocked ? 'locked' : (overallProgress > 0 ? 'in-progress' : 'new'));
        let buttonText = isCompleted ? 'Review Course' : (overallProgress > 0 ? 'Continue Studying' : 'Start Studying');
        
        const buttonDisabled = isLocked ? 'disabled' : '';

        const card = document.createElement('div');
        card.className = `course-card ${statusClass}`;
        card.dataset.key = c.key;
            
        card.onclick = isLocked ? (e) => {
            alert(`⛔ Course Locked: You must complete ${csPath[index-1]?.code} first.`);
        } : (e) => {
            if (e.target.closest('.start-btn')) return;
            selectCourse(c.key);
        };

        // Determine intro/module status
        let currentStatusText = "";
        if (isCompleted) {
            currentStatusText = "COMPLETED! ✅";
        } else if (overallProgress > 0) {
            currentStatusText = `Next: ${nextModule.moduleData.title}`;
        } else if (!isLocked) {
             currentStatusText = "Start your 4-day module.";
        } else {
             currentStatusText = "LOCKED: Complete prerequisite first.";
        }


        card.innerHTML = `
            <div class="course-header">
                <div class="course-title">${c.title}</div>
                <i class="fa ${c.icon || 'fa-graduation-cap'} course-icon" title="${c.code}"></i>
            </div>
            <div class="course-meta">${c.code}</div>
            <div class="progress-text">${isCompleted ? '100% Completed' : overallProgress + '% Progress'}</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: ${overallProgress}%;"></div>
            </div>
            <div class="course-intro" style="font-style: italic;">${currentStatusText}</div>
            <button class="start-btn" data-key="${c.key}" ${buttonDisabled} onclick="event.stopPropagation(); startStudying('${c.key}');">${buttonText}</button>
        `;
        
        cg.appendChild(card);
        
        // Update sequential flag for the next iteration
        isPreviousCompleted = isCompleted;
    });
  }

  // Course Details Display (now shows module breakdown)
  function selectCourse(key) {
    const c = csPath.find(x => x.key === key);
    if (!c) return;
    const cont = document.getElementById('course-details');
    const overallProgress = calculateCourseProgress(c.key);
    const completedDays = userProgress[key]?.completedDays || 0;
    
    let modulesHtml = `<ul style="list-style: none; padding: 0; font-size: 0.95em;">`;
    c.days.forEach((module, index) => {
        const isCompleted = index < completedDays;
        const isCurrent = index === completedDays;
        const icon = isCompleted ? 'fa-check-circle' : (isCurrent ? 'fa-arrow-circle-right' : 'fa-circle');
        const color = isCompleted ? '#00ff88' : (isCurrent ? 'var(--cyan)' : 'var(--muted)');
        
        modulesHtml += `
            <li style="margin-bottom: 8px;">
                <i class="fa ${icon}" style="color:${color}; margin-right: 5px;"></i> ${module.title}
                <span style="float:right; color:${isCompleted ? '#00ff88' : 'var(--muted)'};">${isCompleted ? 'Completed' : (isCurrent ? 'NEXT' : 'Pending')}</span>
            </li>`;
    });
    modulesHtml += `</ul>`;

    cont.innerHTML = `
      <h3 style="color:var(--cyan);margin-top:0">${c.title} Module Breakdown</h3>
      <div style="color:var(--cyan); font-size:1.1em; margin-bottom:10px;">${c.code} &middot; ${c.intro}</div>
      <div class="progress-container" style="height: 10px;">
        <div class="progress-bar" style="width: ${overallProgress}%;"></div>
      </div>
      <div class="progress-text" style="text-align: left; margin-bottom: 20px;">${overallProgress}% Overall Progress (${completedDays}/${c.days.length} Days)</div>
      
      ${modulesHtml}
      
      <button class="start-btn" style="margin-top:2em;" onclick="startStudying('${c.key}');">
        ${overallProgress >= 100 ? 'Review Course Content' : (overallProgress > 0 ? 'Continue Studying' : 'Begin Study')}
      </button>
    `;
    cont.style.display = "block";
    window.scrollTo({ top: cont.offsetTop - 100, behavior: "smooth" });
  }

  // The new 'Learning Screen' logic
  function startStudying(key) {
    const course = csPath.find(x => x.key === key);
    if (!course) return;

    const nextModule = findNextModule(key);
    
    // Check if fully completed and button is pressed for review
    if (!nextModule) {
        // For review, we show the last module's content or a completion message
        const lastModule = course.days[course.days.length - 1];
        
        // Hide dashboard and show study screen
        hideDashboard();
        const studyScreen = document.getElementById('study-screen');
        studyScreen.style.display = 'block';

        document.getElementById('study-course-title').textContent = `${course.code}: ${course.title}`;
        document.getElementById('study-module-title').textContent = "Review: Course Completed";
        document.getElementById('study-content').innerHTML = "<h4>Course Complete</h4><p>You have successfully finished all modules for this course. Use this space for optional review materials.</p>" + lastModule.content;
        
        const completeBtn = document.getElementById('mark-as-complete-btn');
        completeBtn.textContent = 'Course Completed';
        completeBtn.disabled = true;
        
        initTTS("Course completed. Reviewing final content.");
        return;
    }
    
    // Normal study flow
    
    // Hide dashboard and show study screen
    hideDashboard();
    const studyScreen = document.getElementById('study-screen');
    studyScreen.style.display = 'block';

    document.getElementById('study-course-title').textContent = `${course.code}: ${course.title}`;
    document.getElementById('study-module-title').textContent = nextModule.moduleData.title;
    document.getElementById('study-content').innerHTML = nextModule.moduleData.content;
    
    // Setup completion button
    const completeBtn = document.getElementById('mark-as-complete-btn');
    completeBtn.textContent = `Mark Day ${nextModule.moduleIndex + 1} Complete`;
    completeBtn.disabled = false;
    completeBtn.onclick = () => window.markDayComplete(key, nextModule.moduleIndex);
    
    // Scroll to the top of the study screen
    window.scrollTo({ top: studyScreen.offsetTop - 100, behavior: "smooth" });
    
    // Initialize Text-to-Speech
    initTTS(nextModule.moduleData.content);
  }

  function hideDashboard() {
    document.querySelector('main h2').style.display = 'none';
    document.querySelector('main > p').style.display = 'none';
    document.getElementById('courses-grid').style.display = 'none';
    document.getElementById('course-details').style.display = 'none';
    // Hide search bar, if it wasn't removed earlier
    const searchInput = document.querySelector('main > div > input[type="text"]');
    if (searchInput) searchInput.style.display = 'none';
  }

  // TTS Logic
  let isAudioOn = false;
  let synth = window.speechSynthesis;
  let utterance = null;
  const audioBtn = document.getElementById('audio-toggle-btn');
  const ttsStatus = document.getElementById('tts-status');

  function initTTS(text) {
    if (!synth || !('SpeechSynthesisUtterance' in window)) {
        audioBtn.textContent = "Audio Not Supported";
        audioBtn.disabled = true;
        ttsStatus.textContent = "Browser audio features are unavailable.";
        return;
    }
    
    // Stop any previous speech
    if (synth.speaking) synth.cancel();
    isAudioOn = false;
    audioBtn.textContent = '<i class="fa fa-volume-up"></i> Audio Read';
    ttsStatus.textContent = "Ready.";

    // Clean content for speaking (remove HTML tags and newlines)
    const cleanedText = text.replace(/<[^>]*>/g, '').replace(/&middot;/g, '').replace(/&nbsp;/g, ' ').replace(/\n/g, ' ').trim();

    utterance = new SpeechSynthesisUtterance(cleanedText);
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    
    // Try to find a good voice (adjust the filter criteria for better results)
    const voices = synth.getVoices();
    utterance.voice = voices.find(voice => voice.name.includes('Google') || voice.lang.startsWith('en-US')) || voices[0];
    
    // Event listeners for feedback
    utterance.onstart = () => { ttsStatus.textContent = "Speaking..."; audioBtn.innerHTML = '<i class="fa fa-volume-down"></i> Stop Audio'; isAudioOn = true; };
    utterance.onend = () => { ttsStatus.textContent = "Playback Finished."; audioBtn.innerHTML = '<i class="fa fa-volume-up"></i> Audio Read'; isAudioOn = false; };
    utterance.onerror = (event) => { ttsStatus.textContent = `Error: ${event.error}`; isAudioOn = false; };
  }

  audioBtn.onclick = () => {
    if (!utterance || audioBtn.disabled) return;
    
    if (synth.speaking && isAudioOn) {
        synth.cancel(); // Stop completely
    } else if (synth.paused) {
        synth.resume();
    } else {
        synth.speak(utterance);
    }
  };

  // Back button logic
  document.getElementById('back-to-dashboard').addEventListener('click', () => {
    if (synth.speaking) synth.cancel();
    isAudioOn = false;
    document.getElementById('study-screen').style.display = 'none';
    document.querySelector('main h2').style.display = 'block';
    document.querySelector('main > p').style.display = 'block';
    document.getElementById('courses-grid').style.display = 'grid';
    document.getElementById('course-details').style.display = 'none'; // Hide details again
    const searchInput = document.querySelector('main > div > input[type="text"]');
    if (searchInput) searchInput.style.display = 'block';
    renderCourses(); // Re-render to update status
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Function to save and advance progress (Real/Demo implementation below)
  async function markDayComplete(courseKey, completedIndex) {
    const course = csPath.find(x => x.key === courseKey);
    const totalDays = course.days.length;

    const nextCompletedDays = completedIndex + 1;
    const isCourseCompleted = nextCompletedDays >= totalDays;

    // 1. Update local state
    userProgress[courseKey] = { completedDays: nextCompletedDays, completed: isCourseCompleted };
    
    // 2. Persist state (Firestore/LocalStorage handled in onAuthStateChanged)
    if (currentUser.uid !== "demo-user") {
        try {
            await setDoc(doc(db, "user-progress", currentUser.uid), {
                [courseKey]: { completedDays: nextCompletedDays, completed: isCourseCompleted, lastUpdated: new Date() }
            }, { merge: true });
        } catch(e) {
            console.error("Error updating progress in Firestore: ", e);
            alert("Warning: Could not save progress to the server.");
        }
    } else {
        localStorage.setItem('elvion-progress', JSON.stringify(userProgress));
    }
    
    // 3. User Feedback and Redirection
    if (isCourseCompleted) {
        alert(`🎉 Congratulations! You have completed ${course.code}. The next course is now unlocked.`);
    } else {
        alert(`Day ${nextCompletedDays} marked complete! Ready for ${course.days[nextCompletedDays]?.title || 'review'}.`);
    }
    
    // Stop audio and return to dashboard
    if (synth.speaking) synth.cancel();
    document.getElementById('back-to-dashboard').click();
  }


  // ----------------- PROFILE & AUTH FUNCTIONS -----------------
  let userDocRef = null;

  onAuthStateChanged(auth, async user => {
    if (!user) {
      // Failsafe for demo
      currentUser = { uid: "demo-user", displayName: "A. Student", email: "demo@elvion.edu", photoURL: 'https://i.pravatar.cc/150?img=12' };
    } else {
      currentUser = user;
      userDocRef = doc(db, "users", user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const extra = snap.data();
        document.getElementById('edit-dob').value = extra.dob || "";
        document.getElementById('edit-bio').value = extra.bio || "";
      }
    }
    
    // === LOAD PROGRESS DATA ===
    if (currentUser.uid === "demo-user") {
        // DEMO PERSISTENCE: Use Local Storage
        const localProgress = localStorage.getItem('elvion-progress');
        userProgress = localProgress ? JSON.parse(localProgress) : {};
    } else {
        // REAL USER: Load from Firestore (Placeholder code)
        const progressDocRef = doc(db, "user-progress", currentUser.uid);
        const progressSnap = await getDoc(progressDocRef);
        userProgress = progressSnap.exists() ? progressSnap.data() : {};
    }
    
    // Initialize or clean up progress data structure
    csPath.forEach(c => {
         if (!userProgress[c.key]) {
            userProgress[c.key] = { completedDays: 0, completed: false };
         }
    });
    
    // Expose core functions globally
    window.selectCourse = selectCourse;
    window.startStudying = startStudying;
    window.markDayComplete = markDayComplete; // Use the function defined above

    // === UPDATE UI ===
    document.getElementById("displayName").textContent = currentUser.displayName || currentUser.email.split('@')[0];
    document.getElementById("user-email").textContent = currentUser.email || "";
    document.getElementById("profile-img").src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||currentUser.email||'EV')}&background=190021&color=fff&bold=true&rounded=true&size=128`;
    
    renderCourses(); // Render courses once we have the user context
  });

  document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
    localStorage.removeItem('elvion-progress'); // Clear demo progress
    alert("Logged out! (Demo mode - Progress cleared)");
    location.reload(); 
  });

  // Modal logic (kept simple, copied from original)
  const modalBg = document.getElementById('edit-modal-bg');
  const editName = document.getElementById('edit-name');
  const editPhoto = document.getElementById('edit-photo');

  function openEditModal() {
    modalBg.style.display = "flex";
    editName.value = currentUser.displayName || "";
    editPhoto.value = currentUser.photoURL || "";
    editName.focus(); 
  }
  function closeEditModal() {
    modalBg.style.display = "none";
  }

  document.getElementById('edit-profile-btn').addEventListener('click', openEditModal);
  document.getElementById('modal-close-btn').addEventListener('click', closeEditModal);
  document.getElementById('cancel-profile-btn').addEventListener('click', closeEditModal);

  document.getElementById('save-profile-btn').addEventListener('click', async () => {
    // Save logic simplified for demo, focusing on UI update
    const name = editName.value.trim();
    const photo = editPhoto.value.trim();
    
    const saveButton = document.getElementById('save-profile-btn');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    // Simulate saving and UI update
    currentUser.displayName = name; 
    currentUser.photoURL = photo;
    document.getElementById('displayName').textContent = name;
    document.getElementById('profile-img').src = photo || document.getElementById('profile-img').src;

    // In a real app, Firebase Auth/Firestore update would go here.

    closeEditModal();
    alert('Profile saved successfully!');

    saveButton.textContent = 'Save';
    saveButton.disabled = false;
  });

</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
