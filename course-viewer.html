<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Viewer | Elvion University</title>
  <meta name="description" content="Learn with interactive courses at Elvion University">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --dark-navy: #00001a;
      --black-bg: #000000;
      --cyan-glow: #00ffff;
      --light-blue-glow: #00aaff;
      --text-color: #e0e0e0;
      --heading-color: #ffffff;
      --gradient-start: #0a1128;
      --gradient-end: #121a30;
      --card-bg: rgba(18, 26, 48, 0.85);
      --border-glow: 0 0 10px var(--cyan-glow), 0 0 20px var(--light-blue-glow);
      --hover-glow: 0 0 15px var(--cyan-glow), 0 0 30px var(--light-blue-glow);
      --button-bg: linear-gradient(45deg, var(--cyan-glow), var(--light-blue-glow));
      --button-text-color: var(--black-bg);
      --star-color: rgba(255, 255, 255, 0.7);
      --sidebar-width: 300px;
      --success-color: #4ade80;
      --warning-color: #fbbf24;
      --error-color: #f87171;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--black-bg);
      color: var(--text-color);
      line-height: 1.7;
      /* Ensured no forced overflow */
      overflow-x: hidden; 
      position: relative;
      min-height: 100vh;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Orbitron', sans-serif;
      color: var(--heading-color);
      margin-top: 0;
    }

    /* Stars Animation */
    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .star {
      position: absolute;
      background-color: var(--star-color);
      border-radius: 50%;
      opacity: 0;
      animation: twinkle 4s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1); }
    }

    /* Main Layout */
    .course-viewer-container {
      display: flex;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Course Sidebar */
    .course-sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(0, 255, 255, 0.2);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .course-sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--cyan-glow);
      text-decoration: none;
      font-weight: 600;
      padding: 0.8rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .back-btn:hover {
      background: rgba(0, 255, 255, 0.1);
    }

    .course-info {
      text-align: center;
    }

    .course-icon-large {
      font-size: 3rem;
      color: var(--cyan-glow);
      text-shadow: var(--border-glow);
      margin-bottom: 1rem;
    }

    .course-title {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: var(--heading-color);
    }

    .course-subtitle {
      font-size: 0.9rem;
      color: var(--text-color);
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .overall-progress {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .progress-label {
      font-size: 0.85rem;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(0, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--button-bg);
      border-radius: 10px;
      transition: width 0.8s ease;
      box-shadow: 0 0 10px var(--cyan-glow);
    }

    .progress-text {
      font-size: 0.85rem;
      color: var(--cyan-glow);
      font-weight: 600;
    }

    /* Lessons List */
    .lessons-list {
      padding: 1rem 0;
    }

    .lessons-header {
      padding: 0 1.5rem 1rem 1.5rem;
      font-size: 1.1rem;
      color: var(--heading-color);
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .lesson-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .lesson-item:hover {
      background: rgba(0, 255, 255, 0.05);
    }

    .lesson-item.active {
      background: rgba(0, 255, 255, 0.1);
      border-left-color: var(--cyan-glow);
    }

    .lesson-item.completed {
      opacity: 0.8;
    }

    .lesson-status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .lesson-status.completed {
      background: var(--success-color);
      color: var(--black-bg);
    }

    .lesson-status.current {
      background: var(--cyan-glow);
      color: var(--black-bg);
      font-weight: 700;
    }
    
    .lesson-status.accessible {
      background: rgba(0, 255, 255, 0.2);
      color: var(--text-color);
    }

    .lesson-status.locked {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
    }

    .lesson-details {
      flex: 1;
    }

    .lesson-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--heading-color);
      margin-bottom: 0.3rem;
    }

    .lesson-duration {
      font-size: 0.8rem;
      color: var(--text-color);
      opacity: 0.7;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 101;
      background: var(--card-bg);
      border: 1px solid var(--cyan-glow);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      color: var(--cyan-glow);
      cursor: pointer;
      box-shadow: var(--border-glow);
    }

    /* Content Area */
    .content-area {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .content-header {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .lesson-info h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .lesson-meta {
      display: flex;
      gap: 1.5rem;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .lesson-meta span {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .content-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .action-btn {
      padding: 0.8rem 1.5rem;
      background: var(--button-bg);
      color: var(--button-text-color);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .action-btn:hover {
      box-shadow: var(--border-glow);
      transform: scale(1.05);
    }

    .action-btn.secondary {
      background: transparent;
      border: 2px solid var(--cyan-glow);
      color: var(--cyan-glow);
    }

    .action-btn.secondary:hover {
      background: var(--cyan-glow);
      color: var(--black-bg);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    }

    .content-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--border-glow);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 255, 0.1);
      margin-bottom: 2rem;
      /* Ensures content fits without horizontal scroll */
      overflow-x: hidden;
    }

    .lesson-content {
      line-height: 1.8;
      font-size: 1.1rem;
      max-width: 100%; /* Ensure content respects container width */
    }

    .lesson-content h2 {
      color: var(--cyan-glow);
      margin: 2rem 0 1rem 0;
      font-size: 1.4rem;
    }

    .lesson-content h3 {
      color: var(--heading-color);
      margin: 1.5rem 0 0.8rem 0;
      font-size: 1.2rem;
    }

    .lesson-content p {
      margin-bottom: 1.2rem;
    }

    .lesson-content ul, .lesson-content ol {
      margin: 1rem 0 1rem 2rem;
    }

    .lesson-content li {
      margin-bottom: 0.5rem;
    }

    .lesson-content code {
      background: rgba(0, 255, 255, 0.1);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: var(--cyan-glow);
      font-family: 'Courier New', monospace;
      white-space: nowrap; /* Prevent inline code from wrapping unnaturally */
    }

    .lesson-content pre {
      background: rgba(0, 0, 0, 0.5);
      padding: 1.5rem;
      border-radius: 8px;
      border-left: 4px solid var(--cyan-glow);
      overflow-x: auto;
      margin: 1.5rem 0;
    }

    .lesson-content pre code {
      background: none;
      padding: 0;
      color: var(--text-color);
      display: block; /* Allows pre-wrapped content to fill the block */
      white-space: pre;
    }
    
    /* Interactive Code Block Styling */
    .interactive-code-block {
      background: #1e1e1e; /* Darker background for code editor feel */
      border-radius: 8px;
      border: 1px solid var(--light-blue-glow);
      margin: 2rem 0;
      box-shadow: 0 0 10px rgba(0, 170, 255, 0.5);
      overflow: hidden;
    }
    .code-toolbar {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: rgba(0, 255, 255, 0.1);
      border-bottom: 1px solid var(--cyan-glow);
      font-size: 0.9rem;
      color: var(--text-color);
    }
    .code-editor-placeholder {
      padding: 1rem;
      font-family: 'Courier New', monospace;
      color: #d4d4d4;
      min-height: 150px;
      overflow-x: auto;
    }

    /* Video Player Placeholder */
    .video-player {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      border: 1px solid rgba(0, 255, 255, 0.2);
    }

    .video-placeholder {
      text-align: center;
      color: var(--text-color);
    }

    .video-placeholder i {
      font-size: 4rem;
      color: var(--cyan-glow);
      margin-bottom: 1rem;
      display: block;
    }
    .video-player.media-audio {
      height: 100px; /* Smaller height for audio */
    }
    .video-player audio {
        width: 90%;
        margin: 0 auto;
    }

    /* Navigation Controls */
    .lesson-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 255, 255, 0.1);
    }

    .nav-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .lesson-indicator {
      background: rgba(0, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid rgba(0, 255, 255, 0.3);
    }

    .nav-buttons {
      display: flex;
      gap: 1rem;
    }

    /* Quiz/Assessment Styles */
    .quiz-container {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--border-glow);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 255, 0.1);
      margin-top: 2rem;
      margin-bottom: 2rem;
    }
    .quiz-question-counter {
        color: var(--warning-color);
        font-size: 1rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .quiz-question {
      font-size: 1.2rem;
      color: var(--heading-color);
      margin-bottom: 1.5rem;
    }

    .quiz-options {
      display: grid;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .quiz-input-container {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
    }
    .quiz-input {
        flex: 1;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(0, 255, 255, 0.2);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 1rem;
        outline: none;
        transition: border-color 0.3s ease;
    }
    .quiz-input:focus {
        border-color: var(--cyan-glow);
    }

    .quiz-option {
      padding: 1rem 1.5rem;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-color);
    }

    .quiz-option:hover {
      border-color: var(--cyan-glow);
      background: rgba(0, 255, 255, 0.05);
    }

    .quiz-option.selected {
      border-color: var(--cyan-glow);
      background: rgba(0, 255, 255, 0.1);
      color: var(--cyan-glow);
    }

    .quiz-option.correct {
      border-color: var(--success-color);
      background: rgba(74, 222, 128, 0.1);
      color: var(--success-color);
    }

    .quiz-option.incorrect {
      border-color: var(--error-color);
      background: rgba(248, 113, 113, 0.1);
      color: var(--error-color);
    }

    .quiz-feedback {
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
    }

    .quiz-feedback.correct {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: var(--success-color);
    }

    .quiz-feedback.incorrect {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--error-color);
    }
    
    .quiz-result {
        background: rgba(0, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 10px;
        margin-top: 1rem;
        text-align: center;
        font-size: 1.2rem;
        color: var(--cyan-glow);
        font-weight: 600;
        border: 1px solid var(--cyan-glow);
    }
    
    .quiz-timer {
        font-size: 1.2rem;
        color: var(--warning-color);
        margin-bottom: 1rem;
        text-align: right;
        font-weight: 700;
        font-family: 'Orbitron', sans-serif;
    }

    /* Completion Modal */
    .completion-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overflow-y: auto; /* Allow scroll for certificate form */
    }

    .completion-content {
      background: var(--card-bg);
      padding: 3rem;
      border-radius: 15px;
      text-align: center;
      max-width: 600px;
      box-shadow: var(--hover-glow);
      border: 1px solid rgba(0, 255, 255, 0.3);
      margin: 20px;
    }

    .completion-icon {
      font-size: 4rem;
      color: var(--success-color);
      margin-bottom: 1rem;
    }

    .completion-title {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: var(--heading-color);
    }

    .completion-message {
      color: var(--text-color);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .points-earned {
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      color: #ffd700;
    }
    
    /* Certificate Form Styling */
    .certificate-form {
        text-align: left;
        padding: 1.5rem;
        border: 1px solid var(--cyan-glow);
        border-radius: 10px;
        margin-top: 2rem;
        background: rgba(0, 0, 0, 0.3);
    }
    .certificate-form h3 {
        color: var(--cyan-glow);
        margin-bottom: 1rem;
        text-align: center;
    }
    .certificate-form label {
        display: block;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        font-weight: 500;
    }
    .certificate-form input, .certificate-form textarea {
        width: 100%;
        padding: 0.8rem;
        border-radius: 5px;
        border: 1px solid rgba(0, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
        color: var(--text-color);
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }
    .certificate-form input:focus, .certificate-form textarea:focus {
        border-color: var(--light-blue-glow);
        outline: none;
    }
    .certificate-form button {
        width: 100%;
        margin-top: 2rem;
        padding: 1rem;
    }
    
    /* Project Submission Info */
    .project-submission-info {
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        color: var(--warning-color);
    }


    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(0, 255, 255, 0.1);
      border-top-color: var(--cyan-glow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 1rem;
      color: var(--text-color);
      font-size: 1.1rem;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .course-sidebar {
        transform: translateX(-100%);
        width: 100%; /* Sidebar takes full width on mobile */
        height: 100%;
      }

      .course-sidebar.active {
        transform: translateX(0);
      }

      .content-area {
        margin-left: 0;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .main-content {
        padding: 1rem;
        padding-top: 4rem;
      }

      .content-header {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
      }

      .content-actions {
        width: 100%;
        justify-content: stretch;
      }

      .action-btn {
        flex: 1;
        justify-content: center;
      }

      .lesson-navigation {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }

      .nav-buttons {
        width: 100%;
        justify-content: stretch;
      }

      .nav-buttons .action-btn {
        flex: 1;
      }
    }

    @media (max-width: 768px) {
      .video-player {
        height: 250px;
      }

      .content-card {
        padding: 1.5rem;
      }

      .completion-content {
        margin: 1rem;
        padding: 2rem;
      }

      .quiz-option {
        padding: 0.8rem 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </button>

  <div class="course-viewer-container">
    <aside class="course-sidebar" id="courseSidebar">
      <div class="course-sidebar-header">
        <a href="studyingatelvion.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        
        <div class="course-info">
          <i id="courseIconLarge" class="course-icon-large"></i>
          <h2 id="courseTitle" class="course-title">Loading...</h2>
          <p id="courseSubtitle" class="course-subtitle">Please wait...</p>
          
          <div class="overall-progress">
            <div class="progress-label">Overall Progress</div>
            <div class="progress-bar-container">
              <div id="overallProgressBar" class="progress-bar-fill" style="width: 0%"></div>
            </div>
            <div id="overallProgressText" class="progress-text">0% Complete</div>
          </div>
        </div>
      </div>

      <div class="lessons-list">
        <div class="lessons-header">Course Lessons</div>
        <div id="lessonsContainer">
          </div>
      </div>
    </aside>

    <main class="content-area">
      <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading course content...</p>
      </div>

      <header class="content-header" id="contentHeader" style="display: none;">
        <div class="lesson-info">
          <h1 id="lessonTitle">Lesson Title</h1>
          <div class="lesson-meta">
            <span><i class="fas fa-clock"></i> <span id="lessonDuration">45 min</span></span>
            <span><i class="fas fa-book"></i> Lesson <span id="currentLessonNumber">1</span> of <span id="totalLessons">8</span></span>
            <span><i class="fas fa-star"></i> <span id="lessonPoints">10</span> Points</span>
          </div>
        </div>
        <div class="content-actions">
          </div>
      </header>

      <section class="main-content" id="mainContent" style="display: none;">
        <div class="video-player" id="mediaPlayer">
          <div class="video-placeholder">
            <i class="fas fa-play-circle"></i>
            <p>Media content loading...</p>
          </div>
        </div>

        <div class="content-card">
          <div id="lessonContent" class="lesson-content">
            </div>
        </div>

        <div id="quizContainer" class="quiz-container" style="display: none;">
            <div class="quiz-timer" id="quizTimer"></div>
            <h2 style="margin-bottom: 1.5rem; text-align: center;">Mandatory Knowledge Check 📝</h2>
            <p style="text-align: center; color: var(--warning-color); margin-bottom: 2rem;">You must answer all questions correctly to unlock the next lesson. You have 3 minutes.</p>
            <div id="quizQuestions">
                </div>
            <div id="quizSummary" class="quiz-result" style="display: none;"></div>
            <button id="submitQuizBtn" class="action-btn" style="width: 100%; margin-top: 1rem;">Submit Answers</button>
        </div>
      </section>

      <nav class="lesson-navigation" id="lessonNavigation" style="display: none;">
        <div class="nav-info">
          <div class="lesson-indicator">
            Lesson <span id="navCurrentLesson">1</span> of <span id="navTotalLessons">8</span>
          </div>
          <span><i class="fas fa-trophy"></i> <span id="totalPointsEarned">0</span> Points Earned</span>
        </div>
        <div class="nav-buttons">
          <button id="prevLessonBtn" class="action-btn secondary">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button id="nextLessonBtn" class="action-btn" disabled>
            Next Lesson
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </nav>
    </main>
  </div>

  <div id="completionModal" class="completion-modal">
    <div class="completion-content">
      <i class="fas fa-trophy completion-icon"></i>
      <h2 class="completion-title" id="modalCompletionTitle">Course Complete!</h2>
      <p class="completion-message" id="modalCompletionMessage">
        Congratulations! You've successfully completed this course.
      </p>
      <div class="points-earned">
        <i class="fas fa-star"></i>
        Total Points Earned: <span id="modalTotalPoints">0</span>
      </div>
      
      <div class="project-submission-info">
          <i class="fas fa-envelope"></i>
          <p>For official certification, please submit your **Final Year Project** (if applicable) to: <strong style="color: #ffd700;">elvionailabs@gmail.com</strong></p>
          <p>Certificates will be issued by mail upon project review.</p>
      </div>

      <form class="certificate-form" action="https://formspree.io/f/mldrbpwo" method="POST">
        <h3>Apply for Your Certificate of Completion</h3>
        <p style="font-size: 0.9rem; margin-bottom: 1.5rem; color: var(--text-color);">Fill this form to receive your Elvion University Pre-Degree Certificate via email.</p>
        
        <input type="hidden" name="Course Completed" id="certificateCourseName">
        
        <label for="fullName">Full Name (for Certificate):</label>
        <input type="text" name="Full Name" id="fullName" required>
        
        <label for="emailAddress">Email Address (for Delivery):</label>
        <input type="email" name="Email" id="emailAddress" required>
        
        <label for="phone">Phone Number (Optional):</label>
        <input type="tel" name="Phone Number" id="phone">
        
        <label for="projectStatus">Project Status (Check one):</label>
        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem; font-size: 0.95rem;">
            <input type="radio" id="projectSubmitted" name="Project Status" value="Submitted via Email" required> <label for="projectSubmitted" style="display: inline;">Project Submitted</label>
            <input type="radio" id="projectNotApplicable" name="Project Status" value="Not Applicable (Course has no project)" required> <label for="projectNotApplicable" style="display: inline;">N/A</label>
        </div>

        <button type="submit" class="action-btn">
          <i class="fas fa-award"></i> Submit & Get Certificate
        </button>
      </form>

      <div style="margin-top: 2.5rem; padding: 1rem 0; border-top: 1px solid rgba(0, 255, 255, 0.1); font-size: 0.9rem;">
          <p style="color: var(--cyan-glow); margin-bottom: 0.8rem;">We'd love your feedback! Let us know what you thought of the course.</p>
          <form action="https://formspree.io/f/mldrbpwo" method="POST">
              <input type="hidden" name="Feedback Source" value="Course Completion Modal">
              <input type="hidden" name="Course Name" id="feedbackCourseName">
              <textarea name="Feedback/Comment" rows="3" placeholder="Thank you Elvion! This course on [Course Name] was fantastic because..." style="width: 100%; padding: 0.8rem; border-radius: 5px; border: 1px solid rgba(0, 255, 255, 0.3); background: rgba(0, 0, 0, 0.5); color: var(--text-color); font-size: 1rem;"></textarea>
              <button type="submit" class="action-btn secondary" style="width: 100%; margin-top: 1rem; background: rgba(0, 255, 255, 0.1); color: var(--cyan-glow); border: 2px solid var(--cyan-glow);">Send Feedback</button>
          </form>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button id="backToDashboardBtn" class="action-btn secondary" style="flex: 1; border-color: var(--success-color); color: var(--success-color);">
          <i class="fas fa-home"></i> Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UPDATED COURSES DATABASE WITH NEW CONTENT, MEDIA, AND QUIZZES ---
    const coursesDatabase = {
        'science-tech': {
            facultyName: 'Faculty of Science & Technology',
            courses: [
                {
                    id: 'cs101',
                    title: 'Computer Science',
                    description: 'Fundamentals of computing, programming, and algorithms',
                    icon: 'fas fa-laptop-code',
                    totalLessons: 8,
                    estimatedHours: 120,
                    lessons: [
                        {
                            id: 1,
                            title: 'Introduction to Programming',
                            duration: '45 min',
                            mediaType: 'video',
                            mediaPath: 'https://www.youtube.com/embed/5Qwwjych21o',
                            content: `
                                <h2>Welcome to Programming!</h2>
                                <p>Programming is the process of creating a set of instructions that tell a computer how to perform a task. In this lesson, we'll explore the fundamental concepts that form the foundation of all programming languages, starting with **variables** and **data types**.</p>
                                
                                <h3>Variables and Data Types</h3>
                                <p>A **variable** is a storage location paired with an associated symbolic name, which contains some known or unknown quantity of information. Think of it as a labeled box.</p>
                                <p>There are four main **primitive data types**:</p>
                                <ul>
                                    <li><strong>String:</strong> Text (e.g., \`"Hello"\`)</li>
                                    <li><strong>Integer:</strong> Whole numbers (e.g., \`100\`)</li>
                                    <li><strong>Float:</strong> Decimal numbers (e.g., \`3.14\`)</li>
                                    <li><strong>Boolean:</strong> True or False values</li>
                                </ul>

                                <h3>Practical Example: Python</h3>
                                <p>Here’s how you define and use these in Python, a great beginner language:</p>
                                <div class="interactive-code-block">
                                    <div class="code-toolbar"><span>File: example.py</span><span>Language: Python</span></div>
                                    <pre class="code-editor-placeholder"><code># Variable Declarations
                                name = "Elvion" 
                                course_id = 101
                                pass_rate = 95.5
                                is_enrolled = True
                                
                                # Printing the values and their types
                                print(f"Name: {name}, Type: {type(name)}")
                                print(f"Course ID: {course_id}, Type: {type(course_id)}")</code></pre>
                                </div>
                                <p><strong>Assignment:</strong> Try changing the value of the \`name\` variable to your own name. What happens to its type?</p>
                                <p>In our next lesson, we will use these basics to build more complex structures!</p>
                            `,
                            quiz: [
                                { 
                                    question: "What is a 'String' in programming?", 
                                    type: "mcq",
                                    options: ["A whole number", "Text data", "A decimal number", "A True/False value"], 
                                    answer: "Text data" 
                                },
                                { 
                                    question: "Which data type is used to store the value 3.14?", 
                                    type: "mcq",
                                    options: ["Integer", "String", "Float", "Boolean"], 
                                    answer: "Float" 
                                },
                                {
                                    question: "What is the result of the expression: '5' + '5' (in most languages)? (Enter the combined number as a string)",
                                    type: "text",
                                    answer: "55"
                                }
                            ]
                        },
                        { id: 2, title: 'Data Structures', duration: '60 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/bbV8NfNn4pE', content: `<h2>Understanding Data Structures...</h2><p>Data structures are ways of organizing and storing data efficiently. This lesson focuses on **Arrays (Lists)** and **Dictionaries (Hash Maps)**...</p>`, quiz: [{ question: "Arrays follow which storage order?", type: "mcq", options: ["LIFO", "FIFO", "Indexed", "Random"], answer: "Indexed" }] },
                        { id: 3, title: 'Object-Oriented Programming', duration: '55 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/SiB_y_9Kk18', content: `<h2>Object-Oriented Programming (OOP)...</h2><p>OOP organizes code into objects. We cover the four pillars: **Encapsulation, Inheritance, Polymorphism, and Abstraction**.</p>`, quiz: [{ question: "What is the pillar that restricts direct access to some components of an object?", type: "mcq", options: ["Inheritance", "Polymorphism", "Encapsulation", "Abstraction"], answer: "Encapsulation" }] },
                        { id: 4, title: 'Database Systems', duration: '50 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/H37H0I9T_jE', content: `<h2>Introduction to Database Systems...</h2><p>Learn SQL basics and the difference between **Relational (SQL)** and **NoSQL** databases. Practical query examples included.</p>`, quiz: [{ question: "What does the SQL command 'SELECT * FROM users' do?", type: "mcq", options: ["Deletes the users table", "Updates all user records", "Retrieves all data from the users table", "Inserts a new user record"], answer: "Retrieves all data from the users table" }] },
                        { id: 5, title: 'Software Engineering', duration: '60 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/eYn40h6j5jY', content: `<h2>Software Engineering Fundamentals...</h2><p>We delve into the **SDLC** (Software Development Life Cycle) and modern methodologies like **Agile** and the **DRY** principle.</p>`, quiz: [{ question: "What does the 'D' in DRY stand for?", type: "text", answer: "Don't" }] },
                        { id: 6, title: 'Computer Networks', duration: '50 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/v9XN1R5Rz7Y', content: `<h2>Introduction to Computer Networks...</h2><p>Explore the **OSI Model** (7 Layers), **IP addresses**, and essential protocols like HTTP and TCP.</p>`, quiz: [{ question: "Which layer of the OSI model handles physical hardware (cables, radio waves)? (Enter the number only)", type: "text", answer: "1" }] },
                        { id: 7, title: 'Artificial Intelligence', duration: '65 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/i0Jp6vK0f0g', content: `<h2>Introduction to Artificial Intelligence...</h2><p>A look at **Narrow vs. General AI**, the different types of **Machine Learning** (Supervised, Unsupervised, Reinforcement), and **Deep Learning**.</p>`, quiz: [{ question: "Which type of Machine Learning uses labeled data for training?", type: "mcq", options: ["Unsupervised Learning", "Reinforcement Learning", "Deep Learning", "Supervised Learning"], answer: "Supervised Learning" }] },
                        { id: 8, title: 'Final Year Project', duration: '120 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/V6j7Ww5_7oE', content: `<h2>Final Year Project: Building Your Portfolio</h2><p>Your final project is a culmination of your skills. This lesson outlines the **Planning, Design, Development, and Testing phases**.</p><p><strong>Final Requirement:</strong> Submit a comprehensive project (e.g., a simple web app, a data analysis report, a functional game) to <strong>elvionailabs@gmail.com</strong> along with the certificate form below to receive your certificate.</p>`, quiz: [] }
                    ]
                }
            ]
        },
        'law': {
            facultyName: 'Faculty of Law',
            courses: [
                {
                    id: 'law101',
                    title: 'Law (LLB)',
                    description: 'Comprehensive study of legal principles, constitutional law, criminal law, civil law, and legal practice.',
                    icon: 'fas fa-gavel',
                    totalLessons: 6,
                    lessons: [
                        { id: 1, title: 'Introduction to Legal Systems', duration: '40 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/_c6iHL2Zd5o', content: `<h2>The Nature of Law...</h2><p>A study of Common Law vs. Civil Law and the hierarchy of courts.</p>`, quiz: [{ question: "Which type of law is based on judicial precedent (past court decisions)?", type: "mcq", options: ["Civil Law", "Common Law", "Constitutional Law", "Administrative Law"], answer: "Common Law" }] },
                        { id: 2, title: 'Constitutional Law', duration: '55 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/t4bUv4QnE70', content: `<h2>Fundamental Rights and Separation of Powers...</h2><p>The principles of checks and balances between the Legislature, Executive, and Judiciary.</p>`, quiz: [{ question: "Which branch of government is responsible for interpreting the law?", type: "text", answer: "Judiciary" }] },
                        { id: 3, title: 'Criminal Law', duration: '60 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/n3Hn6_n0X8s', content: `<h2>Elements of a Crime: Actus Reus and Mens Rea...</h2><p>An in-depth look at different types of offenses and defenses.</p>`, quiz: [{ question: "What is the term for the 'guilty mind' or criminal intent?", type: "text", answer: "Mens Rea" }] },
                        { id: 4, title: 'Contract Law', duration: '50 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/03uR5n9d1o4', content: `<h2>Formation of a Contract: Offer, Acceptance, and Consideration...</h2><p>Examining breaches of contract and remedies.</p>`, quiz: [{ question: "What is the exchange of something of value between the parties in a contract called?", type: "mcq", options: ["Offer", "Acceptance", "Consideration", "Breach"], answer: "Consideration" }] },
                        { id: 5, title: 'Legal Practice and Advocacy', duration: '70 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/V6_Vd6yIeFk', content: `<h2>Moot Courts and Legal Research...</h2><p>Developing practical skills in drafting legal arguments and courtroom procedure.</p>`, quiz: [{ question: "A **writ** is a formal written order issued by a legal or administrative body.", type: "text", answer: "writ" }] },
                        { id: 6, title: 'Final Year Project', duration: '120 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/3v4g1l8sFfA', content: `<h2>Final Year Project: Case Study and Thesis</h2><p>Choose a landmark case to analyze in depth. Your project must include a 2,500-word written thesis.</p><p><strong>Final Requirement:</strong> Submit your comprehensive **Case Study Thesis** to <strong>elvionailabs@gmail.com</strong> along with the certificate form below to receive your certificate.</p>`, quiz: [] }
                    ]
                }
            ]
        },
        'arts-humanities': {
            facultyName: 'Faculty of Arts & Humanities',
            courses: [
                {
                    id: 'eng101',
                    title: 'English & Literary Studies',
                    description: 'In-depth study of English language structure, literary analysis, composition, and communication skills.',
                    icon: 'fas fa-feather-alt',
                    totalLessons: 6,
                    lessons: [
                        { id: 1, title: 'English Composition', duration: '45 min', mediaType: 'audio', mediaPath: '/university/a081468d-c79a-4912-9f49-764fb70ef1c7.wav', content: `<h2>Academic Writing Fundamentals...</h2><p>Focus on thesis statements, paragraph structure, and proper citation formats.</p>`, quiz: [{ question: "The central argument of an essay is called the **thesis statement**.", type: "text", answer: "thesis statement" }] },
                        { id: 2, title: 'World Literature', duration: '50 min', mediaType: 'audio', mediaPath: '/university/elegant_man_voice.mp3', content: `<h2>Exploring Global Literary Movements...</h2><p>Readings from classical, romantic, and modern periods across different continents.</p>`, quiz: [{ question: "A **sonnet** is a poem of 14 lines, often written in iambic pentameter.", type: "text", answer: "sonnet" }] },
                        { id: 3, title: 'Phonetics and Phonology', duration: '60 min', mediaType: 'audio', mediaPath: '/university/wise_woman_voice.mp3', content: `<h2>The Science of Speech Sounds...</h2><p>Learning the IPA (International Phonetic Alphabet) and sound patterns.</p>`, quiz: [{ question: "What is the study of speech sounds in a language called?", type: "mcq", options: ["Semantics", "Syntax", "Phonology", "Morphology"], answer: "Phonology" }] },
                        { id: 4, title: 'Syntax and Grammar', duration: '40 min', mediaType: 'audio', mediaPath: '/university/abbess_voice.mp3', content: `<h2>Sentence Structure and Analysis...</h2><p>Identifying parts of speech and analyzing complex sentence structures.</p>`, quiz: [{ question: "The **subject** of a sentence is the person, place, or thing performing the action.", type: "text", answer: "subject" }] },
                        { id: 5, title: 'Literary Criticism', duration: '65 min', mediaType: 'audio', mediaPath: '/university/friendly_person_voice (1).mp3', content: `<h2>Theories of Interpretation...</h2><p>Introduction to New Criticism, Structuralism, and Post-Colonial theories.</p>`, quiz: [{ question: "Literary theory focused on the author's biography and historical context is **Biographical Criticism**.", type: "text", answer: "Biographical Criticism" }] },
                        { id: 6, title: 'Research Project', duration: '100 min', mediaType: 'audio', mediaPath: '/university/wise_woman_voice (1).mp3', content: `<h2>Final Year Project: Critical Essay</h2><p>Write a comprehensive 3,000-word critical essay analyzing three literary works under a single critical lens.</p><p><strong>Final Requirement:</strong> Submit your **Critical Essay** to <strong>elvionailabs@gmail.com</strong> along with the certificate form below to receive your certificate.</p>`, quiz: [] }
                    ]
                }
            ]
        },
        'management': {
            facultyName: 'Faculty of Management & Social Sciences',
            courses: [
                {
                    id: 'bus101',
                    title: 'Business Administration',
                    description: 'Principles of management, marketing, finance, and entrepreneurship.',
                    icon: 'fas fa-chart-line',
                    totalLessons: 6,
                    lessons: [
                        { id: 1, title: 'Principles of Management', duration: '45 min', mediaType: 'audio', mediaPath: 'university/wise_woman_voice.mp3', content: `<h2>The Four Functions of Management...</h2><p>Planning, Organizing, Leading, and Controlling.</p>`, quiz: [{ question: "Which management function involves establishing goals and deciding how to achieve them?", type: "mcq", options: ["Organizing", "Controlling", "Planning", "Leading"], answer: "Planning" }] },
                        { id: 2, title: 'Marketing Fundamentals', duration: '50 min', mediaType: 'audio', mediaPath: 'university/wise_woman_voice (1).mp3', content: `<h2>The 4 Ps of Marketing...</h2><p>Product, Price, Place, and Promotion.</p>`, quiz: [{ question: "The marketing mix includes **price**, **product**, **promotion**, and **place**.", type: "text", answer: "price" }] },
                        { id: 3, title: 'Financial Management', duration: '60 min', mediaType: 'audio', mediaPath: 'university/abbess_voice.mp3', content: `<h2>Introduction to Accounting and Budgeting...</h2><p>Understanding Balance Sheets and Income Statements.</p>`, quiz: [{ question: "The equation **Assets = Liabilities + Equity** is the basis of which financial statement?", type: "text", answer: "Balance Sheet" }] },
                        { id: 4, title: 'Human Resource Management', duration: '40 min', mediaType: 'audio', mediaPath: 'university/friendly_person_voice (1).mp3', content: `<h2>Recruitment, Training, and Employee Relations...</h2><p>Best practices for managing a diverse workforce.</p>`, quiz: [{ question: "The process of attracting, screening, and selecting qualified people for a job is called **recruitment**.", type: "text", answer: "recruitment" }] },
                        { id: 5, title: 'Strategic Management', duration: '65 min', mediaType: 'audio', mediaPath: 'university/elegant_man_voice.mp3', content: `<h2>SWOT Analysis and Competitive Advantage...</h2><p>Developing long-term plans to achieve organizational goals.</p>`, quiz: [{ question: "In SWOT analysis, **Opportunities** and **Threats** are external factors.", type: "text", answer: "Threats" }] },
                        { id: 6, title: 'Capstone Project', duration: '120 min', mediaType: 'audio', mediaPath: 'university/wise_woman_voice.mp3', content: `<h2>Final Year Project: Business Plan Simulation</h2><p>Develop a comprehensive business plan for a new startup, covering market analysis, financial projections, and management structure.</p><p><strong>Final Requirement:</strong> Submit your **Comprehensive Business Plan** to <strong>elvionailabs@gmail.com</strong> along with the certificate form below to receive your certificate.</p>`, quiz: [] }
                    ]
                }
            ]
        },
        'visual-arts': { // New Faculty
            facultyName: 'Faculty of Visual Arts & Design',
            courses: [
                {
                    id: 'va101',
                    title: 'Digital Animation & Design',
                    description: 'Master the fundamentals of 2D and 3D animation, character design, and digital storytelling using industry-standard tools.',
                    icon: 'fas fa-palette',
                    totalLessons: 6,
                    lessons: [
                        { id: 1, title: 'Principles of Animation', duration: '45 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/uDqjIdI4DG4', content: `<h2>The 12 Principles of Animation...</h2><p>Squash and Stretch, Anticipation, Staging, and Follow Through.</p>`, quiz: [{ question: "Which principle gives the illusion of weight and flexibility to a character?", type: "mcq", options: ["Staging", "Anticipation", "Squash and Stretch", "Timing"], answer: "Squash and Stretch" }] },
                        { id: 2, title: 'Character Design', duration: '50 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/5T55lQ2I59I', content: `<h2>Developing Emotional and Visual Appeal...</h2><p>Focus on shape language, color theory, and expression sheets.</p>`, quiz: [{ question: "Using simple geometric shapes (square, circle, triangle) in design is known as **shape language**.", type: "text", answer: "shape language" }] },
                        { id: 3, title: '2D Animation Workflow (Frame-by-Frame)', duration: '60 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/P6d577e9l0c', content: `<h2>Keyframes, Breakdowns, and Inbetweens...</h2><p>Learning traditional animation techniques in a digital environment.</p>`, quiz: [{ question: "What are the most important drawings in a sequence that define the motion?", type: "text", answer: "keyframes" }] },
                        { id: 4, title: '3D Modeling and Texturing', duration: '50 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/o7lS51P1f3Y', content: `<h2>Poly-modeling and UV Mapping...</h2><p>Introduction to industry tools like Blender or Maya for creating assets.</p>`, quiz: [{ question: "The process of flattening a 3D model's surface onto a 2D plane for applying textures is called **UV mapping**.", type: "text", answer: "UV mapping" }] },
                        { id: 5, title: 'Digital Painting', duration: '65 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/S2P_f6m3Gj8', content: `<h2>Layer Management and Brush Techniques...</h2><p>Mastering color blending, lighting, and creating custom brushes in Photoshop/Procreate.</p>`, quiz: [{ question: "In digital painting, using different **layers** allows for non-destructive editing.", type: "text", answer: "layers" }] },
                        { id: 6, title: 'Final Project: Animated Short', duration: '120 min', mediaType: 'video', mediaPath: 'https://www.youtube.com/embed/wzXpU8N1Y-0', content: `<h2>Final Year Project: The Short Film</h2><p>Produce a 30-second animated short film (2D or 3D) that showcases at least five of the 12 principles of animation.</p><p><strong>Final Requirement:</strong> Submit your **Animated Short Film** to <strong>elvionailabs@gmail.com</strong> along with the certificate form below to receive your certificate.</p>`, quiz: [] }
                    ]
                }
            ]
        }
    };
    // --- END OF UPDATED COURSES DATABASE ---


    let currentUser = null;
    let userData = null;
    let currentCourse = null;
    let currentLesson = 1;
    let totalLessons = 0;
    let currentQuizIndex = 0;
    let quizTimerInterval = null;
    const QUIZ_TIME_LIMIT = 180; // 3 minutes in seconds
    let quizTimeLeft = QUIZ_TIME_LIMIT;

    // URL Parameters
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('courseId');
    const lessonParam = urlParams.get('lesson');

    // DOM Elements
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const courseSidebar = document.getElementById('courseSidebar');
    const nextLessonBtn = document.getElementById('nextLessonBtn');
    const submitQuizBtn = document.getElementById('submitQuizBtn');

    // Event Listeners for UI
    document.addEventListener('DOMContentLoaded', () => {
      const starsContainer = document.getElementById('stars-container');
      const numStars = 100;
      for (let i = 0; i < numStars; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = `${1 + Math.random() * 2}px`;
        star.style.height = star.style.width;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 4}s`;
        starsContainer.appendChild(star);
      }
    });

    mobileMenuToggle.addEventListener('click', () => {
      courseSidebar.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 992) {
        if (!courseSidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
          courseSidebar.classList.remove('active');
        }
      }
    });

    // --- FIREBASE AND COURSE INITIALIZATION ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
        await initializeCourseViewer();
      } else {
        window.location.href = 'enroll.html';
      }
    });

    async function loadUserData() {
      try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          userData = userDoc.data();
          // Initialize points if null
          if (userData.totalPoints === undefined) {
            userData.totalPoints = 0;
          }
        } else {
          // Changed redirect to studyingatelvion.html
          window.location.href = 'studyingatelvion.html';
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        alert('Error loading user data. Please try again.');
      }
    }

    async function initializeCourseViewer() {
      if (!courseId) {
        alert('No course specified');
        // Changed redirect to studyingatelvion.html
        window.location.href = 'studyingatelvion.html';
        return;
      }

      currentCourse = findCourseById(courseId);
      if (!currentCourse) {
        alert('Course not found');
        // Changed redirect to studyingatelvion.html
        window.location.href = 'studyingatelvion.html';
        return;
      }

      totalLessons = currentCourse.totalLessons;
      currentLesson = parseInt(lessonParam) || 1;

      // Check if user is enrolled
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      if (!enrolledCourse) {
        alert('You are not enrolled in this course');
        // Changed redirect to studyingatelvion.html
        window.location.href = 'studyingatelvion.html';
        return;
      }
      
      // Ensure user starts at or before their current lesson
      const maxLesson = enrolledCourse.currentLesson || 1;
      currentLesson = Math.min(currentLesson, maxLesson);
      
      setupCourseInterface();
      renderLessonsList();
      loadLesson(currentLesson);
      
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('contentHeader').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('lessonNavigation').style.display = 'flex';
    }

    function findCourseById(courseId) {
      for (const facultyKey in coursesDatabase) {
        const course = coursesDatabase[facultyKey].courses.find(c => c.id === courseId);
        if (course) return course;
      }
      return null;
    }
    
    // Helper to get course data
    function getEnrolledCourse() {
        return userData.enrolledCourses?.find(c => c.courseId === courseId);
    }

    function setupCourseInterface() {
      document.getElementById('courseIconLarge').className = `course-icon-large ${currentCourse.icon}`;
      document.getElementById('courseTitle').textContent = currentCourse.title;
      document.getElementById('courseSubtitle').textContent = currentCourse.description;
      document.getElementById('totalPointsEarned').textContent = userData.totalPoints;
      
      updateOverallProgress();
    }

    function updateOverallProgress() {
      const enrolledCourse = getEnrolledCourse();
      const progress = enrolledCourse?.progress || 0;
      const completedLessons = enrolledCourse?.completedLessons?.length || 0;
      
      document.getElementById('overallProgressBar').style.width = `${progress}%`;
      document.getElementById('overallProgressText').textContent = `${progress}% Complete (${completedLessons}/${totalLessons} lessons)`;
    }

    function renderLessonsList() {
      const container = document.getElementById('lessonsContainer');
      const enrolledCourse = getEnrolledCourse();
      const completedLessons = enrolledCourse?.completedLessons || [];
      const maxAccessibleLesson = enrolledCourse?.currentLesson || 1;
      
      container.innerHTML = '';
      
      currentCourse.lessons.forEach((lesson) => {
        const lessonNumber = lesson.id;
        const isCompleted = completedLessons.includes(lessonNumber);
        const isCurrent = lessonNumber === currentLesson;
        const isAccessible = lessonNumber <= maxAccessibleLesson;
        
        const lessonItem = document.createElement('div');
        lessonItem.className = `lesson-item ${isCurrent ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
        
        let statusIcon, statusClass;
        if (isCompleted) {
          statusIcon = '<i class="fas fa-check"></i>';
          statusClass = 'completed';
        } else if (isCurrent) {
          statusIcon = lessonNumber;
          statusClass = 'current';
        } else if (isAccessible) {
          statusIcon = lessonNumber;
          statusClass = 'accessible';
        } else {
          statusIcon = '<i class="fas fa-lock"></i>';
          statusClass = 'locked';
        }
        
        lessonItem.innerHTML = `
          <div class="lesson-status ${statusClass}">${statusIcon}</div>
          <div class="lesson-details">
            <div class="lesson-title">${lesson.title}</div>
            <div class="lesson-duration">${lesson.duration}</div>
          </div>
        `;
        
        if (isAccessible) {
          lessonItem.style.cursor = 'pointer';
          lessonItem.addEventListener('click', () => {
            if (lessonNumber !== currentLesson) {
              loadLesson(lessonNumber);
            }
          });
        } else {
          lessonItem.style.opacity = '0.5';
          lessonItem.style.cursor = 'not-allowed';
        }
        
        container.appendChild(lessonItem);
      });
    }

    function loadLesson(lessonNumber) {
      clearInterval(quizTimerInterval);
      const lesson = currentCourse.lessons.find(l => l.id === lessonNumber);
      if (!lesson) return;
      
      currentLesson = lessonNumber;
      
      // Update URL without reloading
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('lesson', lessonNumber);
      window.history.pushState({}, '', newUrl);
      
      // Update header
      document.getElementById('lessonTitle').textContent = lesson.title;
      document.getElementById('lessonDuration').textContent = lesson.duration;
      document.getElementById('currentLessonNumber').textContent = lessonNumber;
      document.getElementById('totalLessons').textContent = totalLessons;
      document.getElementById('lessonPoints').textContent = lessonNumber === totalLessons ? '50' : '10';
      
      // Update navigation
      document.getElementById('navCurrentLesson').textContent = lessonNumber;
      document.getElementById('navTotalLessons').textContent = totalLessons;
      
      // Update media player
      const mediaPlayer = document.getElementById('mediaPlayer');
      mediaPlayer.className = 'video-player';
      if (lesson.mediaType === 'audio') {
        mediaPlayer.classList.add('media-audio');
        mediaPlayer.innerHTML = `
          <audio controls style="width: 90%; margin: 0 auto; outline: none; border-radius: 10px; box-shadow: 0 0 8px #00ffff;">
            <source src="${lesson.mediaPath}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        `;
      } else if (lesson.mediaType === 'video') {
        mediaPlayer.innerHTML = `
            <iframe width="100%" height="100%" src="${lesson.mediaPath}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="border-radius: 12px;"></iframe>
        `;
      } else {
         mediaPlayer.innerHTML = `
          <div class="video-placeholder">
            <i class="fas fa-book-open"></i>
            <p>Lesson is text-based.</p>
          </div>
        `;
      }
      
      // Update content
      document.getElementById('lessonContent').innerHTML = lesson.content;
      
      // Update navigation buttons
      const prevBtn = document.getElementById('prevLessonBtn');
      const nextBtn = document.getElementById('nextLessonBtn');
      
      prevBtn.disabled = lessonNumber === 1;
      nextBtn.disabled = true; // Disabled by default, enabled by quiz completion

      const enrolledCourse = getEnrolledCourse();
      const isCompleted = enrolledCourse?.completedLessons?.includes(lessonNumber);
      
      // Handle Quiz/Completion Logic
      const quizContainer = document.getElementById('quizContainer');
      const quizQuestions = lesson.quiz;

      if (quizQuestions && quizQuestions.length > 0) {
          quizContainer.style.display = 'block';
          renderQuiz(lesson);
          if (isCompleted) {
              // Show summary but keep next button enabled if available
              document.getElementById('quizSummary').textContent = 'Quiz already completed for this lesson.';
              document.getElementById('quizSummary').style.display = 'block';
              submitQuizBtn.style.display = 'none';
              nextBtn.disabled = lessonNumber === totalLessons;
          } else {
              document.getElementById('quizSummary').style.display = 'none';
              submitQuizBtn.style.display = 'block';
              nextBtn.disabled = true;
              startQuizTimer();
          }
      } else {
          // No quiz (final lesson/project page)
          quizContainer.style.display = 'none';
          nextBtn.disabled = true; // The 'Next' button does nothing on the final lesson

          if (lessonNumber === totalLessons) {
              // Final Lesson Logic - Enable final completion button
              // We'll hijack the next button text for final course completion
              nextBtn.textContent = 'Finish Course & Get Certificate';
              nextBtn.disabled = false;
              nextBtn.classList.remove('action-btn');
              nextBtn.classList.add('action-btn', 'secondary');
          } else {
              // No quiz, not final lesson (should not happen in this structured flow, but as fallback)
              nextBtn.disabled = false; 
          }
      }
      
      // Update sidebar
      renderLessonsList();
      
      // Scroll to top
      window.scrollTo(0, 0);
    }
    
    // --- QUIZ FUNCTIONS ---
    function renderQuiz(lesson) {
        const container = document.getElementById('quizQuestions');
        container.innerHTML = '';
        
        lesson.quiz.forEach((q, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'quiz-question-block';
            
            let optionsHtml = '';
            
            if (q.type === 'mcq') {
                optionsHtml = q.options.map(option => `
                    <div class="quiz-option" data-question-index="${index}" data-answer-value="${option}">
                        ${option}
                    </div>
                `).join('');
                optionsHtml = `<div class="quiz-options">${optionsHtml}</div>`;
            } else if (q.type === 'text') {
                optionsHtml = `
                    <div class="quiz-input-container">
                        <input type="text" class="quiz-input" data-question-index="${index}" placeholder="Type your answer here..." />
                    </div>
                `;
            }
            
            questionElement.innerHTML = `
                <div class="quiz-question-counter">Question ${index + 1} of ${lesson.quiz.length}</div>
                <div class="quiz-question">${q.question}</div>
                ${optionsHtml}
            `;
            
            container.appendChild(questionElement);
        });
        
        // Add click listener for MCQ options
        document.querySelectorAll('.quiz-option').forEach(option => {
            option.addEventListener('click', function() {
                const qIndex = this.getAttribute('data-question-index');
                // Deselect all options for this question
                document.querySelectorAll(`.quiz-option[data-question-index="${qIndex}"]`).forEach(opt => {
                    opt.classList.remove('selected');
                });
                // Select the clicked option
                this.classList.add('selected');
            });
        });
    }
    
    function startQuizTimer() {
        quizTimeLeft = QUIZ_TIME_LIMIT;
        const timerDisplay = document.getElementById('quizTimer');
        
        function updateTimer() {
            const minutes = Math.floor(quizTimeLeft / 60);
            const seconds = quizTimeLeft % 60;
            timerDisplay.textContent = `Time Left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (quizTimeLeft <= 0) {
                clearInterval(quizTimerInterval);
                timerDisplay.textContent = 'Time Up! Auto-submitting...';
                handleSubmitQuiz(true); // Auto-submit on time up
            } else {
                quizTimeLeft--;
            }
        }
        
        clearInterval(quizTimerInterval);
        quizTimerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Initial call
    }

    function handleSubmitQuiz(isTimeUp = false) {
        clearInterval(quizTimerInterval);
        const lesson = currentCourse.lessons.find(l => l.id === currentLesson);
        let score = 0;
        let totalQuestions = lesson.quiz.length;
        
        lesson.quiz.forEach((q, index) => {
            let userAnswer = '';
            let correctAnswer = q.answer.trim().toLowerCase();
            
            if (q.type === 'mcq') {
                const selectedOption = document.querySelector(`.quiz-option[data-question-index="${index}"].selected`);
                if (selectedOption) {
                    userAnswer = selectedOption.getAttribute('data-answer-value').trim().toLowerCase();
                }
                
                // Highlight options
                document.querySelectorAll(`.quiz-option[data-question-index="${index}"]`).forEach(opt => {
                    const optValue = opt.getAttribute('data-answer-value').trim().toLowerCase();
                    opt.classList.remove('selected');
                    if (optValue === correctAnswer) {
                        opt.classList.add('correct');
                    } else if (optValue === userAnswer) {
                        opt.classList.add('incorrect');
                    }
                    opt.style.pointerEvents = 'none';
                });
                
            } else if (q.type === 'text') {
                const input = document.querySelector(`.quiz-input[data-question-index="${index}"]`);
                if (input) {
                    userAnswer = input.value.trim().toLowerCase();
                }
                
                // Provide feedback for text input
                if (input) {
                    input.disabled = true;
                    if (userAnswer === correctAnswer) {
                        input.style.borderColor = var(--success-color);
                    } else {
                        input.style.borderColor = var(--error-color);
                        const feedback = document.createElement('p');
                        feedback.style.color = 'var(--error-color)';
                        feedback.textContent = `Correct Answer: "${q.answer}"`;
                        input.parentElement.after(feedback);
                    }
                }
            }
            
            if (userAnswer === correctAnswer) {
                score++;
            }
        });
        
        // Display Results
        const resultDisplay = document.getElementById('quizSummary');
        const percentage = (score / totalQuestions) * 100;
        
        resultDisplay.innerHTML = `Quiz Submitted! Score: ${score}/${totalQuestions} (${percentage.toFixed(0)}%)`;
        resultDisplay.style.display = 'block';
        submitQuizBtn.style.display = 'none';

        if (percentage === 100) {
            resultDisplay.style.background = 'rgba(74, 222, 128, 0.1)';
            resultDisplay.style.color = 'var(--success-color)';
            resultDisplay.style.border = '1px solid var(--success-color)';
            resultDisplay.innerHTML += '<p style="margin-top: 1rem;">**PERFECT SCORE!** Next lesson unlocked.</p>';
            
            // Unlock next lesson
            markLessonComplete(true); 
            
            // Enable next button if not final lesson
            if (currentLesson < totalLessons) {
                 document.getElementById('nextLessonBtn').disabled = false;
                 document.getElementById('nextLessonBtn').textContent = 'Next Lesson';
            }
            
        } else {
            resultDisplay.style.background = 'rgba(248, 113, 113, 0.1)';
            resultDisplay.style.color = 'var(--error-color)';
            resultDisplay.style.border = '1px solid var(--error-color)';
            resultDisplay.innerHTML += isTimeUp 
                ? '<p style="margin-top: 1rem;">**Time Up!** You must review the lesson and try again to unlock the next page.</p>'
                : '<p style="margin-top: 1rem;">**INCOMPLETE!** You must score 100% to proceed. Please review the lesson and refresh the page to try again.</p>';
            
            // Keep next button disabled
            document.getElementById('nextLessonBtn').disabled = true;
        }
        
    }
    
    // --- LESSON COMPLETION LOGIC ---
    async function markLessonComplete(quizSuccess) {
        if (!quizSuccess) return; // Only mark complete if quiz is 100%
        
        try {
            const enrolledCourseIndex = userData.enrolledCourses.findIndex(c => c.courseId === courseId);
            if (enrolledCourseIndex === -1) return;
            
            const enrolledCourse = userData.enrolledCourses[enrolledCourseIndex];
            
            // Check if already completed
            if (enrolledCourse.completedLessons?.includes(currentLesson)) return;

            // Add to completed lessons
            if (!enrolledCourse.completedLessons) {
                enrolledCourse.completedLessons = [];
            }
            enrolledCourse.completedLessons.push(currentLesson);
            
            // Award points (10 points per lesson, 50 for the final project)
            const pointsToAward = currentLesson === totalLessons ? 50 : 10;
            
            // Update current lesson access
            const nextLesson = currentLesson + 1;
            enrolledCourse.currentLesson = Math.max(enrolledCourse.currentLesson || 1, nextLesson);
            
            // Calculate progress
            const completedCount = enrolledCourse.completedLessons.length;
            enrolledCourse.progress = Math.round((completedCount / totalLessons) * 100);
            
            // Update user data
            userData.enrolledCourses[enrolledCourseIndex] = enrolledCourse;
            userData.completedLessons = (userData.completedLessons || 0) + 1;
            userData.totalPoints = (userData.totalPoints || 0) + pointsToAward;
            
            // Save to database
            await updateDoc(doc(db, 'users', currentUser.uid), {
                enrolledCourses: userData.enrolledCourses,
                completedLessons: userData.completedLessons,
                totalPoints: userData.totalPoints
            });
            
            // Update UI
            updateOverallProgress();
            renderLessonsList();
            document.getElementById('totalPointsEarned').textContent = userData.totalPoints;

            // Handle final course completion
            if (currentLesson === totalLessons) {
                // Show completion modal
                document.getElementById('modalCompletionTitle').textContent = 'Course Completed!';
                document.getElementById('modalCompletionMessage').textContent = `Fantastic! You have completed the entire ${currentCourse.title} course. Submit your project and details below to claim your certificate.`;
                document.getElementById('modalTotalPoints').textContent = userData.totalPoints;
                document.getElementById('certificateCourseName').value = currentCourse.title;
                document.getElementById('feedbackCourseName').value = currentCourse.title;
                document.getElementById('completionModal').style.display = 'flex';
            }
            
        } catch (error) {
            console.error('Error updating progress:', error);
            alert('Error updating progress. Please try again.');
        }
    }

    // --- NAVIGATION BUTTON LISTENERS ---
    document.getElementById('prevLessonBtn').addEventListener('click', () => {
      if (currentLesson > 1) {
        loadLesson(currentLesson - 1);
      }
    });

    document.getElementById('nextLessonBtn').addEventListener('click', () => {
      if (currentLesson < totalLessons) {
        loadLesson(currentLesson + 1);
      } else if (currentLesson === totalLessons) {
        // Handle final lesson completion logic (showing modal)
        markLessonComplete(true);
      }
    });
    
    submitQuizBtn.addEventListener('click', () => {
        handleSubmitQuiz(false);
    });

    // --- MODAL BUTTONS ---
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
      // Changed redirect to studyingatelvion.html
      window.location.href = 'studyingatelvion.html';
    });
  </script>
</body>
  </html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
