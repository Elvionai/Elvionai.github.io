<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Elvion AI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <!-- Highlight.js (syntax highlighting) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.hljs) hljs.configure({ignoreUnescapedHTML: true});
        });
    </script>
    <style>
        :root {
            --cyan:#00ffff; --blue:#0090ff; --bg:#191a26; --card:#181e2e; --radius:18px; --text:#e0e0e0;
            --muted:#b3b3b3; --shadow:0 0 31px #00fff2a4;
        }
        html, body {
            width:100vw; height:100vh; margin:0; padding:0;
            font-family:'Roboto', 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
            background: radial-gradient(circle, #23233a 66%, #0a1128 100%);
            color:var(--text);
        }
        body { display:flex; align-items:center; justify-content:center; overflow:hidden; }
        #stars-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;}
        .star{position:absolute;background:rgba(255,255,255,.7);border-radius:50%;opacity:0;animation:twinkle 4.9s infinite linear;}
        @keyframes twinkle{0%,100%{opacity:.13;}54%{opacity:.97;}}
        .card-container {
            background:var(--card); border-radius:var(--radius); max-width:420px; width:98vw; min-width:270px;
            height:79vh; min-height:420px; max-height:98vh; display:flex; flex-direction:column; align-items:center;
            box-shadow:var(--shadow); transition:all .20s; position:relative; z-index:2;
        }
        .fullscreen {position:fixed !important; top:0; left:0; width:100vw; height:100vh; min-height:100dvh; max-width:none; max-height:none; padding:0; border-radius:0; z-index:10; box-shadow:none;}
        .header-bar {width:99%; display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px 6px; flex-shrink:0;}
        .menu-btn, .fullscreen-btn {
            background:none; border:none; color:var(--cyan); cursor:pointer;
            padding:0 11px;
        }
        .menu-btn { font-size:2em; }
        .fullscreen-btn { font-size:1.19em; margin-left:11px; }
        .fullscreen-btn:hover,.menu-btn:hover{background:var(--cyan); color:#23233a; border-radius:12px;}
        .site-heading{
            font-family:'Orbitron', sans-serif; font-size:1.06em; font-weight:700; letter-spacing:.38px;
            background:linear-gradient(90deg,#00ffff,#fff,#0090ff); background-size:200% auto; -webkit-background-clip:text;
            -webkit-text-fill-color:transparent; animation:shine 4s linear infinite; text-shadow:0 0 13px #00ffff43;
        }
        @keyframes shine{to{background-position:200% center;}}
        .profile-greet{color:#aee; font-size:.97em; margin:.3em auto; text-align:center; max-width:70vw;}
        #chatSwitchBar{width:97%; display:flex; align-items:center; gap:4px; margin:0 auto 7px auto;}
        #chatSelector{padding:8px 7px; border-radius:10px; border:1.3px solid #00ffff; font-size:1em; background:var(--bg); color:var(--text);}
        #newChatBtn,.delChatBtn{
            padding:4px 9px 5px 10px; border-radius:13px; border:none; cursor:pointer;
            background:linear-gradient(95deg,#00ffff 69%,#0090ff 100%); font-family:'Orbitron'; font-size:.98em;
            color:#23233a; font-weight:600; box-shadow:0 0 11px #00fff2c7;
        }
        .delChatBtn{background:none; color:#ffd500a7;}
        .delChatBtn:hover{color:#ff3131; background:#23233a;}
        .chat-box{
            flex:1 1 auto; overflow-y:auto; max-height:66vh; width:95%; margin:0 auto 1px auto; border-radius:13px;
            padding:9px 7px 8px 9px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth;
        }
        .chat-message{display:flex; align-items:flex-end; gap:12px; position: relative;}
        .chat-message.user{justify-content:flex-end;}
        .chat-message .msg{
            background:linear-gradient(90deg,#23233a 91%,#23233a 100%);
            color:#e0e0e0; padding:10px 14px; border-radius:13px 14px 7px 13px; max-width:77%;
            font-size:1.03em; line-height:1.45;
            word-wrap:break-word; white-space:pre-wrap;
        }
        .chat-message.user .msg{
            background:linear-gradient(90deg,#00ffff 49%,#0090ff 100%); color:#23233a; border-radius:13px 12px 13px 7px; font-weight:700;
        }
        .chat-message img,.chat-message video{max-width:115px; max-height:100px; border-radius:7px; background:#fff;}
        .chat-message.ai .msg strong { font-weight:800; color:#e8faff; }
        .chat-message.ai .msg em { opacity:0.95; }
        .chat-message.ai .msg code:not(pre code) {
            background:#0f1426; border:1px solid #26324d; padding:.12em .35em; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95em;
        }
        .chat-message.ai .msg pre {
            position:relative; background:#0b1224; border:1px solid #26324d; border-radius:12px; padding:12px 12px 14px 12px; overflow:auto;
            box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);
        }
        .chat-message.ai .msg pre code { display:block; font-size:.96em; line-height:1.4; }
        .copy-btn{
            position:absolute; top:8px; right:8px; border:none; border-radius:9px; padding:6px 9px; cursor:pointer;
            background:linear-gradient(90deg,#00ffff,#0090ff); color:#132; font-weight:800; font-size:.85em; box-shadow:0 2px 7px #00ffff33;
        }
        .copy-btn:hover{filter:brightness(1.05);}
        .message-actions {
            position: absolute; bottom: 5px; right: -38px;
            display: none; flex-direction: column; gap: 6px;
        }
        .chat-message.ai:hover .message-actions { display: flex; }
        .action-btn {
            background: #2a2f4d; border: 1px solid #00ffff55; color: #00ffff;
            border-radius: 50%; width: 28px; height: 28px; cursor: pointer;
            font-size: 0.8em; display: flex; align-items: center; justify-content: center;
        }
        .action-btn:hover { background: var(--cyan); color: var(--bg); }
        .file-preview{width:94%; margin:11px auto 0; border-radius:8px; overflow:hidden; background:rgba(35,35,58,.7); border:1px solid rgba(255,255,255,0.20);}
        .file-preview img,.file-preview video{max-width:96%; max-height:100px; display:block; margin:0 auto;}
        .file-preview .file-info{padding:7px; display:flex; align-items:center; font-size:.98em; color:var(--muted);}
        .file-preview .file-info i{margin-right:7px;}
        .chat-input-row{
            width:92%; display:flex; gap:7px; align-items:flex-end; background:#23233a; border-radius:9px; padding:8px 9px;
            border:1.1px solid #00ffff21; box-shadow:0 2px 9px #00fff215; margin:3px auto 7px auto;
        }
        .chat-input-row input[type="file"]{display:none;}
        .chat-input-row label{cursor:pointer; color:var(--cyan); font-size:1.15em; padding:0 5px;}
        .chat-input-row label:hover{color:var(--blue);}
        .chat-input-row textarea{
            flex:1; min-height:42px; max-height:168px; resize:none; padding:9px 10px; border-radius:8px;
            border:1.1px solid #23233a; background:#242b3f; color:#e0e0e0; font-size:1.02em; line-height:1.45;
            scrollbar-width:thin;
        }
        .chat-input-row textarea:focus{outline:none; border:1.15px solid var(--cyan);}
        .chat-input-row button{
            background:linear-gradient(90deg,#00ffff,#0090ff); color:#23233a; border:none; border-radius:8px; padding:9px 12px; font-size:1.05em;
            font-weight:800; cursor:pointer; box-shadow:0 2px 7px #00ffff33;
        }
        .chat-input-row button:hover{background:#0090ff; color:#fff;}
        .status-message{color:#ffd700; font-size:.94em; text-align:center; min-height:16px;}
        .panel-bg{display:none; position:fixed; z-index:221; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.59);}
        .panel-bg.active{display:flex;}
        .side-panel{background:var(--card); width:99vw; max-width:320px; height:100vh; box-shadow:-2px 0 26px #00ffffcf; display:flex; flex-direction:column; transition:transform .17s; overflow-y:auto; transform:translateX(340px);}
        .side-panel.active{transform:translateX(0);}
        .panel-header{display:flex; flex-direction:column; align-items:center; padding:24px 0 10px;}
        .panel-header img{width:42px; height:42px; border-radius:55%; object-fit:cover;}
        .panel-header .username{font-weight:800; font-size:1em; color:var(--cyan);}
        .panel-header .email{font-size:.93em; color:var(--muted);}
        .edit-form{display:flex; flex-direction:column; gap:10px;}
        .edit-form label{color:#00ffff; font-size:.92em; margin-bottom:2px;}
        .edit-form input{border:none; border-bottom:2px solid #23233a; background:#181d2c; color:#eee; font-size:.98em; padding:7px 4px 7px 9px; margin-bottom:3px; border-radius:8px;}
        .edit-form input:focus{border-color:#00ffff;}
        .profile-photo-tip{color:#b3b3b3; font-size:.91em; margin-bottom:4px;}
        .panel-links{display:flex; flex-direction:column; gap:1px; margin-top:11px; align-items:flex-start;}
        .panel-links a{color:var(--text); text-decoration:none; font-weight:700; font-size:1.02em; padding:8px 15px 8px 13px; border-radius:0 11px 11px 0; transition:background .14s;}
        .panel-links a:hover{background:var(--cyan); color:#23233a;}
        .typing-bubble { display:inline-flex; gap:6px; align-items:center; }
        .dot-anim{display:inline-block; width:10px; height:10px; margin-right:2px; background:#00ffff; border-radius:50%; animation:bounceDot .95s infinite;}
        .dot-anim:nth-child(2){animation-delay:.11s;}
        .dot-anim:nth-child(3){animation-delay:.2s;}
        @keyframes bounceDot{0%,100%{transform:translateY(0);}55%{transform:translateY(-7px);}}
        @media(max-width:600px){
            .card-container{max-width:99vw; width:100vw; min-height:97vw; height:95vh;}
            .chat-input-row{width:99vw;}
            .chat-box{max-height:57vh;}
            .message-actions { right: 5px; flex-direction: row; }
        }
        @media(max-width:400px){
            .card-container{max-width:100vw; width:100vw;}
            .chat-input-row{width:99vw;}
            .chat-box{font-size:.97em;}
        }
    </style>
</head>
<body>
    <div id="stars-container"></div>
    <div class="card-container" id="mainContainer">
        <div class="header-bar">
            <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
            <span class="site-heading" style="flex:1;text-align:center;">Philadelphia AI</span>
            <button class="fullscreen-btn" id="fullscreenBtn" aria-label="Toggle fullscreen"><i class="fa-solid fa-expand"></i></button>
            <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
        </div>
        <div class="profile-greet" id="greetMsg">Welcome!</div>
        <div id="chatSwitchBar">
            <select id="chatSelector"></select>
            <button id="newChatBtn" title="New chat"><i class="fa-solid fa-plus"></i></button>
            <button class="delChatBtn" id="delChatBtn" title="Delete"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div class="chat-box" id="chatBox"></div>
        <div id="filePreview" class="file-preview" style="display:none;"></div>
        <form class="chat-input-row" id="chatForm" autocomplete="off">
            <label for="chatFile" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
            <input type="file" id="chatFile" accept="*">
            <textarea id="chatInput" placeholder="Type here… (Shift+Enter = new line)"></textarea>
            <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
            <button type="button" id="voiceInputBtn" title="Record voice"><i class="fa-solid fa-microphone"></i></button>
        </form>
        <div class="status-message" id="statusMsg"></div>
    </div>
    <div class="panel-bg" id="profileMenuBg">
        <nav class="side-panel" id="profileMenu">
            <div class="panel-header">
                <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
                <div class="username" id="profileMenuUser">User</div>
                <div class="email" id="profileMenuEmail">email@example.com</div>
            </div>
            <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 18px;">
                <label for="edit-name">Name</label>
                <input type="text" id="edit-name" required>
                <label for="edit-photo">Photo URL</label>
                <input type="url" id="edit-photo" placeholder="Paste image link">
                <span class="profile-photo-tip">For photo, <a href="https://postimg.cc/" target="_blank" style="color:#00ffff;">upload at postimg.cc</a> and paste link here.</span>
                <button type="submit" class="submit-btn">Save</button>
                <div class="status-message" id="profileStatusMsg"></div>
            </form>
            <button class="submit-btn" id="logoutBtn" style="background:#19192a;color:#00ffff;">Logout</button>
        </nav>
    </div>
    <div class="panel-bg" id="linkMenuBg">
        <nav class="side-panel" id="linkMenu">
            <div class="panel-header">
                <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
                <div class="username">Elvion AI</div>
            </div>
            <div class="panel-links">
                <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
                <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
                <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
                <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
                <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
            </div>
        </nav>
    </div>

<script type="module">
/* ---------- Stars ---------- */
document.addEventListener('DOMContentLoaded', () => {
    const starsContainer = document.getElementById('stars-container');
    for(let i=0;i<34;i++){
        const s=document.createElement('div'); s.className='star';
        const z=Math.random()*2.1+1; s.style.width=z+'px'; s.style.height=z+'px';
        s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%';
        s.style.animationDelay=(Math.random()*3.69)+'s';
        s.style.animationDuration=(2.2+Math.random()*1.1)+'s';
        starsContainer.appendChild(s);
    }
});

/* ---------- Fullscreen ---------- */
const mainContainer = document.getElementById('mainContainer');
const fullscreenBtn = document.getElementById('fullscreenBtn');
let isFull = false;
fullscreenBtn.onclick = function() {
    isFull = !isFull;
    if(isFull){
        mainContainer.classList.add('fullscreen');
        fullscreenBtn.innerHTML = '<i class="fa-solid fa-compress"></i>';
    } else {
        mainContainer.classList.remove('fullscreen');
        fullscreenBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
    }
};

/* ---------- Panels/Modals ---------- */
const profileMenuBg = document.getElementById('profileMenuBg'), profileMenu = document.getElementById('profileMenu');
const linkMenuBg = document.getElementById('linkMenuBg'), linkMenu = document.getElementById('linkMenu');
document.getElementById('openProfileMenu').onclick = () => { profileMenuBg.classList.add('active'); setTimeout(() => profileMenu.classList.add('active'), 10); };
profileMenuBg.onclick = e => { if(e.target === profileMenuBg){ profileMenu.classList.remove('active'); setTimeout(() => profileMenuBg.classList.remove('active'), 110); } };
document.getElementById('openLinksMenu').onclick = () => { linkMenuBg.classList.add('active'); setTimeout(() => linkMenu.classList.add('active'), 10); };
linkMenuBg.onclick = e => { if(e.target === linkMenuBg){ linkMenu.classList.remove('active'); setTimeout(() => linkMenuBg.classList.remove('active'), 110); } };
document.getElementById("logoutBtn").onclick = () => window.location.href = 'signup-login.html';

/* ---------- Firebase Imports/Setup ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
import { getDatabase, ref as dbRef, set, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);
const database = getDatabase(app);

/* ---------- Auth/Profile ---------- */
let currentUser, userChats = [], currentChatIdx = 0;
const chatSelector = document.getElementById("chatSelector");
const chatBox = document.getElementById("chatBox");

onAuthStateChanged(auth, async user => {
    if (!user) {
        window.location.href = "signup-login.html";
    } else {
        currentUser = user;
        document.getElementById("greetMsg").textContent = "Welcome, " + (user.displayName || user.email.split('@')[0]) + "!";
        document.getElementById("profileMenuUser").textContent = user.displayName || "User";
        document.getElementById("profileMenuEmail").textContent = user.email;
        document.getElementById("edit-name").value = user.displayName || "";
        document.getElementById("edit-photo").value = user.photoURL || "";
        document.getElementById("profilePicPreview").src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
        await loadChatsFromFirebase();
        renderChatSelector();
        renderChatBox(userChats[currentChatIdx]?.history || []);
    }
});

document.getElementById("edit-photo").oninput = function () {
    document.getElementById("profilePicPreview").src = this.value || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
};

document.getElementById("profileForm").onsubmit = async function (e) {
    e.preventDefault(); if (!currentUser) return;
    const status = document.getElementById("profileStatusMsg"); status.textContent = '';
    const name = document.getElementById("edit-name").value.trim();
    const photoURL = document.getElementById("edit-photo").value.trim();
    try {
        await updateProfile(currentUser, { displayName: name, photoURL });
        await auth.currentUser.reload();
        status.textContent = "Profile updated!";
        status.style.color = "#00ffff";
        setTimeout(() => { profileMenu.classList.remove('active'); profileMenuBg.classList.remove('active'); }, 650);
        document.getElementById("greetMsg").textContent = "Welcome, " + (auth.currentUser.displayName || auth.currentUser.email.split('@')[0]) + "!";
    } catch (err) {
        status.textContent = err.message || "Update failed";
        status.style.color = "#ffd700";
    }
};

/* ---------- Firebase Storage & Chat Save/Load ---------- */
async function uploadChatImage(base64String, filename = "chat_image.png") {
    const imageKey = Date.now() + "" + Math.random().toString(36).slice(2, 8);
    const imgRef = storageRef(storage, `chat_images/${currentUser.uid}/${imageKey}_${filename}`);
    await uploadString(imgRef, base64String, 'data_url');
    return await getDownloadURL(imgRef);
}

async function saveChatsToFirebase() {
    if (!currentUser || !userChats) return;
    await set(dbRef(database, `chats/${currentUser.uid}`), userChats);
}

async function loadChatsFromFirebase() {
    if (!currentUser) return;
    const snap = await get(dbRef(database, `chats/${currentUser.uid}`));
    if (snap.exists()) {
        userChats = snap.val() || [];
        if (!Array.isArray(userChats)) userChats = [];
        currentChatIdx = userChats.length > 0 ? userChats.length - 1 : 0;
    } else {
        userChats = [{ name: "Chat 1", history: [] }];
        currentChatIdx = 0;
    }
}

/* ---------- Rendering ---------- */
function renderChatSelector() {
    chatSelector.innerHTML = "";
    if (userChats.length === 0) {
        userChats.push({ name: "Chat 1", history: [] });
        currentChatIdx = 0;
    }
    userChats.forEach((chat, idx) => {
        const option = document.createElement("option");
        option.value = idx;
        option.textContent = chat.name || (chat.history?.[0]?.text?.slice(0, 25) || "Untitled");
        option.selected = (idx === currentChatIdx);
        chatSelector.appendChild(option);
    });
}

chatSelector.onchange = function () {
    currentChatIdx = parseInt(this.value, 10);
    renderChatBox(userChats[currentChatIdx]?.history || []);
};

function renderChatBox(messages) {
    chatBox.innerHTML = "";
    (messages || []).forEach(msg => {
        const div = document.createElement('div');
        div.className = `chat-message ${msg.role}`;
        
        const msgContent = document.createElement('div');
        msgContent.className = 'msg';

        if (msg.role === "user") {
            msgContent.innerHTML = msg.text.startsWith('image:') 
                ? msg.text.replace('image:', '') 
                : escapeHTML(msg.text || '');
        } else { // AI messages
            const { html } = renderMarkdown(msg.text || '');
            msgContent.innerHTML = html;
        }
        
        div.appendChild(msgContent);

        if (msg.role === 'ai') {
            const actions = document.createElement('div');
            actions.className = 'message-actions';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'action-btn';
            copyBtn.title = 'Copy';
            copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(msg.text);
                copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                setTimeout(() => { copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i>'; }, 1000);
            };

            const shareBtn = document.createElement('button');
            shareBtn.className = 'action-btn';
            shareBtn.title = 'Share';
            shareBtn.innerHTML = '<i class="fa-solid fa-share"></i>';
            shareBtn.onclick = () => {
                if (navigator.share) {
                    navigator.share({ title: 'AI Chat Response', text: msg.text }).catch(console.error);
                } else {
                    alert('Share feature not supported in your browser.');
                }
            };
            
            actions.appendChild(copyBtn);
            actions.appendChild(shareBtn);
            div.appendChild(actions);
        }
        
        chatBox.appendChild(div);
    });
    
    enhanceCodeBlocks(chatBox);
    chatBox.scrollTop = chatBox.scrollHeight;
}

/* * ---------- Markdown & Code Rendering ---------- */
const escapeHTML = (str) => {
    const div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
};

function inlineMarkdown(text) {
    let html = escapeHTML(text);
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italics
    html = html.replace(/`(.*?)`/g, '<code>$1</code>');   // Inline code
    return html;
}

function renderMarkdown(text = '') {
    if (text.startsWith('image:')) {
        const url = text.substring(6);
        return { html: `<img src="${escapeHTML(url)}" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin-top:3px;"><br><em>(Watermarked by Philadelphia AI)</em>` };
    }

    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    
    text.replace(codeBlockRegex, (match, lang, code, offset) => {
        const before = text.slice(lastIndex, offset);
        html += inlineMarkdown(before);
        
        const language = (lang || '').toLowerCase().trim();
        const safe = escapeHTML(code);
        const blockId = 'code_' + Math.random().toString(36).slice(2);
        
        html += `<pre data-block-id="${blockId}">\n            <button class="copy-btn" data-copy="${blockId}">Copy</button>\n            <code class="language-${language || 'plaintext'}">${safe}</code>\n        </pre>`;
        
        lastIndex = offset + match.length;
        return match;
    });

    html += inlineMarkdown(text.slice(lastIndex));
    return { html };
}

function enhanceCodeBlocks(container) {
    container.querySelectorAll('pre code').forEach((block) => {
        if (window.hljs) {
            window.hljs.highlightElement(block);
        }
    });
    container.querySelectorAll('.copy-btn').forEach(button => {
        button.onclick = () => {
            const blockId = button.dataset.copy;
            const codeElement = container.querySelector(`[data-block-id="${blockId}"] code`);
            if (codeElement) {
                navigator.clipboard.writeText(codeElement.textContent);
                button.textContent = 'Copied!';
                setTimeout(() => { button.textContent = 'Copy'; }, 1000);
            }
        };
    });
}

/* ---------- Chat Input & Sending ---------- */
const chatInput = document.getElementById("chatInput");
const chatForm = document.getElementById("chatForm");
const sendBtn = document.getElementById("sendBtn");
const statusMsg = document.getElementById("statusMsg");
const fileInput = document.getElementById("chatFile");
const filePreview = document.getElementById("filePreview");

let attachedFile = null;

fileInput.onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
        attachedFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            filePreview.innerHTML = `
                ${file.type.startsWith('image/') ? `<img src="${e.target.result}" alt="Preview">` : ''}
                ${file.type.startsWith('video/') ? `<video src="${e.target.result}" controls></video>` : ''}
                <div class="file-info">
                    <i class="fa-solid fa-file"></i> ${file.name} (${(file.size / 1024).toFixed(2)} KB)
                </div>
            `;
            filePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        attachedFile = null;
        filePreview.style.display = 'none';
    }
};

chatInput.onkeydown = function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit', { cancelable: true }));
    }
};

chatForm.onsubmit = async function(e) {
    e.preventDefault();
    const msgText = chatInput.value.trim();
    if (!msgText && !attachedFile) return;

    chatInput.value = '';
    fileInput.value = '';
    filePreview.style.display = 'none';
    attachedFile = null;

    userChats[currentChatIdx].history.push({ role: "user", text: msgText });
    renderChatBox(userChats[currentChatIdx].history);
    await saveChatsToFirebase();

    statusMsg.textContent = 'AI is typing...';
    appendTypingIndicator();

    try {
        let imageUrl = null;
        if (attachedFile) {
            const reader = new FileReader();
            const fileReadPromise = new Promise(resolve => {
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(attachedFile);
            });
            const base64File = await fileReadPromise;
            imageUrl = await uploadChatImage(base64File, attachedFile.name);
            userChats[currentChatIdx].history.push({ role: "user", text: `image:${imageUrl}` });
            renderChatBox(userChats[currentChatIdx].history);
            await saveChatsToFirebase();
        }

        if (/^\/image\s+.+/i.test(msgText)) {
            const prompt = msgText.substring(7).trim();
            const res = await fetch('https://api.pawan.krd/v1/images/generations', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer pk-thisisforkrdoapi',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,
                    n: 1,
                    size: '256x256'
                })
            });
            let data;
            try { data = await res.json(); } catch (_) { data = {}; }
            removeTyping();

            if (data.data && data.data.length > 0 && data.data[0].url) {
                const imgUrl = data.data[0].url;
                const imageMessage = `image:${imgUrl}`;
                userChats[currentChatIdx].history.push({ role: "ai", text: imageMessage });
            } else {
                const botText = data.error?.message || "❌ Image generation failed. Try another prompt.";
                userChats[currentChatIdx].history.push({ role: "ai", text: botText });
            }
            await saveChatsToFirebase();
            renderChatBox(userChats[currentChatIdx].history);

        } else {
            const res = await fetch('https://api.pawan.krd/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer pk-thisisforkrdoapi',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: userChats[currentChatIdx].history,
                    max_tokens: 1000,
                    temperature: 0.7
                })
            });
            const data = await res.json();
            removeTyping();

            if (data.choices && data.choices.length > 0) {
                const botText = data.choices[0].message.content;
                userChats[currentChatIdx].history.push({ role: "ai", text: botText });
            } else {
                const botText = data.error?.message || "❌ Something went wrong. Please try again.";
                userChats[currentChatIdx].history.push({ role: "ai", text: botText });
            }
            await saveChatsToFirebase();
            renderChatBox(userChats[currentChatIdx].history);
        }

    } catch (err) {
        removeTyping();
        statusMsg.textContent = `Error: ${err.message}`;
        userChats[currentChatIdx].history.push({ role: "ai", text: `Error: ${err.message}` });
        await saveChatsToFirebase();
        renderChatBox(userChats[currentChatIdx].history);
    }
};

/* ---------- Typing Indicator ---------- */
let typingIndicator = null;
function appendTypingIndicator() {
    if (typingIndicator) return;
    typingIndicator = document.createElement('div');
    typingIndicator.className = 'chat-message ai';
    typingIndicator.innerHTML = '<div class="msg typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></div>';
    chatBox.appendChild(typingIndicator);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function removeTyping() {
    if (typingIndicator && typingIndicator.parentNode) {
        typingIndicator.parentNode.removeChild(typingIndicator);
        typingIndicator = null;
    }
    statusMsg.textContent = '';
}

/* ---------- Chat Management ---------- */
document.getElementById("newChatBtn").onclick = async () => {
    const newChatName = `Chat ${userChats.length + 1}`;
    userChats.push({ name: newChatName, history: [] });
    currentChatIdx = userChats.length - 1;
    renderChatSelector();
    renderChatBox([]);
    await saveChatsToFirebase();
};

document.getElementById("delChatBtn").onclick = async () => {
    if (userChats.length > 1) {
        if (confirm(`Are you sure you want to delete "${userChats[currentChatIdx].name}"?`)) {
            userChats.splice(currentChatIdx, 1);
            currentChatIdx = Math.max(0, currentChatIdx - 1);
            renderChatSelector();
            renderChatBox(userChats[currentChatIdx]?.history || []);
            await saveChatsToFirebase();
        }
    } else {
        alert("Cannot delete the last chat. Create a new one first if you want to clear this one.");
    }
};

/* ---------- Voice Input (Placeholder) ---------- */
document.getElementById("voiceInputBtn").onclick = () => {
    alert("Voice input feature is not yet implemented.");
};
</script>
</body>
</html>
