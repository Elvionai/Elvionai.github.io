<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elvion AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Highlight.js (syntax highlighting) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // initialize once; we'll also call hljs.highlightElement on new blocks
      if (window.hljs) hljs.configure({ignoreUnescapedHTML: true});
    });
  </script>

  <style>
:root {
  --cyan:#00ffff; --blue:#0090ff; --bg:#191a26; --card:#181e2e; --radius:18px; --text:#e0e0e0;
  --muted:#b3b3b3; --shadow:0 0 31px #00fff2a4;
}

html, body {
  height: 100vh; margin:0; padding:0;
  font-family:'Roboto', 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
  background: radial-gradient(ellipse 85% 100% at 60% 50%, #23233a 75%, #0a1128 100%);
  color:var(--text);
  overscroll-behavior-y: none;
}

/* Layout root */
.card-container {
  width: 100vw; height: 100vh;
  display: flex; flex-direction: column;
  align-items: center; justify-content: flex-start;
  background: var(--card);
  padding: 0; position: fixed; left:0; top:0; right:0; bottom:0; z-index: 2;
  overflow: hidden;
}

.fullscreen {position:fixed !important; top:0; left:0; width:100vw; height:100vh; padding:0; border-radius:0; z-index:10; box-shadow:none;}

/* Header bar */
.header-bar { width: 99%; display: flex; align-items: center; justify-content: space-between; padding: 14px 14px 9px 6px; flex-shrink: 0; background: transparent; }
.menu-btn, .fullscreen-btn { background:none; border:none; color:var(--cyan); cursor:pointer; padding:0 11px; }
.menu-btn { font-size:2em; }
.fullscreen-btn { font-size:1.19em; margin-left:11px; }
.fullscreen-btn:hover, .menu-btn:hover { background:var(--cyan); color:#23233a; border-radius:12px; }
.site-heading {
  font-family:'Orbitron', sans-serif; font-size:1.10em; font-weight:700; letter-spacing:.38px;
  background:linear-gradient(90deg,#00ffff,#fff,#0090ff); background-size:200% auto; -webkit-background-clip:text;
  -webkit-text-fill-color:transparent; animation:shine 4s linear infinite; text-shadow:0 0 13px #00ffff43;
}
@keyframes shine{to{background-position:200% center;}}
.header-welcome { color:#aee; font-size:.99em; margin:-4px 0 0.5em 0; text-align:center; }

/* Chat and scroll */
.chat-box {
  flex: 1 1 0%;
  overflow-y: auto; width:100vw; max-width: 900px;
  margin: 0 auto; padding: 3px 0 4px 0;
  background: transparent;
  overscroll-behavior-y: contain;
}
.chat-message {
  max-width: 99.2vw;
  width: 100%;
  margin: 7px 0 7px 0;
  padding: 0;
  display: flex; align-items: flex-end; gap: 10px;
  transition: margin .11s;
}
.chat-message.user { justify-content: flex-end; }
.chat-message .msg {
  display:inline-block;
  background:#162236;
  border-radius: 13px;
  color: #e1eafd;
  padding: 10px 13px 9px 13px;
  margin-bottom: 0;
  max-width: 92vw;
  min-width: 0;
  font-size: 1em; line-height: 1.56; box-shadow: 0 2px 7px #00fff01f;
  word-break: break-word; white-space: pre-wrap;
}
.chat-message.user .msg {
  background: #141521;
  color: #b3eafd;
  font-weight: 600;
  box-shadow: 0 2px 5px #9911ee14;
}
@media (max-width: 600px) {
  .chat-message .msg { font-size: 0.97em; padding: 8px 6vw 8px 7vw; border-radius: 9px; max-width: 97vw; }
  .chat-message {margin: 4px 0;}
}

/* Inline AI response controls */
.inline-copy-btn, .inline-share-btn, .regen-btn {
  padding: 5px 11px 5px 11px;
  margin-top: 2px;
  background: linear-gradient(90deg, #00ffff, #0090ff);
  border: none;
  border-radius: 7px;
  color: #23233a;
  font-family: 'Inter', 'Orbitron', Arial, sans-serif;
  font-size: 0.98em;
  font-weight: bold;
  box-shadow: 0 1px 4px #00fff244;
  cursor: pointer;
  transition: background 0.18s, color .16s;
  display: inline-flex; align-items: center; gap: 5px;
}
.inline-copy-btn:hover, .inline-share-btn:hover, .regen-btn:hover {
  background: #0090ff;
  color: #fff;
}
.chat-message.ai .inline-copy-btn,
.chat-message.ai .inline-share-btn,
.chat-message.ai .regen-btn {
  font-size: 0.97em;
  padding: 5px 10px;
  margin-right: 4px; margin-left: 0;
}

/* File preview above keyboard, compact */
.file-preview {
  background: #191e2f;
  border-radius: 9px;
  padding: 6px 8px 4px 8px;
  color: #c0eefd;
  font-size: 0.99em;
  display: none;
  margin: 4px auto 7px auto;
  width: 99vw; max-width: 870px;
  min-height: 0;
  box-shadow: 0 4px 12px #00fff01b;
  overflow-x: auto;
}
.file-preview img, .file-preview video { max-width: 110px; border-radius: 8px; margin-right: 10px; }
.file-preview audio { width: 85px; margin-right: 8px;}
.file-preview .remove-file-btn { color: #fff; background: #e23333; border: none; border-radius: 11px; padding: 0 8px; cursor: pointer; font-size: 1.10em; margin-left: 7px; }

/* Chat input row at bottom */
.chat-input-row {
  display: flex; align-items: stretch; gap: 4px;
  background: #23233a; border-radius: 13px;
  margin: 0 auto 0.5vh auto; max-width: 900px; width: 99vw;
  border: 1.1px solid #00fff025;
  padding: 8px 6px 8px 7px;
  box-shadow: 0 3px 12px #00fff01f;
  position: sticky; bottom: 0; z-index: 40;
}
@media (max-width: 600px) {
  .chat-input-row {margin-bottom: 0;width: 100vw;border-radius: 0;}
  .chat-input-row textarea { font-size: 1em; min-height: 32px; }
}
.chat-input-row textarea {
  flex: 1 1 auto;
  min-height: 38px;
  max-height: 110px;
  border-radius: 8px;
  border: none;
  background: #171a25;
  color: #e1eaff;
  font-size: 1.07em;
  padding: 8px 13px;
  resize: none;
}
/* Keyboard and button row buttons */
.chat-input-row button, .chat-input-row label {
  background: none; border: none;
  color: #00ffff;
  padding: 0 8px;
  font-size: 1.22em;
  border-radius: 8px;
  cursor: pointer;
  transition: color .13s, background .13s;
  display: flex; align-items: center; height: 38px;
}
.chat-input-row button:active,
.chat-input-row label:active,
.chat-input-row button:focus,
.chat-input-row label:focus { color: #fff900; outline: none; }
.file-upload-btn { cursor: pointer; }
.file-upload-btn:hover { color: #fff900; }

/* Emoji panel */
#emojiPanel {
  display: none;
  position: absolute;
  bottom: 63px;
  left: 9px;
  z-index: 90;
  background:#222a38d9;
  border-radius:13px;
  padding:13px;
  box-shadow:0 5px 19px #00fff287;
}
.emoji-pick {
  font-size:1.35em;
  cursor:pointer;
  padding:2px 4px;
  border-radius:7px;
  transition:background .13s;
}
.emoji-pick:hover { background:#177; }
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="card-container" id="mainContainer">
    <div class="header-bar">
  <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu">
    <i class="fa-solid fa-user"></i>
  </button>
  <span class="site-heading" style="flex:1;text-align:center;">
    Philadelphia AI
  </span>
  <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu">
    <i class="fa-solid fa-link"></i>
  </button>
</div>
<div class="header-welcome" id="headerWelcome" style="text-align:center;font-size:0.97em;color:#aee;margin:-4px 0 0.5em 0;">
  <!-- Username filled by JS, e.g. Welcome, Moses -->
</div>

    <div class="chat-box" id="chatBox"></div>

    <div id="filePreview" class="file-preview" style="display:none;"></div>

    <!-- CHAT INPUT -->
    <form class="chat-input-row" id="chatForm" autocomplete="off">
  <button type="button" id="emojiBtn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
  <label for="chatFile" title="Attach file" class="file-upload-btn"><i class="fa-solid fa-paperclip"></i></label>
  <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none">
  <textarea id="chatInput" placeholder="Type here… (Shift+Enter = new line)"></textarea>
  <button type="button" id="voiceInputBtn" title="Voice Typing"><i class="fa-solid fa-microphone"></i></button>
  <button type="button" id="imageBtn" title="Image AI"><i class="fa-solid fa-image"></i></button>
  <button type="button" id="voiceBtn" title="Voice AI"><i class="fa-solid fa-microphone-lines"></i></button>
  <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
</form>
<div id="emojiPanel" style="display:none;position:absolute;bottom:63px;left:9px;z-index:90;background:#222a38d9;border-radius:13px;padding:13px;box-shadow:0 5px 19px #00fff287;"></div>

    <div class="status-message" id="statusMsg"></div>
  </div>

  <!-- Profile Menu Modal -->
  <div class="panel-bg" id="profileMenuBg">
  <nav class="side-panel" id="profileMenu">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <span style="font-size:1.15em;font-weight:700;color:#00ffff;margin:16px 0 0 15px;">Chats</span>
      <button style="font-size:2em;color:#f44;background:transparent;border:none;margin:15px 15px 0 0;cursor:pointer;" 
        onclick="profileMenuBg.classList.remove('active');">×</button>
    </div>
    <div id="chatsList" style="margin:5px 0 13px 17px;max-height:173px;overflow-y:auto;">
      <!-- Chat list JS-generated here, each chat: [title][✏][🗑][▶] -->
    </div>
    <button id="newChatBtn" class="action-btn" style="margin:0 0 16px 19px;"><i class="fa-solid fa-plus"></i> New Chat</button>
    <hr style="width:94%;margin:15px 0 4px 3%;border:1px solid #00fff036;">
    <div class="panel-header">
      <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
      <div class="username" id="profileMenuUser">User</div>
      <div class="email" id="profileMenuEmail">email@example.com</div>
    </div>
    <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 18px;">
      <label for="edit-name">Name</label>
      <input type="text" id="edit-name" required>
      <label for="edit-photo">Photo URL</label>
      <input type="url" id="edit-photo" placeholder="Paste image link">
      <span class="profile-photo-tip">
        For photo, <a href="https://postimg.cc/" target="_blank" style="color:#00ffff;">upload at postimg.cc</a> and paste link here.
      </span>
      <button type="submit" class="submit-btn">Save</button>
      <div class="status-message" id="profileStatusMsg"></div>
    </form>
    <button class="submit-btn" id="logoutBtn" style="background:#19192a;color:#00ffff;margin:7px 18px 17px 18px;">Logout</button>
  </nav>
</div>

  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:85px;max-width:320px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;">
  <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
  <div id="ai-image-container"></div>
  <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
</div>

  <!-- Link Menu Modal -->
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
        <div class="username">Elvion AI</div>
      </div>
      <div class="panel-links">
        <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </nav>
  </div>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Short helper
const $ = id => document.getElementById(id);

// ---------- Global chat storage (move BEFORE auth callback) ----------
let chats = JSON.parse(localStorage.getItem("elvion_chats") || "[]");
let currentChatIdx = chats.length - 1 >= 0 ? chats.length - 1 : 0;

function saveChats() {
  try {
    let sanitized = JSON.parse(JSON.stringify(chats));
    sanitized.forEach(chat => {
      (chat.history || []).forEach(msg => {
        if (msg.text && typeof msg.text === 'string' && msg.text.includes("data:image")) {
          msg.text = "[image omitted]";
        }
      });
    });
    localStorage.setItem("elvion_chats", JSON.stringify(sanitized));
  } catch (e) { console.warn('saveChats failed', e); }
}

// Keep file/upload state
let uploadedFiles = [];
let uploadData = null;

// ---------- All DOM & event wiring after DOM ready ----------
window.addEventListener('DOMContentLoaded', () => {
  /* ---------- Elements (may be null if markup is different) ---------- */
  const starsContainer = $('stars-container');
  const mainContainer = $('mainContainer');
  const fullscreenBtn = $('fullscreenBtn');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatSelector = $('chatSelector');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const voiceInputBtn = $('voiceInputBtn');
  const addChatBtn = $('addChatBtn');
  const removeChatBtn = $('removeChatBtn');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  
 /* For Emoji */
const emojis = ["😀","😃","😂","🤣","😍","🥰","😎","👍","🙏","🔥","💯","🎉","😇","🫶","😜","🤖","👀"];
emojiBtn.addEventListener('click', function(e) {
  emojiPanel.innerHTML = emojis.map(e => `<span class="emoji-pick" style="font-size:1.3em;cursor:pointer;padding:2px;">${e}</span>`).join('');
  emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
  emojiPanel.style.left = `${emojiBtn.offsetLeft}px`;
  emojiPanel.style.bottom = `60px`;
  // When emoji is clicked, insert at cursor
  emojiPanel.querySelectorAll('.emoji-pick').forEach(span => {
    span.onclick = function() {
      if (chatInput) {
        const [start, end] = [chatInput.selectionStart, chatInput.selectionEnd];
        chatInput.value = chatInput.value.slice(0, start) + this.textContent + chatInput.value.slice(end);
        chatInput.focus();
        chatInput.selectionEnd = start + this.textContent.length;
      }
      emojiPanel.style.display = 'none';
    }
  });
});
document.addEventListener('click', e => {
  if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) emojiPanel.style.display = 'none';
});

  
  /* ---------- Stars ---------- */
  if (starsContainer) {
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  /* ---------- Fullscreen toggle ---------- */
  if (fullscreenBtn && mainContainer) {
    let isFull = false;
    fullscreenBtn.addEventListener('click', () => {
      isFull = !isFull;
      mainContainer.classList.toggle('fullscreen', isFull);
      fullscreenBtn.innerHTML = isFull ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>';
    });
  }

  /* ---------- Panels/Modals ---------- */
  if (profileMenuBg && profileMenu && $('openProfileMenu')) {
    $('openProfileMenu').addEventListener('click', () => { profileMenuBg.classList.add('active'); setTimeout(() => profileMenu.classList.add('active'), 10); });
    profileMenuBg.addEventListener('click', e => { if (e.target === profileMenuBg) { profileMenu.classList.remove('active'); setTimeout(() => profileMenuBg.classList.remove('active'), 110); } });
  }
  if (linkMenuBg && linkMenu && $('openLinksMenu')) {
    $('openLinksMenu').addEventListener('click', () => { linkMenuBg.classList.add('active'); setTimeout(() => linkMenu.classList.add('active'), 10); });
    linkMenuBg.addEventListener('click', e => { if (e.target === linkMenuBg) { linkMenu.classList.remove('active'); setTimeout(() => linkMenuBg.classList.remove('active'), 110); } });
  }
  if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = 'signup-login.html');

  /* ---------- Firebase Auth (profile only) ---------- */
  let currentUser = null;

  onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "signup-login.html";
    return;
  }
  currentUser = user;

  // --- Welcome/User Info ---
  if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]) + "!";
  if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
  if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
  if (editName) editName.value = user.displayName || "";
  if (editPhoto) editPhoto.value = user.photoURL || "";
  if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

  // --- CRITICAL: Ensure at least one chat exists ---
  if (!chats.length) {
    chats.push({ name: 'Chat 1', history: [] });
    currentChatIdx = 0;
    saveChats();
  }
  // --- FIX: Always show first (current) chat and chat selector on page load ---
  renderChatSelector();
  renderChatBox(chats[currentChatIdx]?.history || []);
});

  /* ---------- Profile photo input preview ---------- */
  if (editPhoto && profilePicPreview) {
    editPhoto.addEventListener('input', function () { profilePicPreview.src = this.value || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg"; });
  }

  /* ---------- Profile form submit ---------- */
  if (profileForm) {
    profileForm.addEventListener('submit', async function (e) {
      e.preventDefault(); if (!currentUser) return;
      const status = $('profileStatusMsg'); if (status) status.textContent = '';
      const name = (editName ? editName.value.trim() : '');
      const photoURL = (editPhoto ? editPhoto.value.trim() : '');
      try {
        await updateProfile(currentUser, { displayName: name, photoURL });
        // reload current user if available
        if (auth.currentUser && typeof auth.currentUser.reload === 'function') {
          await auth.currentUser.reload();
        }
        if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; }
        setTimeout(() => { profileMenu?.classList.remove('active'); profileMenuBg?.classList.remove('active'); }, 650);
        // use headerWelcome (was greetMsg previously)
        if (headerWelcome) headerWelcome.textContent = "Welcome, " + (auth.currentUser?.displayName || (auth.currentUser?.email || '').split('@')[0]) + "!";
      } catch (err) {
        if (status) { status.textContent = err.message || "Update failed"; status.style.color = "#ffd700"; }
      }
    });
  }

  /* ---------- Sidebar: render chat list ---------- */
  function renderChatsListSidebar() {
    if (!chatsListEl) return;
    chatsListEl.innerHTML = '';
    chats.forEach((chat, idx) => {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.marginBottom = '4px';

      // Title span with inline edit
      const titleSpan = document.createElement('span');
      titleSpan.textContent = chat.name || `Chat ${idx + 1}`;
      titleSpan.style.flex = '1';
      titleSpan.style.cursor = 'pointer';
      titleSpan.onclick = () => {
        currentChatIdx = idx;
        renderChatBox(chat.history);
        if (chatSelector) {
          chatSelector.value = idx;
        }
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      // Rename (✏️)
      const renameBtn = document.createElement('button');
      renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
      renameBtn.title = 'Rename';
      renameBtn.style.margin = '0 6px 0 9px';
      renameBtn.onclick = (e) => {
        e.stopPropagation();
        let newName = prompt("Rename chat:", chat.name || `Chat ${idx + 1}`);
        if (newName) {
          chat.name = newName.trim();
          saveChats();
          renderChatsListSidebar();
          renderChatSelector(); // sync main selector
        }
      };

      // Delete (🗑️)
      const delBtn = document.createElement('button');
      delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.title = 'Delete';
      delBtn.style.marginLeft = '6px';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm("Delete this chat?")) {
          chats.splice(idx, 1);
          if (currentChatIdx >= chats.length) currentChatIdx = chats.length - 1;
          if (!chats.length) {
            chats.push({ name: 'Chat 1', history: [] });
            currentChatIdx = 0;
          }
          saveChats();
          renderChatsListSidebar();
          renderChatSelector();
          renderChatBox(chats[currentChatIdx]?.history || []);
        }
      };

      // Open (▶)
      const openBtn = document.createElement('button');
      openBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
      openBtn.title = 'Open Chat';
      openBtn.onclick = (e) => {
        e.stopPropagation();
        currentChatIdx = idx;
        renderChatBox(chat.history);
        if (chatSelector) chatSelector.value = idx;
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      container.appendChild(titleSpan);
      container.appendChild(renameBtn);
      container.appendChild(delBtn);
      container.appendChild(openBtn);
      chatsListEl.appendChild(container);
    });
  }

  // Wire up the "New Chat" button in sidebar if present
  if (newChatBtn) {
    newChatBtn.addEventListener('click', () => {
      chats.push({ name: "Chat " + (chats.length + 1), history: [] });
      currentChatIdx = chats.length - 1;
      saveChats();
      renderChatsListSidebar();
      renderChatSelector();
      renderChatBox(chats[currentChatIdx]?.history || []);
    });
  }

  /* ---------- LocalStorage Chat Logic, Excluding Images ---------- */
  function renderChatSelector() {
    if (!chatSelector) return;
    chatSelector.innerHTML = "";
    chats.forEach((chat, idx) => {
      const option = document.createElement("option");
      option.value = idx;
      option.textContent = chat.name || (chat.history?.[0]?.text?.slice(0, 24) || "Untitled");
      chatSelector.appendChild(option);
    });
    // ensure index validity
    if (chats.length === 0) {
      currentChatIdx = 0;
      // add a default chat so UI has something to show
      chats = [{ name: 'Chat 1', history: [] }];
      saveChats();
      // re-render the selector with default chat
      renderChatSelector();
      return;
    }
    if (typeof currentChatIdx === 'number') {
      currentChatIdx = Math.min(Math.max(0, currentChatIdx), Math.max(0, chats.length - 1));
      chatSelector.value = currentChatIdx;
    }
  }

  if (chatSelector) {
    chatSelector.addEventListener('change', function () {
      currentChatIdx = parseInt(this.value) || 0;
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  if (addChatBtn) {
    addChatBtn.addEventListener('click', function () {
      const name = "Chat " + (chats.length + 1);
      chats.push({ name, history: [] });
      currentChatIdx = chats.length - 1;
      saveChats();
      renderChatSelector();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  if (removeChatBtn) {
    removeChatBtn.addEventListener('click', function () {
      if (!chats.length) return;
      if (!confirm("Delete this chat?")) return;
      chats.splice(currentChatIdx, 1);
      currentChatIdx = Math.max(0, currentChatIdx - 1);
      if (!chats.length) {
        chats.push({ name: 'Chat 1', history: [] });
        currentChatIdx = 0;
      }
      saveChats();
      renderChatSelector();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  /* ---------- Markdown, Code, Copy, Share ---------- */
  const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

  function renderMarkdown(text = '') {
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    text = text || '';

    text.replace(codeBlockRegex, (match, lang, code, offset) => {
      const before = text.slice(lastIndex, offset);
      html += inlineMarkdown(before);
      const language = (lang || '').toLowerCase().trim();
      const safe = escapeHTML(code);
      const blockId = 'code_' + Math.random().toString(36).slice(2);
      html += `<pre data-block-id="${blockId}">\n  <button class="copy-btn" data-copy="${blockId}">Copy</button>\n  <code class="language-${language || 'plaintext'}">${safe}</code>\n</pre>`;
      lastIndex = offset + match.length;
      return match;
    });

    html += inlineMarkdown(text.slice(lastIndex));
    return { html };
  }

  function inlineMarkdown(t = '') {
    let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`);
    s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
    s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return s.replace(/\n/g, '<br>');
  }

  function enhanceCodeBlocks(container) {
    if (!container) return;
    container.querySelectorAll('pre').forEach(pre => {
      const codeEl = pre.querySelector('code');
      if (window.hljs && codeEl) try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ }
      const btn = pre.querySelector('.copy-btn');
      if (btn && codeEl) {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(codeEl.innerText);
            const prev = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = prev, 800);
          } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); }
        });
      }
    });
  }

  /* ---------- Chat Rendering with Copy/Share ---------- */
  function renderChatBox(messages) {
    if (!chatBox) return;
    chatBox.innerHTML = "";
    let aiMsgIdx = 0;
    (messages || []).forEach((msg, mi) => {
      const div = document.createElement('div');
      div.className = "chat-message " + (msg.role === "user" ? "user" : "ai");
      if (msg.text && /^(\[File\]|image:)/.test(msg.text)) {
        div.innerHTML = msg.text.replace('image:', '');
      } else if (msg.role === "ai") {
        const { html } = renderMarkdown(msg.text || '');
        div.innerHTML = `<div class="msg">${html}
          <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
            <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
            <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button>
            <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
          </div>
        </div>`;
        div.setAttribute('data-aiidx', aiMsgIdx++);
      } else {
        div.innerHTML = `<div class="msg">${escapeHTML(msg.text || '')}</div>`;
      }
      chatBox.appendChild(div);
    });
    enhanceCodeBlocks(chatBox);
    hookAiMsgControls();
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function hookAiMsgControls() {
    if (!chatBox) return;
    chatBox.querySelectorAll('.chat-message.ai').forEach(div => {
      const aiIdx = Number(div.getAttribute('data-aiidx'));
      const controls = div.querySelector('.ai-msg-controls');
      if (!controls) return;
      const copyBtn = controls.querySelector('.inline-copy-btn');
      const shareBtn = controls.querySelector('.inline-share-btn');
      const regenBtn = controls.querySelector('.regen-btn');

      if (copyBtn)
        copyBtn.onclick = () => {
          try {
            const aiOnly = (chats[currentChatIdx]?.history || []).filter(m => m.role === "ai") || [];
            const text = aiOnly[aiIdx]?.text || "";
            navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
            copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
            setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950);
          } catch (e) {
            console.warn('copy failed', e);
          }
        };

      if (shareBtn)
        shareBtn.onclick = () => {
          try {
            const aiOnly = (chats[currentChatIdx]?.history || []).filter(m => m.role === "ai") || [];
            const text = aiOnly[aiIdx]?.text || "";
            const url = window.location.origin;
            const shareText = `${text.replace(/<\/?[^>]+(>|$)/g, "")}\n\nShared via Philadelphia AI: ${url}`;
            if (navigator.share) {
              navigator.share({ title: "Philadelphia AI", text: shareText, url }).catch(()=>{});
            } else {
              prompt("Copy and share manually:", shareText);
            }
          } catch (e) { console.warn('share failed', e); }
        };

      if (regenBtn)
        regenBtn.onclick = async () => {
          try {
            // Find which index among history this AI is
            let aiMsgCount = 0, aiMsgIndexInHistory = -1;
            const history = chats[currentChatIdx]?.history || [];
            for (let i = 0; i < history.length; i++) {
              if (history[i].role === "ai") {
                if (aiMsgCount === aiIdx) { aiMsgIndexInHistory = i; break; }
                aiMsgCount++;
              }
            }
            const userMsgObj = history[aiMsgIndexInHistory - 1];
            const userMsg = (userMsgObj?.role === "user" ? userMsgObj.text : "");
            if (!userMsg) {
              regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i> Err";
              setTimeout(() => regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i>", 900);
              return;
            }
            // remove the ai message to be regenerated
            if (aiMsgIndexInHistory >= 0) history.splice(aiMsgIndexInHistory, 1);
            saveChats();
            renderChatBox(history);
            showTypingAtNext();
            try {
              let res = await fetch('https://web-production-9a18.up.railway.app/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMsg, user_id: currentUser?.uid || "user", history: [] })
              });
              let data;
              try { data = await res.json(); } catch (e) { data = {}; }
              removeTyping();
              if (data && data.response) {
                history.push({ role: 'ai', text: data.response });
                saveChats();
                renderChatBox(history);
              } else {
                history.push({ role: 'ai', text: '❌ No response from server.' });
                saveChats();
                renderChatBox(history);
              }
            } catch (err) {
              removeTyping();
              history.push({ role: 'ai', text: "❌ Retry Error: " + (err.message || '') });
              saveChats();
              renderChatBox(history);
            }
          } catch (err) {
            console.warn('regen error', err);
          }
        };
    });
  }

  /* ------- Typing / Animation Utilities ---- */
  let typingNode = null;
  function showTypingAtNext() {
    removeTyping();
    if (!chatBox) return;
    typingNode = document.createElement('div');
    typingNode.className = 'chat-message ai';
    typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`;
    chatBox.appendChild(typingNode);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  function removeTyping() { if (typingNode && typingNode.parentNode) { typingNode.parentNode.removeChild(typingNode); typingNode = null; } }

  async function typeBotMessage(text, onDone) {
    removeTyping();
    if (!chatBox) return;
    const div = document.createElement('div'); div.className = "chat-message ai";
    const msgdiv = document.createElement('div'); msgdiv.className = 'msg'; div.appendChild(msgdiv); chatBox.appendChild(div);
    let sofar = '';
    for (const ch of text) {
      sofar += ch;
      msgdiv.innerHTML = renderMarkdown(sofar).html;
      chatBox.scrollTop = chatBox.scrollHeight;
      await new Promise(res => setTimeout(res, 6 + Math.random() * 18));
    }
    msgdiv.innerHTML = renderMarkdown(text).html + `\n  <div style="display:flex;justify-content:end;gap:8px;margin-top:4px;">\n    <button class="inline-copy-btn" title="Copy whole AI response">□ Copy</button>\n    <button class="inline-share-btn" title="Share this reply"><i class="fa-solid fa-share"></i> Share</button>\n  </div>`;
    enhanceCodeBlocks(msgdiv);

    hookAiMsgControls();
    chatBox.scrollTop = chatBox.scrollHeight;

    // attach handlers to the newly appended buttons
    const copyBtn = msgdiv.querySelector('.inline-copy-btn');
    if (copyBtn) copyBtn.onclick = () => { navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, "")); copyBtn.textContent = "Copied!"; setTimeout(() => copyBtn.textContent = "□ Copy", 900); };
    const shareBtn = msgdiv.querySelector('.inline-share-btn');
    if (shareBtn) shareBtn.onclick = async () => { if (navigator.share) { try { await navigator.share({ title: "Philadelphia AI", text }); } catch (e) { /* ignore */ } } else { prompt("Copy and share:", text.replace(/<\/?[^>]+(>|$)/g, "")); } };
    if (onDone) onDone();
  }

  /* ---------- File Preview (images not saved) & Uploaded files state ---------- */
  function renderFilePreview() {
  if (!filePreview) return;
  if (!uploadedFiles.length) {
    filePreview.style.display = 'none';
    filePreview.innerHTML = '';
    return;
  }
  filePreview.style.display = 'block';
  filePreview.innerHTML = uploadedFiles.map((file, idx) => {
    let preview = '';
    if (file.type.startsWith('image/')) {
      preview = `<img src="${URL.createObjectURL(file)}" style="max-width:92px;max-height:74px;vertical-align:middle;border-radius:8px;margin-right:6px;">`;
    } else if (file.type.startsWith('video/')) {
      preview = `<video src="${URL.createObjectURL(file)}" controls style="max-width:80px;height:42px;vertical-align:middle;border-radius:8px;margin-right:7px;"></video>`;
    } else if (file.type.startsWith('audio/')) {
      preview = `<audio controls src="${URL.createObjectURL(file)}" style="vertical-align:middle;width:90px;margin-right:7px;"></audio>`;
    } else if (file.type === 'application/pdf') {
      preview = `<span style="font-size:1.25em;margin-right:7px;">📄</span>`;
    }
    return `
      <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px;">
        ${preview}
        <span style="color:#aee;font-size:.99em;">${file.name}</span>
        <button type="button" data-idx="${idx}" class="remove-file-btn">&times;</button>
      </div>`;
  }).join('');

  filePreview.querySelectorAll('.remove-file-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const idx = parseInt(btn.getAttribute('data-idx'));
      uploadedFiles.splice(idx, 1);
      uploadData = uploadedFiles[0] || null;
      if (!uploadedFiles.length && chatFile) chatFile.value = '';
      renderFilePreview();
    });
  });
}

  if (chatFile) {
    chatFile.addEventListener('change', function () {
      const files = Array.from(this.files || []);
      uploadedFiles = files;
      uploadData = files[0] || null;
      // Quick inline preview for first image/video
      if (filePreview && uploadData) {
        if (uploadData.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => { filePreview.style.display = 'block'; filePreview.innerHTML = `<img src="${e.target.result}" alt="Selected image" style="max-width:200px;border-radius:8px;">`; };
          reader.readAsDataURL(uploadData);
        } else if (uploadData.type.startsWith('video/')) {
          const reader = new FileReader();
          reader.onload = e => { filePreview.style.display = 'block'; filePreview.innerHTML = `<video src="${e.target.result}" controls style="max-width:200px;border-radius:8px;"></video>`; };
          reader.readAsDataURL(uploadData);
        } else {
          renderFilePreview();
        }
      } else {
        renderFilePreview();
      }
    });
  }

  /* ---------- Voice Input (browser speech recognition) ---------- */
  if (voiceInputBtn && chatInput) {
  let recognition = null;
  voiceInputBtn.addEventListener('click', function () {
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
      recognition.onresult = (e) => {
        chatInput.value += (chatInput.value ? ' ' : '') + e.results[0][0].transcript;
        chatInput.dispatchEvent(new Event('input'));
        voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
      };
      recognition.onend = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
      recognition.onerror = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
      recognition.start();
    } else alert('Speech recognition not supported in your browser.');
  });
}

  /* ---------- Textarea auto-resize ---------- */
  if (chatInput) {
    function autoResizeTextarea() { chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px'; }
    chatInput.addEventListener('input', autoResizeTextarea);
    autoResizeTextarea();
    chatInput.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBtn?.click(); } });
  }

  /* ---------- IMAGE & VOICE BUTTONS (create before handlers) ---------- */
  const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore", "gemini6"];
  let currentModelIdx = 0;
  let imageBtn = document.createElement('button'); imageBtn.type = 'button'; imageBtn.id = 'imageBtn'; imageBtn.title = 'Generate image'; imageBtn.innerHTML = '<i class="fa-solid fa-image"></i>';
  let voiceGenBtn = document.createElement('button'); voiceGenBtn.type = 'button'; voiceGenBtn.id = 'voiceBtn'; voiceGenBtn.title = 'Generate voice'; voiceGenBtn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
  if (chatForm && sendBtn) chatForm.insertBefore(imageBtn, sendBtn);
  if (chatForm && sendBtn) chatForm.insertBefore(voiceGenBtn, sendBtn);

  // Image model cycling
  imageBtn.addEventListener('click', function () {
    currentModelIdx = (currentModelIdx + 1) % thenaModels.length;
    let model = thenaModels[currentModelIdx];
    let prevInput = (chatInput ? chatInput.value.replace(/^\/image\s+\w+\s*/i, "").replace(/^\/imagine\s*/i, "") : "");
    if (model === 'gemini6') {
      if (chatInput) chatInput.value = `/imagine ${prevInput}`.trim();
      imageBtn.innerHTML = '<i class="fa-brands fa-google"></i>';
    } else {
      if (chatInput) chatInput.value = `/image ${model} ${prevInput}`.trim();
      imageBtn.innerHTML = '<i class="fa-solid fa-image"></i>';
    }
    chatInput?.focus(); setTimeout(() => { try { chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); } catch (_) { } }, 0);
  });

  /* ---------- Voice Note Generation (use voiceGenBtn created above) ---------- */
  voiceGenBtn.addEventListener('click', async function () {
    if (!chatInput) return;
    let msgText = chatInput.value.trim();
    if (!msgText) { chatInput.focus(); return; }
    let style = $('voiceStyle') ? $('voiceStyle').value : 'podcast';
    showTypingAtNext();
    try {
      let fd = new FormData(); fd.append('text', msgText); fd.append('style', style);
      let res = await fetch('https://web-production-9a18.up.railway.app/voicegen', { method: 'POST', body: fd });
      if (!res.ok) { let err = {}; try { err = await res.json(); } catch (_) { } removeTyping(); await typeBotMessage('❌ Voice generation failed: ' + (err.error || res.statusText)); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Voice generation failed.' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return; }
      let blob = await res.blob(); let url = URL.createObjectURL(blob);
      let audioPlayer = `<audio controls src="${url}" style="width:99%;margin:8px 0 3px 0;border-radius:14px;"></audio>`;
      removeTyping();
      chats[currentChatIdx].history.push({ role: 'ai', text: `🗣️ Voice generated in *${style}* style:<br>${audioPlayer}` });
      saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
    } catch (err) { removeTyping(); await typeBotMessage('❌ Voice API/network error'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Voice API/network error' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); }
  });

  /* ---------- File / Upload handling and main chat submit ---------- */
  if (chatForm) {
    chatForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const file = uploadData; // first file if any
      const fp = filePreview;
      let msgText = (chatInput ? chatInput.value.trim() : '');

      // Ensure at least one chat exists
      if (currentChatIdx < 0 || !chats.length) {
        chats.push({ name: 'Chat 1', history: [] }); currentChatIdx = 0; saveChats();
      }
      if (!msgText && !file) return;
      if (chatInput) { chatInput.value = ''; chatInput.dispatchEvent(new Event('input')); }

      // --------- 1. /imagine handler ---------
      if (/^\/imagine\s+/i.test(msgText)) {
        const imaginePrompt = msgText.replace(/^\/imagine\s+/i, '').trim();
        const fd = new FormData(); fd.append('prompt', imaginePrompt);
        if (uploadedFiles.length && /^image\//.test(uploadedFiles[0].type)) fd.append('file', uploadedFiles[0]);
        showTypingAtNext();
        try {
          const res = await fetch('https://web-production-9a18.up.railway.app/imagine', { method: 'POST', body: fd });
          if (!res.ok) { let err = {}; try { err = await res.json(); } catch (_) { } removeTyping(); await typeBotMessage('❌ Image generation failed: ' + (err.error || res.statusText)); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Image generation failed.' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); }
          else {
            const blob = await res.blob(); const url = URL.createObjectURL(blob);
            showAIImagePreview(url, 'Your new Philadelphia AI image! (click Download if you like it)');
            removeTyping(); chats[currentChatIdx].history.push({ role: 'ai', text: '✅ Image generated! Use the floating image box below to view or download. (Not stored in chat history.)' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          }
        } catch (err) { removeTyping(); await typeBotMessage('❌ Philadelphia image API/network error'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Vision 6 image API/network error' }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); }
        // reset
        if (chatFile) chatFile.value = ''; uploadedFiles = []; uploadData = null; renderFilePreview(); return;
      }

      // ----------- 2. FILE UPLOAD LOGIC: Multiple or Single -----------
      if (uploadedFiles && uploadedFiles.length) {
        showTypingAtNext();
        try {
          const pdfs = uploadedFiles.filter(f => f.type === 'application/pdf');
          const images = uploadedFiles.filter(f => /^image\//.test(f.type));
          const audios = uploadedFiles.filter(f => /^audio\//.test(f.type));
          const videos = uploadedFiles.filter(f => /^video\//.test(f.type));

          if (pdfs.length) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : (pdfs.length > 1 ? 'Please summarize and compare these documents:' : 'Summarize this document.'));
            pdfs.forEach(f => fd.append('files', f));
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-pdf', { method: 'POST', body: fd });
            let txt = await res.text();
            let data;
            try { data = JSON.parse(txt); } catch (err) { removeTyping(); chats[currentChatIdx].history.push({ role: 'user', text: `[PDF] ${pdfs.map(f => f.name).join(', ')}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ PDF API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return; }
            removeTyping(); chats[currentChatIdx].history.push({ role: 'user', text: `[PDF] ${pdfs.map(f => f.name).join(', ')}${msgText ? ': ' + msgText : ''}` });
            if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the PDF(s).'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the PDF(s).' }); }
          }

          for (const img of images) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Describe this image in detail.'); fd.append('file', img);
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-image', { method: 'POST', body: fd });
            let txt = await res.text(); let data;
            try { data = JSON.parse(txt); } catch (err) { chats[currentChatIdx].history.push({ role: 'user', text: `[Image] ${img.name}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ Image API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); continue; }
            chats[currentChatIdx].history.push({ role: 'user', text: `[Image] ${img.name}${msgText ? ': ' + msgText : ''}` });
            if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the image.'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the image.' }); }
          }

          for (const audio of audios) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Transcribe and summarize this audio file in simple English.'); fd.append('file', audio);
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-audio', { method: 'POST', body: fd });
            let txt = await res.text(); let data;
            try { data = JSON.parse(txt); } catch (err) { chats[currentChatIdx].history.push({ role: 'user', text: `[Audio] ${audio.name}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ Audio API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); continue; }
            chats[currentChatIdx].history.push({ role: 'user', text: `[Audio] ${audio.name}${msgText ? ': ' + msgText : ''}` }); if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the audio.'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the audio.' }); }
          }

          for (const vid of videos) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Watch this video and explain what it’s about in simple English. Give a visual description and audio transcript if possible.'); fd.append('file', vid);
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-video', { method: 'POST', body: fd });
            let txt = await res.text(); let data;
            try { data = JSON.parse(txt); } catch (err) { chats[currentChatIdx].history.push({ role: 'user', text: `[Video] ${vid.name}${msgText ? ': ' + msgText : ''}` }); chats[currentChatIdx].history.push({ role: 'ai', text: `❌ Video API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` }); continue; }
            chats[currentChatIdx].history.push({ role: 'user', text: `[Video] ${vid.name}${msgText ? ': ' + msgText : ''}` }); if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('❌ Could not process the video.'); chats[currentChatIdx].history.push({ role: 'ai', text: '❌ Could not process the video.' }); }
          }

          if (chatFile) chatFile.value = '';
          uploadedFiles = []; uploadData = null; renderFilePreview(); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          return;
        } catch (err) {
          removeTyping(); chats[currentChatIdx].history.push({ role: 'ai', text: '[File upload failed] ' + (err.message || 'no net') }); if (chatFile) chatFile.value = ''; uploadedFiles = []; uploadData = null; renderFilePreview(); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); return;
        }
      }

      // ----------- 3. TEXT/COMMAND CHAT LOGIC -----------
      // push user message
      chats[currentChatIdx].history.push({ role: 'user', text: msgText });
      if (chats[currentChatIdx].history.length === 1) { chats[currentChatIdx].name = msgText.slice(0, 25) + "..."; renderChatSelector(); }
      renderChatBox(chats[currentChatIdx]?.history || []);
      showTypingAtNext();

      try {
        let res, data;
        if (/^\/image\s+/i.test(msgText)) {
          let imagePrompt = msgText.replace(/^\/image\s+/i, '');
          res = await fetch('https://web-production-9a18.up.railway.app/generate-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: imagePrompt }) // FIXED: send object with prompt
          });
          try { data = await res.json(); } catch (_) { data = {}; }
          removeTyping();
          if (data.image_b64) {
            showAIImagePreview('data:image/png;base64,' + data.image_b64, '(Your image—download or close)');
            chats[currentChatIdx].history.push({ role: 'ai', text: '✅ Image generated! (Use the floating preview box below to view or download. This image is NOT stored in chat history.)' });
          } else {
            chats[currentChatIdx].history.push({ role: 'ai', text: data.error || '❌ Image generation failed. Try another prompt.' });
          }
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
        } else {
          const history = chats[currentChatIdx].history.map(m => ({ role: m.role, content: m.text }));
          res = await fetch('https://web-production-9a18.up.railway.app/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msgText, user_id: currentUser?.uid || 'user', history }) });
          try { data = await res.json(); } catch (_) { data = {}; }
          removeTyping();
          if (data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); }
          else { await typeBotMessage('🤖 Bot replied (no response).'); chats[currentChatIdx].history.push({ role: 'ai', text: '🤖 Bot replied (no response).' }); }
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
        }
      } catch (err) { removeTyping(); await typeBotMessage('Sorry, bot error: ' + err.message); chats[currentChatIdx].history.push({ role: 'ai', text: 'Sorry, bot error: ' + err.message }); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []); }
    });
  }

  /* ---------- AI Image preview UI ---------- */
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');

  if (aiPrevClose && aiPrevBox && aiPrevImgBox) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; aiPrevImgBox.innerHTML = ''; });
  if (aiPrevDLBtn && aiPrevImgBox) aiPrevDLBtn.addEventListener('click', () => {
    const img = aiPrevImgBox.querySelector('img'); if (img) { const url = img.src; const a = document.createElement('a'); a.href = url; a.download = 'generated_image.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
  });

  function showAIImagePreview(srcUrlOrBase64, caption = '') {
    if (!aiPrevBox || !aiPrevImgBox) return;
    let src = (typeof srcUrlOrBase64 === 'string' && (srcUrlOrBase64.startsWith('data:') || srcUrlOrBase64.startsWith('blob:'))) ? srcUrlOrBase64 : 'data:image/png;base64,' + srcUrlOrBase64;
    aiPrevImgBox.innerHTML = `<img src="${src}" alt="AI gen" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;">` + (caption ? ' <div style="color:#aee;font-size:.95em;margin-top:3px;text-align:center;">' + caption + '</div>' : '');
    aiPrevBox.style.display = 'block';
  }

  // Initial small UI setup: prefill chatInput with /image photoreal
  currentModelIdx = 0;
  if (chatInput) { chatInput.value = '/image photoreal '; chatInput.focus(); try { chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); } catch (_) { } }

  // final render of sidebar list
  renderChatsListSidebar();

}); // end DOMContentLoaded
</script>
</body>
</html>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
