<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Viewer | Elvion University</title>
  <meta name="description" content="Learn with interactive courses at Elvion University">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- VARIABLES & BASE STYLES --- */
    :root {
      --dark-navy: #00001a;
      --black-bg: #000000;
      --cyan-glow: #00ffff;
      --light-blue-glow: #00aaff;
      --text-color: #e0e0e0;
      --heading-color: #ffffff;
      --gradient-start: #0a1128;
      --gradient-end: #121a30;
      --card-bg: rgba(18, 26, 48, 0.85);
      --border-glow: 0 0 10px var(--cyan-glow), 0 0 20px var(--light-blue-glow);
      --hover-glow: 0 0 15px var(--cyan-glow), 0 0 30px var(--light-blue-glow);
      --button-bg: linear-gradient(45deg, var(--cyan-glow), var(--light-blue-glow));
      --button-text-color: var(--black-bg);
      --star-color: rgba(255, 255, 255, 0.7);
      --sidebar-width: 300px;
      --success-color: #4ade80;
      --warning-color: #fbbf24;
      --error-color: #f87171;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background-color: var(--black-bg); color: var(--text-color); line-height: 1.7; overflow-x: hidden; position: relative; min-height: 100vh; }
    h1, h2, h3, h4, h5, h6 { font-family: 'Orbitron', sans-serif; color: var(--heading-color); margin-top: 0; }
    a { color: var(--cyan-glow); text-decoration: none; }

    /* --- LAYOUT --- */
    .course-viewer-container { display: flex; min-height: 100vh; position: relative; z-index: 1; }
    .course-sidebar { 
        width: var(--sidebar-width); background: var(--card-bg); backdrop-filter: blur(10px); 
        border-right: 1px solid rgba(0, 255, 255, 0.2); position: fixed; height: 100vh; 
        overflow-y: auto; z-index: 100; transition: transform 0.3s ease;
    }
    .content-area { 
        flex: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column; 
        min-height: 100vh; width: calc(100% - var(--sidebar-width)); /* Ensures fitting */
    }
    .main-content { 
        flex: 1; padding: 2rem; background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    }

    /* --- SIDEBAR COMPONENTS --- */
    .back-btn { 
        display: flex; align-items: center; gap: 0.5rem; color: var(--cyan-glow); font-weight: 600; 
        padding: 0.8rem; border-radius: 8px; transition: all 0.3s ease; margin-bottom: 1rem;
    }
    .lessons-header { 
        padding: 0 1.5rem 1rem 1.5rem; font-size: 1.1rem; color: var(--heading-color); 
        border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }
    .lesson-item { 
        display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; cursor: pointer; 
        transition: all 0.3s ease; border-left: 3px solid transparent; 
    }
    .lesson-item.active { background: rgba(0, 255, 255, 0.1); border-left-color: var(--cyan-glow); }
    .lesson-status.current { background: var(--cyan-glow); color: var(--black-bg); }

    /* --- CONTENT CARDS & TYPOGRAPHY --- */
    .content-card {
      background: var(--card-bg); border-radius: 15px; padding: 2rem;
      box-shadow: 0 0 5px rgba(0, 255, 255, 0.1); backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 255, 0.1); margin-bottom: 2rem;
    }
    .lesson-content { line-height: 1.8; font-size: 1.1rem; }
    .lesson-content h2 { color: var(--cyan-glow); margin: 2rem 0 1rem 0; font-size: 1.6rem; }
    .lesson-content h3 { color: var(--heading-color); margin: 1.5rem 0 0.8rem 0; font-size: 1.3rem; }
    .lesson-content pre {
      background: #0d1a26; padding: 1.5rem; border-radius: 8px; 
      border-left: 4px solid var(--cyan-glow); overflow-x: auto; margin: 1.5rem 0; 
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
    }
    .lesson-content pre code { background: none; padding: 0; color: #9cdcfe; display: block; font-size: 0.95rem; line-height: 1.5; }
    
    /* --- NAVIGATION & BUTTONS --- */
    .lesson-navigation {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.5rem 2rem; background: var(--card-bg); backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 255, 255, 0.1); position: sticky;
      bottom: 0; z-index: 50;
    }
    .action-btn {
      padding: 0.8rem 1.5rem; background: var(--button-bg); color: var(--button-text-color);
      border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
      font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem;
    }
    .action-btn:hover { box-shadow: var(--hover-glow); transform: scale(1.02); }
    .action-btn:disabled { 
        opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; 
        background: rgba(0, 255, 255, 0.1); border: none; color: var(--text-color); 
    }
    .action-btn.secondary { background: transparent; border: 2px solid var(--cyan-glow); color: var(--cyan-glow); }
    .action-btn.secondary:hover { background: var(--cyan-glow); color: var(--black-bg); box-shadow: var(--border-glow); }

    /* --- QUIZ/ASSIGNMENT STYLES --- */
    .quiz-container, .assignment-form-container {
        background: rgba(18, 26, 48, 0.95); /* Slightly darker for contrast */
        border-radius: 15px; padding: 2rem; margin: 2rem 0;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); /* Gold glow for assessment */
        border: 2px solid var(--warning-color);
    }
    .quiz-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5rem; border-bottom: 1px dashed rgba(255, 215, 0, 0.5); padding-bottom: 0.5rem;
    }
    .quiz-header h2 { color: var(--warning-color); font-size: 1.5rem; }
    .quiz-timer { color: var(--error-color); font-weight: 700; font-family: 'Orbitron', sans-serif; }
    .quiz-question { margin-bottom: 1.5rem; padding: 1rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px; }
    .quiz-question p { margin-bottom: 0.8rem; font-weight: 600; }
    .quiz-options label {
        display: block; padding: 0.7rem; margin-bottom: 0.5rem; cursor: pointer;
        background: rgba(255, 255, 255, 0.05); border-radius: 6px; transition: background 0.2s;
    }
    .quiz-options label:hover { background: rgba(255, 255, 255, 0.15); }
    .quiz-options input[type="radio"]:checked + span { color: var(--cyan-glow); font-weight: 600; }
    
    .quiz-feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; }
    .quiz-feedback.pass { background: rgba(74, 222, 128, 0.2); border: 1px solid var(--success-color); color: var(--success-color); }
    .quiz-feedback.fail { background: rgba(248, 113, 113, 0.2); border: 1px solid var(--error-color); color: var(--error-color); }

    /* --- CERTIFICATE FORM STYLES --- */
    .certificate-form label { display: block; margin-top: 1rem; font-weight: 600; color: var(--cyan-glow); }
    .certificate-form input[type="text"], .certificate-form input[type="email"] {
        width: 100%; padding: 0.75rem; margin-top: 0.5rem; border-radius: 6px;
        border: 1px solid rgba(0, 255, 255, 0.3); background-color: rgba(0, 0, 0, 0.4);
        color: var(--text-color); font-size: 1rem; transition: border-color 0.3s ease;
    }
    .certificate-form p.info { font-size: 0.85rem; color: var(--warning-color); margin-top: 1rem; }
    .certificate-form h2 { color: var(--success-color); text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
    
    /* --- RESPONSIVE ADJUSTMENTS --- */
    @media (max-width: 992px) {
      .course-sidebar { transform: translateX(-100%); }
      .course-sidebar.active { transform: translateX(0); }
      .content-area { margin-left: 0; width: 100%; }
      .mobile-menu-toggle { display: block; }
      .main-content { padding: 1rem; padding-top: 5rem; }
      .content-header { padding: 1rem; flex-direction: column; align-items: flex-start; }
      .content-actions { width: 100%; justify-content: stretch; }
      .action-btn { flex: 1; justify-content: center; }
      .lesson-navigation { padding: 1rem; flex-direction: column; gap: 1rem; }
      .nav-buttons { width: 100%; justify-content: stretch; }
      .nav-buttons .action-btn { flex: 1; }
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>
  <button class="mobile-menu-toggle" id="mobileMenuToggle" style="display: none;"></button>

  <div class="course-viewer-container">
    <aside class="course-sidebar" id="courseSidebar">
      <div class="course-sidebar-header">
        <a href="studyingatelvion.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        
        <div class="course-info">
          <i id="courseIconLarge" class="course-icon-large fas fa-laptop-code"></i>
          <h2 id="courseTitle" class="course-title">Loading...</h2>
          <p id="courseSubtitle" class="course-subtitle">Please wait...</p>
          
          <div class="overall-progress">
            <div class="progress-label">Overall Progress</div>
            <div class="progress-bar-container">
              <div id="overallProgressBar" class="progress-bar-fill" style="width: 0%"></div>
            </div>
            <div id="overallProgressText" class="progress-text">0% Complete</div>
          </div>
        </div>
      </div>

      <div class="lessons-list">
        <div class="lessons-header">Course Lessons</div>
        <div id="lessonsContainer">
          </div>
      </div>
    </aside>

    <main class="content-area">
      <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading course content...</p>
      </div>

      <header class="content-header" id="contentHeader" style="display: none;">
        <div class="lesson-info">
          <h1 id="lessonTitle">Lesson Title</h1>
          <div class="lesson-meta">
            <span><i class="fas fa-clock"></i> <span id="lessonDuration">45 min</span></span>
            <span><i class="fas fa-book"></i> Lesson <span id="currentLessonNumber">1</span> of <span id="totalLessons">8</span></span>
            <span><i class="fas fa-star"></i> <span id="lessonPoints">10</span> Points</span>
          </div>
        </div>
        <div class="content-actions">
          </div>
      </header>

      <section class="main-content" id="mainContent" style="display: none;">
        <div class="video-player" id="videoPlayer">
          <div class="video-placeholder">
            <i class="fas fa-play-circle"></i>
            <p>Video content coming soon</p>
            <p style="font-size: 0.9rem; opacity: 0.7;">For now, please read the lesson content below</p>
          </div>
        </div>

        <div class="content-card">
          <div id="lessonContent" class="lesson-content">
            </div>
        </div>

        <div id="assessmentContainer">
            </div>
      </section>

      <nav class="lesson-navigation" id="lessonNavigation" style="display: none;">
        <div class="nav-info">
          <div class="lesson-indicator">
            Lesson <span id="navCurrentLesson">1</span> of <span id="navTotalLessons">8</span>
          </div>
          <span><i class="fas fa-trophy"></i> <span id="totalPointsEarned">0</span> Points Earned</span>
        </div>
        <div class="nav-buttons">
          <button id="prevLessonBtn" class="action-btn secondary">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button id="nextLessonBtn" class="action-btn" disabled>
            Next Lesson
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </nav>
    </main>
  </div>

  <div id="completionModal" class="completion-modal">
    <div class="completion-content">
      <i class="fas fa-trophy completion-icon"></i>
      <h2 class="completion-title" id="modalTitle">Lesson Complete!</h2>
      <p class="completion-message" id="modalMessage">
        Congratulations! You've successfully passed the assessment and completed this lesson.
      </p>
      <div class="points-earned">
        <i class="fas fa-star"></i>
        You earned <span id="pointsEarned">10</span> points!
      </div>
      
      <div id="commentSection" class="casual-comment-section">
          <h3>Thank Elvion for the Course!</h3>
          <p style="font-size:0.9rem; color:var(--text-color); margin-bottom: 0.5rem; opacity:0.8;">Leave a casual message or feedback below (optional):</p>
          <textarea placeholder="e.g., 'Thank you for the amazing course! I learned so much about OOP.'"></textarea>
          <button class="action-btn" style="width: 100%; margin-top: 1rem;">Submit Feedback</button>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button id="continueBtn" class="action-btn" style="flex: 1;">
          Continue Learning
        </button>
        <button id="backToDashboardBtn" class="action-btn secondary" style="flex: 1;">
          Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // IMPORTANT: Replace this with your actual Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- TEMPLATE CONTENT ---
    const certificateLesson = { 
        id: 99,
        title: 'Course Completion & Final Project', 
        duration: '20 min', 
        isCertificate: true,
        content: `
            <h2>Claim Your Certificate of Participation & Submit Project</h2>
            <p>Congratulations on completing the foundational knowledge portion of this course! Elvion University awards **Certificates of Participation** to recognize your dedication to pre-degree learning. These certificates are not for academic credit but attest to your commitment.</p>
            
            <h3>Final Project Submission</h3>
            <p>To finalize your certificate and receive a project result assessment, please send your completed **Final Project** (as outlined in the previous lesson) and any supporting documentation to our labs:</p>
            <p style="font-size: 1.2rem; font-weight: 700; color: var(--success-color); margin: 1rem 0;">Email your project to: <a href="mailto:elvionailabs@gmail.com" style="color: var(--success-color);">elvionailabs@gmail.com</a></p>
            <p>Use the subject line: **[Course Name] Final Project Submission - [Your Name]**</p>
        `,
        assignmentContent: (courseId, courseTitle) => `
            <div class="assignment-form-container">
                <h2>Certificate Information Submission</h2>
                <p style="margin-bottom: 1.5rem; color: var(--text-color); opacity: 0.9;">Please fill out your details to receive your personalized Certificate of Participation via email. **This form must be submitted before emailing your project.**</p>
                <form class="certificate-form" action="https://formspree.io/f/mldrbpwo" method="post">
                    <label for="full-name"><i class="fas fa-user-circle"></i> Full Name (as it should appear on certificate)</label>
                    <input type="text" id="full-name" name="Full Name" placeholder="e.g., Jane C. Doe" required>

                    <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="email" name="Email" placeholder="jane.doe@example.com" required>
                    
                    <input type="hidden" name="Course ID" value="${courseId}">
                    <input type="hidden" name="Course Title" value="${courseTitle}">

                    <p class="info"><i class="fas fa-exclamation-triangle"></i> Note: This certificate is for personal recognition only and does not award official academic credit. You will receive it by mail upon successful submission of this form and your final project.</p>

                    <button type="submit" class="action-btn" style="width: 100%; margin-top: 2rem;">
                        <i class="fas fa-award"></i> Submit & Initiate Certificate Process
                    </button>
                </form>
            </div>
        `
    };

    const quizTemplate = (lessonNumber) => `
        <div class="quiz-container" id="quizContainer">
            <div class="quiz-header">
                <h2>Mandatory Assessment: Lesson ${lessonNumber} Mastery Check</h2>
                <div class="quiz-timer" id="quizTimer">Time Left: 05:00</div>
            </div>
            <p style="margin-bottom: 1rem; color: var(--text-color);">You must correctly answer all questions below to unlock the next lesson. This is a crucial step in ensuring your foundational knowledge is solid. **You only get one attempt!**</p>
            
            <form id="quizForm">
                <div class="quiz-question">
                    <p>1. Which of the following is an example of a primitive data type in most programming languages?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q1" value="A"> <span>A. Array</span></label>
                        <label><input type="radio" name="q1" value="B"> <span>B. Object</span></label>
                        <label><input type="radio" name="q1" value="C"> <span>C. Boolean</span></label>
                        <label><input type="radio" name="q1" value="D"> <span>D. Dictionary</span></label>
                    </div>
                </div>

                <div class="quiz-question">
                    <p>2. In General Relativity, what physical phenomenon is described as the curvature of spacetime?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q2" value="A"> <span>A. Light Speed</span></label>
                        <label><input type="radio" name="q2" value="B"> <span>B. Gravity</span></label>
                        <label><input type="radio" name="q2" value="C"> <span>C. Magnetic Field</span></label>
                        <label><input type="radio" name="q2" value="D"> <span>D. Nuclear Force</span></label>
                    </div>
                </div>

                <div class="quiz-question">
                    <p>3. What is the Git command used to record staged changes to the local repository?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q3" value="A"> <span>A. git push</span></label>
                        <label><input type="radio" name="q3" value="B"> <span>B. git add</span></label>
                        <label><input type="radio" name="q3" value="C"> <span>C. git commit</span></label>
                        <label><input type="radio" name="q3" value="D"> <span>D. git log</span></label>
                    </div>
                </div>
                
                <div class="quiz-feedback" id="quizFeedback" style="display:none;"></div>

                <button type="button" class="action-btn" id="submitQuizBtn" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-paper-plane"></i> Submit Assessment
                </button>
            </form>
        </div>
    `;

    const genericLessonContent = (courseName, lessonTitle) => `
        <h2>${courseName}: ${lessonTitle}</h2>
        <p>This section is currently under development but will contain a deep dive into the practical aspects of ${lessonTitle}. Expect detailed explanations, case studies, and code snippets or illustrative diagrams.</p>
        
        <h3>Key Concept: Placeholder</h3>
        <p>We believe in learning by doing. The content here will use industry-relevant examples to illustrate complex theories, ensuring you can immediately apply the knowledge you gain.</p>
        <pre><code>// Placeholder for a relevant code snippet or formula
function practicalExample() {
    console.log("Learning is best when it's practical!");
}
// This block will be replaced with detailed, colored code examples.</code></pre>
        
        <p>Continue to the bottom of the page to complete the **Mandatory Assessment** to unlock the next lesson and test your understanding.</p>
    `;

    // --- COURSE DATABASE ---
    const coursesDatabase = {
      'science-tech': {
        facultyName: 'Faculty of Science & Technology',
        courses: [
          {
            id: 'cs101',
            title: 'Computer Science: Fundamentals & Logic',
            description: 'Fundamentals of computing, programming, and algorithms',
            icon: 'fas fa-laptop-code',
            lessons: [
              // Lesson 1: Introduction to Programming & Data Types (Detailed)
              { 
                id: 1, 
                title: 'Introduction to Programming & Data Types', 
                duration: '45 min', 
                content: `
                  <h2>The Core of Computation: Variables and Types</h2>
                  <p>In all programming, the most fundamental concept is the **variable**—a named storage location that holds a value. Consider this as defining the raw material we use to build software logic.</p>
                  
                  <h3>Practical Example: Defining Primitive Types (Python)</h3>
                  <p>In Python, you don't explicitly declare the type, but the type is assigned dynamically. Let’s look at the four core primitive types:</p>
                  <pre><code># Integer (Whole numbers)
student_count = 358
year_of_birth = 1999

# Float (Decimal numbers)
pi_value = 3.14159265
lab_temp_celsius = 20.5

# String (Text data, always wrapped in quotes)
user_greeting = "Welcome to Elvion University!"
api_endpoint = '/api/v1/users'

# Boolean (True or False logic)
is_enrolled = True
has_passed_quiz = False</code></pre>
                  <p>Understanding these types is essential because different data types occupy different amounts of memory and support different operations. For instance, you can multiply two integers, but not an integer and a boolean.</p>
                `
              },
              // Lesson 2: Data Structures: Lists, Dictionaries, and Hashing (Detailed)
              { 
                id: 2, 
                title: 'Data Structures: Lists, Dictionaries, and Hashing', 
                duration: '60 min', 
                content: `
                  <h2>Organizing Data: Arrays vs. Dictionaries</h2>
                  <p>When you have thousands of data points, storing them in individual variables is impossible. **Data Structures** provide a blueprint for how data is related and accessed.</p>

                  <h3>1. Lists (Dynamic Arrays) - Sequential Access</h3>
                  <p>A list is a sequence of items, indexed by their position (starting at 0). It's great when order matters.</p>
                  <pre><code># Python List Example
course_modules = ["Intro", "Data Types", "OOP", "Databases"]

# Accessing by Index (Position)
first_module = course_modules[0]   # 'Intro'
last_module = course_modules[-1]  # 'Databases'</code></pre>
                  
                  <h3>2. Dictionaries (Hash Maps) - Keyed Access</h3>
                  <p>A dictionary stores data in **key-value pairs**. It's crucial for quick lookups, as the key is *hashed* to immediately find the value, making it much faster than searching a list (O(1) time complexity).</p>
                  <pre><code># Python Dictionary Example
student_record = {
    "student_id": "ELV90210",
    "name": "Alexia Vane",
    "gpa": 3.85
}

# Accessing by Key (Name, not Position)
name = student_record["name"] # 'Alexia Vane'</code></pre>
                `
              },
              // Lesson 3: Object-Oriented Programming (OOP) in Action (Detailed)
              { 
                id: 3, 
                title: 'Object-Oriented Programming (OOP) in Action', 
                duration: '55 min', 
                content: `
                  <h2>Classes, Objects, and the Power of Reusability</h2>
                  <p>OOP is a paradigm that models real-world entities into **Objects**. A **Class** is the blueprint, and an **Object** is an instance built from that blueprint.</p>

                  <h3>Blueprint to Reality: Defining a Class (Python)</h3>
                  <pre><code>class Drone:
    # The Constructor: initializes the object's properties
    def __init__(self, serial_number, max_altitude):
        self.serial_number = serial_number
        self.max_altitude = max_altitude
        self.current_altitude = 0

    # A Method (behavior)
    def ascend(self, meters):
        if self.current_altitude + meters <= self.max_altitude:
            self.current_altitude += meters
            print(f"Ascending to {self.current_altitude} meters.")
        else:
            print("Altitude limit reached.")</code></pre>

                  <h3>Creating and Interacting with Objects</h3>
                  <p>We now instantiate two separate objects from the same <code>Drone</code> class. Each object has its own unique state.</p>
                  <pre><code># Creating two independent objects (instances)
drone_alpha = Drone("ALPHA-001", 500)
drone_beta = Drone("BETA-002", 300)

# Interacting with drone_alpha
drone_alpha.ascend(150)    # Output: Ascending to 150 meters.
print(drone_alpha.current_altitude) # Output: 150</code></pre>
                  <p>This demonstrates **Encapsulation** and the independence of objects.</p>
                `
              },
              // Lesson 4: Relational Databases and SQL Mastery (Detailed)
              { 
                id: 4, 
                title: 'Relational Databases and SQL Mastery', 
                duration: '50 min', 
                content: `
                  <h2>Structured Query Language (SQL) for Data Management</h2>
                  <p>SQL is the standard language for managing relational databases, which organize data into **tables** linked by **relationships**.</p>

                  <h3>Creating a Database Schema and Foreign Keys</h3>
                  <p>We link two tables using a **Foreign Key** to define the relationship (e.g., one course has many students).</p>
                  <pre><code>-- Create the primary table for Courses
CREATE TABLE Courses (
    course_id VARCHAR(10) PRIMARY KEY,
    course_name VARCHAR(255) NOT NULL
);

-- Create the dependent table for Students
CREATE TABLE Students (
    student_id SERIAL PRIMARY KEY,
    student_name VARCHAR(100) NOT NULL,
    enrolled_course_id VARCHAR(10),
    FOREIGN KEY (enrolled_course_id) REFERENCES Courses(course_id)
);</code></pre>

                  <h3>The Power of JOIN: Retrieving Related Data</h3>
                  <p>The `JOIN` command combines columns from two or more tables based on the Foreign Key relationship. This is the core skill of a Database Administrator.</p>
                  <pre><code>SELECT 
    S.student_name, 
    C.course_name 
FROM 
    Students AS S
INNER JOIN 
    Courses AS C 
ON 
    S.enrolled_course_id = C.course_id;</code></pre>
                `
              },
              // Lesson 5: Final Project: Authentication System (Detailed)
              { 
                id: 5, 
                title: 'Final Project: Authentication System Design', 
                duration: '120 min', 
                isProject: true,
                content: `
                  <h2>Final Project: Authentication & Security System</h2>
                  <p>For your final project, you will design the core of any modern application: a secure user **Authentication System**. Your project should cover the following:</p>
                  
                  <h3>Key Security Requirements</h3>
                  <ol>
                    <li>**Database Schema:** Sketch the SQL structure for a `Users` table (ID, Username, HashedPassword, Email).</li>
                    <li>**Password Hashing:** Explain the importance of one-way hashing (e.g., using **bcrypt**) and why plaintext storage is unacceptable.</li>
                    <li>**Login Flow:** Outline the step-by-step logic from a user submitting a password to the system verifying it against the stored hash.</li>
                  </ol>
                  
                  <h3>Conceptual Hashing Example</h3>
                  <p>This conceptual code shows what NOT to store (plaintext) versus what MUST be stored (the hash). Your project should detail this process.</p>
                  <pre><code>// Conceptual Hashing (real-world uses libraries like bcrypt)
plaintext_password = "UserSecret123"
hashed_password = hash_function(plaintext_password, salt) 
// Store the hashed_password only.</code></pre>

                  <p>**Your project is to prepare a 500-word report and a database diagram outlining this system, ready to be emailed to Elvion Labs after the next step.**</p>
                `
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
          {
            id: 'swe201',
            title: 'Software Engineering: Advanced Design',
            description: 'Mastering design patterns, testing, and modern development cycles.',
            icon: 'fas fa-cogs',
            lessons: [
              { id: 1, title: 'Introduction to Agile and Scrum', duration: '40 min', content: genericLessonContent('Software Engineering', 'Agile and Scrum Methodologies') },
              { id: 2, title: 'Design Patterns: Factory and Singleton', duration: '60 min', content: genericLessonContent('Software Engineering', 'Design Patterns: Factory and Singleton') },
              { id: 3, title: 'Test-Driven Development (TDD) and CI/CD', duration: '55 min', content: genericLessonContent('Software Engineering', 'Test-Driven Development (TDD) and CI/CD') },
              { id: 4, title: 'Microservices vs. Monolithic Architecture', duration: '50 min', content: genericLessonContent('Software Engineering', 'Microservices vs. Monolithic Architecture') },
              { 
                id: 5, 
                title: 'Final Project: Architectural Design Document', 
                duration: '120 min', 
                isProject: true,
                content: `
                    <h2>Final Project: Architectural Design Document</h2>
                    <p>Your task is to prepare an Architectural Design Document (ADD) for a large-scale e-commerce application. The document should define the system's structure (Microservices or Monolithic), the technologies to be used (Database, Programming Language), and the deployment strategy (CI/CD pipeline).</p>
                    <p>This project will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>
                `
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
          {
            id: 'astro101',
            title: 'Astrophysics & Cosmography: Space & Time',
            description: 'The study of the universe, celestial bodies, and cosmic phenomena.',
            icon: 'fas fa-rocket',
            lessons: [
              // Lesson 1: The Stellar Forge: Birth, Life, and Death of Stars (Detailed)
              {
                id: 1,
                title: 'The Stellar Forge: Birth, Life, and Death of Stars',
                duration: '40 min',
                content: `
                  <h2>Nuclear Fusion: The Engine of the Universe</h2>
                  <p>Stars are colossal fusion reactors, primarily converting **hydrogen into helium** in their cores through the **Proton-Proton Chain Reaction**. This process releases energy ($E$) due to a tiny difference in mass ($\Delta m$), as described by Einstein's equation, $E = \Delta m c^2$.</p>
                  
                  <h3>The Fusion Process</h3>
                  <p>In main-sequence stars, four hydrogen nuclei combine to form one helium nucleus, a process requiring immense heat and pressure.</p>
                  <pre><code># Simplified Fusion Equation
4 \cdot \text{H} \rightarrow 1 \cdot \text{He} + \text{Energy}

# Star Death Scenarios:
# 1. Low-Mass Stars (like the Sun): White Dwarf + Planetary Nebula.
# 2. High-Mass Stars (> 8 Solar Masses): Core collapse into a **Supernova** or Black Hole.</code></pre>
                  
                  <h3>Hertzsprung-Russell Diagram</h3>
                  <p>Astronomers plot a star's luminosity against its temperature on the H-R Diagram. The majority of stars, including our Sun, spend their lives on the **Main Sequence** band.</p>
                `
              },
              // Lesson 2: The Fabric of Spacetime: General Relativity (Detailed)
              {
                id: 2,
                title: 'The Fabric of Spacetime: General Relativity',
                duration: '50 min',
                content: `
                  <h2>Gravity as a Geometric Effect</h2>
                  <p>Albert Einstein's **General Relativity (GR)** redefines gravity. Instead of a force, gravity is the **curvature of spacetime** caused by the presence of mass and energy.</p>

                  <h3>The Equivalence Principle</h3>
                  <p>GR's foundation: The effects of gravity are locally indistinguishable from the effects of uniform acceleration. A person in an accelerating rocket feels the same as a person standing on Earth.</p>

                  <h3>Observable Effects of GR</h3>
                  <ul>
                    <li>**Gravitational Lensing:** Light bends around massive objects, proving the curvature of space.</li>
                    <li>**Time Dilation:** Clocks run slightly slower near massive objects. (Essential for GPS satellites!)</li>
                    <li>**Black Holes:** Regions where curvature is so extreme that light cannot escape.</li>
                  </ul>
                `
              },
              // Lesson 3: Black Holes, Singularities, and Event Horizons (Detailed)
              {
                id: 3,
                title: 'Black Holes, Singularities, and Event Horizons',
                duration: '45 min',
                content: `
                  <h2>The Point of No Return: The Event Horizon</h2>
                  <p>A Black Hole forms when enough mass is compressed into a space small enough that its escape velocity exceeds the speed of light ($c$).</p>

                  <h3>Defining the Black Hole</h3>
                  <ul>
                    <li>**Singularity:** The center, a point of infinite density and zero volume.</li>
                    <li>**Event Horizon:** The boundary from which escape is impossible. Its radius is the **Schwarzschild Radius** ($R_S$).</li>
                  </ul>

                  <h3>The Schwarzschild Radius Formula</h3>
                  <p>The radius is directly proportional to the mass ($M$) of the object:</p>
                  $$R_S = \frac{2GM}{c^2}$$
                  <pre><code># Where: G = Gravitational Constant, c = Speed of Light
# If the Sun were a black hole, its R_S would be only about 3 km!</code></pre>
                  <p>Crossing the Event Horizon does not feel different, but it seals your fate.</p>
                `
              },
              // Lesson 4: Cosmological Models: Big Bang and Expansion (Detailed)
              {
                id: 4,
                title: 'Cosmological Models: Big Bang and Expansion',
                duration: '60 min',
                content: `
                  <h2>The Big Bang: Expansion of Space Itself</h2>
                  <p>The **Big Bang Theory** describes the universe's expansion from an initial hot, dense state, often represented by the Friedmann equations.</p>
                  
                  <h3>Key Observational Evidence</h3>
                  <ol>
                    <li>**Hubble's Law (Redshift):** Galaxies are moving away from us, and their speed is proportional to their distance ($v = H_0 \cdot d$).</li>
                    <li>**Cosmic Microwave Background (CMB):** The 'afterglow' radiation from the hot, early universe, predicted by the theory and observed everywhere.</li>
                    <li>**Abundance of Light Elements:** The theory accurately predicts the ratio of Hydrogen to Helium in the universe.</li>
                  </ol>

                  <h3>Dark Energy and the Future</h3>
                  <p>The expansion is currently **accelerating**, driven by an unknown component called **Dark Energy** (which makes up $\approx 68\%$ of the universe's total energy density). This acceleration suggests a "Big Freeze" as the ultimate fate.</p>
                `
              },
              // Lesson 5: Final Project: Exoplanet Detection Report (Detailed)
              { 
                id: 5, 
                title: 'Final Project: Exoplanet Detection Report', 
                duration: '120 min', 
                isProject: true,
                content: `
                  <h2>Final Project: Exoplanet Detection Report</h2>
                  <p>Your task is to write a detailed, 750-word report on one of the primary methods for discovering exoplanets: the **Radial Velocity Method** (Doppler Shift) or the **Transit Method** (Brightness Dimming).</p>
                  
                  <h3>Report Requirements</h3>
                  <ol>
                    <li>Explain the core physical principle (e.g., how a planet's tug affects a star's light).</li>
                    <li>Describe the instrumentation needed (e.g., high-resolution spectrometer or sensitive photometer).</li>
                    <li>Discuss the biases and limitations of the method (e.g., why is it better at finding large planets close to the star?).</li>
                  </ol>
                  
                  <p>This report will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>
                `
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
        ]
      },
      'law-arts-management': {
        facultyName: 'Other Faculties',
        courses: [
          {
            id: 'law101',
            title: 'Law (LLB): Constitutional & Legal Practice',
            description: 'Study of legal principles, constitutional law, and legal practice.',
            icon: 'fas fa-gavel',
            lessons: [
              { id: 1, title: 'Introduction to Legal Systems and Jurisprudence', duration: '40 min', content: genericLessonContent('Law (LLB)', 'Legal Systems and Jurisprudence') },
              { id: 2, title: 'Constitutional Law: Principles of Federalism', duration: '60 min', content: genericLessonContent('Law (LLB)', 'Constitutional Law') },
              { id: 3, title: 'Criminal Law: Elements of a Crime and Defenses', duration: '55 min', content: genericLessonContent('Law (LLB)', 'Criminal Law') },
              { id: 4, title: 'Contract Law: Offer, Acceptance, and Consideration', duration: '50 min', content: genericLessonContent('Law (LLB)', 'Contract Law') },
              { 
                id: 5, 
                title: 'Final Project: Case Study Analysis', 
                duration: '120 min', 
                isProject: true,
                content: `<h2>Final Project: Case Study Analysis</h2><p>Your final project is to prepare a detailed legal brief (5-7 pages) analyzing a landmark case in either Constitutional Law or Criminal Law. The brief must outline the facts, the issue, the holding, and the reasoning of the court.</p><p>This analysis will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
          {
            id: 'mass101',
            title: 'Mass Communication: Digital & Media Ethics',
            description: 'Journalism, public relations, broadcasting, and digital media communication.',
            icon: 'fas fa-broadcast-tower',
            lessons: [
              { id: 1, title: 'Theories of Mass Communication & Media Effects', duration: '40 min', content: genericLessonContent('Mass Communication', 'Media Effects') },
              { id: 2, title: 'News Writing: Inverted Pyramid & Objectivity', duration: '60 min', content: genericLessonContent('Mass Communication', 'News Writing') },
              { id: 3, title: 'Digital Public Relations & Crisis Management', duration: '55 min', content: genericLessonContent('Mass Communication', 'Public Relations') },
              { id: 4, title: 'Media Law and Ethics: Defamation and Privacy', duration: '50 min', content: genericLessonContent('Mass Communication', 'Media Ethics') },
              { 
                id: 5, 
                title: 'Final Project: Digital Media Campaign', 
                duration: '120 min', 
                isProject: true,
                content: `<h2>Final Project: Digital Media Campaign Strategy</h2><p>Your task is to design a complete digital media campaign for a hypothetical non-profit organization. The plan must include a target audience analysis, social media strategy, content creation pipeline, and a crisis communication strategy. Prepare a 10-slide presentation or a 1000-word report.</p><p>This strategy will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
        ]
      },
      'creative-arts': {
        facultyName: 'Faculty of Creative Arts',
        courses: [
          {
            id: 'visart101',
            title: 'Digital Animation & Visual Arts',
            description: 'Mastering 2D/3D animation, digital painting, and visual storytelling.',
            icon: 'fas fa-palette',
            lessons: [
              { 
                id: 1, 
                title: 'Foundations of Digital Drawing and Composition', 
                duration: '40 min', 
                content: `
                  <h2>The 12 Principles of Animation</h2>
                  <p>Digital animation is built upon a set of fundamental principles developed by Disney animators. Mastering these allows for the creation of believable, dynamic, and appealing characters and motion.</p>
                  
                  <h3>Key Principles: Squash and Stretch</h3>
                  <p>This is the most important principle. It gives a feeling of mass and weight to objects. For example, a bouncing ball should squash when it hits the ground and stretch when it's moving fast.</p>
                  <pre><code>// Conceptual Code for a Bouncing Ball Animation
// Frame 10: Ball is in freefall (Stretched)
// Frame 15: Ball hits ground (Squashed)
// Frame 20: Ball rebounds (Stretched again)</code></pre>
                  
                  <h3>Color Theory and Digital Painting</h3>
                  <p>Understanding color, harmony, and contrast is vital. We will explore the use of color palettes to evoke specific moods and guide the viewer's eye. This involves understanding the **color wheel** (Primary, Secondary, and Tertiary colors) and concepts like **Value** (lightness/darkness) and **Saturation** (intensity).</p>
                `
              },
              { id: 2, title: 'Character Design and Storyboarding', duration: '60 min', content: genericLessonContent('Digital Animation', 'Character Design') },
              { id: 3, title: 'Introduction to 3D Modeling (Mesh and Textures)', duration: '55 min', content: genericLessonContent('Digital Animation', '3D Modeling') },
              { id: 4, title: 'Rendering, Lighting, and Post-Production', duration: '50 min', content: genericLessonContent('Digital Animation', 'Rendering and Lighting') },
              { 
                id: 5, 
                title: 'Final Project: 15-Second Animated Short', 
                duration: '120 min', 
                isProject: true,
                content: `<h2>Final Project: 15-Second Animated Short</h2><p>Your final project is to create a 15-second animated short film (2D or 3D) that demonstrates at least three of the 12 principles of animation. You must provide the final video file (or link to it) and a storyboard detailing your key frames and principles used.</p><p>This short film will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
        ]
      }
    };
    
    // Calculate total lessons and re-map IDs after adding the certificate lesson
    Object.values(coursesDatabase).forEach(faculty => {
        faculty.courses.forEach(course => {
            const lastId = course.lessons.length;
            course.totalLessons = lastId; // Update totalLessons property
            course.lessons[lastId - 1].id = lastId; // Ensure the last lesson has the correct final ID
        });
    });


    let currentUser = null;
    let userData = null;
    let currentCourse = null;
    let currentLesson = 1;
    let totalLessons = 0;
    let quizInterval = null;
    const QUIZ_TIME_LIMIT = 5 * 60; // 5 minutes

    // URL Parameters
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('courseId');
    const lessonParam = urlParams.get('lesson');

    // --- UTILITY FUNCTIONS ---

    function generateStars(numStars = 100) {
      const starsContainer = document.getElementById('stars-container');
      for (let i = 0; i < numStars; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = `${1 + Math.random() * 2}px`;
        star.style.height = star.style.width;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 4}s`;
        starsContainer.appendChild(star);
      }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      generateStars();
      
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const courseSidebar = document.getElementById('courseSidebar');

      mobileMenuToggle.addEventListener('click', () => {
        courseSidebar.classList.toggle('active');
        mobileMenuToggle.innerHTML = courseSidebar.classList.contains('active') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
      });
      
      // Update the toggle button icon on load if the sidebar is visible on mobile
      if (window.innerWidth <= 992) {
          mobileMenuToggle.style.display = 'block';
          mobileMenuToggle.innerHTML = '<i class="fas fa-bars"></i>';
      }
    });

    // Auth State Management (Simplified for Demo)
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
        await initializeCourseViewer();
      } else {
        // Redirect to enrollment page if not logged in
        window.location.href = 'enroll.html';
      }
    });

    async function loadUserData() {
      // Placeholder for actual Firebase logic
      userData = {
          enrolledCourses: [{ courseId: courseId, progress: 0, currentLesson: 1, completedLessons: [] }],
          totalPoints: 0
      };
      
      try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          userData = userDoc.data();
        } else {
          window.location.href = 'studyingatelvion.html';
        }
      } catch (error) {
        // Fallback for demo mode if Firebase fails
        console.warn('Error loading user data from Firebase, using demo data:', error);
      }
    }

    async function initializeCourseViewer() {
      if (!courseId) {
        alert('No course specified');
        window.location.href = 'studyingatelvion.html';
        return;
      }

      currentCourse = findCourseById(courseId);
      if (!currentCourse) {
        alert('Course not found');
        window.location.href = 'studyingatelvion.html';
        return;
      }

      totalLessons = currentCourse.lessons.length; // Uses length of mapped lessons
      
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      
      // Get the highest accessible lesson from stored data
      const accessibleLesson = enrolledCourse?.currentLesson || 1;
      
      // Determine the lesson to load: 
      // 1. The one requested in the URL, but not exceeding the accessible limit.
      // 2. Default to the current accessible lesson if no URL param or if URL param is too high.
      let lessonToLoad = parseInt(lessonParam) || accessibleLesson;
      currentLesson = Math.min(lessonToLoad, accessibleLesson);
      currentLesson = Math.max(currentLesson, 1); // Cannot be less than 1
      
      setupCourseInterface();
      renderLessonsList();
      loadLesson(currentLesson);
      
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('contentHeader').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('lessonNavigation').style.display = 'flex';
    }

    function findCourseById(courseId) {
      for (const facultyKey in coursesDatabase) {
        const course = coursesDatabase[facultyKey].courses.find(c => c.id === courseId);
        if (course) return course;
      }
      return null;
    }

    function setupCourseInterface() {
      document.getElementById('courseIconLarge').className = `course-icon-large ${currentCourse.icon}`;
      document.getElementById('courseTitle').textContent = currentCourse.title;
      document.getElementById('courseSubtitle').textContent = currentCourse.description;
      
      // Update hidden form field for the certificate lesson
      const certificateLessonObj = currentCourse.lessons[currentCourse.lessons.length - 1];
      if (certificateLessonObj && certificateLessonObj.isCertificate) {
         certificateLessonObj.assignmentContent = certificateLesson.assignmentContent(currentCourse.id, currentCourse.title);
      }
      
      updateOverallProgress();
    }

    function updateOverallProgress() {
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const progress = enrolledCourse?.progress || 0;
      const completedLessons = enrolledCourse?.completedLessons?.length || 0;
      
      // Total lessons excluding the final certificate lesson (which is not a knowledge lesson)
      const academicLessons = totalLessons - 1;
      
      document.getElementById('overallProgressBar').style.width = `${progress}%`;
      document.getElementById('overallProgressText').textContent = `${progress}% Complete (${completedLessons}/${academicLessons} Academic Lessons)`;
      
      document.getElementById('totalPointsEarned').textContent = userData.totalPoints || 0;
    }

    function renderLessonsList() {
      const container = document.getElementById('lessonsContainer');
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const completedLessons = enrolledCourse?.completedLessons || [];
      const accessibleLesson = enrolledCourse?.currentLesson || 1;
      
      container.innerHTML = '';
      
      currentCourse.lessons.forEach((lesson, index) => {
        const lessonNumber = index + 1;
        const isCompleted = completedLessons.includes(lessonNumber);
        const isCurrent = lessonNumber === currentLesson;
        const isAccessible = lessonNumber <= accessibleLesson;
        
        const lessonItem = document.createElement('div');
        lessonItem.className = `lesson-item ${isCurrent ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
        
        let statusIcon, statusClass;
        if (isCompleted) {
          statusIcon = '<i class="fas fa-check"></i>';
          statusClass = 'completed';
        } else if (isAccessible) {
          statusIcon = lesson.isCertificate ? '<i class="fas fa-award"></i>' : lessonNumber;
          statusClass = 'current';
        } else {
          statusIcon = '<i class="fas fa-lock"></i>';
          statusClass = 'locked';
        }
        
        lessonItem.innerHTML = `
          <div class="lesson-status ${statusClass}">${statusIcon}</div>
          <div class="lesson-details">
            <div class="lesson-title">${lesson.title}</div>
            <div class="lesson-duration">${lesson.duration}</div>
          </div>
        `;
        
        if (isAccessible) {
          lessonItem.style.cursor = 'pointer';
          lessonItem.addEventListener('click', () => {
            if (lessonNumber !== currentLesson) {
              loadLesson(lessonNumber);
            }
          });
        } else {
          lessonItem.style.opacity = '0.5';
          lessonItem.style.cursor = 'not-allowed';
        }
        
        container.appendChild(lessonItem);
      });
    }

    function loadLesson(lessonNumber) {
      clearInterval(quizInterval); // Clear any running timer
      const lesson = currentCourse.lessons[lessonNumber - 1];
      if (!lesson) return;
      
      currentLesson = lessonNumber;
      
      // Update URL without reloading
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('lesson', lessonNumber);
      window.history.pushState({}, '', newUrl);
      
      // Hide mobile sidebar
      document.getElementById('courseSidebar').classList.remove('active');
      document.getElementById('mobileMenuToggle').innerHTML = '<i class="fas fa-bars"></i>';
      
      // Update header
      document.getElementById('lessonTitle').textContent = lesson.title;
      document.getElementById('lessonDuration').textContent = lesson.duration;
      document.getElementById('currentLessonNumber').textContent = lessonNumber;
      document.getElementById('totalLessons').textContent = totalLessons;
      document.getElementById('lessonPoints').textContent = lesson.isCertificate || lesson.isProject ? '0' : '10'; // 0 points for final/certificate

      
      // Update navigation
      document.getElementById('navCurrentLesson').textContent = lessonNumber;
      document.getElementById('navTotalLessons').textContent = totalLessons;
      
      // Update content
      document.getElementById('lessonContent').innerHTML = lesson.content;
      
      const assessmentContainer = document.getElementById('assessmentContainer');
      const nextBtn = document.getElementById('nextLessonBtn');
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const isCompleted = enrolledCourse?.completedLessons?.includes(lessonNumber);
      
      
      if (lesson.isCertificate) {
          // Certificate/Final Project Lesson
          assessmentContainer.innerHTML = lesson.assignmentContent;
          nextBtn.disabled = true; // No 'next' after the final step
      } else if (isCompleted) {
          // Lesson is completed: show passed message, enable next
          assessmentContainer.innerHTML = `<div class="quiz-feedback pass">Assessment Passed! You are ready for the next lesson.</div>`;
          nextBtn.disabled = currentLesson === totalLessons; // Disable if it's the last lesson (before certificate)
      } else {
          // Normal Lesson: show mandatory quiz
          assessmentContainer.innerHTML = quizTemplate(lessonNumber);
          nextBtn.disabled = true; // Must pass quiz to enable
          startQuizTimer();
          document.getElementById('submitQuizBtn').addEventListener('click', handleSubmitQuiz);
      }
      
      // Update navigation buttons (prev always works if > 1, next based on accessibility)
      const isNextAccessible = (lessonNumber + 1) <= (enrolledCourse?.currentLesson || 1);
      
      document.getElementById('prevLessonBtn').disabled = lessonNumber === 1;
      if (isCompleted) {
          // If current is completed, check if the next one is available
          nextBtn.disabled = lessonNumber === totalLessons || !isNextAccessible;
      }
      
      // Scroll to top
      window.scrollTo(0, 0);
      renderLessonsList();
    }
    
    // --- QUIZ LOGIC ---
    let timeLeft = QUIZ_TIME_LIMIT;

    function startQuizTimer() {
        timeLeft = QUIZ_TIME_LIMIT;
        const timerElement = document.getElementById('quizTimer');

        const updateTimer = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `Time Left: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 60) {
                timerElement.style.color = var(--error-color);
            }

            if (timeLeft <= 0) {
                clearInterval(quizInterval);
                timerElement.textContent = 'Time Up!';
                // Force submission on time out
                handleSubmitQuiz(true);
            }
            timeLeft--;
        };

        clearInterval(quizInterval);
        quizInterval = setInterval(updateTimer, 1000);
        updateTimer(); // Initial call to display immediately
    }

    function handleSubmitQuiz(isTimedOut = false) {
        clearInterval(quizInterval);
        const form = document.getElementById('quizForm');
        const feedback = document.getElementById('quizFeedback');
        const nextBtn = document.getElementById('nextLessonBtn');
        const submitBtn = document.getElementById('submitQuizBtn');
        
        // This is a placeholder for a true assessment engine.
        // For the sake of demonstration and structure, we check if all are answered and assume pass on first attempt.
        const answers = {
            q1: form.elements['q1']?.value, // Correct is C
            q2: form.elements['q2']?.value, // Correct is B
            q3: form.elements['q3']?.value, // Correct is C
        };
        
        const correctAnswers = { q1: 'C', q2: 'B', q3: 'C' };
        
        let score = 0;
        let totalQuestions = 0;
        
        for (const q in correctAnswers) {
            totalQuestions++;
            if (answers[q] === correctAnswers[q]) {
                score++;
            }
        }
        
        const passMark = totalQuestions; // User must get ALL correct to pass
        const isPassed = score === passMark;
        
        feedback.style.display = 'block';
        submitBtn.disabled = true; // Only one attempt

        if (isTimedOut) {
             feedback.className = 'quiz-feedback fail';
             feedback.innerHTML = `<i class="fas fa-times-circle"></i> **Time Up!** You ran out of time. Score: ${score}/${totalQuestions}. You must reload the page to restart the assessment.`;
             return;
        }

        if (isPassed) {
            feedback.className = 'quiz-feedback pass';
            feedback.innerHTML = `<i class="fas fa-check-circle"></i> **PASS!** Score: ${score}/${totalQuestions}. Mastery achieved. Click 'Next Lesson' to continue.`;
            markLessonComplete();
            nextBtn.disabled = false;
        } else {
            feedback.className = 'quiz-feedback fail';
            feedback.innerHTML = `<i class="fas fa-times-circle"></i> **FAIL!** Score: ${score}/${totalQuestions}. You must get all answers correct. Please refresh the page and study the content again before re-attempting.`;
        }
    }
    
    // --- EVENT LISTENERS ---
    document.getElementById('prevLessonBtn').addEventListener('click', () => {
      if (currentLesson > 1) {
        loadLesson(currentLesson - 1);
      }
    });

    document.getElementById('nextLessonBtn').addEventListener('click', () => {
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const isNextAccessible = (currentLesson + 1) <= (enrolledCourse?.currentLesson || 1);
      
      if (currentLesson < totalLessons && isNextAccessible) {
        loadLesson(currentLesson + 1);
      }
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
      document.getElementById('completionModal').style.display = 'none';
      if (currentLesson < totalLessons) {
        loadLesson(currentLesson + 1);
      } else {
          // If the last lesson (Certificate) is reached, redirect to dashboard.
          window.location.href = 'studyingatelvion.html';
      }
    });

    // Redirect fix
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
      window.location.href = 'studyingatelvion.html';
    });
    
    // --- FIREBASE UPDATE LOGIC ---
    async function markLessonComplete() {
      try {
        const enrolledCourseIndex = userData.enrolledCourses.findIndex(c => c.courseId === courseId);
        if (enrolledCourseIndex === -1) return;
        
        const enrolledCourse = userData.enrolledCourses[enrolledCourseIndex];
        const currentLessonObj = currentCourse.lessons[currentLesson - 1];
        
        const pointsToAward = currentLessonObj.isCertificate || currentLessonObj.isProject ? 0 : 10;
        
        // Add to completed lessons if not already completed
        if (!enrolledCourse.completedLessons?.includes(currentLesson)) {
          if (!enrolledCourse.completedLessons) {
            enrolledCourse.completedLessons = [];
          }
          enrolledCourse.completedLessons.push(currentLesson);
          
          // Update current lesson access
          enrolledCourse.currentLesson = Math.max(enrolledCourse.currentLesson || 1, currentLesson + 1);
          
          // Calculate progress (excluding the final certificate lesson)
          const academicLessons = totalLessons - 1;
          const completedAcademicCount = enrolledCourse.completedLessons.filter(id => id < totalLessons).length;
          enrolledCourse.progress = Math.round((completedAcademicCount / academicLessons) * 100);
          
          // Update user data
          userData.enrolledCourses[enrolledCourseIndex] = enrolledCourse;
          userData.completedLessons = (userData.completedLessons || 0) + 1;
          userData.totalPoints = (userData.totalPoints || 0) + pointsToAward;
          
          // Save to database
          await updateDoc(doc(db, 'users', currentUser.uid), {
            enrolledCourses: userData.enrolledCourses,
            completedLessons: userData.completedLessons,
            totalPoints: userData.totalPoints
          });
          
          // Update UI
          updateOverallProgress();
          renderLessonsList();
          
          // Show completion modal
          document.getElementById('pointsEarned').textContent = pointsToAward;
          document.getElementById('modalTitle').textContent = currentLessonObj.isProject ? 'Pre-Project Complete!' : 'Lesson Complete!';
          document.getElementById('modalMessage').textContent = currentLessonObj.isProject ? `You are now ready to begin your Final Project and claim your Certificate.` : `Congratulations! You've successfully passed the assessment and completed this lesson.`;
          
          document.getElementById('completionModal').style.display = 'flex';
          
          // Update modal button text for the last non-certificate lesson
          if (currentLesson === totalLessons - 1) {
              document.getElementById('continueBtn').textContent = 'Go to Certificate';
          } else {
              document.getElementById('continueBtn').textContent = 'Continue Learning';
          }
        }
      } catch (error) {
        console.error('Error marking lesson complete:', error);
        // alert('Error updating progress. Please try again.');
        // In a real environment, you'd handle this more gracefully.
      }
    }
  </script>
</body>
  </html>
