<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Developer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #00ffff; --secondary: #ff00ff; --bg-dark: #050a14;
      --text-main: #ffffff; --success: #00e676; --danger: #ff1744; --warning: #ffae42;
    }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; }
    
    /* Layout */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand h1 { font-family: 'Orbitron'; color: var(--primary); margin: 0; font-size: 1.5rem; }
    
    /* Cards */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: rgba(20, 25, 40, 0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 25px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--primary); margin: 0; }

    /* Inputs - FIXED VISIBILITY */
    input { 
      background: #ffffff !important; 
      color: #000000 !important; 
      border: 2px solid #ccc; 
      padding: 12px; 
      border-radius: 6px; 
      width: 100%; 
      font-size: 1rem; 
      font-weight: 600;
      margin-top: 5px;
    }
    input:focus { border-color: var(--primary); }
    label { font-size: 0.85rem; color: #ccc; margin-bottom: 5px; display: block; }

    /* Buttons */
    .btn { background: var(--primary); color: #000; border: none; padding: 12px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-secondary { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    .btn-secondary:hover { background: rgba(0, 255, 255, 0.1); }
    .btn-danger { background: rgba(255, 23, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); width: auto; padding: 5px 10px; font-size: 0.8rem; }

    /* Tables */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px; color: #888; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
    
    .cost-pos { color: var(--success); font-weight: bold; }
    .cost-neg { color: var(--danger); font-weight: bold; }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; display: none; align-items: center; justify-content: center; }
    .modal { background: #1a1f2e; border: 1px solid var(--primary); padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; position: relative; }
    .close-modal { position: absolute; top: 10px; right: 10px; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

    /* Toast */
    #toast-box { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    .toast { background: #222; border-left: 4px solid var(--primary); color: white; padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); min-width: 250px; }
    
    .loader { display:inline-block; width:15px; height:15px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; display:none;}
    .loading .loader { display:inline-block; }
    .loading span { display:none; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="toast-box"></div>

<div class="container">
  <header>
    <div class="brand">
      <h1>Elvion AI Console</h1>
    </div>
    <div style="display:flex; gap:15px; align-items:center;">
      <span id="user-email" style="color:#aaa; font-size:0.9rem;">...</span>
      <button onclick="logout()" style="background:none; border:1px solid #ff1744; color:#ff1744; padding:5px 10px; border-radius:4px; cursor:pointer;">Logout</button>
    </div>
  </header>

  <div class="dashboard-grid">
    <!-- Wallet -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Wallet Balance</h3>
        <button onclick="loadData()" class="btn-secondary" style="width:auto; padding:5px 10px;"><i class="fas fa-sync"></i></button>
      </div>
      <div style="text-align:center; padding:10px 0;">
        <div style="font-size:3rem; font-family:'Orbitron'; font-weight:bold;" id="balance">---</div>
        <div style="color:#888;">Credits</div>
      </div>
      <button class="btn" onclick="openModal('payment-modal')"><i class="fas fa-wallet"></i> Fund Wallet</button>
      
      <!-- Manual Check Button -->
      <div id="pending-box" style="display:none; margin-top:15px; padding-top:10px; border-top:1px solid #333; text-align:center;">
        <p style="color:var(--warning); font-size:0.8rem; margin:0 0 5px 0;">Transaction Pending?</p>
        <button class="btn-secondary" onclick="manualCheck()" style="font-size:0.8rem; padding:8px;">Check Payment Status</button>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="card-header"><h3 class="card-title">Quick Actions</h3></div>
      <div style="display:grid; gap:10px;">
        <button class="btn btn-secondary" onclick="openModal('transfer-modal')">Transfer Credits</button>
        <button class="btn btn-secondary" id="gen-key-btn" onclick="generateKey()"><span>Generate API Key</span><div class="loader"></div></button>
      </div>
      <p style="text-align:center; color:#666; font-size:0.8rem; margin-top:15px;">Key Cost: 100 Credits</p>
    </div>
  </div>

  <!-- Activity -->
  <div class="card">
    <div class="card-header"><h3 class="card-title">Activity History</h3></div>
    <div class="table-container">
      <table>
        <thead><tr><th>Action</th><th>Amount</th><th>Time</th></tr></thead>
        <tbody id="history-list"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
  
  <!-- Keys -->
  <div class="card" style="margin-top:20px;">
    <div class="card-header"><h3 class="card-title">Active API Keys</h3></div>
    <div class="table-container">
      <table>
        <thead><tr><th>Key</th><th>Created</th><th>Action</th></tr></thead>
        <tbody id="key-list"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
  
  <!-- Admin -->
  <div class="card" id="admin-panel" style="margin-top:20px; display:none; border-color:var(--warning);">
    <div class="card-header"><h3 class="card-title" style="color:var(--warning)">Admin</h3></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div>
            <label>Grant Self</label>
            <button class="btn" onclick="adminGrantSelf()">Set 100k</button>
        </div>
        <div>
            <label>Gift User</label>
            <input type="email" id="gift-email" placeholder="User Email">
            <input type="number" id="gift-amount" placeholder="Amount">
            <button class="btn btn-secondary" onclick="adminGift()" style="margin-top:10px;">Send</button>
        </div>
    </div>
  </div>

</div>

<!-- Payment Modal -->
<div id="payment-modal" class="modal-overlay">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('payment-modal')">&times;</button>
    <h3 style="text-align:center; margin-top:0;">Fund Wallet</h3>
    <label>Amount (NGN)</label>
    <input type="number" id="pay-amount" value="1000" style="font-size:1.5rem; text-align:center;">
    <button class="btn" id="pay-btn" onclick="initiatePayment()" style="margin-top:20px;">
        <span>Proceed to Pay</span><div class="loader"></div>
    </button>
  </div>
</div>

<!-- Transfer Modal -->
<div id="transfer-modal" class="modal-overlay">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('transfer-modal')">&times;</button>
    <h3 style="text-align:center; margin-top:0;">Transfer Credits</h3>
    <label>Receiver Email</label>
    <input type="email" id="trans-email" placeholder="email@example.com">
    <label style="margin-top:10px;">Amount</label>
    <input type="number" id="trans-amount" placeholder="500">
    <button class="btn" id="trans-btn" onclick="transferCredits()" style="margin-top:20px;">
        <span>Transfer</span><div class="loader"></div>
    </button>
  </div>
</div>

<!-- Key Modal -->
<div id="key-modal" class="modal-overlay">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('key-modal')">&times;</button>
    <h3 style="color:var(--success); text-align:center;">Success</h3>
    <p style="text-align:center; color:#ccc;">Copy your key now:</p>
    <div id="new-key" style="background:black; color:white; padding:15px; word-break:break-all; border-radius:5px; font-family:monospace;"></div>
  </div>
</div>

<script type="module">
  const API_URL = "https://web-production-9a18.up.railway.app";
  const ADMIN_EMAIL = "koladhino@gmail.com";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  });

  const auth = getAuth(app);
  let token = null;

  window.logout = () => signOut(auth);
  window.openModal = (id) => document.getElementById(id).style.display = 'flex';
  window.closeModal = (id) => document.getElementById(id).style.display = 'none';

  onIdTokenChanged(auth, async (user) => {
    if (user) {
      token = await user.getIdToken(true);
      document.getElementById('user-email').innerText = user.email;
      if(user.email.toLowerCase() === ADMIN_EMAIL) document.getElementById('admin-panel').style.display = 'block';
      
      loadData();
      
      // Check for return from Payment
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('reference') || params.get('trxref');
      if(ref) {
          verifyPaymentLoop(ref);
          // Remove query params to clean URL
          window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Check local storage for pending
      if(localStorage.getItem('pending_ref')) document.getElementById('pending-box').style.display = 'block';

    } else {
      window.location.href = 'developer-login.html';
    }
  });

  async function req(endpoint, method='GET', body=null) {
    try {
        const opts = { method, headers: { 'Content-Type': 'application/json', 'X-Firebase-Token': token } };
        if(body) opts.body = JSON.stringify(body);
        const res = await fetch(`${API_URL}${endpoint}`, opts);
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || 'Error');
        return data;
    } catch(e) {
        toast(e.message, 'error');
        throw e;
    }
  }

  window.loadData = async () => {
    try {
        const d = await req('/api/user/keys-and-balance');
        document.getElementById('balance').innerText = d.balance.toLocaleString();
        
        // Keys
        const kList = document.getElementById('key-list');
        kList.innerHTML = d.keys.map(k => `<tr><td style="font-family:monospace">...${k.api_key.slice(-6)}</td><td>${k.created_at.split('T')[0]}</td><td>${k.is_active ? `<button class="btn-danger" onclick="revoke('${k.api_key}')">Revoke</button>` : 'Revoked'}</td></tr>`).join('') || '<tr><td colspan="3">No keys</td></tr>';

        // History
        const h = await req('/api/user/usage-history');
        const hList = document.getElementById('history-list');
        hList.innerHTML = h.logs.map(l => {
            const isPos = l.type === 'funding' || l.type === 'gift';
            return `<tr><td>${l.endpoint}</td><td class="${isPos ? 'cost-pos' : 'cost-neg'}">${isPos?'+':'-'} ${l.cost}</td><td>${new Date(l.timestamp).toLocaleString()}</td></tr>`;
        }).join('') || '<tr><td colspan="3">No history</td></tr>';
        
    } catch(e) {}
  };

  // --- PAYMENT LOGIC ---
  window.initiatePayment = async () => {
    const btn = document.getElementById('pay-btn');
    btn.classList.add('loading');
    const amt = document.getElementById('pay-amount').value;
    try {
        const res = await req('/api/payments/initiate', 'POST', { amount: parseInt(amt) });
        // Save ref locally to track it
        localStorage.setItem('pending_ref', res.transaction_ref);
        window.location.href = res.checkout_url;
    } catch(e) { btn.classList.remove('loading'); }
  };

  async function verifyPaymentLoop(ref) {
    toast('Verifying payment... Please wait.', 'warning');
    localStorage.setItem('pending_ref', ref); // Ensure it's saved
    document.getElementById('pending-box').style.display = 'block';

    // Retry logic: 5 times, 3 seconds apart
    for(let i=0; i<5; i++) {
        try {
            const res = await req(`/api/payments/verify?transaction_ref=${ref}`);
            if(res.status === 'success') {
                toast(`Success! +${res.credits_added} Credits`, 'success');
                localStorage.removeItem('pending_ref');
                document.getElementById('pending-box').style.display = 'none';
                loadData();
                return;
            } else if (res.status === 'failed') {
                toast('Payment Failed.', 'error');
                localStorage.removeItem('pending_ref');
                document.getElementById('pending-box').style.display = 'none';
                return;
            }
        } catch(e) {}
        await new Promise(r => setTimeout(r, 3000));
    }
    toast('Still verifying. Click "Check Payment Status" manually.', 'warning');
  }

  window.manualCheck = () => {
      const ref = localStorage.getItem('pending_ref');
      if(ref) verifyPaymentLoop(ref);
      else toast('No pending transaction found.', 'error');
  };

  // --- OTHER ACTIONS ---
  window.generateKey = async () => {
      const btn = document.getElementById('gen-key-btn');
      btn.classList.add('loading');
      try {
          const res = await req('/api/user/create-api-key', 'POST');
          document.getElementById('new-key').innerText = res.api_key;
          openModal('key-modal');
          loadData();
      } catch(e) {} finally { btn.classList.remove('loading'); }
  };

  window.transferCredits = async () => {
      const btn = document.getElementById('trans-btn');
      btn.classList.add('loading');
      try {
          const email = document.getElementById('trans-email').value;
          const amt = document.getElementById('trans-amount').value;
          const res = await req('/api/user/transfer-credits', 'POST', { receiver_email: email, amount: parseInt(amt) });
          toast(res.message, 'success');
          closeModal('transfer-modal');
          loadData();
      } catch(e) {} finally { btn.classList.remove('loading'); }
  };

  window.revoke = async (key) => {
      if(!confirm('Revoke key?')) return;
      try { await req('/api/user/revoke-api-key', 'POST', { api_key: key }); loadData(); } catch(e){}
  };

  window.adminGrantSelf = async () => { try { await req('/api/admin/grant-credits', 'POST'); loadData(); toast('Granted', 'success'); } catch(e){} };
  window.adminGift = async () => { 
      try { 
          await req('/api/admin/gift-credits', 'POST', { 
              target_email: document.getElementById('gift-email').value, 
              amount: parseInt(document.getElementById('gift-amount').value) 
          }); 
          toast('Gifted', 'success'); 
      } catch(e){} 
  };

  function toast(msg, type) {
      const d = document.createElement('div');
      d.className = 'toast';
      d.style.borderColor = type === 'success' ? '#00e676' : (type==='warning' ? '#ffae42' : '#ff1744');
      d.innerText = msg;
      document.getElementById('toast-box').appendChild(d);
      setTimeout(() => d.remove(), 4000);
  }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
