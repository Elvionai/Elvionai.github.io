<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial English Assessment | Mr. Kola</title>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-glow: #00e5ff;
            --secondary-glow: #ff00e0;
            --background-deep-space: #0b0c14;
            --text-color-nebula: #e0e0e0;
            --container-bg: rgba(20, 22, 37, 0.85);
            --border-color: rgba(0, 229, 255, 0.3);
            --font-heading: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--background-deep-space);
            color: var(--text-color-nebula);
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #starfield {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background: var(--background-deep-space) url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle fill="%23fff" cx="10" cy="10" r="0.5"/><circle fill="%23fff" cx="80" cy="20" r="0.3"/><circle fill="%23fff" cx="30" cy="70" r="0.4"/><circle fill="%23fff" cx="50" cy="50" r="0.2"/><circle fill="%23fff" cx="90" cy="90" r="0.1"/></svg>');
            animation: twinkle 20s linear infinite alternate;
        }
        @keyframes twinkle { 
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .assessment-container {
            width: 100%;
            max-width: 900px;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(12px);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.2);
            animation: border-pulse 4s infinite alternate;
            max-height: 95vh;
            overflow-y: auto;
        }
        @keyframes border-pulse {
            from { box-shadow: 0 0 20px rgba(0, 229, 255, 0.15); }
            to { box-shadow: 0 0 40px rgba(0, 229, 255, 0.35); }
        }


        header {
            text-align: center;
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-family: var(--font-heading);
            margin: 0;
            font-size: 2.2rem;
            color: var(--primary-glow);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        main { padding: 2rem; }

        button {
            font-family: var(--font-heading);
            font-size: 1rem;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid var(--primary-glow);
            background: transparent;
            color: var(--primary-glow);
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) {
            background: var(--primary-glow);
            color: var(--background-deep-space);
            box-shadow: 0 0 15px var(--primary-glow);
        }
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        #timer-container {
            font-family: var(--font-heading);
            text-align: right; font-size: 1.2rem;
            color: var(--primary-glow); margin-bottom: 1rem;
        }

        .mcq-container { min-height: 280px; }
        .mcq-question-wrapper { animation: fadeIn 0.7s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Radio Buttons */
        .mcq-option {
            margin: 1rem 0;
            line-height: 1.7;
            display: block;
        }
        .mcq-option label {
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: color 0.3s ease;
        }
        .mcq-option input[type="radio"] { display: none; }
        .mcq-option label::before {
            content: '';
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 15px;
            border-radius: 50%;
            border: 2px solid var(--primary-glow);
            transition: all 0.3s ease;
        }
        .mcq-option input[type="radio"]:checked + label::before {
            background-color: var(--primary-glow);
            box-shadow: 0 0 10px var(--primary-glow);
        }
        .mcq-option input[type="radio"]:checked + label {
            color: var(--primary-glow);
        }


        .modal-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--container-bg);
            padding: 2.5rem; border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center; max-width: 90%; width: 500px;
        }

        .hidden { display: none; }
        
        /* Quill Editor Styling */
        .ql-toolbar.ql-snow, .ql-container.ql-snow { border-color: var(--border-color); }
        .ql-editor { color: var(--text-color-nebula); font-family: 'Times New Roman', serif; font-size: 16px; height: 300px; }
        .ql-snow .ql-stroke { stroke: var(--primary-glow); }
        .ql-snow .ql-picker-label { color: var(--text-color-nebula) !important; }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body { padding: 0.5rem; align-items: flex-start; }
            .assessment-container { border-radius: 0; max-height: 100vh; }
            main { padding: 1.5rem; }
            header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div id="starfield"></div>

    <div id="instructions-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="font-family: var(--font-heading); color: var(--primary-glow);">Assessment Protocol</h2>
            <p>Welcome. You have 45 minutes to complete this assessment. It is divided into two sections. Do not leave this page, or your session will be terminated.</p>
            <button id="agree-btn">Begin Assessment</button>
        </div>
    </div>
    
    <div class="assessment-container">
        <header><h1>English Language Assessment</h1><p>Instructor: Mr. Kola</p></header>
        <main>
            <div id="student-selection">
                <h2 style="font-family: var(--font-heading); text-align: center;">Identify Yourself</h2>
                <div style="text-align: center;">
                    <button class="student-btn" data-student="El Rohi">El Rohi</button>
                    <button class="student-btn" data-student="Kingspraise">Kingspraise</button>
                </div>
            </div>
            
            <div id="assessment-content" class="hidden">
                <div id="timer-container">Time Remaining: <span id="time">45:00</span></div>

                <div id="mcq-part">
                    <h3 id="mcq-progress" style="font-family: var(--font-heading); text-align: center;">Question 1 / 15</h3>
                    <div id="mcq-container"></div>
                    <div style="text-align: right; margin-top: 1rem;">
                        <button id="next-question-btn" disabled>Next</button>
                    </div>
                </div>

                <div id="results-part" class="hidden" style="text-align: center;">
                    <h2 style="font-family: var(--font-heading); color: var(--primary-glow);">Objective Section Complete</h2>
                    <p id="results-text">Calculating your score...</p>
                    <h1 id="score-display" style="font-size: 4rem; color: var(--primary-glow); margin: 1rem 0;"></h1>
                </div>

                <form id="essay-form" class="hidden" method="POST" action="https://formspree.io/f/mldrbpwo">
                    <h2 style="font-family: var(--font-heading);">Section B: Writing Task</h2>
                    <p id="essay-prompt-text"></p>
                    
                    <input type="hidden" id="student-name-hidden" name="student_name">
                    <textarea id="essay-content-hidden" name="writing_content_plain_text" class="hidden"></textarea>
                    
                    <div id="writing-editor-container"></div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; flex-wrap: wrap; gap: 10px;">
                        <span>Word Count: <span id="word-count">0</span></span>
                        <button type="button" id="analyze-btn">Analyze Writing</button>
                    </div>
                    <div id="ai-suggestions-box" class="hidden" style="margin-top: 1rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 5px;"></div>
                    
                    <div style="text-align: right; margin-top: 2rem;">
                        <button type="submit" id="submit-essay-btn" disabled>Submit Final Essay</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // --- DATA & STATE MANAGEMENT ---
        let currentStudent = '';
        let currentQuestionIndex = 0;
        let studentAnswers = [];
        let score = 0;
        let pageLocked = false;
        let minWords = 150;
        const formspreeEndpoint = 'https://formspree.io/f/mldrbpwo';
        const aiEndpoint = 'https://web-production-9a18.up.railway.app/api/llama/chat';

        // --- DOM ELEMENTS ---
        const agreeBtn = document.getElementById('agree-btn');
        const instructionsModal = document.getElementById('instructions-modal');
        const studentSelection = document.getElementById('student-selection');
        const assessmentContent = document.getElementById('assessment-content');
        const mcqPart = document.getElementById('mcq-part');
        const mcqContainer = document.getElementById('mcq-container');
        const nextBtn = document.getElementById('next-question-btn');
        const mcqProgress = document.getElementById('mcq-progress');
        const resultsPart = document.getElementById('results-part');
        const resultsText = document.getElementById('results-text');
        const scoreDisplay = document.getElementById('score-display');
        const essayForm = document.getElementById('essay-form');
        const studentNameHidden = document.getElementById('student-name-hidden');
        const essayContentHidden = document.getElementById('essay-content-hidden');
        const submitEssayBtn = document.getElementById('submit-essay-btn');
        const wordCountDisplay = document.getElementById('word-count');
        const analyzeBtn = document.getElementById('analyze-btn');
        const suggestionsBox = document.getElementById('ai-suggestions-box');

        // --- QUILL EDITOR SETUP ---
        const quill = new Quill('#writing-editor-container', {
            theme: 'snow',
            modules: { toolbar: [['bold', 'italic'], [{ 'font': [] }]] }
        });

        // --- EVENT LISTENERS ---
        agreeBtn.addEventListener('click', () => instructionsModal.style.display = 'none');

        document.querySelectorAll('.student-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                currentStudent = e.target.dataset.student;
                studentNameHidden.value = currentStudent;
                transitionView(studentSelection, assessmentContent);
                startTimer(2700);
                document.addEventListener('visibilitychange', handleVisibilityChange);
                displayQuestion();
            });
        });

        nextBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="mcq"]:checked');
            if (!selected) return;
            studentAnswers.push(selected.value);
            currentQuestionIndex++;
            const questions = getQuestionsForStudent(currentStudent);
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
            } else {
                gradeAndSubmitMCQs();
            }
        });

        quill.on('text-change', () => {
            const text = quill.getText();
            const words = text.trim().split(/\s+/).filter(Boolean);
            wordCountDisplay.textContent = words.length;
            submitEssayBtn.disabled = words.length < minWords;
        });

        essayForm.addEventListener('submit', (e) => {
            e.preventDefault();
            essayContentHidden.value = quill.getText(); // GUARANTEED PLAIN TEXT
            e.target.submit();
        });

        analyzeBtn.addEventListener('click', async () => {
            const text = quill.getText();
            if (!text.trim()) {
                suggestionsBox.innerHTML = 'Please write something to analyze.';
                suggestionsBox.classList.remove('hidden');
                return;
            }
            suggestionsBox.innerHTML = 'Analyzing your text...';
            suggestionsBox.classList.remove('hidden');
            analyzeBtn.disabled = true;

            try {
                const response = await fetch(aiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: text,
                        systemPrompt: "You are an AI writing assistant. Check the text for spelling and grammar errors. Provide suggestions for improvement but do not rewrite it. Start with 'Analysis:'"
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    suggestionsBox.innerHTML = data.content.replace(/\n/g, '<br>');
                } else {
                    suggestionsBox.innerHTML = 'Error: Could not analyze text.';
                }
            } catch (error) {
                suggestionsBox.innerHTML = 'Error: Could not connect to the AI assistant.';
            } finally {
                analyzeBtn.disabled = false;
            }
        });

        // --- CORE LOGIC ---
        function transitionView(hideElement, showElement) {
            hideElement.style.transition = 'opacity 0.5s ease';
            hideElement.style.opacity = '0';
            setTimeout(() => {
                hideElement.classList.add('hidden');
                showElement.classList.remove('hidden');
                showElement.style.opacity = '0';
                setTimeout(() => { showElement.style.transition = 'opacity 0.5s ease'; showElement.style.opacity = '1'; }, 50);
            }, 500);
        }

        function displayQuestion() {
            const questions = getQuestionsForStudent(currentStudent);
            const question = questions[currentQuestionIndex];
            mcqContainer.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'mcq-question-wrapper';
            
            let optionsHTML = '';
            question.options.forEach((opt, index) => {
                const optionId = `q${currentQuestionIndex}_opt${index}`;
                optionsHTML += `<div class="mcq-option">
                                  <input type="radio" id="${optionId}" name="mcq" value="${opt}">
                                  <label for="${optionId}">${opt}</label>
                                </div>`;
            });

            wrapper.innerHTML = `<p style="font-size: 1.1rem;">${question.question}</p>${optionsHTML}`;
            mcqContainer.appendChild(wrapper);
            mcqProgress.textContent = `Question ${currentQuestionIndex + 1} / ${questions.length}`;
            nextBtn.disabled = true;

            mcqContainer.querySelectorAll('input[name="mcq"]').forEach(radio => {
                radio.addEventListener('change', () => nextBtn.disabled = false);
            });
        }

        async function gradeAndSubmitMCQs() {
            transitionView(mcqPart, resultsPart);
            const questions = getQuestionsForStudent(currentStudent);
            questions.forEach((q, index) => {
                if (q.answer === studentAnswers[index]) score++;
            });

            const formData = new FormData();
            formData.append('student_name', currentStudent);
            formData.append('assessment_part', 'Multiple Choice Questions');
            formData.append('score', `${score} out of ${questions.length}`);
            studentAnswers.forEach((ans, i) => formData.append(`question_${i+1}_answer`, ans));
            
            try {
                await fetch(formspreeEndpoint, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                });
                resultsText.textContent = 'Your results have been submitted. Prepare for the writing section.';
            } catch (error) {
                resultsText.textContent = 'Could not submit your results. Please proceed to the writing section.';
            }
            scoreDisplay.textContent = `${score} / ${questions.length}`;

            setTimeout(() => {
                setupEssaySection();
                transitionView(resultsPart, essayForm);
            }, 4000);
        }

        function setupEssaySection() {
            const prompts = {
                'El Rohi': 'You are proposing the motion: "Technology in the classroom is more of a distraction than a tool." Write a formal debate speech of at least 150 words, including a proper greeting, introduction, and at least two strong points.',
                'Kingspraise': 'Your best friend moved to another country a year ago. Write an informal letter of at least 150 words. In the letter, ask how they are doing, share a detailed story about a recent, exciting event in your life, and express how much you miss them.'
            };
            document.getElementById('essay-prompt-text').textContent = prompts[currentStudent];
        }

        // --- UTILITY & SECURITY ---
        function startTimer(duration) {
            let timer = duration;
            const timeDisplay = document.getElementById('time');
            const interval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timeDisplay.textContent = minutes + ":" + seconds;
                if (--timer < 0) {
                    clearInterval(interval);
                    timeDisplay.textContent = "Time Expired!";
                    essayForm.submit();
                }
            }, 1000);
        }

        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden' && !pageLocked) {
                pageLocked = true;
                document.body.innerHTML = `<div style="text-align: center; padding: 15% 1rem;">
                                               <h1 style="font-family: var(--font-heading); color: var(--secondary-glow);">ACCESS REVOKED</h1>
                                               <p>Session terminated due to leaving the assessment page.</p>
                                           </div>`;
            }
        }

        // --- QUESTION DATABASE ---
        function getQuestionsForStudent(student) {
            const elRohiQs = [
                { question: "1. The primary purpose of a debate is to:", options: ["Entertain the audience with stories", "Persuade judges and an audience of a viewpoint", "Have a casual discussion with friends"], answer: "Persuade judges and an audience of a viewpoint" },
                { question: "2. The formal topic of a debate is known as the:", options: ["Motion", "Argument", "Rebuttal"], answer: "Motion" },
                { question: "3. Addressing the 'Mr. Chairman, Panel of Judges...' is called the:", options: ["Introduction", "Vocative", "Conclusion"], answer: "Vocative" },
                { question: "4. A 'Rebuttal' is when you:", options: ["Summarize your main points", "Explain why the opposing side's argument is incorrect", "Politely thank the audience"], answer: "Explain why the opposing side's argument is incorrect" },
                { question: "5. One key tip for a debate from the text is to be:", options: ["Quiet and reserved", "Persuasive and confident", "Funny and informal"], answer: "Persuasive and confident" },
                { question: "6. Which phrase is a persuasive transition word used in the body of a debate?", options: ["By the way", "I guess", "Furthermore"], answer: "Furthermore" },
                { question: "7. The final part of a debate speech should always be:", options: ["A question to the audience", "A polite 'Thank you'", "A summary of the opponent's points"], answer: "A polite 'Thank you'" },
                { question: "8. An informal letter's tone is best described as:", options: ["Strict and professional", "Relaxed and conversational", "Sad and emotional"], answer: "Relaxed and conversational" },
                { question: "9. Where is the writer's address placed in an informal letter?", options: ["Top left-hand corner", "Top right-hand corner", "Bottom of the page"], answer: "Top right-hand corner" },
                { question: "10. 'Dear Sammy,' is an example of a:", options: ["Subscription", "Salutation", "Motion"], answer: "Salutation" },
                { question: "11. Exchanging pleasantries, like asking about someone's health, belongs in the:", options: ["Introduction", "Body", "Conclusion"], answer: "Introduction" },
                { question: "12. The main message and details of an informal letter are found in the:", options: ["Salutation", "Body", "Subscription"], answer: "Body" },
                { question: "13. Using contractions like 'I'm' and 'can't' is:", options: ["Discouraged in informal letters", "Encouraged to make it sound natural", "Only for formal writing"], answer: "Encouraged to make it sound natural" },
                { question: "14. A closing like 'Yours sincerely,' is known as the:", options: ["Subscription", "Address", "Salutation"], answer: "Subscription" },
                { question: "15. The example letter about moving to secondary school primarily expresses:", options: ["A formal complaint", "A job application", "Personal feelings and emotions"], answer: "Personal feelings and emotions" }
            ];
            const kingspraiseQs = [
                { question: "1. An informal letter is written to people you:", options: ["Do not know", "Know well, like friends and family", "Want to hire for a job"], answer: "Know well, like friends and family" },
                { question: "2. What two pieces of information are placed at the top right of an informal letter?", options: ["Your name and the recipient's name", "The date and your signature", "Your address and the date"], answer: "Your address and the date" },
                { question: "3. The greeting of an informal letter, like 'Dear Tunde,' is called the:", options: ["Subscription", "Salutation", "Introduction"], answer: "Salutation" },
                { question: "4. The use of exclamation marks (!) in an informal letter is appropriate to show:", options: ["Formality", "Excitement", "Confusion"], answer: "Excitement" },
                { question: "5. The main paragraphs of your letter, where you discuss news and ideas, form the:", options: ["Body", "Conclusion", "Address"], answer: "Body" },
                { question: "6. 'Give my regards to your parents' is an example of a sentence in the:", options: ["Introduction", "Body", "Conclusion and Subscription"], answer: "Conclusion and Subscription" },
                { question: "7. The tone of an informal letter is best described as:", options: ["Relaxed, friendly, and conversational", "Strict, serious, and professional", "Neutral and objective"], answer: "Relaxed, friendly, and conversational" },
                { question: "8. According to the text, a debate is a:", options: ["Casual chat about a topic", "Formal discussion with opposing viewpoints", "Written story to entertain an audience"], answer: "Formal discussion with opposing viewpoints" },
                { question: "9. If you are 'Opposing' the motion, you are:", options: ["For the topic", "Neutral on the topic", "Against the topic"], answer: "Against the topic" },
                { question: "10. The first four groups to address in a debate vocative are, in order:", options: ["Students, Judges, Chairman, Timekeeper", "Chairman, Judges, Timekeeper, Co-debaters", "Co-debaters, Students, Timekeeper, Judges"], answer: "Chairman, Judges, Timekeeper, Co-debaters" },
                { question: "11. The part of the debate where you present your points clearly with examples is the:", options: ["Introduction", "Body", "Conclusion"], answer: "Body" },
                { question: "12. To be convincing in a debate, the text advises you to be:", options: ["Persuasive and confident", "Reserved and quiet", "Aggressive and loud"], answer: "Persuasive and confident" },
                { question: "13. In the example debate, the internet's ability to be 'constantly updated' is contrasted with textbooks which can become:", options: ["Too expensive", "Outdated", "Too simple"], answer: "Outdated" },
                { question: "14. A key weakness of the internet mentioned in the classwork hint is the potential for:", options: ["'Fake News' or poor reliability", "It being too slow to use", "It having too much information"], answer: "'Fake News' or poor reliability" },
                { question: "15. The final conclusion of a debate should summarize your points and:", options: ["Introduce a new topic", "Restate your position firmly", "Ask for the opponent's opinion"], answer: "Restate your position firmly" }
            ];
            return student === 'El Rohi' ? elRohiQs : kingspraiseQs;
        }
    </script>
</body>
</html>
