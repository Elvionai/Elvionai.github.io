<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Philadelphia AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
  <style>
/* Default Theme: Night Sky */
:root {
  --cyan: #00fff7;
  --blue: #0a8afe;
  --dark-bg: #070b1a;
  --fade-blue: #133c8b;
  --gradient-1: linear-gradient(120deg, #000a2e 39%, #04336a 68%, #10bfff 97%);
  --gradient-user: linear-gradient(120deg, #0857ee 32%, #00fff0 89%);
  --glass: rgba(25, 38, 67, 0.82);
  --bubble-glow: 0 0 13px #00d8ffb1, 0 0 24px #0197ff40;
  --user-glow: 0 0 22px #0fffd555, 0 0 14px #36f9ff70;
  --header-glass: rgba(17,29,47,0.92);
  --code-bg: linear-gradient(92deg,#031d39 79%,#092ff8 120%);
  --code-border: #15faff;
  --code-text: #17fafd;
  --main-bg-start: #112250;
  --main-bg-end: #060e1e;
  --star-color: #08ecff;
  --star-shadow: 0 0 12px #00fff9cc, 0 0 22px #1bf2f2cc;
}

/* --- THEME 2: OCEAN WAVE (Blue/Teal, Soft) --- */
.theme-oceanwave {
    --dark-bg: #0f1c32;
    --cyan: #37cfff;
    --blue: #008cba;
    --gradient-1: linear-gradient(120deg, #1d4078 39%, #10a7c9 97%);
    --gradient-user: linear-gradient(120deg, #13b3e8 32%, #60fff0 89%);
    --bubble-glow: 0 0 13px #18c0e2b1, 0 0 24px #0197ff40;
    --user-glow: 0 0 22px #22f7ff55, 0 0 14px #49e7ff70;
    --header-glass: rgba(25, 41, 68, 0.92);
    --code-border: #33e8ff;
    --main-bg-start: #2a557d;
    --main-bg-end: #0d1e3d;
    --star-color: #79f7ff;
    --star-shadow: 0 0 12px #60f9ffcc, 0 0 22px #48e6ffcc;
}
.theme-oceanwave html, .theme-oceanwave body {
    background: radial-gradient(circle at 60% 45%, var(--main-bg-start) 37%, var(--main-bg-end) 88%, #1e0942 100%) fixed, repeating-linear-gradient(100deg,#163f70 0 9%,#0d1e3d 16% 19%,#09113d 30% 41%,#10406d 44% 62%,#0a182d 74% 89%,#0c2162 99% 100%);
    background-blend-mode: lighten, color-dodge;
}

/* --- THEME 3: VAPORWAVE NEON (Purple/Pink/Orange) --- */
.theme-vaporwave {
    --dark-bg: #2a0b38;
    --cyan: #ff00ff; /* Pink/Magenta */
    --blue: #ff8c00; /* Orange */
    --gradient-1: linear-gradient(120deg, #44115f 39%, #ff00ff 97%);
    --gradient-user: linear-gradient(120deg, #ff8c00 32%, #ff00ff 89%);
    --bubble-glow: 0 0 13px #ff00ffb1, 0 0 24px #ff007f40;
    --user-glow: 0 0 22px #ff8c0055, 0 0 14px #ff00ff70;
    --header-glass: rgba(42, 11, 56, 0.92);
    --code-border: #ff00ff;
    --code-text: #ffe0ff;
    --main-bg-start: #5e1f7a;
    --main-bg-end: #1a0627;
    --star-color: #ff00ff;
    --star-shadow: 0 0 12px #ff00ffcc, 0 0 22px #ff00ffcc;
}
.theme-vaporwave html, .theme-vaporwave body {
    background: radial-gradient(circle at 60% 45%, var(--main-bg-start) 37%, var(--main-bg-end) 88%, #1a0627 100%) fixed, repeating-linear-gradient(100deg,#44115f 0 9%,#1a0627 16% 19%,#11041b 30% 41%,#4f1d6b 44% 62%,#1a0627 74% 89%,#3d145c 99% 100%);
    background-blend-mode: lighten, color-dodge;
}

/* --- THEME 4: CYBERPUNK (Red/Black/Yellow) --- */
.theme-cyberpunk {
    --cyan: #ffdd00;
    --blue: #ff0000;
    --dark-bg: #1a0101;
    --gradient-1: linear-gradient(120deg, #2a0000 39%, #aa0000 68%, #ffdd00 97%);
    --gradient-user: linear-gradient(120deg, #ff0000 32%, #ff9d00 89%);
    --bubble-glow: 0 0 13px #ff0000b1, 0 0 24px #ff000040;
    --user-glow: 0 0 22px #ffdd0055, 0 0 14px #ff000070;
    --header-glass: rgba(26, 1, 1, 0.92);
    --code-bg: linear-gradient(92deg,#2a0000 79%,#ff0000 120%);
    --code-border: #ffdd00;
    --code-text: #fff1a0;
    --main-bg-start: #2a0000;
    --main-bg-end: #0a0101;
    --star-color: #ffdd00;
    --star-shadow: 0 0 12px #ff0000cc, 0 0 22px #ff0000cc;
}
.theme-cyberpunk html, .theme-cyberpunk body {
    background: radial-gradient(circle at 60% 45%, var(--main-bg-start) 37%, var(--main-bg-end) 88%, #0a0101 100%) fixed, repeating-linear-gradient(100deg,#2a0000 0 9%,#0a0101 16% 19%,#0a0101 30% 41%,#2a0000 44% 62%,#0a0101 74% 89%,#2a0000 99% 100%);
    background-blend-mode: lighten, color-dodge;
}

/* --- THEME 5: EARTH GREEN (Dark Green/Gold) --- */
.theme-earth {
    --cyan: #8cff00;
    --blue: #228b22;
    --dark-bg: #0d1a07;
    --gradient-1: linear-gradient(120deg, #0f2e00 39%, #228b22 68%, #8cff00 97%);
    --gradient-user: linear-gradient(120deg, #228b22 32%, #ffff00 89%);
    --bubble-glow: 0 0 13px #32cd32b1, 0 0 24px #228b2240;
    --user-glow: 0 0 22px #8cff0055, 0 0 14px #228b2270;
    --header-glass: rgba(13, 26, 7, 0.92);
    --code-bg: linear-gradient(92deg,#0f2e00 79%,#228b22 120%);
    --code-border: #8cff00;
    --code-text: #caff80;
    --main-bg-start: #1c3c10;
    --main-bg-end: #0d1a07;
    --star-color: #8cff00;
    --star-shadow: 0 0 12px #8cff00cc, 0 0 22px #228b22cc;
}
.theme-earth html, .theme-earth body {
    background: radial-gradient(circle at 60% 45%, var(--main-bg-start) 37%, var(--main-bg-end) 88%, #0d1a07 100%) fixed, repeating-linear-gradient(100deg,#1c3c10 0 9%,#0d1a07 16% 19%,#0f2e00 30% 41%,#1c3c10 44% 62%,#0d1a07 74% 89%,#1c3c10 99% 100%);
    background-blend-mode: lighten, color-dodge;
}


html, body {
  height: 100vh; width: 100vw; margin: 0; padding: 0;
  color: #e1fafe;
  background:
    radial-gradient(circle at 60% 45%, var(--main-bg-start) 37%, var(--main-bg-end) 88%, #1e0942 100%) fixed,
    repeating-linear-gradient(100deg,#061c4c 0 9%,#080e20 16% 19%,#030721 30% 41%,#052650 44% 62%,#050b16 74% 89%,#041048 99% 100%);
  background-blend-mode: lighten, color-dodge;
  font-family: 'Roboto','Inter',system-ui,-apple-system,Segoe UI,sans-serif;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}
body { overflow: hidden; min-height: 100vh; width: 100vw; }
#stars-container {
  pointer-events: none;
  position: fixed; left:0; top:0;right:0;bottom:0;
  width:100vw; height:100vh; z-index:1;
  overflow: hidden;
}
.star {
  position:absolute;
  background: var(--star-color);
  box-shadow: var(--star-shadow);
  opacity: 0.23;
  border-radius: 50%;
  pointer-events: none;
  animation: star-twinkle 2.7s infinite alternate;
}
@keyframes star-twinkle {
  0% { opacity:.18; }
  41% { opacity:.88; }
  100%{ opacity:.09;}
}
.header-bar {
  position: fixed; top: 0; left: 0; width: 100vw;
  display: flex; align-items: center; justify-content: space-between;
  background: var(--header-glass);
  z-index: 1003;
  padding: 0;
  box-shadow: 0 7px 48px #00aaff27, 0 3px 41px #09fcfe15;
  border-radius: 0 0 22px 22px;
  height: 70px;
}
.menu-btn {
  background: none; border: none;
  color: var(--cyan); font-size: 2em; cursor: pointer;
  border-radius: 14px; margin-left: 17px; margin-right: 3px;
  padding: 7px 11px;
  transition: background .15s, color .15s;
}
.menu-btn:hover { background: #00eaff28; color: #fff; }
.site-heading {
  font-family: 'Orbitron',sans-serif;
  font-size: 1.28em; font-weight: 700;
  text-align: center; flex: 1;
  letter-spacing: .27px;
  white-space:nowrap;
  background: linear-gradient(90deg,#00fff1,#00b4ff 40%,#fff 59%,#1093f1 89%,#24e0fa 100%);
  background-size: 250% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: neonglow 4.2s ease-in-out infinite alternate;
  text-shadow: 0 0 12px #00ffe0cc, 0 0 27px #178fcf88;
  user-select: none; margin-left: 8px; margin-right: 10px;
}
@keyframes neonglow {
  0% { text-shadow: 0 0 17px #00e7ff70,0 0 30px #0b8fff44;}
  100% { text-shadow: 0 0 29px #00ffe9ee,0 0 44px #31d2ff82;}
}
.header-welcome {
  color: #68e6fd; font-size: .97em; margin: -2px 0 .7em 0; text-align: center;
  text-shadow: 0 0 14px #00bcb4a8;
}
.main-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow-y: hidden;
    position: relative;
    padding-top: 70px;
    padding-bottom: 86px;
    box-sizing: border-box;
}
.chat-box {
  flex: 1 1 0px; 
  overflow-y: auto;
  overflow-x: hidden;
  width: 100vw; max-width: 635px; margin: 0 auto;
  box-sizing: border-box;
  padding: 15px 8px 40px 8px;
  position: relative;
  z-index:3;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
}
.chat-message {
  width: 100%; display: flex; gap:9px; align-items: flex-end;
  margin: 8px 0; max-width:100vw;
  flex-shrink: 0;
}
.chat-message .msg {
  font-size: 1.01em; line-height: 1.58;
  max-width: 62vw; min-width:0; 
  padding: 11px 16px 12px 15px;
  border-radius: 16px 14px 11px 12px;
  word-break: break-word; white-space: pre-wrap; overflow-x: auto;
  background: var(--gradient-1); color: #e1fafe;
  text-shadow: 0 0 3px #23d8ff15;
  box-shadow: var(--bubble-glow);
  margin-right: auto; margin-left: 0;
  border: 1.2px solid #0090ffa0; position:relative;
  transition:background .15s;
}
.chat-message.user { justify-content: flex-end; }
.chat-message.user .msg {
  background: var(--gradient-user);
  color: #141825; font-weight: 700;
  text-shadow: 0 0 5px #00e0ff77, 0 0 2px #00ffe033;
  border-radius: 17px 13px 15px 11px;
  margin-left: auto; margin-right: 0;
  box-shadow: var(--user-glow);
  border: 1.2px solid #04eef4c9;
  max-width: 68vw;
}
@media (max-width:790px) {
  .chat-box { max-width:100vw; padding: 15px 4px 40px 4px; }
  .chat-message .msg { font-size: .97em; padding:9px 4vw 10px 5vw; max-width:80vw;}
  .chat-message.user .msg { max-width: 83vw; }
}
.typing-bubble {
  display: inline-flex;
  align-items: center;
  height: 28px;
  padding: 4px 12px;
  margin: 6px 4px;
  border-radius: 15px;
  background: linear-gradient(90deg,#0a4477dd 30%,#0ebfff88 95%);
  box-shadow: 0 2px 12px #0dfcff77;
  border: 1px solid #00ffff55;
}
.dot-anim {
  display:inline-block;
  width: 8px; height: 8px;
  margin:0 3px; 
  background: #05fff9;
  border-radius: 50%;
  opacity: 0.85;
  animation: typing-blink 1.4s infinite both;
  box-shadow: 0 0 6px #05fff9aa;
}
.dot-anim:nth-child(2){animation-delay:.3s;}
.dot-anim:nth-child(3){animation-delay:.6s;}
@keyframes typing-blink {
  0%,100% {opacity:.25; transform: scale(0.8);}
  25%  {opacity:.95; transform: scale(1.1);}
  50%  {opacity:1; transform: scale(1.2);}
  75%  {opacity:.65; transform: scale(1);}
}
pre, code {
  font-family: 'JetBrains Mono','Fira Mono','Menlo',monospace;
  font-size: .99em;
  background: var(--code-bg);
  border-radius: 11px;
  border: 1.7px solid var(--code-border);
  color: var(--code-text);
  box-shadow: 0 0 19px #00eaff38, 0 0 48px #0beaff38 inset;
}
pre {
  overflow-x: auto;
  padding: 1.18em 1.3em 1.16em 1.13em;
  margin: 1.15em 0 1em 0; position: relative;
}
pre:before {
  content: "CODE";
  color: #07eefb;
  font-size: 0.82em;
  font-family: 'Orbitron', monospace;
  position: absolute; top: 5px; right: 29px; opacity: 0.17;
  letter-spacing: 0.13em; pointer-events: none;
}
.copy-btn {
  position: absolute; top: 10px; right: 13px; z-index: 3;
  border-radius: 8px; border: none; padding: 3px 15px;
  background: linear-gradient(95deg,#0cf3ff 40%,#0980ff 120%);
  color: #06182f; font-size: .98em; font-family: 'Inter'; font-weight: bold;
  box-shadow: 0 2px 9px #18e3ffc5,0 0 7px #00ffd7a4;
  transition: background .15s, color .15s;
  cursor: pointer; outline: none; border: 1px solid #0cf3ff35;
}
.copy-btn:hover { background: #008cee; color: #fff; }
.inline-copy-btn, .inline-share-btn, .regen-btn, .inline-edit-btn {
  padding:4px 10px; border-radius:7px; border:none;
  background:linear-gradient(94deg,#00fff6,#0090ff 97%);
  color:#0f1a31; font-family:'Inter',Arial,sans-serif; font-size:.96em;
  font-weight:600; display:inline-flex; align-items:center; gap:4px; 
  margin-top:6px; margin-right: 3px; cursor:pointer;
  box-shadow:0 2px 7px #17f6fe51;transition:background .14s,color .13s;
}
.inline-copy-btn:hover, .inline-share-btn:hover, .regen-btn:hover, .inline-edit-btn:hover{background:#009cff; color:#fff;}
.file-attachments {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
    max-width: 100%;
}
.chat-media-preview {
  max-width: 100%;
  max-height: 250px;
  border-radius: 12px;
  display: block;
}
.image-preview-thumb, .video-preview-thumb {
  border: 2px solid #00fff2;
  box-shadow: 0 0 10px #00eaff88;
}
.audio-preview-thumb {
  width: 90%;
  min-height: 40px;
  border-radius: 10px;
}
.file-link {
  display: inline-block;
  padding: 8px 12px;
  background: #0b2447;
  border: 1px solid #1af8ff51;
  border-radius: 10px;
  color: #00fff6;
  text-decoration: none;
  font-size: 0.9em;
  font-weight: bold;
}
.file-link i { margin-right: 5px; }
.file-preview{
  display:none;
  background:rgba(15,36,65,0.98);
  border-radius:12px;color:#c4f2ff;font-size:.98em;
  box-shadow:0 3px 15px #00aac0bb;
  margin:0 auto 10px auto;width:94vw;max-width:520px;
  padding:10px 14px 10px 15px;
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  z-index: 1002;
  border: 1.5px solid #00ffff44;
}
.file-preview img, .file-preview video {
  max-width:58px;max-height:41px;border-radius:6px;margin-right:6px;vertical-align: middle;
}
.file-preview audio { width:52px; margin-right:7px; }
.remove-file-btn {
  color: #fff !important; 
  background:#d23 !important;
  border:none !important; 
  border-radius:50% !important;
  padding:2px 6px !important; 
  cursor:pointer !important;
  font-size:1.2em !important; 
  font-weight:bold !important;
  margin-left:8px !important;
  transition: background .16s, color .16s !important;
  min-width: 24px !important;
  height: 24px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
}
.remove-file-btn:hover { 
  background:#ff4444 !important; 
  color:#fff !important;
  transform: scale(1.1) !important;
}

/* --- IMPROVED KEYBOARD FIT --- */
.chat-input-row {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 0;
  display: flex;
  align-items: stretch;
  gap: 8px;
  background: rgba(17, 29, 47, 0.94);
  backdrop-filter: blur(8px);
  border: 1.5px solid #1af8ff51;
  border-radius: 23px 23px 0 0;
  width: 95vw;
  max-width: 900px;
  padding: 9px 12px 10px 13px;
  box-shadow: 0 0 39px #007fff22, 0 11px 33px #00fff014;
  z-index: 1003;
}
@media (max-width: 920px) {
  .chat-input-row {
    width: 95vw;
    max-width: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 22px 22px 8px 8px;
  }
}
.chat-input-row textarea{
  flex:1 1 auto;resize:none;min-height:36px;max-height:120px;
  background:#09284c;color:#f5ffff;font-size:1em;
  padding:10px 12px;border:none;border-radius:11px;
  box-shadow:0 1px 6px #00f2ff27;
}
.chat-input-row button, .chat-input-row label{
  background:none;border:none;color:#07eaff;font-size:1.21em;
  cursor:pointer;border-radius:10px;transition:color .13s,background .15s;padding:0;
  display:flex;align-items:center;justify-content:center;min-width:33px;
  box-shadow: 0 0 3px #00eaff20;
}
.chat-input-row button:hover, .chat-input-row label:hover{color:#fff;background:#00cdf247;}
#emojiPanel {
  display:none;
  position: fixed;
  left:10px;
  bottom:110px;
  z-index:2222;
  background: #051f46f9;
  border-radius: 15px;
  padding: 16px 15px 12px 15px;
  box-shadow: 0 5px 22px #00fff194;
  border: 1px solid #00ffff66;
}
.emoji-pick {
  font-size:1.23em;
  cursor:pointer;
  padding:4px 8px;
  border-radius:10px;
  transition:background .13s;
  user-select:none;
}
.emoji-pick:hover { background:#35cdfd66; }
.status-message{padding:6px 13px;color:#12ffc7;font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;}
.panel-bg {
  display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(13,20,52,0.86);z-index:1200;
}
.panel-bg.active{display:block;}
.side-panel{position:absolute;top:0;left:0;height:100vh;width:325px;background:linear-gradient(118deg,#131642 80%,#1629af 200%);border-right:2.5px solid #00fbffcb;box-shadow:0 0 42px #25f8ffc9;z-index:1212;
  padding:18px 16px 20px 15px;overflow-y:auto;border-radius:0 24px 32px 0;}
.side-panel .panel-header{text-align:center;margin:18px 0 13px 0;}
.side-panel img{width:56px;height:56px;border-radius:53%;margin-bottom:8px;border:2px solid #31f6ffea;}
.side-panel .username{font-weight:700;font-size:1.11em;color:#08d0fe;font-family:'Orbitron',sans-serif;text-shadow:0 0 8px #00eaffbb;}
.side-panel .email{font-size:.97em;color:#a8eaff;}
.panel-links a{color:#13efff;text-decoration:none;font-weight:500;font-size:1.08em;padding:8px 4px;display:flex;align-items:center;gap:12px;border-radius:9px;transition:background .14s;}
.panel-links a:hover{background:#00eaff55;color:#f4fdff;}
.panel-links a i { width: 20px; text-align: center; }
#chatsList button{background:none;border:none;cursor:pointer;outline:none;font-size:1.11em;margin:0 5px;vertical-align:middle;border-radius:7px;padding:3px 5px;}
#chatsList .fa-pen{color:#0fe0ee;transition:color .13s;}
#chatsList .fa-pen:hover{color:#ffd800;}
#chatsList .fa-trash{color:#ff244e;transition:color .10s;}
#chatsList .fa-trash:hover{color:#fff900;}
#chatsList .fa-play{color:#04ea70;font-size:1.2em;}
#chatsList .fa-play:hover{color:#31adff;}
.edit-form label{display:block;margin-top:10px;font-size:.99em;color:#38e4ff;text-shadow:0 1px 14px #11aaff71;}
.edit-form input, .edit-form textarea, .edit-form select{
  width:99%;padding:7px 11px;margin-top:5px;
  border:1.7px solid #13f0ff95;border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;
  box-shadow:0 0 8px #04f6fd81 inset;transition:border-color .17s,box-shadow .17s;}
.edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus{border-color:#27eeff;background:#273f5d;color:#fff;}
.edit-form textarea { resize:vertical; min-height: 80px; }
.submit-btn{
  margin-top:14px; padding:10px 20px;
  background:linear-gradient(94deg,#00ffff,#0090ff 90%);
  border:none; border-radius:10px;
  color:#102649; font-weight:bold; cursor:pointer; font-size:1.11em;
  box-shadow:0 2px 13px #00fff292; transition:background .14s,color .13s;}
.submit-btn:hover{background:#008cff;color:#fff;}
/* Spinner for loading states */
.spinner {
  display: inline-block;
  width: 20px; height: 20px;
  border: 3px solid rgba(0, 255, 247, 0.3);
  border-radius: 50%;
  border-top-color: var(--cyan);
  animation: spin 1s ease-in-out infinite;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- CALL MODAL STYLES --- */
#callModal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 5000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
#callModal.active { display: flex; }
#callContent {
    background: rgba(17, 29, 47, 0.9);
    border: 2px solid #00f2ff;
    border-radius: 15px;
    padding: 20px;
    width: 90%; max-width: 450px;
    box-shadow: 0 0 40px #00eaff88;
}
#botImage {
    width: 80px; height: 80px; border-radius: 50%;
    border: 3px solid var(--cyan); box-shadow: 0 0 15px var(--cyan);
    margin-bottom: 10px;
}
#callLog {
    height: 250px; overflow-y: auto;
    background: #09284c; padding: 10px; border-radius: 8px;
    font-size: 0.9em; margin-bottom: 15px;
    border: 1px solid #1af8ff51;
}
#callLog .user { color: #00fff6; text-align: right; }
#callLog .bot { color: #f5ffff; text-align: left; }
#callControls button {
    background: #ff4444; color: white; border: none; padding: 12px 20px;
    border-radius: 10px; font-size: 1.1em; cursor: pointer;
    margin: 0 10px; transition: background 0.2s;
}
#callControls button#endCallBtn { background: #ff4444; }
#callControls button#endCallBtn:hover { background: #e02020; }
#callControls button#muteBtn { background: #00aaff; }
#callControls button#muteBtn:hover { background: #008cff; }
</style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="main-content">
    
    <div class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <div class="header-titles">
        <span class="site-heading">ðŸ¦…Philadelphia AIðŸ¦…</span>
        <div class="header-welcome" id="headerWelcome"></div>
      </div>
      <button class="menu-btn" id="themeToggleBtn" title="Change Theme"><i class="fa-solid fa-moon"></i></button>
      <button class="menu-btn" id="callBtn" title="Call Bot"><i class="fa-solid fa-phone"></i></button>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <button type="button" id="emojiBtn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
      <label for="chatFile" class="file-upload-btn" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
      <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none">
      <textarea id="chatInput" placeholder="Type hereâ€¦ (Shift+Enter = new line)"></textarea>
      <button type="button" id="toolBtn" title="Philadelphia Tools" aria-controls="toolMenu" aria-expanded="false"><i class="fa-solid fa-wrench"></i></button>
      <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
    </form>
  </div>
  
  <div id="emojiPanel"></div>
  <div class="status-message" id="statusMsg"></div>
  <div id="filePreview" class="file-preview"></div>
  
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:1.17em;font-weight:700;color:#00ffff;margin:18px 0 0 13px;">Chats</span>
        <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="profileMenuBg.classList.remove('active');">&times;</button>
      </div>
      <div id="chatsList" style="margin:7px 0 8px 6px;max-height:161px;overflow-y:auto;"></div>
      <button id="newChatBtn" class="submit-btn" style="margin:0 0 12px 11px;"><i class="fa-solid fa-plus"></i> New Chat</button>
      <hr style="width:91%;margin:11px 0 7px 3%;border:1px solid #00fff031;">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 6px;">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Paste image link">
        <span style="font-size:0.83em;color:#aae;display:block;margin:5px 0 7px 2px;">
          Tip: <a href="https://postimg.cc/" target="_blank" style="color:#19fcff;">Upload at postimg.cc</a>
        </span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">Logout</button>
    </nav>
  </div>
  
  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:100px;max-width:320px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;">
    <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
    <div id="ai-image-container"></div>
    <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
  </div>
  
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Philadelphia logo">
        <div class="username">Philadelphia AI</div>
      </div>
      <div class="panel-links">
        <a href="philadelphia.html"><i class="fa-solid fa-home"></i>Philadelphia Homepage</a>
        <a href="index.html"><i class="fa-solid fa-home"></i>Elvion Homepage</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About US</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Try Telegram Version</a>
      </div>
    </nav>
  </div>

  <div class="panel-bg" id="toolsMenuBg">
    <nav class="side-panel" id="toolsMenu">
        <div class="panel-header" style="text-align:left;">
            <div class="username" style="font-size:1.2em;margin-left:-8px;text-align:center;">Philadelphia AI Tools</div>
        </div>
        <div class="panel-links">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Creative Suite</h3>
            <a href="#" class="tool-link" data-tool="image"><i class="fa-solid fa-image"></i> Generate Image</a>
            <a href="#" class="tool-link" data-tool="edit-photo"><i class="fa-solid fa-wand-magic-sparkles"></i> Edit Photo</a>
            <a href="#" class="tool-link" data-tool="remove-bg"><i class="fa-solid fa-scissors"></i> Remove Background</a>
            <a href="#" class="tool-link" data-tool="comic"><i class="fa-solid fa-book-open"></i> Create Comic</a>
            <hr style="border-color: #00eaff30; margin: 10px 0;">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Audio & Video</h3>
            <a href="#" class="tool-link" data-tool="voice-gen"><i class="fa-solid fa-microphone-lines"></i> Voice Generation</a>
            <a href="#" class="tool-link" data-tool="audio-narration"><i class="fa-solid fa-file-audio"></i> Audio Narration</a>
            <a href="#" class="tool-link" data-tool="video-text"><i class="fa-solid fa-film"></i> Text-to-Video</a>
            <a href="#" class="tool-link" data-tool="video-image"><i class="fa-solid fa-photo-film"></i> Image-to-Video</a>
            <a href="#" class="tool-link" data-tool="music"><i class="fa-solid fa-music"></i> Generate Music</a>
            <hr style="border-color: #00eaff30; margin: 10px 0;">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Web & Research</h3>
            <a href="#" class="tool-link" data-tool="website"><i class="fa-solid fa-globe"></i> Create Website</a>
            <a href="#" class="tool-link" data-tool="edit-website"><i class="fa-solid fa-pen-ruler"></i> Edit Last Website</a>
            <a href="#" class="tool-link" data-tool="my-sites"><i class="fa-solid fa-list-check"></i> My Websites</a>
            <a href="#" class="tool-link" data-tool="research-report"><i class="fa-solid fa-flask-vial"></i> Research Report</a>
        </div>
        <button class="submit-btn" style="margin-top:17px;" onclick="closeToolMenu();">Close</button>
    </nav>
  </div>

  <div class="panel-bg" id="toolFormModalBg">
    <nav class="side-panel" id="toolFormModal">
      <div class="panel-header">
        <div class="username" id="toolFormTitle">Tool Title</div>
      </div>
      <form class="edit-form" id="toolForm" style="padding:0 6px;"></form>
      <button id="toolFormBackBtn" class="submit-btn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">
          <i class="fa-solid fa-arrow-left"></i> Back to Tools
      </button>
      <div class="status-message" id="toolStatusMsg"></div>
    </nav>
  </div>

  <div id="callModal" class="panel-bg">
    <div id="callContent">
        <div style="text-align:center; margin-bottom: 20px;">
            <img id="botImage" src="https://i.postimg.cc/XqL63yM9/IMG-20250824-133336-309.jpg" alt="Philadelphia AI">
            <h2 style="color:var(--cyan); margin: 5px 0 0;">Philadelphia AI</h2>
            <div id="callStatus" style="color:#00ff8c; font-size: 0.9em;">Connecting...</div>
        </div>
        <div id="callLog">
            </div>
        <div id="callControls" style="text-align:center;">
            <button id="muteBtn" title="Mute/Unmute"><i class="fa-solid fa-microphone"></i> Mute</button>
            <button id="endCallBtn" title="End Call"><i class="fa-solid fa-phone-slash"></i> Hang Up</button>
        </div>
    </div>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script type="module">
// --- FIREBASE AND IMPORTS ---

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";


const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app); // Initialize Firestore

// Short helper
const $ = id => document.getElementById(id);

// API Base URL
const API_BASE_URL = 'https://web-production-9a18.up.railway.app';

// ---------- Global State Management & AbortController (UPDATED for Firestore) ----------
let chatsMetadata = []; // Stores { id, name, lastMessageText } for the sidebar
let currentChat = null; // Stores { id: '...', name: '...', history: [] }
let uploadedFiles = [];
let currentUser = null;
let typingNode = null;
let currentController = null;

// --- FIRESTORE CHAT FUNCTIONS ---

async function loadUserChatsMetadata(userId) {
    if (!userId) return [];
    const chatsRef = collection(db, 'users', userId, 'chats');
    // Order by 'updatedAt' which we will set on every new message
    const q = query(chatsRef, orderBy('updatedAt', 'desc')); 
    const snapshot = await getDocs(q);
    chatsMetadata = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    return chatsMetadata;
}

async function loadChatHistory(userId, chatId) {
    if (!userId || !chatId) return [];
    const historyRef = collection(db, 'users', userId, 'chats', chatId, 'messages');
    const q = query(historyRef, orderBy('timestamp', 'asc')); // Oldest first
    const snapshot = await getDocs(q);
    const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Update currentChat state
    const metadata = chatsMetadata.find(c => c.id === chatId);
    currentChat = { id: chatId, name: metadata?.name || 'Untitled Chat', history: history };
    return history;
}

async function startNewChat() {
    if (!currentUser) return;
    const newChatRef = doc(collection(db, 'users', currentUser.uid, 'chats'));
    const newChat = {
        name: `Chat ${chatsMetadata.length + 1}`,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        lastMessageText: '',
    };
    await setDoc(newChatRef, newChat);
    await loadUserChatsMetadata(currentUser.uid); // Refresh metadata
    await loadChatHistory(currentUser.uid, newChatRef.id);
    renderChatsListSidebar();
    renderChatBox(currentChat.history);
}

async function addMessageToChat(role, text, files = [], isNewChat = false) {
    if (!currentUser) return;
    if (isNewChat || !currentChat?.id) {
        await startNewChat(); // Will update currentChat
    }

    const message = {
        role,
        text,
        files: files.map(f => ({ 
            name: f.name, 
            type: f.type, 
            summary: f.summary || f.url || 'File attached' // Use summary/URL
        })),
        timestamp: Date.now(),
    };

    // 1. Add the message to the subcollection
    const msgRef = await addDoc(collection(db, 'users', currentUser.uid, 'chats', currentChat.id, 'messages'), message);
    
    // 2. Update the parent chat metadata
    await updateDoc(doc(db, 'users', currentUser.uid, 'chats', currentChat.id), {
        name: currentChat.name || (text.length > 30 ? text.substring(0, 30) + '...' : text),
        updatedAt: Date.now(),
        lastMessageText: text.substring(0, 50)
    });
    
    // Update local state and UI
    currentChat.history.push({ id: msgRef.id, ...message });
    renderChatsListSidebar(); 
    renderChatBox(currentChat.history);
}

async function deleteChat(chatId) {
    if (!currentUser || !chatId) return;
    if (!confirm("Are you sure you want to delete this chat?")) return;

    // Delete all messages in subcollection (Note: Firestore does not auto-delete subcollections, 
    // but we can rely on the UI hiding it, or use cloud functions for full deletion.
    // For this client-side example, we delete the parent doc.)
    const chatRef = doc(db, 'users', currentUser.uid, 'chats', chatId);
    await deleteDoc(chatRef);

    // After deletion
    await loadUserChatsMetadata(currentUser.uid);
    if (chatsMetadata.length > 0) {
        await loadChatHistory(currentUser.uid, chatsMetadata[0].id);
    } else {
        await startNewChat(); // Create new empty chat
    }
    renderChatsListSidebar();
    renderChatBox(currentChat?.history || []);
}


window.addEventListener('DOMContentLoaded', () => {
  // ---------- Element Selectors ----------
  const starsContainer = $('stars-container');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const toolsMenuBg = $('toolsMenuBg');
  const toolsMenu = $('toolsMenu');
  const toolBtn = $('toolBtn');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  const emojiBtn = $('emojiBtn');
  const toolFormModalBg = $('toolFormModalBg');
  const toolForm = $('toolForm');
  const toolFormTitle = $('toolFormTitle');
  const toolFormBackBtn = $('toolFormBackBtn');
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');
  // New Theme Element
  const themeToggleBtn = $('themeToggleBtn');
  const themes = ['theme-default', 'theme-oceanwave', 'theme-vaporwave', 'theme-cyberpunk', 'theme-earth'];
  let currentThemeIndex = 0;
  // New Call Elements
  const callBtn = $('callBtn');
  const callModal = $('callModal');
  const callLog = $('callLog');
  const callStatus = $('callStatus');
  const muteBtn = $('muteBtn');
  const endCallBtn = $('endCallBtn');
  let isCalling = false;
  let speechRecognition = null;
  let isMuted = false;

  if (!chatForm || !chatBox || !toolsMenu) {
    console.error("Essential UI elements are missing. App functionality will be limited.");
    return;
  }

  // ---------- THEME TOGGLE LOGIC ----------
    function applyTheme(index) {
        document.body.className = themes[index] === 'theme-default' ? '' : themes[index];
        localStorage.setItem('philadelphia_theme_index', index);
    }
    const persistedIndex = localStorage.getItem('philadelphia_theme_index');
    if (persistedIndex !== null) {
        currentThemeIndex = parseInt(persistedIndex);
    }
    applyTheme(currentThemeIndex);

    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            applyTheme(currentThemeIndex);
        });
    }
  // ----------------------------------------

  // ---------- UI Initializers & Event Handlers ----------
  if (starsContainer) {
    starsContainer.innerHTML = '';
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  const emojis = ["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ¥°","ðŸ˜Ž","ðŸ‘","ðŸ™","ðŸ”¥","ðŸ’¯","ðŸŽ‰","ðŸ˜‡","ðŸ¤–","ðŸ‘€"];
  if (emojiBtn && emojiPanel && chatInput) {
    // ... (Emoji logic remains the same)
  }

  if (chatInput) {
    const autoResize = () => { chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px'; };
    chatInput.addEventListener('input', autoResize);
    chatInput.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatForm.requestSubmit(); }});
    autoResize();
  }
  
  if (chatFile) {
      chatFile.addEventListener('change', function() {
          uploadedFiles = Array.from(this.files || []);
          renderFilePreview();
      });
  }
  
  if (aiPrevClose) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; });
  if (aiPrevDLBtn) aiPrevDLBtn.addEventListener('click', () => {
    const img = aiPrevImgBox.querySelector('img');
    if (img) {
      const a = document.createElement('a'); a.href = img.src; a.download = 'philadelphia_ai_image.png'; a.click();
    }
  });

  // ---------- Panel & Modal Management (Remains the same) ----------
  window.closeToolMenu = () => { if (toolsMenuBg) toolsMenuBg.classList.remove('active'); };
  window.openToolMenu = () => { if (toolsMenuBg) toolsMenuBg.classList.add('active'); };

  if (profileMenuBg) {
    $('openProfileMenu').addEventListener('click', () => {
      profileMenuBg.classList.add('active');
      setTimeout(() => profileMenu.classList.add('active'), 10);
    });
    profileMenuBg.addEventListener('click', e => { if (e.target === profileMenuBg) { profileMenu.classList.remove('active'); setTimeout(() => profileMenuBg.classList.remove('active'), 110); } });
  }
  if (linkMenuBg) {
    $('openLinksMenu').addEventListener('click', () => {
      linkMenuBg.classList.add('active');
      setTimeout(() => linkMenu.classList.add('active'), 10);
    });
    linkMenuBg.addEventListener('click', e => { if (e.target === linkMenuBg) { linkMenu.classList.remove('active'); setTimeout(() => linkMenuBg.classList.remove('active'), 110); } });
  }
  if (toolBtn) toolBtn.addEventListener('click', openToolMenu);
  if (toolsMenuBg) toolsMenuBg.addEventListener('click', e => { if (e.target === toolsMenuBg) closeToolMenu(); });
  if (toolFormBackBtn) {
    toolFormBackBtn.addEventListener('click', () => {
      toolFormModalBg.classList.remove('active');
      openToolMenu();
    });
  }
  if (toolFormModalBg) toolFormModalBg.addEventListener('click', e => { if (e.target === toolFormModalBg) toolFormModalBg.classList.remove('active'); });
  if (logoutBtn) logoutBtn.addEventListener('click', () => {
      auth.signOut();
      window.location.href = 'signup-login.html';
  });

  // ---------- Bot Call Logic (NEW) ----------
  
  function addCallMessage(role, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = role;
      msgDiv.textContent = `${role === 'user' ? 'You' : 'Bot'}: ${text}`;
      callLog.appendChild(msgDiv);
      callLog.scrollTop = callLog.scrollHeight;
  }

  async function getBotResponseAudio(userText) {
      callStatus.textContent = "AI is thinking...";
      muteBtn.disabled = true;

      try {
          // 1. Get Text Response (Using a history-less chat for simplicity in call)
          const textRes = await fetch(`${API_BASE_URL}/chat`, { 
              method: 'POST', 
              headers: { 'Content-Type': 'application/json' }, 
              body: JSON.stringify({ message: userText, history: [], user_id: currentUser?.uid || "user" }) 
          });
          const textData = await textRes.json();
          const botText = textData.response || "Sorry, I lost connection.";
          addCallMessage('bot', botText);

          // 2. Generate Voice Audio (Using a cinematic style for drama)
          callStatus.textContent = "AI is speaking...";
          const fd = new FormData(); fd.append('text', botText); fd.append('style', 'cinematic');
          const voiceRes = await fetch(`${API_BASE_URL}/voicegen`, { method: 'POST', body: fd });
          if (!voiceRes.ok) throw new Error("Voice generation failed.");

          const audioBlob = await voiceRes.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          
          return new Promise(resolve => {
              audio.onended = () => {
                  URL.revokeObjectURL(audioUrl);
                  resolve();
              };
              audio.onerror = () => {
                  resolve(); // Resolve even on error
              };
              if (!isMuted) audio.play();
              else resolve(); // Resolve immediately if muted
          });

      } catch (err) {
          addCallMessage('bot', `[ERROR] Connection interrupted.`);
          console.error("Call error:", err);
      } finally {
          callStatus.textContent = "Listening...";
          muteBtn.disabled = false;
      }
  }

  function startCall() {
      if (isCalling) return;
      isCalling = true;
      callModal.classList.add('active');
      callLog.innerHTML = ''; // Clear log
      callStatus.textContent = "Connecting...";

      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!window.SpeechRecognition) {
          alert("Your browser does not support Web Speech API for the call feature.");
          endCall();
          return;
      }
      
      speechRecognition = new SpeechRecognition();
      speechRecognition.continuous = false;
      speechRecognition.interimResults = false;
      speechRecognition.lang = 'en-US';

      speechRecognition.onstart = () => { callStatus.textContent = "Listening..."; };

      speechRecognition.onresult = async (event) => {
          speechRecognition.stop(); // Stop listening while processing
          const userText = event.results[0][0].transcript;
          addCallMessage('user', userText);
          await getBotResponseAudio(userText);
          if (isCalling) speechRecognition.start(); // Resume listening after bot speaks
      };

      speechRecognition.onend = () => {
          if (isCalling) {
              callStatus.textContent = "Restarting listener...";
              speechRecognition.start(); // Restart if ended unexpectedly
          }
      };

      speechRecognition.onerror = (event) => {
          console.error('Speech recognition error:', event);
          if (event.error !== 'no-speech' && isCalling) endCall();
      };

      speechRecognition.start();
      getBotResponseAudio("Hello! I am Philadelphia AI. You can now speak to me.");
  }

  function endCall() {
      if (!isCalling) return;
      isCalling = false;
      speechRecognition?.stop();
      speechRecognition = null;
      callModal.classList.remove('active');
      callStatus.textContent = "Call ended.";
  }
  
  if (callBtn) callBtn.addEventListener('click', startCall);
  if (endCallBtn) endCallBtn.addEventListener('click', endCall);
  if (muteBtn) muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      muteBtn.innerHTML = isMuted ? '<i class="fa-solid fa-microphone-slash"></i> Unmute' : '<i class="fa-solid fa-microphone"></i> Mute';
      if(isMuted) callStatus.textContent = "Muted. Listening...";
      else callStatus.textContent = "Listening...";
  });

  // ---------- Authentication & Profile Management ----------
  onAuthStateChanged(auth, async user => {
    if (!user) {
      try { window.location.href = "signup-login.html"; } catch (e) {}
      return;
    }
    currentUser = user;
    if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]);
    if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
    if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
    if (editName) editName.value = user.displayName || "";
    if (editPhoto) editPhoto.value = user.photoURL || "";
    if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

    await loadUserChatsMetadata(user.uid);
    if (chatsMetadata.length === 0) {
        await startNewChat();
    } else {
        // Load the most recently updated chat
        await loadChatHistory(user.uid, chatsMetadata[0].id);
    }
    renderChatsListSidebar();
    renderChatBox(currentChat?.history || []);
  });

  if (profileForm) {
    // ... (Profile update logic remains the same)
  }

  // ---------- Chat History & Rendering Logic (UPDATED for Firestore) ----------
  function renderChatsListSidebar() {
    if (!chatsListEl) return;
    chatsListEl.innerHTML = '';
    
    chatsMetadata.forEach((chat, idx) => {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.marginBottom = '6px';
      container.style.backgroundColor = (currentChat?.id === chat.id) ? '#00eaff33' : 'transparent';
      container.style.borderRadius = '8px';
      container.style.padding = '3px';

      const titleSpan = document.createElement('span');
      titleSpan.textContent = chat.name || chat.lastMessageText || `Chat ${idx + 1}`;
      titleSpan.title = chat.lastMessageText;
      titleSpan.style.flex = '1';
      titleSpan.style.cursor = 'pointer';
      titleSpan.onclick = async () => {
        await loadChatHistory(currentUser.uid, chat.id);
        renderChatBox(currentChat.history);
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      const renameBtn = document.createElement('button');
      renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
      renameBtn.title = 'Rename';
      renameBtn.style.margin = '0 6px 0 8px';
      renameBtn.onclick = async (e) => {
        e.stopPropagation();
        const newName = prompt("Rename chat:", chat.name || `Chat ${idx + 1}`);
        if (newName) {
          await updateDoc(doc(db, 'users', currentUser.uid, 'chats', chat.id), { name: newName.trim() });
          await loadUserChatsMetadata(currentUser.uid);
          renderChatsListSidebar();
        }
      };

      const delBtn = document.createElement('button');
      delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.title = 'Delete';
      delBtn.style.marginLeft = '6px';
      delBtn.onclick = async (e) => {
        e.stopPropagation();
        await deleteChat(chat.id);
      };

      const openBtn = document.createElement('button');
      openBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
      openBtn.title = 'Open Chat';
      openBtn.onclick = async (e) => {
        e.stopPropagation();
        await loadChatHistory(currentUser.uid, chat.id);
        renderChatBox(currentChat.history);
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      container.appendChild(titleSpan);
      container.appendChild(renameBtn);
      container.appendChild(delBtn);
      container.appendChild(openBtn);
      chatsListEl.appendChild(container);
    });
  }

  if (newChatBtn) {
    newChatBtn.addEventListener('click', startNewChat);
  }

  // Removed renderChatSelector as we rely on the sidebar list now

  const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

  function inlineMarkdown(t = '') {
    // ... (inlineMarkdown remains the same)
    let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`);
    s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
    s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return s.replace(/\n/g, '<br>');
  }

  function renderMarkdown(text = '') {
    // ... (renderMarkdown remains the same)
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    text = text || '';
    text.replace(codeBlockRegex, (match, lang, code, offset) => {
      const before = text.slice(lastIndex, offset);
      html += inlineMarkdown(before);
      const language = (lang || '').toLowerCase().trim();
      const safe = escapeHTML(code);
      html += `<pre><button class="copy-btn">Copy</button><code class="language-${language || 'plaintext'}">${safe}</code></pre>`;
      lastIndex = offset + match.length;
      return match;
    });
    html += inlineMarkdown(text.slice(lastIndex));
    return { html };
  }

  function enhanceCodeBlocks(container) {
    // ... (enhanceCodeBlocks remains the same)
  }

  function renderChatBox(messages = []) {
    if (!chatBox) return;
    chatBox.innerHTML = '';
    let aiMsgIdx = 0; // Index for AI messages only, used for regeneration tracking

    (messages || []).forEach((msg, idx) => {
      const div = document.createElement('div');
      div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'ai');

      let innerHtml = '';
      if (msg.role === 'user') {
        // Files now use the summary/url from the stored message object
        const fileHtml = (msg.files || [])
          .map(file => {
            const fileUrl = file.summary || file.url; // Use summary/url field
            if (!fileUrl) return ''; 
            
            if (file.type.startsWith('image/')) {
              return `<img src="${fileUrl}" alt="${file.name}" class="chat-media-preview image-preview-thumb">`;
            } else if (file.type.startsWith('video/')) {
              return `<video src="${fileUrl}" controls class="chat-media-preview video-preview-thumb"></video>`;
            } else if (file.type.startsWith('audio/')) {
              return `<audio src="${fileUrl}" controls class="chat-media-preview audio-preview-thumb"></audio>`;
            } else {
              // For PDF or other files, show the link
              return `<a href="${fileUrl}" target="_blank" class="chat-media-preview file-link"><i class="fa-solid fa-file"></i> ${escapeHTML(file.name)}</a>`;
            }
          })
          .join('');
        
        innerHtml = `<div class="msg">
          ${fileHtml ? `<div class="file-attachments">${fileHtml}</div>` : ''}
          ${escapeHTML(msg.text || '')}
          <div class="user-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
            <button class="inline-edit-btn" title="Edit"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
            <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i> Copy</button>
          </div>
        </div>`;
        div.setAttribute('data-useridx', idx);
      } else { // AI message
        const { html } = renderMarkdown(msg.text || '');
        innerHtml = `<div class="msg">${html}
          <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
            <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i> Copy</button>
            <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i> Share</button>
            <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i> Regenerate</button>
          </div>
        </div>`;
        div.setAttribute('data-aiidx', aiMsgIdx++);
      }
      
      div.innerHTML = innerHtml;
      chatBox.appendChild(div);
    });
    enhanceCodeBlocks(chatBox);
    hookAiMsgControls();
    hookUserMsgControls();
    setTimeout(() => {
      const last = chatBox.lastElementChild;
      if (last) last.scrollIntoView({ behavior: "smooth", block: "end" });
    }, 20);
  }

  // --- UPDATED Regenerate Logic ---
  async function regenerateMessage(aiMsgIndex) {
    if (!currentChat || !currentUser) return;
    
    const history = currentChat.history;
    let aiMsgIndexInHistory = -1;
    let aiMsgCount = 0;
    
    // Find the index of the AI message we are regenerating
    for (let i = 0; i < history.length; i++) {
        if (history[i].role === "ai") {
            if (aiMsgCount === aiMsgIndex) { aiMsgIndexInHistory = i; break; }
            aiMsgCount++;
        }
    }
    
    if (aiMsgIndexInHistory < 1 || history[aiMsgIndexInHistory - 1].role !== 'user') {
        alert("Cannot regenerate: the previous message must be a user prompt.");
        return;
    }

    const userMsgObj = history[aiMsgIndexInHistory - 1];
    const userMsg = userMsgObj.text;
    
    // 1. Delete the last user message and the AI response from Firestore (simplified client-side history splice)
    // NOTE: This is client-side state manipulation. A full solution would use Firestore batch deletes.
    const userMsgId = userMsgObj.id;
    const aiMsgId = history[aiMsgIndexInHistory].id;
    
    await deleteDoc(doc(db, 'users', currentUser.uid, 'chats', currentChat.id, 'messages', aiMsgId));
    await deleteDoc(doc(db, 'users', currentUser.uid, 'chats', currentChat.id, 'messages', userMsgId));

    // Refetch history and re-render to reflect the deletion
    await loadChatHistory(currentUser.uid, currentChat.id);
    renderChatBox(currentChat.history);
    
    // 2. Re-send the User Message (This handles adding the message to Firestore again)
    // and trigger the AI generation
    await chatSubmitHandler(userMsg, true);
  }

  function hookAiMsgControls() {
    if (!chatBox) return;
    chatBox.querySelectorAll('.chat-message.ai').forEach(div => {
      const aiIdx = Number(div.getAttribute('data-aiidx'));
      const controls = div.querySelector('.ai-msg-controls');
      if (!controls) return;
      const copyBtn = controls.querySelector('.inline-copy-btn');
      const shareBtn = controls.querySelector('.inline-share-btn');
      const regenBtn = controls.querySelector('.regen-btn');

      if (copyBtn) copyBtn.onclick = () => {
        try {
          const aiOnly = (currentChat?.history || []).filter(m => m.role === "ai") || [];
          const text = aiOnly[aiIdx]?.text || "";
          navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
          copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
          setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copy", 950);
        } catch (e) { console.warn('copy failed', e); }
      };

      if (shareBtn) shareBtn.onclick = () => {
        // ... (share logic remains the same)
      };

      if (regenBtn) regenBtn.onclick = () => regenerateMessage(aiIdx);
    });
  }

  // --- UPDATED Edit Logic ---
  function hookUserMsgControls() {
    if (!chatBox) return;
    chatBox.querySelectorAll('.chat-message.user').forEach(div => {
      const userIdx = Number(div.getAttribute('data-useridx'));
      const controls = div.querySelector('.user-msg-controls');
      if (!controls) return;
      const copyBtn = controls.querySelector('.inline-copy-btn');
      const editBtn = controls.querySelector('.inline-edit-btn');

      if (copyBtn) copyBtn.onclick = () => {
        // ... (copy logic remains the same)
      };
      
      if (editBtn) editBtn.onclick = async () => {
        if (!currentChat || !currentUser) return;
        try {
          const history = currentChat.history;
          const userMsgObj = history[userIdx];
          if (userMsgObj.role !== 'user') return;

          // 1. Put the message text into the input field
          chatInput.value = userMsgObj.text;
          chatInput.focus();

          // 2. Determine the message range to delete (user message + its AI reply)
          const messagesToDelete = [userMsgObj];
          const nextMsg = history[userIdx + 1];
          if (nextMsg && nextMsg.role === 'ai') {
              messagesToDelete.push(nextMsg);
          }

          // 3. Delete from Firestore
          for (const msg of messagesToDelete) {
              await deleteDoc(doc(db, 'users', currentUser.uid, 'chats', currentChat.id, 'messages', msg.id));
          }

          // 4. Reload and Re-render
          await loadChatHistory(currentUser.uid, currentChat.id);
          renderChatBox(currentChat.history);

        } catch (e) { console.warn('Edit failed', e); }
      };
    });
  }
  // -----------------------------

  function showTypingAtNext() {
    // ... (showTypingAtNext remains the same)
  }

  function removeTyping() {
    // ... (removeTyping remains the same)
  }

  async function typeBotMessage(text) {
    // ... (typeBotMessage remains the same, but remove saveChats/renderChatSelector)
    // The message is added and saved inside the chatSubmitHandler below.
    removeTyping();
    if (!chatBox) return;

    const div = document.createElement('div');
    div.className = "chat-message ai";
    const msgdiv = document.createElement('div');
    msgdiv.className = 'msg';
    div.appendChild(msgdiv);
    chatBox.appendChild(div);

    let sofar = '';
    const words = text.split(' ');

    for (const word of words) {
      if (currentController?.signal.aborted) {
        break;
      }
      sofar += word + ' ';
      msgdiv.innerHTML = renderMarkdown(sofar).html;
      chatBox.scrollTop = chatBox.scrollHeight;
      await new Promise(res => setTimeout(res, 35 + Math.random() * 20));
    }
    
    msgdiv.innerHTML = renderMarkdown(text).html + `
      <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
          <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i> Copy</button>
          <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i> Share</button>
          <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i> Regenerate</button>
      </div>
    `;
    enhanceCodeBlocks(msgdiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Add the message to Firestore and update local state
    await addMessageToChat('ai', text, []); 
    hookAiMsgControls();
  }

  function renderFilePreview() {
    // ... (renderFilePreview remains the same)
  }

  function showAIImagePreview(base64, caption = '') {
    // ... (showAIImagePreview remains the same)
  }

  function showTypingWithText(text) {
    // ... (showTypingWithText remains the same)
  }

  async function handleVideoGeneration(payload, isImageToVideo = false) {
    // ... (handleVideoGeneration remains the same)
  }

  const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
  const toolDefinitions = {
    // ... (toolDefinitions remain the same, relying on addMessageToChat/typeBotMessage for output)
    // NOTE: All tool outputs now call typeBotMessage(resultText), which saves the message to Firestore.
  };

  if (toolsMenu) {
    // ... (toolsMenu logic remains the same)
  }

  function displayToolForm(toolKey) {
    // ... (displayToolForm remains the same)
  }

  /* ---------- MAIN CHAT SUBMIT HANDLER (UPDATED for Firestore) ---------- */
  async function chatSubmitHandler(msgTextOverride = null, isRegen = false) {
    const msgText = msgTextOverride !== null ? msgTextOverride.trim() : chatInput.value.trim();
    if (!msgText && uploadedFiles.length === 0) return;
    if (!currentUser) return;

    const stopButton = document.createElement('button');
    stopButton.type = 'button';
    stopButton.id = 'stopBtn';
    stopButton.innerHTML = '<i class="fa-solid fa-stop"></i>';
    stopButton.style.color = '#ff6b6b';
    sendBtn.replaceWith(stopButton);

    currentController = new AbortController();
    const signal = currentController.signal;
    let finalResponse = '';

    stopButton.addEventListener('click', () => {
      if (currentController) {
        currentController.abort();
      }
    });
    
    let isNewChat = !currentChat?.id;

    if (uploadedFiles.length > 0) {
      const filesToProcess = [...uploadedFiles];
      const filesForHistory = filesToProcess.map(file => ({ name: file.name, type: file.type, url: URL.createObjectURL(file) }));
      await addMessageToChat('user', msgText, filesForHistory, isNewChat);
      chatInput.value = ''; 
      uploadedFiles = []; 
      renderFilePreview();
      showTypingWithText('Analyzing your file(s)...');
      
      let endpoint = '';
      const file = filesToProcess[0];
      if (file.type.startsWith('image/')) endpoint = '/understand-image';
      else if (file.type === 'application/pdf') endpoint = '/understand-pdf';
      else if (file.type.startsWith('audio/')) endpoint = '/understand-audio';
      else if (file.type.startsWith('video/')) endpoint = '/understand-video';
      else { removeTyping(); finalResponse = "Sorry, I can't analyze that file type."; }
      
      try {
        if(endpoint) {
          const fd = new FormData();
          fd.append('prompt', msgText || `Describe this ${file.type.split('/')[0]}`);
          fd.append('file', file);
          const res = await fetch(API_BASE_URL + endpoint, { method: 'POST', body: fd, signal });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Analysis failed.");
          finalResponse = data.response;
        }
      } catch (err) {
        finalResponse = err.name === 'AbortError' ? 'âŒ File analysis stopped.' : `âŒ File analysis failed: ${err.message}`;
      }
    } else if (msgText) {
      if (!isRegen) { // Only add message if it's NOT a regen (regen handles history manipulation separately)
          await addMessageToChat('user', msgText, [], isNewChat);
          chatInput.value = '';
      }
      showTypingAtNext();
      try {
        // Construct history from currentChat state
        const history = currentChat.history
                         .filter(m => m.role === 'user' || m.role === 'ai')
                         .map(m => ({ role: m.role, content: m.text || '' }));
                         
        // Ensure the last message is the current user's prompt (if it wasn't filtered out by regen)
        const apiHistory = history.slice(0, -1); 
        
        const res = await fetch(`${API_BASE_URL}/chat`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ message: msgText, history: apiHistory, user_id: currentUser?.uid || "user" }), 
            signal 
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Server error.");
        
        // Check for structured media response from the API
        if (data.media_type === 'image' && data.image_b64) {
             showAIImagePreview(data.image_b64, data.response_text);
             finalResponse = data.response_text || 'An image has been generated.';
        } else if (data.media_type === 'audio' && data.audio_url) {
             finalResponse = data.response_text + `<br><audio controls src="${data.audio_url}" class="chat-media-preview audio-preview-thumb"></audio>`;
        } else if (data.media_type === 'video' && data.video_url) {
             finalResponse = data.response_text + `<br><video controls src="${data.video_url}" class="chat-media-preview video-preview-thumb"></video>`;
        } else {
             // Standard text response
             finalResponse = data.response;
        }

      } catch (err) {
        finalResponse = err.name === 'AbortError' ? 'âŒ Response stopped.' : `âŒ An error occurred: ${err.message}`;
      }
    }

    removeTyping();
    if (finalResponse) {
      await typeBotMessage(finalResponse);
    }
    stopButton.replaceWith(sendBtn);
    currentController = null;
  }

  // Hook the submit handler
  chatForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    await chatSubmitHandler();
  });


  // Final initial render (Moved to onAuthStateChanged)
  if(chatInput) chatInput.focus();
  
}); // end DOMContentLoaded
</script>
</body>
</html>


<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>
