<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Philadelphia AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
  <style>
:root {
  --cyan: #00fff7;
  --blue: #0a8afe;
  --dark-bg: #070b1a;
  --fade-blue: #133c8b;
  --gradient-1: linear-gradient(120deg, #000a2e 39%, #04336a 68%, #10bfff 97%);
  --gradient-user: linear-gradient(120deg, #0857ee 32%, #00fff0 89%);
  --glass: rgba(25, 38, 67, 0.82);
  --bubble-glow: 0 0 13px #00d8ffb1, 0 0 24px #0197ff40;
  --user-glow: 0 0 22px #0fffd555, 0 0 14px #36f9ff70;
  --header-glass: rgba(17,29,47,0.92);
  --code-bg: linear-gradient(92deg,#031d39 79%,#092ff8 120%);
  --code-border: #15faff;
  --code-text: #17fafd;
}
/* -- BG & Star Layer -- */
html, body {
  height: 100vh; width: 100vw; margin: 0; padding: 0;
  color: #e1fafe;
  background:
    radial-gradient(circle at 60% 45%, #112250 37%, #060e1e 88%, #1e0942 100%) fixed,
    repeating-linear-gradient(100deg,#061c4c 0 9%,#080e20 16% 19%,#030721 30% 41%,#052650 44% 62%,#050b16 74% 89%,#041048 99% 100%);
  background-blend-mode: lighten, color-dodge;
  font-family: 'Roboto','Inter',system-ui,-apple-system,Segoe UI,sans-serif;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}
body { overflow: hidden; min-height: 100vh; width: 100vw; }
#stars-container {
  pointer-events: none;
  position: fixed; left:0; top:0;right:0;bottom:0;
  width:100vw; height:100vh; z-index:1;
  overflow: hidden;
}
.star {
  position:absolute;
  background: #08ecff;
  box-shadow:0 0 12px #00fff9cc,0 0 22px #1bf2f2cc;
  opacity: 0.23;
  border-radius: 50%;
  pointer-events: none;
  animation: star-twinkle 2.7s infinite alternate;
}
@keyframes star-twinkle {
  0% { opacity:.18; }
  41% { opacity:.88; }
  100%{ opacity:.09;}
}

/* -- Neon Header/Sticky Keyboard -- */
.header-bar {
  position: fixed; top: 0; left: 0; width: 100vw;
  display: flex; align-items: center; justify-content: space-between;
  background: var(--header-glass);
  z-index: 1003;
  padding: 0;
  box-shadow: 0 7px 48px #00aaff27, 0 3px 41px #09fcfe15;
  border-radius: 0 0 22px 22px;
  height: 70px;
}
.menu-btn {
  background: none; border: none;
  color: var(--cyan); font-size: 1.8em; cursor: pointer;
  border-radius: 14px; margin-left: 17px; margin-right: 3px;
  padding: 7px 11px;
}
.menu-btn:hover { background: #00eaff28; color: #fff; }
.site-heading {
  font-family: 'Orbitron',sans-serif;
  font-size: 1.28em; font-weight: 700;
  text-align: center; flex: 1;
  letter-spacing: .27px;
  white-space:nowrap;
  background: linear-gradient(90deg,#00fff1,#00b4ff 40%,#fff 59%,#1093f1 89%,#24e0fa 100%);
  background-size: 250% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: neonglow 4.2s ease-in-out infinite alternate;
  text-shadow: 0 0 12px #00ffe0cc, 0 0 27px #178fcf88;
  user-select: none; margin-left: 8px; margin-right: 10px;
}
@keyframes neonglow {
  0% { text-shadow: 0 0 17px #00e7ff70,0 0 30px #0b8fff44;}
  100% { text-shadow: 0 0 29px #00ffe9ee,0 0 44px #31d2ff82;}
}
.header-welcome {
  color: #68e6fd; font-size: .97em; margin: -2px 0 .7em 0; text-align: center;
  text-shadow: 0 0 14px #00bcb4a8;
}

.main-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow: hidden;
    position: relative;
    padding-top: 70px;
    padding-bottom: 86px;
    box-sizing: border-box;
}

/* -- Chat area -- */
.chat-box {
  flex: 1 1 0px; 
  overflow-y: auto;
  overflow-x: hidden;
  width: 100%; max-width: 635px; margin: 0 auto;
  box-sizing: border-box;
  padding: 15px 8px 40px 8px;
  position: relative;
  z-index:3;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
}
.chat-message {
  width: 100%; display: flex; gap:9px; align-items: flex-end;
  margin: 8px 0; max-width:100%;
  flex-shrink: 0;
}
.chat-message .msg {
  font-size: 1.01em; line-height: 1.58;
  width: fit-content;
  max-width: calc(100% - 70px);
  padding: 11px 16px 12px 15px;
  border-radius: 16px 14px 11px 12px;
  word-break: break-word; white-space: pre-wrap; overflow-x: auto;
  background: var(--gradient-1); color: #e1fafe;
  text-shadow: 0 0 3px #23d8ff15;
  box-shadow: var(--bubble-glow);
  margin-right: auto; margin-left: 0;
  border: 1.2px solid #0090ffa0; position:relative;
  transition:background .15s;
}
.chat-message.user { justify-content: flex-end; }
.chat-message.user .msg {
  background: var(--gradient-user);
  color: #141825; font-weight: 700;
  text-shadow: 0 0 5px #00e0ff77, 0 0 2px #00ffe033;
  border-radius: 17px 13px 15px 11px;
  margin-left: auto; margin-right: 0;
  box-shadow: var(--user-glow);
  border: 1.2px solid #04eef4c9;
}
@media (max-width:790px) {
  .chat-box { max-width:100vw; padding: 15px 4px 40px 4px; }
  .chat-message .msg { font-size: .97em; padding:9px 4vw 10px 5vw; max-width:80vw;}
  .chat-message.user .msg { max-width: 83vw; }
}

/* -- Typing Dots -- */
.typing-bubble {
  display: inline-flex;
  align-items: center;
  height: 28px;
  padding: 4px 12px;
  margin: 6px 4px;
  border-radius: 15px;
  background: linear-gradient(90deg,#0a4477dd 30%,#0ebfff88 95%);
  box-shadow: 0 2px 12px #0dfcff77;
  border: 1px solid #00ffff55;
}
.dot-anim {
  display:inline-block;
  width: 8px; height: 8px;
  margin:0 3px; 
  background: #05fff9;
  border-radius: 50%;
  opacity: 0.85;
  animation: typing-blink 1.4s infinite both;
  box-shadow: 0 0 6px #05fff9aa;
}
.dot-anim:nth-child(2){animation-delay:.3s;}
.dot-anim:nth-child(3){animation-delay:.6s;}
@keyframes typing-blink {
  0%,100% {opacity:.25; transform: scale(0.8);}
  25%  {opacity:.95; transform: scale(1.1);}
  50%  {opacity:1; transform: scale(1.2);}
  75%  {opacity:.65; transform: scale(1);}
}

/* -- Code block & Copy button -- */
pre, code {
  font-family: 'JetBrains Mono','Fira Mono','Menlo',monospace;
  font-size: .99em;
  background: var(--code-bg);
  border-radius: 11px;
  border: 1.7px solid var(--code-border);
  color: var(--code-text);
  box-shadow: 0 0 19px #00eaff38, 0 0 48px #0beaff38 inset;
}
pre {
  overflow-x: auto;
  padding: 1.18em 1.3em 1.16em 1.13em;
  margin: 1.15em 0 1em 0; position: relative;
}
.copy-btn {
  position: absolute; top: 10px; right: 13px; z-index: 3;
  border-radius: 8px; border: none; padding: 3px 15px;
  background: linear-gradient(95deg,#0cf3ff 40%,#0980ff 120%);
  color: #06182f; font-size: .98em; font-family: 'Inter'; font-weight: bold;
  box-shadow: 0 2px 9px #18e3ffc5,0 0 7px #00ffd7a4;
  cursor: pointer;
}

/* -- Message Controls -- */
.inline-copy-btn, .inline-share-btn, .regen-btn, .inline-edit-btn {
  padding:4px 10px; border-radius:7px; border:none;
  background:linear-gradient(94deg,#00fff6,#0090ff 97%);
  color:#0f1a31; font-family:'Inter',Arial,sans-serif; font-size:.96em;
  font-weight:600; display:inline-flex; align-items:center; gap:4px; 
  margin-top:6px; margin-right: 3px; cursor:pointer;
  box-shadow:0 2px 7px #17f6fe51;transition:background .14s,color .13s;
}
.inline-copy-btn:hover, .inline-share-btn:hover, .regen-btn:hover, .inline-edit-btn:hover{background:#009cff; color:#fff;}

/* -- File Preview -- */
.file-preview{
  display:none;
  align-items: center;
  gap: 10px;
  background:rgba(15,36,65,0.98);
  border-radius:12px;color:#c4f2ff;font-size:.98em;
  box-shadow:0 3px 15px #00aac0bb;
  margin:0 auto 10px auto;width:94%;max-width:635px;
  padding:10px 14px 10px 15px;
  position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
  z-index: 1002;
  border: 1.5px solid #00ffff44;
}
.file-preview img, .file-preview video { max-width:58px;max-height:41px;border-radius:6px;margin-right:6px;vertical-align: middle; }
.remove-file-btn { color: #fff !important; background:#d23 !important; border:none !important; border-radius:50% !important; padding:2px 6px !important; cursor:pointer !important; font-size:1.2em !important; font-weight:bold !important; margin-left:8px !important; transition: background .16s !important; min-width: 24px !important; height: 24px !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; }
.remove-file-btn:hover { background:#ff4444 !important; transform: scale(1.1) !important; }

/* -- NEW: In-Chat Media Display -- */
.msg .chat-media-image { max-width: 100%; border-radius: 12px; margin-top: 8px; cursor: pointer; }
.msg .chat-media-video, .msg .chat-media-audio { width: 100%; max-width: 350px; border-radius: 12px; margin-top: 8px; }
.msg .chat-media-file {
    display: inline-flex; align-items: center; gap: 10px;
    background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-top: 8px;
    color: #9eefff; text-decoration: none; border: 1px solid #00a2ff55;
}
.msg .chat-media-file:hover { background: rgba(0,0,0,0.4); }
.msg .chat-media-file i { font-size: 1.5em; color: var(--cyan); }

/* -- IMPROVED: Sticky Footer/Keyboard -- */
.chat-input-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    background: rgba(17,29,47,0.94);
    backdrop-filter: blur(8px);
    border-top: 1.5px solid #1af8ff51;
    z-index: 1003;
    box-shadow: 0 0 39px #007fff22, 0 11px 33px #00fff014;
    padding: 9px 12px 10px 13px;
    box-sizing: border-box;
    border-radius: 23px 23px 0 0;
}
.chat-input-row {
  display: flex; align-items: stretch; gap: 8px;
  width: 100%;
  max-width: 635px; /* Match chat box max-width */
}
.chat-input-row textarea{
  flex:1 1 auto;resize:none;min-height:36px;max-height:120px;
  background:#09284c;color:#f5ffff;font-size:1em;
  padding:10px 12px;border:none;border-radius:11px;
  box-shadow:0 1px 6px #00f2ff27;
}
.chat-input-row button, .chat-input-row label{
  background:none;border:none;color:#07eaff;font-size:1.3em;
  cursor:pointer;border-radius:10px;transition:color .13s,background .15s;padding:0;
  display:flex;align-items:center;justify-content:center;min-width:40px;
  box-shadow: 0 0 3px #00eaff20;
}
.chat-input-row button:hover, .chat-input-row label:hover{color:#fff;background:#00cdf247;}

/* -- Emoji panel -- */
#emojiPanel {
  display:none;
  position: fixed;
  left:10px;
  bottom:110px;
  z-index:2222;
  background: #051f46f9;
  border-radius: 15px;
  padding: 16px;
  box-shadow: 0 5px 22px #00fff194;
  border: 1px solid #00ffff66;
  max-width: 280px;
}
.emoji-pick { font-size:1.3em; cursor:pointer; padding:5px; border-radius:10px; transition:background .13s; user-select:none; display: inline-block; }
.emoji-pick:hover { background:#35cdfd66; }

/* -- Status message -- */
.status-message{padding:6px 13px;color:#12ffc7;font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;}

/* -- Panel styles -- */
.panel-bg { display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(13,20,52,0.86);z-index:1200; }
.panel-bg.active{display:block;}
.side-panel{position:absolute;top:0;left:-350px;height:100vh;width:325px;background:linear-gradient(118deg,#131642 80%,#1629af 200%);border-right:2.5px solid #00fbffcb;box-shadow:0 0 42px #25f8ffc9;z-index:1212;
  padding:18px 16px 20px 15px;overflow-y:auto;border-radius:0 24px 32px 0; transition: left 0.3s ease-in-out;}
.panel-bg.active .side-panel { left: 0; }
.side-panel .panel-header{text-align:center;margin:18px 0 13px 0;}
.side-panel img{width:56px;height:56px;border-radius:53%;margin-bottom:8px;border:2px solid #31f6ffea;}
.side-panel .username{font-weight:700;font-size:1.11em;color:#08d0fe;font-family:'Orbitron',sans-serif;text-shadow:0 0 8px #00eaffbb;}
.panel-links a{color:#13efff;text-decoration:none;font-weight:500;font-size:1.08em;padding:8px 4px;display:block;border-radius:9px;transition:background .14s;}
.panel-links a:hover{background:#00eaff55;color:#f4fdff;}

#chatsList button { background: none; border: none; cursor: pointer; color: #00d9ff; font-size: 1.1em; padding: 4px; border-radius: 5px; }
#chatsList button:hover { background: #00eaff33; }
#chatsList .delete-btn { color: #ff3d67; }

.submit-btn{
  margin-top:14px; padding:10px 20px;
  background:linear-gradient(94deg,#00ffff,#0090ff 90%);
  border:none; border-radius:10px;
  color:#102649; font-weight:bold; cursor:pointer; font-size:1.11em;
  box-shadow:0 2px 13px #00fff292; transition:background .14s,color .13s;}
.submit-btn:hover{background:#008cff;color:#fff;}
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="main-content">
    
    <header class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <div class="header-titles">
        <h1 class="site-heading">🦅Philadelphia AI🦅</h1>
        <div class="header-welcome" id="headerWelcome"></div>
      </div>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </header>

    <main class="chat-box" id="chatBox"></main>

    <div id="filePreview" class="file-preview"></div>

    <div class="chat-input-container">
      <form class="chat-input-row" id="chatForm" autocomplete="off">
        <button type="button" id="emojiBtn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
        <label for="chatFile" class="file-upload-btn" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
        <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" style="display:none">
        <textarea id="chatInput" placeholder="Type here… (Shift+Enter = new line)" rows="1"></textarea>
        <button type="button" id="toolBtn" title="Philadelphia Tools" aria-controls="toolMenu" aria-expanded="false"><i class="fa-solid fa-wrench"></i></button>
        <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
      </form>
    </div>

  </div>
  
  <div id="emojiPanel"></div>
  <div class="status-message" id="statusMsg"></div>
  
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:1.17em;font-weight:700;color:#00ffff;margin:18px 0 0 13px;">Chats</span>
        <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="document.getElementById('profileMenuBg').classList.remove('active');">&times;</button>
      </div>
      <div id="chatsList" style="margin:7px 0 8px 6px;max-height:200px;overflow-y:auto;"></div>
      <button id="newChatBtn" class="submit-btn" style="margin:0 0 12px 11px;"><i class="fa-solid fa-plus"></i> New Chat</button>
      <hr style="width:91%;margin:11px 0 7px 3%;border:1px solid #00fff031;">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 6px;">
        <label for="edit-name">Name</label><input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label><input type="url" id="edit-photo" placeholder="Paste image link">
        <span style="font-size:0.83em;color:#aae;display:block;margin:5px 0 7px 2px;">Tip: <a href="https://postimg.cc/" target="_blank" style="color:#19fcff;">Upload at postimg.cc</a></span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">Logout</button>
    </nav>
  </div>
    
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
       <div style="display:flex; align-items:center; justify-content:flex-end;">
         <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="document.getElementById('linkMenuBg').classList.remove('active');">&times;</button>
      </div>
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
        <div class="username">Philadelphia AI</div>
      </div>
      <div class="panel-links">
        <a href="#"><i class="fa-solid fa-home"></i> Home</a>
        <a href="#"><i class="fa-solid fa-circle-info"></i> About</a>
        <a href="#"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="#"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </nav>
  </div>

  <div class="panel-bg" id="toolsMenuBg">
    <nav class="side-panel" id="toolsMenu">
      <div style="display:flex; align-items:center; justify-content:flex-end;">
         <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="document.getElementById('toolsMenuBg').classList.remove('active');">&times;</button>
      </div>
        <div class="panel-header" style="text-align:center;">
            <div class="username" style="font-size:1.2em;">Philadelphia AI Tools</div>
        </div>
        <div class="panel-links">
            <a href="#" class="tool-link" data-tool="research"><i class="fa-solid fa-magnifying-glass"></i> Research</a>
            <a href="#" class="tool-link" data-tool="image"><i class="fa-solid fa-image"></i> Generate Image</a>
            <a href="#" class="tool-link" data-tool="comic"><i class="fa-solid fa-book-open"></i> Create Comic</a>
            <a href="#" class="tool-link" data-tool="website"><i class="fa-solid fa-globe"></i> Create Website</a>
            <a href="#" class="tool-link" data-tool="remove-bg"><i class="fa-solid fa-wand-magic-sparkles"></i> Remove Background</a>
            <a href="#" class="tool-link" data-tool="voice-gen"><i class="fa-solid fa-microphone-lines"></i> Generate Voice</a>
            <a href="#" class="tool-link" data-tool="audio-narration"><i class="fa-solid fa-file-audio"></i> Audio Narration</a>
        </div>
    </nav>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script type="module">
// Firebase SDKs
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, deleteDoc, updateDoc, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// Short helper
const $ = id => document.getElementById(id);

// ---------- Global State ----------
let currentUser = null;
let chats = []; // local cache of chat metadata
let currentChatId = null; // The ID of the currently active chat
let unsubscribeChatHistory = null; // To stop listening to Firestore updates
let uploadedFiles = [];
let activeTool = { name: null, step: 0, data: {} }; // For conversational tools

// ---------- DOM Elements ----------
const chatBox = $('chatBox');
const chatForm = $('chatForm');
const chatInput = $('chatInput');
const chatFile = $('chatFile');
const filePreview = $('filePreview');
const chatsListEl = $('chatsList');

// ---------- UI & Panel Handlers ----------
function setupUI() {
  // Stars background
  const starsContainer = $('stars-container');
  if (starsContainer) {
    starsContainer.innerHTML = '';
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  // Panel toggles
  const setupPanel = (bgId, openBtnId) => {
    const bg = $(bgId);
    const openBtn = $(openBtnId);
    if (!bg || !openBtn) return;
    openBtn.onclick = () => bg.classList.add('active');
    bg.onclick = (e) => { if (e.target === bg) bg.classList.remove('active'); };
  };
  setupPanel('profileMenuBg', 'openProfileMenu');
  setupPanel('linkMenuBg', 'openLinksMenu');
  setupPanel('toolsMenuBg', 'toolBtn');
  
  $('logoutBtn').addEventListener('click', () => {
    auth.signOut().then(() => { window.location.href = 'signup-login.html'; });
  });

  // Textarea auto-resize
  chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
  });
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); chatForm.requestSubmit(); }
  });

  // File preview logic
  chatFile.addEventListener('change', function() {
    uploadedFiles = Array.from(this.files);
    renderFilePreview();
  });

  // Tool selection
  document.querySelectorAll('.tool-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      $('toolsMenuBg').classList.remove('active');
      handleToolSelection(link.getAttribute('data-tool'));
    });
  });
  
  // Emoji Panel
  const emojis = ["😀","😃","😂","🤣","😍","🥰","😎","👍","🙏","🔥","💯","🎉","😇","🫶","😜","🤖","👀"];
  const emojiBtn = $('emojiBtn');
  const emojiPanel = $('emojiPanel');
  if(emojiBtn && emojiPanel) {
      emojiBtn.addEventListener('click', () => {
          emojiPanel.innerHTML = emojis.map(em => `<span class="emoji-pick">${em}</span>`).join('');
          emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
          emojiPanel.querySelectorAll('.emoji-pick').forEach(span => {
              span.onclick = () => {
                  chatInput.value += span.textContent;
                  emojiPanel.style.display = 'none';
                  chatInput.focus();
              }
          })
      });
      document.addEventListener('click', e => {
        if (!emojiPanel.contains(e.target) && e.target !== emojiBtn && !emojiBtn.contains(e.target)) {
            emojiPanel.style.display = 'none';
        }
    });
  }
}

// ---------- Firebase & Chat Logic ----------
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    updateProfileUI(user);
    loadUserChats();
  } else {
    // Redirect to login if on a protected page
    if(!window.location.pathname.includes('signup-login.html')) {
        window.location.href = "signup-login.html";
    }
  }
});

function updateProfileUI(user) {
  $('headerWelcome').textContent = `Welcome, ${user.displayName || user.email.split('@')[0]}`;
  $('profileMenuUser').textContent = user.displayName || "User";
  $('profileMenuEmail').textContent = user.email || "";
  $('edit-name').value = user.displayName || "";
  $('edit-photo').value = user.photoURL || "";
  $('profilePicPreview').src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
}

$('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const status = $('profileStatusMsg');
  status.textContent = 'Saving...';
  try {
    await updateProfile(currentUser, { 
      displayName: $('edit-name').value.trim(), 
      photoURL: $('edit-photo').value.trim() 
    });
    status.textContent = "Profile updated!"; status.style.color = "#00ffff";
    setTimeout(() => $('profileMenuBg').classList.remove('active'), 800);
  } catch (err) {
    status.textContent = `Error: ${err.message}`; status.style.color = "#ff4444";
  }
});

function loadUserChats() {
  const chatsColRef = collection(db, `users/${currentUser.uid}/chats`);
  const q = query(chatsColRef, orderBy('createdAt', 'desc'));
  onSnapshot(q, (snapshot) => {
    chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderChatsListSidebar();
    if (!currentChatId && chats.length > 0) {
      switchToChat(chats[0].id);
    } else if (chats.length === 0) {
      createNewChat();
    }
  });
}

async function createNewChat() {
  const chatsColRef = collection(db, `users/${currentUser.uid}/chats`);
  const newChat = {
    name: "New Chat",
    createdAt: serverTimestamp()
  };
  const docRef = await addDoc(chatsColRef, newChat);
  switchToChat(docRef.id);
  $('profileMenuBg').classList.remove('active');
}

$('newChatBtn').addEventListener('click', createNewChat);

function switchToChat(chatId) {
  if (currentChatId === chatId) return;
  currentChatId = chatId;
  renderChatsListSidebar(); // Re-render to highlight active chat
  
  if (unsubscribeChatHistory) {
    unsubscribeChatHistory();
  }

  const historyColRef = collection(db, `users/${currentUser.uid}/chats/${chatId}/history`);
  const q = query(historyColRef, orderBy('createdAt'));
  
  unsubscribeChatHistory = onSnapshot(q, (snapshot) => {
    const messages = snapshot.docs.map(doc => doc.data());
    renderChatBox(messages);
  });
}

// ---------- Chat Rendering & Helpers ----------
const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

function renderMarkdown(text = '') {
    const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    text = text || '';
    
    const inline = t => String(t)
        .replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>')
        .replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>')
        .replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`)
        .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
        .replace(/\n/g, '<br>');

    text.replace(codeBlockRegex, (match, lang, code, offset) => {
      const before = text.slice(lastIndex, offset);
      html += inline(before);
      const safeCode = escapeHTML(code);
      html += `<pre><button class="copy-btn">Copy</button><code class="language-${lang || 'plaintext'}">${safeCode}</code></pre>`;
      lastIndex = offset + match.length;
      return match;
    });
    html += inline(text.slice(lastIndex));
    return html;
}

function renderChatBox(messages = []) {
  chatBox.innerHTML = '';
  messages.forEach(msg => {
    const div = document.createElement('div');
    div.className = `chat-message ${msg.role}`;
    const msgDiv = document.createElement('div');
    msgDiv.className = 'msg';

    let contentHTML = '';
    if (msg.fileURL) {
      const { fileURL, fileType, fileName } = msg;
      if (fileType.startsWith('image/')) {
        contentHTML += `<img src="${fileURL}" alt="${fileName || 'Uploaded image'}" class="chat-media-image">`;
      } else if (fileType.startsWith('video/')) {
        contentHTML += `<video src="${fileURL}" controls class="chat-media-video"></video>`;
      } else if (fileType.startsWith('audio/')) {
        contentHTML += `<audio src="${fileURL}" controls class="chat-media-audio"></audio>`;
      } else {
        contentHTML += `<a href="${fileURL}" target="_blank" class="chat-media-file">
                          <i class="fa-solid fa-file-lines"></i>
                          <span>${escapeHTML(fileName || 'Download File')}</span>
                        </a>`;
      }
    }
    if (msg.text) {
        contentHTML += (contentHTML ? '<br>' : '') + renderMarkdown(msg.text);
    }
    
    msgDiv.innerHTML = contentHTML;
    div.appendChild(msgDiv);
    chatBox.appendChild(div);
  });

  chatBox.querySelectorAll('pre .copy-btn').forEach(btn => {
      btn.onclick = () => {
          const code = btn.nextElementSibling.innerText;
          navigator.clipboard.writeText(code);
          btn.textContent = 'Copied!';
          setTimeout(() => { btn.textContent = 'Copy'; }, 1000);
      };
  });
  hljs.highlightAll();

  setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 50);
}

function renderChatsListSidebar() {
    if (!chatsListEl) return;
    chatsListEl.innerHTML = chats.map(chat => `
        <div class="chat-list-item" data-id="${chat.id}" style="display:flex; align-items:center; padding:5px; margin-bottom: 4px; border-radius:8px; cursor:pointer; ${currentChatId === chat.id ? 'background:#00eaff33;' : ''}">
            <span style="flex:1; margin-left: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHTML(chat.name)}</span>
            <button class="rename-btn" title="Rename"><i class="fa-solid fa-pen"></i></button>
            <button class="delete-btn" title="Delete"><i class="fa-solid fa-trash"></i></button>
        </div>
    `).join('');

    chatsListEl.querySelectorAll('.chat-list-item').forEach(item => {
        const id = item.dataset.id;
        item.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            switchToChat(id);
            $('profileMenuBg').classList.remove('active');
        });
        item.querySelector('.rename-btn').onclick = async (e) => {
            e.stopPropagation();
            const currentName = chats.find(c => c.id === id).name;
            const newName = prompt("Rename chat:", currentName);
            if (newName && newName.trim() && newName.trim() !== currentName) {
                await updateDoc(doc(db, `users/${currentUser.uid}/chats/${id}`), { name: newName.trim() });
            }
        };
        item.querySelector('.delete-btn').onclick = async (e) => {
            e.stopPropagation();
            if (confirm("Are you sure you want to delete this chat?")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/chats/${id}`));
                if (currentChatId === id) {
                    currentChatId = null;
                }
            }
        };
    });
}

// ---------- Message Submission ----------
chatForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = chatInput.value.trim();
  const files = [...uploadedFiles];

  if (!text && files.length === 0) return;

  chatInput.value = '';
  chatInput.style.height = 'auto';
  chatInput.focus();
  uploadedFiles = [];
  renderFilePreview();

  // If a conversational tool is active, handle that first.
  if (activeTool.name) {
    await handleToolStep(text, files);
    return;
  }
  
  await sendMessage({ text, files });
});

async function sendMessage({ text = '', files = [], role = 'user' }) {
    if (!currentChatId) {
        alert("No active chat. Please create one first.");
        return;
    }
    const historyColRef = collection(db, `users/${currentUser.uid}/chats/${currentChatId}/history`);

    // --- User Message ---
    const userMessage = { role, text, createdAt: serverTimestamp() };
    if (files.length > 0) {
        showTyping();
        const file = files[0];
        const storageRef = ref(storage, `user_files/${currentUser.uid}/${currentChatId}/${Date.now()}_${file.name}`);
        const snapshot = await uploadBytes(storageRef, file);
        userMessage.fileURL = await getDownloadURL(snapshot.ref);
        userMessage.fileType = file.type;
        userMessage.fileName = file.name;
        removeTyping();
    }
    if (text || userMessage.fileURL) {
        await addDoc(historyColRef, userMessage);
    } else {
        return; // Don't send empty messages
    }

    // --- AI Response ---
    showTyping();
    try {
        const recentHistoryQuery = query(historyColRef, orderBy('createdAt', 'desc'), limit(10));
        const historySnapshot = await getDocs(recentHistoryQuery);
        const history = historySnapshot.docs.map(d => {
            const data = d.data();
            return { role: data.role, content: data.text }; // Adjust for backend expectations
        }).reverse();
        
        // This is a generic chat endpoint. File understanding would need a different logic/endpoint.
        const res = await fetch('https://web-production-9a18.up.railway.app/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, user_id: currentUser.uid, history })
        });
        const data = await res.json();
        
        if (res.ok && data.response) {
            await addDoc(historyColRef, { role: 'ai', text: data.response, createdAt: serverTimestamp() });
        } else {
            throw new Error(data.error || 'Server returned no response.');
        }
    } catch (err) {
        await addDoc(historyColRef, { role: 'ai', text: `❌ Error: ${err.message}`, createdAt: serverTimestamp() });
    } finally {
        removeTyping();
    }
}

// ---------- Typing Indicator ----------
let typingNode = null;
function showTyping() {
  if (typingNode) return;
  typingNode = document.createElement('div');
  typingNode.className = 'chat-message ai';
  typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`;
  chatBox.appendChild(typingNode);
  chatBox.scrollTop = chatBox.scrollHeight;
}
function removeTyping() {
  if (typingNode) {
    typingNode.remove();
    typingNode = null;
  }
}

// ---------- File Preview ----------
function renderFilePreview() {
  if (!uploadedFiles.length) {
    filePreview.style.display = 'none';
    return;
  }
  filePreview.style.display = 'flex';
  const file = uploadedFiles[0];
  let previewHTML = '';
  if (file.type.startsWith('image/')) {
    previewHTML = `<img src="${URL.createObjectURL(file)}" alt="preview">`;
  } else {
    previewHTML = `<i class="fa-solid fa-file" style="font-size:2em;"></i>`;
  }
  filePreview.innerHTML = `
    ${previewHTML}
    <span>${escapeHTML(file.name)}</span>
    <button type="button" class="remove-file-btn">&times;</button>
  `;
  filePreview.querySelector('.remove-file-btn').onclick = () => {
    uploadedFiles = [];
    chatFile.value = '';
    renderFilePreview();
  };
}


// ---------- CONVERSATIONAL TOOLS LOGIC ----------

async function addBotMessage(text) {
    const historyColRef = collection(db, `users/${currentUser.uid}/chats/${currentChatId}/history`);
    await addDoc(historyColRef, { role: 'ai', text, createdAt: serverTimestamp() });
}

function handleToolSelection(tool) {
    activeTool = { name: tool, step: 1, data: {} };
    const toolPrompts = {
        'research': "What topic would you like me to research for you?",
        'image': "What do you want to create? Please describe the image.",
        'comic': "Please provide the story for the comic.",
        'website': "Describe the website you want to build.",
        'remove-bg': "Please upload the image you want to remove the background from.",
        'voice-gen': "What text should I read aloud?",
        'audio-narration': "Which voice style would you like? (e.g., `podcast`, `cinematic`, `upbeat`, `soft`, `dramatic`)",
    };
    addBotMessage(`🔧 Activating **${tool} tool**. ${toolPrompts[tool] || 'Please provide your input.'}`);
}

async function handleToolStep(userInput, files) {
    const { name, step } = activeTool;
    const historyColRef = collection(db, `users/${currentUser.uid}/chats/${currentChatId}/history`);
    
    // Log user's input to the tool
    await addDoc(historyColRef, { role: 'user', text: userInput, createdAt: serverTimestamp() });

    showTyping();

    try {
        let toolFinished = false;
        switch(name) {
            case 'research':
                await addBotMessage(`🔬 Conducting research on **"${userInput}"**... this may take a moment.`);
                const researchResponse = await fetch('/api/tools/research', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: userInput })
                });
                if (!researchResponse.ok) throw new Error(`Research API failed with status ${researchResponse.status}`);
                const blob = await researchResponse.blob();
                const url = URL.createObjectURL(blob);
                await addBotMessage(`✅ Research complete! You can download the report below.\n\n[Download PDF](${url})`);
                toolFinished = true;
                break;

            case 'audio-narration':
                if (step === 1) { // We have the style, now ask for file
                    const style = userInput.toLowerCase();
                    if (!["podcast", "cinematic", "upbeat", "soft", "dramatic"].includes(style)) {
                        await addBotMessage("Invalid style. Please choose one of: `podcast`, `cinematic`, `upbeat`, `soft`, `dramatic`");
                        // Tool is not finished, stay on step 1
                    } else {
                        activeTool.data.style = style;
                        activeTool.step = 2;
                        await addBotMessage(`Style set to **${style}**. Now, please upload the document or audio file for narration.`);
                    }
                } else if (step === 2) { // We have the file, process it
                    if (files.length === 0) {
                        await addBotMessage("Please upload a file to continue.");
                        break; 
                    }
                    const file = files[0];
                    await addBotMessage(`🗣️ Generating narration for **${file.name}** in a *${activeTool.data.style}* style...`);
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('style', activeTool.data.style);
                    
                    const audioRes = await fetch('/api/tools/audio-narration', { method: 'POST', body: fd });
                    if (!audioRes.ok) throw new Error(`Audio narration API failed with status ${audioRes.status}`);
                    
                    const audioBlob = await audioRes.blob();
                    const storageRef = ref(storage, `user_files/${currentUser.uid}/${currentChatId}/narration_${Date.now()}.wav`);
                    const snapshot = await uploadBytes(storageRef, audioBlob);
                    const audioUrl = await getDownloadURL(snapshot.ref);

                    await addDoc(historyColRef, { 
                        role: 'ai', 
                        text: `Here is your audio narration:`,
                        fileURL: audioUrl,
                        fileType: 'audio/wav',
                        fileName: 'narration.wav',
                        createdAt: serverTimestamp() 
                    });
                    toolFinished = true;
                }
                break;
            
            // Add other tools here...
            default:
                await addBotMessage(`Tool "${name}" is not fully implemented on the frontend yet.`);
                toolFinished = true;
        }

        if (toolFinished) {
           activeTool = { name: null, step: 0, data: {} };
        }
    } catch (err) {
        await addBotMessage(`❌ Tool Error: ${err.message}`);
        activeTool = { name: null, step: 0, data: {} }; // Reset on error
    } finally {
        removeTyping();
    }
}

// ---------- Initial Load ----------
document.addEventListener('DOMContentLoaded', setupUI);

</script>
</body>
</html>
