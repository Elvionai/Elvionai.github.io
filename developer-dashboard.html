<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Developer Dashboard | Elvion AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Styles remain the same as your previous code -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://checkout.squadco.com/widget/squad.js"></script>
  <style>
    /* ... PASTE YOUR CSS FROM THE PREVIOUS FILE HERE ... */
    :root {
      --cyan: #00ffff; --blue: #0090ff; --red: #ff4d4d; --green: #28a745; --orange: #ffae42;
      --card-bg: rgba(18,26,48,0.97); --section-bg: rgba(24, 24, 31, 0.7);
      --border-glow: 0 0 11px var(--cyan), 0 0 24px var(--blue); --radius: 16px;
      --text: #e0e0e0; --white: #fff; --muted: #b3b3b3;
    }
    body {
      background: #0a1128; color: white; font-family: 'Inter', sans-serif;
      padding: 20px; display: flex; flex-direction: column; align-items: center;
    }
    .dashboard-container { max-width: 900px; width: 100%; }
    .section-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
    .submit-btn { background: var(--cyan); border: none; padding: 10px 20px; cursor: pointer; color: black; font-weight: bold; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block;}
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}
  </style>
</head>
<body>

<div class="dashboard-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1>Developer Dashboard</h1>
        <button id="logout-btn" style="background:transparent; border:1px solid var(--red); color:var(--red); padding:5px 10px; cursor:pointer;">Log Out</button>
    </div>

    <p id="welcome-message">Initializing...</p>

    <!-- Admin Tools -->
    <div id="admin-panel" class="section-card" style="border-color: var(--orange); display:none;">
        <h3 style="color: var(--orange);">ðŸ‘‘ Admin Controls</h3>
        <p>If you see this, the system recognizes you as an Admin.</p>
        <div id="admin-stats">Loading stats...</div>
        <br>
        <button id="grant-credits-btn" class="submit-btn" style="background: var(--orange);">Grant Myself 100k Credits</button>
        <p id="grant-status" style="font-size:0.8em; margin-top:5px;"></p>
    </div>

    <!-- Wallet -->
    <div class="section-card">
        <h3>My Wallet</h3>
        <h1 id="balance-display">---</h1>
        <button id="fund-wallet-btn" class="submit-btn">Fund Wallet (Squad)</button>
    </div>

    <!-- API Keys -->
    <div class="section-card">
        <h3>API Keys</h3>
        <button id="generate-key-btn" class="submit-btn">Generate New Key</button>
        <p id="generation-status"></p>
        <div id="new-key-box" style="display:none; background:black; padding:10px; margin-top:10px; border:1px solid var(--cyan);">
            <code id="api-key-display" style="color:var(--cyan);"></code>
        </div>
        <hr style="border-color:#333; margin:20px 0;">
        <div id="api-key-list">Loading keys...</div>
    </div>
</div>

<script type="module">
  // --- CONFIGURATION ---
  // IMPORTANT: Do not put a trailing slash '/' at the end of the URL
  const BACKEND_URL = "https://web-production-9a18.up.railway.app"; 
  const ADMIN_EMAIL = "koladhino@gmail.com"; // Lowercase

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  let userToken = null;

  // Logout
  document.getElementById('logout-btn').addEventListener('click', () => {
      signOut(auth).then(() => window.location.href = 'developer-login.html');
  });

  // Auth Listener
  onIdTokenChanged(auth, async (user) => {
    if (user) {
        // 1. Get Token
        userToken = await user.getIdToken();
        document.getElementById('welcome-message').textContent = `Logged in as: ${user.email}`;

        // 2. Check Admin UI
        if (user.email.toLowerCase() === ADMIN_EMAIL) {
            document.getElementById('admin-panel').style.display = 'block';
            fetchAdminStats();
        }

        // 3. Load Data
        loadData();
    } else {
        window.location.href = 'developer-login.html';
    }
  });

  async function loadData() {
      try {
          const res = await fetch(`${BACKEND_URL}/api/user/keys-and-balance`, {
              headers: { 'X-Firebase-Token': userToken }
          });
          
          if (!res.ok) {
              const err = await res.json();
              throw new Error(err.detail || "Failed to fetch data");
          }

          const data = await res.json();
          document.getElementById('balance-display').textContent = `${data.balance} Credits`;
          renderKeys(data.keys);

      } catch (e) {
          console.error(e);
          document.getElementById('balance-display').innerHTML = `<span style="color:red; font-size:14px;">Error connecting to server.<br>${e.message}</span>`;
      }
  }

  function renderKeys(keys) {
      const list = document.getElementById('api-key-list');
      list.innerHTML = "";
      if (keys.length === 0) {
          list.innerHTML = "No keys found."; 
          return;
      }
      keys.forEach(k => {
          const div = document.createElement('div');
          div.style.cssText = "display:flex; justify-content:space-between; background:#111; padding:10px; margin-bottom:5px; border-radius:5px;";
          const statusColor = k.is_active ? 'var(--green)' : 'var(--red)';
          div.innerHTML = `
            <div>
                <code style="color:white;">${k.api_key.slice(0,10)}...</code><br>
                <small style="color:#666;">${new Date(k.created_at).toLocaleDateString()}</small>
            </div>
            <div>
                <span style="color:${statusColor}; margin-right:10px;">${k.is_active ? 'ACTIVE' : 'REVOKED'}</span>
                ${k.is_active ? `<button onclick="revokeKey('${k.api_key}')" style="background:transparent; border:1px solid #555; color:#ccc; cursor:pointer;">Revoke</button>` : ''}
            </div>
          `;
          list.appendChild(div);
      });
  }

  // Make revoke globally accessible for the onclick handler
  window.revokeKey = async (key) => {
      if(!confirm("Revoke this key?")) return;
      await fetch(`${BACKEND_URL}/api/user/revoke-api-key`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json', 'X-Firebase-Token': userToken},
          body: JSON.stringify({api_key: key})
      });
      loadData();
  };

  // Generate Key
  document.getElementById('generate-key-btn').addEventListener('click', async () => {
      const status = document.getElementById('generation-status');
      status.textContent = "Processing...";
      try {
          const res = await fetch(`${BACKEND_URL}/api/user/create-api-key`, {
              method: 'POST',
              headers: { 'X-Firebase-Token': userToken }
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.detail);

          status.textContent = data.message;
          document.getElementById('api-key-display').textContent = data.api_key;
          document.getElementById('new-key-box').style.display = 'block';
          loadData();
      } catch (e) {
          status.textContent = `Error: ${e.message}`;
          status.style.color = "var(--red)";
      }
  });

  // Admin Grant Logic
  document.getElementById('grant-credits-btn').addEventListener('click', async () => {
      const status = document.getElementById('grant-status');
      status.textContent = "Processing...";
      try {
          const res = await fetch(`${BACKEND_URL}/api/admin/grant-credits`, {
              method: 'POST',
              headers: { 'X-Firebase-Token': userToken }
          });
          const data = await res.json();
          if(!res.ok) throw new Error(data.detail);
          status.textContent = data.message;
          status.style.color = "var(--green)";
          loadData(); // Update balance immediately
      } catch (e) {
          status.textContent = e.message;
          status.style.color = "var(--red)";
      }
  });

  async function fetchAdminStats() {
      try {
          const res = await fetch(`${BACKEND_URL}/api/admin/stats`, { headers: { 'X-Firebase-Token': userToken } });
          const data = await res.json();
          document.getElementById('admin-stats').innerHTML = `
            Users: ${data.total_registered_users} | 
            Keys: ${data.total_api_keys_generated} | 
            Revenue: â‚¦${data.total_revenue_credited}
          `;
      } catch(e) { console.log("Stats error", e); }
  }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>
