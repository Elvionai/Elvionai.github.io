<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF8" />
  <title>Philadelphia AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght=400;700&family=Roboto:wght=400;500;700&family=JetBrains+Mono:wght=500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
  <style>
:root {
  /* Default Theme: Deep Blue */
  --cyan: #00fff7;
  --blue: #0a8afe;
  --dark-bg: #070b1a;
  --fade-blue: #133c8b;
  --gradient-1: linear-gradient(120deg, #000a2e 39%, #04336a 68%, #10bfff 97%);
  --gradient-user: linear-gradient(120deg, #0857ee 32%, #00fff0 89%);
  --glass: rgba(25, 38, 67, 0.82);
  --bubble-glow: 0 0 13px #00d8ffb1, 0 0 24px #0197ff40;
  --user-glow: 0 0 22px #0fffd555, 0 0 14px #36f9ff70;
  --header-glass: rgba(17,29,47,0.92);
  --code-bg: linear-gradient(92deg,#031d39 79%,#092ff8 120%);
  --code-border: #15faff;
  --code-text: #17fafd;
  --action-btn-bg: #00fff7; /* New for action buttons */
  --action-btn-text: #070b1a; /* New for action buttons */
}
/* --- THEME STYLES --- */
body.theme-default {
  background:
  radial-gradient(circle at 60% 45%, #112250 37%, #060e1e 88%, #1e0942 100%) fixed,
  repeating-linear-gradient(100deg,#061c4c 0 9%,#080e20 16% 19%,#030721 30% 41%,#052650 44% 62%,#050b16 74% 89%,#041048 99% 100%);
background-blend-mode: lighten, color-dodge;
}
body.theme-cyberpunk {
  --cyan: #ff10f0; /* Neon Pink */
  --blue: #0ff0fc; /* Electric Cyan */
  --dark-bg: #000000;
  --fade-blue: #2a0040;
  --gradient-1: linear-gradient(120deg, #10002b 39%, #3c006b 68%, #ff10f0 97%);
  --gradient-user: linear-gradient(120deg, #0ff0fc 32%, #ff10f0 89%);
  --bubble-glow: 0 0 15px #ff10f0b1, 0 0 25px #ff10f040;
  --user-glow: 0 0 22px #0ff0fc55, 0 0 14px #0ff0fc70;
  --header-glass: rgba(0,0,0,0.92);
  --code-bg: linear-gradient(92deg,#10002b 79%,#3c006b 120%);
  --code-border: #0ff0fc;
  --code-text: #ff10f0;
  --action-btn-bg: #ff10f0; 
  --action-btn-text: #000000;
  background: #000000;
  font-family: 'JetBrains Mono', monospace;
}
body.theme-retrowave {
  --cyan: #ff7518; /* Orange */
  --blue: #ff007f; /* Magenta */
  --dark-bg: #1c0f49;
  --fade-blue: #401060;
  --gradient-1: linear-gradient(120deg, #1f0851 39%, #521568 68%, #ff007f 97%);
  --gradient-user: linear-gradient(120deg, #ff7518 32%, #ff007f 89%);
  --bubble-glow: 0 0 13px #ff007fb1;
  --user-glow: 0 0 22px #ff751855;
  --header-glass: rgba(28, 15, 73, 0.92);
  --code-bg: linear-gradient(92deg,#1f0851 79%,#521568 120%);
  --code-border: #ff7518;
  --code-text: #ffe57f;
  --action-btn-bg: #ff007f; 
  --action-btn-text: #1c0f49;
  background: linear-gradient(to top, #1f0851, #401060) fixed;
  font-family: 'Orbitron', sans-serif;
}
body.theme-deepforest {
  --cyan: #39ff14; /* Neon Green */
  --blue: #00a000;
  --dark-bg: #0a140a;
  --fade-blue: #0f3d0f;
  --gradient-1: linear-gradient(120deg, #0d2b0d 39%, #1a4d1a 68%, #39ff14 97%);
  --gradient-user: linear-gradient(120deg, #008000 32%, #39ff14 89%);
  --bubble-glow: 0 0 13px #39ff14b1;
  --user-glow: 0 0 22px #00800055;
  --header-glass: rgba(10, 20, 10, 0.92);
  --code-bg: linear-gradient(92deg,#0d2b0d 79%,#1a4d1a 120%);
  --code-border: #39ff14;
  --code-text: #90ee90;
  --action-btn-bg: #39ff14; 
  --action-btn-text: #0a140a;
  background: linear-gradient(to top, #0a140a, #0f3d0f) fixed;
}
body.theme-solarflare {
  --cyan: #ffd700; /* Gold */
  --blue: #ff8c00; /* Dark Orange */
  --dark-bg: #2b1d0e;
  --fade-blue: #5c3f1f;
  --gradient-1: linear-gradient(120deg, #4d2f09 39%, #7d4d14 68%, #ff8c00 97%);
  --gradient-user: linear-gradient(120deg, #ffd700 32%, #ff8c00 89%);
  --bubble-glow: 0 0 13px #ffd700b1;
  --user-glow: 0 0 22px #ffd70055;
  --header-glass: rgba(43, 29, 14, 0.92);
  --code-bg: linear-gradient(92deg,#4d2f09 79%,#7d4d14 120%);
  --code-border: #ff8c00;
  --code-text: #ffeb99;
  --action-btn-bg: #ff8c00; 
  --action-btn-text: #2b1d0e;
  background: linear-gradient(to top, #2b1d0e, #5c3f1f) fixed;
}

/* --- END THEME STYLES --- */

html, body {
  height: 100vh; width: 100vw; margin: 0; padding: 0;
  color: #e1fafe;
  font-family: 'Roboto','Inter',system-ui,-apple-system,Segoe UI,sans-serif;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}
body { overflow: hidden; min-height: 100vh; width: 100vw; }
#stars-container {
  pointer-events: none;
  position: fixed; left:0; top:0;right:0;bottom:0;
  width:100vw; height:100vh; z-index:1;
  overflow: hidden;
}
.star {
  position:absolute;
  background: var(--cyan);
  box-shadow:0 0 12px var(--cyan),0 0 22px var(--cyan);
  opacity: 0.23;
  border-radius: 50%;
  pointer-events: none;
  animation: star-twinkle 2.7s infinite alternate;
}
@keyframes star-twinkle {
  0% { opacity:.18; }
  41% { opacity:.88; }
  100%{ opacity:.09;}
}
.header-bar {
  position: fixed; top: 0; left: 0; width: 100vw;
  display: flex; align-items: center; justify-content: space-between;
  background: var(--header-glass);
  z-index: 1003;
  padding: 0;
  box-shadow: 0 7px 48px #00aaff27, 0 3px 41px #09fcfe15;
  border-radius: 0 0 22px 22px;
  height: 70px;
}
.menu-btn {
  background: none; border: none;
  color: var(--cyan); font-size: 2em; cursor: pointer;
  border-radius: 14px; margin-left: 17px; margin-right: 3px;
  padding: 7px 11px;
}
.menu-btn:hover { background: #00eaff28; color: #fff; }
.site-heading {
  font-family: 'Orbitron',sans-serif;
  font-size: 1.28em; font-weight: 700;
  text-align: center; flex: 1;
  letter-spacing: .27px;
  white-space:nowrap;
  background: linear-gradient(90deg,#00fff1,#00b4ff 40%,#fff 59%,#1093f1 89%,#24e0fa 100%);
  background-size: 250% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: neonglow 4.2s ease-in-out infinite alternate;
  text-shadow: 0 0 12px #00ffe0cc, 0 0 27px #178fcf88;
  user-select: none; margin-left: 8px; margin-right: 10px;
}
@keyframes neonglow {
  0% { text-shadow: 0 0 17px #00e7ff70,0 0 30px #0b8fff44;}
  100% { text-shadow: 0 0 29px #00ffe9ee,0 0 44px #31d2ff82;}
}
.header-welcome {
  color: #68e6fd; font-size: .97em; margin: -2px 0 .7em 0; text-align: center;
  text-shadow: 0 0 14px #00bcb4a8;
}
.main-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow-y: hidden;
    position: relative;
    padding-top: 70px;
    padding-bottom: 86px;
    box-sizing: border-box;
}
.chat-box {
  flex: 1 1 0px; 
  overflow-y: auto;
  overflow-x: hidden;
  width: 100vw; max-width: 635px; margin: 0 auto;
  box-sizing: border-box;
  padding: 15px 8px 40px 8px;
  position: relative;
  z-index:3;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
}
.chat-message {
  width: 100%; display: flex; gap:9px; align-items: flex-end;
  margin: 8px 0; max-width:100vw;
  flex-shrink: 0;
}
.chat-message .msg {
  font-size: 1.01em; line-height: 1.58;
  max-width: 62vw; min-width:0; 
  padding: 11px 16px 12px 15px;
  border-radius: 16px 14px 11px 12px;
  word-break: break-word; white-space: pre-wrap; overflow-x: auto;
  background: var(--gradient-1); color: #e1fafe;
  text-shadow: 0 0 3px #23d8ff15;
  box-shadow: var(--bubble-glow);
  margin-right: auto; margin-left: 0;
  border: 1.2px solid #0090ffa0; position:relative;
  transition:background .15s;
}
.chat-message.user { justify-content: flex-end; }
.chat-message.user .msg {
  background: var(--gradient-user);
  color: #141825; font-weight: 700;
  text-shadow: 0 0 5px #00e0ff77, 0 0 2px #00ffe033;
  border-radius: 17px 13px 15px 11px;
  margin-left: auto; margin-right: 0;
  box-shadow: var(--user-glow);
  border: 1.2px solid #04eef4c9;
  max-width: 68vw;
}
@media (max-width:790px) {
  .chat-box { max-width:100vw; padding: 15px 4px 40px 4px; }
  .chat-message .msg { font-size: .97em; padding:9px 4vw 10px 5vw; max-width:80vw;}
  .chat-message.user .msg { max-width: 83vw; }
}
.typing-bubble {
  display: inline-flex;
  align-items: center;
  height: 28px;
  padding: 4px 12px;
  margin: 6px 4px;
  border-radius: 15px;
  background: linear-gradient(90deg,#0a4477dd 30%,#0ebfff88 95%);
  box-shadow: 0 2px 12px #0dfcff77;
  border: 1px solid #00ffff55;
}
.dot-anim {
  display:inline-block;
  width: 8px; height: 8px;
  margin:0 3px; 
  background: var(--cyan);
  border-radius: 50%;
  opacity: 0.85;
  animation: typing-blink 1.4s infinite both;
  box-shadow: 0 0 6px var(--cyan);
}
.dot-anim:nth-child(2){animation-delay:.3s;}
.dot-anim:nth-child(3){animation-delay:.6s;}
@keyframes typing-blink {
  0%,100% {opacity:.25; transform: scale(0.8);}
  25%  {opacity:.95; transform: scale(1.1);}
  50%  {opacity:1; transform: scale(1.2);}
  75%  {opacity:.65; transform: scale(1);}
}
pre, code {
  font-family: 'JetBrains Mono','Fira Mono','Menlo',monospace;
  font-size: .99em;
  background: var(--code-bg);
  border-radius: 11px;
  border: 1.7px solid var(--code-border);
  color: var(--code-text);
  box-shadow: 0 0 19px #00eaff38, 0 0 48px #0beaff38 inset;
}
pre {
  overflow-x: auto;
  padding: 1.18em 1.3em 1.16em 1.13em;
  margin: 1.15em 0 1em 0; position: relative;
}
pre:before {
  content: "CODE";
  color: var(--cyan);
  font-size: 0.82em;
  font-family: 'Orbitron', monospace;
  position: absolute; top: 5px; right: 29px; opacity: 0.17;
  letter-spacing: 0.13em; pointer-events: none;
}
.copy-btn {
  position: absolute; top: 10px; right: 13px; z-index: 3;
  border-radius: 8px; border: none; padding: 3px 15px;
  background: linear-gradient(95deg,var(--cyan) 40%,var(--blue) 120%);
  color: #06182f; font-size: .98em; font-family: 'Inter'; font-weight: bold;
  box-shadow: 0 2px 9px var(--cyan),0 0 7px var(--cyan);
  transition: background .15s, color .15s;
  cursor: pointer; outline: none; border: 1px solid var(--cyan);
}
.copy-btn:hover { background: var(--blue); color: #fff; }
.file-attachments {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
    max-width: 100%;
}
.chat-media-preview {
  max-width: 100%;
  max-height: 250px;
  border-radius: 12px;
  display: block;
}
.image-preview-thumb, .video-preview-thumb {
  border: 2px solid var(--cyan);
  box-shadow: 0 0 10px var(--cyan);
}
.audio-preview-thumb {
  width: 90%;
  min-height: 40px;
  border-radius: 10px;
}
.file-link {
  display: inline-block;
  padding: 8px 12px;
  background: #0b2447;
  border: 1px solid var(--cyan);
  border-radius: 10px;
  color: var(--cyan);
  text-decoration: none;
  font-size: 0.9em;
  font-weight: bold;
}
.file-link i { margin-right: 5px; }
.file-preview{
  display:none;
  background:rgba(15,36,65,0.98);
  border-radius:12px;color:#c4f2ff;font-size:.98em;
  box-shadow:0 3px 15px #00aac0bb;
  margin:0 auto 10px auto;width:94vw;max-width:520px;
  padding:10px 14px 10px 15px;
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  z-index: 1002;
  border: 1.5px solid #00ffff44;
}
.file-preview img, .file-preview video {
  max-width:58px;max-height:41px;border-radius:6px;margin-right:6px;vertical-align: middle;
}
.file-preview audio { width:52px; margin-right:7px; }
.remove-file-btn {
  color: #fff !important; 
  background:#d23 !important;
  border:none !important; 
  border-radius:50% !important;
  padding:2px 6px !important; 
  cursor:pointer !important;
  font-size:1.2em !important; 
  font-weight:bold !important;
  margin-left:8px !important;
  transition: background .16s, color .16s !important;
  min-width: 24px !important;
  height: 24px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
}
.remove-file-btn:hover { 
  background:#ff4444 !important; 
  color:#fff !important;
  transform: scale(1.1) !important;
}

/* --- IMPROVED KEYBOARD FIT --- */
.chat-input-row {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 0;
  display: flex;
  align-items: stretch;
  gap: 8px;
  background: rgba(17, 29, 47, 0.94);
  backdrop-filter: blur(8px);
  border: 1.5px solid #1af8ff51;
  border-radius: 23px 23px 0 0;
  width: 95vw;
  max-width: 900px;
  padding: 9px 12px 10px 13px;
  box-shadow: 0 0 39px #007fff22, 0 11px 33px #00fff014;
  z-index: 1003;
}
@media (max-width: 920px) {
  .chat-input-row {
    width: 95vw;
    max-width: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 22px 22px 8px 8px;
  }
}
.chat-input-row textarea{
  flex:1 1 auto;resize:none;min-height:36px;max-height:120px;
  background:#09284c;color:#f5ffff;font-size:1em;
  padding:10px 12px;border:none;border-radius:11px;
  box-shadow:0 1px 6px #00f2ff27;
}
.chat-input-row button, .chat-input-row label{
  background:none;border:none;color:var(--cyan);font-size:1.21em;
  cursor:pointer;border-radius:10px;transition:color .13s,background .15s;padding:0;
  display:flex;align-items:center;justify-content:center;min-width:33px;
  box-shadow: 0 0 3px #00eaff20;
}
.chat-input-row button:hover, .chat-input-row label:hover{color:#fff;background:#00cdf247;}
#emojiPanel {
  display:none;
  position: fixed;
  left:10px;
  bottom:110px;
  z-index:2222;
  background: #051f46f9;
  border-radius: 15px;
  padding: 16px 15px 12px 15px;
  box-shadow: 0 5px 22px #00fff194;
  border: 1px solid #00ffff66;
}
.emoji-pick {
  font-size:1.23em;
  cursor:pointer;
  padding:4px 8px;
  border-radius:10px;
  transition:background .13s;
  user-select:none;
}
.emoji-pick:hover { background:#35cdfd66; }
.status-message{padding:6px 13px;color:#12ffc7;font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;}
.panel-bg {
  display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(13,20,52,0.86);z-index:1200;
}
.panel-bg.active{display:block;}
.side-panel{position:absolute;top:0;left:0;height:100vh;width:325px;background:linear-gradient(118deg,#131642 80%,#1629af 200%);border-right:2.5px solid #00fbffcb;box-shadow:0 0 42px #25f8ffc9;z-index:1212;
  padding:18px 16px 20px 15px;overflow-y:auto;border-radius:0 24px 32px 0;}
.side-panel .panel-header{text-align:center;margin:18px 0 13px 0;}
.side-panel img{width:56px;height:56px;border-radius:53%;margin-bottom:8px;border:2px solid #31f6ffea;}
.side-panel .username{font-weight:700;font-size:1.11em;color:#08d0fe;font-family:'Orbitron',sans-serif;text-shadow:0 0 8px #00eaffbb;}
.side-panel .email{font-size:.97em;color:#a8eaff;}
.panel-links a{color:#13efff;text-decoration:none;font-weight:500;font-size:1.08em;padding:8px 4px;display:flex;align-items:center;gap:12px;border-radius:9px;transition:background .14s;}
.panel-links a:hover{background:#00eaff55;color:#f4fdff;}
.panel-links a i { width: 20px; text-align: center; }
#chatsList button{background:none;border:none;cursor:pointer;outline:none;font-size:1.11em;margin:0 5px;vertical-align:middle;border-radius:7px;padding:3px 5px;}
#chatsList .fa-pen{color:#0fe0ee;transition:color .13s;}
#chatsList .fa-pen:hover{color:#ffd800;}
#chatsList .fa-trash{color:#ff244e;transition:color .10s;}
#chatsList .fa-trash:hover{color:#fff900;}
#chatsList .fa-play{color:#04ea70;font-size:1.2em;}
#chatsList .fa-play:hover{color:#31adff;}
.edit-form label{display:block;margin-top:10px;font-size:.99em;color:#38e4ff;text-shadow:0 1px 14px #11aaff71;}
.edit-form input, .edit-form textarea, .edit-form select{
  width:99%;padding:7px 11px;margin-top:5px;
  border:1.7px solid #13f0ff95;border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;
  box-shadow:0 0 8px #04f6fd81 inset;transition:border-color .17s,box-shadow .17s;}
.edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus{border-color:#27eeff;background:#273f5d;color:#fff;}
.edit-form textarea { resize:vertical; min-height: 80px; }
.submit-btn{
  margin-top:14px; padding:10px 20px;
  background:linear-gradient(94deg,var(--cyan),var(--blue) 90%);
  border:none; border-radius:10px;
  color:#102649; font-weight:bold; cursor:pointer; font-size:1.11em;
  box-shadow:0 2px 13px var(--cyan); transition:background .14s,color .13s;}
.submit-btn:hover{background:var(--blue);color:#fff;}
/* Spinner for loading states */
.spinner {
  display: inline-block;
  width: 20px; height: 20px;
  border: 3px solid rgba(0, 255, 247, 0.3);
  border-radius: 50%;
  border-top-color: var(--cyan);
  animation: spin 1s ease-in-out infinite;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- CALL MODAL STYLES --- */
.call-screen {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 90vw; max-width: 380px;
  background: linear-gradient(145deg, var(--dark-bg), var(--fade-blue));
  border-radius: 24px;
  border: 2px solid var(--cyan);
  box-shadow: 0 0 40px var(--bubble-glow);
  padding: 25px;
  text-align: center;
  z-index: 1210;
}
.call-header { margin-bottom: 20px; }
.call-status {
  font-size: 1.3em;
  color: var(--cyan);
  font-weight: 700;
  text-shadow: 0 0 8px var(--cyan);
}
.call-bot-name { font-size: 1.3em; color: #fff; font-weight: bold; }
.call-avatar-ring {
  width: 150px; height: 150px;
  border-radius: 50%;
  border: 4px solid var(--cyan);
  padding: 5px;
  margin: 0 auto 20px auto;
  animation: pulse-ring 1.5s infinite;
}
.call-avatar-ring.speaking {
  border-color: #00ff41;
  animation: pulse-ring 1s infinite;
}
@keyframes pulse-ring {
  0% { box-shadow: 0 0 0 0px var(--cyan); }
  50% { box-shadow: 0 0 0 10px rgba(0, 255, 247, 0.5); }
  100% { box-shadow: 0 0 0 20px rgba(0, 255, 247, 0); }
}
.call-avatar-ring img {
  width: 100%; height: 100%;
  border-radius: 50%;
  object-fit: cover;
}
.call-transcript {
  min-height: 40px;
  font-size: 1.1em;
  color: #e1fafe;
  font-style: italic;
}

/* --- New Action Button Styles (Copy/Share/Regen) --- */
.action-buttons {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  justify-content: flex-start;
  flex-wrap: wrap;
}
.action-button {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid var(--action-btn-bg);
  background: var(--action-btn-bg);
  color: var(--action-btn-text);
  font-family: 'Inter', sans-serif;
  font-size: 0.9em;
  font-weight: 700;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, box-shadow 0.15s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 5px;
}
.action-button:hover {
  background: transparent;
  color: var(--action-btn-bg);
  box-shadow: 0 0 12px var(--action-btn-bg);
}
.action-button i {
  font-size: 1.1em;
}

/* Update for typing status */
.msg-status-text {
  margin-left:8px; 
  color:#a8eaff; 
  font-style:italic;
  font-size: 0.95em;
}

/* New CSS for better button appearance */
#callBtn {
  font-size: 1.5em !important; 
  min-width: 40px !important;
}
  </style>
</head>
<body class="theme-default">
  <div id="stars-container"></div>

  <div class="main-content">
    
    <div class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <div class="header-titles">
        <span class="site-heading">ðŸ¦…Philadelphia AIðŸ¦…</span>
        <div class="header-welcome" id="headerWelcome"></div>
      </div>
      <button class="menu-btn" id="themeToggleBtn" aria-label="Toggle theme"><i class="fa-solid fa-moon"></i></button>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <button type="button" id="emojiBtn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
      <label for="chatFile" class="file-upload-btn" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
      <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none">
      <textarea id="chatInput" placeholder="Type hereâ€¦ (Shift+Enter = new line)"></textarea>
      <button type="button" id="callBtn" title="Call the Bot" style="color:#00ff41;"><i class="fa-solid fa-phone-volume"></i></button>
      <button type="button" id="toolBtn" title="Philadelphia Tools" aria-controls="toolMenu" aria-expanded="false"><i class="fa-solid fa-wrench"></i></button>
      <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
    </form>
  </div>
  
  <div id="emojiPanel"></div>
  <div class="status-message" id="statusMsg"></div>
  <div id="filePreview" class="file-preview"></div>
  
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:1.17em;font-weight:700;color:#00ffff;margin:18px 0 0 13px;">Chats</span>
        <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="profileMenuBg.classList.remove('active');">&times;</button>
      </div>
      <div id="chatsList" style="margin:7px 0 8px 6px;max-height:161px;overflow-y:auto;"></div>
      <button id="newChatBtn" class="submit-btn" style="margin:0 0 12px 11px;"><i class="fa-solid fa-plus"></i> New Chat</button>
      <hr style="width:91%;margin:11px 0 7px 3%;border:1px solid #00fff031;">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 6px;">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Paste image link">
        <span style="font-size:0.83em;color:#aae;display:block;margin:5px 0 7px 2px;">
          Tip: <a href="https://postimg.cc/" target="_blank" style="color:#19fcff;">Upload at postimg.cc</a>
        </span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">Logout</button>
    </nav>
  </div>
  
  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:100px;max-width:320px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;">
    <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
    <div id="ai-image-container"></div>
    <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
  </div>
  
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Philadelphia logo">
        <div class="username">Philadelphia AI</div>
      </div>
      <div class="panel-links">
        <a href="philadelphia.html"><i class="fa-solid fa-home"></i>Philadelphia Homepage</a>
        <a href="index.html"><i class="fa-solid fa-home"></i>Elvion Homepage</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About US</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Try Telegram Version</a>
      </div>
    </nav>
  </div>

  <div class="panel-bg" id="toolsMenuBg">
    <nav class="side-panel" id="toolsMenu">
        <div class="panel-header" style="text-align:left;">
            <div class="username" style="font-size:1.2em;margin-left:-8px;text-align:center;">Philadelphia AI Tools</div>
        </div>
        <div class="panel-links">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Creative Suite</h3>
            <a href="#" class="tool-link" data-tool="image"><i class="fa-solid fa-image"></i> Generate Image</a>
            <a href="#" class="tool-link" data-tool="edit-photo"><i class="fa-solid fa-wand-magic-sparkles"></i> Edit Photo</a>
            <a href="#" class="tool-link" data-tool="remove-bg"><i class="fa-solid fa-scissors"></i> Remove Background</a>
            <a href="#" class="tool-link" data-tool="comic"><i class="fa-solid fa-book-open"></i> Create Comic</a>
            <hr style="border-color: #00eaff30; margin: 10px 0;">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Audio & Video</h3>
            <a href="#" class="tool-link" data-tool="voice-gen"><i class="fa-solid fa-microphone-lines"></i> Voice Generation</a>
            <a href="#" class="tool-link" data-tool="audio-narration"><i class="fa-solid fa-file-audio"></i> Audio Narration</a>
            <a href="#" class="tool-link" data-tool="video-text"><i class="fa-solid fa-film"></i> Text-to-Video</a>
            <a href="#" class="tool-link" data-tool="video-image"><i class="fa-solid fa-photo-film"></i> Image-to-Video</a>
            <a href="#" class="tool-link" data-tool="music"><i class="fa-solid fa-music"></i> Generate Music</a>
            <hr style="border-color: #00eaff30; margin: 10px 0;">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Web & Research</h3>
            <a href="#" class="tool-link" data-tool="website"><i class="fa-solid fa-globe"></i> Create Website</a>
            <a href="#" class="tool-link" data-tool="edit-website"><i class="fa-solid fa-pen-ruler"></i> Edit Last Website</a>
            <a href="#" class="tool-link" data-tool="my-sites"><i class="fa-solid fa-list-check"></i> My Websites</a>
            <a href="#" class="tool-link" data-tool="research-report"><i class="fa-solid fa-flask-vial"></i> Research Report</a>
        </div>
        <button class="submit-btn" style="margin-top:17px;" onclick="closeToolMenu();">Close</button>
    </nav>
  </div>

  <div class="panel-bg" id="toolFormModalBg">
    <nav class="side-panel" id="toolFormModal">
      <div class="panel-header">
        <div class="username" id="toolFormTitle">Tool Title</div>
      </div>
      <form class="edit-form" id="toolForm" style="padding:0 6px;"></form>
      <button id="toolFormBackBtn" class="submit-btn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">
          <i class="fa-solid fa-arrow-left"></i> Back to Tools
      </button>
      <div class="status-message" id="toolStatusMsg"></div>
    </nav>
  </div>

  <div class="panel-bg" id="callScreenBg">
    <div class="call-screen">
      <div class="call-header">
        <div class="call-status" id="callStatus">Connecting...</div>
        <div class="call-bot-name">Philadelphia AI</div>
      </div>
      <div class="call-avatar-ring" id="callAvatarRing">
        <img src="https://i.postimg.cc/gcRyMxxy/IMG-20251106-090548-391.webp" alt="Bot Avatar">
      </div>
      <div class="call-transcript" id="callTranscript">...</div>
      <button class="submit-btn" id="endCallBtn" style="background:#d23; margin-top: 20px;">
        <i class="fa-solid fa-phone-slash"></i> End Call
      </button>
    </div>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script type="module">
// --- START OF FIREBASE-POWERED JAVASCRIPT ---

// --- FIREBASE IMPORTS (Storage REMOVED) ---
import { 
  getFirestore, collection, query, orderBy, onSnapshot, 
  addDoc, serverTimestamp, doc, deleteDoc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// NOTE: Firebase Storage imports are REMOVED here.
// We are skipping Firebase Storage and using a custom API endpoint for file uploads.

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com", // This is now unused for uploads
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
// --- FIRESTORE ONLY ---
const db = getFirestore(app);

// Short helper
const $ = id => document.getElementById(id);

// API Base URL
const API_BASE_URL = 'https://web-production-9a18.up.railway.app'; // Your Railway URL

// ---------- Global State Management ----------
let currentChatId = null;
let localChatsList = [];
let unsubscribeFromMessages = null;

let uploadedFiles = [];
let currentUser = null;
let typingNode = null;
let currentController = null;

// This helper saves a message to Firestore.
async function saveMessageToFirestore(role, text, files = [], originalMessageId = null) {
  if (!currentChatId || !currentUser) return;
  try {
    const data = {
      role: role,
      text: text,
      files: files,
      createdAt: serverTimestamp()
    };
    if (originalMessageId) {
      data.originalMessageId = originalMessageId;
    }
    await addDoc(collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages'), data);
  } catch (error) {
    console.error("Failed to save message to Firestore:", error);
  }
}

// --- NEW FILE UPLOAD LOGIC (Skipping Firebase Storage) ---
// This function sends the file to your API server and expects a public URL back.
async function uploadFile(file) {
  if (!file) return null;
  const fd = new FormData();
  fd.append('file', file);
  
  try {
    // IMPORTANT: This relies on your backend having a POST /upload-file endpoint
    const res = await fetch(`${API_BASE_URL}/upload-file`, { method: 'POST', body: fd });
    const data = await res.json();
    
    if (!res.ok || !data.url) throw new Error(data.error || 'Failed to get public URL from server.');
    
    return {
      url: data.url, // The public URL from your API server
      name: file.name,
      type: file.type,
      // path: null // No path needed as we are not using Firebase Storage
    };
  } catch (error) {
    console.error("File upload failed via API:", error);
    $('statusMsg').textContent = `File upload failed: ${file.name}. Check API endpoint /upload-file.`;
    setTimeout(() => { $('statusMsg').textContent = ''; }, 5000);
    return null;
  }
}


window.addEventListener('DOMContentLoaded', () => {
  // ---------- Element Selectors (same as before) ----------
  const starsContainer = $('stars-container');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const toolsMenuBg = $('toolsMenuBg');
  const toolsMenu = $('toolsMenu');
  const toolBtn = $('toolBtn');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  const emojiBtn = $('emojiBtn');
  const toolFormModalBg = $('toolFormModalBg');
  const toolForm = $('toolForm');
  const toolFormTitle = $('toolFormTitle');
  const toolFormBackBtn = $('toolFormBackBtn');
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');
  const statusMsg = $('statusMsg');

  if (!chatForm || !chatBox || !toolsMenu) {
    console.error("Essential UI elements are missing. App functionality will be limited.");
    return;
  }

  // --- THEME TOGGLER LOGIC (New Themes Implemented) ---
  const themeToggleBtn = $('themeToggleBtn');
  const themes = ['theme-default', 'theme-cyberpunk', 'theme-retrowave', 'theme-deepforest', 'theme-solarflare'];
  const themeIcons = ['fa-moon', 'fa-skull-crossbones', 'fa-video-slash', 'fa-tree', 'fa-sun'];
  let currentThemeIdx = 0;

  function applyTheme(idx) {
    currentThemeIdx = idx % themes.length;
    const theme = themes[currentThemeIdx];
    document.body.className = theme;
    localStorage.setItem('philadelphia_theme', theme);
    if (themeToggleBtn) {
      themeToggleBtn.innerHTML = `<i class="fa-solid ${themeIcons[currentThemeIdx]}"></i>`;
    }
  }
  const savedTheme = localStorage.getItem('philadelphia_theme');
  const savedThemeIdx = themes.indexOf(savedTheme);
  applyTheme(savedThemeIdx >= 0 ? savedThemeIdx : 0);
  
  if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', () => {
      applyTheme(currentThemeIdx + 1);
    });
  }
  // --- END THEME LOGIC ---

  // (All other UI initializers: stars, menu handlers, etc. remain here)
  window.closeToolMenu = () => { if (toolsMenuBg) toolsMenuBg.classList.remove('active'); };
  window.openToolMenu = () => { if (toolsMenuBg) toolsMenuBg.classList.add('active'); };

  // --- Auth Logic (Unchanged) ---
  onAuthStateChanged(auth, user => {
    if (!user) {
      try { window.location.href = "signup-login.html"; } catch (e) {}
      return;
    }
    currentUser = user;

    // ... (Profile UI updates, chat loading logic, etc. remain unchanged)
    if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]);
    if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
    if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
    if (editName) editName.value = user.displayName || "";
    if (editPhoto) editPhoto.value = user.photoURL || "";
    if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

    const chatsRef = collection(db, 'users', user.uid, 'chats');
    const q = query(chatsRef, orderBy('name'));

    onSnapshot(q, (snapshot) => {
      localChatsList = [];
      if (snapshot.empty) {
        console.log('No chats found, creating a new one...');
        addDoc(collection(db, 'users', currentUser.uid, 'chats'), {
          name: 'Welcome Chat',
          createdAt: serverTimestamp()
        }).then(docRef => {
          currentChatId = docRef.id;
          loadChat(currentChatId);
        });
      } else {
        snapshot.forEach(doc => {
          localChatsList.push({ id: doc.id, ...doc.data() });
        });
        renderChatsListSidebar();
        if (!currentChatId || !localChatsList.find(c => c.id === currentChatId)) {
          currentChatId = localChatsList[0].id;
        }
        loadChat(currentChatId);
      }
    }, (error) => {
      console.error("Error listening to chats: ", error);
      if (chatBox) chatBox.innerHTML = `<div class="status-message" style="color:#ff6b6b;">Error loading chats: ${error.message}</div>`;
    });

    if (profileForm) {
      profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;
        const status = $('profileStatusMsg');
        if (status) status.textContent = 'Saving...';
        try {
          await updateProfile(currentUser, { displayName: editName.value, photoURL: editPhoto.value });
          if (auth.currentUser) await auth.currentUser.reload();
          if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; }
          setTimeout(() => { profileMenuBg?.classList.remove('active'); }, 800);
          if (headerWelcome) headerWelcome.textContent = "Welcome, " + (auth.currentUser?.displayName || 'User');
        } catch (err) {
          if (status) { status.textContent = err.message; status.style.color = "#ffd700"; }
        }
      });
    }
  });

  // --- Chat/Message Rendering Logic (Action Buttons Added) ---
  // (renderChatsListSidebar, loadChat, markdown functions remain unchanged)
  
  function renderChatBox(messages = []) {
    if (!chatBox) return;
    chatBox.innerHTML = '';

    (messages || []).forEach((msg, idx) => {
      const div = document.createElement('div');
      div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'ai');
      div.setAttribute('data-msg-id', msg.id); 

      let innerHtml = '';
      const fileHtml = (msg.files || [])
        .map(file => {
          if (file.type.startsWith('image/')) {
            return `<img src="${file.url}" alt="${file.name}" class="chat-media-preview image-preview-thumb">`;
          } else if (file.type.startsWith('video/')) {
            return `<video src="${file.url}" controls class="chat-media-preview video-preview-thumb"></video>`;
          } else if (file.type.startsWith('audio/')) {
            return `<audio src="${file.url}" controls class="chat-media-preview audio-preview-thumb"></audio>`;
          } else {
            return `<a href="${file.url}" target="_blank" class="chat-media-preview file-link"><i class="fa-solid fa-file"></i> ${escapeHTML(file.name)}</a>`;
          }
        })
        .join('');

      if (msg.role === 'user') {
        innerHtml = `<div class="msg">
          ${fileHtml ? `<div class="file-attachments">${fileHtml}</div>` : ''}
          ${escapeHTML(msg.text || '')}
        </div>`;
      } else {
        const { html } = renderMarkdown(msg.text || '');
        
        const actionsHtml = `
          <div class="action-buttons">
            <button class="action-button copy-response" data-text="${escapeHTML(msg.text)}"><i class="fa-regular fa-clipboard"></i> Copy</button>
            <button class="action-button regenerate-response" data-original-text="${escapeHTML(msg.text)}" data-msg-id="${msg.id}"><i class="fa-solid fa-arrows-rotate"></i> Regenerate</button>
            <button class="action-button share-response" data-text="${escapeHTML(msg.text)}"><i class="fa-solid fa-share-nodes"></i> Share</button>
          </div>
        `;
        
        innerHtml = `<div class="msg">
          ${html}
          ${fileHtml ? `<div class="file-attachments" style="margin-top:10px;">${fileHtml}</div>` : ''}
          ${msg.text ? actionsHtml : ''}
        </div>`;
      }
      
      div.innerHTML = innerHtml;
      chatBox.appendChild(div);
    });
    // --- Action Button Handlers (Implemented) ---
    enhanceCodeBlocks(chatBox);
    
    chatBox.querySelectorAll('.copy-response').forEach(btn => {
      btn.addEventListener('click', () => {
        navigator.clipboard.writeText(btn.getAttribute('data-text'))
          .then(() => { btn.textContent = 'Copied!'; setTimeout(() => { btn.innerHTML = '<i class="fa-regular fa-clipboard"></i> Copy'; }, 800); })
          .catch(() => alert('Failed to copy.'));
      });
    });
    
    chatBox.querySelectorAll('.share-response').forEach(btn => {
      btn.addEventListener('click', () => {
        if (navigator.share) {
          navigator.share({ text: btn.getAttribute('data-text') })
            .catch(console.error);
        } else {
          alert('Sharing not supported on this device.');
        }
      });
    });

    chatBox.querySelectorAll('.regenerate-response').forEach(btn => {
      btn.addEventListener('click', () => {
        const aiMessage = btn.closest('.chat-message.ai');
        const prevMessages = Array.from(chatBox.children);
        let userMessage = null;

        for (let i = prevMessages.indexOf(aiMessage) - 1; i >= 0; i--) {
            if (prevMessages[i].classList.contains('user')) {
                userMessage = prevMessages[i];
                break;
            }
        }
        
        if (userMessage) {
            const userText = userMessage.querySelector('.msg').textContent.trim();
            chatInput.value = userText;
            chatForm.requestSubmit();
        } else {
            statusMsg.textContent = "Could not find the original user message to regenerate from.";
            setTimeout(() => { statusMsg.textContent = ''; }, 3000);
        }
      });
    });
    
    setTimeout(() => {
      const last = chatBox.lastElementChild;
      if (last) last.scrollIntoView({ behavior: "smooth", block: "end" });
    }, 20);
  }

  // --- Typing Indicators (Fixed) ---
  function showTypingWithText(text) {
      removeTyping();
      if (!chatBox) return;
      typingNode = document.createElement('div');
      typingNode.className = 'chat-message ai';
      typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span> <span class="msg-status-text">${escapeHTML(text)}</span></div>`;
      chatBox.appendChild(typingNode);
      typingNode.scrollIntoView({ behavior: "smooth", block: "end" });
  }
  
  function removeTyping() {
    if (typingNode && typingNode.parentNode) {
      typingNode.parentNode.removeChild(typingNode);
      typingNode = null;
    }
  }

  // (All file/image preview functions remain unchanged)

  // --- Tool Definitions (Updated to use API Upload) ---
  const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
  
  const toolDefinitions = {
    "image": {
        title: "Generate Image",
        description: "Create stunning visuals from a text prompt. Choose a model for different results.",
        buildForm: () => `
            <label for="tool-provider">Generation Model</label>
            <select id="tool-provider">
              <option value="thena">Version 1 (Stylized, Fast & Recommended)</option>
              <option value="minimax">Version 2 (Creative, Realistic, good for text in images)</option>
            </select>
            <label for="tool-prompt">Image Prompt</label>
            <textarea id="tool-prompt" placeholder="A futuristic cityscape, vibrant neon signs, flying cars" required></textarea>
            <label for="tool-style">Style (for Version 1 only)</label>
            <select id="tool-style">${thenaModels.map(s => `<option value="${s.toLowerCase()}">${s}</option>`).join('')}</select>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-sparkles"></i> Generate</button>`,
        handleSubmit: async (form) => {
            const use_minimax = form.querySelector('#tool-provider').value === 'minimax';
            const payload = { prompt: form.querySelector('#tool-prompt').value, model: form.querySelector('#tool-style').value, use_minimax };
            await saveMessageToFirestore('user', `Image generation request: "${payload.prompt}" (Model: ${use_minimax ? 'Version 2' : 'Version 1'})`);
            showTypingWithText('Generating your image...');
            try {
                const res = await fetch(`${API_BASE_URL}/generate-image`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || res.statusText);
                showAIImagePreview(data.image_b64, `Generated by Philadelphia AI`);
                removeTyping();
                await saveMessageToFirestore('ai', 'âœ… Image generated! Check the floating image box to view or download.');
                return null;
            } catch (err) { 
                removeTyping();
                return `âŒ Image generation failed: ${err.message}`; 
            }
        }
    },
    "edit-photo": {
        title: "Edit Photo",
        description: "Modify an existing image based on a prompt (e.g., 'give him a hat'). Requires an image file.",
        buildForm: () => `
            <label for="tool-image-file">Image File</label><input type="file" id="tool-image-file" accept="image/*" required>
            <label for="tool-prompt">Edit Prompt</label><textarea id="tool-prompt" placeholder="Give the person a futuristic helmet"></textarea>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-wand-magic-sparkles"></i> Edit Photo</button>`,
        handleSubmit: async (form) => {
            const file = form.querySelector('#tool-image-file').files[0];
            const prompt = form.querySelector('#tool-prompt').value;
            if (!file) return "Please select an image.";
            
            const fd = new FormData(); fd.append('file', file); fd.append('prompt', prompt);
            await saveMessageToFirestore('user', `Photo edit request: "${prompt}"`);
            showTypingWithText('Editing photo...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/edit-photo`, { method: 'POST', body: fd });
                if (!res.ok) throw new Error(await res.text() || res.statusText);
                
                const blob = await res.blob();
                const tempFile = new File([blob], `edited_${file.name}`, { type: file.type });
                // --- Using API upload instead of Firebase Storage ---
                const uploadedFile = await uploadFile(tempFile);
                
                removeTyping();
                if (uploadedFile) {
                    await saveMessageToFirestore('ai', `âœ… Photo edited successfully!`, [uploadedFile]);
                    return null;
                } else {
                    return `âŒ Failed to save edited photo. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Photo edit failed: ${err.message}`; 
            }
        }
    },
     "remove-bg": {
        title: "Remove Background",
        description: "Instantly remove the background from an uploaded image.",
        buildForm: () => `
            <label for="tool-image-file">Image File</label><input type="file" id="tool-image-file" accept="image/*" required>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-scissors"></i> Remove Background</button>`,
        handleSubmit: async (form) => {
            const file = form.querySelector('#tool-image-file').files[0];
            if (!file) return "Please select an image.";

            const fd = new FormData(); fd.append('file', file);
            await saveMessageToFirestore('user', `Background removal request.`);
            showTypingWithText('Removing background...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/remove-bg`, { method: 'POST', body: fd });
                if (!res.ok) throw new Error(await res.text() || res.statusText);
                
                const blob = await res.blob();
                const tempFile = new File([blob], `bg_removed_${file.name}`, { type: file.type });
                // --- Using API upload instead of Firebase Storage ---
                const uploadedFile = await uploadFile(tempFile);
                
                removeTyping();
                if (uploadedFile) {
                    await saveMessageToFirestore('ai', `âœ… Background removed!`, [uploadedFile]);
                    return null;
                } else {
                    return `âŒ Failed to save image with removed background. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Background removal failed: ${err.message}`; 
            }
        }
    },
    "comic": {
        title: "Create Comic",
        description: "Generate a 4-panel comic strip from a single story prompt.",
        buildForm: () => `
            <label for="tool-prompt">Comic Story Prompt</label><textarea id="tool-prompt" placeholder="A cat tries to catch a laser dot, chases it around the room, realizes it's just a light, and falls asleep on the couch."></textarea>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-book-open"></i> Create Comic</button>`,
        handleSubmit: async (form) => {
            const prompt = form.querySelector('#tool-prompt').value;
            await saveMessageToFirestore('user', `Comic generation request: "${prompt}"`);
            showTypingWithText('Creating 4-panel comic...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/generate-comic`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt }) });
                const data = await res.json();
                if (!res.ok || !data.images) throw new Error(data.error || res.statusText);

                const uploadPromises = data.images.map(async (base64, idx) => {
                    const byteCharacters = atob(base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) { byteNumbers[i] = byteCharacters.charCodeAt(i); }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/png' });
                    
                    const tempFile = new File([blob], `comic_panel_${idx+1}.png`, { type: 'image/png' });
                    // --- Using API upload instead of Firebase Storage ---
                    return uploadFile(tempFile);
                });

                const uploadedFiles = (await Promise.all(uploadPromises)).filter(Boolean);
                
                removeTyping();
                if (uploadedFiles.length > 0) {
                    await saveMessageToFirestore('ai', `ðŸ–¼ï¸ Comic successfully created!`, uploadedFiles);
                    return null;
                } else {
                    return `âŒ Failed to save comic panels. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Comic generation failed: ${err.message}`; 
            }
        }
    },
    "voice-gen": {
        title: "Voice Generation",
        description: "Transform text into realistic speech. Choose a version for different voice styles.",
        buildForm: () => `
            <label for="tool-provider">Voice Version</label>
            <select id="tool-provider">
              <option value="gemini">Version 1 (Styles)</option>
              <option value="minimax">Version 2 (Characters)</option>
            </select>
            <label for="tool-prompt">Text to Speak</label><textarea id="tool-prompt" placeholder="The eagle soars high..." required></textarea>
            <label for="tool-style">Voice Style</label><select id="tool-style"></select>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-microphone"></i> Generate Voice</button>`,
        onFormReady: () => {
            const providerSelect = $('tool-provider'), styleSelect = $('tool-style');
            const voices = { gemini: ["podcast", "cinematic", "upbeat", "soft", "dramatic"], minimax: ["anime", "movie", "narrator", "knight", "elder", "sweet", "casual", "ceo", "hero", "elegant"] };
            const updateStyles = () => { styleSelect.innerHTML = voices[providerSelect.value].map(v => `<option value="${v}">${v.charAt(0).toUpperCase() + v.slice(1)}</option>`).join(''); };
            providerSelect.addEventListener('change', updateStyles);
            updateStyles();
        },
        handleSubmit: async (form) => {
            const provider = form.querySelector('#tool-provider').value, text = form.querySelector('#tool-prompt').value, style = form.querySelector('#tool-style').value;
            await saveMessageToFirestore('user', `Voice generation request using ${provider === 'gemini' ? 'Version 1' : 'Version 2'}.`);
            showTypingWithText('Generating your audio...');
            try {
                let res;
                if (provider === 'gemini') {
                    const fd = new FormData(); fd.append('text', text); fd.append('style', style);
                    res = await fetch(`${API_BASE_URL}/voicegen`, { method: 'POST', body: fd });
                } else {
                    res = await fetch(`${API_BASE_URL}/api/tools/text-to-speech`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text, voice_id: style }) });
                }
                if (!res.ok) throw new Error(await res.text());
                const blob = await res.blob();
                
                // --- Using API upload instead of Firebase Storage ---
                const file = new File([blob], "generated_voice.mp3", { type: "audio/mpeg" });
                const uploadedFile = await uploadFile(file);
                
                removeTyping();
                if (uploadedFile) {
                  await saveMessageToFirestore('ai', `ðŸ—£ï¸ Voice generated!`, [uploadedFile]);
                  return null;
                } else {
                  return `âŒ Failed to save generated voice. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Voice generation failed: ${err.message}`; 
            }
        }
    },
    "audio-narration": {
        title: "Audio Narration",
        description: "Narrate a document or long text passage with a consistent voice.",
        buildForm: () => `
            <label for="tool-text-file">Text/PDF File (Optional)</label><input type="file" id="tool-text-file" accept="text/*,application/pdf">
            <label for="tool-prompt">Text to Narrate</label><textarea id="tool-prompt" placeholder="The full text of your chapter or script..."></textarea>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-file-audio"></i> Generate Narration</button>`,
        handleSubmit: async (form) => {
            const text = form.querySelector('#tool-prompt').value;
            await saveMessageToFirestore('user', `Audio Narration request (Text length: ${text.length} characters).`);
            showTypingWithText('Generating narration...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/audio-narration`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
                if (!res.ok) throw new Error(await res.text() || res.statusText);

                const blob = await res.blob();
                // --- Using API upload instead of Firebase Storage ---
                const file = new File([blob], "generated_narration.mp3", { type: "audio/mpeg" });
                const uploadedFile = await uploadFile(file);
                
                removeTyping();
                if (uploadedFile) {
                  await saveMessageToFirestore('ai', `ðŸ—£ï¸ Narration generated!`, [uploadedFile]);
                  return null;
                } else {
                  return `âŒ Failed to save generated narration. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Audio narration failed: ${err.message}`; 
            }
        }
    },
    "video-text": {
        title: "Generate Video from Text",
        description: "Create a short video clip from a description. Video generation can take several minutes.",
        buildForm: () => `
            <label for="video-prompt">Video Prompt</label><textarea id="video-prompt" placeholder="A majestic eagle flying over the Philadelphia skyline at sunset, 4K, cinematic lighting" required></textarea>
            <label for="video-duration">Duration (seconds)</label><input type="number" id="video-duration" value="4" min="1" max="10" required>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-film"></i> Start Video Generation</button>`,
        handleSubmit: async (form) => {
            const payload = { prompt: form.querySelector('#video-prompt').value, duration: parseInt(form.querySelector('#video-duration').value, 10), resolution: "1080P" };
            await saveMessageToFirestore('user', `Text-to-Video request: "${payload.prompt}"`);
            // Simplified handleVideoGeneration to avoid tool duplication
            showTypingWithText('Submitting video generation job...');
            try {
                const startRes = await fetch(API_BASE_URL + '/api/tools/generate-video-from-text', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const startData = await startRes.json();
                if (!startRes.ok || !startData.task_id) throw new Error(startData.detail || 'Failed to start video task.');
                
                removeTyping();
                await saveMessageToFirestore('ai', `âœ… Video job submitted! Task ID: \`${startData.task_id}\`. I'll notify you when it's ready. This can take a few minutes.`);
                
                const pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`${API_BASE_URL}/api/tools/video-status?task_id=${startData.task_id}`);
                        const statusData = await statusRes.json();
                        if (statusRes.ok && statusData.url) {
                            clearInterval(pollInterval);
                            await saveMessageToFirestore('ai', `ðŸŽ‰ Your video is ready!`, [{
                              url: statusData.url,
                              name: "generated_video.mp4",
                              type: "video/mp4"
                            }]);
                        } else if (!statusRes.ok || statusData.status?.toLowerCase().includes('fail')) {
                            clearInterval(pollInterval);
                            await saveMessageToFirestore('ai', `âŒ Video generation failed. Reason: ${statusData.error || 'Unknown error'}`);
                        }
                    } catch (pollErr) {
                        clearInterval(pollInterval);
                        await saveMessageToFirestore('ai', `âŒ Error checking video status.`);
                    }
                }, 20000);
            } catch (err) {
                removeTyping();
                await saveMessageToFirestore('ai', `âŒ Could not start video generation: ${err.message}`);
            }
            return null;
        }
    },
    "video-image": {
        title: "Generate Video from Image",
        description: "Animate an image with a text prompt. Requires an image file.",
        buildForm: () => `
            <label for="video-image-file">Image File</label><input type="file" id="video-image-file" accept="image/*" required>
            <label for="video-image-prompt">Animation Prompt</label><textarea id="video-image-prompt" placeholder="Make the water ripple and the clouds drift slowly"></textarea>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-photo-film"></i> Start Video Generation</button>`,
        handleSubmit: async (form) => {
            const file = form.querySelector('#video-image-file').files[0];
            const prompt = form.querySelector('#video-image-prompt').value;
            if (!file) return "Please select an image.";
            
            await saveMessageToFirestore('user', `Image-to-Video request: "${prompt}"`);
            
            const fd = new FormData(); fd.append('prompt', prompt); fd.append('file', file);
            
            // Simplified handleVideoGeneration to avoid tool duplication
            showTypingWithText('Submitting video generation job...');
            try {
                const startRes = await fetch(API_BASE_URL + '/api/tools/generate-video-from-image', { method: 'POST', body: fd });
                const startData = await startRes.json();
                if (!startRes.ok || !startData.task_id) throw new Error(startData.detail || 'Failed to start video task.');
                
                removeTyping();
                await saveMessageToFirestore('ai', `âœ… Video job submitted! Task ID: \`${startData.task_id}\`. I'll notify you when it's ready. This can take a few minutes.`);
                
                const pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`${API_BASE_URL}/api/tools/video-status?task_id=${startData.task_id}`);
                        const statusData = await statusRes.json();
                        if (statusRes.ok && statusData.url) {
                            clearInterval(pollInterval);
                            await saveMessageToFirestore('ai', `ðŸŽ‰ Your video is ready!`, [{
                              url: statusData.url,
                              name: "generated_video.mp4",
                              type: "video/mp4"
                            }]);
                        } else if (!statusRes.ok || statusData.status?.toLowerCase().includes('fail')) {
                            clearInterval(pollInterval);
                            await saveMessageToFirestore('ai', `âŒ Video generation failed. Reason: ${statusData.error || 'Unknown error'}`);
                        }
                    } catch (pollErr) {
                        clearInterval(pollInterval);
                        await saveMessageToFirestore('ai', `âŒ Error checking video status.`);
                    }
                }, 20000);
            } catch (err) {
                removeTyping();
                await saveMessageToFirestore('ai', `âŒ Could not start video generation: ${err.message}`);
            }
            return null;
        }
    },
    "music": {
        title: "Generate Music",
        description: "Create a unique music clip from a text prompt.",
        buildForm: () => `
            <label for="music-prompt">Music Prompt (e.g. 'Epic cinematic trailer music with strings and drums')</label><textarea id="music-prompt" required></textarea>
            <label for="music-duration">Duration (seconds, max 30)</label><input type="number" id="music-duration" value="10" min="5" max="30" required>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-music"></i> Generate Music</button>`,
        handleSubmit: async (form) => {
            const prompt = form.querySelector('#music-prompt').value;
            const duration = parseInt(form.querySelector('#music-duration').value, 10);
            
            await saveMessageToFirestore('user', `Music generation request: "${prompt}" for ${duration} seconds.`);
            showTypingWithText('Generating your music...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/music-gen`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, duration })
                });

                if (!res.ok) throw new Error(await res.text() || res.statusText);
                
                const blob = await res.blob();
                
                // --- Using API upload instead of Firebase Storage ---
                const file = new File([blob], "generated_music.mp3", { type: "audio/mpeg" });
                const uploadedFile = await uploadFile(file);
                
                removeTyping();

                if (uploadedFile) {
                  await saveMessageToFirestore('ai', `ðŸŽµ Your music is ready!`, [uploadedFile]);
                  return null;
                } else {
                  return `âŒ Failed to save generated music. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Music generation failed: ${err.message}`; 
            }
        }
    },
    "website": {
        title: "Create Website",
        description: "Generate and deploy a complete website based on your prompt.",
        buildForm: () => `
            <label for="website-prompt">Website Description</label><textarea id="website-prompt" placeholder="A one-page portfolio website for a freelance web developer, modern, dark theme." required></textarea>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-globe"></i> Create Website</button>`,
        handleSubmit: async (form) => {
            const prompt = form.querySelector('#website-prompt').value;
            await saveMessageToFirestore('user', `Website creation request: "${prompt.substring(0, 50)}..."`);
            showTypingWithText('Building and deploying your website...');
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/create-website`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, user_id: currentUser.uid }) });
                const data = await res.json();
                removeTyping();
                if (!res.ok) throw new Error(data.error || res.statusText);
                return `ðŸŒ Website deployed successfully! [View here](${data.url})`;
            } catch (err) { 
                removeTyping();
                return `âŒ Website creation failed: ${err.message}`; 
            }
        }
    },
    "edit-website": {
        title: "Edit Last Website",
        description: "Request a change to the last website you generated.",
        buildForm: () => `
            <label for="edit-prompt">Edit Instructions</label><textarea id="edit-prompt" placeholder="Change the main color scheme to red and black, and add a contact form." required></textarea>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-pen-ruler"></i> Edit Website</button>`,
        handleSubmit: async (form) => {
            const prompt = form.querySelector('#edit-prompt').value;
            await saveMessageToFirestore('user', `Website edit request: "${prompt.substring(0, 50)}..."`);
            showTypingWithText('Applying changes to your website...');
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/edit-website`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, user_id: currentUser.uid }) });
                const data = await res.json();
                removeTyping();
                if (!res.ok) throw new Error(data.error || res.statusText);
                return `ðŸ”„ Website updated! [View the new version here](${data.url})`;
            } catch (err) { 
                removeTyping();
                return `âŒ Website update failed: ${err.message}`; 
            }
        }
    },
    "my-sites": {
        isAction: true,
        runAction: async () => {
            await saveMessageToFirestore('user', 'Show me a list of my websites.');
            showTypingWithText('Fetching your website list...');
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/my-sites/${currentUser.uid}`);
                const data = await res.json();
                removeTyping();
                if (!res.ok) throw new Error(data.error || 'Could not fetch sites.');
                if (!data.sites || data.sites.length === 0) return "You haven't created any websites yet.";
                const siteList = data.sites.map(site => `- <a href="${site.site_url}" target="_blank">${site.site_url}</a> (Created: ${new Date(site.created_at).toLocaleString()})`).join('\n');
                return `Here are the websites you've created:\n${siteList}`;
            } catch (err) { 
                removeTyping();
                return `âŒ Error fetching websites: ${err.message}`; 
            }
        }
    },
    "research-report": {
        title: "Research Report",
        description: "Generate a detailed PDF report on any given topic.",
        buildForm: () => `
            <label for="research-topic">Topic for Research Report</label><input type="text" id="research-topic" placeholder="The impact of AI on urban planning" required>
            <label for="report-length">Desired Length</label><select id="report-length"><option>Short (1-2 pages)</option><option>Medium (3-5 pages)</option><option>Long (6-10 pages)</option></select>
            <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-flask-vial"></i> Generate Report</button>`,
        handleSubmit: async (form) => {
            const topic = form.querySelector('#research-topic').value;
            const length = form.querySelector('#report-length').value;
            await saveMessageToFirestore('user', `Research report requested on **${topic}** (${length} length).`);
            showTypingWithText('Generating your research report...');
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/research-report`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ topic, length }) });
                if (!res.ok) throw new Error(await res.text() || res.statusText);
                
                const blob = await res.blob();
                
                // --- Using API upload instead of Firebase Storage ---
                const file = new File([blob], `research_${topic.replace(/\s/g, '_')}.pdf`, { type: "application/pdf" });
                const uploadedFile = await uploadFile(file);

                removeTyping();
                if (uploadedFile) {
                  await saveMessageToFirestore('ai', `âœ… Research report on **${topic}** is ready!`, [uploadedFile]);
                  return null;
                } else {
                  return `âŒ Failed to save generated report. (API Upload Failed)`;
                }
            } catch (err) { 
                removeTyping();
                return `âŒ Research report failed: ${err.message}`; 
            }
        }
    },
  };
  
  // (Tool Menu/Form/Submit handlers remain unchanged)


  /* ---------- MAIN CHAT SUBMIT HANDLER (API Upload Implemented) ---------- */
  chatForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!currentChatId || !currentUser) {
      statusMsg.textContent = "Not connected. Please wait for the chat to load.";
      return;
    }
    
    const msgText = chatInput.value.trim();
    const filesToUpload = [...uploadedFiles];
    
    if (!msgText && filesToUpload.length === 0) return;

    chatInput.disabled = true;
    
    const stopButton = document.createElement('button');
    stopButton.type = 'button';
    stopButton.id = 'stopBtn';
    stopButton.innerHTML = '<i class="fa-solid fa-stop"></i>';
    stopButton.style.color = '#ff6b6b';
    sendBtn.replaceWith(stopButton);

    currentController = new AbortController();
    const signal = currentController.signal;
    
    chatInput.value = '';
    uploadedFiles = [];
    renderFilePreview();
    
    let finalResponse = '';
    let aiResponseFiles = [];
    let isStopped = false;

    stopButton.addEventListener('click', () => {
        if (currentController) {
            currentController.abort();
            isStopped = true;
            removeTyping();
            saveMessageToFirestore('ai', 'âŒ Response stopped by user.');
        }
    });

    try {
      // --- 1. Save User Message to Firestore (Placeholder) ---
      showTypingWithText('Saving message...');
      const messageDocRef = await addDoc(collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages'), {
        role: 'user',
        text: msgText,
        createdAt: serverTimestamp(),
        files: [] 
      });
      
      // --- 2. Upload Files (if any) ---
      const uploadedFileMetadata = [];
      if (filesToUpload.length > 0) {
        showTypingWithText('Uploading file(s)...');
        const uploadPromises = filesToUpload.map(file => 
          // --- Changed to use the new API-based uploadFile ---
          uploadFile(file)
        );
        const results = await Promise.all(uploadPromises);
        uploadedFileMetadata.push(...results.filter(Boolean));
        
        // --- 3. Update message doc with file URLs ---
        await updateDoc(messageDocRef, {
          files: uploadedFileMetadata
        });
      }
      
      // --- 4. Call AI Backend ---
      if (isStopped) return;
      removeTyping();
      showTypingAtNext();
      
      if (uploadedFileMetadata.length > 0) {
        // --- Logic for File-Based AI ---
        const file = uploadedFileMetadata[0];
        const localFile = filesToUpload[0];
        
        let endpoint = '';
        if (file.type.startsWith('image/')) endpoint = '/understand-image';
        else if (file.type === 'application/pdf') endpoint = '/understand-pdf';
        else if (file.type.startsWith('audio/')) endpoint = '/understand-audio';
        else if (file.type.startsWith('video/')) endpoint = '/understand-video';
        
        if (endpoint) {
          const fd = new FormData();
          fd.append('prompt', msgText || `Analyze this ${file.type.split('/')[0]}`);
          // Send the actual file blob for analysis
          fd.append('file', localFile); 
          
          const res = await fetch(API_BASE_URL + endpoint, { method: 'POST', body: fd, signal });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Analysis failed.");
          finalResponse = data.response;
        } else {
          finalResponse = "Sorry, I can't analyze that file type.";
        }
        
      } else if (msgText) {
        // --- Logic for Plain Text Chat ---
        const history = []; 
        const res = await fetch(`${API_BASE_URL}/chat`, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ message: msgText, history, user_id: currentUser?.uid || "user" }), 
          signal 
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Server error.");
        finalResponse = data.response;
      }

      // --- 5. Save AI Response to Firestore ---
      if (isStopped) return;
      removeTyping();
      if (finalResponse || aiResponseFiles.length > 0) {
        await saveMessageToFirestore('ai', finalResponse, aiResponseFiles);
      }
      
    } catch (err) {
      if (isStopped) return;
      removeTyping();
      const errorText = err.name === 'AbortError' ? 'âŒ Response stopped.' : `âŒ An error occurred: ${err.message}`;
      await saveMessageToFirestore('ai', errorText);
    }

    // UI Cleanup
    stopButton.replaceWith(sendBtn);
    chatInput.disabled = false;
    currentController = null;
    chatInput.focus();
  });


  // --- "CALL THE BOT" LOGIC (Point 2: Call Perfection) ---
  const callBtn = $('callBtn');
  const callScreenBg = $('callScreenBg');
  const endCallBtn = $('endCallBtn');
  const callStatus = $('callStatus');
  const callTranscript = $('callTranscript');
  const callAvatarRing = $('callAvatarRing');
  let isCallActive = false;
  let callAudioQueue = [];
  let isPlayingAudio = false;

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  if (!SpeechRecognition) {
    if (callBtn) callBtn.style.display = 'none';
    console.warn("Speech Recognition not supported by this browser.");
  } else {
    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    function processQueue() {
      if (callAudioQueue.length === 0) {
        isPlayingAudio = false;
        callAvatarRing.classList.remove('speaking');
        if (isCallActive) {
          callStatus.textContent = "Listening...";
          setTimeout(() => {
            if (isCallActive && !isPlayingAudio) {
              try { recognition.start(); } catch(e) { /* ignore restart error */ }
            }
          }, 300); 
        }
        return;
      }
      
      isPlayingAudio = true;
      callAvatarRing.classList.add('speaking');
      callStatus.textContent = "Speaking...";
      const audioUrl = callAudioQueue.shift();
      const audio = new Audio(audioUrl);
      
      audio.play();
      
      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        processQueue();
      };
      audio.onerror = () => { 
        URL.revokeObjectURL(audioUrl);
        callStatus.textContent = "Audio playback failed.";
        processQueue();
      };
    }
    
    function playAudioFromQueue(url) {
      callAudioQueue.push(url);
      if (!isPlayingAudio) {
        processQueue();
      }
    }
    
    async function handleUserSpeech(transcript) {
      if (!transcript.trim()) {
         callStatus.textContent = "Didn't catch that. Listening...";
         try { recognition.start(); } catch(e) { /* ignore restart error */ }
         return;
      }
      
      callStatus.textContent = "Thinking...";
      recognition.stop(); 
      
      let botText = "Sorry, I had trouble thinking of a response.";
      
      try {
        // 1. Send text to chat API
        const chatRes = await fetch(`${API_BASE_URL}/chat`, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ message: transcript, user_id: currentUser?.uid || "user" }) 
        });
        const chatData = await chatRes.json();
        botText = chatData.response || botText;
        
        // 2. Save to chat (quietly)
        await saveMessageToFirestore('user', transcript);
        await saveMessageToFirestore('ai', botText);
        
        // 3. Send response text to voice API
        const fd = new FormData();
        fd.append('text', botText);
        fd.append('style', 'podcast');
        const voiceRes = await fetch(`${API_BASE_URL}/voicegen`, { method: 'POST', body: fd });
        
        if (voiceRes.ok) {
          const blob = await voiceRes.blob();
          const url = URL.createObjectURL(blob);
          playAudioFromQueue(url);
        } else {
          callStatus.textContent = "Speaking failed. Attempting to listen again.";
          setTimeout(() => {
            if(isCallActive && !isPlayingAudio) {
              try { recognition.start(); } catch(e) {}
            }
          }, 500);
        }
      } catch (e) {
        console.error("Call error:", e);
        callStatus.textContent = "An error occurred. Attempting to listen again.";
        setTimeout(() => {
            if(isCallActive && !isPlayingAudio) {
              try { recognition.start(); } catch(e) {}
            }
        }, 500);
      }
    }
    
    recognition.onstart = () => {
      callStatus.textContent = "Listening...";
      callAvatarRing.classList.remove('speaking');
    };
    
    recognition.onresult = (event) => {
      const interimTranscript = Array.from(event.results)
        .map(result => result[0].transcript)
        .join('');
      callTranscript.textContent = `You: "${interimTranscript}"`;
      
      if (event.results[0].isFinal) {
        const finalTranscript = event.results[0][0].transcript;
        callTranscript.textContent = `You: "${finalTranscript}"`;
        handleUserSpeech(finalTranscript);
      }
    };
    
    recognition.onend = () => {
      if (isCallActive && !isPlayingAudio) {
        callStatus.textContent = "Waiting for you...";
        setTimeout(() => {
          if (isCallActive && !isPlayingAudio) {
            try { recognition.start(); } catch(e) { /* ignore restart error */ }
          }
        }, 500); 
      }
    };
    
    recognition.onerror = (event) => {
        console.error("Recognition Error:", event.error);
        if (isCallActive && !isPlayingAudio) {
             callStatus.textContent = `Recognition Error: ${event.error}. Restarting...`;
             setTimeout(() => {
                 if (isCallActive && !isPlayingAudio) {
                   try { recognition.start(); } catch(e) { /* ignore restart error */ }
                 }
             }, 1000);
        }
    };

    if (callBtn) callBtn.addEventListener('click', () => {
      if (!currentChatId || !currentUser) {
        statusMsg.textContent = "Please select a chat first.";
        setTimeout(() => { statusMsg.textContent = ''; }, 3000);
        return;
      }
      isCallActive = true;
      callScreenBg.classList.add('active');
      callStatus.textContent = "Connecting...";
      callTranscript.textContent = "...";
      callAudioQueue = [];
      isPlayingAudio = false;
      callAvatarRing.classList.remove('speaking');
      try {
        recognition.start();
      } catch(e) { 
        callStatus.textContent = "Error starting voice recognition.";
        console.error("Recognition start error:", e); 
      }
    });
    
    if (endCallBtn) endCallBtn.addEventListener('click', () => {
      isCallActive = false;
      recognition.abort();
      callScreenBg.classList.remove('active');
      callAudioQueue.forEach(url => URL.revokeObjectURL(url));
      callAudioQueue = [];
      isPlayingAudio = false;
      callAvatarRing.classList.remove('speaking');
      statusMsg.textContent = "Call ended.";
      setTimeout(() => { statusMsg.textContent = ''; }, 3000);
    });
  }
  // --- END "CALL THE BOT" LOGIC ---
  
  if(chatInput) chatInput.focus();
  
}); // end DOMContentLoaded
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>
