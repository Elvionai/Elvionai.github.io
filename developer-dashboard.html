<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Developer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root { --primary: #00ffff; --primary-dim: rgba(0, 255, 255, 0.1); --secondary: #ff00ff; --bg-dark: #050a14; --glass-bg: rgba(16, 24, 45, 0.75); --glass-border: rgba(255, 255, 255, 0.08); --text-main: #ffffff; --text-muted: #94a3b8; --success: #00e676; --danger: #ff1744; --warning: #ffae42; }
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; overflow-x: hidden; background-image: radial-gradient(circle at 10% 20%, rgba(0, 255, 255, 0.05) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(255, 0, 255, 0.05) 0%, transparent 20%); }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 25px 0; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand img { width: 45px; height: 45px; border-radius: 10px; box-shadow: 0 0 15px var(--primary-dim); }
    .brand h1 { font-family: 'Orbitron'; font-size: 1.4rem; margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .user-info { display: flex; align-items: center; gap: 20px; background: var(--glass-border); padding: 8px 16px; border-radius: 30px; }
    .logout-btn { background: none; border: none; color: var(--danger); cursor: pointer; transition: 0.3s; font-size: 1rem; padding: 5px; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
    .card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 25px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 10px; }
    .balance-amount { font-family: 'Orbitron'; font-size: 3rem; font-weight: 700; color: white; margin: 5px 0 20px 0; text-align: center; }
    .btn { background: linear-gradient(135deg, var(--primary), #00cccc); color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-family: 'Inter'; cursor: pointer; transition: 0.3s; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
    .btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid var(--glass-border); }
    .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
    .table-container { overflow-x: auto; max-height: 400px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; color: var(--text-muted); font-size: 0.8rem; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; background: rgba(10, 14, 25, 0.95); z-index: 2; }
    td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: #e2e8f0; font-size: 0.9rem; }
    .cost-negative { color: #ff80ab; font-weight: 600; font-family: 'Orbitron'; }
    .cost-positive { color: var(--success); font-weight: 600; font-family: 'Orbitron'; }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-active { background: rgba(0, 230, 118, 0.15); color: var(--success); border: 1px solid rgba(0, 230, 118, 0.3); }
    .badge-revoked { background: rgba(255, 23, 68, 0.15); color: var(--danger); border: 1px solid rgba(255, 23, 68, 0.3); }
    .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .admin-box { background: rgba(255, 174, 66, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 174, 66, 0.2); }
    input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; }
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { pointer-events: auto; background: rgba(16, 24, 45, 0.95); border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; min-width: 300px; animation: slideIn 0.4s; backdrop-filter: blur(10px); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal { background: #0f1623; border: 1px solid var(--glass-border); padding: 35px; border-radius: 20px; width: 90%; max-width: 420px; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; }
    .key-display { background: black; padding: 20px; border-radius: 12px; font-family: monospace; color: var(--success); word-break: break-all; margin: 20px 0; border: 1px dashed var(--glass-border); text-align: center; }
    .loader { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-bottom-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    .btn-loading .loader { display: inline-block; }
    .btn-loading span { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 768px) { .dashboard-grid, .admin-controls { grid-template-columns: 1fr; } header { flex-direction: column; text-align: center; gap: 15px; } }
  </style>
</head>
<body>

<div id="stars"></div>
<div id="toast-container"></div>

<div class="container">
  <header>
    <div class="brand">
      <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Logo">
      <div>
        <h1>Elvion AI</h1>
        <span style="font-size:0.75rem; color: var(--primary); letter-spacing: 2px; text-transform: uppercase;">Developer Console</span>
      </div>
    </div>
    <div class="user-info">
      <i class="fas fa-user-circle" style="color:var(--primary);"></i>
      <span id="user-email">Loading...</span>
      <button class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <div class="dashboard-grid">
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-wallet"></i> Wallet</h3><button class="btn-secondary btn-sm" onclick="loadAllData()"><i class="fas fa-sync"></i></button></div>
      <div class="balance-wrapper">
        <div class="balance-label">Available Balance</div>
        <div class="balance-amount"><span id="balance-display">---</span> <span style="font-size:1rem; color:var(--text-muted);">Cr</span></div>
      </div>
      <button class="btn" id="fund-wallet-btn"><i class="fas fa-bolt"></i> Fund Wallet</button>
    </div>

    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-rocket"></i> Actions</h3></div>
      <div class="action-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn btn-secondary" id="transfer-open-btn"><i class="fas fa-paper-plane"></i> Transfer</button>
        <button class="btn btn-secondary" id="generate-key-btn"><span><i class="fas fa-key"></i> New Key</span><div class="loader"></div></button>
      </div>
      <p style="font-size:0.8rem; color:var(--text-muted); margin-top:15px; text-align:center;">Key Gen costs 100 Cr</p>
    </div>

    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-pie"></i> Stats</h3></div>
      <div style="display:flex; justify-content: space-between; margin-top:10px;">
        <div><div style="color:var(--text-muted); font-size:0.8rem;">Active Keys</div><div style="font-family:'Orbitron'; font-size:1.5rem;" id="active-keys-display">0</div></div>
        <div><div style="color:var(--text-muted); font-size:0.8rem;">Total Calls</div><div style="font-family:'Orbitron'; font-size:1.5rem;" id="total-calls-display">0</div></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h3 class="card-title"><i class="fas fa-list-alt"></i> Recent Activity</h3></div>
    <div class="table-container">
      <table id="usage-table">
        <thead><tr><th>Activity</th><th style="text-align:right;">Amount</th><th style="text-align:right;">Time (UTC)</th></tr></thead>
        <tbody id="usage-list"><tr><td colspan="3" style="text-align:center; padding:30px;">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h3 class="card-title"><i class="fas fa-code"></i> API Credentials</h3></div>
    <div class="table-container">
      <table>
        <thead><tr><th>Key ID</th><th>Status</th><th>Created</th><th style="text-align:right;">Manage</th></tr></thead>
        <tbody id="key-list"><tr><td colspan="4" style="text-align:center;">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="admin-panel" style="display: none; border: 1px solid var(--warning);">
    <div class="card-header"><h3 class="card-title" style="color: var(--warning);"><i class="fas fa-user-shield"></i> Admin</h3></div>
    <div class="admin-controls">
      <div class="admin-box"><button class="btn" id="grant-self-btn" style="background:var(--warning); color:black;"><span>Set 100k Balance</span><div class="loader"></div></button></div>
      <div class="admin-box"><input type="email" id="gift-email" placeholder="Email"><input type="number" id="gift-amount" placeholder="Amount"><button class="btn btn-secondary" id="gift-btn" style="margin-top:10px;"><span>Send Grant</span><div class="loader"></div></button></div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="payment-modal"><div class="modal"><button class="close-modal" onclick="closeModal('payment-modal')">&times;</button><h3 style="text-align:center;">Fund Wallet</h3><input type="number" id="fund-amount" value="1000" min="100" style="font-size:1.5rem; text-align:center; color:var(--primary); font-weight:700;"><button class="btn" id="proceed-pay-btn" style="margin-top:20px;"><span>Proceed</span><div class="loader"></div></button></div></div>
<div class="modal-overlay" id="transfer-modal"><div class="modal"><button class="close-modal" onclick="closeModal('transfer-modal')">&times;</button><h3 style="text-align:center;">Transfer Credits</h3><input type="email" id="transfer-email" placeholder="Email"><input type="number" id="transfer-amount" placeholder="Amount" style="margin-top:10px;"><button class="btn" id="confirm-transfer-btn" style="margin-top:20px;"><span>Send</span><div class="loader"></div></button></div></div>
<div class="modal-overlay" id="key-modal"><div class="modal"><button class="close-modal" onclick="closeModal('key-modal')">&times;</button><h3 style="text-align:center; color:var(--success);">Key Created</h3><div class="key-display" id="new-key-text"></div><button class="btn btn-secondary" id="copy-key-btn">Copy</button></div></div>

<script type="module">
  const BACKEND_URL = "https://web-production-9a18.up.railway.app"; 
  const ADMIN_EMAIL = "koladhino@gmail.com";
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  });
  const auth = getAuth(app);
  let userToken = null;

  const dom = {
    balance: document.getElementById('balance-display'),
    activeKeys: document.getElementById('active-keys-display'),
    totalCalls: document.getElementById('total-calls-display'),
    usageList: document.getElementById('usage-list'),
    keyList: document.getElementById('key-list'),
    email: document.getElementById('user-email'),
    adminPanel: document.getElementById('admin-panel')
  };

  onIdTokenChanged(auth, async (user) => {
    if (user) {
      userToken = await user.getIdToken(true);
      dom.email.textContent = user.email;
      if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) dom.adminPanel.style.display = 'block';
      await loadAllData();
      await checkPaymentReturn(); // Triggers auto-verify
      window.loadAllData = loadAllData;
    } else {
      window.location.href = 'developer-login.html';
    }
  });

  document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

  async function apiCall(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json', 'X-Firebase-Token': userToken };
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    const res = await fetch(`${BACKEND_URL}${endpoint}`, config);
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Request failed');
    return data;
  }

  async function loadAllData() {
    try {
      const metrics = await apiCall('/api/user/keys-and-balance');
      dom.balance.textContent = (metrics.balance || 0).toLocaleString();
      dom.activeKeys.textContent = metrics.keys.filter(k => k.is_active).length;
      renderKeys(metrics.keys);

      const history = await apiCall('/api/user/usage-history');
      renderUsage(history.logs);
      dom.totalCalls.textContent = history.logs ? history.logs.length.toLocaleString() : 0;
    } catch (e) { console.error(e); }
  }

  function renderKeys(keys) {
    dom.keyList.innerHTML = '';
    if (!keys.length) return dom.keyList.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No keys found.</td></tr>';
    keys.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    keys.forEach(k => {
      const row = document.createElement('tr');
      row.innerHTML = `<td style="font-family:monospace; color:var(--primary);">...${k.api_key.slice(-8)}</td>
        <td><span class="badge ${k.is_active ? 'badge-active' : 'badge-revoked'}">${k.is_active ? 'Active' : 'Revoked'}</span></td>
        <td style="color:var(--text-muted); font-size:0.85rem;">${new Date(k.created_at).toLocaleDateString()}</td>
        <td style="text-align:right;">${k.is_active ? `<button class="btn-danger revoke-btn" data-key="${k.api_key}">Revoke</button>` : '-'}</td>`;
      dom.keyList.appendChild(row);
    });
    document.querySelectorAll('.revoke-btn').forEach(btn => btn.addEventListener('click', () => revokeKey(btn.dataset.key)));
  }

  function renderUsage(logs) {
    dom.usageList.innerHTML = '';
    if (!logs || !logs.length) return dom.usageList.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px;">No recent activity.</td></tr>';
    logs.forEach(l => {
      const row = document.createElement('tr');
      let cl = 'cost-negative', sign = '-', icon = 'microchip', style = '';
      if (l.type === 'funding' || l.type === 'gift') { cl = 'cost-positive'; sign = '+'; icon = 'wallet'; style = 'background:rgba(0,230,118,0.05);'; }
      row.innerHTML = `<td style="${style}"><i class="fas fa-${icon}"></i> ${l.endpoint || 'Action'}</td><td style="text-align:right; ${style}" class="${cl}">${sign} ${l.cost.toLocaleString()} Cr</td><td style="text-align:right; color:var(--text-muted); font-size:0.85rem; ${style}">${new Date(l.timestamp).toLocaleString()}</td>`;
      dom.usageList.appendChild(row);
    });
  }

  // --- CRITICAL FIX: RETRY LOGIC FOR PAYMENT ---
  async function checkPaymentReturn() {
    const params = new URLSearchParams(window.location.search);
    const ref = params.get('reference') || params.get('trxref');
    
    if (ref) {
      window.history.replaceState({}, document.title, window.location.pathname);
      showToast('Verifying transaction (Attempt 1/5)...', 'warning');
      
      // Retry Loop: Try 5 times, waiting 2 seconds between each
      for (let i = 1; i <= 5; i++) {
        try {
            const res = await apiCall(`/api/payments/verify?transaction_ref=${ref}`);
            
            if(res.status === 'success' || res.status === 'already_credited') {
                showToast(`Success! +${res.credits_added || 0} Cr`, 'success');
                await loadAllData();
                return; // Stop checking
            } else if (res.status === 'pending') {
                if (i < 5) {
                    showToast(`Still verifying... (${i}/5)`, 'warning');
                    await new Promise(r => setTimeout(r, 2000)); // Wait 2 seconds
                }
            } else {
                showToast('Payment Failed', 'error');
                return;
            }
        } catch(e) {
            console.log("Verify error:", e);
        }
      }
      showToast('Transaction verification timed out. Check back later.', 'error');
    }
  }

  const payBtn = document.getElementById('proceed-pay-btn');
  payBtn.addEventListener('click', async () => {
    const amount = parseInt(document.getElementById('fund-amount').value);
    setLoading(payBtn, true);
    try {
      const res = await apiCall('/api/payments/initiate', 'POST', { amount });
      window.location.href = res.checkout_url;
    } catch(e) { showToast(e.message, 'error'); setLoading(payBtn, false); }
  });

  const transferBtn = document.getElementById('confirm-transfer-btn');
  transferBtn.addEventListener('click', async () => {
    const email = document.getElementById('transfer-email').value, amount = parseInt(document.getElementById('transfer-amount').value);
    setLoading(transferBtn, true);
    try {
      const res = await apiCall('/api/user/transfer-credits', 'POST', { receiver_email: email, amount });
      showToast(res.message, 'success'); closeModal('transfer-modal'); await loadAllData();
    } catch(e) { showToast(e.message, 'error'); } finally { setLoading(transferBtn, false); }
  });

  const genBtn = document.getElementById('generate-key-btn');
  genBtn.addEventListener('click', async () => {
    setLoading(genBtn, true);
    try {
      const res = await apiCall('/api/user/create-api-key', 'POST');
      document.getElementById('new-key-text').textContent = res.api_key; openModal('key-modal'); await loadAllData();
    } catch (e) { showToast(e.message, 'error'); } finally { setLoading(genBtn, false); }
  });

  async function revokeKey(key) { if(confirm("Revoke?")) try { await apiCall('/api/user/revoke-api-key', 'POST', { api_key: key }); await loadAllData(); } catch (e) { showToast(e.message, 'error'); } }
  document.getElementById('grant-self-btn').addEventListener('click', async () => { try { await apiCall('/api/admin/grant-credits', 'POST'); await loadAllData(); } catch(e){} });
  document.getElementById('gift-btn').addEventListener('click', async () => { try { await apiCall('/api/admin/gift-credits', 'POST', { target_email: document.getElementById('gift-email').value, amount: parseInt(document.getElementById('gift-amount').value) }); await loadAllData(); } catch(e){} });

  function showToast(msg, type='success') {
    const t = document.createElement('div'); t.className = `toast`; t.style.borderLeft = `4px solid ${type === 'success' ? 'var(--success)' : 'var(--danger)'}`;
    t.innerHTML = `<span>${msg}</span>`; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 4500);
  }
  function setLoading(btn, isLoading) { btn.disabled = isLoading; btn.classList.toggle('btn-loading', isLoading); }
  window.openModal = (id) => document.getElementById(id).style.display = 'flex';
  window.closeModal = (id) => document.getElementById(id).style.display = 'none';
  document.getElementById('fund-wallet-btn').addEventListener('click', () => openModal('payment-modal'));
  document.getElementById('transfer-open-btn').addEventListener('click', () => openModal('transfer-modal'));
  document.getElementById('copy-key-btn').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('new-key-text').textContent); closeModal('key-modal'); });

  const stars = document.getElementById('stars');
  for(let i=0; i<80; i++) { const s = document.createElement('div'); s.className = 'star'; s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%'; s.style.width = Math.random()*2+'px'; s.style.height = s.style.width; s.style.animationDuration = (Math.random()*3+2)+'s'; stars.appendChild(s); }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
