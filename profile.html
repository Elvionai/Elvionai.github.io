<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Philadelphia AI - Cosmic Interface</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-purple: #c300ff;
            --dark-matter: #020410;
            --plasma-gradient: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            --glass-bg-strong: rgba(10, 12, 35, 0.6);
            --glass-bg-light: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-glow: 0 0 8px rgba(0, 242, 255, 0.7), 0 0 16px rgba(195, 0, 255, 0.5);
            --box-glow: 0 0 15px rgba(0, 242, 255, 0.3), 0 0 25px rgba(195, 0, 255, 0.2);
            --input-focus-glow: 0 0 20px rgba(0, 242, 255, 0.5);
            --submit-glow: 0 0 20px rgba(195, 0, 255, 0.5);
            --error-color: #ff4d4d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: 'Roboto', 'Segoe UI', Helvetica, sans-serif;
            background-color: var(--dark-matter);
            color: #fff;
        }

        /* --- ENHANCED COSMIC BACKGROUND ENGINE --- */
        #cosmos-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden; perspective: 1000px;
        }

        .nebula-layer {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background:
                radial-gradient(circle at 50% 50%, rgba(76, 0, 255, 0.1), transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 242, 255, 0.1), transparent 40%),
                radial-gradient(circle at 20% 80%, rgba(195, 0, 255, 0.15), transparent 50%);
            mix-blend-mode: screen;
            animation: drift 80s infinite linear alternate;
            transition: transform 0.5s ease-out;
        }
        .nebula-layer:nth-child(2) { animation: drift 60s infinite linear reverse; mix-blend-mode: overlay; }
        .nebula-layer:nth-child(3) {
            background: radial-gradient(circle at 50% 10%, rgba(200, 200, 255, 0.05), transparent 30%);
            animation: drift 120s infinite linear; mix-blend-mode: lighten;
        }

        @keyframes drift {
            from { transform: translate(0, 0) rotate(0deg); }
            to { transform: translate(-25%, -25%) rotate(180deg); }
        }

        .star, .shooting-star, .stardust { position: absolute; pointer-events: none; }

        .star {
            background: white; border-radius: 50%;
            animation: twinkle var(--duration) infinite ease-in-out;
            box-shadow: 0 0 5px #fff, 0 0 10px var(--neon-blue);
        }

        .stardust {
            background: var(--neon-blue); border-radius: 50%; width: 1px; height: 1px;
            opacity: 0.7; animation: floatUp var(--duration) infinite linear;
        }

        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.1); } }
        @keyframes floatUp { to { transform: translateY(-100vh); opacity: 0; } }

        .shooting-star {
            height: 2px; background: linear-gradient(-90deg, white, transparent);
            filter: drop-shadow(0 0 6px var(--neon-blue));
            animation: shoot 2.5s ease-out; opacity: 0; z-index: 0;
        }
        @keyframes shoot {
            0% { transform: translate(var(--startX), var(--startY)) rotate(-35deg); opacity: 1; width: 0; }
            20% { width: 100px; }
            100% { transform: translate(calc(var(--startX) - 600px), calc(var(--startY) + 400px)) rotate(-35deg); opacity: 0; width: 0; }
        }
        
        /* The Eagle Easter Egg */
        #cosmic-eagle {
            position: absolute;
            width: 50px;
            height: auto;
            opacity: 0.1;
            filter: grayscale(1) brightness(5) drop-shadow(0 0 10px var(--neon-blue));
            pointer-events: none;
            animation: fly-by 30s infinite linear;
            z-index: 1;
        }

        @keyframes fly-by {
            0% { top: 20%; left: -100px; transform: rotate(10deg) scale(0.5); }
            50% { top: 60%; left: 50vw; transform: rotate(-5deg) scale(1); opacity: 0.2; }
            100% { top: 30%; left: calc(100vw + 100px); transform: rotate(15deg) scale(0.5); }
        }

        /* --- UI MAIN STRUCTURE --- */
        .ui-container {
            width: 100%; max-width: 700px; height: 100vh;
            display: flex; flex-direction: column; position: relative; z-index: 10;
            background: rgba(5, 7, 20, 0.4);
        }

        header {
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;
            background: var(--glass-bg-strong); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border); box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            flex-shrink: 0; z-index: 1003;
        }

        .brand-plasma {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 700; letter-spacing: 1px;
            background: linear-gradient(90deg, #fff, var(--neon-blue), var(--neon-purple), #fff);
            background-size: 300% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: plasmaFlow 5s linear infinite; text-shadow: var(--text-glow);
            cursor: default;
        }
        @keyframes plasmaFlow { to { background-position: 300% center; } }

        .header-actions { display: flex; gap: 20px; font-size: 1.4rem; }
        .icon-btn { cursor: pointer; opacity: 0.7; transition: 0.3s; position: relative; color: #fff; background: none; border: none;}
        .icon-btn:hover { opacity: 1; text-shadow: var(--text-glow); transform: scale(1.1); }

        /* --- Cognitive Status Indicator --- */
        #cognitive-status {
            font-size: 0.8rem;
            color: var(--neon-blue);
            text-shadow: 0 0 5px var(--neon-blue);
            display: flex;
            align-items: center;
            gap: 8px;
            position: absolute;
            bottom: 100%;
            left: 25px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none; /* Make sure it doesn't block clicks below */
        }
        #cognitive-status.active { opacity: 1; }
        #status-text { letter-spacing: 1px; }
        #status-orb {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } }


        /* --- Chat Area --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        #chatBox {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
            scrollbar-width: thin; scrollbar-color: var(--neon-blue) transparent;
        }
        #chatBox::-webkit-scrollbar { width: 4px; }
        #chatBox::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 4px; }

        .chat-message { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .chat-message.ai { align-self: flex-start; }
        .chat-message.user { align-self: flex-end; align-items: flex-end; }

        .msg {
            padding: 16px 22px; border-radius: 24px; font-size: 1rem; line-height: 1.5;
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            word-wrap: break-word;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }
        @keyframes popIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .chat-message.ai .msg {
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.5), rgba(20, 20, 35, 0.7));
            border-bottom-left-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.05);
        }

        .chat-message.user .msg {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.2), rgba(195, 0, 255, 0.2));
            border-bottom-right-radius: 4px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: var(--box-glow); border: 1px solid rgba(255,255,255,0.2);
        }
        
        .msg pre {
            margin: 1em 0;
            padding: 1em; /* Adjusted padding for better look */
            border-radius: 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--neon-blue);
            box-shadow: var(--input-focus-glow);
            position: relative;
            overflow-x: auto; /* Allow horizontal scrolling for code */
        }
        .msg code { font-family: 'JetBrains Mono', monospace; }
        .copy-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border);
            color: #fff; padding: 5px 10px; border-radius: 8px; cursor: pointer; transition: 0.2s;
            font-size: 0.8em;
        }
        .copy-btn:hover { background: var(--neon-blue); color: #000; }

        /* --- Quick Actions --- */
        .quick-actions {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end; /* Align to the right for user-like feel */
        }
        .quick-action-btn {
            background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border);
            color: var(--neon-blue); border-radius: 15px; padding: 8px 15px;
            font-size: 0.85rem; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 5px; /* Icon and text alignment */
        }
        .quick-action-btn:hover { background: var(--neon-blue); color: var(--dark-matter); box-shadow: var(--input-focus-glow); }


        /* --- Input Dock --- */
        .input-dock {
            padding: 15px 20px;
            background: var(--glass-bg-strong); backdrop-filter: blur(25px);
            border-top: 1px solid var(--glass-border); display: flex; gap: 15px; align-items: center;
            flex-shrink: 0;
            position: relative; /* Needed for cognitive status positioning */
        }

        .capsule-input-wrapper {
            flex: 1; position: relative; min-height: 50px; /* Use min-height for textarea growth */
        }
        .capsule-input {
            width: 100%; min-height: 50px; /* Use min-height */
            background: var(--glass-bg-light); border-radius: 25px; border: 1px solid var(--glass-border);
            transition: 0.3s; display: flex; align-items: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.4);
        }
        .capsule-input:focus-within {
            border-color: var(--neon-blue); box-shadow: var(--input-focus-glow), inset 0 2px 10px rgba(0,0,0,0.4);
            background: rgba(0, 242, 255, 0.05);
        }
        .capsule-input textarea {
            width: 100%; height: auto; /* Let textarea determine its own height */
            min-height: 24px; /* Matches line-height + padding roughly */
            max-height: 120px;
            background: transparent; border: none; resize: none;
            padding: 13px 25px; color: #fff; font-size: 1rem; outline: none;
            scrollbar-width: none;
            line-height: 1.5; /* Ensure consistent line height */
        }
        .capsule-input textarea::-webkit-scrollbar { display: none; }

        .thruster-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer;
            background: var(--plasma-gradient); display: flex; align-items: center; justify-content: center;
            box-shadow: var(--submit-glow); transition: 0.3s; color: #fff; flex-shrink: 0;
        }
        .thruster-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(195, 0, 255, 0.8); }
        .thruster-btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
        
        .input-actions { display: flex; gap: 10px; }
        .input-actions .icon-btn { font-size: 1.2rem; width: 50px; height: 50px; border-radius: 50%; background: var(--glass-bg-light); border: 1px solid var(--glass-border); display: flex; justify-content: center; align-items: center; }
        .input-actions .icon-btn:hover { background: rgba(0, 242, 255, 0.1); border-color: var(--neon-blue); }

        #stopBtn { background: var(--error-color); }
        #stopBtn:hover { box-shadow: 0 0 20px var(--error-color); }

        /* --- Panel & Modal Styling --- */
        .panel-bg {
            display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
            background:rgba(5, 7, 20, 0.5); backdrop-filter: blur(10px);
            z-index:1200; transition: opacity 0.3s; opacity: 0;
        }
        .panel-bg.active{ display:block; opacity: 1; }
        .side-panel{
            position:absolute; top:0; left:-350px; height:100vh; width:325px;
            background: var(--glass-bg-strong); border-right: 1.5px solid var(--glass-border);
            box-shadow: var(--box-glow); z-index:1212; padding:20px; overflow-y:auto;
            transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .panel-bg.active .side-panel { left: 0; }
        .panel-header { text-align: center; margin-bottom: 20px; }
        .side-panel img { width:60px; height:60px; border-radius:50%; border:2px solid var(--neon-blue); box-shadow: var(--box-glow); }
        .side-panel .username { font-family: 'Orbitron', sans-serif; font-weight:700; font-size:1.1em; color: var(--neon-blue); text-shadow: var(--text-glow); margin-top: 10px;}
        .side-panel .email { font-size:.97em; color:#a8eaff; margin-top: 5px; }
        .side-panel a { color: #ccc; text-decoration: none; display: block; padding: 10px; border-radius: 8px; transition: 0.2s; }
        .side-panel a:hover { background: var(--glass-bg-light); color: #fff; }
        
        #profileMenu .submit-btn {
            display: block; width: fit-content; margin: 15px auto;
        }
        #profileMenu .submit-btn:last-child { margin-bottom: 20px; } /* Adjust margin for logout */

        .submit-btn {
            margin-top:14px; padding:12px 20px; background: var(--plasma-gradient); border:none;
            border-radius:10px; color: #fff; font-weight:bold; cursor:pointer; font-size:1.1em;
            box-shadow: var(--submit-glow); transition: 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 0 30px rgba(195, 0, 255, 0.8); }
        
        .chats-list button {
            background:none; border:none; cursor:pointer; outline:none; font-size:1.1em;
            margin:0 5px; vertical-align:middle; border-radius:7px; padding:3px 5px;
        }
        .chats-list .fa-pen { color:var(--neon-blue); }
        .chats-list .fa-pen:hover { color:#ffd800; }
        .chats-list .fa-trash { color:var(--error-color); }
        .chats-list .fa-trash:hover { color:#ff0000; }

        /* --- IMPROVED CALL MODAL --- */
        #callModal {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--dark-matter); z-index: 4000; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px; box-sizing: border-box; opacity: 0;
            transition: opacity 0.3s;
        }
        #callModal.active { display: flex; opacity: 1; }

        #botImageContainer {
            position: relative; width: 200px; height: 200px;
            display: flex; align-items: center; justify-content: center;
        }
        #botImageContainer .wave {
            position: absolute; border: 2px solid var(--neon-blue); border-radius: 50%;
            animation: wave-expand 3s infinite ease-out;
        }
        #botImageContainer .wave:nth-child(1) { animation-delay: 0s; }
        #botImageContainer .wave:nth-child(2) { animation-delay: 1s; }
        #botImageContainer .wave:nth-child(3) { animation-delay: 2s; }

        @keyframes wave-expand {
            from { width: 100px; height: 100px; opacity: 1; }
            to { width: 300px; height: 300px; opacity: 0; }
        }

        #botImageContainer img {
            width: 150px; height: 150px; border-radius: 50%;
            border: 4px solid var(--neon-blue); box-shadow: var(--box-glow), inset 0 0 20px rgba(0,0,0,0.5);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        #botImageContainer.speaking img {
            border-color: var(--neon-purple); transform: scale(1.05);
            animation: head-nod 1.2s infinite ease-in-out; /* Add head nod for speaking */
        }
        @keyframes head-nod {
            0% { transform: translateY(0) scale(1.05); }
            50% { transform: translateY(-3px) scale(1.05); }
            100% { transform: translateY(0) scale(1.05); }
        }


        #callConversation {
            width: 100%; max-width: 600px; height: 150px; overflow-y: auto;
            margin: 40px 0; text-align: center; font-size: 1.2rem;
            color: rgba(255,255,255,0.8);
            border: 1px solid var(--glass-border); border-radius: 10px;
            background: rgba(0,0,0,0.3); padding: 10px;
        }
        .call-msg { padding: 5px; word-wrap: break-word; }
        .call-msg.user { color: #fff; font-weight: 500; text-align: right; }
        .call-msg.bot { color: var(--neon-blue); text-align: left; }
        .call-msg.status { font-style: italic; color: #888; }


        #callStatusMessage { font-size: 1rem; color: #aaa; height: 20px; margin-top: 20px; }
        
        #callControls { display: flex; gap: 20px; margin-top: 40px; }
        #callControls button {
            width: 70px; height: 70px; font-size: 1.8rem;
            border: 1px solid var(--glass-border); border-radius: 50%;
            cursor: pointer; transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        #endCallBtn { background: #8B0000; color: white; }
        #endCallBtn:hover { background: var(--error-color); box-shadow: 0 0 20px var(--error-color); }
        #muteCallBtn { background: var(--glass-bg-strong); color: white; }
        #muteCallBtn:hover { background: rgba(255,255,255,0.2); }
        #muteCallBtn.muted { background: var(--neon-purple); }

        /* Other inherited styles from original file */
        .file-preview {
            display:none; background:var(--glass-bg-strong); border-radius:12px;
            color:#c4f2ff; font-size:.98em; box-shadow: var(--box-glow);
            margin:0 auto 10px auto; width:94vw; max-width:520px;
            padding:10px 14px; position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); z-index: 1002; border: 1.5px solid var(--glass-border);
        }
        .file-preview img, .file-preview video {
            max-width:58px; max-height:41px; border-radius:6px; margin-right:6px; vertical-align: middle;
        }
        .file-preview audio { width:52px; margin-right:7px; }
        .remove-file-btn {
            color: #fff !important; background:#d23 !important; border:none !important;
            border-radius:50% !important; padding:2px 6px !important; cursor:pointer !important;
            font-size:1.2em !important; font-weight:bold !important; margin-left:8px !important;
            transition: background .16s, color .16s !important; min-width: 24px !important;
            height: 24px !important; display: inline-flex !important; align-items: center !important;
            justify-content: center !important;
        }
        .remove-file-btn:hover { background:#ff4444 !important; transform: scale(1.1) !important; }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 247, 0.3);
            border-radius: 50%;
            border-top-color: var(--neon-blue);
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .ui-container { width: 100%; }
            header { padding: 10px 15px; }
            .brand-plasma { font-size: 1.2rem; }
            .header-actions { gap: 10px; font-size: 1.2rem; }
            .input-dock { padding: 10px; gap: 10px; }
            .input-actions .icon-btn, .thruster-btn { width: 45px; height: 45px; font-size: 1rem;}
            .capsule-input textarea { padding: 10px 15px; font-size: 0.9rem; }
            #cognitive-status { left: 10px; font-size: 0.7rem; }
            .chat-message { max-width: 95%; }
            .msg { padding: 12px 18px; font-size: 0.9rem; }
            .quick-actions { justify-content: center; }
            .side-panel { width: 100%; left: -100vw; }
            .panel-bg.active .side-panel { left: 0; }
        }
    </style>
</head>
<body>

    <!-- COSMIC BACKGROUND -->
    <div id="cosmos-container">
        <div class="nebula-layer"></div>
        <div class="nebula-layer"></div>
        <div class="nebula-layer"></div>
        <img src="https://i.ibb.co/6rW8kPZ/eagle-silhouette.png" id="cosmic-eagle" alt="Cosmic Eagle">
    </div>

    <!-- MAIN UI -->
    <div class="ui-container">
        <header>
            <div class="brand-plasma">ðŸ¦… Philadelphia AI ðŸ¦…</div>
            <div class="header-actions">
                <button class="icon-btn" id="openProfileMenu" title="User Profile & Chats"><i class="fa-solid fa-user-astronaut"></i></button>
                <button class="icon-btn" id="toolBtn" title="Philadelphia Tools"><i class="fa-solid fa-wrench"></i></button>
                <button class="icon-btn" id="openLinksMenu" title="Menu Links"><i class="fa-solid fa-link"></i></button>
            </div>
        </header>

        <div class="main-content">
            <div id="chatBox">
                <!-- Messages will be dynamically loaded here -->
            </div>
        </div>
        
        <div id="filePreview"></div>
        
        <div class="input-dock">
             <div id="cognitive-status">
                <div id="status-orb"></div>
                <span id="status-text">INITIALIZING</span>
            </div>
            <div class="input-actions">
                <label for="chatFile" class="icon-btn" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
                <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none">
                <button type="button" id="callBtn" class="icon-btn" title="Start Voice Call"><i class="fa-solid fa-phone"></i></button>
            </div>
            <div class="capsule-input-wrapper">
                <div class="capsule-input">
                    <textarea id="chatInput" placeholder="Broadcast your message..." autocomplete="off" rows="1"></textarea>
                </div>
            </div>
            <button class="thruster-btn" id="sendBtn" title="Send">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>
    
    <!-- PANELS AND MODALS -->
    <div class="panel-bg" id="profileMenuBg">
        <nav class="side-panel" id="profileMenu">
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <span style="font-size:1.17em;font-weight:700;color:var(--neon-blue);margin:18px 0 0 13px;">Chats</span>
                <button style="font-size:1.55em;color:var(--error-color);background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;" onclick="profileMenuBg.classList.remove('active');">&times;</button>
            </div>
            <div id="chatsList" class="chats-list" style="margin:7px 0 8px 6px;max-height:161px;overflow-y:auto;">
                <div class="spinner" style="margin: 20px auto; display: block;"></div>
            </div>
            <button id="newChatBtn" class="submit-btn" style="margin:0 auto 12px auto;"><i class="fa-solid fa-plus"></i> New Chat</button>
            <hr style="width:91%;margin:11px 0 7px 3%;border:1px solid rgba(0,255,240,0.3);">
            <div class="panel-header">
                <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
                <div class="username" id="profileMenuUser">User</div>
                <div class="email" id="profileMenuEmail">email@example.com</div>
            </div>
            <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 6px;">
                <label for="edit-name" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Name</label>
                <input type="text" id="edit-name" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                <label for="edit-photo" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Photo URL</label>
                <input type="url" id="edit-photo" placeholder="Paste image link" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                <span style="font-size:0.83em;color:#aae;display:block;margin:5px 0 7px 2px;"> Tip: <a href="https://postimg.cc/" target="_blank" style="color:var(--neon-blue);">Upload at postimg.cc</a> </span>
                <button type="submit" class="submit-btn" style="width:100px;">Save</button>
                <div class="status-message" id="profileStatusMsg" style="padding:6px 13px;color:var(--neon-blue);font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;"></div>
            </form>
            <button class="submit-btn" id="logoutBtn" style="background:transparent;color:var(--neon-blue);border:1px solid var(--neon-blue);width:100px;">Logout</button>
        </nav>
    </div>

    <div class="panel-bg" id="linkMenuBg">
        <nav class="side-panel" id="linkMenu">
            <div class="panel-header">
                <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Philadelphia logo">
                <div class="username">Philadelphia AI</div>
            </div>
            <div class="panel-links" style="margin-top: 20px;">
                <a href="philadelphia.html"><i class="fa-solid fa-home"></i>Philadelphia Homepage</a>
                <a href="index.html"><i class="fa-solid fa-home"></i>Elvion Homepage</a>
                <a href="about.html"><i class="fa-solid fa-circle-info"></i> About US</a>
                <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
                <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
                <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Try Telegram Version</a>
            </div>
            <button style="font-size:1.55em;color:var(--error-color);background:transparent;border:none;margin:13px auto 0 auto;cursor:pointer;border-radius:7px;display:block;" onclick="linkMenuBg.classList.remove('active');">&times;</button>
        </nav>
    </div>

    <div class="panel-bg" id="toolsMenuBg">
        <nav class="side-panel" id="toolsMenu">
            <div class="panel-header" style="text-align:left;">
                <div class="username" style="font-size:1.2em;margin-left:-8px;text-align:center;">Philadelphia AI Tools</div>
            </div>
            <div class="panel-links" style="margin-top: 20px;">
                <h3 style="color:var(--neon-blue);margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Creative Suite</h3>
                <a href="#" class="tool-link" data-tool="image"><i class="fa-solid fa-image"></i> Generate Image</a>
                <a href="#" class="tool-link" data-tool="edit-photo"><i class="fa-solid fa-wand-magic-sparkles"></i> Edit Photo</a>
                <a href="#" class="tool-link" data-tool="remove-bg"><i class="fa-solid fa-scissors"></i> Remove Background</a>
                <a href="#" class="tool-link" data-tool="comic"><i class="fa-solid fa-book-open"></i> Create Comic</a>
                <hr style="border-color: rgba(0,234,255,0.3); margin: 10px 0;">
                <h3 style="color:var(--neon-blue);margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Audio & Video</h3>
                <a href="#" class="tool-link" data-tool="voice-gen"><i class="fa-solid fa-microphone-lines"></i> Voice Generation</a>
                <a href="#" class="tool-link" data-tool="audio-narration"><i class="fa-solid fa-file-audio"></i> Audio Narration</a>
                <a href="#" class="tool-link" data-tool="video-text"><i class="fa-solid fa-film"></i> Text-to-Video</a>
                <a href="#" class="tool-link" data-tool="video-image"><i class="fa-solid fa-photo-film"></i> Image-to-Video</a>
                <a href="#" class="tool-link" data-tool="music"><i class="fa-solid fa-music"></i> Generate Music</a>
                <hr style="border-color: rgba(0,234,255,0.3); margin: 10px 0;">
                <h3 style="color:var(--neon-blue);margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Web & Research</h3>
                <a href="#" class="tool-link" data-tool="website"><i class="fa-solid fa-globe"></i> Create Website</a>
                <a href="#" class="tool-link" data-tool="edit-website"><i class="fa-solid fa-pen-ruler"></i> Edit Last Website</a>
                <a href="#" class="tool-link" data-tool="my-sites"><i class="fa-solid fa-list-check"></i> My Websites</a>
                <a href="#" class="tool-link" data-tool="research-report"><i class="fa-solid fa-flask-vial"></i> Research Report</a>
            </div>
            <button class="submit-btn" style="margin-top:17px; width:100px; display: block; margin-left: auto; margin-right: auto;" onclick="closeToolMenu();">Close</button>
        </nav>
    </div>

    <div class="panel-bg" id="toolFormModalBg">
        <nav class="side-panel" id="toolFormModal">
            <div class="panel-header">
                <div class="username" id="toolFormTitle">Tool Title</div>
            </div>
            <form class="edit-form" id="toolForm" style="padding:0 6px;"></form>
            <button id="toolFormBackBtn" class="submit-btn" style="background:transparent;color:var(--neon-blue);border:1px solid var(--neon-blue);margin:7px 7px 17px 7px; width:fit-content;">
                <i class="fa-solid fa-arrow-left"></i> Back to Tools
            </button>
            <div class="status-message" id="toolStatusMsg" style="padding:6px 13px;color:var(--neon-blue);font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;"></div>
        </nav>
    </div>

    <div id="callModal">
        <div id="botImageContainer">
            <div class="wave"></div><div class="wave"></div><div class="wave"></div>
            <img src="https://i.postimg.cc/XqL63yM9/IMG-20250824-133336-309.jpg" alt="Bot">
        </div>
        <div id="callConversation">
            <div class="call-msg status">Initializing neural link...</div>
        </div>
        <div id="callStatusMessage">Connecting...</div>
        <div id="callControls">
            <button id="muteCallBtn"><i class="fa-solid fa-microphone"></i></button>
            <button id="endCallBtn"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>
    
    <!-- JavaScript logic from original file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, query, orderBy, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
            authDomain: "elvionai.firebaseapp.com",
            projectId: "elvionai",
            storageBucket: "elvionai.appspot.com",
            messagingSenderId: "161078300830",
            appId: "1:161078300830:web:f460df8591704eb0e96b8f"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const $ = id => document.getElementById(id);
        const API_BASE_URL = 'https://web-production-9a18.up.railway.app';
        
        // --- Sound Effects UI Kit ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const sounds = {
            send: { freq: [440, 880], type: 'triangle', dur: 0.1 },
            receive: { freq: [880, 440], type: 'sine', dur: 0.15 },
            open: { freq: [600, 900], type: 'square', dur: 0.08 },
            close: { freq: [900, 600], type: 'square', dur: 0.08 },
            error: { freq: [200, 100], type: 'sawtooth', dur: 0.2 }
        };

        function playSound(name) {
            try {
                const sound = sounds[name];
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = sound.type;
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + sound.dur);
                
                oscillator.frequency.setValueAtTime(sound.freq[0], audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(sound.freq[1], audioContext.currentTime + sound.dur);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + sound.dur);
            } catch (e) {
                // Audio context can fail on some browsers if not user-initiated
                console.warn("Could not play sound:", e);
            }
        }


        // --- COSMIC ENGINE JS ---
        const cosmos = $('cosmos-container');
        const nebulaLayers = document.querySelectorAll('.nebula-layer');
        
        function createParticle(type, spread, maxDuration) {
            const particle = document.createElement('div');
            particle.className = type;
            const size = Math.random() * (type === 'star' ? 2 : 1.5) + 0.5;
            particle.style.width = `${size}px`; particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * spread}%`;
            particle.style.top = `${Math.random() * spread}%`;
            particle.style.setProperty('--duration', `${Math.random() * maxDuration + 5}s`);
            if(type==='star') particle.style.opacity = Math.random();
            cosmos.appendChild(particle);
        }

        function launchShootingStar() {
            const star = document.createElement('div');
            star.className = 'shooting-star';
            const startX = Math.random() * window.innerWidth * 1.5;
            const startY = -100;
            star.style.setProperty('--startX', `${startX}px`);
            star.style.setProperty('--startY', `${startY}px`);
            cosmos.appendChild(star);
            setTimeout(() => star.remove(), 2500);
        }

        function igniteCosmos() {
            for (let i = 0; i < 150; i++) createParticle('star', 100, 5);
            for (let i = 0; i < 50; i++) createParticle('stardust', 100, 15);
            
            const randomLaunch = () => {
                launchShootingStar();
                setTimeout(randomLaunch, Math.random() * 5000 + 3000);
            }
            setTimeout(randomLaunch, 2000);
            
            // Parallax Effect
            window.addEventListener('mousemove', e => {
                const { clientX, clientY } = e;
                const x = (clientX / window.innerWidth - 0.5) * -50;
                const y = (clientY / window.innerHeight - 0.5) * -50;
                nebulaLayers.forEach((layer, i) => {
                    const depth = (i + 1) * 0.5;
                    layer.style.transform = `translate(${x * depth}px, ${y * depth}px)`;
                });
            });
        }


        // --- Cognitive Status Indicator ---
        const cognitiveStatus = $('cognitive-status');
        const statusText = $('status-text');
        const statuses = ["PARSING QUERY", "ACCESSING DATA STREAM", "SYNTHESIZING RESPONSE", "QUERYING NEURAL NET", "GENERATING PHOTONS"];
        let statusInterval;

        function showCognitiveStatus(active, text = '') {
            if (active) {
                cognitiveStatus.classList.add('active');
                if (text) {
                    statusText.textContent = text;
                    clearInterval(statusInterval);
                } else {
                    let i = 0;
                    statusText.textContent = statuses[i];
                    statusInterval = setInterval(() => {
                        i = (i + 1) % statuses.length;
                        statusText.textContent = statuses[i];
                    }, 1500);
                }
            } else {
                cognitiveStatus.classList.remove('active');
                clearInterval(statusInterval);
            }
        }


        // --- MAIN CHAT APPLICATION LOGIC (MERGED & ENHANCED) ---
        let chats = [];
        let currentChatId = null;
        let currentMessages = [];
        let uploadedFiles = [];
        let currentUser = null;
        let currentController = null;

        let chatsUnsubscribe = null;
        let messagesUnsubscribe = null;
        
        const chatInput = $('chatInput');
        const sendBtn = $('sendBtn');
        const chatFile = $('chatFile');
        const filePreview = $('filePreview');
        const chatBox = $('chatBox');
        const profileMenuBg = $('profileMenuBg');
        const profileMenu = $('profileMenu');
        const linkMenuBg = $('linkMenuBg');
        const linkMenu = $('linkMenu');
        const toolsMenuBg = $('toolsMenuBg');
        const toolsMenu = $('toolsMenu');
        const toolBtn = $('toolBtn');
        const logoutBtn = $('logoutBtn');
        const newChatBtn = $('newChatBtn');
        const chatsListEl = $('chatsList');
        const profileMenuUser = $('profileMenuUser');
        const profileMenuEmail = $('profileMenuEmail');
        const editName = $('edit-name');
        const editPhoto = $('edit-photo');
        const profilePicPreview = $('profilePicPreview');
        const profileForm = $('profileForm');
        const toolFormModalBg = $('toolFormModalBg');
        const toolForm = $('toolForm');
        const toolFormTitle = $('toolFormTitle');
        const toolFormBackBtn = $('toolFormBackBtn');
        const callBtn = $('callBtn');
        const callModal = $('callModal');
        const endCallBtn = $('endCallBtn');
        const muteCallBtn = $('muteCallBtn');
        const callConversation = $('callConversation');
        const botImageContainer = $('botImageContainer');
        const callStatusMessage = $('callStatusMessage');


        // Auto-resize textarea
        chatInput.addEventListener('input', () => {
            chatInput.style.height = 'auto';
            chatInput.style.height = `${Math.min(chatInput.scrollHeight, 120)}px`;
        });
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

        // Chat File Upload
        if (chatFile) {
            chatFile.addEventListener('change', function() {
                uploadedFiles = Array.from(this.files || []);
                renderFilePreview();
            });
        }

        function renderFilePreview() {
            if (!filePreview) return;
            if (!uploadedFiles.length) {
                filePreview.style.display = 'none';
                filePreview.innerHTML = '';
                return;
            }
            filePreview.style.display = 'block';
            filePreview.innerHTML = uploadedFiles.map((file, idx) => {
                let preview = '';
                if (file.type.startsWith('image/')) {
                    preview = `<img src="${URL.createObjectURL(file)}" style="max-width:58px;max-height:41px;vertical-align:middle;border-radius:8px;margin-right:6px;">`;
                } else if (file.type.startsWith('video/')) {
                    preview = `<video src="${URL.createObjectURL(file)}" controls style="max-width:58px;height:41px;vertical-align:middle;border-radius:8px;margin-right:7px;"></video>`;
                } else if (file.type.startsWith('audio/')) {
                    preview = `<audio controls src="${URL.createObjectURL(file)}" style="vertical-align:middle;width:52px;margin-right:7px;"></audio>`;
                } else if (file.type === 'application/pdf') {
                    preview = `<span style="font-size:1.25em;margin-right:7px;">ðŸ“„</span>`;
                }
                return `
                    <div style="display:flex;align-items:center;gap:7px;margin-bottom:1px;">
                        ${preview}
                        <span style="color:#aee;font-size:.99em;">${escapeHTML(file.name)}</span>
                        <button type="button" data-idx="${idx}" class="remove-file-btn" aria-label="Remove file">&times;</button>
                    </div>`;
            }).join('');

            filePreview.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.getAttribute('data-idx'));
                    uploadedFiles.splice(idx, 1);
                    if (!uploadedFiles.length && chatFile) chatFile.value = '';
                    renderFilePreview();
                });
            });
        }


        // Markdown Utility Functions
        const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

        function inlineMarkdown(t = '') {
            let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`);
            s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
            s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
            s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            return s.replace(/\n/g, '<br>');
        }

        function renderMarkdown(text = '') {
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            let html = '';
            let lastIndex = 0;
            text = text || '';
            text.replace(codeBlockRegex, (match, lang, code, offset) => {
                const before = text.slice(lastIndex, offset);
                html += inlineMarkdown(before);
                const language = (lang || '').toLowerCase().trim();
                const safe = escapeHTML(code);
                html += `<pre><button class="copy-btn">Copy</button><code class="language-${language || 'plaintext'}">${safe}</code></pre>`;
                lastIndex = offset + match.length;
                return match;
            });
            html += inlineMarkdown(text.slice(lastIndex));
            return { html };
        }

        function enhanceCodeBlocks(container) {
            if (!container) return;
            container.querySelectorAll('pre').forEach(pre => {
                const codeEl = pre.querySelector('code');
                if (window.hljs && codeEl) {
                    try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ }
                }
                const btn = pre.querySelector('.copy-btn');
                if (btn && codeEl) {
                    btn.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(codeEl.innerText);
                            const prev = btn.textContent;
                            btn.textContent = 'Copied!';
                            setTimeout(() => btn.textContent = prev, 800);
                        } catch (e) {
                            btn.textContent = 'Failed';
                            setTimeout(() => btn.textContent = 'Copy', 800);
                        }
                    });
                }
            });
        }


        // NEW: Progressive typewriter for code blocks
        async function startTypewriter(text, saveToDb = true) {
            const div = document.createElement('div');
            div.className = "chat-message ai";
            const msgdiv = document.createElement('div');
            msgdiv.className = 'msg';
            div.appendChild(msgdiv);
            chatBox.appendChild(div);

            let tempText = '';
            const words = text.split(/(\s+)/); // Split by words and whitespace
            for (const word of words) {
                if (currentController?.signal.aborted) {
                    text = tempText; // Save progress
                    break;
                }
                tempText += word;
                // Render unformatted text during typing for speed
                msgdiv.textContent = tempText; 
                chatBox.scrollTop = chatBox.scrollHeight;
                const delay = Math.random() * 20 + 10; // Varied typing speed
                await new Promise(res => setTimeout(res, delay));
            }
            
            // After typing, render the final markdown and highlight code
            const finalHtml = renderMarkdown(text).html;
            msgdiv.innerHTML = finalHtml;
            enhanceCodeBlocks(msgdiv);
            addQuickActions(msgdiv, text); // Add contextual buttons
            chatBox.scrollTop = chatBox.scrollHeight;

            if (saveToDb) {
                const messagesCol = collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages');
                await addDoc(messagesCol, { role: 'ai', text: text, createdAt: serverTimestamp() });
            }
            playSound('receive');
        }
        
        // NEW: Quick Actions Feature
        function addQuickActions(msgElement, text) {
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'quick-actions';
            
            // Add a "Copy" button for any message
            const copyBtn = document.createElement('button');
            copyBtn.className = 'quick-action-btn';
            copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(text);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy'; }, 1000);
            };
            actionsContainer.appendChild(copyBtn);

            // Add "Explain Further" button
            const explainBtn = document.createElement('button');
            explainBtn.className = 'quick-action-btn';
            explainBtn.innerHTML = '<i class="fa-solid fa-lightbulb"></i> Explain';
            explainBtn.onclick = () => {
                chatInput.value = `Explain the following in simpler terms:\n\n"${text.substring(0, Math.min(text.length, 100))}..."`;
                sendBtn.click();
            };
            actionsContainer.appendChild(explainBtn);
            
            msgElement.appendChild(actionsContainer);
        }


        // Chat Management Functions
        async function loadUserChats(userId) {
            if (chatsUnsubscribe) chatsUnsubscribe();
            const chatsCol = collection(db, 'users', userId, 'chats');
            const q = query(chatsCol, orderBy('createdAt', 'desc'));
            chatsUnsubscribe = onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) {
                    await createNewChat(userId);
                    return;
                }
                chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChatsListSidebar();
                if (!currentChatId || !chats.find(c => c.id === currentChatId)) {
                    currentChatId = chats[0].id;
                }
                subscribeToMessages(userId, currentChatId);
            }, (error) => {
                console.error("Error fetching chats: ", error);
                chatsListEl.innerHTML = `<div style="color: var(--error-color);">Error loading chats.</div>`;
            });
        }

        async function createNewChat(userId) {
            if (!userId) userId = currentUser?.uid;
            if (!userId) return;
            const chatsCol = collection(db, 'users', userId, 'chats');
            try {
                const newChatDoc = await addDoc(chatsCol, { name: "New Chat", createdAt: serverTimestamp() });
                currentChatId = newChatDoc.id;
            } catch (e) {
                console.error("Error creating new chat: ", e);
            }
        }

        function subscribeToMessages(userId, chatId) {
            if (messagesUnsubscribe) messagesUnsubscribe();
            if (!userId || !chatId) {
                renderChatBox([]);
                return;
            }
            const messagesCol = collection(db, 'users', userId, 'chats', chatId, 'messages');
            const q = query(messagesCol, orderBy('createdAt'));
            messagesUnsubscribe = onSnapshot(q, (snapshot) => {
                currentMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChatBox(currentMessages);
            }, (error) => {
                console.error("Error fetching messages: ", error);
                chatBox.innerHTML = `<div style="color: var(--error-color); text-align: center; margin-top: 20px;">Error loading messages for this chat.</div>`;
            });
        }

        function renderChatsListSidebar() {
            if (!chatsListEl) return;
            chatsListEl.innerHTML = '';
            if (chats.length === 0) {
                chatsListEl.innerHTML = `<div style="padding: 10px; color: #a8eaff;">No chats yet.</div>`;
                return;
            }
            chats.forEach((chat) => {
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.marginBottom = '6px';
                container.style.background = chat.id === currentChatId ? 'rgba(0, 234, 255, 0.15)' : 'transparent';
                container.style.borderRadius = '8px';

                const titleSpan = document.createElement('span');
                titleSpan.textContent = chat.name || `Chat`;
                titleSpan.style.flex = '1';
                titleSpan.style.cursor = 'pointer';
                titleSpan.style.padding = '8px 5px';
                titleSpan.onclick = () => {
                    currentChatId = chat.id;
                    subscribeToMessages(currentUser.uid, currentChatId);
                    renderChatsListSidebar();
                    profileMenu?.classList.remove('active');
                    profileMenuBg?.classList.remove('active');
                    playSound('close');
                };

                const renameBtn = document.createElement('button');
                renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
                renameBtn.title = 'Rename';
                renameBtn.style.margin = '0 6px 0 8px';
                renameBtn.onclick = async (e) => {
                    e.stopPropagation();
                    const newName = prompt("Rename chat:", chat.name);
                    if (newName && newName.trim()) {
                        const chatDoc = doc(db, 'users', currentUser.uid, 'chats', chat.id);
                        await setDoc(chatDoc, { name: newName.trim() }, { merge: true });
                    }
                };

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                delBtn.title = 'Delete';
                delBtn.style.marginLeft = '6px';
                delBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!confirm(`Delete "${chat.name}"? This will delete all messages.`)) return;

                    const messagesCol = collection(db, 'users', currentUser.uid, 'chats', chat.id, 'messages');
                    const messagesSnap = await getDocs(messagesCol);
                    const batch = writeBatch(db);
                    messagesSnap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    const chatDoc = doc(db, 'users', currentUser.uid, 'chats', chat.id);
                    await deleteDoc(chatDoc);

                    if (currentChatId === chat.id) {
                        currentChatId = null;
                    }
                };

                container.appendChild(titleSpan);
                container.appendChild(renameBtn);
                container.appendChild(delBtn);
                chatsListEl.appendChild(container);
            });
        }

        function renderChatBox(messages = []) {
            if (!chatBox) return;
            chatBox.innerHTML = '';
            (messages || []).forEach((msg) => {
                const div = document.createElement('div');
                div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'ai');
                div.setAttribute('data-message-id', msg.id);
                let contentHtml = '';

                if (msg.role === 'user') {
                    const fileHtml = (msg.files || [])
                        .map(file => {
                            let icon = 'fa-file';
                            if (file.type.startsWith('image/')) icon = 'fa-file-image';
                            else if (file.type.startsWith('video/')) icon = 'fa-file-video';
                            else if (file.type.startsWith('audio/')) icon = 'fa-file-audio';
                            else if (file.type === 'application/pdf') icon = 'fa-file-pdf';
                            return `<div class="file-placeholder" style="display:inline-block;padding:8px 12px;background:#0b2447;border:1px solid #1af8ff51;border-radius:10px;color:var(--neon-blue);text-decoration:none;font-size:0.9em;font-weight:bold;"><i class="fa-solid ${icon}" style="margin-right:5px;"></i> ${escapeHTML(file.name)}</div>`;
                        })
                        .join('');

                    contentHtml = `${fileHtml ? `<div class="file-attachments" style="display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;">${fileHtml}</div>` : ''}
                        ${inlineMarkdown(msg.text || '')}`; // Use inlineMarkdown for user messages
                } else {
                    // For AI messages, use full markdown rendering
                    contentHtml = renderMarkdown(msg.text || '').html;
                }
                
                div.innerHTML = `<div class="msg">${contentHtml}</div>`;
                chatBox.appendChild(div);

                if (msg.role === 'ai') {
                    enhanceCodeBlocks(div.querySelector('.msg'));
                    addQuickActions(div.querySelector('.msg'), msg.text); // Add quick actions to AI messages
                }
            });
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 50);
        }

        async function deleteMessagesFrom(messageId) {
            if (!currentChatId || !currentUser) return;
            const msgIndex = currentMessages.findIndex(m => m.id === messageId);
            if (msgIndex === -1) return;
            const batch = writeBatch(db);
            const messagesCol = collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages');
            for (let i = msgIndex; i < currentMessages.length; i++) {
                const msgToDel = currentMessages[i];
                const docRef = doc(messagesCol, msgToDel.id);
                batch.delete(docRef);
            }
            try {
                await batch.commit();
            } catch (e) {
                console.error("Error deleting messages: ", e);
            }
        }
        
        async function addMessageToChat(role, text, files = []) {
            if (!currentChatId || !currentUser) return;
            const messagesCol = collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages');
            try {
                await addDoc(messagesCol, { role, text, files, createdAt: serverTimestamp() });
            } catch (e) {
                console.error("Error adding message to Firestore: ", e);
            }
        }


        // Profile Menu Handlers
        if (profileMenuBg) {
            $('openProfileMenu').addEventListener('click', () => {
                profileMenuBg.classList.add('active');
                setTimeout(() => profileMenu.classList.add('active'), 10);
                playSound('open');
            });
            profileMenuBg.addEventListener('click', e => {
                if (e.target === profileMenuBg) {
                    profileMenu.classList.remove('active');
                    setTimeout(() => profileMenuBg.classList.remove('active'), 400);
                    playSound('close');
                }
            });
        }
        if (logoutBtn) logoutBtn.addEventListener('click', () => {
            auth.signOut();
            window.location.href = 'signup-login.html';
        });
        if (profileForm) {
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) return;
                const status = $('profileStatusMsg');
                if (status) status.textContent = 'Saving...';
                try {
                    await updateProfile(currentUser, { displayName: editName.value, photoURL: editPhoto.value });
                    if (auth.currentUser) await auth.currentUser.reload();
                    if (status) {
                        status.textContent = "Profile updated!";
                        status.style.color = "var(--neon-blue)";
                    }
                    setTimeout(() => {
                        profileMenuBg?.classList.remove('active');
                        playSound('close');
                    }, 800);
                } catch (err) {
                    if (status) {
                        status.textContent = err.message;
                        status.style.color = "var(--error-color)";
                    }
                }
            });
        }
        if (newChatBtn) newChatBtn.addEventListener('click', () => createNewChat(currentUser.uid));


        // Links Menu Handlers
        if (linkMenuBg) {
            $('openLinksMenu').addEventListener('click', () => {
                linkMenuBg.classList.add('active');
                setTimeout(() => linkMenu.classList.add('active'), 10);
                playSound('open');
            });
            linkMenuBg.addEventListener('click', e => {
                if (e.target === linkMenuBg) {
                    linkMenu.classList.remove('active');
                    setTimeout(() => linkMenuBg.classList.remove('active'), 400);
                    playSound('close');
                }
            });
        }
        
        // Tools Menu Handlers
        window.closeToolMenu = () => {
            if (toolsMenuBg) toolsMenuBg.classList.remove('active');
            playSound('close');
        };
        window.openToolMenu = () => {
            if (toolsMenuBg) toolsMenuBg.classList.add('active');
            playSound('open');
        };

        if (toolBtn) toolBtn.addEventListener('click', openToolMenu);
        if (toolsMenuBg) toolsMenuBg.addEventListener('click', e => {
            if (e.target === toolsMenuBg) closeToolMenu();
        });

        if (toolFormBackBtn) {
            toolFormBackBtn.addEventListener('click', () => {
                toolFormModalBg.classList.remove('active');
                openToolMenu();
            });
        }

        if (toolFormModalBg) toolFormModalBg.addEventListener('click', e => {
            if (e.target === toolFormModalBg) toolFormModalBg.classList.remove('active');
        });
        
        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // TOOL DEFINITIONS & HANDLERS
        const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
        const toolDefinitions = {
            "image": {
                title: "Generate Image",
                description: "Create stunning visuals from a text prompt. Choose a model for different results.",
                buildForm: () => `
                    <label for="tool-provider" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Generation Model</label>
                    <select id="tool-provider" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;"><option value="thena">Version 1 (Stylized, Fast & Recommended)</option><option value="minimax">Version 2 (Creative, Realistic, good for text in images)</option></select>
                    <label for="tool-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Image Prompt</label>
                    <textarea id="tool-prompt" placeholder="A futuristic cityscape, vibrant neon signs, flying cars" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="tool-style" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Style (for Version1 only)</label>
                    <select id="tool-style" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">${thenaModels.map(s => `<option value="${s.toLowerCase()}">${s}</option>`).join('')}</select>
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-sparkles"></i> Generate</button>`,
                handleSubmit: async (form) => {
                    const use_minimax = form.querySelector('#tool-provider').value === 'minimax';
                    const providerName = use_minimax ? 'Version 2 (Creative)' : 'Version 1 (Stylized)';
                    const payload = { prompt: form.querySelector('#tool-prompt').value, model: form.querySelector('#tool-style').value, use_minimax };
                    await addMessageToChat('user', `Image generation request: "${payload.prompt}" (using ${providerName})`);
                    showCognitiveStatus(true, 'Generating image...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/generate-image`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || res.statusText);
                        
                        const imgHtml = `âœ… Image generated! <br><img src="data:image/png;base64,${data.image_b64}" alt="AI generated image" style="max-width: 100%; max-height: 250px; border-radius: 12px; display: block; margin-top: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);">`;
                        showCognitiveStatus(false);
                        await startTypewriter(imgHtml, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Image generation failed: ${err.message}`;
                    }
                }
            },
            "edit-photo": {
                title: "Edit Photo",
                description: "Upload a photo and describe the changes you want to make.",
                buildForm: () => `
                    <label for="tool-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Edit Instruction</label><textarea id="tool-prompt" placeholder="Change the background to a sunny beach" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="tool-file" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Image to Edit</label><input type="file" id="tool-file" accept="image/*" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-wand-magic-sparkles"></i> Apply Edit</button>`,
                handleSubmit: async (form) => {
                    const file = form.querySelector('#tool-file').files[0];
                    const prompt = form.querySelector('#tool-prompt').value;
                    if (!file) return "Please select a file to edit.";
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('prompt', prompt);
                    await addMessageToChat('user', `Photo edit request for ${file.name}: "${prompt}"`, [{name: file.name, type: file.type}]);
                    showCognitiveStatus(true, 'Editing photo...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/edit-photo`, { method: 'POST', body: fd });
                        if (!res.ok) throw new Error((await res.json()).error || 'Failed to edit photo.');
                        const blob = await res.blob();
                        const base64String = await blobToBase64(blob);
                        const imgHtml = `âœ… Photo edited successfully! <br><img src="${base64String}" alt="Edited Photo" class="chat-media-preview" style="max-width: 100%; max-height: 250px; border-radius: 12px; display: block; margin-top: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);">`;
                        showCognitiveStatus(false);
                        await startTypewriter(imgHtml, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Photo edit failed: ${err.message}`;
                    }
                }
            },
            "remove-bg": {
                title: "Remove Background",
                description: "Select an image file to automatically remove its background.",
                buildForm: () => `
                    <label for="tool-file" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Select Image File</label><input type="file" id="tool-file" accept="image/*" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;"></input>
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-scissors"></i> Remove Background</button>`,
                handleSubmit: async (form) => {
                    const file = form.querySelector('#tool-file').files[0];
                    if (!file) return "Please select a file.";
                    await addMessageToChat('user', `Background removal request for: "${file.name}"`, [{name: file.name, type: file.type}]);
                    showCognitiveStatus(true, 'Removing background...');
                    const fd = new FormData();
                    fd.append('file', file);
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/remove-background`, { method: 'POST', body: fd });
                        if (!res.ok) throw new Error(res.statusText);
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const imgHtml = `âœ… Background removed! <br><img src="${url}" alt="Image with background removed" class="chat-media-preview" style="max-width: 100%; max-height: 250px; border-radius: 12px; display: block; margin-top: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);">`;
                        showCognitiveStatus(false);
                        await startTypewriter(imgHtml, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Background removal failed: ${err.message}`;
                    }
                }
            },
            "comic": {
                title: "Create Comic",
                description: "Write a story and watch it transform into a comic strip. Use tags like [DIALOGUE], [INSTRUCTION] and [NARRATION] to guide the story.",
                buildForm: () => `
                    <label for="tool-story" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Comic Story</label><textarea id="tool-story" placeholder="[DIALOGUE] Are you seeing this?&#10;[NARRATION] Lilo and stitch were once best friends..." required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="tool-style" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Comic Style</label><select id="tool-style" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;"><option value="anime">Anime</option><option value="american">American Comic</option><option value="manga">Manga</option></select>
                    <label for="tool-panels" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Number of Panels</label><input type="number" id="tool-panels" value="3" min="1" max="6" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;" />
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-book-open"></i> Create Comic</button>`,
                handleSubmit: async (form) => {
                    const payload = {
                        story: form.querySelector('#tool-story').value,
                        style: form.querySelector('#tool-style').value,
                        panels: parseInt(form.querySelector('#tool-panels').value, 10),
                        user: currentUser?.displayName || "User"
                    };
                    await addMessageToChat('user', `Comic creation request with style: ${payload.style}.`);
                    showCognitiveStatus(true, 'Generating comic panels...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/generate-comic`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || res.statusText);
                        const imagesHtml = data.images.map((img, idx) => `<img src="data:image/png;base64,${img}" alt="Comic Panel ${idx+1}" class="chat-media-preview" style="max-width: 150px; display: inline-block; margin: 5px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);">`).join('');
                        const comicMessage = `ðŸ–¼ï¸ Comic successfully created! <br><div class="file-attachments" style="justify-content:center;">${imagesHtml}</div>`;
                        showCognitiveStatus(false);
                        await startTypewriter(comicMessage, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Comic generation failed: ${err.message}`;
                    }
                }
            },
            "voice-gen": {
                title: "Voice Generation",
                description: "Transform text into realistic speech. Choose a provider and voice style.",
                buildForm: () => `
                    <label for="tool-provider" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Voice Provider</label><select id="tool-provider" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;"><option value="gemini">Philadelphia (Styles)</option><option value="minimax">Seraphina (Characters)</option></select>
                    <label for="tool-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Text to Speak</label><textarea id="tool-prompt" placeholder="The eagle soars high..." required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="tool-style" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Voice Style</label><select id="tool-style" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;"></select>
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-microphone"></i> Generate Voice</button>`,
                onFormReady: () => {
                    const providerSelect = $('tool-provider'), styleSelect = $('tool-style');
                    const voices = {
                        gemini: ["podcast", "cinematic", "upbeat", "soft", "dramatic"],
                        minimax: ["anime", "movie", "narrator", "knight", "elder", "sweet", "casual", "ceo", "hero", "elegant"]
                    };
                    const updateStyles = () => {
                        styleSelect.innerHTML = voices[providerSelect.value].map(v => `<option value="${v}">${v.charAt(0).toUpperCase() + v.slice(1)}</option>`).join('');
                    };
                    providerSelect.addEventListener('change', updateStyles);
                    updateStyles();
                },
                handleSubmit: async (form) => {
                    const provider = form.querySelector('#tool-provider').value,
                        text = form.querySelector('#tool-prompt').value,
                        style = form.querySelector('#tool-style').value;
                    const providerName = provider === 'minimax' ? 'Seraphina' : 'Philadelphia';
                    await addMessageToChat('user', `Voice generation request using ${providerName}.`);
                    showCognitiveStatus(true, 'Generating audio...');
                    try {
                        let res;
                        if (provider === 'gemini') {
                            const fd = new FormData();
                            fd.append('text', text);
                            fd.append('style', style);
                            res = await fetch(`${API_BASE_URL}/voicegen`, { method: 'POST', body: fd });
                        } else {
                            res = await fetch(`${API_BASE_URL}/api/tools/text-to-speech`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ text, voice_id: style })
                            });
                        }
                        if (!res.ok) throw new Error(await res.text());
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const audioHtml = `ðŸ—£ï¸ Voice generated! <br><audio controls src="${url}" class="chat-media-preview" style="width: 90%; min-height: 40px; border-radius: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);"></audio>`;
                        showCognitiveStatus(false);
                        await startTypewriter(audioHtml, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Voice generation failed: ${err.message}`;
                    }
                }
            },
            "audio-narration": {
                title: "Audio Narration",
                description: "Upload a document (PDF, TXT) to get a podcast-style narrated audio summary.",
                buildForm: () => `
                    <label for="tool-file" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Select File for Narration</label><input type="file" id="tool-file" accept="application/pdf, text/plain" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;"></input>
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-file-audio"></i> Generate Narration</button>`,
                handleSubmit: async (form) => {
                    const file = form.querySelector('#tool-file').files[0];
                    if (!file) return "Please select a file.";
                    await addMessageToChat('user', `Audio narration request for: "${file.name}"`, [{name: file.name, type: file.type}]);
                    showCognitiveStatus(true, 'Analyzing and narrating document...');
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('style', 'podcast');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/audio-narration`, { method: 'POST', body: fd });
                        if (!res.ok) throw new Error(res.statusText);
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const narrationHtml = `ðŸ—£ï¸ Narration generated! <br><audio controls src="${url}" class="chat-media-preview" style="width: 90%; min-height: 40px; border-radius: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);"></audio>`;
                        showCognitiveStatus(false);
                        await startTypewriter(narrationHtml, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Audio narration failed: ${err.message}`;
                    }
                }
            },
            "video-text": {
                title: "Generate Video from Text",
                description: "Describe the video you want to create. This process can take a few minutes.",
                buildForm: () => `
                    <label for="video-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Video Prompt</label><textarea id="video-prompt" placeholder="A majestic eagle flying over mountains..." required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="video-duration" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Duration (seconds)</label><input type="number" id="video-duration" value="6" min="2" max="15" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-play"></i> Start Generation</button>`,
                handleSubmit: async (form) => {
                    const payload = { prompt: form.querySelector('#video-prompt').value, duration: parseInt(form.querySelector('#video-duration').value, 10), resolution: "1080P" };
                    await addMessageToChat('user', `Text-to-Video request: "${payload.prompt}"`);
                    await handleVideoGeneration(payload);
                    return null;
                }
            },
            "video-image": {
                title: "Generate Video from Image",
                description: "Upload a starting image and describe how you want to animate it.",
                buildForm: () => `
                    <label for="video-image-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Animation Prompt</label><textarea id="video-image-prompt" placeholder="Make the clouds move, gentle zoom in" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="video-image-file" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Starting Image</label><input type="file" id="video-image-file" accept="image/*" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-play"></i> Start Generation</button>`,
                handleSubmit: async (form) => {
                    const file = form.querySelector('#video-image-file').files[0];
                    if (!file) return "Please select an image.";
                    await addMessageToChat('user', `Image-to-Video request for: ${file.name}`, [{name: file.name, type: file.type}]);
                    const fd = new FormData();
                    fd.append('prompt', form.querySelector('#video-image-prompt').value);
                    fd.append('file', file);
                    await handleVideoGeneration(fd, true);
                    return null;
                }
            },
            "music": {
                title: "Generate Music",
                description: "Generate music from a prompt, lyrics, and optional reference audio. Thanks to MiniMax.",
                buildForm: () => `
                    <label for="music-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Music Prompt / Description</label><textarea id="music-prompt" placeholder="Upbeat electronic pop song..." required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="music-lyrics" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Lyrics (Optional)</label><textarea id="music-lyrics" placeholder="Verse 1...&#10;Chorus..." style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <label for="music-ref" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Reference Audio (Optional)</label><input type="file" id="music-ref" accept="audio/*" style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-music"></i> Generate Music</button>`,
                handleSubmit: async (form) => {
                    const payload = { prompt: form.querySelector('#music-prompt').value, lyrics: form.querySelector('#music-lyrics').value, model: 'music-1.5' };
                    const refFile = form.querySelector('#music-ref').files[0];
                    await addMessageToChat('user', `Music generation request: "${payload.prompt}"`);
                    showCognitiveStatus(true, 'Composing music...');
                    try {
                        if (refFile) {
                            showCognitiveStatus(true, 'Uploading reference audio first...');
                            const fd = new FormData();
                            fd.append('file', refFile);
                            const uploadRes = await fetch(`${API_BASE_URL}/api/tools/upload-music`, { method: 'POST', body: fd });
                            const uploadData = await uploadRes.json();
                            if (!uploadRes.ok) throw new Error(uploadData.error || "Reference upload failed.");
                            if (uploadData.instrumental_id) payload.instrumental_id = uploadData.instrumental_id;
                            if (uploadData.voice_id) payload.voice_id = uploadData.voice_id;
                            showCognitiveStatus(true, 'Reference uploaded. Composing music...');
                        }
                        const res = await fetch(`${API_BASE_URL}/api/tools/generate-music`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res.ok) throw new Error((await res.json()).detail || 'API request failed.');
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const musicHtml = `ðŸŽµ Your music is ready! <br><audio controls src="${url}" class="chat-media-preview" style="width: 90%; min-height: 40px; border-radius: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);"></audio>`;
                        showCognitiveStatus(false);
                        await startTypewriter(musicHtml, true);
                        return null;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Music generation failed: ${err.message}`;
                    }
                }
            },
            "website": {
                title: "Create Website",
                description: "Describe the website you want to build and get a live, working prototype.",
                buildForm: () => `
                    <label for="website-prompt" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Website Description</label><textarea id="website-prompt" placeholder="A simple portfolio website for a graphic designer..." required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-globe"></i> Generate Website</button>`,
                handleSubmit: async (form) => {
                    const prompt = form.querySelector('#website-prompt').value;
                    await addMessageToChat('user', `Website creation request: "${prompt.substring(0, Math.min(prompt.length, 50))}..."`);
                    showCognitiveStatus(true, 'Building and deploying website...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/create-website`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt, user_id: currentUser.uid })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || res.statusText);
                        showCognitiveStatus(false);
                        return `ðŸŒ Website deployed successfully! [View here](${data.url})`;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Website creation failed: ${err.message}`;
                    }
                }
            },
            "edit-website": {
                title: "Edit Last Website",
                description: "Provide an instruction to modify the most recent website you created.",
                buildForm: () => `
                    <label for="edit-instruction" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Edit Instruction</label><textarea id="edit-instruction" placeholder="Change the main heading to 'Welcome to my Studio'..." required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;resize:vertical;min-height: 80px;"></textarea>
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-pen-ruler"></i> Apply Changes</button>`,
                handleSubmit: async (form) => {
                    const instruction = form.querySelector('#edit-instruction').value;
                    await addMessageToChat('user', `Website edit request: "${instruction.substring(0, Math.min(instruction.length, 50))}..."`);
                    showCognitiveStatus(true, 'Editing and redeploying website...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/edit-website`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instruction, user_id: currentUser.uid })
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || res.statusText);
                        showCognitiveStatus(false);
                        return `âœï¸ Website updated successfully! [View new version here](${data.url})`;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Website edit failed: ${err.message}`;
                    }
                }
            },
            "my-sites": {
                isAction: true,
                runAction: async () => {
                    await addMessageToChat('user', 'Show me a list of my websites.');
                    showCognitiveStatus(true, 'Fetching website list...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/my-sites/${currentUser.uid}`);
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || 'Could not fetch sites.');
                        if (!data.sites || data.sites.length === 0) return "You haven't created any websites yet.";
                        const siteList = data.sites.map(site => `- <a href="${site.site_url}" target="_blank" style="color:var(--neon-blue);">${site.site_url}</a> (Created: ${new Date(site.created_at).toLocaleString()})`).join('\n');
                        showCognitiveStatus(false);
                        return `Here are the websites you've created:\n${siteList}`;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Error fetching websites: ${err.message}`;
                    }
                }
            },
            "research-report": {
                title: "Research Report",
                description: "Generate a comprehensive research report in PDF format on any topic.",
                buildForm: () => `
                    <label for="research-topic" style="display:block;margin-top:10px;font-size:.99em;color:var(--neon-blue);text-shadow:0 1px 14px rgba(17,170,255,0.71);">Research Topic</label><input type="text" id="research-topic" placeholder="The history of artificial intelligence" required style="width:99%;padding:7px 11px;margin-top:5px;border:1.7px solid rgba(19,240,255,0.95);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;box-shadow:0 0 8px rgba(4,246,253,0.81) inset;">
                    <button type="submit" class="submit-btn" style="width:100%;"><i class="fa-solid fa-flask-vial"></i> Generate Report</button>`,
                handleSubmit: async (form) => {
                    const topic = form.querySelector('#research-topic').value;
                    await addMessageToChat('user', `Research report request on: "${topic}"`);
                    showCognitiveStatus(true, 'Conducting research and compiling report...');
                    try {
                        const res = await fetch(`${API_BASE_URL}/api/tools/research`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ topic })
                        });
                        if (!res.ok) throw new Error(res.statusText);
                        const blob = await res.blob();
                        const url = URL.createObjectURL(blob);
                        const downloadLink = `<a href="${url}" download="research_${topic.replace(/\s/g, '_')}.pdf" style="color:var(--neon-blue);font-weight:bold;">Download PDF Report</a>`;
                        showCognitiveStatus(false);
                        return `âœ… Research report on **${topic}** is ready! ${downloadLink}`;
                    } catch (err) {
                        showCognitiveStatus(false);
                        return `âŒ Research report failed: ${err.message}`;
                    }
                }
            },
        };

        if (toolsMenu) {
            toolsMenu.addEventListener('click', async (e) => {
                const toolLink = e.target.closest('.tool-link');
                if (!toolLink) return;
                e.preventDefault();
                const toolKey = toolLink.getAttribute('data-tool');
                const tool = toolDefinitions[toolKey];
                if (!tool) return console.error(`Tool "${toolKey}" is not defined.`);
                closeToolMenu();
                if (tool.isAction) {
                    const result = await tool.runAction();
                    showCognitiveStatus(false);
                    if(result) await startTypewriter(result);
                } else {
                    displayToolForm(toolKey);
                }
            });
        }

        function displayToolForm(toolKey) {
            const tool = toolDefinitions[toolKey];
            if (!tool || !toolFormModalBg) return;
            toolFormTitle.textContent = tool.title;
            const descriptionHtml = tool.description ? `<div style="color:#a8eaff;font-size:.9em;margin-bottom:12px;">${tool.description}</div>` : '';
            toolForm.innerHTML = descriptionHtml + tool.buildForm();
            if (typeof tool.onFormReady === 'function') tool.onFormReady();

            toolForm.onsubmit = async (e) => {
                e.preventDefault();
                const submitButton = toolForm.querySelector('button[type="submit"]');
                const originalButtonContent = submitButton.innerHTML;
                submitButton.innerHTML = `<div class="spinner"></div> Processing...`;
                submitButton.disabled = true;
                toolFormModalBg.classList.remove('active');
                const resultText = await tool.handleSubmit(toolForm);
                if (resultText) {
                    showCognitiveStatus(false);
                    await startTypewriter(resultText);
                }
                submitButton.innerHTML = originalButtonContent;
                submitButton.disabled = false;
            };
            toolFormModalBg.classList.add('active');
            playSound('open');
        }

        async function handleVideoGeneration(payload, isImageToVideo = false) {
            showCognitiveStatus(true, 'Submitting video generation job...');
            try {
                const endpoint = isImageToVideo ? '/api/tools/generate-video-from-image' : '/api/tools/generate-video-from-text';
                const commonPayload = { model: "MiniMax-Hailuo-02", duration: payload.duration || 6, resolution: payload.resolution || "1080P" };
                let options;

                if (isImageToVideo) {
                    // For FormData, append individual fields
                    payload.append('model', commonPayload.model);
                    payload.append('duration', commonPayload.duration);
                    payload.append('resolution', commonPayload.resolution);
                    options = { method: 'POST', body: payload };
                } else {
                    const finalPayload = { ...payload, ...commonPayload };
                    options = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(finalPayload)
                    };
                }

                const startRes = await fetch(API_BASE_URL + endpoint, options);
                const startData = await startRes.json();

                if (!startRes.ok || !startData.task_id) throw new Error(startData.detail || 'Failed to start video task.');

                showCognitiveStatus(false);
                await startTypewriter(`âœ… Video job submitted! Task ID: \`${startData.task_id}\`. I'll notify you when it's ready. This can take a few minutes. Do not leave this page or send another message or task.`);

                const pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`${API_BASE_URL}/api/tools/video-status?task_id=${startData.task_id}`);
                        const statusData = await statusRes.json();

                        if (statusRes.ok && statusData.url) {
                            clearInterval(pollInterval);
                            const videoHtml = `ðŸŽ‰ Your video is ready! <br><video controls src="${statusData.url}" class="chat-media-preview" style="max-width: 100%; max-height: 250px; border-radius: 12px; display: block; margin-top: 10px; border: 2px solid var(--neon-blue); box-shadow: var(--box-glow);"></video>`;
                            await addMessageToChat('ai', videoHtml);
                        } else if (!statusRes.ok || statusData.status?.toLowerCase().includes('fail')) {
                            clearInterval(pollInterval);
                            await startTypewriter(`âŒ Video generation failed. Reason: ${statusData.error || 'Unknown error'}`);
                        }
                    } catch (pollErr) {
                        clearInterval(pollInterval);
                        await startTypewriter(`âŒ Error checking video status.`);
                    }
                }, 20000); // Poll every 20 seconds
            } catch (err) {
                showCognitiveStatus(false);
                await startTypewriter(`âŒ Could not start video generation: ${err.message}`);
            }
        }


        // Main Chat Form Submission
        sendBtn.addEventListener('click', async function (e) {
            e.preventDefault();
            if (!currentChatId) {
                alert("Please select a chat or create a new one.");
                return;
            }
            const msgText = chatInput.value.trim();
            if (!msgText && uploadedFiles.length === 0) return;
            playSound('send');

            const stopButton = document.createElement('button');
            stopButton.type = 'button';
            stopButton.id = 'stopBtn';
            stopButton.className = 'thruster-btn';
            stopButton.innerHTML = '<i class="fa-solid fa-stop"></i>';
            sendBtn.replaceWith(stopButton);
            sendBtn.disabled = true; // Disable original send button
            currentController = new AbortController();
            const signal = currentController.signal;
            let finalResponse = '';

            stopButton.addEventListener('click', () => {
                if (currentController) {
                    currentController.abort();
                }
            });

            const filesForHistory = uploadedFiles.map(file => ({ name: file.name, type: file.type }));
            await addMessageToChat('user', msgText, filesForHistory);
            const localUploadedFiles = [...uploadedFiles];
            chatInput.value = '';
            uploadedFiles = [];
            renderFilePreview();
            chatInput.style.height = 'auto'; // Reset textarea height

            showCognitiveStatus(true); // Start cognitive status animation

            if (localUploadedFiles.length > 0) {
                showCognitiveStatus(true, 'Analyzing your file(s)...');
                let endpoint = '';
                const file = localUploadedFiles[0];
                if (file.type.startsWith('image/')) endpoint = '/understand-image';
                else if (file.type === 'application/pdf') endpoint = '/understand-pdf';
                else if (file.type.startsWith('audio/')) endpoint = '/understand-audio';
                else if (file.type.startsWith('video/')) endpoint = '/understand-video';
                else {
                    showCognitiveStatus(false);
                    finalResponse = "Sorry, I can't analyze that file type.";
                }
                try {
                    if(endpoint) {
                        const fd = new FormData();
                        fd.append('prompt', msgText || `Describe this ${file.type.split('/')[0]}`);
                        fd.append('file', file);
                        const res = await fetch(API_BASE_URL + endpoint, { method: 'POST', body: fd, signal });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error || "Analysis failed.");
                        finalResponse = data.response;
                    }
                } catch (err) {
                    finalResponse = err.name === 'AbortError' ? 'âŒ File analysis stopped.' : `âŒ File analysis failed: ${err.message}`;
                }
            } else if (msgText) {
                try {
                    const history = currentMessages.map(m => ({ role: m.role, content: m.text || '' }));
                    const res = await fetch(`${API_BASE_URL}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: msgText, history, user_id: currentUser?.uid || "user" }),
                        signal
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || "Server error.");
                    finalResponse = data.response;
                } catch (err) {
                    finalResponse = err.name === 'AbortError' ? 'âŒ Response stopped.' : `âŒ An error occurred: ${err.message}`;
                }
            }

            showCognitiveStatus(false); // Stop cognitive status animation
            if (finalResponse) {
                await startTypewriter(finalResponse);
            }

            stopButton.replaceWith(sendBtn);
            sendBtn.disabled = false; // Re-enable original send button
            currentController = null;
        });


        // Voice Call Logic (Refactored and Improved)
        let speechRecognition;
        let isCallActive = false;
        let callHistory = [];
        let botIsSpeaking = false;
        let userSaidSomething = false;
        let currentAudio = null;
        let isMuted = false;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.lang = 'en-US';

            speechRecognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                userSaidSomething = true;
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                let userMsgEl = callConversation.querySelector('.call-msg.user.interim');
                if (!userMsgEl) {
                    userMsgEl = document.createElement('div');
                    userMsgEl.className = 'call-msg user interim';
                    callConversation.appendChild(userMsgEl);
                }
                userMsgEl.textContent = finalTranscript || interimTranscript;
                callConversation.scrollTop = callConversation.scrollHeight;

                callStatusMessage.textContent = finalTranscript ? 'User Speaking (Final)' : 'User Speaking...';
            };

            speechRecognition.onspeechend = () => {};

            speechRecognition.onend = () => {
                if (!isCallActive) return;
                if (isMuted) {
                    callStatusMessage.textContent = 'Microphone Muted.';
                    return;
                }

                let finalTranscript = '';
                const userMsgEl = callConversation.querySelector('.call-msg.user.interim');
                if (userMsgEl) {
                    finalTranscript = userMsgEl.textContent.trim();
                    userMsgEl.classList.remove('interim');
                }

                if (botIsSpeaking) {
                    // Bot is speaking, just wait for it to finish and restart listening (in speakBotResponse)
                } else if (finalTranscript && userSaidSomething) {
                    userSaidSomething = false;
                    callHistory.push({ role: 'user', content: finalTranscript });
                    handleCallBotResponse();
                } else {
                    if (isCallActive && !isMuted) {
                        callStatusMessage.textContent = 'Listening...';
                        try { speechRecognition.start(); } catch(e) {console.warn("Speech recognition failed to start automatically:", e);}
                    }
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error === 'no-speech' && isCallActive && !isMuted) {
                    userSaidSomething = false;
                    speechRecognition.stop();
                } else if (event.error === 'network' && isCallActive) {
                    callStatusMessage.textContent = 'Network error. Attempting restart...';
                    speechRecognition.stop();
                } else if (event.error === 'not-allowed' || event.error === 'permission-denied') {
                    callStatusMessage.textContent = 'Microphone permission denied. Please allow in browser settings.';
                    endCall();
                }
            };
        } else {
            callBtn.style.display = 'none';
            console.warn("Speech Recognition not supported in this browser.");
        }

        function addCallMessage(role, text) {
            const msgEl = document.createElement('div');
            msgEl.className = `call-msg ${role}`;
            msgEl.textContent = text;
            callConversation.appendChild(msgEl);
            callConversation.scrollTop = callConversation.scrollHeight;
        }

        async function handleCallBotResponse() {
            if (!isCallActive) return;
            callStatusMessage.textContent = 'Philadelphia AI is thinking...';
            const userMessage = callHistory.length > 0 ? callHistory[callHistory.length - 1].content : "";

            try {
                speechRecognition.stop();
                const res = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: userMessage, 
                        history: callHistory.slice(0, -1), 
                        user_id: currentUser?.uid || "user",
                        output_channel: 'voice' // Signal to backend for blunt response
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Server error.");
                
                const botResponse = data.response; // Backend should return blunt, conversational text
                
                callHistory.push({ role: 'ai', content: botResponse });
                addCallMessage('bot', botResponse);
                speakBotResponse(botResponse);
            } catch (err) {
                const errorMsg = `âŒ Call error: ${err.message}`;
                addCallMessage('bot', errorMsg);
                if (isCallActive && !isMuted) {
                    callStatusMessage.textContent = 'Listening...';
                    try { speechRecognition.start(); } catch(e) {console.warn("Speech recognition failed to start after error:", e);}
                }
            }
        }

        async function speakBotResponse(text) {
            if (!isCallActive) return;
            botIsSpeaking = true;
            botImageContainer.classList.add('speaking');
            callStatusMessage.textContent = 'Philadelphia AI is speaking...';
            try {
                const res = await fetch(`${API_BASE_URL}/api/tools/text-to-speech`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text, voice_id: 'casual' }) // Using a casual voice for natural conversation
                });
                if (!res.ok) throw new Error(await res.text());
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                currentAudio = audio;
                audio.onended = audio.onerror = () => {
                    botIsSpeaking = false;
                    botImageContainer.classList.remove('speaking');
                    currentAudio = null;
                    if (isCallActive && !isMuted) {
                        callStatusMessage.textContent = 'Listening...';
                        try { speechRecognition.start(); } catch(e) {console.warn("Speech recognition failed to start after speaking:", e);}
                    } else if (isMuted) {
                        callStatusMessage.textContent = 'Microphone Muted.';
                    }
                };
                audio.play();
            } catch (err) {
                console.error("Voice gen error:", err);
                botIsSpeaking = false;
                botImageContainer.classList.remove('speaking');
                if (isCallActive && !isMuted) {
                    callStatusMessage.textContent = 'Listening (Voice Failed)...';
                    try { speechRecognition.start(); } catch(e) {console.warn("Speech recognition failed to start after voice error:", e);}
                } else if (isMuted) {
                    callStatusMessage.textContent = 'Microphone Muted.';
                }
            }
        }

        function stopBotSpeakingAndStartListening() {
            if (!isCallActive || !botIsSpeaking) return;
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            botIsSpeaking = false;
            botImageContainer.classList.remove('speaking');
            if (!isMuted) {
                callStatusMessage.textContent = 'Listening...';
                try {
                    speechRecognition.stop();
                    speechRecognition.start();
                } catch(e) { console.warn("Could not restart speech recognition immediately:", e); }
            } else {
                callStatusMessage.textContent = 'Microphone Muted.';
            }
            const userMsgEl = callConversation.querySelector('.call-msg.user.interim');
            if (userMsgEl) userMsgEl.textContent = '';
        }

        callModal.addEventListener('mousedown', stopBotSpeakingAndStartListening);
        callModal.addEventListener('touchstart', stopBotSpeakingAndStartListening);

        callBtn.addEventListener('click', () => {
            if (!SpeechRecognition) {
                alert("Sorry, your browser doesn't support the Speech Recognition needed for this feature.");
                return;
            }
            isCallActive = true;
            isMuted = false;
            muteCallBtn.classList.remove('muted');
            muteCallBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
            callModal.classList.add('active');
            callConversation.innerHTML = '';
            addCallMessage('status', 'Initializing neural link...');
            callStatusMessage.textContent = 'Connecting...';
            callHistory = [];
            playSound('open');
            setTimeout(() => {
                if (!isCallActive) return;
                addCallMessage('status', 'Neural link established. Speak when ready.');
                callStatusMessage.textContent = 'Listening...';
                try { speechRecognition.start(); } catch(e) { console.error("Speech recognition start failed", e); callStatusMessage.textContent = 'Microphone error. Check permissions.'; }
            }, 1500);
        });

        function endCall() {
            isCallActive = false;
            botIsSpeaking = false;
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            callModal.classList.remove('active');
            try { speechRecognition.stop(); } catch(e) {}
            botImageContainer.classList.remove('speaking');
            callStatusMessage.textContent = 'Call Ended.';
            playSound('close');
        }

        endCallBtn.addEventListener('click', endCall);

        if (muteCallBtn) {
            muteCallBtn.addEventListener('click', () => {
                isMuted = !isMuted;
                if (isMuted) {
                    muteCallBtn.classList.add('muted');
                    muteCallBtn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
                    speechRecognition.stop();
                    callStatusMessage.textContent = 'Microphone Muted.';
                } else {
                    muteCallBtn.classList.remove('muted');
                    muteCallBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    if (isCallActive && !botIsSpeaking) {
                        callStatusMessage.textContent = 'Listening...';
                        try { speechRecognition.start(); } catch(e) {console.warn("Speech recognition failed to start after unmute:", e);}
                    } else if (isCallActive && botIsSpeaking) {
                        callStatusMessage.textContent = 'Philadelphia AI is speaking...';
                    }
                }
            });
        }


        // --- Initialize on DOMContentLoaded ---
        window.addEventListener('DOMContentLoaded', () => {
            igniteCosmos(); // Start cosmic background
            showCognitiveStatus(true, 'AWAITING CONNECTION'); // Initial status

            onAuthStateChanged(auth, user => {
                if (!user) {
                    try {
                        window.location.href = "signup-login.html"; // Redirect to login if not authenticated
                    } catch (e) {
                        console.error("Redirect failed:", e);
                    }
                    return;
                }
                currentUser = user;
                if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
                if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
                if (editName) editName.value = user.displayName || "";
                if (editPhoto) editPhoto.value = user.photoURL || "";
                if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
                
                loadUserChats(user.uid);
                showCognitiveStatus(false); // Clear status once authenticated and chats loaded
            });

            if(chatInput) chatInput.focus();
        });
    </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>
