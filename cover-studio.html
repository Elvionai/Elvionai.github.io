<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elvion Book Cover Studio</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- Firebase SDKs (Compat version for easier standalone use) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Google Fonts (12+ Selection) -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:wght@700&family=Roboto:wght@900&family=Great+Vibes&family=Oswald:wght@700&family=Montserrat:wght@800&family=Merriweather:wght@900&family=Bebas+Neue&family=Orbitron:wght@900&family=Dancing+Script:wght@700&family=Lato:wght@900&family=Anton&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #6c5ce7; 
            --dark: #1e1e2f; 
            --panel: #2b2b40; 
            --text: #eee; 
            --accent: #00cec9; 
            --danger: #ff7675;
        }
        body { margin: 0; background: var(--dark); color: var(--text); font-family: 'Roboto', sans-serif; overflow: hidden; }

        /* --- LAYOUT --- */
        .app-container { display: grid; grid-template-columns: 320px 1fr 300px; height: 100vh; filter: blur(5px); transition: filter 0.3s; pointer-events: none; }
        .app-container.logged-in { filter: blur(0); pointer-events: all; }

        .sidebar { background: var(--panel); padding: 15px; border-right: 1px solid #333; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .sidebar-right { border-left: 1px solid #333; border-right: none; }
        
        h3 { margin: 0 0 5px 0; color: var(--accent); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 5px; }

        /* --- UI ELEMENTS --- */
        input, select, textarea, button { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #181825; color: white; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; }
        input:focus, textarea:focus { outline: 1px solid var(--primary); border-color: var(--primary); }

        button { background: var(--primary); border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        button:hover { filter: brightness(1.15); transform: translateY(-1px); }
        button.secondary { background: #444; }
        button.danger { background: var(--danger); color: #2d3436; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* --- CANVAS --- */
        .canvas-area { background: #12121a; display: flex; align-items: center; justify-content: center; overflow: auto; position: relative; background-image: radial-gradient(#2d2d44 1px, transparent 1px); background-size: 20px 20px; }
        .canvas-shadow { box-shadow: 0 0 40px rgba(0,0,0,0.6); }

        /* --- AUTH OVERLAY --- */
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .auth-box { background: var(--panel); padding: 40px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid var(--primary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .auth-btn { margin-top: 10px; padding: 12px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; font-size: 14px; }
        .btn-google { background: #fff; color: #333; }
        .btn-twitter { background: #1da1f2; color: #fff; }
        .btn-email { background: var(--primary); color: #fff; }
        .divider { margin: 15px 0; color: #888; font-size: 12px; }

        /* --- WALLET --- */
        .wallet-card { background: linear-gradient(135deg, #6c5ce7, #a29bfe); padding: 15px; border-radius: 8px; text-align: center; color: white; margin-bottom: 15px; position: relative; overflow: hidden; }
        .wallet-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(transparent, rgba(255,255,255,0.2), transparent); transform: rotate(45deg); animation: shine 3s infinite; }
        @keyframes shine { 0% { transform: translate(-100%, -100%) rotate(45deg); } 100% { transform: translate(100%, 100%) rotate(45deg); } }

        /* --- PERSISTENT CHARACTERS --- */
        .char-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .char-item { position: relative; aspect-ratio: 1; border-radius: 6px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .char-item:hover { border-color: var(--accent); transform: scale(1.02); }
        .char-item img { width: 100%; height: 100%; object-fit: cover; }
        .char-actions { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: space-between; padding: 2px; display: none; }
        .char-item:hover .char-actions { display: flex; }
        .char-btn { color: white; background: none; border: none; font-size: 10px; padding: 5px; }

        /* --- 3D MOCKUP --- */
        #mockup-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; }
        .scene { width: 300px; height: 450px; perspective: 1500px; }
        .book { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .face { position: absolute; width: 300px; height: 450px; background-size: cover; background-color: #eee; }
        .front { transform: translateZ(25px); }
        .back { transform: rotateY(180deg) translateZ(25px); }
        .spine { width: 50px; height: 450px; transform: rotateY(-90deg) translateZ(25px); left: -25px; }
        
        /* --- NOTIFICATIONS --- */
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--panel); border-left: 4px solid var(--accent); padding: 15px 25px; border-radius: 4px; color: white; transform: translateX(150%); transition: transform 0.3s; z-index: 4000; }
        #toast.show { transform: translateX(0); }
    </style>
</head>
<body>

<!-- AUTH OVERLAY -->
<div id="auth-overlay">
    <div class="auth-box">
        <h2 style="color: var(--primary); margin-top:0;">Welcome Author</h2>
        <p style="font-size: 14px; color: #ccc;">Sign in to access your Book Cover Studio.</p>
        
        <button class="auth-btn btn-google" onclick="signIn('google')">
            <i class="fab fa-google"></i> Continue with Google
        </button>
        <button class="auth-btn btn-twitter" onclick="signIn('twitter')">
            <i class="fab fa-twitter"></i> Continue with Twitter
        </button>
        
        <div class="divider">OR USE EMAIL</div>
        
        <input type="email" id="auth-email" placeholder="email@address.com">
        <input type="password" id="auth-password" placeholder="Password (Optional for Demo)">
        <button class="auth-btn btn-email" onclick="signIn('email')">
            <i class="fas fa-envelope"></i> Enter Studio
        </button>
        <p id="auth-error" style="color: var(--danger); font-size: 12px; margin-top: 10px;"></p>
    </div>
</div>

<!-- 3D PREVIEW MODAL -->
<div id="mockup-modal">
    <h2 style="color: white; margin-bottom: 40px;">3D Preview</h2>
    <div class="scene">
        <div class="book" id="book-3d">
            <div class="face front" id="face-front"></div>
            <div class="face spine" id="face-spine"></div>
            <div class="face back" id="face-back"></div>
        </div>
    </div>
    <div style="margin-top: 50px; display: flex; gap: 15px;">
        <button onclick="rotateBook('front')">Front</button>
        <button onclick="rotateBook('spine')">Spine</button>
        <button onclick="rotateBook('full')">Full View</button>
        <button class="danger" onclick="document.getElementById('mockup-modal').style.display='none'">Close</button>
    </div>
</div>

<!-- TOAST -->
<div id="toast">Operation Successful</div>

<!-- MAIN APP -->
<div class="app-container" id="app-container">
    
    <!-- LEFT SIDEBAR -->
    <div class="sidebar">
        <!-- Wallet -->
        <div class="wallet-card">
            <div style="font-size: 11px; text-transform: uppercase;">Credit Balance</div>
            <div style="font-size: 32px; font-weight: 900;" id="credit-display">--</div>
            <button onclick="fundWallet()" style="background: rgba(0,0,0,0.3); margin-top: 5px; font-size: 11px; padding: 5px;">
                <i class="fas fa-plus-circle"></i> Fund Wallet
            </button>
        </div>

        <h3>Create Cover</h3>
        <select id="gen-model">
            <option value="v6">Thena V6 (High Quality)</option>
            <option value="photoreal">Thena Photoreal</option>
            <option value="movie">Thena Cinematic</option>
            <option value="illustration">Thena Illustration</option>
        </select>
        <textarea id="gen-prompt" rows="3" placeholder="Describe the scene... e.g. 'A dark castle on a hill...'"></textarea>
        
        <div style="display: flex; gap: 5px;">
            <button class="secondary" onclick="askAI()" title="AI Help"><i class="fas fa-magic"></i> AI</button>
            <button onclick="generateImage('cover')" id="btn-gen-cover"><i class="fas fa-paint-brush"></i> Generate (20c)</button>
        </div>

        <h3>Persistent Characters</h3>
        <div class="char-grid" id="char-container">
            <!-- Characters load here -->
        </div>
        <button class="secondary" onclick="generateImage('char')" style="margin-top: 10px;" id="btn-gen-char">
            <i class="fas fa-user-plus"></i> Create Character (10c)
        </button>

        <!-- Chat -->
        <div style="margin-top: auto; border-top: 1px solid #444; padding-top: 10px;">
            <h3>Bobby Assistant</h3>
            <div id="chat-output" style="height: 100px; background: #222; overflow-y: auto; font-size: 11px; padding: 5px; margin-bottom: 5px; border-radius: 4px; color: #aaa;">
                Bob: Hi! Need help describing your cover?
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="Ask something..." style="margin: 0;">
                <button onclick="sendChat()" style="width: 40px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- CENTER CANVAS -->
    <div class="canvas-area">
        <canvas id="c"></canvas>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="sidebar sidebar-right">
        <h3>Project</h3>
        <button onclick="saveProject()"><i class="fas fa-save"></i> Save Progress</button>
        <select onchange="setCanvasMode(this.value)">
            <option value="front">Front Cover Only (600x900)</option>
            <option value="full">Full Wrap (Back+Spine+Front)</option>
        </select>

        <h3>Edit Tools</h3>
        <button onclick="addText()"><i class="fas fa-font"></i> Add Title Text</button>
        
        <div style="display: flex; gap: 5px;">
            <select id="font-family" onchange="updateObject('fontFamily', this.value)">
                <option value="Cinzel">Cinzel (Fantasy)</option>
                <option value="Playfair Display">Playfair (Romance)</option>
                <option value="Oswald">Oswald (Thriller)</option>
                <option value="Roboto">Roboto (Modern)</option>
                <option value="Great Vibes">Script</option>
                <option value="Orbitron">Sci-Fi</option>
            </select>
            <input type="color" id="text-color" style="width: 50px;" onchange="updateObject('fill', this.value)">
        </div>
        <input type="range" min="10" max="150" value="60" oninput="updateObject('fontSize', parseInt(this.value))">

        <h3>Image Tools</h3>
        <button class="secondary" onclick="removeBackground()"><i class="fas fa-eraser"></i> Remove Background</button>
        <button class="secondary" onclick="enableBrushMode()"><i class="fas fa-paint-roller"></i> Brush/Erase Mode</button>
        <button class="danger" onclick="deleteObject()"><i class="fas fa-trash"></i> Delete Selected</button>

        <div style="margin-top: auto; gap: 10px; display: flex; flex-direction: column;">
            <button onclick="openMockup()" style="background: var(--accent); color: #000;"><i class="fas fa-cube"></i> View 3D Mockup</button>
            <button onclick="downloadCover()" style="background: #27ae60;"><i class="fas fa-download"></i> Download Final</button>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION (REPLACE WITH YOURS) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    const twitterProvider = new firebase.auth.TwitterAuthProvider();

    // --- 2. GLOBAL VARIABLES ---
    const API_URL = "https://web-production-9a18.up.railway.app"; 
    const SUPER_ADMIN_EMAIL = "koladhino@gmail.com";
    
    let currentUser = null;
    let authToken = null; // The ID Token for backend calls
    let credits = 0;
    let canvas;
    let isBrushMode = false;

    // --- 3. AUTHENTICATION LOGIC ---
    
    // Check Auth State
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            authToken = await user.getIdToken();
            
            // Hide Overlay
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('app-container').classList.add('logged-in');
            
            // Sync Wallet & Load Data
            showToast(`Welcome, ${user.displayName || user.email}`);
            await fetchWalletBalance();
            loadProject();
            loadCharacters();
        } else {
            // Show Overlay
            document.getElementById('auth-overlay').style.display = 'flex';
            document.getElementById('app-container').classList.remove('logged-in');
        }
    });

    async function signIn(method) {
        try {
            if (method === 'google') await auth.signInWithPopup(googleProvider);
            if (method === 'twitter') await auth.signInWithPopup(twitterProvider);
            if (method === 'email') {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-password').value || "demo1234"; // Simplification for demo
                // In a real app, use sendSignInLinkToEmail or strict password flows
                // For this demo, we assume the user exists or we create them anonymously linked to email
                await auth.signInAnonymously(); // Or proper implementation
                // Force update email for credits to work in backend
                if(auth.currentUser) auth.currentUser.updateEmail(email).catch(e => console.log("Email update skipped"));
            }
        } catch (error) {
            document.getElementById('auth-error').innerText = error.message;
        }
    }

    // --- 4. BACKEND API INTERACTION ---
    
    // Wrapper to include Firebase Token in headers
    async function fetchWithAuth(endpoint, options = {}) {
        if (!authToken && auth.currentUser) authToken = await auth.currentUser.getIdToken(true);
        
        const headers = {
            'Content-Type': 'application/json',
            'X-Firebase-Token': authToken, // YOUR BACKEND EXPECTS THIS
            ...options.headers
        };

        const response = await fetch(`${API_URL}${endpoint}`, {
            ...options,
            headers: headers
        });

        if (response.status === 401 || response.status === 403) {
            showToast("Session expired. Please refresh.");
            return null;
        }

        return response.json();
    }

    // --- 5. CANVAS & EDITING LOGIC ---
    
    window.onload = () => {
        canvas = new fabric.Canvas('c', {
            width: 600,
            height: 900,
            backgroundColor: '#ffffff',
            preserveObjectStacking: true
        });
        
        // Auto-save logic
        canvas.on('object:modified', saveProject);
        canvas.on('object:added', saveProject);
    };

    function setCanvasMode(mode) {
        if (mode === 'full') {
            canvas.setWidth(1300); // 600 + 100(spine) + 600
            // Add guide lines
            canvas.add(new fabric.Line([600, 0, 600, 900], { stroke: 'cyan', strokeDashArray: [5, 5], selectable: false }));
            canvas.add(new fabric.Line([700, 0, 700, 900], { stroke: 'cyan', strokeDashArray: [5, 5], selectable: false }));
        } else {
            canvas.setWidth(600);
        }
        canvas.renderAll();
    }

    function addText() {
        const text = new fabric.IText('Title Here', {
            left: 100, top: 100,
            fontFamily: 'Cinzel',
            fill: '#000000',
            fontSize: 60
        });
        canvas.add(text);
        canvas.setActiveObject(text);
    }

    function updateObject(prop, value) {
        const obj = canvas.getActiveObject();
        if (obj) {
            obj.set(prop, value);
            canvas.renderAll();
            saveProject();
        }
    }

    function enableBrushMode() {
        isBrushMode = !isBrushMode;
        canvas.isDrawingMode = isBrushMode;
        if (isBrushMode) {
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = canvas.backgroundColor; // Eraser effect (paint with BG color)
            canvas.freeDrawingBrush.width = 20;
            showToast("Brush Mode: ON (Painting Background Color)");
        } else {
            showToast("Brush Mode: OFF");
        }
    }

    // --- 6. IMAGE GENERATION & LIMITS ---

    function checkLimits(cost) {
        // 1. Check Admin
        if (currentUser.email === SUPER_ADMIN_EMAIL) return true;

        // 2. Check Daily Limit (Local Storage for speed)
        const today = new Date().toDateString();
        const count = parseInt(localStorage.getItem(`gen_count_${currentUser.uid}_${today}`) || 0);
        if (count >= 3) {
            alert("Daily limit reached (3 generations). Upgrade or wait till tomorrow.");
            return false;
        }

        // 3. Check Credits
        if (credits < cost) {
            if(confirm("Insufficient credits. Fund wallet now?")) fundWallet();
            return false;
        }
        return true;
    }

    async function generateImage(type) {
        const cost = type === 'cover' ? 20 : 10;
        if (!checkLimits(cost)) return;

        const prompt = document.getElementById('gen-prompt').value;
        const model = document.getElementById('gen-model').value;
        const btn = document.getElementById(type === 'cover' ? 'btn-gen-cover' : 'btn-gen-char');
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        btn.disabled = true;

        try {
            // Using the 'generate-image' endpoint (mapped to your bot.py)
            const result = await fetchWithAuth('/generate-image', {
                method: 'POST',
                body: JSON.stringify({
                    prompt: type === 'char' ? `Character sheet, white background, ${prompt}` : prompt,
                    model: type === 'char' ? 'anime_core' : model,
                    width: type === 'char' ? 512 : 600,
                    height: type === 'char' ? 512 : 900
                })
            });

            if (result && result.image_b64) {
                if (type === 'cover') {
                    fabric.Image.fromURL('data:image/png;base64,' + result.image_b64, (img) => {
                        img.scaleToWidth(600);
                        canvas.add(img);
                        canvas.sendToBack(img);
                    });
                } else {
                    saveCharacter(result.image_b64);
                }
                
                // Deduct & Log
                updateLocalCredits(-cost);
                logDailyUsage();
                showToast("Generation Complete!");
            } else {
                throw new Error("Generation failed.");
            }
        } catch (e) {
            console.error(e);
            showToast("Error generating image.");
        } finally {
            btn.innerHTML = type === 'cover' ? 'Generate (20c)' : 'Create Character (10c)';
            btn.disabled = false;
        }
    }

    async function removeBackground() {
        const obj = canvas.getActiveObject();
        if (!obj || obj.type !== 'image') return alert("Select an image first");

        showToast("Removing background...");
        
        // Convert Fabric obj to blob
        const dataURL = obj.toDataURL({format: 'png'});
        const blob = await (await fetch(dataURL)).blob();
        const formData = new FormData();
        formData.append('file', blob, 'image.png');

        // Call backend (uses authentication via get_current_user in backend if adapted, or api key)
        // Since backend snippet for remove-bg uses UploadFile, we send as FormData
        // We assume backend validates token or we rely on the API key inside backend
        const res = await fetch(`${API_URL}/api/tools/remove-background`, {
            method: 'POST',
            body: formData
            // Note: UploadFile endpoints usually don't take JSON headers easily with FormData
            // You might need to append token if backend requires it: headers: {'X-Firebase-Token': authToken}
        });

        if(res.ok) {
            const newBlob = await res.blob();
            const reader = new FileReader();
            reader.onload = (e) => {
                fabric.Image.fromURL(e.target.result, (img) => {
                    img.set({ left: obj.left, top: obj.top, scaleX: obj.scaleX, scaleY: obj.scaleY });
                    canvas.remove(obj);
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    saveProject();
                });
            };
            reader.readAsDataURL(newBlob);
        } else {
            showToast("Failed to remove background");
        }
    }

    // --- 7. PERSISTENCE ---

    function saveCharacter(b64) {
        const chars = JSON.parse(localStorage.getItem(`chars_${currentUser.uid}`) || "[]");
        chars.push(b64);
        localStorage.setItem(`chars_${currentUser.uid}`, JSON.stringify(chars));
        loadCharacters();
    }

    function loadCharacters() {
        const container = document.getElementById('char-container');
        container.innerHTML = "";
        const chars = JSON.parse(localStorage.getItem(`chars_${currentUser.uid}`) || "[]");
        
        chars.forEach(b64 => {
            const div = document.createElement('div');
            div.className = 'char-item';
            div.innerHTML = `
                <img src="data:image/png;base64,${b64}" onclick="addToCanvas('${b64}')">
                <div class="char-actions">
                    <button class="char-btn" onclick="addToCanvas('${b64}')">USE</button>
                    <button class="char-btn" style="color:red" onclick="deleteChar('${b64}')">DEL</button>
                </div>
            `;
            container.appendChild(div);
        });
    }
    
    function addToCanvas(b64) {
        fabric.Image.fromURL('data:image/png;base64,' + b64, (img) => {
            img.scaleToWidth(200);
            canvas.add(img);
        });
    }

    function saveProject() {
        if(currentUser) localStorage.setItem(`project_${currentUser.uid}`, JSON.stringify(canvas.toJSON()));
    }

    function loadProject() {
        const json = localStorage.getItem(`project_${currentUser.uid}`);
        if(json) canvas.loadFromJSON(json);
    }

    function logDailyUsage() {
        const today = new Date().toDateString();
        const key = `gen_count_${currentUser.uid}_${today}`;
        const count = parseInt(localStorage.getItem(key) || 0);
        localStorage.setItem(key, count + 1);
    }

    // --- 8. PAYMENTS & CREDITS ---

    async function fetchWalletBalance() {
        // Backend doesn't have a direct "get balance" in snippet, 
        // but we can infer it or use a separate call. 
        // For now, we simulate using local or calling user details endpoint if exists.
        
        // Simulating backend fetch:
        const stored = localStorage.getItem(`credits_${currentUser.uid}`);
        credits = stored ? parseInt(stored) : (currentUser.email === SUPER_ADMIN_EMAIL ? 999999 : 50);
        
        document.getElementById('credit-display').innerText = credits.toLocaleString();
    }

    function updateLocalCredits(change) {
        credits += change;
        localStorage.setItem(`credits_${currentUser.uid}`, credits);
        document.getElementById('credit-display').innerText = credits.toLocaleString();
    }

    async function fundWallet() {
        const amount = prompt("Enter amount (NGN) to add:", "1000");
        if (!amount || amount < 100) return;

        try {
            const result = await fetchWithAuth('/api/payments/initiate', {
                method: 'POST',
                body: JSON.stringify({ amount: parseInt(amount) })
            });

            if (result && result.checkout_url) {
                // Open Korapay in new tab
                const win = window.open(result.checkout_url, '_blank');
                
                // Polling for completion
                const checkInterval = setInterval(async () => {
                    if (win.closed) {
                        clearInterval(checkInterval);
                        // Verify transaction
                        const verify = await fetchWithAuth(`/api/payments/verify?transaction_ref=${result.transaction_ref}`, { method: 'GET' });
                        if (verify && verify.status === 'success') {
                            updateLocalCredits(parseInt(amount)); // Or use verify.new_balance
                            showToast("Payment Successful!");
                        }
                    }
                }, 3000);
            }
        } catch (e) {
            console.error(e);
            alert("Payment init failed");
        }
    }

    // --- 9. 3D MOCKUPS & UTILS ---

    function openMockup() {
        const dataUrl = canvas.toDataURL();
        document.getElementById('mockup-modal').style.display = 'flex';
        
        // Apply textures
        document.getElementById('face-front').style.backgroundImage = `url(${dataUrl})`;
        document.getElementById('face-back').style.backgroundColor = '#333'; // Simple back
        
        if (canvas.width > 1000) {
            // Logic for Full Wrap splitting
            document.getElementById('face-front').style.backgroundPosition = "100% 0";
            document.getElementById('face-spine').style.backgroundImage = `url(${dataUrl})`;
            document.getElementById('face-spine').style.backgroundPosition = "50% 0";
            document.getElementById('face-back').style.backgroundImage = `url(${dataUrl})`;
            document.getElementById('face-back').style.backgroundPosition = "0% 0";
        }
        
        rotateBook('front');
    }

    function rotateBook(view) {
        const book = document.getElementById('book-3d');
        if (view === 'front') book.style.transform = "rotateY(-20deg) rotateX(10deg)";
        if (view === 'spine') book.style.transform = "rotateY(-110deg) rotateX(0deg)";
        if (view === 'full') book.style.transform = "rotateY(-30deg) rotateX(20deg) scale(0.8)";
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
    
    // Simple Chatbot Bridge
    async function sendChat() {
        const inp = document.getElementById('chat-input');
        const txt = inp.value;
        if(!txt) return;
        
        document.getElementById('chat-output').innerHTML += `<div>You: ${txt}</div>`;
        inp.value = "";
        
        const res = await fetchWithAuth('/api/llama/chat', {
            method: 'POST',
            body: JSON.stringify({ prompt: txt, systemPrompt: "You are a helpful design assistant named Bobby." })
        });
        
        if(res && (res.content || res.response)) {
            document.getElementById('chat-output').innerHTML += `<div>Bob: ${res.content || res.response}</div>`;
        }
    }
    
    function downloadCover() {
        const link = document.createElement('a');
        link.download = 'book_cover.png';
        link.href = canvas.toDataURL({ quality: 1.0 });
        link.click();
    }
</script>

</body>
</html>
