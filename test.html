<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to Craft Unforgettable Characters | Elvion AI Blog</title>
    <meta name="description" content="Learn proven techniques to create compelling, three-dimensional characters that readers will remember long after the final page.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- DUAL THEME VARIABLES --- */
        :root {
            /* Default: DARK MODE (Aligned with Elvion AI blue/cyan theme) */
            --bg-color: #0d1117;
            --text-color: #e6edf3;
            --heading-color: #ffffff;
            --link-color: #00ffff; /* Cyan Glow */
            --link-hover-color: #00aaff;
            --border-color: #21262d;
            --card-bg: #161b22;
            --button-bg: #0056b3;
            --button-text-color: #ffffff;
            --button-hover-bg: #003d80;
            --navbar-bg: rgba(13, 17, 23, 0.95);
            --footer-bg: #0a0e14;
            --highlight-color: #384109; /* Subtle green/yellow highlight for dark mode */
            --comment-bg: #0d1117;
        }

        /* LIGHT MODE VARIABLES (Applied when body has .light-theme) */
        body.light-theme {
            --bg-color: #ffffff;
            --text-color: #333333;
            --heading-color: #111111;
            --link-color: #0056b3;
            --link-hover-color: #003d80;
            --border-color: #e0e0e0;
            --card-bg: #f9f9f9;
            --button-bg: #0056b3;
            --button-text-color: #ffffff;
            --button-hover-bg: #003d80;
            --navbar-bg: #ffffff;
            --footer-bg: #f1f1f1;
            --highlight-color: #fff9c4; /* Light yellow highlight */
            --comment-bg: #ffffff;
        }

        /* --- GLOBAL STYLES --- */
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding-top: 60px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            font-size: 1.1rem;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Lato', 'Helvetica Neue', Arial, sans-serif;
            color: var(--heading-color);
            margin-top: 0;
            line-height: 1.3;
        }
        
        a {
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .post-container {
             max-width: 800px;
             margin: 0 auto;
             padding: 0 1rem;
        }

        /* --- Navbar Styles (Updated for Dark/Light) --- */
        .navbar {
            position: fixed; top: 0; width: 100%; 
            background: var(--navbar-bg); 
            padding: 1rem 0; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .navbar-brand { font-family: 'Lato', sans-serif; font-size: 1.8rem; font-weight: 900; color: var(--heading-color); }
        .nav-links { display: flex; list-style: none; margin: 0; padding: 0; }
        .nav-links li { margin-left: 2rem; }
        .nav-links a { 
            color: var(--text-color); font-weight: 700; font-family: 'Lato', sans-serif; font-size: 0.9rem;
            text-transform: uppercase; letter-spacing: 0.5px; padding: 0.5rem 0; position: relative; 
        }
        .nav-links .active-link { color: var(--link-color); }
        .nav-links a::after { 
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0; 
            background: var(--link-color); transition: width 0.3s ease-in-out; 
        }
        .nav-links a:hover::after, .nav-links .active-link::after { width: 100%; }
        
        .hamburger { display: none; flex-direction: column; cursor: pointer; padding: 0.5rem; background: transparent; border: none; }
        .hamburger .bar { 
            width: 25px; height: 3px; background-color: var(--heading-color); margin: 4px 0; transition: 0.4s; box-shadow: none; 
        }
        .hamburger.active .bar:nth-child(2) { opacity: 0; }
        .hamburger.active .bar:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .hamburger.active .bar:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
        
        /* Theme Toggle Button */
        #theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-left: 1rem;
        }
        #theme-toggle:hover {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* --- Footer Styles --- */
        .footer {
            background: var(--footer-bg); color: var(--text-color); padding: 4rem 0 2rem; font-size: 0.9rem;
            border-top: 1px solid var(--border-color); text-align: center; position: relative; margin-top: 4rem;
        }
        .footer .legal-info { color: #777; }

        /* --- Single Post Styles --- */
        .post-main { padding-top: 3rem; padding-bottom: 3rem; position: relative; }
        .post-header { border-bottom: 1px solid var(--border-color); }
        .post-header .post-tag { background: var(--link-color); color: var(--button-text-color); }
        
        .post-thumbnail-placeholder {
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color);
            color: #555;
        }
        
        .article-content blockquote {
            border-left: 4px solid var(--link-color);
            color: var(--text-color);
            background: var(--card-bg);
        }
        
        .article-content h2 { border-bottom: 2px solid var(--border-color); }
        .article-content h3 { color: var(--heading-color); }

        /* --- Audio Player Styles --- */
        .audio-player {
            background: var(--card-bg); border: 1px solid var(--border-color);
        }
        #reading-time {
            font-size: 0.9rem;
            color: var(--link-color);
            font-weight: 700;
        }
        
        /* Word Highlighting (Inline span) */
        .word-highlight {
            background-color: var(--highlight-color);
            box-shadow: 0 0 5px rgba(255, 255, 0, 0.5); /* Subtle glow for dark mode */
            color: var(--heading-color);
            padding: 0 1px;
            border-radius: 2px;
            transition: background-color 0.1s;
        }
        body.light-theme .word-highlight {
            box-shadow: none; /* Remove glow in light mode */
            color: var(--heading-color);
        }
        
        /* --- Comment Section Styles --- */
        .comments-wrapper { border-top: 2px solid var(--border-color); }
        .comments-wrapper h2 { color: var(--heading-color); }

        .btn-primary {
            background: var(--button-bg); color: var(--button-text-color); 
        }
        .btn-secondary {
            border: 1px solid var(--border-color); color: var(--text-color);
        }
        .btn-secondary:hover { background: var(--card-bg); border-color: #ccc; }
        .btn-secondary.active { background: var(--button-bg); border-color: var(--button-bg); }

        #auth-container { background: var(--card-bg); border: 1px solid var(--border-color); }
        .form-input {
            background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color);
        }
        .form-input:focus { border-color: var(--link-color); box-shadow: 0 0 0 2px var(--link-color); }

        .comment {
            background: var(--comment-bg); border: 1px solid var(--border-color);
        }
        .comment img { border: 2px solid var(--border-color); }
        .comment-user { color: var(--heading-color); }
        .comment-text { color: var(--text-color); }
        .comment-meta { color: #777; }
        .comment-actions button {
            border: 1px solid var(--border-color); color: #999;
        }
        .comment-actions button:hover { border-color: var(--link-color); color: var(--link-color); background: var(--card-bg); }
        .comment-actions button.active { background: var(--link-color); color: var(--button-text-color); border-color: var(--link-color); }
        .custom-verified-badge { background: var(--link-color); }
        
        .replies-container { border-left: 2px solid var(--border-color); }
        
        @media (max-width: 992px) {
            .nav-links { background: var(--navbar-bg); border-top: 1px solid var(--border-color); }
        }
    </style>
</head>
<body>
    
    <header class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">Elvion AI</a>
            
            <div class="nav-controls">
                <button class="hamburger" aria-label="Toggle navigation">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
                <nav class="nav-links">
                    <li><a href="university.html">Elvion University</a></li>
                    <li><a href="blog.html" class="active-link">Blog</a></li>
                    <li><a href="about.html">About Us</a></li>
                </nav>
                <button id="theme-toggle" aria-label="Toggle theme">
                    <i class="fas fa-sun"></i> 
                </button>
            </div>
        </div>
    </header>

    <main class="post-main">
        <div class="post-container">

            <header class="post-header">
                <span class="post-tag">Creative Writing</span>
                <h1>How to Craft Unforgettable Characters: A Writer's Guide</h1>
                <div class="post-meta">
                    <span><i class="fas fa-user-edit"></i> By Elvion AI Staff</span>
                    <span><i class="fas fa-calendar-alt"></i> Nov 5, 2025</span>
                    <span id="estimated-time"><i class="fas fa-clock"></i> Calculating read time...</span>
                </div>
            </header>

            <div class="post-thumbnail-placeholder">
                <i class="fas fa-feather-pointed"></i>
                </div>
            
            <section class="audio-player">
                <select id="voice-select" class="form-input" style="width: auto; margin: 0;">
                    <option value="">Select Voice...</option>
                </select>
                <button id="audio-play-pause-btn" class="audio-player-button" disabled>
                    <i class="fas fa-play"></i>
                    <span>Listen to this Article</span>
                </button>
                <span id="speech-status">Loading voices...</span>
            </section>

            <article class="article-content" id="article-content">
                <p>Your characters are the heart of your story. They are the vessels through which your reader experiences the world you've built, the conflicts you've crafted, and the emotions you want to evoke. A weak plot can sometimes be saved by compelling characters, but even the most brilliant plot will fall flat if the characters feel like cardboard cutouts. So, how do you create three-dimensional, unforgettable characters that leap off the page?</p>

                <h2>1. Beyond the Surface: The Iceberg Method</h2>
                <p>What we see of a character‚Äîtheir appearance, their job, their actions‚Äîis just the tip of the iceberg. The real substance lies beneath the surface. This is their **backstory**. You don't need to dump all of this information on the reader (in fact, please don't!), but *you* need to know it. What was their childhood like? What's their biggest regret? What is the secret they've never told anyone? This hidden weight informs their every decision, fear, and desire.</p>

                <blockquote>
                    **Pro-Tip:** Ask yourself: What is the single most important event that shaped my character into who they are today? How does it affect their behavior in Chapter 1?
                </blockquote>

                <h2>2. Give Them Flaws (Real Ones)</h2>
                <p>Perfection is boring. A character who is always right, always strong, and always kind is not relatable‚Äîthey're annoying. Real people are messy. They are impatient, they are selfish, they are afraid of spiders, they procrastinate. A flaw makes a character human. More importantly, a character's **fatal flaw** is often the engine of the plot. It's the internal obstacle they must overcome to achieve their external goal. Is your hero brave? Make them reckless. Is your heroine brilliant? Make her arrogant.</p>

                <h2>3. Wants vs. Needs</h2>
                <p>This is a classic writing technique for a reason. Every compelling character has two goals:</p>
                
                <ul>
                    <li><strong>The Want:</strong> This is the external, conscious goal. It's what the character *thinks* they need to be happy. (e.g., "I want to win the championship," "I want to get the promotion," "I want to defeat the villain.")</li>
                    <li><strong>The Need:</strong> This is the internal, often subconscious truth. It's what the character *actually* needs to grow as a person. (e.g., "I need to learn to trust my teammates," "I need to realize my family is more important than work," "I need to forgive myself.")</li>
                </ul>

                <p>The best stories create conflict by putting the Want and the Need at odds. The character's journey (their "arc") is complete when they either sacrifice their Want to achieve their Need, or finally realize that what they Needed was the key to getting what they Wanted all along.</p>
                
                <h2>4. Let Their Voice Be Heard</h2>
                <p>How does your character speak? Their dialogue is a window into their soul. A character's voice is more than just an accent; it's their word choice, their sentence structure, their rhythm, and what they choose to say (or not say).</p>
                
                <h3>Quick Voice Tips:</h3>
                <ul>
                    <li>An educated professor might use complex sentences and precise vocabulary.</li>
                    <li>A nervous teenager might speak in short, halting sentences, using a lot of "like" or "um."</li>
                    <li>A cynical detective might use dry, sarcastic wit.</li>
                </ul>
                <p>Try this exercise: Write a scene with two characters arguing, but remove all dialogue tags ("he said," "she yelled"). Can you tell who is speaking just by their words and rhythm? If so, you're on the right track.</p>

                <h2>5. Make Them Act: Decisions Define Character</h2>
                <p>Don't just *tell* us your character is brave; put them in a situation where they must *choose* to be brave, especially when it's hard. Character is revealed through action and choice, especially choices made under pressure. The harder the choice, the more we learn about who they really are. A character who chooses to run into a burning building is defined by that action in a way no amount of descriptive prose ever could.</p>
                
                <p>Ultimately, an unforgettable character feels *real*. They are a bundle of contradictions, flaws, desires, and secrets, just like us. By digging deep into their past, understanding their internal conflicts, and letting them express themselves through a unique voice, you can create characters that readers will carry with them long after the final page.</p>
            </article>

            <section class="comments-wrapper" id="comments">
                <h2>Join the Conversation</h2>

                <div id="auth-container">
                    <div class="auth-toggle">
                        <button id="auth-toggle-login" class="auth-toggle-btn btn-secondary active">Login</button>
                        <button id="auth-toggle-signup" class="auth-toggle-btn btn-secondary">Sign Up</button>
                    </div>
                    
                    <form id="auth-form" class="auth-form">
                        <div id="auth-username-group">
                            <label for="auth-username" class="form-label">Username</label>
                            <input type="text" id="auth-username" class="form-input" placeholder="Choose a display name">
                        </div>
                        <div id="auth-pic-group">
                            <label for="auth-pic-url" class="form-label">Profile Pic URL (Optional)</label>
                            <input type="text" id="auth-pic-url" class="form-input" placeholder="http://your-image.com/pic.jpg or leave blank for a default avatar">
                        </div>
                        <div>
                            <label for="auth-email" class="form-label">Email</label>
                            <input type="email" id="auth-email" class="form-input" placeholder="you@example.com" required>
                        </div>
                        <div>
                            <label for="auth-password" class="form-label">Password</label>
                            <input type="password" id="auth-password" class="form-input" placeholder="Min. 6 characters" required>
                        </div>
                        <button type="submit" id="auth-submit-button" class="btn-primary">Login</button>
                        <p id="auth-error" style="color: red; margin-top: 1rem;"></p>
                    </form>
                </div>

                <div class="comment-form" id="comment-form-container" style="display: none;">
                    <h3>Leave a Comment</h3>
                    <textarea id="comment-input" class="form-input" placeholder="Share your thoughts..."></textarea>
                    <div class="emoji-suggestions" id="emoji-suggestion-box">
                        <span>üëç</span>
                        <span>‚ù§Ô∏è</span>
                        <span>üòÇ</span>
                        <span>üòÆ</span>
                        <span>ü§î</span>
                        <span>üí°</span>
                    </div>
                    <button id="comment-button" class="btn-primary">Post Comment</button>
                </div>

                <div id="comment-list-container">
                    <h3 id="comment-list-title">Comments</h3>
                    <div id="comment-list">
                        <p style="text-align: center; color: #777;">Loading comments...</p>
                        </div>
                </div>

            </section>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="col">
                <span class="brand-info">Elvion AI</span>
                <p>Where Assistance Meets Excellence.</p>
            </div>
            <div class="col">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="index.html#hero">Home</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="university.html">University</a></li>
                </ul>
            </div>
            <div class="col">
                <h4>Company</h4>
                <ul>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="mailto:Philipsmith@consultant.com">Contact Us</a></li>
                </ul>
            </div>
            <div class="col">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms of Service</a></li>
                </ul>
            </div>
            <div class="legal-info">
                &copy; <span id="current-year-footer"></span> Elvion AI. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // --- Theme Toggle Script & Hamburger ---
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');

            // Default to dark theme, but check local storage
            const savedTheme = localStorage.getItem('theme') || 'dark';

            function applyTheme(theme) {
                if (theme === 'light') {
                    body.classList.add('light-theme');
                    toggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    body.classList.remove('light-theme');
                    toggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                }
                localStorage.setItem('theme', theme);
            }

            applyTheme(savedTheme);

            toggleButton.addEventListener('click', () => {
                const currentTheme = body.classList.contains('light-theme') ? 'light' : 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
            });

            // --- Mobile Menu ---
            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
            // Close menu on link click
            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 992) {
                        hamburger.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });
            });

            document.getElementById('current-year-footer').textContent = new Date().getFullYear();
        });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const playPauseBtn = document.getElementById('audio-play-pause-btn');
            const speechStatus = document.getElementById('speech-status');
            const articleContent = document.getElementById('article-content');
            const voiceSelect = document.getElementById('voice-select');
            const estimatedTimeEl = document.getElementById('estimated-time');
            
            const synth = window.speechSynthesis;
            const WPM = 200; // Average words per minute for reading time calculation

            let isPlaying = false;
            let isPaused = false;
            let currentUtterance = null;
            let wordsMap = []; // Array of {text: 'word', element: <p>, originalHTML: '...' }
            let wordIndexInMap = 0;

            if ('speechSynthesis' in window) {
                
                // --- 1. Content Processing & Read Time ---
                function processArticleContent() {
                    let totalWordCount = 0;
                    wordsMap = [];
                    
                    // Select all relevant content containers (p, h2, h3, li, blockquote)
                    const elements = articleContent.querySelectorAll('p:not(.post-meta), h2, h3, li, blockquote');
                    
                    elements.forEach(el => {
                        const originalHTML = el.innerHTML;
                        const text = el.textContent.trim();
                        if (text.length === 0) return;
                        
                        // Use a full sentence split, not just words, for accurate TTS segmenting
                        // This text will be the basis for the SpeechSynthesisUtterance
                        const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];

                        sentences.forEach(sentence => {
                            const words = sentence.match(/\b\w+[\.,;:]?\b/g) || [];
                            
                            words.forEach((word) => {
                                wordsMap.push({ text: word, element: el, originalHTML: originalHTML, sentence: sentence });
                                totalWordCount++;
                            });
                        });
                        
                        // Store the sentence text for the utterance
                        el.setAttribute('data-tts-text', sentences.join(' '));
                    });
                    
                    // Calculate and display reading time
                    const readTimeMinutes = Math.ceil(totalWordCount / WPM);
                    estimatedTimeEl.innerHTML = `<i class="fas fa-clock"></i> ${readTimeMinutes} min read`;
                }
                
                // --- 2. Voice Selection Setup ---
                function populateVoiceList() {
                    const voices = synth.getVoices();
                    voiceSelect.innerHTML = '<option value="">Select Voice...</option>';
                    
                    // Filter for two preferred English voices (Male/Female)
                    const englishVoices = voices.filter(v => v.lang.startsWith('en'));
                    
                    let femaleVoice = englishVoices.find(v => v.name.toLowerCase().includes('female')) || englishVoices[0];
                    let maleVoice = englishVoices.find(v => v.name.toLowerCase().includes('male')) || englishVoices[1];
                    
                    if (femaleVoice) {
                        const option = document.createElement('option');
                        option.textContent = `${femaleVoice.name} (Female)`;
                        option.value = femaleVoice.name;
                        option.selected = true; // Set female as default
                        voiceSelect.appendChild(option);
                    }
                    if (maleVoice && maleVoice.name !== (femaleVoice ? femaleVoice.name : '')) {
                        const option = document.createElement('option');
                        option.textContent = `${maleVoice.name} (Male)`;
                        option.value = maleVoice.name;
                        voiceSelect.appendChild(option);
                    }

                    if (voiceSelect.options.length > 1) {
                         speechStatus.textContent = "Voice selected. Ready to listen.";
                         playPauseBtn.disabled = false;
                    } else {
                        speechStatus.textContent = "Voices loading or not found.";
                    }
                }
                
                // --- 3. Speech Control & Highlighting ---
                function startSpeaking(voiceName) {
                    removeHighlighting();
                    wordIndexInMap = 0; // Reset word index
                    
                    // Combine all tts-text attributes for the full reading
                    const fullText = Array.from(articleContent.querySelectorAll('[data-tts-text]'))
                        .map(el => el.getAttribute('data-tts-text')).join(' ');

                    if (!fullText) {
                        speechStatus.textContent = "No text found to read.";
                        return;
                    }

                    currentUtterance = new SpeechSynthesisUtterance(fullText);
                    
                    const selectedVoice = synth.getVoices().find(v => v.name === voiceName);
                    if (selectedVoice) {
                        currentUtterance.voice = selectedVoice;
                    }

                    currentUtterance.onstart = () => {
                        isPlaying = true;
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> <span>Pause</span>';
                        speechStatus.textContent = "Reading aloud...";
                    };
                    
                    currentUtterance.onboundary = (event) => {
                        if (event.name === 'word') {
                            removeHighlighting(); // Clean previous word highlight
                            
                            // Find the word in the map that corresponds to the current spoken boundary
                            let foundWordData = wordsMap[wordIndexInMap];
                            
                            if (foundWordData) {
                                const currentElement = foundWordData.element;
                                const wordToHighlight = foundWordData.text;
                                
                                // Restore the element's original content (in case of previous highlights)
                                currentElement.innerHTML = currentElement.getAttribute('data-original-html') || currentElement.innerHTML;

                                // Regex to find the *exact* word in the element's text and wrap it
                                // Must handle punctuation (e.g., "story." vs "story")
                                const regex = new RegExp(`(?<!<[^>]*>)(\\b${wordToHighlight}\\b)`);
                                
                                if (regex.test(currentElement.innerHTML)) {
                                    currentElement.innerHTML = currentElement.innerHTML.replace(regex, `<span class="word-highlight">$1</span>`);
                                    currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                                
                                wordIndexInMap++;
                            }
                        }
                    };

                    currentUtterance.onend = () => {
                        resetPlayer();
                        removeHighlighting();
                        speechStatus.textContent = "Finished reading.";
                    };
                    
                    currentUtterance.onerror = (e) => {
                        console.error('Speech synthesis error:', e);
                        resetPlayer();
                        speechStatus.textContent = "Error reading";
                    };

                    synth.speak(currentUtterance);
                }

                function removeHighlighting() {
                    // Clean up all highlighting spans across the article
                    const highlightedSpans = articleContent.querySelectorAll('.word-highlight');
                    highlightedSpans.forEach(span => {
                         // Use a temporary element to safely replace the span with its content
                        span.outerHTML = span.innerHTML; 
                    });
                }
                
                function resetPlayer() {
                    isPlaying = false;
                    isPaused = false;
                    wordIndexInMap = 0; // Reset map index
                    removeHighlighting();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i> <span>Listen to this Article</span>';
                    synth.cancel();
                }

                // --- 4. Event Listeners ---
                playPauseBtn.addEventListener('click', () => {
                    const selectedVoice = voiceSelect.value;
                    if (!selectedVoice) {
                        speechStatus.textContent = "Please select a voice first!";
                        return;
                    }

                    if (!isPlaying && !isPaused) {
                        startSpeaking(selectedVoice);
                    } else if (isPlaying && !isPaused) {
                        isPlaying = false;
                        isPaused = true;
                        synth.pause();
                        speechStatus.textContent = "Paused";
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i> <span>Resume</span>';
                    } else if (!isPlaying && isPaused) {
                        isPlaying = true;
                        isPaused = false;
                        synth.resume();
                        speechStatus.textContent = "Reading aloud...";
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i> <span>Pause</span>';
                    }
                });

                // Re-process content on load
                processArticleContent();
                // Store original HTML for accurate highlighting
                articleContent.querySelectorAll('p:not(.post-meta), h2, h3, li, blockquote')
                    .forEach(el => el.setAttribute('data-original-html', el.innerHTML));

                // Re-populate voice list if voices load later
                synth.onvoiceschanged = populateVoiceList;
                populateVoiceList(); // Call immediately for browsers that load voices fast

                // Clean up on page exit
                window.onbeforeunload = () => {
                    synth.cancel();
                };

            } else {
                speechStatus.textContent = "Audio playback not supported by your browser.";
                playPauseBtn.disabled = true;
                estimatedTimeEl.textContent = '';
            }
        });
    </script>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            updateProfile 
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            onSnapshot, 
            orderBy, 
            updateDoc, 
            doc, 
            arrayUnion, 
            arrayRemove, 
            getDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
            authDomain: "elvionai.firebaseapp.com",
            projectId: "elvionai",
            storageBucket: "elvionai.firebasestorage.app",
            messagingSenderId: "161078300830",
            appId: "1:161078300830:web:f460df8591704eb0e96b8f"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. STATE & CONSTANTS ---
        let currentUser = null;
        const ARTICLE_ID = 'crafting-characters-01';

        // --- 3. DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const authForm = document.getElementById('auth-form');
        const authToggleLogin = document.getElementById('auth-toggle-login');
        const authToggleSignup = document.getElementById('auth-toggle-signup');
        const authUsernameGroup = document.getElementById('auth-username-group');
        const authPicGroup = document.getElementById('auth-pic-group');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authUsernameInput = document.getElementById('auth-username');
        const authPicInput = document.getElementById('auth-pic-url');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authError = document.getElementById('auth-error');

        const commentFormContainer = document.getElementById('comment-form-container');
        const commentButton = document.getElementById('comment-button');
        const commentInput = document.getElementById('comment-input');
        const commentList = document.getElementById('comment-list');
        const emojiSuggestionBox = document.getElementById('emoji-suggestion-box');
        
        // --- 4. AUTHENTICATION ---

        function toggleAuthForm(isLogin) {
            authError.textContent = '';
            if (isLogin) {
                authToggleLogin.classList.add('active');
                authToggleSignup.classList.remove('active');
                authUsernameGroup.style.display = 'none';
                authPicGroup.style.display = 'none';
                authSubmitButton.textContent = 'Login';
            } else {
                authToggleLogin.classList.remove('active');
                authToggleSignup.classList.add('active');
                authUsernameGroup.style.display = 'block';
                authPicGroup.style.display = 'block';
                authSubmitButton.textContent = 'Sign Up';
            }
        }
        
        authToggleLogin.addEventListener('click', () => toggleAuthForm(true));
        authToggleSignup.addEventListener('click', () => toggleAuthForm(false));

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const isLogin = authSubmitButton.textContent === 'Login';
            authError.textContent = '';

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const username = authUsernameInput.value;
                    const picUrl = authPicInput.value || `https://api.dicebear.com/8.x/initials/svg?seed=${username}`;
                    
                    if (!username) {
                        authError.textContent = 'Please enter a username.';
                        return;
                    }

                    await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(auth.currentUser, { 
                        displayName: username, 
                        photoURL: picUrl 
                    });
                }
            } catch (error) {
                console.error("Auth error:", error);
                authError.textContent = error.message;
            }
        });

        // State change listener ensures the UI reflects the logged-in status
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                commentFormContainer.style.display = 'block';
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                commentFormContainer.style.display = 'none';
                toggleAuthForm(true); 
            }
        });

        // --- 5. COMMENTS LOGIC ---

        commentButton.addEventListener('click', async () => {
            if (!currentUser) return;

            const commentText = commentInput.value.trim();
            if (!commentText) return;
            
            const commentData = {
                text: commentText,
                userName: currentUser.displayName,
                userProfilePic: currentUser.photoURL,
                userId: currentUser.uid,
                timestamp: Timestamp.fromDate(new Date()),
                articleId: ARTICLE_ID,
                replies: [],
                likes: [],
                helpful: [],
                notHelpful: []
            };

            try {
                await addDoc(collection(db, 'comments'), commentData);
                commentInput.value = '';
            } catch (error) {
                console.error("Error posting comment: ", error);
                authError.textContent = 'Failed to post comment. Check console.';
            }
        });

        emojiSuggestionBox.addEventListener('click', (e) => {
            if (e.target.tagName === 'SPAN') {
                commentInput.value += e.target.textContent;
                commentInput.focus();
            }
        });

        // --- 6. REAL-TIME COMMENT RENDERING ---

        const q = query(
            collection(db, 'comments'), 
            where("articleId", "==", ARTICLE_ID),
            orderBy("timestamp", "desc")
        );

        onSnapshot(q, (snapshot) => {
            commentList.innerHTML = ''; 
            if (snapshot.empty) {
                document.getElementById('comment-list-title').textContent = 'No comments yet. Be the first!';
                return;
            }
            
            document.getElementById('comment-list-title').textContent = `${snapshot.size} Comments`;
            snapshot.forEach((doc) => {
                commentList.appendChild(renderComment(doc));
            });
        });

        function renderComment(doc) {
            const comment = doc.data();
            const commentId = doc.id;
            const li = document.createElement('li');
            li.className = 'comment';
            
            const hasLiked = currentUser && comment.likes.includes(currentUser.uid);
            const hasFoundHelpful = currentUser && comment.helpful.includes(currentUser.uid);
            const hasFoundNotHelpful = currentUser && comment.notHelpful.includes(currentUser.uid);
            
            let repliesHtml = '';
            if (comment.replies && comment.replies.length > 0) {
                comment.replies.sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);
                
                comment.replies.forEach(reply => {
                    const replyTimestamp = reply.timestamp && reply.timestamp.seconds ? 
                        new Date(reply.timestamp.seconds * 1000).toLocaleString() : 'Just now';
                    
                    const defaultReplyAvatar = `https://api.dicebear.com/8.x/initials/svg?seed=${reply.userName}`;
                    repliesHtml += `
                        <div class="reply">
                            <img src="${reply.userProfilePic || defaultReplyAvatar}" alt="${reply.userName} Profile Pic" />
                            <div class="comment-content">
                                <span class="comment-user">${reply.userName} <span class="custom-verified-badge"></span></span>
                                <p class="comment-text">${reply.text}</p>
                                <div class="comment-meta">${replyTimestamp}</div>
                            </div>
                        </div>
                    `;
                });
            }

            const defaultAvatar = `https://api.dicebear.com/8.x/initials/svg?seed=${comment.userName}`;
            li.innerHTML = `
                <img src="${comment.userProfilePic || defaultAvatar}" alt="${comment.userName} Profile Pic" />
                <div class="comment-content">
                    <span class="comment-user">
                        ${comment.userName}
                        <span class="custom-verified-badge" title="${comment.userLevel || 'User'}"></span>
                    </span>
                    <p class="comment-text">${comment.text}</p>
                    <div class="comment-meta">${new Date(comment.timestamp.seconds * 1000).toLocaleString()}</div>
                    <div class="comment-actions" data-id="${commentId}">
                        <button class="like-button ${hasLiked ? 'active' : ''}" title="Like">
                            <i class="fas fa-thumbs-up"></i> (${comment.likes.length})
                        </button>
                        <button class="helpful-button ${hasFoundHelpful ? 'active' : ''}" title="Helpful">
                            <i class="fas fa-hands-clapping"></i> (${comment.helpful.length})
                        </button>
                        <button class="not-helpful-button ${hasFoundNotHelpful ? 'active' : ''}" title="Not Helpful">
                            <i class="fas fa-thumbs-down"></i> (${comment.notHelpful.length})
                        </button>
                        <button class="reply-button" title="Reply">
                            <i class="fas fa-reply"></i> Reply
                        </button>
                    </div>
                    
                    <div class="reply-box" id="reply-box-${commentId}">
                        <textarea class="form-input" placeholder="Write a reply..."></textarea>
                        <button class="submit-reply-button btn-primary">Submit Reply</button>
                    </div>

                    <div class="replies-container">
                        ${repliesHtml}
                    </div>
                </div>
            `;
            return li;
        }

        // --- 7. EVENT DELEGATION (Action Handlers) ---
        
        commentList.addEventListener('click', async (e) => {
            if (!currentUser) {
                alert("Please log in to interact with comments.");
                return;
            }

            const button = e.target.closest('button');
            if (!button) return;
            
            const commentActions = e.target.closest('.comment-actions');
            const commentContent = e.target.closest('.comment-content');

            // Handle actions within .comment-actions
            if (commentActions) {
                const commentId = commentActions.dataset.id;
                const commentRef = doc(db, 'comments', commentId);

                if (button.classList.contains('like-button')) {
                    toggleArrayVote(commentRef, 'likes', currentUser.uid);
                } else if (button.classList.contains('helpful-button')) {
                    toggleArrayVote(commentRef, 'helpful', currentUser.uid);
                } else if (button.classList.contains('not-helpful-button')) {
                    toggleArrayVote(commentRef, 'notHelpful', currentUser.uid);
                } else if (button.classList.contains('reply-button')) {
                    const replyBox = commentContent.querySelector(`#reply-box-${commentId}`);
                    replyBox.style.display = replyBox.style.display === 'none' ? 'block' : 'none';
                }
            }
            
            // Handle actions within .reply-box
            if (button.classList.contains('submit-reply-button')) {
                const replyBox = e.target.closest('.reply-box');
                const commentId = replyBox.id.replace('reply-box-', '');
                const commentRef = doc(db, 'comments', commentId);
                const replyTextarea = replyBox.querySelector('textarea');
                const replyText = replyTextarea.value.trim();
                
                if (!replyText) return;
                
                const replyData = {
                    text: replyText,
                    userName: currentUser.displayName,
                    userProfilePic: currentUser.photoURL,
                    userId: currentUser.uid,
                    timestamp: Timestamp.fromDate(new Date())
                };

                try {
                    await updateDoc(commentRef, {
                        replies: arrayUnion(replyData)
                    });
                    replyTextarea.value = '';
                    replyBox.style.display = 'none';
                } catch (error) {
                    console.error("Error adding reply: ", error);
                }
            }
        });
        
        // Helper function to TOGGLE a user's ID in an array (like, helpful, etc.)
        async function toggleArrayVote(docRef, fieldName, userId) {
            try {
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) return;
                
                const data = docSnap.data();
                const array = data[fieldName] || [];
                
                // If user ID is present, remove it. If not, add it.
                const operation = array.includes(userId) ? arrayRemove(userId) : arrayUnion(userId);
                
                await updateDoc(docRef, { [fieldName]: operation });
            } catch (error) {
                console.error(`Error toggling ${fieldName}:`, error);
            }
        }
    </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
¬† window.dataLayer = window.dataLayer || [];
¬† function gtag(){dataLayer.push(arguments);}
¬† gtag('js', new Date()); 

¬† gtag('config', 'G-J1YTKP10ZX');
</script>
