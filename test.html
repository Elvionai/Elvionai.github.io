<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to Craft Unforgettable Characters: A Writer's Guide | Elvion AI Blog</title>
    <meta name="description" content="Master the art of character creation with proven techniques to build compelling, three-dimensional characters that readers will love.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- DUAL THEME VARIABLES (Default: DARK MODE) --- */
        :root {
            /* Elvion AI Cyan/Blue Theme */
            --dark-navy: #00001a;
            --bg-color: #0d1117; 
            --text-color: #e6edf3;
            --heading-color: #ffffff;
            --cyan-glow: #00ffff;
            --light-blue-glow: #00aaff; 
            --link-color: var(--cyan-glow);
            --link-hover-color: var(--light-blue-glow);
            --border-color: #21262d;
            --card-bg: #161b22; 
            --button-bg: linear-gradient(45deg, var(--cyan-glow), var(--light-blue-glow));
            --button-text-color: #0d1117; /* Dark text on bright button */
            --button-hover-bg: linear-gradient(45deg, #00d4d4, #0077ff);
            --navbar-bg: rgba(13, 17, 23, 0.95);
            --footer-bg: #0a0e14;
            --highlight-color: rgba(0, 255, 255, 0.3); 
            --comment-bg: #0d1117;
            --shadow-glow: 0 0 10px rgba(0, 255, 255, 0.15);
            /* New: Dark Mode Headline Color */
            --headline-color: var(--light-blue-glow);
        }

        /* LIGHT MODE VARIABLES */
        body.light-theme {
            --bg-color: #f7f7f7; /* Less whitish, slight off-white */
            --text-color: #333333;
            --heading-color: #111111;
            --link-color: #0056b3;
            --link-hover-color: #003d80;
            --border-color: #e0e0e0;
            --card-bg: #ffffff; /* Card background is still white */
            --button-bg: #0056b3;
            --button-text-color: #ffffff;
            --button-hover-bg: #003d80;
            --navbar-bg: rgba(255, 255, 255, 0.95);
            --footer-bg: #eeeeee;
            --highlight-color: #ffeb3b; /* A subtle yellow highlight */
            --comment-bg: #ffffff;
            --shadow-glow: none;
            /* New: Light Mode Headline Color */
            --headline-color: #111111; /* Black headline */
        }

        /* --- GLOBAL STYLES --- */
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-top: 60px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            font-size: 1.1rem;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
            color: var(--heading-color);
            margin-top: 0;
            line-height: 1.3;
            text-shadow: var(--shadow-glow);
        }
        
        a {
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .post-container {
             max-width: 800px;
             margin: 0 auto;
             padding: 0 1rem;
        }

        /* --- Navbar Styles (Existing) --- */
        .navbar {
            position: fixed; top: 0; width: 100%; 
            background: var(--navbar-bg); 
            padding: 1rem 0; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); 
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .navbar-brand { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--heading-color); text-shadow: var(--shadow-glow); }
        .nav-links { display: flex; list-style: none; margin: 0; padding: 0; }
        .nav-links li { margin-left: 2rem; }
        .nav-links a { 
            color: var(--text-color); font-weight: 500; font-family: 'Inter', sans-serif; font-size: 1rem;
            text-transform: uppercase; letter-spacing: 0.5px; padding: 0.5rem 0; position: relative; 
        }
        .nav-links .active-link { color: var(--link-color); }
        .nav-links a::after { 
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0; 
            background: var(--link-color); transition: width 0.3s ease-in-out; 
        }
        .nav-links a:hover::after, .nav-links .active-link::after { width: 100%; }
        
        .hamburger { display: none; flex-direction: column; cursor: pointer; padding: 0.5rem; background: transparent; border: none; }
        .hamburger .bar { 
            width: 25px; height: 3px; background-color: var(--heading-color); margin: 4px 0; transition: 0.4s; box-shadow: none; 
        }
        .hamburger.active .bar:nth-child(2) { opacity: 0; }
        .hamburger.active .bar:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .hamburger.active .bar:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
        
        #theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-left: 1rem;
        }
        #theme-toggle:hover {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* --- Footer Styles (Existing) --- */
        .footer {
            background: var(--footer-bg); color: var(--text-color); padding: 4rem 0 2rem; font-size: 0.9rem;
            border-top: 1px solid var(--border-color); text-align: center; position: relative; margin-top: 4rem;
        }
        .footer .container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            text-align: left;
            max-width: 900px;
        }
        .footer .col h4 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        .footer ul {
            list-style: none;
            padding: 0;
        }
        .footer li {
            margin-bottom: 0.5rem;
        }
        .footer a {
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .footer a:hover {
            color: var(--link-color);
            text-decoration: none;
        }
        .footer .brand-info {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--link-color);
        }
        .footer .legal-info { 
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            color: #777; 
        }

        /* --- Single Post Styles --- */
        .post-main { padding-top: 3rem; padding-bottom: 3rem; position: relative; }
        .post-header { border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .post-header .post-tag { 
            display: inline-block; padding: 0.4rem 1rem; background: var(--button-bg); 
            color: var(--button-text-color); font-weight: 700; font-size: 0.85rem; 
            border-radius: 20px; text-transform: uppercase; margin-bottom: 1rem;
            background-image: var(--button-bg); /* Apply gradient */
        }
        .post-meta {
            display: flex; flex-wrap: wrap; gap: 1.5rem; 
            color: rgba(224, 224, 224, 0.7); font-size: 0.95rem; margin-top: 1rem;
        }
        body.light-theme .post-meta { color: #666; }
        .post-meta span { display: flex; align-items: center; gap: 0.5rem; }
        .post-meta i { color: var(--link-color); }
        
        .post-thumbnail-placeholder {
            height: 300px; line-height: 300px; text-align: center; font-size: 4rem;
            background-color: var(--card-bg); 
            border: 1px solid var(--border-color);
            color: var(--link-color);
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .article-content blockquote {
            border-left: 4px solid var(--link-color);
            color: var(--text-color);
            background: var(--card-bg);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
        }
        
        /* UPDATED: Headline colors */
        .article-content h2 { 
            font-size: 2rem; margin-top: 3rem; margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;
            color: var(--headline-color);
        }
        .article-content h3 { color: var(--heading-color); font-size: 1.5rem; margin-top: 2rem; }
        .article-content ul, .article-content ol { padding-left: 1.5rem; margin-bottom: 1.5rem; }
        .article-content b { color: var(--cyan-glow); font-weight: 600; }
        body.light-theme .article-content b { color: var(--link-color); }
        
        /* NEW: Paragraph highlight style */
        .article-content p.word-highlight,
        .article-content li.word-highlight,
        .article-content blockquote.word-highlight {
            background-color: var(--highlight-color);
            border-radius: 4px;
            padding: 5px;
            margin: -5px 0; /* Adjust margin to accommodate padding */
            transition: background-color 0.1s;
        }
        body.light-theme .article-content p.word-highlight,
        body.light-theme .article-content li.word-highlight,
        body.light-theme .article-content blockquote.word-highlight {
             background-color: var(--highlight-color);
        }

        /* --- UPDATED Audio Player Styles (Futuristic Design) --- */
        .audio-player {
            background: var(--card-bg); 
            border: 1px solid var(--link-color);
            padding: 1.5rem; border-radius: 16px; /* Slightly more rounded */
            margin-bottom: 2.5rem;
            display: flex; /* Use flex for simpler controls layout */
            flex-direction: column;
            gap: 1.5rem;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4); /* Stronger glow */
            transition: all 0.5s ease-in-out;
        }
        body.light-theme .audio-player {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); 
            border-color: #ddd;
        }

        /* New Controls Layout */
        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            width: 100%;
        }

        /* Animated Play/Pause Button */
        #audio-play-pause-btn {
            width: 50px !important; /* Fixed size for a circle */
            height: 50px;
            padding: 0 !important;
            border-radius: 50% !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            background-size: 200% 200%;
            animation: pulse 2s infinite alternate; /* Pulsing effect */
            flex-shrink: 0;
        }
        
        @keyframes pulse {
            from { transform: scale(1); box-shadow: 0 0 10px var(--cyan-glow); }
            to { transform: scale(1.05); box-shadow: 0 0 20px var(--light-blue-glow); }
        }
        body.light-theme #audio-play-pause-btn {
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
             animation: none;
        }

        /* Progress Bar Styling */
        .progress-container {
            width: 100%;
            height: 10px; /* Slightly thicker */
            background: var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.2);
        }

        #audio-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--cyan-glow), var(--light-blue-glow));
            box-shadow: 0 0 8px var(--cyan-glow);
            border-radius: 5px;
            transition: width 0.1s linear, box-shadow 0.3s;
        }
        
        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-color);
            width: 100%;
        }
        
        /* Voice & Speed Selectors */
        #voice-select, #speed-select {
            border-radius: 8px;
            padding: 0.7rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            flex-grow: 1; /* Allow stretching */
            width: auto; /* Reset width constraint */
        }
        #voice-select:focus, #speed-select:focus {
            box-shadow: 0 0 5px var(--link-color);
        }
        
        /* Word Highlighting (Removed, using P/LI/BLOCKQUOTE highlighting now) */

        .btn-primary {
            background: var(--button-bg); color: var(--button-text-color); border: none;
            padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: 700;
            font-family: 'Orbitron', sans-serif; font-size: 1rem; transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .btn-primary:hover { 
            background: var(--button-hover-bg); 
            box-shadow: var(--shadow-glow);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Form Controls */
        .form-input {
            background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color);
            display: block; width: 100%; padding: 0.8rem; margin-bottom: 1rem; border-radius: 4px; box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }
        .form-input:focus { 
            border-color: var(--link-color); 
            box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.3); 
            outline: none;
        }
        textarea.form-input { min-height: 100px; resize: vertical; }

        /* --- Comment Section Styles (Authentication & Likes/Replies) --- */
        .comments-wrapper { 
            margin-top: 4rem;
            padding-top: 2rem; 
            border-top: 1px solid var(--border-color); 
        }
        .comments-wrapper h2 { 
            font-size: 1.8rem;
            margin-bottom: 2rem;
            border-bottom: none;
        }
        
        /* New: Authentication Prompt */
        .auth-prompt {
            background: var(--card-bg);
            border: 1px solid var(--link-color);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 3rem;
            text-align: center;
        }
        .auth-prompt h3 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }
        .auth-prompt .guest-comment-link {
            display: block;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .comment-form-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 3rem;
        }
        .comment-form-container h3 {
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
        }

        .comment {
            background: var(--comment-bg); border: 1px solid var(--border-color);
            display: flex; gap: 1rem; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        /* NEW: Reply Indentation */
        .comment.reply {
            margin-left: 50px; /* Indent replies */
            border-left: 4px solid var(--link-hover-color); /* Visual distinction */
            margin-top: -0.5rem; /* Reduce vertical spacing between parent and first reply */
            margin-bottom: 1rem;
        }
        
        /* NEW: Styling for the dynamic reply/edit form */
        .reply-form-container {
            margin-top: 1rem;
            padding: 1rem;
            border-top: 1px dashed var(--border-color);
            background: var(--bg-color); /* Use base color for subtle contrast */
            border-radius: 4px;
        }
        .reply-form-container .form-input {
            margin-bottom: 0.5rem;
        }
        
        .comment-avatar { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--link-color); 
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            color: var(--button-text-color); font-weight: 700; flex-shrink: 0;
        }
        .comment-user { 
            font-weight: 600; color: var(--cyan-glow); font-size: 1rem; 
            display: inline-block; margin-bottom: 0.3rem;
        }
        body.light-theme .comment-user { color: var(--link-color); }
        .verified-badge { 
            color: #4CAF50; margin-left: 5px; font-size: 0.8rem; 
            vertical-align: middle; 
        }
        .admin-badge {
            color: gold; margin-left: 5px; font-size: 0.8rem;
            vertical-align: middle;
        }
        .guest-badge {
            color: #999; margin-left: 5px; font-size: 0.8rem;
            vertical-align: middle;
        }
        .comment-meta {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.5rem;
        }
        .comment-actions {
            font-size: 0.9rem;
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            color: #777;
        }
        .comment-actions button {
            background: none; border: none; color: #777; cursor: pointer;
            transition: color 0.2s; font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }
        .comment-actions button:hover {
            color: var(--link-color);
        }
        .comment-actions button:disabled {
            color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .comment-actions i {
            margin-right: 5px;
        }
        .like-btn.liked {
            color: #E91E63;
        }
        
        .no-comments {
            text-align: center;
            padding: 3rem;
            color: #777;
        }
        
        /* Responsive adjustments (Existing) */
        @media (max-width: 992px) {
            .nav-links {
                display: none;
                flex-direction: column;
                width: 100%;
                background: var(--navbar-bg);
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem 0;
                border-top: 1px solid var(--border-color);
            }
            .nav-links.active {
                display: flex;
            }
            .nav-links li {
                margin: 0.5rem 2rem;
            }
            .nav-links a::after { display: none; }
            .hamburger { display: flex; }
            .footer .container { grid-template-columns: repeat(2, 1fr); }
            .footer .col:nth-child(1), .footer .col:nth-child(2) { margin-bottom: 1.5rem; }
        }

        @media (max-width: 500px) {
            .footer .container { grid-template-columns: 1fr; text-align: center; }
            .footer .col { margin-bottom: 1rem; }
            .audio-player { 
                gap: 1rem;
            }
            .audio-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .audio-controls > * {
                width: 100% !important;
                margin: 0 !important;
            }
            #audio-play-pause-btn {
                width: 100% !important;
                height: auto;
                padding: 0.8rem !important;
                border-radius: 8px !important;
            }
            .comment.reply {
                margin-left: 20px;
            }
        }
    </style>
</head>
<body>
    
    <header class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">Elvion AI</a>
            
            <div class="nav-controls">
                <nav class="nav-links">
                    <li><a href="university.html">University</a></li>
                    <li><a href="blog.html" class="active-link">Blog</a></li>
                    <li><a href="about.html">About Us</a></li>
                </nav>
                <button id="theme-toggle" aria-label="Toggle theme">
                    <i class="fas fa-sun"></i> 
                </button>
                <button class="hamburger" aria-label="Toggle navigation">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
            </div>
        </div>
    </header>

    <main class="post-main">
        <div class="post-container">

            <header class="post-header">
                <span class="post-tag">Creative Writing</span>
                <h1>How to Craft Unforgettable Characters: A Writer's Guide</h1>
                <div class="post-meta">
                    <span><i class="fas fa-user-edit"></i> By Elvion AI Staff</span>
                    <span><i class="fas fa-calendar-alt"></i> Nov 5, 2025</span>
                    <span id="estimated-time"><i class="fas fa-clock"></i> Calculating read time...</span>
                </div>
            </header>

            <div class="post-thumbnail-placeholder">
                <i class="fas fa-feather-pointed"></i>
            </div>
            
            <section class="audio-player">
                <div class="audio-controls">
                    <span id="reading-time"></span>
                    <select id="voice-select" class="form-input" style="flex-grow: 2;">
                        <option value="" disabled selected>Select AI Voice...</option>
                        <option value="audios/a5cae336-01dd-431b-b388-9a319258d85f.wav">Philadelphia AI (Female)</option>
                        <option value="audios/c72d8fbf-8a99-451d-b94c-8d7c8ffef5e5.wav">Funny Daddy (Male)</option>
                    </select>
                    <select id="speed-select" class="form-input" style="flex-grow: 1;">
                        <option value="1.0">Normal</option>
                        <option value="0.75">0.75x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                    </select>
                    <button id="audio-play-pause-btn" class="btn-primary" disabled style="width: 50px; height: 50px; padding: 0;" aria-label="Select a voice to play audio">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
                
                <div class="progress-container" id="progress-container">
                    <div id="audio-progress-bar"></div>
                </div>
                <div class="progress-time">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <span id="speech-status" style="font-size: 0.9rem; color: #aaa; text-align: center;">Select a voice to begin listening.</span>
            </section>
            
            <article class="article-content" id="article-content">
                <p>Your characters are the heart of your story. They are the vessels through which your reader experiences the world you've built, the conflicts you've crafted, and the emotions you want to evoke. A weak plot can sometimes be saved by compelling characters, but even the most brilliant plot will fall flat if the characters feel like cardboard cutouts. So, how do you create three-dimensional, unforgettable characters that leap off the page?</p>

                <h2>1. Beyond the Surface: The Iceberg Method</h2>
                <p>What we see of a characterâ€”their appearance, their job, their actionsâ€”is just the tip of the iceberg. The real substance lies beneath the surface. This is their backstory. You don't need to dump all of this information on the reader (in fact, please don't!), but <i>you</i> need to know it. What was their childhood like? What's their biggest regret? What is the secret they've never told anyone? This hidden weight informs their every decision, fear, and desire.</p>

                <blockquote>
                    <b>Pro-Tip:</b> Ask yourself: What is the single most important event that shaped my character into who they are today? How does it affect their behavior in Chapter 1?
                </blockquote>

                <h2>2. Give Them Flaws (Real Ones)</h2>
                <p>Perfection is boring. A character who is always right, always strong, and always kind is not relatableâ€”they're annoying. Real people are messy. They are impatient, they are selfish, they are afraid of spiders, they procrastinate. A flaw makes a character human. More importantly, a character's fatal flaw is often the engine of the plot. It's the internal obstacle they must overcome to achieve their external goal. Is your hero brave? Make them reckless. Is your heroine brilliant? Make her arrogant.</p>

                <h2>3. Wants vs. Needs</h2>
                <p>This is a classic writing technique for a reason. Every compelling character has two goals:</p>
                
                <ul>
                    <li><b>The Want:</b> This is the external, conscious goal. It's what the character <i>thinks</i> they need to be happy. (e.g., "I want to win the championship.")</li>
                    <li><b>The Need:</b> This is the internal, often subconscious truth. It's what the character <i>actually</i> needs to grow as a person. (e.g., "I need to learn to trust my teammates.")</li>
                </ul>

                <p>The best stories create conflict by putting the Want and the Need at odds. The character's journey (their "arc") is complete when they either sacrifice their Want to achieve their Need, or finally realize that what they Needed was the key to getting what they Wanted all along.</p>
                
                <h2>4. Let Their Voice Be Heard</h2>
                <p>How does your character speak? Their dialogue is a window into their soul. A character's voice is more than just an accent; it's their word choice, their sentence structure, their rhythm, and what they choose to say (or not say).</p>
                
                <h3>Quick Voice Tips:</h3>
                <ul>
                    <li>An educated professor might use complex sentences and precise vocabulary.</li>
                    <li>A nervous teenager might speak in short, halting sentences, using a lot of "like" or "um."</li>
                    <li>A cynical detective might use dry, sarcastic wit.</li>
                </ul>
                <p>Try this exercise: Write a scene with two characters arguing, but remove all dialogue tags ("he said," "she yelled"). Can you tell who is speaking just by their words and rhythm? If so, you're on the right track.</p>

                <h2>5. Make Them Act: Decisions Define Character</h2>
                <p>Don't just <i>tell</i> us your character is brave; put them in a situation where they must <i>choose</i> to be brave, especially when it's hard. Character is revealed through action and choice, especially choices made under pressure. The harder the choice, the more we learn about who they really are. A character who chooses to run into a burning building is defined by that action in a way no amount of descriptive prose ever could.</p>
                
                <p>Ultimately, an unforgettable character feels <b>real</b>. They are a bundle of contradictions, flaws, desires, and secrets, just like us. By digging deep into their past, understanding their internal conflicts, and letting them express themselves through a unique voice, you can create characters that readers will carry with them long after the final page.</p>
            </article>

            <section class="comments-wrapper" id="comments">
                <h2>ðŸ’¬ Join the Conversation (<span id="comment-count">0</span> Comments)</h2>

                <div id="auth-prompt" class="auth-prompt">
                    <h3>Join the discussion!</h3>
                    <p>Sign in to post, like, and reply with a verified profile, or comment as a guest.</p>
                    <button id="google-sign-in-btn" class="btn-primary" style="background: #DB4437; background-image: none;">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                    <a href="#" id="guest-comment-link" class="guest-comment-link">Or, comment as a Guest User (No likes/replies)</a>
                    <p id="auth-status" style="margin-top: 1rem; font-size: 0.9rem;"></p>
                </div>
                
                <div class="comment-form-container" id="comment-form-container" style="display: none;">
                    <h3>Leave a Comment As <span id="current-user-name" style="color: var(--link-color);"></span></h3>
                    <form id="comment-form">
                        <div id="guest-name-input" style="display: none; margin-bottom: 1rem;">
                            <label for="guest-name-field" class="form-label">Your Name <span style="color: red;">*</span></label>
                            <input type="text" id="guest-name-field" class="form-input" placeholder="Enter a name to display" required>
                        </div>
                        <div>
                            <label for="comment-input-text" class="form-label">Share your thoughts <span style="color: red;">*</span></label>
                            <textarea id="comment-input-text" class="form-input" placeholder="What did you think? (Supports links, **bold**, _italics_, and line breaks!)" required></textarea>
                        </div>
                        <button type="submit" id="comment-button" class="btn-primary">
                            <i class="fas fa-paper-plane"></i> Post Comment
                        </button>
                    </form>
                </div>

                <div id="comment-list-container">
                    <div id="comment-list">
                        <p class="loading-message" style="text-align: center; color: #777;">Loading comments...</p>
                    </div>
                </div>

            </section>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="col">
                <span class="brand-info">Elvion AI</span>
                <p>Where Assistance Meets Excellence.</p>
            </div>
            <div class="col">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="index.html#hero">Home</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="university.html">University</a></li>
                </ul>
            </div>
            <div class="col">
                <h4>Company</h4>
                <ul>
                    <li><a href="about.html">About Us</a></li>
                    <li><a href="mailto:contact@elvionai.com">Contact Us</a></li>
                </ul>
            </div>
            <div class="col">
                <h4>Legal</h4>
                <ul>
                    <li><a href="privacy.html">Privacy Policy</a></li>
                    <li><a href="terms.html">Terms of Service</a></li>
                </ul>
            </div>
            <div class="legal-info">
                &copy; <span id="current-year-footer"></span> Elvion AI. All rights reserved.
            </div>
        </div>
    </footer>

    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"></script>
    
    <script>
        // --- THEME TOGGLE & NAV SCRIPT (Existing) ---
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');

            const savedTheme = localStorage.getItem('theme') || 'dark';

            function applyTheme(theme) {
                if (theme === 'light') {
                    body.classList.add('light-theme');
                    toggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    body.classList.remove('light-theme');
                    toggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                }
                localStorage.setItem('theme', theme);
            }

            applyTheme(savedTheme);

            toggleButton.addEventListener('click', () => {
                const currentTheme = body.classList.contains('light-theme') ? 'light' : 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
            });

            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 992) {
                        hamburger.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });
            });

            document.getElementById('current-year-footer').textContent = new Date().getFullYear();
        });
    </script>
    
    <script>
        // --- TEXT TO SPEECH SCRIPT (UPDATED TO PARAGRAPH-LEVEL HIGHLIGHTING) ---
        document.addEventListener('DOMContentLoaded', () => {
            const playPauseBtn = document.getElementById('audio-play-pause-btn');
            const speechStatus = document.getElementById('speech-status');
            const voiceSelect = document.getElementById('voice-select');
            const speedSelect = document.getElementById('speed-select');
            const articleContent = document.getElementById('article-content');
            const estimatedTimeEl = document.getElementById('estimated-time');
            const readingTimeEl = document.getElementById('reading-time');
            const progressBar = document.getElementById('audio-progress-bar');
            const progressContainer = document.getElementById('progress-container');
            const currentTimeEl = document.getElementById('current-time');
            const durationEl = document.getElementById('duration');
            
            const WPM = 200; 

            let audio = new Audio();
            let isPlaying = false;
            let ttsElements = []; // Now stores elements (p, li, blockquote)
            let currentElementIndex = -1; // Start before the first element
            
            // --- 1. Content Processing & Read Time ---
            function processArticleContent() {
                // Calculate and display reading time
                const fullText = articleContent.textContent;
                const totalWordCount = fullText.split(/\s+/).filter(word => word.length > 0).length;
                const readTimeMinutes = Math.ceil(totalWordCount / WPM);
                
                estimatedTimeEl.innerHTML = `<i class="fas fa-clock"></i> ${readTimeMinutes} min read`;
                readingTimeEl.textContent = `Duration: ${readTimeMinutes} min (Approx)`;

                // 2. Element Selection: Select P, LI, and BLOCKQUOTE for highlighting
                ttsElements = Array.from(articleContent.querySelectorAll('p, li, blockquote'));
                
                // Enable button since content is processed
                playPauseBtn.disabled = false;
            }
            
            // --- 2. Audio Control & Player Functions ---
            
            function formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min}:${sec.toString().padStart(2, '0')}`;
            }

            function updateProgress() {
                if (isNaN(audio.duration)) return;
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${progress}%`;
                currentTimeEl.textContent = formatTime(audio.currentTime);
                highlightElementByTime(audio.currentTime); // NEW: Call paragraph highlight
            }
            
            function seekAudio(event) {
                if (!audio.src || isNaN(audio.duration)) return;
                const rect = progressContainer.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const width = rect.width;
                const seekTime = (clickX / width) * audio.duration;
                audio.currentTime = seekTime;
            }

            function resetPlayer() {
                isPlaying = false;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play audio');
                speechStatus.textContent = "Select a voice to begin listening.";
                audio.pause();
                audio.currentTime = 0; 
                progressBar.style.width = '0%';
                currentTimeEl.textContent = '0:00';
                if (audio.src) { // Only show duration if a voice is selected
                    durationEl.textContent = formatTime(audio.duration || 0);
                } else {
                    durationEl.textContent = '0:00';
                }
                removeHighlighting();
                currentElementIndex = -1;
            }
            
            function removeHighlighting() {
                ttsElements.forEach(el => el.classList.remove('word-highlight'));
            }

            // NEW: Paragraph-level highlighting (Linear approximation)
            function highlightElementByTime(time) {
                if (ttsElements.length === 0 || isNaN(audio.duration) || audio.duration === 0) return;
                
                const totalDuration = audio.duration;
                const progressRatio = time / totalDuration;
                
                // Target index is based on the ratio of the total elements
                let targetIndex = Math.floor(progressRatio * ttsElements.length);
                if (targetIndex >= ttsElements.length) targetIndex = ttsElements.length - 1;

                if (targetIndex !== currentElementIndex && targetIndex >= 0) {
                    
                    // Remove highlight from the *previous* element
                    if (currentElementIndex >= 0 && currentElementIndex < ttsElements.length) {
                         ttsElements[currentElementIndex].classList.remove('word-highlight');
                    }
                    
                    currentElementIndex = targetIndex;
                    
                    const elementToHighlight = ttsElements[currentElementIndex];
                    if (elementToHighlight) {
                        elementToHighlight.classList.add('word-highlight');
                        
                        // Scroll logic: Center the element if it's outside a comfortable view range
                        const rect = elementToHighlight.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        
                        if (rect.top < viewportHeight * 0.25 || rect.bottom > viewportHeight * 0.75) {
                            elementToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }


            // --- 3. Event Listeners ---
            voiceSelect.addEventListener('change', () => {
                resetPlayer();
                const audioSrc = voiceSelect.value;
                if (audioSrc) {
                    audio.src = audioSrc;
                    playPauseBtn.disabled = false;
                    speechStatus.textContent = "Ready to play " + voiceSelect.options[voiceSelect.selectedIndex].text + ".";
                } else {
                    playPauseBtn.disabled = true;
                    speechStatus.textContent = "Select an AI Voice...";
                }
            });
            
            speedSelect.addEventListener('change', () => {
                audio.playbackRate = parseFloat(speedSelect.value);
                if(isPlaying) {
                     speechStatus.textContent = `Reading at ${speedSelect.value}x speed...`;
                }
            });

            playPauseBtn.addEventListener('click', () => {
                if (!audio.src || playPauseBtn.disabled) return;
                
                if (!isPlaying) {
                    isPlaying = true;
                    audio.play().catch(e => console.error("Audio play failed:", e));
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    playPauseBtn.setAttribute('aria-label', 'Pause audio');
                    speechStatus.textContent = `Reading aloud at ${audio.playbackRate}x speed...`;
                } else {
                    isPlaying = false;
                    audio.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playPauseBtn.setAttribute('aria-label', 'Play audio');
                    speechStatus.textContent = "Paused";
                }
            });

            progressContainer.addEventListener('click', seekAudio);

            audio.addEventListener('loadedmetadata', () => {
                durationEl.textContent = formatTime(audio.duration);
                audio.playbackRate = parseFloat(speedSelect.value);
            });
            
            audio.addEventListener('timeupdate', updateProgress);
            
            audio.onended = () => {
                resetPlayer();
                speechStatus.textContent = "Finished reading.";
            };
            
            // Initial load
            processArticleContent();
        });
    </script>


    <script type="module">
        // --- FIREBASE/COMMENT SCRIPT (FIXED IMPORTS & LOGIC FOR REPLIES, EDIT/DELETE) ---
        
        // Use full CDN paths for module imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, where, 
            onSnapshot, doc, arrayUnion, arrayRemove, runTransaction, serverTimestamp, 
            setDoc, deleteDoc // Added for Edit/Delete
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        // --- 0. CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            // Your Elvion AI Configuration
            apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
            authDomain: "elvionai.firebaseapp.com",
            projectId: "elvionai",
            storageBucket: "elvionai.firebasestorage.app",
            messagingSenderId: "161078300830",
            appId: "1:161078300830:web:f460df8591704eb0e96b8f"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const ARTICLE_ID = 'crafting-characters-01';
        const ADMIN_EMAIL = 'koladhino@gmail.com'; 

        // --- 1. DOM Elements ---
        const commentForm = document.getElementById('comment-form');
        const commentTextInput = document.getElementById('comment-input-text');
        const commentList = document.getElementById('comment-list');
        const commentCountEl = document.getElementById('comment-count');
        const submitBtn = document.getElementById('comment-button');
        const authPrompt = document.getElementById('auth-prompt');
        const commentFormContainer = document.getElementById('comment-form-container');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const currentUserNameEl = document.getElementById('current-user-name');
        const guestCommentLink = document.getElementById('guest-comment-link');
        const guestNameInputDiv = document.getElementById('guest-name-input');
        const guestNameField = document.getElementById('guest-name-field');
        
        let currentUser = null;
        let isGuestMode = false;
        let currentReplyToId = null; 

        // --- 2. Authentication & Guest Logic (Remains the same and correct) ---
        
        function setAuthState(user) {
            currentUser = user;
            
            // Clear any active reply/edit forms when auth state changes
            document.querySelectorAll('.reply-form-container').forEach(el => el.remove());
            currentReplyToId = null; 

            if (user) {
                isGuestMode = false;
                authPrompt.style.display = 'none';
                commentFormContainer.style.display = 'block';
                currentUserNameEl.textContent = user.displayName || user.email;
                guestNameInputDiv.style.display = 'none';
                guestNameField.removeAttribute('required');
                guestNameField.value = ''; 
            } else {
                if (!isGuestMode) {
                    authPrompt.style.display = 'block';
                    commentFormContainer.style.display = 'none';
                    currentUserNameEl.textContent = 'Guest';
                    guestNameInputDiv.style.display = 'none';
                } else {
                    authPrompt.style.display = 'none';
                    commentFormContainer.style.display = 'block';
                    currentUserNameEl.textContent = 'Guest User';
                    guestNameInputDiv.style.display = 'block';
                    guestNameField.setAttribute('required', 'required');
                }
            }
            loadComments(); 
        }

        guestCommentLink.addEventListener('click', (e) => {
            e.preventDefault();
            isGuestMode = true;
            setAuthState(null); 
            guestNameField.focus();
        });

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
            }
        });
        
        onAuthStateChanged(auth, user => {
            setAuthState(user);
        });

        // --- 3. Comment Display & Actions (Updated for Edit/Delete) ---
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment';

            if (comment.parentId) {
                div.classList.add('reply');
            }
            
            const userName = escapeHtml(comment.userName) || 'Anonymous';
            const initial = userName.charAt(0).toUpperCase();
            
            let timestampString;
            if (comment.timestamp && typeof comment.timestamp.toDate === 'function') {
                timestampString = new Date(comment.timestamp.toDate()).toLocaleString();
            } else if (comment.timestamp) {
                const date = comment.timestamp || new Date(); 
                timestampString = date instanceof Date ? date.toLocaleString() : 'Just now';
            } else {
                timestampString = 'Pending...';
            }
            
            let badge = '';
            
            if (comment.userEmail === ADMIN_EMAIL) {
                 badge = '<span class="admin-badge" title="Admin/Author"><i class="fas fa-crown"></i> Admin</span>';
            } else if (comment.userId && comment.userId !== 'guest') {
                badge = '<span class="verified-badge" title="Verified User">âœ”</span>';
            } else {
                badge = '<span class="guest-badge" title="Guest User"><i class="fas fa-user-tag"></i> Guest</span>';
            }
            
            const isLiked = currentUser && !isGuestMode && comment.likes && comment.likes.includes(currentUser.uid);
            const likeCount = comment.likes ? comment.likes.length : 0;
            
            // Check if the current user is authenticated AND not in guest mode
            const canPerformAction = currentUser && !isGuestMode; 
            const actionDisabled = !canPerformAction; 
            
            // Check if the current authenticated user can edit/delete this comment
            const canModify = currentUser && comment.userId === currentUser.uid;

            const processedText = formatCommentText(comment.text);
            
            div.innerHTML = `
                <div class="comment-avatar">${initial}</div>
                <div class="comment-content" style="flex-grow: 1;" data-comment-id="${comment.id}">
                    <span class="comment-user">${userName}</span>${badge}
                    ${comment.editedAt ? '<span class="guest-badge" style="margin-left: 5px;">(edited)</span>' : ''}
                    <p class="comment-text">${processedText}</p>
                    <div class="comment-meta">ðŸ• ${timestampString}</div>
                    <div class="comment-actions">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}" ${actionDisabled ? 'disabled' : ''}>
                            <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> 
                            <span>Like</span> (<span class="like-count">${likeCount}</span>)
                        </button>
                        <button class="reply-btn" data-comment-id="${comment.id}" ${actionDisabled ? 'disabled' : ''}>
                            <i class="fas fa-reply"></i> Reply
                        </button>
                        ${canModify ? `<button class="edit-btn" data-comment-id="${comment.id}"><i class="fas fa-edit"></i> Edit</button>` : ''}
                        ${canModify ? `<button class="delete-btn" data-comment-id="${comment.id}" style="color: #dc3545;"><i class="fas fa-trash-alt"></i> Delete</button>` : ''}
                    </div>
                    
                    </div>
            `;
            
            // Add listeners for like/reply
            const likeBtn = div.querySelector('.like-btn');
            if (likeBtn && !actionDisabled) {
                likeBtn.addEventListener('click', () => toggleLike(comment.id, likeBtn));
            }
            
            // NEW: Add listeners for Edit/Delete
            const editBtn = div.querySelector('.edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', () => handleEditButtonClick(comment.id, comment.text));
            }
            
            const deleteBtn = div.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => deleteComment(comment.id));
            }
            
            return div;
        }

        function renderComments(comments) {
            commentList.innerHTML = '';
            
            const topLevelComments = comments.filter(c => !c.parentId);
            const repliesByParentId = comments
                .filter(c => c.parentId)
                .reduce((acc, reply) => {
                    acc[reply.parentId] = acc[reply.parentId] || [];
                    acc[reply.parentId].push(reply);
                    return acc;
                }, {});

            topLevelComments.forEach(comment => {
                const topEl = createCommentElement(comment);
                commentList.appendChild(topEl);
                
                const replyBtn = topEl.querySelector('.reply-btn');
                if (replyBtn) {
                     replyBtn.addEventListener('click', (e) => handleReplyButtonClick(e));
                }

                const replies = repliesByParentId[comment.id] || [];
                replies.forEach(reply => {
                    const replyEl = createCommentElement(reply);
                    commentList.appendChild(replyEl); 
                    
                    const nestedReplyBtn = replyEl.querySelector('.reply-btn');
                    if (nestedReplyBtn) {
                        nestedReplyBtn.addEventListener('click', (e) => handleReplyButtonClick(e));
                    }
                });
            });

            if (comments.length === 0) {
                commentList.innerHTML = `
                    <div class="no-comments">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                        <p>No comments yet. Be the first to share your thoughts! ðŸŒŸ</p>
                    </div>
                `;
            }
        }


        function loadComments() {
             const q = query(collection(db, 'comments'), 
                             where('articleId', '==', ARTICLE_ID));

             commentList.innerHTML = `<p class="loading-message" style="text-align: center; color: #777;">Loading comments...</p>`;


             onSnapshot(q, (snapshot) => {
                    commentList.innerHTML = ''; 
                    
                    if (snapshot.empty) {
                        commentList.innerHTML = `
                            <div class="no-comments">
                                <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                                <p>No comments yet. Be the first to share your thoughts! ðŸŒŸ</p>
                            </div>
                        `;
                        commentCountEl.textContent = '0';
                        return;
                    }

                    commentCountEl.textContent = snapshot.size;
                    
                    const sortedDocs = snapshot.docs.sort((a, b) => {
                        const timeA = a.data().timestamp;
                        const timeB = b.data().timestamp;
                        
                        const dateA = timeA && timeA.toDate ? timeA.toDate() : new Date(0); 
                        const dateB = timeB && timeB.toDate ? timeB.toDate() : new Date(0);
                        
                        return dateB - dateA; // Sort descending (newest first)
                    });

                    const comments = sortedDocs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderComments(comments); 

                }, error => {
                    console.error("Error loading comments:", error);
                    commentList.innerHTML = `<p class="loading-message" style="color: red;">Failed to load comments. (Check Firestore Security Rules)</p>`;
                });
        }
        
        // --- 4. Comment Submission & Actions ---

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser && !isGuestMode) {
                console.warn('User must sign in or choose to comment as a Guest!');
                return;
            }

            const commentText = commentTextInput.value.trim();

            if (!commentText) {
                console.warn('Comment text is empty.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';

            let commentData = {};

            if (isGuestMode) {
                const guestName = guestNameField.value.trim();
                if (!guestName) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Comment';
                    return;
                }
                commentData = {
                    articleId: ARTICLE_ID,
                    userId: 'guest', 
                    userName: guestName,
                    userEmail: '', 
                    text: commentText,
                    timestamp: serverTimestamp(), 
                    likes: [] 
                };
            } else {
                commentData = {
                    articleId: ARTICLE_ID,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    userEmail: currentUser.email,
                    text: commentText,
                    timestamp: serverTimestamp(), 
                    likes: [] 
                };
            }

            try {
                await addDoc(collection(db, 'comments'), commentData);

                commentTextInput.value = '';
                guestNameField.value = ''; 

                if (isGuestMode) {
                    isGuestMode = false; 
                    setAuthState(auth.currentUser); 
                }

            } catch (error) {
                console.error('Error posting comment:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Comment';
            }
        });

        async function toggleLike(commentId, button) {
             if (!currentUser || isGuestMode) return;
             
             const commentRef = doc(db, 'comments', commentId);
             const userId = currentUser.uid;
             
             try {
                 await runTransaction(db, async (transaction) => {
                     const docSnapshot = await transaction.get(commentRef);
                     if (!docSnapshot.exists()) {
                         throw "Comment does not exist!";
                     }
                     
                     const data = docSnapshot.data();
                     const likes = data.likes || [];
                     const isCurrentlyLiked = likes.includes(userId);
                     
                     if (isCurrentlyLiked) {
                         transaction.update(commentRef, {
                             likes: arrayRemove(userId)
                         });
                     } else {
                         transaction.update(commentRef, {
                             likes: arrayUnion(userId)
                         });
                     }
                 });
             } catch (error) {
                 console.error("Transaction failed:", error);
             }
        }
        
        // NEW: Handler for dynamically created reply forms submission
        async function handleReplySubmit(e) {
            e.preventDefault();
            if (!currentUser || isGuestMode) return;

            const form = e.target;
            const parentId = form.dataset.parentId;
            const textarea = form.querySelector('textarea');
            const replyText = textarea.value.trim();
            const submitButton = form.querySelector('.btn-primary');

            if (!replyText) return;

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
            
            const replyData = {
                articleId: ARTICLE_ID,
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                userEmail: currentUser.email,
                text: replyText,
                timestamp: serverTimestamp(),
                likes: [],
                parentId: parentId 
            };

            try {
                await addDoc(collection(db, 'comments'), replyData);
            } catch (error) {
                console.error('Error posting reply:', error);
            } finally {
                form.closest('.reply-form-container').remove(); 
                currentReplyToId = null;
            }
        }
        
        // NEW: Function to create the dynamic reply form HTML
        function createReplyFormHtml(parentId) {
            const formContainer = document.createElement('div');
            formContainer.className = 'reply-form-container'; 
            formContainer.innerHTML = `
                <h4 style="font-size: 1.2rem; margin-top: 0; margin-bottom: 0.5rem; color: var(--heading-color);">
                    Replying to a comment as <span style="color: var(--link-color);">${currentUser.displayName || currentUser.email.split('@')[0]}</span>
                </h4>
                <form class="reply-form" data-parent-id="${parentId}">
                    <textarea class="form-input" placeholder="Your reply (supports **bold**, _italics_)..." required></textarea>
                    <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-paper-plane"></i> Post Reply
                    </button>
                    <button type="button" class="btn-cancel-reply btn-primary" style="background: #555; background-image: none; margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Cancel
                    </button>
                </form>
            `;
            
            const form = formContainer.querySelector('.reply-form');
            const cancelBtn = formContainer.querySelector('.btn-cancel-reply');

            form.addEventListener('submit', handleReplySubmit);
            cancelBtn.addEventListener('click', () => {
                formContainer.remove();
                currentReplyToId = null;
            });

            return formContainer;
        }
        
        // NEW: Handler for reply button click
        function handleReplyButtonClick(e) {
            e.preventDefault();
            const replyBtn = e.currentTarget;
            const parentId = replyBtn.dataset.commentId;

            document.querySelectorAll('.reply-form-container').forEach(el => el.remove());
            
            if (currentReplyToId === parentId) {
                currentReplyToId = null;
                return;
            }

            const formEl = createReplyFormHtml(parentId);
            const commentContentDiv = replyBtn.closest('.comment-content');
            
            if (commentContentDiv) {
                commentContentDiv.appendChild(formEl);
                formEl.querySelector('textarea').focus();
                currentReplyToId = parentId;
            }
        }
        
        // NEW: Function to handle edit button click (shows a new form)
        function handleEditButtonClick(commentId, originalText) {
            document.querySelectorAll('.reply-form-container').forEach(el => el.remove());
            currentReplyToId = null; 

            const commentEl = document.querySelector(`.comment-content[data-comment-id="${commentId}"]`);
            if (!commentEl) return;
            
            const editContainer = document.createElement('div');
            editContainer.className = 'reply-form-container'; 
            editContainer.innerHTML = `
                <h4 style="font-size: 1.2rem; margin-top: 0; margin-bottom: 0.5rem; color: var(--heading-color);">
                    Editing Comment
                </h4>
                <form class="edit-form" data-comment-id="${commentId}">
                    <textarea class="form-input" required>${originalText}</textarea>
                    <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn-cancel-reply btn-primary" style="background: #555; background-image: none; margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Cancel
                    </button>
                </form>
            `;
            
            commentEl.appendChild(editContainer);
            editContainer.querySelector('textarea').focus();

            editContainer.querySelector('.edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newText = editContainer.querySelector('textarea').value.trim();
                const submitButton = e.target.querySelector('.btn-primary');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                await updateComment(commentId, newText);
                editContainer.remove();
            });

            editContainer.querySelector('.btn-cancel-reply').addEventListener('click', () => {
                editContainer.remove();
            });
        }
        
        // NEW: Firestore Update function (for editing)
        async function updateComment(commentId, newText) {
            if (!currentUser) return;
            const commentRef = doc(db, 'comments', commentId);
            
            try {
                await setDoc(commentRef, {
                    text: newText,
                    editedAt: serverTimestamp() 
                }, { merge: true });
            } catch (error) {
                console.error("Error updating comment:", error);
            }
        }

        // NEW: Firestore Delete function
        async function deleteComment(commentId) {
            // Confirm with the user before deletion
            if (!currentUser || !confirm("Are you sure you want to delete this comment? This action cannot be undone.")) return;
            
            const commentRef = doc(db, 'comments', commentId);
            try {
                await deleteDoc(commentRef);
            } catch (error) {
                console.error("Error deleting comment:", error);
            }
        }


        // --- 5. Utility Functions ---
        
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // UPDATED: Added _italics_ formatting
        function formatCommentText(text) {
            let safeText = escapeHtml(text);
            
            // Format links
            safeText = safeText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); 
            // Format bold: **text**
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            // Format italics: _text_
            safeText = safeText.replace(/_(.*?)_/g, '<i>$1</i>');
            // Format line breaks
            safeText = safeText.replace(/\n/g, '<br>');
            
            return safeText;
        }

        // --- 6. Initialization (Handled by onAuthStateChanged) ---
    </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>
