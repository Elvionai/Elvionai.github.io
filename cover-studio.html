<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elvion Cover Studio | Philadelphia AI</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Cinzel:wght@400;700&family=Playfair+Display:wght@400;700;900&family=Roboto:wght@300;400;900&family=Great+Vibes&family=Oswald:wght@400;700&family=Montserrat:wght@400;800&family=Merriweather:wght@400;900&family=Bebas+Neue&family=Dancing+Script:wght@400;700&family=Lato:wght@400;900&family=Anton&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #050510;
            --bg-panel: rgba(20, 20, 35, 0.7);
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #fd79a8;
            --text-main: #ffffff;
            --text-muted: #b2bec3;
            --border: rgba(255, 255, 255, 0.1);
            --glass: blur(15px);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(108, 92, 231, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(0, 206, 201, 0.15), transparent 25%);
        }

        /* --- COSMIC ANIMATIONS --- */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: 0;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.5); }
        }

        /* --- LAYOUT --- */
        .app-grid {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            height: 100vh;
            filter: blur(10px);
            transition: filter 0.5s ease;
            pointer-events: none;
        }

        .app-grid.active {
            filter: blur(0);
            pointer-events: all;
        }

        /* --- SIDEBARS --- */
        .sidebar {
            background: var(--bg-panel);
            backdrop-filter: var(--glass);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) transparent;
        }
        
        .sidebar-right {
            border-left: 1px solid var(--border);
            border-right: none;
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin: 10px 0 5px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        /* --- CONTROLS --- */
        input, select, textarea {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Roboto', sans-serif;
            transition: 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(108, 92, 231, 0.3);
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(45deg, var(--primary), #a29bfe);
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        button.secondary { background: rgba(255,255,255,0.1); border: 1px solid var(--border); }
        button.secondary:hover { background: rgba(255,255,255,0.2); }
        button.danger { background: linear-gradient(45deg, #ff7675, #d63031); }
        button.success { background: linear-gradient(45deg, #00b894, #00cec9); }

        /* --- CANVAS AREA --- */
        .canvas-wrapper {
            position: relative;
            background: rgba(10, 10, 20, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* Grid Pattern */
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .canvas-container {
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 1px solid var(--border);
        }

        /* --- AUTH MODAL --- */
        .auth-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 16, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(20px);
        }

        .auth-card {
            background: rgba(20, 20, 35, 0.9);
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--primary);
            box-shadow: 0 0 40px rgba(108, 92, 231, 0.2);
            width: 350px;
            text-align: center;
            animation: float 6s ease-in-out infinite;
        }

        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* --- WALLET --- */
        .wallet-panel {
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.2), rgba(0, 0, 0, 0));
            border: 1px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .credits { font-size: 28px; font-weight: 900; color: var(--secondary); font-family: 'Orbitron'; }

        /* --- CHARACTERS --- */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .char-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }
        .char-item:hover { border-color: var(--secondary); transform: scale(1.05); }
        .char-item img { width: 100%; height: 100%; object-fit: cover; }
        .char-del { position: absolute; top: 2px; right: 2px; background: red; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; opacity: 0; }
        .char-item:hover .char-del { opacity: 1; }

        /* --- 3D MOCKUP --- */
        #mockup-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .scene { width: 300px; height: 450px; perspective: 1500px; }
        .book { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .face { position: absolute; width: 300px; height: 450px; background-size: cover; background-color: #eee; }
        .front { transform: translateZ(25px); }
        .back { transform: rotateY(180deg) translateZ(25px); }
        .spine { width: 50px; height: 450px; transform: rotateY(-90deg) translateZ(25px); left: -25px; background: #333; }
        
        /* --- CHAT --- */
        .chat-box {
            height: 150px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            overflow-y: auto;
            padding: 10px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .msg-user { color: var(--secondary); margin-bottom: 4px; }
        .msg-bot { color: white; margin-bottom: 8px; }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--bg-panel);
            border-left: 4px solid var(--secondary);
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            transform: translateX(150%);
            transition: 0.3s;
            z-index: 3000;
        }
        .toast.show { transform: translateX(0); }

    </style>
</head>
<body>

<!-- BACKGROUND STARS -->
<div id="stars"></div>

<!-- AUTH -->
<div class="auth-overlay" id="auth-screen">
    <div class="auth-card">
        <div class="logo-text">ELVION STUDIO</div>
        <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">Otherworldly Design Platform</p>
        
        <button onclick="signIn('google')" style="background: white; color: #333; margin-bottom: 10px;">
            <i class="fab fa-google"></i> Continue with Google
        </button>
        <button onclick="signIn('twitter')" style="background: #1da1f2; color: white; margin-bottom: 20px;">
            <i class="fab fa-twitter"></i> Continue with Twitter
        </button>
        
        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;"></div>
        
        <input type="email" id="email" placeholder="Email Address" style="margin-bottom: 10px;">
        <input type="password" id="pass" placeholder="Password" style="margin-bottom: 10px;">
        <button onclick="signIn('email')" class="success">Enter Studio</button>
        <p id="auth-msg" style="color: #ff7675; font-size: 12px; margin-top: 10px;"></p>
    </div>
</div>

<!-- 3D MOCKUP -->
<div id="mockup-overlay">
    <h2 style="color:white; margin-bottom: 40px;">3D Visualization</h2>
    <div class="scene">
        <div class="book" id="book-3d">
            <div class="face front" id="face-front"></div>
            <div class="face spine" id="face-spine"></div>
            <div class="face back" id="face-back"></div>
        </div>
    </div>
    <div style="margin-top: 50px; display: flex; gap: 15px;">
        <button class="secondary" onclick="rotateBook('front')">Front</button>
        <button class="secondary" onclick="rotateBook('spine')">Spine</button>
        <button class="secondary" onclick="rotateBook('full')">Full Spread</button>
        <button class="danger" onclick="document.getElementById('mockup-overlay').style.display='none'">Close</button>
    </div>
</div>

<!-- MAIN APP -->
<div class="app-grid" id="app-interface">
    
    <!-- LEFT: GENERATION -->
    <div class="sidebar">
        <div class="wallet-panel">
            <div style="font-size: 10px; text-transform: uppercase; color: #ccc;">Wallet Balance</div>
            <div class="credits" id="credit-display">--</div>
            <button onclick="fundWallet()" class="secondary" style="margin-top:5px; font-size: 10px; padding: 6px;">
                <i class="fas fa-wallet"></i> Fund Wallet
            </button>
        </div>

        <h2>Create Cover</h2>
        <select id="gen-model">
            <option value="v6">Philadelphia V6 (High Detail)</option>
            <option value="photoreal">Philadelphia Photoreal</option>
            <option value="movie">Philadelphia Cinematic</option>
            <option value="illustration">Philadelphia Illustration</option>
            <option value="anime_core">Philadelphia Anime</option>
        </select>
        <textarea id="gen-prompt" rows="3" placeholder="Describe your cosmic vision..."></textarea>
        
        <div style="display:flex; gap: 5px;">
            <button class="secondary" onclick="askBobby()" title="Get Prompt Ideas"><i class="fas fa-magic"></i> AI Idea</button>
            <button onclick="generate('cover')" id="btn-cover"><i class="fas fa-paint-brush"></i> Generate (20c)</button>
        </div>
        <small id="cover-limit" style="text-align: center; color: #666; font-size: 10px;">Daily Limit: --/2</small>

        <h2>Persistent Characters</h2>
        <div class="char-grid" id="char-list"></div>
        <button class="secondary" onclick="generate('char')" id="btn-char"><i class="fas fa-user-plus"></i> New Character (10c)</button>

        <!-- Chat -->
        <div style="margin-top: auto;">
            <h2>Bobby Assistant</h2>
            <div class="chat-box" id="chat-out">
                <div class="msg-bot">Bobby: How can I help you design today?</div>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chat-in" placeholder="Ask Bobby...">
                <button onclick="sendChat()" style="width: 40px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- CENTER: CANVAS -->
    <div class="canvas-wrapper">
        <canvas id="c"></canvas>
    </div>

    <!-- RIGHT: TOOLS -->
    <div class="sidebar sidebar-right">
        <h2>Canvas Settings</h2>
        <select onchange="resizeCanvas(this.value)">
            <option value="front">Front Cover (600x900)</option>
            <option value="full">Full Wrap (1300x900)</option>
        </select>
        <button onclick="saveProject()"><i class="fas fa-save"></i> Save Project</button>
        <button class="danger" onclick="clearCanvas()"><i class="fas fa-trash"></i> Clear All</button>

        <h2>Text Tools</h2>
        <button onclick="addText()"><i class="fas fa-font"></i> Add Title</button>
        <select id="font-family" onchange="updateObj('fontFamily', this.value)">
            <option value="Cinzel">Cinzel (Fantasy)</option>
            <option value="Playfair Display">Playfair (Elegant)</option>
            <option value="Orbitron">Orbitron (Sci-Fi)</option>
            <option value="Roboto">Roboto (Clean)</option>
            <option value="Oswald">Oswald (Thriller)</option>
            <option value="Great Vibes">Script</option>
            <option value="Bebas Neue">Bebas Neue</option>
        </select>
        <div style="display: flex; gap: 5px;">
            <input type="color" onchange="updateObj('fill', this.value)" title="Color">
            <input type="color" onchange="updateObj('stroke', this.value)" title="Stroke">
        </div>
        <input type="range" min="10" max="200" value="60" oninput="updateObj('fontSize', parseInt(this.value))">

        <h2>Editing</h2>
        <button class="secondary" onclick="removeBG()"><i class="fas fa-eraser"></i> Remove BG</button>
        <button class="secondary" onclick="toggleBrush()"><i class="fas fa-paint-roller"></i> Brush/Erase</button>
        <div style="display: flex; gap: 5px;">
            <button class="secondary" onclick="moveLayer('up')">Up</button>
            <button class="secondary" onclick="moveLayer('down')">Down</button>
        </div>
        <button class="danger" onclick="deleteObj()"><i class="fas fa-times"></i> Delete Selected</button>

        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
            <button class="success" onclick="openMockup()"><i class="fas fa-cube"></i> 3D Preview</button>
            <button onclick="downloadCover()"><i class="fas fa-download"></i> Download</button>
        </div>
    </div>
</div>

<div id="toast" class="toast">Action Successful</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    const twitterProvider = new firebase.auth.TwitterAuthProvider();

    // --- GLOBALS ---
    const API_URL = "https://web-production-9a18.up.railway.app";
    const SUPER_ADMIN = "Koladhino@gmail.com";
    
    let currentUser = null;
    let token = null;
    let credits = 0;
    let canvas;
    let isBrush = false;

    // --- STARS ANIMATION ---
    function createStars() {
        const container = document.getElementById('stars');
        for(let i=0; i<50; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.width = Math.random() * 3 + 'px';
            star.style.height = star.style.width;
            star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
            container.appendChild(star);
        }
    }
    createStars();

    // --- AUTH ---
    auth.onAuthStateChanged(async (user) => {
        if(user) {
            currentUser = user;
            token = await user.getIdToken();
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-interface').classList.add('active');
            
            notify(`Welcome, ${user.displayName || user.email.split('@')[0]}`);
            await fetchBalance();
            loadProject();
            loadChars();
            checkDailyLimits();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-interface').classList.remove('active');
        }
    });

    async function signIn(method) {
        try {
            if(method === 'google') await auth.signInWithPopup(googleProvider);
            if(method === 'twitter') await auth.signInWithPopup(twitterProvider);
            if(method === 'email') {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                try {
                    await auth.signInWithEmailAndPassword(e, p);
                } catch(err) {
                    await auth.createUserWithEmailAndPassword(e, p); // Auto register
                }
            }
        } catch(e) {
            document.getElementById('auth-msg').innerText = e.message;
        }
    }

    // --- API HELPER ---
    async function api(endpoint, method = 'GET', body = null) {
        if(!currentUser) return null;
        // Refresh token to be safe
        token = await currentUser.getIdToken(true);
        
        const opts = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'X-Firebase-Token': token
            }
        };
        if(body) opts.body = JSON.stringify(body);

        try {
            const res = await fetch(`${API_URL}${endpoint}`, opts);
            if(!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || "API Error");
            }
            return await res.json();
        } catch(e) {
            console.error(e);
            notify(e.message, true);
            return null;
        }
    }

    // --- CANVAS ENGINE ---
    window.onload = () => {
        canvas = new fabric.Canvas('c', {
            width: 600, height: 900,
            backgroundColor: '#ffffff',
            preserveObjectStacking: true
        });
        
        canvas.on('object:modified', saveProject);
        canvas.on('object:added', saveProject);
    };

    function resizeCanvas(mode) {
        if(mode === 'full') {
            canvas.setWidth(1300);
            // Add Guides
            const l1 = new fabric.Line([600,0,600,900], {stroke:'cyan', strokeDashArray:[5,5], selectable:false});
            const l2 = new fabric.Line([700,0,700,900], {stroke:'cyan', strokeDashArray:[5,5], selectable:false});
            canvas.add(l1,l2);
        } else {
            canvas.setWidth(600);
        }
        canvas.renderAll();
    }

    function addText() {
        const t = new fabric.IText("Title", {
            left: 100, top: 100,
            fontFamily: 'Orbitron',
            fontSize: 60,
            fill: '#000000'
        });
        canvas.add(t);
        canvas.setActiveObject(t);
    }

    function updateObj(prop, val) {
        const o = canvas.getActiveObject();
        if(o) {
            o.set(prop, val);
            canvas.renderAll();
            saveProject();
        }
    }

    function deleteObj() {
        const o = canvas.getActiveObject();
        if(o) canvas.remove(o);
    }

    function moveLayer(dir) {
        const o = canvas.getActiveObject();
        if(!o) return;
        dir === 'up' ? canvas.bringForward(o) : canvas.sendBackwards(o);
    }

    function toggleBrush() {
        isBrush = !isBrush;
        canvas.isDrawingMode = isBrush;
        if(isBrush) {
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.width = 30;
            canvas.freeDrawingBrush.color = "white"; // "Eraser"
            notify("Brush/Eraser Active");
        } else {
            notify("Brush Inactive");
        }
    }

    // --- IMAGE GENERATION ---
    async function generate(type) {
        // 1. Check Limits
        const isAdmin = currentUser.email.toLowerCase() === SUPER_ADMIN.toLowerCase();
        const cost = type === 'cover' ? 20 : 10;
        const today = new Date().toDateString();
        const count = parseInt(localStorage.getItem(`count_${currentUser.uid}_${today}`) || 0);

        if(!isAdmin) {
            if(type === 'cover' && count >= 2) return notify("Daily limit reached!", true);
            if(credits < cost) return notify("Insufficient credits", true);
        }

        const prompt = document.getElementById('gen-prompt').value;
        const model = document.getElementById('gen-model').value;
        
        if(!prompt) return notify("Enter a prompt first", true);

        const btn = document.getElementById(type === 'cover' ? 'btn-cover' : 'btn-char');
        const oldText = btn.innerHTML;
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;
        btn.disabled = true;

        // 2. Call API (Fixing for bot.py payload)
        const payload = {
            prompt: type === 'char' ? `Character sheet, full body, white background, ${prompt}` : prompt,
            model: type === 'char' ? 'anime_core' : model,
            width: type === 'char' ? 512 : 600,
            height: type === 'char' ? 512 : 900,
            use_minimax: false // FORCE THENA/PHILADELPHIA
        };

        const res = await api('/generate-image', 'POST', payload);

        if(res && res.image_b64) {
            if(type === 'cover') {
                fabric.Image.fromURL('data:image/png;base64,'+res.image_b64, (img) => {
                    img.scaleToWidth(canvas.width);
                    canvas.add(img);
                    canvas.sendToBack(img);
                });
                if(!isAdmin) {
                    localStorage.setItem(`count_${currentUser.uid}_${today}`, count+1);
                    checkDailyLimits();
                }
            } else {
                saveChar(res.image_b64);
            }
            
            // Deduct local credit view (Backend handles real deduction if set up)
            if(!isAdmin) {
                credits -= cost;
                document.getElementById('credit-display').innerText = credits;
            }
            notify("Generation Complete");
        }

        btn.innerHTML = oldText;
        btn.disabled = false;
    }

    async function removeBG() {
        const obj = canvas.getActiveObject();
        if(!obj || obj.type !== 'image') return notify("Select image first", true);

        notify("Removing background...");
        const data = obj.toDataURL({format:'png'});
        const blob = await (await fetch(data)).blob();
        const fd = new FormData();
        fd.append('file', blob, 'img.png');

        // Note: remove-bg endpoint in bot.py might not use token auth depending on implementation
        // But we try standard fetch first
        const res = await fetch(`${API_URL}/api/tools/remove-background`, {
            method: 'POST',
            body: fd
        });

        if(res.ok) {
            const newBlob = await res.blob();
            const reader = new FileReader();
            reader.onload = (e) => {
                fabric.Image.fromURL(e.target.result, (img) => {
                    img.set({left:obj.left, top:obj.top, scaleX:obj.scaleX, scaleY:obj.scaleY});
                    canvas.remove(obj);
                    canvas.add(img);
                    canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(newBlob);
        } else {
            notify("BG Removal Failed", true);
        }
    }

    // --- PERSISTENCE ---
    function saveChar(b64) {
        const chars = JSON.parse(localStorage.getItem(`chars_${currentUser.uid}`) || "[]");
        chars.push(b64);
        localStorage.setItem(`chars_${currentUser.uid}`, JSON.stringify(chars));
        loadChars();
    }

    function loadChars() {
        const chars = JSON.parse(localStorage.getItem(`chars_${currentUser.uid}`) || "[]");
        const list = document.getElementById('char-list');
        list.innerHTML = "";
        chars.forEach((b64, i) => {
            const div = document.createElement('div');
            div.className = 'char-item';
            div.innerHTML = `
                <img src="data:image/png;base64,${b64}" onclick="addCharToCanvas('${b64}')">
                <div class="char-del" onclick="delChar(${i})">x</div>
            `;
            list.appendChild(div);
        });
    }

    function addCharToCanvas(b64) {
        fabric.Image.fromURL('data:image/png;base64,'+b64, (img) => {
            img.scaleToWidth(250);
            canvas.add(img);
        });
    }

    function delChar(i) {
        const chars = JSON.parse(localStorage.getItem(`chars_${currentUser.uid}`) || "[]");
        chars.splice(i,1);
        localStorage.setItem(`chars_${currentUser.uid}`, JSON.stringify(chars));
        loadChars();
    }

    function saveProject() {
        if(currentUser) localStorage.setItem(`proj_${currentUser.uid}`, JSON.stringify(canvas.toJSON()));
    }

    function loadProject() {
        const json = localStorage.getItem(`proj_${currentUser.uid}`);
        if(json) canvas.loadFromJSON(json);
    }

    function checkDailyLimits() {
        const today = new Date().toDateString();
        const count = localStorage.getItem(`count_${currentUser.uid}_${today}`) || 0;
        document.getElementById('cover-limit').innerText = 
            (currentUser.email.toLowerCase() === SUPER_ADMIN.toLowerCase()) ? "Unlimited (Admin)" : `Daily Limit: ${count}/2`;
    }

    // --- WALLET & PAYMENTS ---
    async function fetchBalance() {
        try {
            const res = await api('/api/user/keys-and-balance');
            credits = res.balance || 0;
            if(currentUser.email.toLowerCase() === SUPER_ADMIN.toLowerCase()) credits = 999999;
            document.getElementById('credit-display').innerText = credits.toLocaleString();
        } catch(e) {
            console.log("Balance fetch error, defaulting to local/0");
        }
    }

    async function fundWallet() {
        const amt = prompt("Amount to fund (NGN):", "1000");
        if(!amt || amt < 100) return;

        const res = await api('/api/payments/initiate', 'POST', {amount: parseInt(amt)});
        if(res && res.checkout_url) {
            const win = window.open(res.checkout_url);
            const check = setInterval(async () => {
                if(win.closed) {
                    clearInterval(check);
                    const verify = await api(`/api/payments/verify?transaction_ref=${res.transaction_ref}`);
                    if(verify && verify.status === 'success') {
                        credits = verify.new_balance;
                        document.getElementById('credit-display').innerText = credits;
                        notify("Payment Successful!");
                    }
                }
            }, 3000);
        }
    }

    // --- CHAT & AI HELP ---
    async function askBobby() {
        const txt = document.getElementById('gen-prompt').value;
        if(!txt) return notify("Type a basic idea first", true);
        
        const res = await api('/api/llama/chat', 'POST', {
            prompt: "Refine this book cover idea into a highly detailed stable diffusion prompt: " + txt,
            systemPrompt: "You are an expert art director."
        });
        
        if(res) {
            document.getElementById('gen-prompt').value = res.content || res.response;
        }
    }

    async function sendChat() {
        const inp = document.getElementById('chat-in');
        const box = document.getElementById('chat-out');
        const txt = inp.value;
        if(!txt) return;

        box.innerHTML += `<div class="msg-user">You: ${txt}</div>`;
        inp.value = "";
        
        const res = await api('/api/llama/chat', 'POST', {
            prompt: txt,
            systemPrompt: "You are Bobby, a helpful design assistant."
        });

        if(res) {
            box.innerHTML += `<div class="msg-bot">Bobby: ${res.content || res.response}</div>`;
            box.scrollTop = box.scrollHeight;
        }
    }

    // --- 3D & EXPORT ---
    function openMockup() {
        if(canvas.getObjects().length === 0) return notify("Canvas is empty", true);
        
        const img = canvas.toDataURL();
        const modal = document.getElementById('mockup-overlay');
        const front = document.getElementById('face-front');
        const spine = document.getElementById('face-spine');
        const back = document.getElementById('face-back');

        modal.style.display = 'flex';
        
        const isFull = canvas.width > 1000;

        if(isFull) {
            // Mapping for 1300px width (600+100+600)
            front.style.backgroundImage = `url(${img})`;
            front.style.backgroundPosition = "100% 0"; // Right side
            
            spine.style.backgroundImage = `url(${img})`;
            spine.style.backgroundPosition = "50% 0"; // Center
            
            back.style.backgroundImage = `url(${img})`;
            back.style.backgroundPosition = "0% 0"; // Left side
        } else {
            front.style.backgroundImage = `url(${img})`;
            spine.style.background = "#222";
            back.style.background = "#333";
        }
        
        rotateBook('front');
    }

    function rotateBook(view) {
        const b = document.getElementById('book-3d');
        if(view === 'front') b.style.transform = "rotateY(-25deg) rotateX(10deg)";
        if(view === 'spine') b.style.transform = "rotateY(-100deg) rotateX(0deg)";
        if(view === 'full') b.style.transform = "rotateY(-40deg) rotateX(20deg) scale(0.8)";
    }

    function downloadCover() {
        const a = document.createElement('a');
        a.download = `cover_${Date.now()}.png`;
        a.href = canvas.toDataURL({quality:1});
        a.click();
    }

    function clearCanvas() {
        if(confirm("Clear everything?")) canvas.clear();
    }

    function notify(msg, isError = false) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.borderLeftColor = isError ? "#ff7675" : "#00cec9";
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

</script>
</body>
</html>
