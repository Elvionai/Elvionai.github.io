<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Developer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;800&display=swap" rel="stylesheet">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #00ffff;
      --primary-dim: rgba(0, 255, 255, 0.1);
      --secondary: #ff00ff;
      --bg-dark: #050a14;
      --glass-bg: rgba(16, 24, 45, 0.75);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      --success: #00e676;
      --danger: #ff1744;
      --warning: #ffae42;
    }

    * { box-sizing: border-box; outline: none; }
    
    body { 
      margin: 0; 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg-dark); 
      color: var(--text-main); 
      min-height: 100vh; 
      overflow-x: hidden;
      background-image: radial-gradient(circle at 10% 20%, rgba(0, 255, 255, 0.05) 0%, transparent 20%),
                        radial-gradient(circle at 90% 80%, rgba(255, 0, 255, 0.05) 0%, transparent 20%);
    }

    /* Animated Background Stars */
    #stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--duration) linear infinite; opacity: 0; }
    @keyframes twinkle { 0% { opacity: 0; } 50% { opacity: 0.8; } 100% { opacity: 0; } }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* Header */
    header { display: flex; justify-content: space-between; align-items: center; padding: 25px 0; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand img { width: 45px; height: 45px; border-radius: 10px; box-shadow: 0 0 15px var(--primary-dim); }
    .brand h1 { font-family: 'Orbitron'; font-size: 1.4rem; margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; }
    .user-info { display: flex; align-items: center; gap: 20px; background: var(--glass-border); padding: 8px 16px; border-radius: 30px; }
    .user-email { font-size: 0.9rem; color: var(--text-muted); }
    .logout-btn { background: none; border: none; color: var(--danger); cursor: pointer; transition: 0.3s; font-size: 1rem; padding: 5px; }
    .logout-btn:hover { transform: scale(1.1); color: #ff5252; }

    /* Dashboard Grid */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }

    .card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 25px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); transition: transform 0.2s; }
    .card:hover { border-color: rgba(255, 255, 255, 0.15); }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 10px; }

    /* Metrics */
    .balance-wrapper { text-align: center; padding: 10px 0; }
    .balance-label { color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
    .balance-amount { font-family: 'Orbitron'; font-size: 3rem; font-weight: 700; color: white; margin: 5px 0 20px 0; text-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }
    
    /* Quick Actions */
    .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    /* Buttons */
    .btn { background: linear-gradient(135deg, var(--primary), #00cccc); color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-family: 'Inter'; cursor: pointer; transition: all 0.3s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; width: 100%; text-decoration: none; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 255, 255, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
    
    .btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid var(--glass-border); }
    .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--primary); color: var(--primary); }

    .btn-danger { background: rgba(255, 23, 68, 0.1); color: var(--danger); border: 1px solid rgba(255, 23, 68, 0.2); width: auto; padding: 6px 12px; font-size: 0.8rem; }
    .btn-danger:hover { background: var(--danger); color: white; }

    .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }

    /* Tables */
    .table-container { overflow-x: auto; max-height: 400px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; background: rgba(10, 14, 25, 0.95); z-index: 2; }
    td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: #e2e8f0; font-size: 0.9rem; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255, 255, 255, 0.02); }
    
    /* History Colors */
    .cost-negative { color: #ff80ab; font-weight: 600; font-family: 'Orbitron'; }
    .cost-positive { color: var(--success); font-weight: 600; font-family: 'Orbitron'; text-shadow: 0 0 10px rgba(0, 230, 118, 0.3); }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
    .badge-active { background: rgba(0, 230, 118, 0.15); color: var(--success); border: 1px solid rgba(0, 230, 118, 0.3); }
    .badge-revoked { background: rgba(255, 23, 68, 0.15); color: var(--danger); border: 1px solid rgba(255, 23, 68, 0.3); }

    /* Admin Panel */
    .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .admin-box { background: rgba(255, 174, 66, 0.05); padding: 20px; border-radius: 12px; border: 1px solid rgba(255, 174, 66, 0.2); }
    input { background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; padding: 12px; border-radius: 8px; width: 100%; margin-top: 10px; font-family: 'Inter'; transition: 0.3s; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-dim); }

    /* Toast Notification */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { pointer-events: auto; background: rgba(16, 24, 45, 0.95); border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; min-width: 300px; animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(10px); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.active { opacity: 1; }
    .modal { background: #0f1623; border: 1px solid var(--glass-border); padding: 35px; border-radius: 20px; width: 90%; max-width: 420px; position: relative; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    .modal-overlay.active .modal { transform: scale(1); }
    
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; transition: 0.2s; }
    .close-modal:hover { color: white; }
    
    .key-display { background: black; padding: 20px; border-radius: 12px; font-family: monospace; color: var(--success); word-break: break-all; margin: 20px 0; border: 1px dashed var(--glass-border); text-align: center; }
    
    /* Loader */
    .loader { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-bottom-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
    .btn-loading .loader { display: inline-block; }
    .btn-loading span { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) { 
      .dashboard-grid, .admin-controls { grid-template-columns: 1fr; } 
      header { flex-direction: column; text-align: center; gap: 15px; } 
      .brand h1 { font-size: 1.2rem; }
    }
  </style>
</head>
<body>

<div id="stars"></div>
<div id="toast-container"></div>

<div class="container">
  <!-- HEADER -->
  <header>
    <div class="brand">
      <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Logo">
      <div>
        <h1>Elvion AI</h1>
        <span style="font-size:0.75rem; color: var(--primary); letter-spacing: 2px; text-transform: uppercase;">Developer Console</span>
      </div>
    </div>
    <div class="user-info">
      <i class="fas fa-user-circle" style="color:var(--primary);"></i>
      <span class="user-email" id="user-email">Loading...</span>
      <button class="logout-btn" id="logout-btn" title="Sign Out"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <!-- DASHBOARD GRID -->
  <div class="dashboard-grid">
    
    <!-- Balance Card -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-wallet"></i> Wallet</h3>
        <button class="btn-sm btn-secondary" onclick="loadAllData()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <div class="balance-wrapper">
        <div class="balance-label">Available Balance</div>
        <div class="balance-amount"><span id="balance-display">---</span> <span style="font-size:1rem; color:var(--text-muted);">Cr</span></div>
      </div>
      <button class="btn" id="fund-wallet-btn">
        <i class="fas fa-bolt"></i> Fund Wallet
      </button>
    </div>

    <!-- Quick Actions Card -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-rocket"></i> Actions</h3>
      </div>
      <div class="action-grid">
        <button class="btn btn-secondary" id="transfer-open-btn">
          <i class="fas fa-paper-plane"></i> Transfer
        </button>
        <button class="btn btn-secondary" id="generate-key-btn">
          <span><i class="fas fa-key"></i> New Key</span>
          <div class="loader"></div>
        </button>
      </div>
      <p style="font-size:0.8rem; color:var(--text-muted); margin-top:15px; text-align:center;">
        <i class="fas fa-info-circle"></i> Key Generation costs <strong>100 Cr</strong>
      </p>
    </div>

    <!-- Stats Summary -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-chart-pie"></i> Stats</h3>
      </div>
      <div style="display:flex; justify-content: space-between; margin-top:10px;">
        <div>
          <div style="color:var(--text-muted); font-size:0.8rem;">Active Keys</div>
          <div style="font-family:'Orbitron'; font-size:1.5rem;" id="active-keys-display">0</div>
        </div>
        <div>
          <div style="color:var(--text-muted); font-size:0.8rem;">Total Calls</div>
          <div style="font-family:'Orbitron'; font-size:1.5rem;" id="total-calls-display">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- REAL-TIME HISTORY TABLE -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-list-alt"></i> Recent Activity</h3>
      <span style="font-size:0.8rem; color:var(--text-muted);">Real-time updates</span>
    </div>
    <div class="table-container">
      <table id="usage-table">
        <thead>
          <tr>
            <th>Activity / Service</th>
            <th style="text-align:right;">Amount</th>
            <th style="text-align:right;">Time (UTC)</th>
          </tr>
        </thead>
        <tbody id="usage-list">
          <tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted);">Loading activity...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- API KEYS TABLE -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-code"></i> API Credentials</h3>
    </div>
    <div class="table-container">
      <table>
        <thead><tr><th>Key ID</th><th>Status</th><th>Created</th><th style="text-align:right;">Manage</th></tr></thead>
        <tbody id="key-list"><tr><td colspan="4" style="text-align:center;">Loading keys...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- ADMIN PANEL (Hidden by default) -->
  <div class="card" id="admin-panel" style="display: none; border: 1px solid var(--warning);">
    <div class="card-header"><h3 class="card-title" style="color: var(--warning);"><i class="fas fa-user-shield"></i> Admin Control</h3></div>
    <div class="admin-controls">
      <div class="admin-box">
        <h4 style="color: var(--warning); margin:0 0 10px 0;">Developer Testing</h4>
        <p style="font-size:0.8rem; color:var(--text-muted);">Reset your own balance for testing.</p>
        <button class="btn" id="grant-self-btn" style="background: var(--warning); color:black; margin-top:10px;">
          <span>Set 100k Balance</span><div class="loader"></div>
        </button>
      </div>
      <div class="admin-box">
        <h4 style="color: var(--primary); margin:0 0 10px 0;">Grant Credits</h4>
        <input type="email" id="gift-email" placeholder="User Email">
        <input type="number" id="gift-amount" placeholder="Amount (Cr)">
        <button class="btn btn-secondary" id="gift-btn" style="margin-top: 10px; width:100%; border-color:var(--success); color:var(--success);">
          <span>Send Grant</span><div class="loader"></div>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Payment Modal -->
<div class="modal-overlay" id="payment-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('payment-modal')">&times;</button>
    <div style="text-align:center;">
      <i class="fas fa-wallet" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
      <h3>Fund Wallet</h3>
      <p style="color: var(--text-muted); margin-bottom:20px;">Secure payment via Korapay.<br>1 Credit = ₦1.</p>
    </div>
    
    <label style="color: var(--text-muted); font-size: 0.8rem; text-transform:uppercase; letter-spacing:1px;">Amount (NGN)</label>
    <input type="number" id="fund-amount" value="1000" min="100" style="font-size: 1.5rem; text-align: center; color:var(--primary); font-weight:700;">
    
    <button class="btn" id="proceed-pay-btn" style="width: 100%; margin-top:20px;">
      <span>Proceed to Checkout <i class="fas fa-chevron-right"></i></span><div class="loader"></div>
    </button>
  </div>
</div>

<!-- Transfer Modal -->
<div class="modal-overlay" id="transfer-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('transfer-modal')">&times;</button>
    <div style="text-align:center;">
      <i class="fas fa-paper-plane" style="font-size:3rem; color:var(--secondary); margin-bottom:15px;"></i>
      <h3>Transfer Credits</h3>
      <p style="color: var(--text-muted);">Send credits instantly to another user.</p>
    </div>
    
    <div style="margin: 20px 0;">
      <label style="color: white; font-size: 0.85rem;">Receiver Email</label>
      <input type="email" id="transfer-email" placeholder="developer@example.com">
      
      <label style="color: white; font-size: 0.85rem; margin-top: 15px; display:block;">Amount</label>
      <input type="number" id="transfer-amount" placeholder="e.g. 500">
    </div>

    <button class="btn" id="confirm-transfer-btn" style="width: 100%; background: linear-gradient(135deg, var(--secondary), #ff5e62);">
      <span>Send Credits</span><div class="loader"></div>
    </button>
  </div>
</div>

<!-- Success Key Modal -->
<div class="modal-overlay" id="key-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('key-modal')">&times;</button>
    <div style="text-align:center;">
      <i class="fas fa-check-circle" style="font-size:3rem; color:var(--success); margin-bottom:15px;"></i>
      <h3>API Key Created</h3>
      <p style="color: var(--text-muted);">Copy this key now. It will not be shown again.</p>
    </div>
    <div class="key-display" id="new-key-text"></div>
    <button class="btn btn-secondary" id="copy-key-btn" style="width: 100%;">
      <i class="fas fa-copy"></i> Copy to Clipboard
    </button>
  </div>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script type="module">
  // --- CONFIGURATION ---
  const BACKEND_URL = "https://web-production-9a18.up.railway.app"; 
  const ADMIN_EMAIL = "koladhino@gmail.com";
  
  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  let userToken = null;

  const dom = {
    balance: document.getElementById('balance-display'),
    activeKeys: document.getElementById('active-keys-display'),
    totalCalls: document.getElementById('total-calls-display'),
    usageList: document.getElementById('usage-list'),
    keyList: document.getElementById('key-list'),
    email: document.getElementById('user-email'),
    adminPanel: document.getElementById('admin-panel')
  };

  // --- INITIALIZATION ---
  onIdTokenChanged(auth, async (user) => {
    if (user) {
      userToken = await user.getIdToken(true);
      dom.email.textContent = user.email;
      
      // Admin Check
      if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
        dom.adminPanel.style.display = 'block';
      }
      
      // Initial Load
      await loadAllData();
      
      // Auto-Check for Payment Return
      await checkPaymentReturn();
      
      window.loadAllData = loadAllData; // Make accessible globally
    } else {
      window.location.href = 'developer-login.html';
    }
  });

  document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

  // --- API HELPER ---
  async function apiCall(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json', 'X-Firebase-Token': userToken };
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    
    try {
      const res = await fetch(`${BACKEND_URL}${endpoint}`, config);
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Request failed');
      return data;
    } catch (err) {
      if(err.message === 'Failed to fetch') {
        throw new Error('Could not connect to server.');
      }
      throw err;
    }
  }

  // --- CORE DATA LOADING ---
  async function loadAllData() {
    try {
      // 1. Get Balance & Keys
      const metrics = await apiCall('/api/user/keys-and-balance');
      dom.balance.textContent = (metrics.balance || 0).toLocaleString();
      
      const activeKeys = metrics.keys.filter(k => k.is_active).length;
      dom.activeKeys.textContent = activeKeys;
      
      renderKeys(metrics.keys);

      // 2. Get Activity History
      const history = await apiCall('/api/user/usage-history');
      renderUsage(history.logs);
      
      // Simple stat: total logs
      dom.totalCalls.textContent = history.logs ? history.logs.length.toLocaleString() : 0;

    } catch (e) {
      console.error(e);
      showToast('Sync failed: ' + e.message, 'error');
    }
  }

  // --- RENDERING ---
  function renderKeys(keys) {
    dom.keyList.innerHTML = '';
    if (!keys.length) return dom.keyList.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--text-muted);">No API keys generated yet.</td></tr>';
    
    keys.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
    
    keys.forEach(k => {
      const row = document.createElement('tr');
      const shortKey = `...${k.api_key.slice(-8)}`;
      row.innerHTML = `
        <td style="font-family:monospace; color:var(--primary); font-weight:bold;">${shortKey}</td>
        <td><span class="badge ${k.is_active ? 'badge-active' : 'badge-revoked'}">${k.is_active ? 'Active' : 'Revoked'}</span></td>
        <td style="color:var(--text-muted); font-size:0.85rem;">${new Date(k.created_at).toLocaleDateString()}</td>
        <td style="text-align:right;">
          ${k.is_active ? `<button class="btn-danger revoke-btn" data-key="${k.api_key}"><i class="fas fa-ban"></i> Revoke</button>` : '<span style="color:var(--text-muted);">-</span>'}
        </td>
      `;
      dom.keyList.appendChild(row);
    });
    
    document.querySelectorAll('.revoke-btn').forEach(btn => btn.addEventListener('click', () => revokeKey(btn.dataset.key)));
  }

  function renderUsage(logs) {
    dom.usageList.innerHTML = '';
    if (!logs || !logs.length) return dom.usageList.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted);">No recent activity found.</td></tr>';
    
    logs.forEach(l => {
      const row = document.createElement('tr');
      
      // LOGIC FOR ICONS & COLORS BASED ON TYPE
      let amountClass = 'cost-negative';
      let sign = '-';
      let icon = '<i class="fas fa-microchip" style="color:var(--primary); margin-right:8px;"></i>';
      let rowStyle = '';

      if (l.type === 'funding') {
        amountClass = 'cost-positive';
        sign = '+';
        icon = '<i class="fas fa-wallet" style="color:var(--success); margin-right:8px;"></i>';
        rowStyle = 'background: rgba(0, 230, 118, 0.05);';
      } else if (l.type === 'gift') {
        amountClass = 'cost-positive';
        sign = '+';
        icon = '<i class="fas fa-gift" style="color:#ffae42; margin-right:8px;"></i>';
        rowStyle = 'background: rgba(255, 174, 66, 0.05);';
      }

      row.innerHTML = `
        <td style="font-weight: 500; ${rowStyle}">${icon} ${l.endpoint || 'System Action'}</td>
        <td style="text-align:right; ${rowStyle}" class="${amountClass}">${sign} ${l.cost.toLocaleString()} Cr</td>
        <td style="text-align:right; color: var(--text-muted); font-size: 0.85rem; ${rowStyle}">${new Date(l.timestamp).toLocaleString()}</td>
      `;
      dom.usageList.appendChild(row);
    });
  }

  // --- ACTIONS ---

  // 1. Payment Verification (Auto-Run)
  async function checkPaymentReturn() {
    const params = new URLSearchParams(window.location.search);
    const ref = params.get('reference') || params.get('trxref');
    
    if (ref) {
      // Clean URL so refresh doesn't trigger again
      window.history.replaceState({}, document.title, window.location.pathname);
      
      showToast('Verifying transaction...', 'warning');
      try {
        const res = await apiCall(`/api/payments/verify?transaction_ref=${ref}`);
        if(res.status === 'success' || res.status === 'already_credited') {
          showToast(`Payment Confirmed! +${res.credits_added || 0} Cr`, 'success');
          await loadAllData();
        } else {
          showToast('Payment Pending or Failed', 'error');
        }
      } catch(e) {
        showToast('Verification Error: ' + e.message, 'error');
      }
    }
  }

  // 2. Fund Wallet
  const payBtn = document.getElementById('proceed-pay-btn');
  payBtn.addEventListener('click', async () => {
    const amount = parseInt(document.getElementById('fund-amount').value);
    if(!amount || amount < 100) return showToast('Minimum amount is ₦100', 'error');
    
    setLoading(payBtn, true);
    try {
      const res = await apiCall('/api/payments/initiate', 'POST', { amount });
      showToast('Redirecting to secure checkout...', 'success');
      setTimeout(() => window.location.href = res.checkout_url, 1000);
    } catch(e) { 
      showToast(e.message, 'error'); 
      setLoading(payBtn, false); 
    }
  });

  // 3. Transfer Credits
  const transferBtn = document.getElementById('confirm-transfer-btn');
  transferBtn.addEventListener('click', async () => {
    const email = document.getElementById('transfer-email').value;
    const amount = parseInt(document.getElementById('transfer-amount').value);
    
    if(!email || !amount || amount <= 0) return showToast('Please check email and amount', 'error');

    setLoading(transferBtn, true);
    try {
      const res = await apiCall('/api/user/transfer-credits', 'POST', { receiver_email: email, amount: amount });
      showToast(res.message, 'success');
      closeModal('transfer-modal');
      await loadAllData();
    } catch(e) {
      showToast(e.message, 'error');
    } finally {
      setLoading(transferBtn, false);
    }
  });

  // 4. Generate Key
  const genBtn = document.getElementById('generate-key-btn');
  genBtn.addEventListener('click', async () => {
    setLoading(genBtn, true);
    try {
      const res = await apiCall('/api/user/create-api-key', 'POST');
      document.getElementById('new-key-text').textContent = res.api_key;
      openModal('key-modal');
      await loadAllData();
      showToast('Key Generated (-100 Cr)', 'success');
    } catch (e) { 
      showToast(e.message, 'error'); 
    } finally { 
      setLoading(genBtn, false); 
    }
  });

  // 5. Revoke Key
  async function revokeKey(key) {
    if(!confirm("Are you sure? This will immediately stop any apps using this key.")) return;
    try { 
      await apiCall('/api/user/revoke-api-key', 'POST', { api_key: key }); 
      await loadAllData(); 
      showToast('Key Revoked', 'success'); 
    } catch (e) { 
      showToast(e.message, 'error'); 
    }
  }

  // 6. Admin Tools
  document.getElementById('grant-self-btn').addEventListener('click', async (e) => {
    setLoading(e.target.closest('button'), true);
    try { const res = await apiCall('/api/admin/grant-credits', 'POST'); await loadAllData(); showToast(res.message, 'success'); } 
    catch(err) { showToast(err.message, 'error'); }
    finally { setLoading(e.target.closest('button'), false); }
  });

  document.getElementById('gift-btn').addEventListener('click', async (e) => {
    const email = document.getElementById('gift-email').value;
    const amount = parseInt(document.getElementById('gift-amount').value);
    setLoading(e.target.closest('button'), true);
    try { 
      const res = await apiCall('/api/admin/gift-credits', 'POST', { target_email: email, amount }); 
      showToast(res.message, 'success'); 
      await loadAllData();
    } 
    catch(err) { showToast(err.message, 'error'); }
    finally { setLoading(e.target.closest('button'), false); }
  });

  // --- UI UTILITIES ---
  function showToast(msg, type='success') {
    const t = document.createElement('div');
    t.className = `toast`;
    t.style.borderLeft = `4px solid ${type === 'success' ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : 'var(--danger)')}`;
    const icon = type === 'success' ? 'check-circle' : (type === 'warning' ? 'hourglass-half' : 'exclamation-circle');
    
    t.innerHTML = `<i class="fas fa-${icon}" style="color:${type === 'success' ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : 'var(--danger)')}"></i><span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 4500);
  }

  function setLoading(btn, isLoading) { 
    btn.disabled = isLoading; 
    btn.classList.toggle('btn-loading', isLoading); 
  }
  
  // Modals
  window.openModal = (id) => {
    const el = document.getElementById(id);
    el.style.display = 'flex';
    // Small delay to allow display:flex to apply before adding opacity class for animation
    setTimeout(() => el.classList.add('active'), 10);
  };
  
  window.closeModal = (id) => {
    const el = document.getElementById(id);
    el.classList.remove('active');
    setTimeout(() => el.style.display = 'none', 300); // Wait for transition
  };

  document.getElementById('fund-wallet-btn').addEventListener('click', () => openModal('payment-modal'));
  document.getElementById('transfer-open-btn').addEventListener('click', () => openModal('transfer-modal'));
  
  document.getElementById('copy-key-btn').addEventListener('click', () => { 
    navigator.clipboard.writeText(document.getElementById('new-key-text').textContent); 
    showToast('Copied to clipboard', 'success');
    closeModal('key-modal'); 
  });

  // Background Stars
  const stars = document.getElementById('stars');
  for(let i=0; i<80; i++) {
    const s = document.createElement('div'); s.className = 'star';
    s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%';
    s.style.width = Math.random()*2+'px'; s.style.height = s.style.width;
    s.style.animationDuration = (Math.random()*3+2)+'s';
    s.style.animationDelay = (Math.random()*5)+'s';
    stars.appendChild(s);
  }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
