<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elvion AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Highlight.js (syntax highlighting) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // initialize once; we'll also call hljs.highlightElement on new blocks
      if (window.hljs) hljs.configure({ignoreUnescapedHTML: true});
    });
  </script>

  <style>
    :root {
      --cyan:#00ffff; --blue:#0090ff; --bg:#191a26; --card:#181e2e; --radius:18px; --text:#e0e0e0;
      --muted:#b3b3b3; --shadow:0 0 31px #00fff2a4;
    }

    html, body {
      width:100vw; height:100vh; margin:0; padding:0;
      font-family:'Roboto', 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: radial-gradient(circle, #23233a 66%, #0a1128 100%);
      color:var(--text);
    }
    body { display:flex; align-items:center; justify-content:center; overflow:hidden; }

    /* Stars */
    #stars-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;}
    .star{position:absolute;background:rgba(255,255,255,.7);border-radius:50%;opacity:0;animation:twinkle 4.9s infinite linear;}
    @keyframes twinkle{0%,100%{opacity:.13;}54%{opacity:.97;}}
     /* --- Copy/Share Inline Buttons --- */
.inline-copy-btn, .inline-share-btn {
  padding: 5px 11px 5px 11px;
  margin-top: 2px;
  background: linear-gradient(90deg, #00ffff, #0090ff);
  border: none;
  border-radius: 7px;
  color: #23233a;
  font-family: 'Inter', 'Orbitron', Arial, sans-serif;
  font-size: 0.99em;
  font-weight: bold;
  box-shadow: 0 1px 4px #00fff244;
  cursor: pointer;
  transition: background 0.18s;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.inline-copy-btn:hover, .inline-share-btn:hover {
  background: #0090ff;
  color: #fff;
}
/* Optional: keep inline buttons more compact inside messages */
.chat-message.ai .inline-copy-btn,
.chat-message.ai .inline-share-btn {
  font-size: 0.97em;
  padding: 5px 10px;
  margin-right: 4px;
  margin-left: 0;
}

    /* Card */
    .card-container {
      background:var(--card); border-radius:var(--radius); max-width:420px; width:98vw; min-width:270px;
      height:79vh; min-height:420px; max-height:98vh; display:flex; flex-direction:column; align-items:center;
      box-shadow:var(--shadow); transition:all .20s; position:relative; z-index:2;
    }
    .fullscreen {position:fixed !important; top:0; left:0; width:100vw; height:100vh; min-height:100dvh; max-width:none; max-height:none; padding:0; border-radius:0; z-index:10; box-shadow:none;}

    /* Header */
    .header-bar {width:99%; display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px 6px; flex-shrink:0;}
    .menu-btn, .fullscreen-btn {
      background:none; border:none; color:var(--cyan); cursor:pointer;
      padding:0 11px;
    }
    .menu-btn { font-size:2em; }
    .fullscreen-btn { font-size:1.19em; margin-left:11px; }
    .fullscreen-btn:hover,.menu-btn:hover{background:var(--cyan); color:#23233a; border-radius:12px;}

    .site-heading{
      font-family:'Orbitron', sans-serif; font-size:1.06em; font-weight:700; letter-spacing:.38px;
      background:linear-gradient(90deg,#00ffff,#fff,#0090ff); background-size:200% auto; -webkit-background-clip:text;
      -webkit-text-fill-color:transparent; animation:shine 4s linear infinite; text-shadow:0 0 13px #00ffff43;
    }
    @keyframes shine{to{background-position:200% center;}}

    .profile-greet{color:#aee; font-size:.97em; margin:.3em auto; text-align:center; max-width:70vw;}

    /* Switch bar */
    #chatSwitchBar{width:97%; display:flex; align-items:center; gap:4px; margin:0 auto 7px auto;}
    #chatSelector{padding:8px 7px; border-radius:10px; border:1.3px solid #00ffff; font-size:1em; background:var(--bg); color:var(--text);}
    #newChatBtn,.delChatBtn{
      padding:4px 9px 5px 10px; border-radius:13px; border:none; cursor:pointer;
      background:linear-gradient(95deg,#00ffff 69%,#0090ff 100%); font-family:'Orbitron'; font-size:.98em;
      color:#23233a; font-weight:600; box-shadow:0 0 11px #00fff2c7;
    }
    .delChatBtn{background:none; color:#ffd500a7;}
    .delChatBtn:hover{color:#ff3131; background:#23233a;}

    /* Chat */
    .chat-box{
      flex:1 1 auto; overflow-y:auto; max-height:66vh; width:95%; margin:0 auto 1px auto; border-radius:13px;
      padding:9px 7px 8px 9px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth;
    }
    .chat-message{display:flex; align-items:flex-end; gap:12px;}
    .chat-message.user{justify-content:flex-end;}
    .chat-message .msg{
      background:linear-gradient(90deg,#23233a 91%,#23233a 100%);
      color:#e0e0e0; padding:10px 14px; border-radius:13px 14px 7px 13px; max-width:77%;
      font-size:1.03em; line-height:1.45;
      word-wrap:break-word; white-space:pre-wrap;
    }
    .chat-message.user .msg{
      background:linear-gradient(90deg,#00ffff 49%,#0090ff 100%); color:#23233a; border-radius:13px 12px 13px 7px; font-weight:700;
    }
    .chat-message img,.chat-message video{max-width:115px; max-height:100px; border-radius:7px; background:#fff;}

    /* Rich text inside AI messages */
    .chat-message.ai .msg strong { font-weight:800; color:#e8faff; }
    .chat-message.ai .msg em { opacity:0.95; }
    .chat-message.ai .msg code:not(pre code) {
      background:#0f1426; border:1px solid #26324d; padding:.12em .35em; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.95em;
    }
    .chat-message.ai .msg pre {
      position:relative; background:#0b1224; border:1px solid #26324d; border-radius:12px; padding:12px 12px 14px 12px; overflow:auto;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    .chat-message.ai .msg pre code {
      display:block; font-size:.96em; line-height:1.4;
    }
    .copy-btn{
      position:absolute; top:8px; right:8px; border:none; border-radius:9px; padding:6px 9px; cursor:pointer;
      background:linear-gradient(90deg,#00ffff,#0090ff); color:#132; font-weight:800; font-size:.85em; box-shadow:0 2px 7px #00ffff33;
    }
    .copy-btn:hover{filter:brightness(1.05);}

    /* File preview */
    .file-preview{width:94%; margin:11px auto 0; border-radius:8px; overflow:hidden; background:rgba(35,35,58,.7); border:1px solid rgba(255,255,255,0.20);}
    .file-preview img,.file-preview video{max-width:96%; max-height:100px; display:block; margin:0 auto;}
    .file-preview .file-info{padding:7px; display:flex; align-items:center; font-size:.98em; color:var(--muted);}
    .file-preview .file-info i{margin-right:7px;}

    /* Input row w/ textarea */
    .chat-input-row{
      width:92%; display:flex; gap:7px; align-items:flex-end; background:#23233a; border-radius:9px; padding:8px 9px;
      border:1.1px solid #00ffff21; box-shadow:0 2px 9px #00fff215; margin:3px auto 7px auto;
    }
    .chat-input-row input[type="file"]{display:none;}
    .chat-input-row label{cursor:pointer; color:var(--cyan); font-size:1.15em; padding:0 5px;}
    .chat-input-row label:hover{color:var(--blue);}
    .chat-input-row textarea{
      flex:1; min-height:42px; max-height:168px; resize:none; padding:9px 10px; border-radius:8px;
      border:1.1px solid #23233a; background:#242b3f; color:#e0e0e0; font-size:1.02em; line-height:1.45;
      scrollbar-width:thin;
    }
    .chat-input-row textarea:focus{outline:none; border:1.15px solid var(--cyan);}
    .chat-input-row button{
      background:linear-gradient(90deg,#00ffff,#0090ff); color:#23233a; border:none; border-radius:8px; padding:9px 12px; font-size:1.05em;
      font-weight:800; cursor:pointer; box-shadow:0 2px 7px #00ffff33;
    }
    .chat-input-row button:hover{background:#0090ff; color:#fff;}

    .status-message{color:#ffd700; font-size:.94em; text-align:center; min-height:16px;}

    /* Side panels */
    .panel-bg{display:none; position:fixed; z-index:221; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.59);}
    .panel-bg.active{display:flex;}
    .side-panel{background:var(--card); width:99vw; max-width:320px; height:100vh; box-shadow:-2px 0 26px #00ffffcf; display:flex; flex-direction:column; transition:transform .17s; overflow-y:auto; transform:translateX(340px);}
    .side-panel.active{transform:translateX(0);}
    .panel-header{display:flex; flex-direction:column; align-items:center; padding:24px 0 10px;}
    .panel-header img{width:42px; height:42px; border-radius:55%; object-fit:cover;}
    .panel-header .username{font-weight:800; font-size:1em; color:var(--cyan);}
    .panel-header .email{font-size:.93em; color:var(--muted);}
    .edit-form{display:flex; flex-direction:column; gap:10px;}
    .edit-form label{color:#00ffff; font-size:.92em; margin-bottom:2px;}
    .edit-form input{border:none; border-bottom:2px solid #23233a; background:#181d2c; color:#eee; font-size:.98em; padding:7px 4px 7px 9px; margin-bottom:3px; border-radius:8px;}
    .edit-form input:focus{border-color:#00ffff;}
    .profile-photo-tip{color:#b3b3b3; font-size:.91em; margin-bottom:4px;}
    .panel-links{display:flex; flex-direction:column; gap:1px; margin-top:11px; align-items:flex-start;}
    .panel-links a{color:var(--text); text-decoration:none; font-weight:700; font-size:1.02em; padding:8px 15px 8px 13px; border-radius:0 11px 11px 0; transition:background .14s;}
    .panel-links a:hover{background:var(--cyan); color:#23233a;}

    /* Typing dots (inline bubble) */
    .typing-bubble { display:inline-flex; gap:6px; align-items:center; }
    .dot-anim{display:inline-block; width:10px; height:10px; margin-right:2px; background:#00ffff; border-radius:50%; animation:bounceDot .95s infinite;}
    .dot-anim:nth-child(2){animation-delay:.11s;}
    .dot-anim:nth-child(3){animation-delay:.2s;}
    @keyframes bounceDot{0%,100%{transform:translateY(0);}55%{transform:translateY(-7px);}}

    /* Responsive */
    @media(max-width:600px){
      .card-container{max-width:99vw; width:100vw; min-height:97vw; height:95vh;}
      .chat-input-row{width:99vw;}
      .chat-box{max-height:57vh;}
    }
    @media(max-width:400px){
      .card-container{max-width:100vw; width:100vw;}
      .chat-input-row{width:99vw;}
      .chat-box{font-size:.97em;}
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="card-container" id="mainContainer">
    <div class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <span class="site-heading" style="flex:1;text-align:center;">Philadelphia AI</span>
      <button class="fullscreen-btn" id="fullscreenBtn" aria-label="Toggle fullscreen"><i class="fa-solid fa-expand"></i></button>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </div>

    <div class="profile-greet" id="greetMsg">Welcome!</div>

    <div id="chatSwitchBar">
      <select id="chatSelector"></select>
      <button id="newChatBtn" title="New chat"><i class="fa-solid fa-plus"></i></button>
      <button class="delChatBtn" id="delChatBtn" title="Delete"><i class="fa-solid fa-trash"></i></button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <div id="filePreview" class="file-preview" style="display:none;"></div>

    <!-- CHAT INPUT -->
    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <label for="chatFile" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
      <input type="file" id="chatFile" accept="*">
      <textarea id="chatInput" placeholder="Type hereâ€¦ (Shift+Enter = new line)"></textarea>
      <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
      <button type="button" id="voiceInputBtn" title="Record voice"><i class="fa-solid fa-microphone"></i></button>
    </form>

    <div class="status-message" id="statusMsg"></div>
  </div>

  <!-- Profile Menu Modal -->
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 18px;">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Paste image link">
        <span class="profile-photo-tip">For photo, <a href="https://postimg.cc/" target="_blank" style="color:#00ffff;">upload at postimg.cc</a> and paste link here.</span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#19192a;color:#00ffff;">Logout</button>
    </nav>
  </div>

  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:85px;max-width:320px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;">
  <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
  <div id="ai-image-container"></div>
  <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
</div>

  <!-- Link Menu Modal -->
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
        <div class="username">Elvion AI</div>
      </div>
      <div class="panel-links">
        <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </nav>
  </div>
    <script type="module">
/* ---------- Stars ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const starsContainer = document.getElementById('stars-container');
  for(let i=0;i<34;i++){
    const s=document.createElement('div'); s.className='star';
    const z=Math.random()*2.1+1; s.style.width=z+'px'; s.style.height=z+'px';
    s.style.left=Math.random()*100+'%'; s.style.top=Math.random()*100+'%';
    s.style.animationDelay=(Math.random()*3.69)+'s';
    s.style.animationDuration=(2.2+Math.random()*1.1)+'s';
    starsContainer.appendChild(s);
  }
});

/* ---------- Fullscreen ---------- */
const mainContainer=document.getElementById('mainContainer');
const fullscreenBtn=document.getElementById('fullscreenBtn');
let isFull=false;
fullscreenBtn.onclick=function(){
  isFull=!isFull;
  if(isFull){
    mainContainer.classList.add('fullscreen');
    fullscreenBtn.innerHTML='<i class="fa-solid fa-compress"></i>';
  }else{
    mainContainer.classList.remove('fullscreen');
    fullscreenBtn.innerHTML='<i class="fa-solid fa-expand"></i>';
  }
};

/* ---------- Panels/Modals ---------- */
const profileMenuBg=document.getElementById('profileMenuBg'), profileMenu=document.getElementById('profileMenu');
const linkMenuBg=document.getElementById('linkMenuBg'), linkMenu=document.getElementById('linkMenu');
document.getElementById('openProfileMenu').onclick=()=>{profileMenuBg.classList.add('active'); setTimeout(()=>profileMenu.classList.add('active'),10);};
profileMenuBg.onclick=e=>{if(e.target===profileMenuBg){ profileMenu.classList.remove('active'); setTimeout(()=>profileMenuBg.classList.remove('active'),110); }};
document.getElementById('openLinksMenu').onclick=()=>{linkMenuBg.classList.add('active'); setTimeout(()=>linkMenu.classList.add('active'),10);};
linkMenuBg.onclick=e=>{if(e.target===linkMenuBg){ linkMenu.classList.remove('active'); setTimeout(()=>linkMenuBg.classList.remove('active'),110); }};
document.getElementById("logoutBtn").onclick=()=>window.location.href='signup-login.html';

/* ---------- Firebase Auth (profile only) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
let currentUser;

onAuthStateChanged(auth, user => {
  if (!user) window.location.href = "signup-login.html";
  else {
    currentUser = user;
    document.getElementById("greetMsg").textContent = "Welcome, " + (user.displayName || user.email.split('@')[0]) + "!";
    document.getElementById("profileMenuUser").textContent = user.displayName || "User";
    document.getElementById("profileMenuEmail").textContent = user.email;
    document.getElementById("edit-name").value = user.displayName || "";
    document.getElementById("edit-photo").value = user.photoURL || "";
    document.getElementById("profilePicPreview").src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
    renderChatSelector();
    renderChatBox(chats[currentChatIdx]?.history || []);
  }
});
document.getElementById("edit-photo").oninput = function () {
  document.getElementById("profilePicPreview").src = this.value || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
};
document.getElementById("profileForm").onsubmit = async function (e) {
  e.preventDefault(); if (!currentUser) return;
  const status=document.getElementById("profileStatusMsg"); status.textContent='';
  const name=document.getElementById("edit-name").value.trim();
  const photoURL=document.getElementById("edit-photo").value.trim();
  try {
    await updateProfile(currentUser, { displayName:name, photoURL });
    await auth.currentUser.reload();
    status.textContent = "Profile updated!";
    status.style.color = "#00ffff";
    setTimeout(()=>{profileMenu.classList.remove('active'); profileMenuBg.classList.remove('active');}, 650);
    document.getElementById("greetMsg").textContent = "Welcome, "+(auth.currentUser.displayName||auth.currentUser.email.split('@')[0])+"!";
  } catch (err) {
    status.textContent = err.message || "Update failed";
    status.style.color = "#ffd700";
  }
};

/* ---------- LocalStorage Chat Logic, Excluding Images ---------- */
let chats = JSON.parse(localStorage.getItem("elvion_chats")||"[]");
let currentChatIdx = chats.length-1 >= 0 ? chats.length-1 : 0;
const chatBox = document.getElementById("chatBox");

function saveChats(){
  // Remove base64 images before saving
  let sanitized = JSON.parse(JSON.stringify(chats));
  sanitized.forEach(chat=>{
    chat.history.forEach(msg=>{
      if(msg.text && msg.text.includes("data:image/png;base64,")){
        msg.text = "[image omitted]";
      }
    });
  });
  localStorage.setItem("elvion_chats", JSON.stringify(sanitized));
}
function renderChatSelector() {
  const chatSelector = document.getElementById("chatSelector"); chatSelector.innerHTML="";
  chats.forEach((chat,idx)=>{
    const option=document.createElement("option");
    option.value=idx;
    option.textContent=chat.name||(chat.history?.[0]?.text?.slice(0,25)||"Untitled");
    chatSelector.appendChild(option);
  }); 
  chatSelector.value=currentChatIdx;
}
document.getElementById("chatSelector").onchange = function(){currentChatIdx=parseInt(this.value)||0; renderChatBox(chats[currentChatIdx]?.history || []);}
function loadChat(idx){currentChatIdx=idx||0; renderChatBox(chats[idx]?.history || []);}

/* ---------- Markdown, Code, Copy, Share ---------- */
const escapeHTML = (str = '') => 
  str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');


      function renderMarkdown(text = '') {
  const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
  let html = '';
  let lastIndex = 0;
  text = text || '';

  text.replace(codeBlockRegex, (match, lang, code, offset) => {
    // Add the text before this code block
    const before = text.slice(lastIndex, offset);
    html += inlineMarkdown(before);

    // Handle code block
    const language = (lang || '').toLowerCase().trim();
    const safe = escapeHTML(code);
    const blockId = 'code_' + Math.random().toString(36).slice(2);

    html += `<pre data-block-id="${blockId}">
      <button class="copy-btn" data-copy="${blockId}">Copy</button>
      <code class="language-${language || 'plaintext'}">${safe}</code>
    </pre>`;

    lastIndex = offset + match.length;
    return match;
  });

  // Add any remaining text after the last code block
  html += inlineMarkdown(text.slice(lastIndex));

  return { html };
      }
function inlineMarkdown(t=''){
  let s = t.replace(/`([^`]+?)`/g, (_,a)=>`<code>${escapeHTML(a)}</code>`);
  s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
  s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  return s.replace(/\n/g, '<br>');
}
function enhanceCodeBlocks(container){
  // add code highlighting and copy for code blocks only
  container.querySelectorAll('pre').forEach(pre=>{
    const codeEl = pre.querySelector('code');
    if (window.hljs && codeEl) hljs.highlightElement(codeEl);
    const btn = pre.querySelector('.copy-btn');
    if(btn && codeEl){
      btn.addEventListener('click', async ()=>{
        try{
          await navigator.clipboard.writeText(codeEl.innerText);
          const prev = btn.textContent;
          btn.textContent='Copied!';
          setTimeout(()=>btn.textContent=prev,800);
        }catch(e){ btn.textContent='Failed'; setTimeout(()=>btn.textContent='Copy',800); }
      });
    }
  });
}

/* ---------- Chat Rendering with Copy/Share ---------- */
function renderChatBox(messages){
  chatBox.innerHTML="";
  (messages||[]).forEach((msg, mi)=>{
    const div=document.createElement('div');
    div.className="chat-message "+(msg.role==="user"?"user":"ai");
    if(msg.text && /^(\[File\]|image:)/.test(msg.text)){
      div.innerHTML = msg.text.replace('image:','');
    } else if(msg.role === "ai") {
      const {html} = renderMarkdown(msg.text||'');
      div.innerHTML = `<div class="msg">${html}
        <div style="display:flex;justify-content:end;gap:8px;margin-top:4px;">
          <button class="inline-copy-btn" title="Copy whole AI response" data-idx="ai-${mi}">â–¡ Copy</button>
          <button class="inline-share-btn" title="Share this reply" data-idx="ai-${mi}"><i class="fa-solid fa-share"></i> Share</button>
        </div></div>`;
    } else {
      div.innerHTML = `<div class="msg">${escapeHTML(msg.text||'')}</div>`;
    }
    chatBox.appendChild(div);
  });
  enhanceCodeBlocks(chatBox);

  // Copy/share handlers:
  chatBox.querySelectorAll('.inline-copy-btn').forEach(btn=>{
    btn.onclick = function(){
      const idx = parseInt(btn.getAttribute('data-idx').replace('ai-',''));
      const text = (chats[currentChatIdx]?.history[idx]?.text)||"";
      navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, "")); // strip HTML
      btn.textContent = "Copied!";
      setTimeout(()=>btn.textContent="â–¡ Copy", 900);
    }
  });
  chatBox.querySelectorAll('.inline-share-btn').forEach(btn=>{
    btn.onclick = async function(){
      const idx = parseInt(btn.getAttribute('data-idx').replace('ai-',''));
      const text = (chats[currentChatIdx]?.history[idx]?.text)||"";
      if(navigator.share){
        await navigator.share({ title:"Philadelphia AI", text });
      }else{
        prompt("Copy and share:", text.replace(/<\/?[^>]+(>|$)/g, ""));
      }
    }
  });

  chatBox.scrollTop = chatBox.scrollHeight;
}

/* ---------- Typing Dots/Animations ---------- */
let typingNode = null;
function showTypingAtNext(){
  removeTyping();
  typingNode = document.createElement('div');
  typingNode.className = 'chat-message ai';
  typingNode.innerHTML = `<div class="msg"><span class="typing-bubble">
    <span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span>
  </span></div>`;
  chatBox.appendChild(typingNode);
  chatBox.scrollTop = chatBox.scrollHeight;
}
function removeTyping(){
  if(typingNode && typingNode.parentNode){
    typingNode.parentNode.removeChild(typingNode);
    typingNode = null;
  }
}
async function typeBotMessage(text, onDone){
  removeTyping();
  const div = document.createElement('div');
  div.className = "chat-message ai";
  const msgdiv = document.createElement('div');
  msgdiv.className = "msg";
  div.appendChild(msgdiv);
  chatBox.appendChild(div);
  let sofar = '';
  // Animate as plain text to avoid partial markdown weirdness
  for(const ch of text) {
    sofar += ch;
    msgdiv.innerHTML = renderMarkdown(sofar).html;
    chatBox.scrollTop = chatBox.scrollHeight;
    await new Promise(res=>setTimeout(res, 6+Math.random()*18));
  }
  // Render final markdown, add buttons
  msgdiv.innerHTML = renderMarkdown(text).html
    + `<div style="display:flex;justify-content:end;gap:8px;margin-top:4px;">
       <button class="inline-copy-btn" title="Copy whole AI response">â–¡ Copy</button>
       <button class="inline-share-btn" title="Share this reply"><i class="fa-solid fa-share"></i> Share</button>
      </div>`;
  enhanceCodeBlocks(msgdiv);
  // add copy/share handlers just to this message
  msgdiv.querySelector('.inline-copy-btn').onclick = () => {
    navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g,""));
    msgdiv.querySelector('.inline-copy-btn').textContent = "Copied!";
    setTimeout(()=>msgdiv.querySelector('.inline-copy-btn').textContent="â–¡ Copy",900);
  };
  msgdiv.querySelector('.inline-share-btn').onclick = async () => {
    if(navigator.share){
      await navigator.share({ title:"Philadelphia AI", text });
    }else{
      prompt("Copy and share:", text.replace(/<\/?[^>]+(>|$)/g,""));
    }
  };
  if(onDone) onDone();
}

/* ---------- New/Delete Chat ---------- */
document.getElementById("newChatBtn").onclick=function(){
  const name="Chat "+(chats.length+1);
  chats.push({name,history:[]});
  currentChatIdx=chats.length-1;
  saveChats(); renderChatSelector(); loadChat(currentChatIdx);
};
document.getElementById("delChatBtn").onclick=function(){
  if(!chats.length)return;
  if(!confirm("Delete this chat?"))return;
  chats.splice(currentChatIdx,1);
  if(currentChatIdx>=chats.length)currentChatIdx=chats.length-1;
  saveChats(); renderChatSelector(); loadChat(currentChatIdx);
};

/* ---------- File Preview (images not saved) ---------- */
let uploadData=null;
document.getElementById("chatFile").onchange = function(){
  const file=this.files[0],fp=document.getElementById("filePreview");
  uploadData=null; if(!file){fp.style.display="none";fp.innerHTML="";return;}
  fp.style.display='block'; uploadData=file;
  if(file.type.startsWith("image/")){
    const reader=new FileReader();
    reader.onload=e=>{fp.innerHTML=`<img src="${e.target.result}" alt="Selected image">`;};
    reader.readAsDataURL(file);
  }else if(file.type.startsWith("video/")){
    const reader=new FileReader();
    reader.onload=e=>{fp.innerHTML=`<video src="${e.target.result}" controls></video>`;};
    reader.readAsDataURL(file);
  }else{
    fp.innerHTML=`<div class="file-info"><i class="fa-solid fa-file"></i> ${file.name}</div>`;
  }
};

/* ---------- Voice Input ---------- */
let recognition;
document.getElementById("voiceInputBtn").onclick=function(){
  if('webkitSpeechRecognition'in window){
    recognition=new webkitSpeechRecognition();
    recognition.continuous=false; recognition.interimResults=false; recognition.lang='en-US';
    this.innerHTML='<i class="fa-solid fa-microphone-lines"></i>';
    recognition.onresult=(e)=>{
      chatInput.value += (chatInput.value ? ' ' : '') + e.results[0][0].transcript;
      autoResizeTextarea();
      document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone"></i>';
    };
    recognition.onend=()=>{document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone"></i>';};
    recognition.onerror=()=>{document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone"></i>';};
    recognition.start();
  }else{
    alert("Speech recognition not supported in your browser.");
  }
};

/* ---------- Textarea auto-resize ---------- */
const chatInput = document.getElementById('chatInput');
function autoResizeTextarea(){
  chatInput.style.height = 'auto';
  chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px';
}
chatInput.addEventListener('input', autoResizeTextarea);
autoResizeTextarea();
chatInput.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
    e.preventDefault();
    document.getElementById('sendBtn').click();
  }
});

/* ---------- IMAGE BUTTON (model cycling, no save) ---------- */
const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
let currentModelIdx = 0;
let imageBtn = document.createElement("button");
imageBtn.type = "button";
imageBtn.id = "imageBtn";
imageBtn.title = "Generate image";
imageBtn.innerHTML = '<i class="fa-solid fa-image"></i>';
document.getElementById("chatForm").insertBefore(imageBtn, document.getElementById("sendBtn"));
imageBtn.onclick = function () {
  currentModelIdx = (currentModelIdx + 1) % thenaModels.length;
  let model = thenaModels[currentModelIdx];
  let prevInput = chatInput.value.replace(/^\/image\s+\w+\s*/i, "");
  chatInput.value = `/image ${model} ${prevInput}`.trim();
  chatInput.focus();
  setTimeout(() => {
    chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
  }, 0);
};
document.addEventListener('DOMContentLoaded', () => {
  currentModelIdx = 0;
  if (chatInput) {
    chatInput.value = "/image photoreal ";
    chatInput.focus();
    chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length);
  }
});

/* ---------- Chat Submit ---------- */
document.getElementById("chatForm").onsubmit = async function(e){
  e.preventDefault();
  let file = uploadData, fp = document.getElementById("filePreview");
  let msgText = chatInput.value.trim();

  if (currentChatIdx < 0) { chats.push({ name: "Chat 1", history: [] }); currentChatIdx = 0; }
  if (!msgText && !file) return;
  // Clear box right away
  chatInput.value = ""; autoResizeTextarea();

  // File upload (image not saved to storage!)
  if (file) {
    showTypingAtNext();
    try {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("message", msgText);
      formData.append("user_id", "user");
      const res = await fetch("https://web-production-9a18.up.railway.app/upload-file",{method:"POST",body:formData});
      let data;
      try{ data = await res.json(); }catch(_){ data = {response:"ðŸ¤– File received."}; }
      let isImg = /^image\//.test(file.type);
      let isVid = /^video\//.test(file.type);
      let bubble = isImg ? `<img src='${URL.createObjectURL(file)}' alt="Uploaded image">`
        : isVid ? `<video src='${URL.createObjectURL(file)}' controls></video>`
        : `<div class="msg">[File] ${escapeHTML(msgText||file.name)}</div>`;
      chats[currentChatIdx].history.push({role:"user",text:"image:"+bubble});
      removeTyping();
      chats[currentChatIdx].history.push({role:"ai",text:data.response||"ðŸ¤– Bot file reply."});
    }catch(err){
      removeTyping();
      chats[currentChatIdx].history.push({role:"ai",text:"[File upload failed] "+(err.message||'no net')});
    }
    document.getElementById("chatFile").value=""; fp.style.display="none"; fp.innerHTML=""; uploadData=null;
    saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
    return;
  }

  // Text message handling (AI markdown always correct NOW)
  chats[currentChatIdx].history.push({role:"user",text:msgText});
  if (chats[currentChatIdx].history.length === 1) {
    chats[currentChatIdx].name = msgText.slice(0, 25) + "..."; renderChatSelector();
  }
  renderChatBox(chats[currentChatIdx]?.history || []);
  showTypingAtNext();

  try {
    let res, data, botText;
    if(/^\/image\s+/i.test(msgText)){
  let imagePrompt = msgText.replace(/^\/image\s+/i, '');
  res = await fetch("https://web-production-9a18.up.railway.app/generate-image", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify(imagePrompt)
  });
  try { data = await res.json(); } catch(_) { data = {}; }
  removeTyping();
  if(data.image_b64){
    showAIImagePreview(data.image_b64, "(Your imageâ€”download or close)");
    chats[currentChatIdx].history.push({
      role: "ai",
      text: "âœ… Image generated! (Use the floating preview box below to view or download. This image is NOT stored in chat history.)"
    });
  } else {
    chats[currentChatIdx].history.push({ role: "ai", text: data.error || "âŒ Image generation failed. Try another prompt." });
  }
  saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
    } else {
      const history = chats[currentChatIdx].history.map(m=>({role:m.role,content:m.text}));
      res = await fetch("https://web-production-9a18.up.railway.app/chat", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msgText, user_id: currentUser?.uid || "user", history })
      });
      try { data = await res.json(); } catch(_) { data = {}; }
      removeTyping();
      if (data.response) {
        await typeBotMessage(data.response);
        chats[currentChatIdx].history.push({ role: "ai", text: data.response });
      } else {
        await typeBotMessage("ðŸ¤– Bot replied (no response).");
        chats[currentChatIdx].history.push({ role: "ai", text: "ðŸ¤– Bot replied (no response)." });
      }
      saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
    }
  } catch (err) {
    removeTyping();
    await typeBotMessage("Sorry, bot error: " + err.message);
    chats[currentChatIdx].history.push({role:"ai",text:"Sorry, bot error: "+err.message});
    saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
  }
};
</script>
<script>
  // Find nodes
const aiPrevBox = document.getElementById('ai-image-preview');
const aiPrevClose = document.getElementById('ai-image-close');
const aiPrevDLBtn = document.getElementById('ai-image-dl');
const aiPrevImgBox = document.getElementById('ai-image-container');

// Close preview
aiPrevClose.onclick = ()=>{ aiPrevBox.style.display="none"; aiPrevImgBox.innerHTML=""; };

// Download handler
aiPrevDLBtn.onclick = ()=>{
  const img = aiPrevImgBox.querySelector('img');
  if(img){
    const url = img.src;
    const a = document.createElement('a');
    a.href = url;
    a.download = 'generated_image.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
};

function showAIImagePreview(b64,caption=""){
  aiPrevImgBox.innerHTML = `<img src="data:image/png;base64,${b64}" alt="AI gen" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;">`
    +(caption?' <div style="color:#aee;font-size:.95em;margin-top:3px;text-align:center;">'+caption+'</div>':"");
  aiPrevBox.style.display = "block";
}
</script>
</body>
</html>
