<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Developer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --bg: #030712;
      --card-bg: #111827;
      --border: #1f2937;
      --primary: #3b82f6;
      --primary-glow: rgba(59, 130, 246, 0.5);
      --accent: #8b5cf6;
      --text: #f3f4f6;
      --text-muted: #9ca3af;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text); min-height: 100vh; }

    /* Layout */
    .dashboard { display: grid; grid-template-columns: 250px 1fr; min-height: 100vh; }
    .sidebar { background: var(--card-bg); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
    .main-content { padding: 30px; overflow-y: auto; }

    /* Sidebar */
    .brand { font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
    .brand span { background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500; }
    .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
    .nav-item i { width: 20px; }

    .user-mini { margin-top: auto; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--border); }
    .user-mini small { display: block; color: var(--text-muted); font-size: 0.75rem; }
    .logout-link { color: var(--danger); font-size: 0.8rem; margin-top: 5px; cursor: pointer; display: inline-block; }

    /* Cards */
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 25px; position: relative; overflow: hidden; }
    
    /* Balance Card */
    .balance-card { background: linear-gradient(145deg, #1e3a8a, #111827); border: 1px solid #3b82f6; }
    .balance-val { font-family: 'Space Grotesk'; font-size: 2.5rem; font-weight: 700; color: white; margin: 10px 0; }
    
    .btn { padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 0 20px var(--primary-glow); }
    .btn-secondary { background: rgba(255,255,255,0.1); color: white; }
    .btn-secondary:hover { background: rgba(255,255,255,0.2); }
    
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    /* Tables & Activity */
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 10px; }
    .section-title { font-family: 'Space Grotesk'; font-size: 1.25rem; font-weight: 700; }

    .activity-feed { display: flex; flex-direction: column; gap: 10px; }
    .activity-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid var(--border); transition: 0.2s; }
    .activity-item:hover { background: rgba(255,255,255,0.04); }
    
    .act-left { display: flex; align-items: center; gap: 15px; }
    .act-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
    .icon-payment { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    .icon-usage { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .icon-key { background: rgba(59, 130, 246, 0.2); color: var(--primary); }
    
    .act-details h4 { margin: 0; font-size: 0.95rem; font-weight: 600; }
    .act-details p { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-muted); }
    
    .act-amount { font-family: 'Space Grotesk'; font-weight: 700; font-size: 1rem; }
    .positive { color: var(--success); }
    .negative { color: var(--danger); }

    /* API Key Table */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { text-align: left; padding: 12px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
    .key-blur { filter: blur(4px); transition: 0.2s; cursor: pointer; font-family: monospace; }
    .key-blur:hover { filter: blur(0); }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
    .badge-active { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-inactive { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal { background: #111827; border: 1px solid var(--border); padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; position: relative; animation: popIn 0.3s; }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal h3 { margin-top: 0; font-family: 'Space Grotesk'; }
    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
    
    input { width: 100%; background: #030712; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; margin-top: 8px; margin-bottom: 15px; font-size: 1rem; }
    input:focus { border-color: var(--primary); }

    /* Toast */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: #1f2937; border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s; min-width: 300px; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    /* Mobile */
    @media (max-width: 768px) {
      .dashboard { grid-template-columns: 1fr; }
      .sidebar { display: none; /* Add toggle logic if needed */ }
      .main-content { padding: 20px; }
    }
  </style>
</head>
<body>

<div class="toast-container" id="toast-container"></div>

<div class="dashboard">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="brand">
      <i class="fas fa-cube" style="color:var(--primary)"></i> Elvion<span>AI</span>
    </div>
    <div class="nav-item active">
      <i class="fas fa-chart-line"></i> Dashboard
    </div>
    <!-- Add documentation link if needed -->
    <a href="https://documenter.getpostman.com/view/YOUR_DOCS" target="_blank" style="text-decoration:none;">
        <div class="nav-item">
        <i class="fas fa-book"></i> API Docs
        </div>
    </a>
    
    <div class="user-mini">
      <div style="font-weight:600;" id="user-name">Developer</div>
      <small id="user-email-display">Loading...</small>
      <span class="logout-link" id="logout-btn">Sign Out</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Admin Section (Hidden by default) -->
    <div id="admin-banner" style="display:none; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: var(--warning);">
      <strong><i class="fas fa-shield-alt"></i> Admin Controls:</strong> 
      <button class="btn btn-sm btn-secondary" onclick="triggerAdminGrant()" style="margin-left:10px;">Self-Grant 100k</button>
      <button class="btn btn-sm btn-secondary" onclick="openModal('admin-gift-modal')" style="margin-left:5px;">Gift User</button>
    </div>

    <!-- Stats Grid -->
    <div class="grid-3">
      <!-- Balance -->
      <div class="card balance-card">
        <div style="color:rgba(255,255,255,0.7); font-size:0.9rem;">Available Balance</div>
        <div class="balance-val" id="balance-display">...</div>
        <div style="display:flex; gap: 10px;">
          <button class="btn btn-secondary btn-sm" onclick="openModal('payment-modal')">
            <i class="fas fa-plus"></i> Add Funds
          </button>
          <button class="btn btn-secondary btn-sm" onclick="openModal('transfer-modal')">
            <i class="fas fa-paper-plane"></i> Transfer
          </button>
        </div>
      </div>

      <!-- Keys -->
      <div class="card">
        <div class="section-title" style="margin-bottom:10px;">API Keys</div>
        <div style="font-size: 2rem; font-weight:700;" id="active-key-count">0</div>
        <small style="color:var(--text-muted);">Active keys in usage</small>
        <button class="btn btn-primary btn-sm" style="margin-top:15px; width:100%;" onclick="generateKey()">
          <i class="fas fa-plus"></i> Create New Key (100 Cr)
        </button>
      </div>

      <!-- Quick Info -->
      <div class="card">
        <div class="section-title" style="margin-bottom:10px;">Usage Stats</div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
          <span style="color:var(--text-muted);">Last 24h</span>
          <span style="color:var(--success);">Active</span>
        </div>
        <div style="background:rgba(255,255,255,0.05); height:8px; border-radius:4px; overflow:hidden;">
            <div style="width: 70%; height:100%; background:var(--primary);"></div>
        </div>
        <small style="color:var(--text-muted); display:block; margin-top:10px;">System operational</small>
      </div>
    </div>

    <!-- Main Section: Activity & Keys -->
    <div class="grid-3" style="grid-template-columns: 2fr 1fr;">
      
      <!-- Activity Feed -->
      <div class="card">
        <div class="section-header">
            <div class="section-title">Activity History</div>
            <button class="btn btn-sm btn-secondary" onclick="loadActivity()"><i class="fas fa-sync"></i></button>
        </div>
        <div class="activity-feed" id="activity-list">
          <!-- JS Injects Here -->
          <div style="text-align:center; padding:20px; color:var(--text-muted);">Loading activity...</div>
        </div>
      </div>

      <!-- Key List -->
      <div class="card">
        <div class="section-title">Your Keys</div>
        <div class="table-responsive">
          <table id="key-table">
            <tbody id="key-table-body">
              <!-- JS Injects Here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODALS -->

<!-- Payment Modal -->
<div class="modal-overlay" id="payment-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('payment-modal')">&times;</button>
    <h3><i class="fas fa-wallet" style="color:var(--success);"></i> Fund Wallet</h3>
    <p style="color:var(--text-muted); font-size:0.9rem;">Secure payment via Korapay. 1 Credit = ₦1.</p>
    
    <label>Amount (₦)</label>
    <input type="number" id="fund-amount" value="1000" min="100">
    
    <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="initiatePayment(this)">
      Proceed to Payment
    </button>
  </div>
</div>

<!-- Transfer Modal -->
<div class="modal-overlay" id="transfer-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('transfer-modal')">&times;</button>
    <h3><i class="fas fa-paper-plane" style="color:var(--primary);"></i> Transfer Credits</h3>
    <p style="color:var(--text-muted); font-size:0.9rem;">Gift credits to another developer.</p>
    
    <label>Recipient Email</label>
    <input type="email" id="transfer-email" placeholder="friend@example.com">
    
    <label>Amount (Credits)</label>
    <input type="number" id="transfer-amount" placeholder="100">
    
    <button class="btn btn-primary" style="width:100%; justify-content:center;" onclick="executeTransfer(this)">
      Send Credits
    </button>
  </div>
</div>

<!-- Admin Gift Modal -->
<div class="modal-overlay" id="admin-gift-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('admin-gift-modal')">&times;</button>
    <h3 style="color:var(--warning)">Admin Gift</h3>
    <label>Target Email</label>
    <input type="email" id="admin-gift-email">
    <label>Amount</label>
    <input type="number" id="admin-gift-amount">
    <button class="btn btn-primary" onclick="adminGift(this)" style="width:100%">Gift</button>
  </div>
</div>

<!-- Key Created Modal -->
<div class="modal-overlay" id="key-created-modal">
  <div class="modal" style="text-align:center;">
    <button class="close-modal" onclick="closeModal('key-created-modal')">&times;</button>
    <i class="fas fa-check-circle" style="font-size:3rem; color:var(--success); margin-bottom:15px;"></i>
    <h3>API Key Generated</h3>
    <p style="color:var(--text-muted);">Keep this key safe. Use it in the 'Authorization: Bearer' header.</p>
    
    <div style="background:black; padding:15px; border-radius:8px; font-family:monospace; color:var(--accent); word-break:break-all; margin:15px 0;" id="new-key-display">
      el_sec_...
    </div>
    
    <button class="btn btn-secondary" onclick="copyKey()">Copy to Clipboard</button>
  </div>
</div>

<!-- JAVASCRIPT LOGIC -->
<script type="module">
  // --- CONFIGURATION ---
  const BACKEND_URL = "https://web-production-9a18.up.railway.app";
  const ADMIN_EMAIL = "koladhino@gmail.com";
  
  // Firebase Imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  let userToken = null;
  let currentUserEmail = "";

  // --- AUTH LISTENER ---
  onIdTokenChanged(auth, async (user) => {
    if (user) {
      userToken = await user.getIdToken(true);
      currentUserEmail = user.email;
      
      // Update UI Info
      document.getElementById('user-email-display').textContent = user.email;
      document.getElementById('user-name').textContent = user.email.split('@')[0];
      
      // Admin Check
      if(user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()){
        document.getElementById('admin-banner').style.display = 'block';
      }

      // Load Data
      await refreshDashboard();
      
      // Check for Payment Return
      checkPaymentReturn();
      
    } else {
      window.location.href = 'developer-login.html';
    }
  });

  // --- CORE FUNCTIONS ---

  async function apiCall(endpoint, method = 'GET', body = null) {
    const options = {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-Firebase-Token': userToken
      }
    };
    if (body) options.body = JSON.stringify(body);
    
    try {
      const res = await fetch(`${BACKEND_URL}${endpoint}`, options);
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'API Error');
      return data;
    } catch (e) {
      console.error("API Call Error:", e);
      throw e;
    }
  }

  async function refreshDashboard() {
    try {
      // 1. Get Balance & Keys
      const data = await apiCall('/api/user/keys-and-balance');
      document.getElementById('balance-display').textContent = data.balance.toLocaleString();
      
      const activeKeys = data.keys.filter(k => k.is_active);
      document.getElementById('active-key-count').textContent = activeKeys.length;
      
      renderKeys(data.keys);
      
      // 2. Get Activity History
      await loadActivity();
      
    } catch (e) {
      showToast(e.message, 'error');
    }
  }

  // --- ACTIVITY FEED RENDERER ---
  async function loadActivity() {
    const list = document.getElementById('activity-list');
    list.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-muted);">Updating...</div>';
    
    try {
      // Note: We updated the backend to return 'activity' merging logs and transactions
      // If backend updated: /api/user/activity. If old backend: /api/user/usage-history
      let res;
      try {
        res = await apiCall('/api/user/activity'); // Try new endpoint
      } catch {
         // Fallback if backend isn't fully updated yet, though user asked for full solution
         res = await apiCall('/api/user/usage-history'); 
      }
      
      const logs = res.activity || res.logs || [];
      list.innerHTML = '';
      
      if(logs.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">No recent activity.</div>';
        return;
      }

      logs.forEach(item => {
        // Determine styling based on Type/Amount
        let iconClass = 'icon-usage';
        let iconHtml = '<i class="fas fa-bolt"></i>';
        let amountClass = 'negative';
        let title = item.description || item.endpoint;
        
        // Handle Transactions/Gifts (Amount is positive)
        if (item.amount > 0 || item.type === 'transaction') {
            iconClass = 'icon-payment';
            iconHtml = '<i class="fas fa-arrow-down"></i>';
            amountClass = 'positive';
            if(title.toLowerCase().includes('gift')) iconHtml = '<i class="fas fa-gift"></i>';
        } 
        // Handle Key Generation
        else if (title.includes('API Key')) {
            iconClass = 'icon-key';
            iconHtml = '<i class="fas fa-key"></i>';
        }
        // Handle Transfers (Out)
        else if (item.type === 'transfer_out') {
             iconHtml = '<i class="fas fa-paper-plane"></i>';
        }

        const date = new Date(item.timestamp).toLocaleString();

        const div = document.createElement('div');
        div.className = 'activity-item';
        div.innerHTML = `
          <div class="act-left">
            <div class="act-icon ${iconClass}">${iconHtml}</div>
            <div class="act-details">
              <h4>${title}</h4>
              <p>${date} &bull; ${item.details || item.api_key || ''}</p>
            </div>
          </div>
          <div class="act-amount ${amountClass}">
            ${item.amount > 0 ? '+' : ''}${item.amount}
          </div>
        `;
        list.appendChild(div);
      });
      
    } catch (e) {
      list.innerHTML = `<div style="text-align:center; color:var(--danger)">Failed to load activity</div>`;
    }
  }

  // --- KEY RENDERER ---
  function renderKeys(keys) {
    const tbody = document.getElementById('key-table-body');
    tbody.innerHTML = '';
    
    // Sort active first, then by date
    keys.sort((a,b) => (b.is_active - a.is_active) || new Date(b.created_at) - new Date(a.created_at));

    keys.forEach(key => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><span class="key-blur" title="Click to copy" onclick="navigator.clipboard.writeText('${key.api_key}'); showToast('Copied!')">${key.api_key}</span></td>
            <td><span class="badge ${key.is_active ? 'badge-active' : 'badge-inactive'}">${key.is_active ? 'ACTIVE' : 'REVOKED'}</span></td>
            <td>${key.is_active ? `<i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="revokeKey('${key.api_key}')"></i>` : ''}</td>
        `;
        tbody.appendChild(tr);
    });
  }

  // --- ACTIONS ---

  // 1. Payment Verification (Fixes Problem 1)
  window.checkPaymentReturn = async function() {
    const params = new URLSearchParams(window.location.search);
    const ref = params.get('reference') || params.get('trxref'); // Korapay uses reference
    
    if (ref) {
        // Clean URL immediately so user doesn't retry on refresh
        window.history.replaceState({}, document.title, window.location.pathname);
        
        showToast('Verifying payment...', 'warning');
        try {
            const res = await apiCall(`/api/payments/verify?transaction_ref=${ref}`);
            if(res.status === 'success' || res.status === 'already_credited') {
                showToast(`Payment Successful! Wallet funded.`, 'success');
                refreshDashboard(); // Update balance immediately
            } else {
                showToast(`Payment status: ${res.status}`, 'error');
            }
        } catch (e) {
            showToast('Verification failed. Contact support.', 'error');
        }
    }
  }

  window.initiatePayment = async function(btn) {
    const amt = document.getElementById('fund-amount').value;
    if(amt < 100) return showToast('Minimum ₦100', 'error');
    
    btn.disabled = true; btn.innerText = "Processing...";
    
    try {
        const res = await apiCall('/api/payments/initiate', 'POST', { amount: parseInt(amt) });
        // Redirect to Korapay Checkout
        window.location.href = res.checkout_url;
    } catch (e) {
        showToast(e.message, 'error');
        btn.disabled = false; btn.innerText = "Proceed to Payment";
    }
  }

  // 2. Key Generation
  window.generateKey = async function() {
    if(!confirm("Generate new API key? This costs 100 credits.")) return;
    
    try {
        const res = await apiCall('/api/user/create-api-key', 'POST');
        document.getElementById('new-key-display').textContent = res.api_key;
        openModal('key-created-modal');
        refreshDashboard();
        showToast('Key generated successfully', 'success');
    } catch (e) {
        showToast(e.message, 'error');
    }
  }
  
  window.revokeKey = async function(key) {
      if(!confirm("Revoke this key? It cannot be reactivated.")) return;
      try {
          await apiCall('/api/user/revoke-api-key', 'POST', { api_key: key });
          refreshDashboard();
          showToast('Key revoked', 'success');
      } catch(e) { showToast(e.message, 'error'); }
  }

  window.copyKey = function() {
      const text = document.getElementById('new-key-display').textContent;
      navigator.clipboard.writeText(text);
      showToast('Copied to clipboard', 'success');
      closeModal('key-created-modal');
  }

  // 3. User Transfer (Fixes Problem 4)
  window.executeTransfer = async function(btn) {
      const email = document.getElementById('transfer-email').value;
      const amount = parseInt(document.getElementById('transfer-amount').value);
      
      if(!email || !amount) return showToast('Fill all fields', 'error');
      
      btn.disabled = true; btn.innerText = "Sending...";
      
      try {
          const res = await apiCall('/api/user/transfer-credits', 'POST', { recipient_email: email, amount: amount });
          showToast(res.message, 'success');
          closeModal('transfer-modal');
          refreshDashboard();
      } catch (e) {
          showToast(e.message, 'error');
      } finally {
          btn.disabled = false; btn.innerText = "Send Credits";
      }
  }

  // 4. Admin Actions
  window.triggerAdminGrant = async function() {
      try { await apiCall('/api/admin/grant-credits', 'POST'); refreshDashboard(); showToast('Granted 100k', 'success'); }
      catch(e) { showToast(e.message, 'error'); }
  }
  
  window.adminGift = async function(btn) {
      const email = document.getElementById('admin-gift-email').value;
      const amt = parseInt(document.getElementById('admin-gift-amount').value);
      try {
          const res = await apiCall('/api/admin/gift-credits', 'POST', { target_email: email, amount: amt });
          showToast(res.message, 'success');
          closeModal('admin-gift-modal');
      } catch(e) { showToast(e.message, 'error'); }
  }

  // --- UI UTILS ---
  window.signOutUser = () => signOut(auth);
  document.getElementById('logout-btn').addEventListener('click', signOutUser);

  window.openModal = (id) => document.getElementById(id).style.display = 'flex';
  window.closeModal = (id) => document.getElementById(id).style.display = 'none';
  
  function showToast(msg, type='success') {
    const t = document.createElement('div');
    t.className = 'toast';
    t.style.borderLeftColor = type === 'success' ? 'var(--success)' : (type === 'warning' ? 'var(--warning)' : 'var(--danger)');
    
    let icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    t.innerHTML = `<i class="fas ${icon}" style="color:${t.style.borderLeftColor}"></i> <span>${msg}</span>`;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => t.remove(), 4000);
  }

</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
