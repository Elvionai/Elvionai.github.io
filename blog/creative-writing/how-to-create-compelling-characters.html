<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to Craft Unforgettable Characters: A Writer's Guide | Elvion AI Blog</title>
    <meta name="description" content="Master the art of character creation with proven techniques to build compelling, three-dimensional characters that readers will love.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- DUAL THEME VARIABLES (Default: DARK MODE) --- */
        :root {
            /* Elvion AI Cyan/Blue Theme */
            --dark-navy: #00001a;
            --bg-color: #0d1117; 
            --text-color: #e6edf3;
            --heading-color: #ffffff;
            --cyan-glow: #00ffff;
            --light-blue-glow: #00aaff; 
            --link-color: var(--cyan-glow);
            --link-hover-color: var(--light-blue-glow);
            --border-color: #21262d;
            --card-bg: #161b22; 
            --button-bg: linear-gradient(45deg, var(--cyan-glow), var(--light-blue-glow));
            --button-text-color: #0d1117; /* Dark text on bright button */
            --button-hover-bg: linear-gradient(45deg, #00d4d4, #0077ff);
            --navbar-bg: rgba(13, 17, 23, 0.95);
            --footer-bg: #0a0e14;
            --highlight-color: rgba(0, 255, 255, 0.3); 
            --comment-bg: #0d1117;
            --shadow-glow: 0 0 10px rgba(0, 255, 255, 0.15);
            /* Dark Mode Headline Color */
            --headline-color: var(--light-blue-glow);
            /* Verified Badge Color */
            --verified-color: #1DA1F2; /* Standard Blue Checkmark */
            /* New Admin Glow Badge Colors */
            --admin-color: #FFD700; /* Gold */
            --admin-glow: rgba(255, 215, 0, 0.5);
            /* New Audio Player */
            --audio-widget-bg: rgba(22, 27, 34, 0.9);
        }

        /* LIGHT MODE VARIABLES */
        body.light-theme {
            --bg-color: #f7f7f7; /* Less whitish, slight off-white */
            --text-color: #333333;
            --heading-color: #111111;
            --link-color: #0056b3;
            --link-hover-color: #003d80;
            --border-color: #e0e0e0;
            --card-bg: #ffffff; /* Card background is still white */
            --button-bg: #0056b3;
            --button-text-color: #ffffff;
            --button-hover-bg: #003d80;
            --navbar-bg: rgba(255, 255, 255, 0.95);
            --footer-bg: #eeeeee;
            --highlight-color: #ffeb3b; /* A subtle yellow highlight */
            --comment-bg: #ffffff;
            --shadow-glow: none;
            /* Light Mode Headline Color */
            --headline-color: #111111; /* Black headline */
            /* Verified Badge Color */
            --verified-color: #1DA1F2;
            /* New Admin Glow Badge Colors */
            --admin-color: #CCAA00; /* Darker Gold */
            --admin-glow: none;
            /* New Audio Player */
            --audio-widget-bg: rgba(255, 255, 255, 0.9);
        }

        /* --- GLOBAL STYLES --- */
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding-top: 60px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            font-size: 1.1rem;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
            color: var(--heading-color);
            margin-top: 0;
            line-height: 1.3;
            text-shadow: var(--shadow-glow);
        }
        
        a {
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .post-container {
             max-width: 800px;
             margin: 0 auto;
             padding: 0 1rem;
        }

        /* --- Navbar Styles (Existing) --- */
        .navbar {
            position: fixed; top: 0; width: 100%; 
            background: var(--navbar-bg); 
            padding: 1rem 0; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5); 
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .navbar-brand { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--heading-color); text-shadow: var(--shadow-glow); }
        .nav-links { display: flex; list-style: none; margin: 0; padding: 0; }
        .nav-links li { margin-left: 2rem; }
        .nav-links a { 
            color: var(--text-color); font-weight: 500; font-family: 'Inter', sans-serif; font-size: 1rem;
            text-transform: uppercase; letter-spacing: 0.5px; padding: 0.5rem 0; position: relative; 
        }
        .nav-links .active-link { color: var(--link-color); }
        .nav-links a::after { 
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0; 
            background: var(--link-color); transition: width 0.3s ease-in-out; 
        }
        .nav-links a:hover::after, .nav-links .active-link::after { width: 100%; }
        
        .hamburger { display: none; flex-direction: column; cursor: pointer; padding: 0.5rem; background: transparent; border: none; }
        .hamburger .bar { 
            width: 25px; height: 3px; background-color: var(--heading-color); margin: 4px 0; transition: 0.4s; box-shadow: none; 
        }
        .hamburger.active .bar:nth-child(2) { opacity: 0; }
        .hamburger.active .bar:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .hamburger.active .bar:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
        
        #theme-toggle {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-left: 1rem;
        }
        #theme-toggle:hover {
            border-color: var(--link-color);
            color: var(--link-color);
        }
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* --- Footer Styles (Existing) --- */
        .footer {
            background: var(--footer-bg); color: var(--text-color); padding: 4rem 0 2rem; font-size: 0.9rem;
            border-top: 1px solid var(--border-color); text-align: center; position: relative; margin-top: 4rem;
        }
        .footer .container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            text-align: left;
            max-width: 900px;
        }
        .footer .col h4 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        .footer ul {
            list-style: none;
            padding: 0;
        }
        .footer li {
            margin-bottom: 0.5rem;
        }
        .footer a {
            color: var(--text-color);
            font-size: 0.9rem;
        }
        .footer a:hover {
            color: var(--link-color);
            text-decoration: none;
        }
        .footer .brand-info {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--link-color);
        }
        .footer .legal-info { 
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
            color: #777; 
        }

        /* --- Single Post Styles --- */
        .post-main { padding-top: 3rem; padding-bottom: 3rem; position: relative; }
        .post-header { border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .post-header .post-tag { 
            display: inline-block; padding: 0.4rem 1rem; background: var(--button-bg); 
            color: var(--button-text-color); font-weight: 700; font-size: 0.85rem; 
            border-radius: 20px; text-transform: uppercase; margin-bottom: 1rem;
            background-image: var(--button-bg); /* Apply gradient */
        }
        .post-meta {
            display: flex; flex-wrap: wrap; gap: 1.5rem; 
            color: rgba(224, 224, 224, 0.7); font-size: 0.95rem; margin-top: 1rem;
        }
        body.light-theme .post-meta { color: #666; }
        .post-meta span { display: flex; align-items: center; gap: 0.5rem; }
        .post-meta i { color: var(--link-color); }
        
        /* REVERTED: Article Image Styles */
        .post-thumbnail-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-glow);
        }
        .post-thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .article-content blockquote {
            border-left: 4px solid var(--link-color);
            color: var(--text-color);
            background: var(--card-bg);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 4px;
        }
        
        /* UPDATED: Headline colors */
        .article-content h2 { 
            font-size: 2rem; margin-top: 3rem; margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;
            color: var(--headline-color);
        }
        .article-content h3 { color: var(--heading-color); font-size: 1.5rem; margin-top: 2rem; }
        .article-content ul, .article-content ol { padding-left: 1.5rem; margin-bottom: 1.5rem; }
        .article-content b { color: var(--cyan-glow); font-weight: 600; }
        body.light-theme .article-content b { color: var(--link-color); }
        
        /* TTS Word Highlighting Style */
        .article-content span.tts-highlight {
            background-color: var(--highlight-color);
            border-radius: 2px;
            padding: 2px 0;
            margin: 0;
            transition: background-color 0.05s;
        }
        body.light-theme .article-content span.tts-highlight {
             background-color: var(--highlight-color);
        }
        
        /* NEW: Button Style */
        .btn-primary {
            background: var(--button-bg); color: var(--button-text-color); border: none;
            padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: 700;
            font-family: 'Orbitron', sans-serif; font-size: 1rem; transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .btn-primary:hover { 
            background: var(--button-hover-bg); 
            box-shadow: var(--shadow-glow);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }


        /* --- NEW AUDIO WIDGET STYLES (Fixed Position, Glowing) --- */
        #audio-widget-container {
            position: fixed;
            bottom: -150px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            width: min(90%, 500px);
            padding: 1rem;
            background: var(--audio-widget-bg);
            border: 2px solid var(--link-color);
            border-radius: 12px 12px 0 0;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            z-index: 999;
            transition: bottom 0.5s ease-out;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #audio-widget-container.active {
            bottom: 0;
        }
        body.light-theme #audio-widget-container {
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15); 
            border-color: var(--link-color);
        }

        .widget-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #widget-play-pause-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
            box-shadow: 0 0 10px var(--cyan-glow);
            animation: pulse-widget 1.5s infinite alternate;
        }
        #widget-play-pause-btn:hover {
            box-shadow: 0 0 15px var(--light-blue-glow);
        }
        @keyframes pulse-widget {
            from { transform: scale(1); }
            to { transform: scale(1.03); }
        }

        .widget-progress-info {
            flex-grow: 1;
        }

        .widget-progress-container {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        #widget-audio-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--cyan-glow), var(--light-blue-glow));
            border-radius: 4px;
        }
        .widget-time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 0.2rem;
        }
        
        #widget-voice-display {
            font-size: 0.9rem;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Initial "Listen" button */
        #initial-listen-cta {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        #initial-listen-cta h3 {
            margin-top: 0;
            font-size: 1.5rem;
        }
        #initial-listen-cta select, #initial-listen-cta button {
            margin-top: 1rem;
        }
        
        /* Remove old audio player section */
        .audio-player { display: none !important; }

        /* Form Controls */
        .form-input {
            background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color);
            display: block; width: 100%; padding: 0.8rem; margin-bottom: 1rem; border-radius: 4px; box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }
        .form-input:focus { 
            border-color: var(--link-color); 
            box-shadow: 0 0 0 2px rgba(0, 255, 255, 0.3); 
            outline: none;
        }
        textarea.form-input { min-height: 100px; resize: vertical; }

        /* --- COMMENT EDITOR TOOLBAR --- */
        .comment-editor-toolbar {
            display: flex;
            gap: 5px;
            margin-bottom: 0.5rem;
            padding: 5px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            flex-wrap: wrap;
        }
        .comment-editor-toolbar button {
            background: none;
            border: none;
            color: var(--text-color);
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
            line-height: 1;
        }
        .comment-editor-toolbar button:hover {
            background: var(--card-bg);
            color: var(--link-color);
        }
        .comment-editor-toolbar button i {
            font-size: 1rem;
        }


        /* --- Comment Section Styles (Authentication & Likes/Replies) --- */
        .comments-wrapper { 
            margin-top: 4rem;
            padding-top: 2rem; 
            border-top: 1px solid var(--border-color); 
        }
        .comments-wrapper h2 { 
            font-size: 1.8rem;
            margin-bottom: 2rem;
            border-bottom: none;
        }
        
        /* New: Authentication Prompt */
        .auth-prompt {
            background: var(--card-bg);
            border: 1px solid var(--link-color);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 3rem;
            text-align: center;
        }
        .auth-prompt h3 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
        }
        .auth-prompt .guest-comment-link {
            display: block;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .comment-form-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 3rem;
        }
        .comment-form-container h3 {
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
        }

        .comment {
            background: var(--comment-bg); border: 1px solid var(--border-color);
            display: flex; gap: 1rem; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        /* NEW: Reply Indentation */
        .comment.reply {
            margin-left: 50px; /* Indent replies */
            border-left: 4px solid var(--link-hover-color); /* Visual distinction */
            margin-top: -0.5rem; /* Reduce vertical spacing between parent and first reply */
            margin-bottom: 1rem;
        }
        
        /* NEW: Styling for the dynamic reply/edit form */
        .reply-form-container {
            margin-top: 1rem;
            padding: 1rem;
            border-top: 1px dashed var(--border-color);
            background: var(--bg-color); /* Use base color for subtle contrast */
            border-radius: 4px;
        }
        .reply-form-container .form-input {
            margin-bottom: 0.5rem;
        }
        
        .comment-avatar { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--link-color); 
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            color: var(--button-text-color); font-weight: 700; flex-shrink: 0;
        }
        .comment-user { 
            font-weight: 600; color: var(--cyan-glow); font-size: 1rem; 
            display: inline-block; margin-bottom: 0.3rem;
        }
        body.light-theme .comment-user { color: var(--link-color); }
        
        /* Standard Verified Badge - Instagram Blue */
        .verified-badge { 
            background: var(--verified-color);
            color: white; 
            margin-left: 5px; 
            font-size: 0.65rem; 
            vertical-align: middle; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            line-height: 1;
            transform: translateY(-2px);
        }
        .verified-badge i { font-size: 0.75rem; }
        
        /* NEW: Admin Verified Badge (Glowing Gold/Cyan) */
        .admin-verified-badge {
            background: linear-gradient(45deg, var(--cyan-glow), var(--admin-color));
            color: var(--button-text-color); /* Dark text on bright badge */
            margin-left: 5px;
            font-size: 0.65rem;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 17px; /* Slightly larger */
            height: 17px;
            border-radius: 50%;
            line-height: 1;
            transform: translateY(-2px);
            box-shadow: 0 0 5px var(--admin-glow), 0 0 10px var(--cyan-glow);
        }
        body.light-theme .admin-verified-badge {
             box-shadow: none; /* Turn off glow in light mode */
             background: var(--admin-color);
             color: var(--heading-color);
        }
        .admin-verified-badge i { font-size: 0.8rem; }
        
        .admin-badge {
            color: gold; margin-left: 5px; font-size: 0.8rem;
            vertical-align: middle;
        }
        .guest-badge {
            color: #999; margin-left: 5px; font-size: 0.8rem;
            vertical-align: middle;
        }
        .comment-meta {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.5rem;
        }
        .comment-actions {
            font-size: 0.9rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            color: #777;
        }
        .comment-actions button {
            background: none; border: none; color: #777; cursor: pointer;
            transition: color 0.2s; font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }
        .comment-actions button:hover {
            color: var(--link-color);
        }
        .comment-actions button:disabled {
            color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .comment-actions i {
            margin-right: 5px;
        }
        .like-btn.liked {
            color: #E91E63;
        }
        
        .no-comments {
            text-align: center;
            padding: 3rem;
            color: #777;
        }
        
        /* Responsive adjustments (Existing) */
        @media (max-width: 992px) {
            .nav-links {
                display: none;
                flex-direction: column;
                width: 100%;
                background: var(--navbar-bg);
                position: absolute;
                top: 100%;
                left: 0;
                padding: 1rem 0;
                border-top: 1px solid var(--border-color);
            }
            .nav-links.active {
                display: flex;
            }
            .nav-links li {
                margin: 0.5rem 2rem;
            }
            .nav-links a::after { display: none; }
            .hamburger { display: flex; }
            .footer .container { grid-template-columns: repeat(2, 1fr); }
            .footer .col:nth-child(1), .footer .col:nth-child(2) { margin-bottom: 1.5rem; }
            
            #audio-widget-container {
                width: 100%;
                border-left: none;
                border-right: none;
                border-radius: 12px 12px 0 0;
            }
        }

        @media (max-width: 500px) {
            .footer .container { grid-template-columns: 1fr; text-align: center; }
            .footer .col { margin-bottom: 1rem; }
            .comment.reply {
                margin-left: 20px;
            }
        }
    </style>
</head>
<body>
    
    <header class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">Elvion AI</a>
            
            <div class="nav-controls">
                <nav class="nav-links">
                    <li><a href="https://elvionai.github.io/university.html">Digital University</a></li>
                    <li><a href="https://elvionai.github.io/blog.html" class="active-link">Back to Blog</a></li>
                    <li><a href="https://elvionai.github.io/about.html">About Us</a></li>
                </nav>
                <button id="theme-toggle" aria-label="Toggle theme">
                    <i class="fas fa-sun"></i> 
                </button>
                <button class="hamburger" aria-label="Toggle navigation">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </button>
            </div>
        </div>
    </header>

    <main class="post-main">
        <div class="post-container">

            <header class="post-header">
                <span class="post-tag">Creative Writing</span>
                <h1>How to Craft Unforgettable Characters: A Writer's Guide</h1>
                <div class="post-meta">
                    <span><i class="fas fa-user-edit"></i> By Philip Smith</span>
                    <span><i class="fas fa-calendar-alt"></i> Nov 5, 2025</span>
                    <span id="estimated-time"><i class="fas fa-clock"></i> Calculating read time...</span>
                </div>
            </header>
            
            <div class="post-thumbnail-container">
                <img src="https://i.postimg.cc/5tVz6Hdc/20251106-155445.jpg" alt="A quill pen rests on a piece of paper, symbolizing creative writing and character crafting.">
            </div>
            
            <section id="initial-listen-cta">
                <h3>ðŸ”Š Listen to this article</h3>
                <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; max-width: 400px; margin: 0 auto;">
                    <select id="voice-select" class="form-input" style="margin-bottom: 0;">
                        <option value="" disabled selected>Select AI Voice...</option>
                        <option value="audios/a5cae336-01dd-431b-b388-9a319258d85f.wav" data-duration="274.0">Philadelphia (Female)</option>
                        <option value="audios/c72d8fbf-8a99-451d-b94c-8d7c8ffef5e5.wav" data-duration="267.0">Funny Daddy (Male)</option>
                    </select>
                    <select id="speed-select" class="form-input" style="margin-bottom: 0;">
                        <option value="1.0">Normal</option>
                        <option value="0.75">0.75x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                    </select>
                </div>
            </section>
            
            <article class="article-content" id="article-content">
                <p id="p-0">Your <span class="word-content">characters</span> <span class="word-content">are</span> <span class="word-content">the</span> <span class="word-content">heart</span> <span class="word-content">of</span> <span class="word-content">your</span> <span class="word-content">story.</span> <span class="word-content">They</span> <span class="word-content">are</span> <span class="word-content">the</span> <span class="word-content">vessels</span> <span class="word-content">through</span> <span class="word-content">which</span> <span class="word-content">your</span> <span class="word-content">reader</span> <span class="word-content">experiences</span> <span class="word-content">the</span> <span class="word-content">world</span> <span class="word-content">you've</span> <span class="word-content">built,</span> <span class="word-content">the</span> <span class="word-content">conflicts</span> <span class="word-content">you've</span> <span class="word-content">crafted,</span> <span class="word-content">and</span> <span class="word-content">the</span> <span class="word-content">emotions</span> <span class="word-content">you</span> <span class="word-content">want</span> <span class="word-content">to</span> <span class="word-content">evoke.</span> <span class="word-content">A</span> <span class="word-content">weak</span> <span class="word-content">plot</span> <span class="word-content">can</span> <span class="word-content">sometimes</span> <span class="word-content">be</span> <span class="word-content">saved</span> <span class="word-content">by</span> <span class="word-content">compelling</span> <span class="word-content">characters,</span> <span class="word-content">but</span> <span class="word-content">even</span> <span class="word-content">the</span> <span class="word-content">most</span> <span class="word-content">brilliant</span> <span class="word-content">plot</span> <span class="word-content">will</span> <span class="word-content">fall</span> <span class="word-content">flat</span> <span class="word-content">if</span> <span class="word-content">the</span> <span class="word-content">characters</span> <span class="word-content">feel</span> <span class="word-content">like</span> <span class="word-content">cardboard</span> <span class="word-content">cutouts.</span> <span class="word-content">So,</span> <span class="word-content">how</span> <span class="word-content">do</span> <span class="word-content">you</span> <span class="word-content">create</span> <span class="word-content">three-dimensional,</span> <span class="word-content">unforgettable</span> <span class="word-content">characters</span> <span class="word-content">that</span> <span class="word-content">leap</span> <span class="word-content">off</span> <span class="word-content">the</span> <span class="word-content">page?</span></p>

                <h2>1.<span class="word-content">The</span> <span class="word-content">Iceberg</span> <span class="word-content">Method</span></h2>
                <p id="p-1"><span class="word-content">What</span> <span class="word-content">we</span> <span class="word-content">see</span> <span class="word-content">of</span> <span class="word-content">a</span> <span class="word-content">character. Their</span> <span class="word-content">appearance,</span> <span class="word-content">their</span> <span class="word-content">job,</span> <span class="word-content">their</span> <span class="word-content">actions; is</span> <span class="word-content">just</span> <span class="word-content">the</span> <span class="word-content">tip</span> <span class="word-content">of</span> <span class="word-content">the</span> <span class="word-content">iceberg.</span> <span class="word-content">The</span> <span class="word-content">real</span> <span class="word-content">substance</span> <span class="word-content">lies</span> <span class="word-content">beneath</span> <span class="word-content">the</span> <span class="word-content">surface.</span> <span class="word-content">This</span> <span class="word-content">is</span> <span class="word-content">their</span> <span class="word-content">backstory.</span> <span class="word-content">You</span> <span class="word-content">don't</span> <span class="word-content">need</span> <span class="word-content">to</span> <span class="word-content">dump</span> <span class="word-content">all</span> <span class="word-content">of</span> <span class="word-content">this</span> <span class="word-content">information</span> <span class="word-content">on</span> <span class="word-content">the</span> <span class="word-content">reader</span> <span class="word-content">(in</span> <span class="word-content">fact,</span> <span class="word-content">please</span> <span class="word-content">don't!),</span> <span class="word-content">but</span> <span class="word-content"><i>you</i></span> <span class="word-content">need</span> <span class="word-content">to</span> <span class="word-content">know</span> <span class="word-content">it.</span> <span class="word-content">What</span> <span class="word-content">was</span> <span class="word-content">their</span> <span class="word-content">childhood</span> <span class="word-content">like?</span> <span class="word-content">What's</span> <span class="word-content">their</span> <span class="word-content">biggest</span> <span class="word-content">regret?</span> <span class="word-content">What</span> <span class="word-content">is</span> <span class="word-content">the</span> <span class="word-content">secret</span> <span class="word-content">they've</span> <span class="word-content">never</span> <span class="word-content">told</span> <span class="word-content">anyone?</span> <span class="word-content">This</span> <span class="word-content">hidden</span> <span class="word-content">weight</span> <span class="word-content">informs</span> <span class="word-content">their</span> <span class="word-content">every</span> <span class="word-content">decision,</span> <span class="word-content">fear,</span> <span class="word-content">and</span> <span class="word-content">desire.</span></p>

                <blockquote id="bq-0">
                    <span class="word-content"><b>Pro-Tip:</b></span> <span class="word-content">Ask</span> <span class="word-content">yourself:</span> <span class="word-content">What</span> <span class="word-content">is</span> <span class="word-content">the</span> <span class="word-content">single</span> <span class="word-content">most</span> <span class="word-content">important</span> <span class="word-content">event</span> <span class="word-content">that</span> <span class="word-content">shaped</span> <span class="word-content">my</span> <span class="word-content">character</span> <span class="word-content">into</span> <span class="word-content">who</span> <span class="word-content">they</span> <span class="word-content">are</span> <span class="word-content">today?</span> <span class="word-content">How</span> <span class="word-content">does</span> <span class="word-content">it</span> <span class="word-content">affect</span> <span class="word-content">their</span> <span class="word-content">behavior</span> <span class="word-content">in</span> <span class="word-content">Chapter</span> <span class="word-content">1?</span>
                </blockquote>

                <h2>2. <span class="word-content">Give</span> <span class="word-content">Them</span> <span class="word-content">Flaws</span> <span class="word-content">(Real</span> <span class="word-content">Ones)</span></h2>
                <p id="p-2"><span class="word-content">Perfection</span> <span class="word-content">is</span> <span class="word-content">boring.</span> <span class="word-content">A</span> <span class="word-content">character</span> <span class="word-content">who</span> <span class="word-content">is</span> <span class="word-content">always</span> <span class="word-content">right,</span> <span class="word-content">always</span> <span class="word-content">strong,</span> <span class="word-content">and</span> <span class="word-content">always</span> <span class="word-content">kind</span> <span class="word-content">is</span> <span class="word-content">not</span> <span class="word-content">relatable. They're</span> <span class="word-content">annoying.</span> <span class="word-content">Real</span> <span class="word-content">people</span> <span class="word-content">are</span> <span class="word-content">messy.</span> <span class="word-content">They</span> <span class="word-content">are</span> <span class="word-content">impatient,</span> <span class="word-content">they</span> <span class="word-content">are</span> <span class="word-content">selfish,</span> <span class="word-content">they</span> <span class="word-content">are</span> <span class="word-content">afraid</span> <span class="word-content">of</span> <span class="word-content">spiders,</span> <span class="word-content">they</span> <span class="word-content">procrastinate.</span> <span class="word-content">A</span> <span class="word-content">flaw</span> <span class="word-content">makes</span> <span class="word-content">a</span> <span class="word-content">character</span> <span class="word-content">human.</span> <span class="word-content">More</span> <span class="word-content">importantly,</span> <span class="word-content">a</span> <span class="word-content">character's</span> <span class="word-content">fatal</span> <span class="word-content">flaw</span> <span class="word-content">is</span> <span class="word-content">often</span> <span class="word-content">the</span> <span class="word-content">engine</span> <span class="word-content">of</span> <span class="word-content">the</span> <span class="word-content">plot.</span> <span class="word-content">It's</span> <span class="word-content">the</span> <span class="word-content">internal</span> <span class="word-content">obstacle</span> <span class="word-content">they</span> <span class="word-content">must</span> <span class="word-content">overcome</span> <span class="word-content">to</span> <span class="word-content">achieve</span> <span class="word-content">their</span> <span class="word-content">external</span> <span class="word-content">goal.</span> <span class="word-content">Is</span> <span class="word-content">your</span> <span class="word-content">hero</span> <span class="word-content">brave?</span> <span class="word-content">Make</span> <span class="word-content">them</span> <span class="word-content">reckless.</span> <span class="word-content">Is</span> <span class="word-content">your</span> <span class="word-content">heroine</span> <span class="word-content">brilliant?</span> <span class="word-content">Make</span> <span class="word-content">her</span> <span class="word-content">arrogant.</span></p>

                <h2>3. <span class="word-content">Wants</span> <span class="word-content">vs.</span> <span class="word-content">Needs</span></h2>
                <p id="p-3"><span class="word-content">This</span> <span class="word-content">is</span> <span class="word-content">a</span> <span class="word-content">classic</span> <span class="word-content">writing</span> <span class="word-content">technique</span> <span class="word-content">for</span> <span class="word-content">a</span> <span class="word-content">reason.</span> <span class="word-content">Every</span> <span class="word-content">compelling</span> <span class="word-content">character</span> <span class="word-content">has</span> <span class="word-content">two</span> <span class="word-content">goals:</span></p>
                
                <ul>
                    <li id="li-0"><span class="word-content"><b>The</span> <span class="word-content">Want:</b></span> <span class="word-content">This</span> <span class="word-content">is</span> <span class="word-content">the</span> <span class="word-content">external,</span> <span class="word-content">conscious</span> <span class="word-content">goal.</span> <span class="word-content">It's</span> <span class="word-content">what</span> <span class="word-content">the</span> <span class="word-content">character</span> <span class="word-content"><i>thinks</i></span> <span class="word-content">they</span> <span class="word-content">need</span> <span class="word-content">to</span> <span class="word-content">be</span> <span class="word-content">happy.</span> <span class="word-content">(e.g.,</span> <span class="word-content">"I</span> <span class="word-content">want</span> <span class="word-content">to</span> <span class="word-content">win</span> <span class="word-content">the</span> <span class="word-content">championship.")</span></li>
                    <li id="li-1"><span class="word-content"><b>The</span> <span class="word-content">Need:</b></span> <span class="word-content">This</span> <span class="word-content">is</span> <span class="word-content">the</span> <span class="word-content">internal,</span> <span class="word-content">often</span> <span class="word-content">subconscious</span> <span class="word-content">truth.</span> <span class="word-content">It's</span> <span class="word-content">what</span> <span class="word-content">the</span> <span class="word-content">character</span> <span class="word-content"><i>actually</i></span> <span class="word-content">needs</span> <span class="word-content">to</span> <span class="word-content">grow</span> <span class="word-content">as</span> <span class="word-content">a</span> <span class="word-content">person.</span> <span class="word-content">(e.g.,</span> <span class="word-content">"I</span> <span class="word-content">need</span> <span class="word-content">to</span> <span class="word-content">learn</span> <span class="word-content">to</span> <span class="word-content">trust</span> <span class="word-content">my</span> <span class="word-content">teammates.")</span></li>
                </ul>

                <p id="p-4"><span class="word-content">The</span> <span class="word-content">best</span> <span class="word-content">stories</span> <span class="word-content">create</span> <span class="word-content">conflict</span> <span class="word-content">by</span> <span class="word-content">putting</span> <span class="word-content">the</span> <span class="word-content">Want</span> <span class="word-content">and</span> <span class="word-content">the</span> <span class="word-content">Need</span> <span class="word-content">at</span> <span class="word-content">odds.</span> <span class="word-content">The</span> <span class="word-content">character's</span> <span class="word-content">journey</span> <span class="word-content">(their</span> <span class="word-content">"arc")</span> <span class="word-content">is</span> <span class="word-content">complete</span> <span class="word-content">when</span> <span class="word-content">they</span> <span class="word-content">either</span> <span class="word-content">sacrifice</span> <span class="word-content">their</span> <span class="word-content">Want</span> <span class="word-content">to</span> <span class="word-content">achieve</span> <span class="word-content">their</span> <span class="word-content">Need,</span> <span class="word-content">or</span> <span class="word-content">finally</span> <span class="word-content">realize</span> <span class="word-content">that</span> <span class="word-content">what</span> <span class="word-content">they</span> <span class="word-content">Needed</span> <span class="word-content">was</span> <span class="word-content">the</span> <span class="word-content">key</span> <span class="word-content">to</span> <span class="word-content">getting</span> <span class="word-content">what</span> <span class="word-content">they</span> <span class="word-content">Wanted</span> <span class="word-content">all</span> <span class="word-content">along.</span></p>
                
                <h2>4. <span class="word-content">Let</span> <span class="word-content">Their</span> <span class="word-content">Voice</span> <span class="word-content">Be</span> <span class="word-content">Heard</span></h2>
                <p id="p-5"><span class="word-content">How</span> <span class="word-content">does</span> <span class="word-content">your</span> <span class="word-content">character</span> <span class="word-content">speak?</span> <span class="word-content">Their</span> <span class="word-content">dialogue</span> <span class="word-content">is</span> <span class="word-content">a</span> <span class="word-content">window</span> <span class="word-content">into</span> <span class="word-content">their</span> <span class="word-content">soul.</span> <span class="word-content">A</span> <span class="word-content">character's</span> <span class="word-content">voice</span> <span class="word-content">is</span> <span class="word-content">more</span> <span class="word-content">than</span> <span class="word-content">just</span> <span class="word-content">an</span> <span class="word-content">accent;</span> <span class="word-content">it's</span> <span class="word-content">their</span> <span class="word-content">word</span> <span class="word-content">choice,</span> <span class="word-content">their</span> <span class="word-content">sentence</span> <span class="word-content">structure,</span> <span class="word-content">their</span> <span class="word-content">rhythm,</span> <span class="word-content">and</span> <span class="word-content">what</span> <span class="word-content">they</span> <span class="word-content">choose</span> <span class="word-content">to</span> <span class="word-content">say</span> <span class="word-content">(or</span> <span class="word-content">not</span> <span class="word-content">say).</span></p>
                
                <h3><span class="word-content">Quick</span> <span class="word-content">Voice</span> <span class="word-content">Tips:</span></h3>
                <ul>
                    <li id="li-2"><span class="word-content">An</span> <span class="word-content">educated</span> <span class="word-content">professor</span> <span class="word-content">might</span> <span class="word-content">use</span> <span class="word-content">complex</span> <span class="word-content">sentences</span> <span class="word-content">and</span> <span class="word-content">precise</span> <span class="word-content">vocabulary.</span></li>
                    <li id="li-3"><span class="word-content">A</span> <span class="word-content">nervous</span> <span class="word-content">teenager</span> <span class="word-content">might</span> <span class="word-content">speak</span> <span class="word-content">in</span> <span class="word-content">short,</span> <span class="word-content">halting</span> <span class="word-content">sentences,</span> <span class="word-content">using</span> <span class="word-content">a</span> <span class="word-content">lot</span> <span class="word-content">of</span> <span class="word-content">"like"</span> <span class="word-content">or</span> <span class="word-content">"um."</span></li>
                    <li id="li-4"><span class="word-content">A</span> <span class="word-content">cynical</span> <span class="word-content">detective</span> <span class="word-content">might</span> <span class="word-content">use</span> <span class="word-content">dry,</span> <span class="word-content">sarcastic</span> <span class="word-content">wit.</span></li>
                </ul>
                <p id="p-6"><span class="word-content">Try</span> <span class="word-content">this</span> <span class="word-content">exercise:</span> <span class="word-content">Write</span> <span class="word-content">a</span> <span class="word-content">scene</span> <span class="word-content">with</span> <span class="word-content">two</span> <span class="word-content">characters</span> <span class="word-content">arguing,</span> <span class="word-content">but</span> <span class="word-content">remove</span> <span class="word-content">all</span> <span class="word-content">dialogue</span> <span class="word-content">tags</span> <span class="word-content">("he</span> <span class="word-content">said,"</span> <span class="word-content">"she</span> <span class="word-content">yelled").</span> <span class="word-content">Can</span> <span class="word-content">you</span> <span class="word-content">tell</span> <span class="word-content">who</span> <span class="word-content">is</span> <span class="word-content">speaking</span> <span class="word-content">just</span> <span class="word-content">by</span> <span class="word-content">their</span> <span class="word-content">words</span> <span class="word-content">and</span> <span class="word-content">rhythm?</span> <span class="word-content">If</span> <span class="word-content">so,</span> <span class="word-content">you're</span> <span class="word-content">on</span> <span class="word-content">the</span> <span class="word-content">right</span> <span class="word-content">track.</span></p>

                <h2>5. <span class="word-content">Make</span> <span class="word-content">Them</span> <span class="word-content">Act:</span> <span class="word-content">Decisions</span> <span class="word-content">Define</span> <span class="word-content">Character</span></h2>
                <p id="p-7"><span class="word-content">Don't</span> <span class="word-content">just</span> <span class="word-content"><i>tell</i></span> <span class="word-content">us</span> <span class="word-content">your</span> <span class="word-content">character</span> <span class="word-content">is</span> <span class="word-content">brave;</span> <span class="word-content">put</span> <span class="word-content">them</span> <span class="word-content">in</span> <span class="word-content">a</span> <span class="word-content">situation</span> <span class="word-content">where</span> <span class="word-content">they</span> <span class="word-content">must</span> <span class="word-content"><i>choose</i></span> <span class="word-content">to</span> <span class="word-content">be</span> <span class="word-content">brave,</span> <span class="word-content">especially</span> <span class="word-content">when</span> <span class="word-content">it's</span> <span class="word-content">hard.</span> <span class="word-content">Character</span> <span class="word-content">is</span> <span class="word-content">revealed</span> <span class="word-content">through</span> <span class="word-content">action</span> <span class="word-content">and</span> <span class="word-content">choice,</span> <span class="word-content">especially</span> <span class="word-content">choices</span> <span class="word-content">made</span> <span class="word-content">under</span> <span class="word-content">pressure.</span> <span class="word-content">The</span> <span class="word-content">harder</span> <span class="word-content">the</span> <span class="word-content">choice,</span> <span class="word-content">the</span> <span class="word-content">more</span> <span class="word-content">we</span> <span class="word-content">learn</span> <span class="word-content">about</span> <span class="word-content">who</span> <span class="word-content">they</span> <span class="word-content">really</span> <span class="word-content">are.</span> <span class="word-content">A</span> <span class="word-content">character</span> <span class="word-content">who</span> <span class="word-content">chooses</span> <span class="word-content">to</span> <span class="word-content">run</span> <span class="word-content">into</span> <span class="word-content">a</span> <span class="word-content">burning</span> <span class="word-content">building</span> <span class="word-content">is</span> <span class="word-content">defined</span> <span class="word-content">by</span> <span class="word-content">that</span> <span class="word-content">action</span> <span class="word-content">in</span> <span class="word-content">a</span> <span class="word-content">way</span> <span class="word-content">no</span> <span class="word-content">amount</span> <span class="word-content">of</span> <span class="word-content">descriptive</span> <span class="word-content">prose</span> <span class="word-content">ever</span> <span class="word-content">could.</span></p>
                
                <p id="p-8"><span class="word-content">Ultimately,</span> <span class="word-content">an</span> <span class="word-content">unforgettable</span> <span class="word-content">character</span> <span class="word-content">feels</span> <span class="word-content"><b>real</b>.</span> <span class="word-content">They</span> <span class="word-content">are</span> <span class="word-content">a</span> <span class="word-content">bundle</span> <span class="word-content">of</span> <span class="word-content">contradictions,</span> <span class="word-content">flaws,</span> <span class="word-content">desires,</span> <span class="word-content">and</span> <span class="word-content">secrets,</span> <span class="word-content">just</span> <span class="word-content">like</span> <span class="word-content">us.</span> <span class="word-content">By</span> <span class="word-content">digging</span> <span class="word-content">deep</span> <span class="word-content">into</span> <span class="word-content">their</span> <span class="word-content">past,</span> <span class="word-content">understanding</span> <span class="word-content">their</span> <span class="word-content">internal</span> <span class="word-content">conflicts,</span> <span class="word-content">and</span> <span class="word-content">letting</span> <span class="word-content">them</span> <span class="word-content">express</span> <span class="word-content"> themselves</span> <span class="word-content">through</span> <span class="word-content">a</span> <span class="word-content">unique</span> <span class="word-content">voice,</span> <span class="word-content">you</span> <span class="word-content">can</span> <span class="word-content">create</span> <span class="word-content">characters</span> <span class="word-content">that</span> <span class="word-content">readers</span> <span class="word-content">will</span> <span class="word-content">carry</span> <span class="word-content">with</span> <span class="word-content">them</span> <span class="word-content">long</span> <span class="word-content">after</span> <span class="word-content">the</span> <span class="word-content">final</span> <span class="word-content">page.</span></p>
            </article>

            <section class="comments-wrapper" id="comments">
                <h2>ðŸ’¬ Join the Conversation (<span id="comment-count">0</span> Comments)</h2>

                <div id="auth-prompt" class="auth-prompt">
                    <h3>Join the discussion!</h3>
                    <p>Sign in to post, like, and reply with a verified profile, or comment as a guest.</p>
                    <button id="google-sign-in-btn" class="btn-primary" style="background: #DB4437; background-image: none;">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                    <a href="#" id="guest-comment-link" class="guest-comment-link">Or, comment as a Guest User (No likes/replies)</a>
                    <p id="auth-status" style="margin-top: 1rem; font-size: 0.9rem;"></p>
                </div>
                
                <div class="comment-form-container" id="comment-form-container" style="display: none;">
                    <h3>Leave a Comment As <span id="current-user-name" style="color: var(--link-color);"></span></h3>
                    <form id="comment-form">
                        <div id="guest-name-input" style="display: none; margin-bottom: 1rem;">
                            <label for="guest-name-field" class="form-label">Your Name <span style="color: red;">*</span></label>
                            <input type="text" id="guest-name-field" class="form-input" placeholder="Enter a name to display" required>
                        </div>
                        
                        <div class="comment-editor-toolbar">
                            <button type="button" data-format="bold" aria-label="Bold"><i class="fas fa-bold"></i></button>
                            <button type="button" data-format="italic" aria-label="Italic"><i class="fas fa-italic"></i></button>
                            <button type="button" data-format="link" aria-label="Insert Link"><i class="fas fa-link"></i></button>
                            <span style="margin-left: auto; font-size: 0.9rem; color: #777;">**bold**, _italic_</span>
                        </div>
                        
                        <div>
                            <label for="comment-input-text" class="form-label">Share your thoughts <span style="color: red;">*</span></label>
                            <textarea id="comment-input-text" class="form-input" placeholder="What did you think? (Supports **bold**, _italics_, and line breaks!)" required></textarea>
                        </div>
                        <button type="submit" id="comment-button" class="btn-primary">
                            <i class="fas fa-paper-plane"></i> Post Comment
                        </button>
                    </form>
                </div>

                <div id="comment-list-container">
                    <div id="comment-list">
                        <p class="loading-message" style="text-align: center; color: #777;">Loading comments...</p>
                    </div>
                </div>

            </section>

        </div>
    </main>

    <div id="audio-widget-container">
        <div id="widget-voice-display">Ready to play.</div>
        <div class="widget-controls">
            <button id="widget-play-pause-btn" class="btn-primary" aria-label="Play audio">
                <i class="fas fa-play"></i>
            </button>
            <div class="widget-progress-info">
                <div class="widget-progress-container" id="widget-progress-container">
                    <div id="widget-audio-progress-bar"></div>
                </div>
                <div class="widget-time-info">
                    <span id="widget-current-time">0:00</span>
                    <span id="widget-duration">0:00</span>
                </div>
            </div>
            <button id="widget-close-btn" class="btn-primary" style="background: #dc3545; background-image: none; width: 45px; height: 45px; border-radius: 50%; padding: 0;" aria-label="Close audio player">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>


    <footer class="footer">
        <div class="container">
            <div class="col">
                <span class="brand-info">Elvion AI</span>
                <p>Where Assistance Meets Excellence.</p>
            </div>
            <div class="col">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="https://elvionai.github.io/index.html#hero">Home</a></li>
                    <li><a href="https://elvionai.github.io/blog.html">Blog</a></li>
                    <li><a href="https://elvionai.github.io/university.html">University</a></li>
                </ul>
            </div>
            <div class="col">
                <h4>Company</h4>
                <ul>
                    <li><a href="https://elvionai.github.io/about.html">About Us</a></li>
                    <li><a href="mailto:contact@elvionai.com">Contact Us</a></li>
                </ul>
            </div>
            <div class="col">
                <h4>Legal</h4>
                <ul>
                    <li><a href="https://elvionai.github.io/privacy.html">Privacy Policy</a></li>
                    <li><a href="https://elvionai.github.io/terms.html">Terms of Service</a></li>
                </ul>
            </div>
            <div class="legal-info">
                &copy; <span id="current-year-footer"></span> Elvion AI. All rights reserved.
            </div>
        </div>
    </footer>

    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js"></script>
    
    <script>
        // --- THEME TOGGLE & NAV SCRIPT (Existing) ---
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');
            const hamburger = document.querySelector('.hamburger');
            const navLinks = document.querySelector('.nav-links');

            const savedTheme = localStorage.getItem('theme') || 'dark';

            function applyTheme(theme) {
                if (theme === 'light') {
                    body.classList.add('light-theme');
                    toggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    body.classList.remove('light-theme');
                    toggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                }
                localStorage.setItem('theme', theme);
            }

            applyTheme(savedTheme);

            toggleButton.addEventListener('click', () => {
                const currentTheme = body.classList.contains('light-theme') ? 'light' : 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
            });

            hamburger.addEventListener('click', () => {
                hamburger.classList.toggle('active');
                navLinks.classList.toggle('active');
            });
            navLinks.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 992) {
                        hamburger.classList.remove('active');
                        navLinks.classList.remove('active');
                    }
                });
            });

            document.getElementById('current-year-footer').textContent = new Date().getFullYear();
        });
    </script>
    
    <script>
        // --- NEW: WORD-FOR-WORD TEXT TO SPEECH SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {
            const voiceSelect = document.getElementById('voice-select');
            const speedSelect = document.getElementById('speed-select');
            const articleContent = document.getElementById('article-content');
            const estimatedTimeEl = document.getElementById('estimated-time');
            
            // Widget Elements
            const widgetContainer = document.getElementById('audio-widget-container');
            const widgetPlayPauseBtn = document.getElementById('widget-play-pause-btn');
            const widgetCloseBtn = document.getElementById('widget-close-btn');
            const widgetProgressBar = document.getElementById('widget-audio-progress-bar');
            const widgetProgressContainer = document.getElementById('widget-progress-container');
            const widgetCurrentTimeEl = document.getElementById('widget-current-time');
            const widgetDurationEl = document.getElementById('widget-duration');
            const widgetVoiceDisplay = document.getElementById('widget-voice-display');

            // Data
            const WPM = 200; 
            const ALL_WORD_SPANS = Array.from(articleContent.querySelectorAll('.word-content'));
            const TOTAL_WORD_COUNT = ALL_WORD_SPANS.length;
            
            let audio = new Audio();
            let isPlaying = false;
            let currentWordIndex = -1;
            let currentTTSDuration = 0; // Duration of the currently selected audio track (seconds)
            let wordTimings = []; // Array of {start: 0.0, end: 0.1, index: 0}

            // --- 1. Content & Timing Pre-processing ---
            
            function formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min}:${sec.toString().padStart(2, '0')}`;
            }
            
            function calculateReadTime() {
                const readTimeMinutes = Math.ceil(TOTAL_WORD_COUNT / WPM);
                estimatedTimeEl.innerHTML = `<i class="fas fa-clock"></i> ${readTimeMinutes} min read`;
            }
            
            // NEW: Simplified word timing simulation (Word-for-word)
            function generateWordTimings(duration) {
                if (TOTAL_WORD_COUNT === 0 || duration === 0) return [];

                const averageWordTime = duration / TOTAL_WORD_COUNT;
                const timings = [];
                let currentTime = 0;

                for (let i = 0; i < TOTAL_WORD_COUNT; i++) {
                    const wordDuration = averageWordTime; // Simplified: assume equal time per word
                    const endTime = currentTime + wordDuration;

                    timings.push({
                        start: currentTime,
                        end: endTime,
                        index: i
                    });
                    currentTime = endTime;
                }
                return timings;
            }
            
            // --- 2. Player Controls & Highlighting ---
            
            function removeHighlighting() {
                ALL_WORD_SPANS.forEach(span => span.classList.remove('tts-highlight'));
            }
            
            function updateWidgetDisplay() {
                 widgetContainer.classList.add('active');
                 const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
                 widgetVoiceDisplay.textContent = selectedOption.text;
            }

            function resetPlayer() {
                isPlaying = false;
                widgetPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                widgetPlayPauseBtn.setAttribute('aria-label', 'Play audio');
                audio.pause();
                audio.currentTime = 0; 
                widgetProgressBar.style.width = '0%';
                widgetCurrentTimeEl.textContent = '0:00';
                removeHighlighting();
                currentWordIndex = -1;
            }
            
            function seekAudio(event) {
                if (!audio.src || isNaN(audio.duration) || audio.duration === 0) return;
                const rect = widgetProgressContainer.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const width = rect.width;
                const seekTime = (clickX / width) * audio.duration;
                audio.currentTime = seekTime;
                
                // Jump to nearest word for visual sync after seeking
                highlightWordByTime(seekTime);
            }
            
            function highlightWordByTime(time) {
                if (wordTimings.length === 0) return;

                // Find the word that corresponds to the current time
                const targetWord = wordTimings.find(t => time >= t.start && time < t.end);
                
                let targetIndex = targetWord ? targetWord.index : -1;
                
                // If past the last word, set index to -1 to clear highlight
                if (time >= currentTTSDuration) {
                    targetIndex = -1;
                }

                if (targetIndex !== currentWordIndex) {
                    removeHighlighting();
                    currentWordIndex = targetIndex;
                    
                    if (currentWordIndex >= 0 && currentWordIndex < ALL_WORD_SPANS.length) {
                        const wordSpan = ALL_WORD_SPANS[currentWordIndex];
                        wordSpan.classList.add('tts-highlight');
                        
                        // Scroll logic: Scroll parent element into view (p, li, blockquote)
                        const parentEl = wordSpan.closest('p, li, blockquote');
                        if (parentEl) {
                            const rect = parentEl.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            
                            // Scroll if the element is out of the middle 50% of the viewport
                            if (rect.top < viewportHeight * 0.25 || rect.bottom > viewportHeight * 0.75) {
                                parentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    }
                }
            }
            
            function updateProgress() {
                if (isNaN(audio.duration) || audio.duration === 0) return;
                const progress = (audio.currentTime / audio.duration) * 100;
                widgetProgressBar.style.width = `${progress}%`;
                widgetCurrentTimeEl.textContent = formatTime(audio.currentTime);
                
                // Advanced Word Highlighting
                highlightWordByTime(audio.currentTime);
            }

            // --- 3. Event Listeners ---

            voiceSelect.addEventListener('change', () => {
                resetPlayer(); // Reset audio on voice change
                
                const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
                const audioSrc = selectedOption.value;
                currentTTSDuration = parseFloat(selectedOption.dataset.duration || 0);

                if (audioSrc && currentTTSDuration > 0) {
                    audio.src = audioSrc;
                    
                    // Generate word timings based on the actual duration
                    wordTimings = generateWordTimings(currentTTSDuration);

                    widgetDurationEl.textContent = formatTime(currentTTSDuration);
                    updateWidgetDisplay(); 
                    audio.playbackRate = parseFloat(speedSelect.value);

                    // Auto-play might be jarring, so just set to 'Ready'
                    widgetVoiceDisplay.textContent = `Ready: ${selectedOption.text}`;
                } else {
                    widgetContainer.classList.remove('active');
                }
            });
            
            speedSelect.addEventListener('change', () => {
                audio.playbackRate = parseFloat(speedSelect.value);
                if(isPlaying) {
                    widgetVoiceDisplay.textContent = `${voiceSelect.options[voiceSelect.selectedIndex].text} @ ${speedSelect.value}x speed...`;
                }
            });

            widgetPlayPauseBtn.addEventListener('click', () => {
                if (!audio.src) return;
                
                if (!isPlaying) {
                    isPlaying = true;
                    audio.play().catch(e => console.error("Audio play failed:", e));
                    widgetPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    widgetPlayPauseBtn.setAttribute('aria-label', 'Pause audio');
                    widgetVoiceDisplay.textContent = `${voiceSelect.options[voiceSelect.selectedIndex].text} @ ${audio.playbackRate}x speed...`;
                } else {
                    isPlaying = false;
                    audio.pause();
                    widgetPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    widgetPlayPauseBtn.setAttribute('aria-label', 'Play audio');
                    widgetVoiceDisplay.textContent = "Paused";
                }
            });
            
            widgetCloseBtn.addEventListener('click', () => {
                resetPlayer();
                widgetContainer.classList.remove('active');
                voiceSelect.selectedIndex = 0; // Reset voice selector
            });

            widgetProgressContainer.addEventListener('click', seekAudio);
            
            audio.addEventListener('loadedmetadata', () => {
                // Ensure duration is set if it wasn't pre-loaded from data-duration (fallback)
                if (audio.duration && currentTTSDuration === 0) {
                    currentTTSDuration = audio.duration;
                    widgetDurationEl.textContent = formatTime(audio.duration);
                    wordTimings = generateWordTimings(currentTTSDuration);
                }
            });
            
            audio.addEventListener('timeupdate', updateProgress);
            
            audio.onended = () => {
                resetPlayer();
                widgetVoiceDisplay.textContent = "Finished reading.";
            };
            
            // Initial load
            calculateReadTime();
        });
    </script>
    
    <script>
        // --- COMMENT EDITOR TOOLBAR LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // Expose formatting function globally for use by the generic toolbar listener
            window.applyFormatting = (textarea, format) => {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                let formattedText = selectedText;
                let wrap = '';

                switch (format) {
                    case 'bold':
                        wrap = '**';
                        formattedText = wrap + selectedText + wrap;
                        break;
                    case 'italic':
                        wrap = '_';
                        formattedText = wrap + selectedText + wrap;
                        break;
                    case 'link':
                        const linkUrl = prompt("Enter URL:", "https://");
                        if (linkUrl) {
                            const linkText = selectedText || "link text";
                            formattedText = `[${linkText}](${linkUrl})`;
                        } else {
                            return;
                        }
                        break;
                }

                textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
                textarea.focus();
                
                if (wrap && selectedText === "") {
                    textarea.selectionStart = start + wrap.length;
                    textarea.selectionEnd = start + wrap.length;
                } else if (wrap || format === 'link') {
                    textarea.selectionStart = start;
                    textarea.selectionEnd = start + formattedText.length;
                }
            };
            
            document.querySelectorAll('.comment-editor-toolbar button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const format = e.currentTarget.dataset.format;
                    // Find the closest textarea (either main comment or reply/edit form)
                    const formContainer = e.currentTarget.closest('.comment-form-container') || e.currentTarget.closest('.reply-form-container');
                    
                    let textarea;
                    if (formContainer.id === 'comment-form-container') {
                         textarea = document.getElementById('comment-input-text');
                    } else if (formContainer) {
                         // Must be a reply/edit form
                         textarea = formContainer.querySelector('textarea');
                    }
                    
                    if (textarea && window.applyFormatting) {
                        window.applyFormatting(textarea, format);
                    }
                });
            });
        });
    </script>


    <script type="module">
        // --- FIREBASE/COMMENT SCRIPT ---
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, query, where, 
            onSnapshot, doc, arrayUnion, arrayRemove, runTransaction, serverTimestamp, 
            setDoc, deleteDoc, getDoc 
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

        // --- 0. CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
            authDomain: "elvionai.firebaseapp.com",
            projectId: "elvionai",
            storageBucket: "elvionai.firebasestorage.app",
            messagingSenderId: "161078300830",
            appId: "1:161078300830:web:f460df8591704eb0e96b8f"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const ARTICLE_ID = 'crafting-characters-01';
        
        const ADMIN_EMAIL = 'koladhino@gmail.com'; 

        // --- 1. DOM Elements (omitted for brevity, assume linked correctly) ---
        const commentForm = document.getElementById('comment-form');
        const commentTextInput = document.getElementById('comment-input-text');
        const commentList = document.getElementById('comment-list');
        const commentCountEl = document.getElementById('comment-count');
        const submitBtn = document.getElementById('comment-button');
        const authPrompt = document.getElementById('auth-prompt');
        const commentFormContainer = document.getElementById('comment-form-container');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const currentUserNameEl = document.getElementById('current-user-name');
        const guestCommentLink = document.getElementById('guest-comment-link');
        const guestNameInputDiv = document.getElementById('guest-name-input');
        const guestNameField = document.getElementById('guest-name-field');
        
        let currentUser = null;
        let isGuestMode = false;
        let currentReplyToId = null; 

        // --- 2. Authentication & Guest Logic (SetAuthState now checks Admin status) ---
        
        function setAuthState(user) {
            currentUser = user;
            
            document.querySelectorAll('.reply-form-container').forEach(el => el.remove());
            currentReplyToId = null; 

            if (user) {
                isGuestMode = false;
                authPrompt.style.display = 'none';
                commentFormContainer.style.display = 'block';
                currentUserNameEl.textContent = user.displayName || user.email;
                guestNameInputDiv.style.display = 'none';
                guestNameField.removeAttribute('required');
                guestNameField.value = ''; 
            } else {
                if (!isGuestMode) {
                    authPrompt.style.display = 'block';
                    commentFormContainer.style.display = 'none';
                    currentUserNameEl.textContent = 'Guest';
                    guestNameInputDiv.style.display = 'none';
                } else {
                    authPrompt.style.display = 'none';
                    commentFormContainer.style.display = 'block';
                    currentUserNameEl.textContent = 'Guest User';
                    guestNameInputDiv.style.display = 'block';
                    guestNameField.setAttribute('required', 'required');
                }
            }
            loadComments(); 
        }

        guestCommentLink.addEventListener('click', (e) => {
            e.preventDefault();
            isGuestMode = true;
            setAuthState(null); 
            guestNameField.focus();
        });

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
            }
        });
        
        onAuthStateChanged(auth, user => {
            setAuthState(user);
        });

        // --- 3. Comment Display & Actions (Updated for Admin Delete) ---
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'comment';

            if (comment.parentId) {
                div.classList.add('reply');
            }
            
            const userName = escapeHtml(comment.userName) || 'Anonymous';
            const initial = userName.charAt(0).toUpperCase();
            
            let timestampString;
            if (comment.timestamp && typeof comment.timestamp.toDate === 'function') {
                timestampString = new Date(comment.timestamp.toDate()).toLocaleString();
            } else if (comment.timestamp) {
                const date = comment.timestamp || new Date(); 
                timestampString = date instanceof Date ? date.toLocaleString() : 'Just now';
            } else {
                timestampString = 'Pending...';
            }
            
            let badge = '';
            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
            
            if (comment.userEmail === ADMIN_EMAIL) {
                 // NEW: Apply glowing admin badge
                 badge = '<span class="admin-verified-badge" title="Verified Admin"><i class="fas fa-crown"></i></span>';
            } else if (comment.userId && comment.userId !== 'guest') {
                // Standard Verified Badge
                badge = '<span class="verified-badge" title="Verified User"><i class="fas fa-check"></i></span>';
            } else {
                badge = '<span class="guest-badge" title="Guest User"><i class="fas fa-user-tag"></i> Guest</span>';
            }
            
            const isLiked = currentUser && !isGuestMode && comment.likes && comment.likes.includes(currentUser.uid);
            const likeCount = comment.likes ? comment.likes.length : 0;
            
            const canPerformAction = currentUser && !isGuestMode; 
            const actionDisabled = !canPerformAction; 
            
            // Can modify if they are the poster OR if the current user is an Admin
            const canModify = (currentUser && comment.userId === currentUser.uid) || isAdmin;
            const canDelete = canModify; // Admin can delete anyone's comment. User can delete their own.

            const processedText = formatCommentText(comment.text);
            
            div.innerHTML = `
                <div class="comment-avatar">${initial}</div>
                <div class="comment-content" style="flex-grow: 1;" data-comment-id="${comment.id}">
                    <span class="comment-user">${userName}</span>${badge}
                    ${comment.editedAt ? '<span class="guest-badge" style="margin-left: 5px;">(edited)</span>' : ''}
                    <p class="comment-text">${processedText}</p>
                    <div class="comment-meta">ðŸ• ${timestampString}</div>
                    <div class="comment-actions">
                        <button class="like-btn ${isLiked ? 'liked' : ''}" data-comment-id="${comment.id}" ${actionDisabled ? 'disabled' : ''}>
                            <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> 
                            <span>Like</span> (<span class="like-count">${likeCount}</span>)
                        </button>
                        <button class="reply-btn" data-comment-id="${comment.id}" ${actionDisabled ? 'disabled' : ''}>
                            <i class="fas fa-reply"></i> Reply
                        </button>
                        ${canModify ? `<button class="edit-btn" data-comment-id="${comment.id}"><i class="fas fa-edit"></i> Edit</button>` : ''}
                        ${canDelete ? `<button class="delete-btn" data-comment-id="${comment.id}" style="color: #dc3545;"><i class="fas fa-trash-alt"></i> Delete</button>` : ''}
                    </div>
                    
                    </div>
            `;
            
            // Add listeners for actions
            const likeBtn = div.querySelector('.like-btn');
            if (likeBtn && !actionDisabled) {
                likeBtn.addEventListener('click', () => toggleLike(comment.id, likeBtn));
            }
            
            const editBtn = div.querySelector('.edit-btn');
            if (editBtn) {
                editBtn.addEventListener('click', () => handleEditButtonClick(comment.id, comment.text));
            }
            
            const deleteBtn = div.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => deleteComment(comment.id));
            }
            
            return div;
        }

        function renderComments(comments) {
            commentList.innerHTML = '';
            
            const topLevelComments = comments.filter(c => !c.parentId);
            const repliesByParentId = comments
                .filter(c => c.parentId)
                .reduce((acc, reply) => {
                    acc[reply.parentId] = acc[reply.parentId] || [];
                    acc[reply.parentId].push(reply);
                    return acc;
                }, {});

            topLevelComments.forEach(comment => {
                const topEl = createCommentElement(comment);
                commentList.appendChild(topEl);
                
                const replyBtn = topEl.querySelector('.reply-btn');
                if (replyBtn) {
                     replyBtn.addEventListener('click', (e) => handleReplyButtonClick(e));
                }

                const replies = repliesByParentId[comment.id] || [];
                replies.forEach(reply => {
                    const replyEl = createCommentElement(reply);
                    commentList.appendChild(replyEl); 
                    
                    const nestedReplyBtn = replyEl.querySelector('.reply-btn');
                    if (nestedReplyBtn) {
                        nestedReplyBtn.addEventListener('click', (e) => handleReplyButtonClick(e));
                    }
                });
            });

            if (comments.length === 0) {
                commentList.innerHTML = `
                    <div class="no-comments">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                        <p>No comments yet. Be the first to share your thoughts! ðŸŒŸ</p>
                    </div>
                `;
            }
        }


        function loadComments() {
             const q = query(collection(db, 'comments'), 
                             where('articleId', '==', ARTICLE_ID));

             commentList.innerHTML = `<p class="loading-message" style="text-align: center; color: #777;">Loading comments...</p>`;


             onSnapshot(q, (snapshot) => {
                    commentList.innerHTML = ''; 
                    
                    if (snapshot.empty) {
                        commentList.innerHTML = `
                            <div class="no-comments">
                                <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                                <p>No comments yet. Be the first to share your thoughts! ðŸŒŸ</p>
                            </div>
                        `;
                        commentCountEl.textContent = '0';
                        return;
                    }

                    commentCountEl.textContent = snapshot.size;
                    
                    const sortedDocs = snapshot.docs.sort((a, b) => {
                        const timeA = a.data().timestamp;
                        const timeB = b.data().timestamp;
                        
                        const dateA = timeA && timeA.toDate ? timeA.toDate() : new Date(0); 
                        const dateB = timeB && timeB.toDate ? timeB.toDate() : new Date(0);
                        
                        return dateB - dateA; // Sort descending (newest first)
                    });

                    const comments = sortedDocs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderComments(comments); 

                }, error => {
                    console.error("Error loading comments:", error);
                    commentList.innerHTML = `<p class="loading-message" style="color: red;">Failed to load comments. (Check Firestore Security Rules)</p>`;
                });
        }
        
        // --- 4. Comment Submission & Actions ---

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUser && !isGuestMode) {
                console.warn('User must sign in or choose to comment as a Guest!');
                return;
            }

            const commentText = commentTextInput.value.trim();

            if (!commentText) {
                console.warn('Comment text is empty.');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';

            let commentData = {};

            if (isGuestMode) {
                const guestName = guestNameField.value.trim();
                if (!guestName) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Comment';
                    return;
                }
                commentData = {
                    articleId: ARTICLE_ID,
                    userId: 'guest', 
                    userName: guestName,
                    userEmail: '', 
                    text: commentText,
                    timestamp: serverTimestamp(), 
                    likes: [] 
                };
            } else {
                commentData = {
                    articleId: ARTICLE_ID,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    userEmail: currentUser.email,
                    text: commentText,
                    timestamp: serverTimestamp(), 
                    likes: [] 
                };
            }

            try {
                await addDoc(collection(db, 'comments'), commentData);

                commentTextInput.value = '';
                guestNameField.value = ''; 

                if (isGuestMode) {
                    isGuestMode = false; 
                    setAuthState(auth.currentUser); 
                }

            } catch (error) {
                console.error('Error posting comment:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Post Comment';
            }
        });

        async function toggleLike(commentId, button) {
             if (!currentUser || isGuestMode) return;
             
             const commentRef = doc(db, 'comments', commentId);
             const userId = currentUser.uid;
             
             try {
                 await runTransaction(db, async (transaction) => {
                     const docSnapshot = await transaction.get(commentRef);
                     if (!docSnapshot.exists()) {
                         throw "Comment does not exist!";
                     }
                     
                     const data = docSnapshot.data();
                     const likes = data.likes || [];
                     const isCurrentlyLiked = likes.includes(userId);
                     
                     if (isCurrentlyLiked) {
                         transaction.update(commentRef, {
                             likes: arrayRemove(userId)
                         });
                     } else {
                         transaction.update(commentRef, {
                             likes: arrayUnion(userId)
                         });
                     }
                 });
             } catch (error) {
                 console.error("Transaction failed:", error);
             }
        }
        
        // NEW: Handler for dynamically created reply forms submission
        async function handleReplySubmit(e) {
            e.preventDefault();
            if (!currentUser || isGuestMode) return;

            const form = e.target;
            const parentId = form.dataset.parentId;
            const textarea = form.querySelector('textarea');
            const replyText = textarea.value.trim();
            const submitButton = form.querySelector('.btn-primary');

            if (!replyText) return;

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
            
            const replyData = {
                articleId: ARTICLE_ID,
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                userEmail: currentUser.email,
                text: replyText,
                timestamp: serverTimestamp(),
                likes: [],
                parentId: parentId 
            };

            try {
                await addDoc(collection(db, 'comments'), replyData);
            } catch (error) {
                console.error('Error posting reply:', error);
            } finally {
                form.closest('.reply-form-container').remove(); 
                currentReplyToId = null;
            }
        }
        
        // NEW: Function to create the dynamic reply form HTML
        function createReplyFormHtml(parentId) {
            const formContainer = document.createElement('div');
            formContainer.className = 'reply-form-container'; 
            formContainer.innerHTML = `
                <h4 style="font-size: 1.2rem; margin-top: 0; margin-bottom: 0.5rem; color: var(--heading-color);">
                    Replying to a comment as <span style="color: var(--link-color);">${currentUser.displayName || currentUser.email.split('@')[0]}</span>
                </h4>
                
                <div class="comment-editor-toolbar">
                    <button type="button" data-format="bold" aria-label="Bold"><i class="fas fa-bold"></i></button>
                    <button type="button" data-format="italic" aria-label="Italic"><i class="fas fa-italic"></i></button>
                    <button type="button" data-format="link" aria-label="Insert Link"><i class="fas fa-link"></i></button>
                    <span style="margin-left: auto; font-size: 0.9rem; color: #777;">**bold**, _italic_</span>
                </div>

                <form class="reply-form" data-parent-id="${parentId}">
                    <textarea class="form-input" placeholder="Your reply (supports **bold**, _italics_)..." required></textarea>
                    <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-paper-plane"></i> Post Reply
                    </button>
                    <button type="button" class="btn-cancel-reply btn-primary" style="background: #555; background-image: none; margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Cancel
                    </button>
                </form>
            `;
            
            const form = formContainer.querySelector('.reply-form');
            const cancelBtn = formContainer.querySelector('.btn-cancel-reply');
            const textarea = formContainer.querySelector('textarea');

            form.addEventListener('submit', handleReplySubmit);
            cancelBtn.addEventListener('click', () => {
                formContainer.remove();
                currentReplyToId = null;
            });

            // Re-apply toolbar listener for the dynamically created form
            formContainer.querySelectorAll('.comment-editor-toolbar button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const format = e.currentTarget.dataset.format;
                    // Use the existing global formatting logic 
                    if (window.applyFormatting) { 
                        window.applyFormatting(textarea, format);
                    }
                });
            });

            return formContainer;
        }
        
        // NEW: Handler for reply button click
        function handleReplyButtonClick(e) {
            e.preventDefault();
            if (!currentUser || isGuestMode) return; // Guard for unauthenticated users

            const replyBtn = e.currentTarget;
            const parentId = replyBtn.dataset.commentId;

            document.querySelectorAll('.reply-form-container').forEach(el => el.remove());
            
            if (currentReplyToId === parentId) {
                currentReplyToId = null;
                return;
            }

            const formEl = createReplyFormHtml(parentId);
            const commentContentDiv = replyBtn.closest('.comment-content');
            
            if (commentContentDiv) {
                commentContentDiv.appendChild(formEl);
                formEl.querySelector('textarea').focus();
                currentReplyToId = parentId;
            }
        }
        
        // NEW: Function to handle edit button click (shows a new form)
        function handleEditButtonClick(commentId, originalText) {
            document.querySelectorAll('.reply-form-container').forEach(el => el.remove());
            currentReplyToId = null; 

            const commentEl = document.querySelector(`.comment-content[data-comment-id="${commentId}"]`);
            if (!commentEl) return;
            
            const editContainer = document.createElement('div');
            editContainer.className = 'reply-form-container'; 
            editContainer.innerHTML = `
                <h4 style="font-size: 1.2rem; margin-top: 0; margin-bottom: 0.5rem; color: var(--heading-color);">
                    Editing Comment
                </h4>
                <div class="comment-editor-toolbar">
                    <button type="button" data-format="bold" aria-label="Bold"><i class="fas fa-bold"></i></button>
                    <button type="button" data-format="italic" aria-label="Italic"><i class="fas fa-italic"></i></button>
                    <button type="button" data-format="link" aria-label="Insert Link"><i class="fas fa-link"></i></button>
                    <span style="margin-left: auto; font-size: 0.9rem; color: #777;">**bold**, _italic_</span>
                </div>
                <form class="edit-form" data-comment-id="${commentId}">
                    <textarea class="form-input" required>${originalText}</textarea>
                    <button type="submit" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="btn-cancel-reply btn-primary" style="background: #555; background-image: none; margin-left: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Cancel
                    </button>
                </form>
            `;
            
            commentEl.appendChild(editContainer);
            const textarea = editContainer.querySelector('textarea');
            textarea.focus();

            editContainer.querySelector('.edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newText = textarea.value.trim();
                const submitButton = e.target.querySelector('.btn-primary');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                await updateComment(commentId, newText);
                editContainer.remove();
            });

            editContainer.querySelector('.btn-cancel-reply').addEventListener('click', () => {
                editContainer.remove();
            });
            
            // Re-apply toolbar listener for the dynamically created form
            editContainer.querySelectorAll('.comment-editor-toolbar button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const format = e.currentTarget.dataset.format;
                    // Use the existing global formatting logic 
                    if (window.applyFormatting) { 
                        window.applyFormatting(textarea, format);
                    }
                });
            });
        }
        
        // NEW: Firestore Update function (for editing)
        async function updateComment(commentId, newText) {
            if (!currentUser) return;
            const commentRef = doc(db, 'comments', commentId);
            
            try {
                await setDoc(commentRef, {
                    text: newText,
                    editedAt: serverTimestamp() 
                }, { merge: true });
            } catch (error) {
                console.error("Error updating comment:", error);
            }
        }

        // NEW: Firestore Delete function (FIXED with getDoc)
        async function deleteComment(commentId) {
            if (!currentUser) {
                 alert("You must be signed in to delete comments.");
                 return;
            }

            const commentRef = doc(db, 'comments', commentId);
            
            try {
                // 1. Check for authorization before proceeding
                const docSnapshot = await getDoc(commentRef); 
                if (!docSnapshot.exists()) {
                    alert("Comment not found.");
                    return;
                }
                
                const commentData = docSnapshot.data();
                const isCommentOwner = currentUser.uid === commentData.userId;
                const isAdmin = currentUser.email === ADMIN_EMAIL;
                
                if (!isCommentOwner && !isAdmin) {
                    alert("You are not authorized to delete this comment.");
                    return;
                }
            } catch (error) {
                 console.error("Error checking delete permissions:", error);
                 alert("Failed to verify user permissions.");
                 return;
            }
            
            if (!confirm("Are you sure you want to delete this comment? This action cannot be undone.")) return;
            
            try {
                // 2. Perform the deletion
                await deleteDoc(commentRef);
            } catch (error) {
                console.error("Error deleting comment:", error);
                alert("Failed to delete comment. Please check your Firestore security rules (if deletion is denied).");
            }
        }


        // --- 5. Utility Functions ---
        
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // UPDATED: Added [link](url) formatting
        function formatCommentText(text) {
            let safeText = escapeHtml(text);
            
            // Format bold: **text**
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            // Format italics: _text_
            safeText = safeText.replace(/_(.*?)_/g, '<i>$1</i>');
            // Format links: [text](url)
            safeText = safeText.replace(/\[([^\]]+)\]\((https?:\/\/[^\s\)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            // Format standalone links (fallback)
            safeText = safeText.replace(/(https?:\/\/[^\s]+)/g, (match) => {
                 // Check if it's already part of a markdown link
                 if (safeText.includes(`](${match})`)) return match;
                 return `<a href="${match}" target="_blank" rel="noopener noreferrer">${match}</a>`;
            });

            // Format line breaks
            safeText = safeText.replace(/\n/g, '<br>');
            
            return safeText;
        }

        // --- 6. Initialization (Handled by onAuthStateChanged) ---
    </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>
