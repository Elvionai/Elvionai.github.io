<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elvion Cover Studio</title>

  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:wght@400;700;900&family=Roboto:wght@300;400;700;900&family=Great+Vibes&family=Oswald:wght@400;700&family=Montserrat:wght@400;700;800&family=Merriweather:wght@400;700;900&family=Bebas+Neue&family=Orbitron:wght@400;700;900&family=Dancing+Script:wght@400;700&family=Lato:wght@400;700;900&family=Anton&family=Courier+Prime:wght@400;700&family=Times+New+Roman&display=swap" rel="stylesheet" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #38bdf8;
      --primary-soft: rgba(56, 189, 248, 0.15);
      --primary-strong: #0ea5e9;
      --accent: #a855f7;
      --bg: #020617;
      --bg-card: rgba(15, 23, 42, 0.9);
      --bg-soft: rgba(15, 23, 42, 0.8);
      --border-soft: rgba(148, 163, 184, 0.25);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #facc15;
    }

    body {
      font-family: "Roboto", sans-serif;
      background:
        radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.1) 0, transparent 40%),
        radial-gradient(circle at 90% 0%, rgba(168, 85, 247, 0.12) 0, transparent 55%),
        radial-gradient(circle at 50% 80%, rgba(34, 197, 94, 0.09) 0, transparent 60%),
        url("https://www.transparenttextures.com/patterns/stardust.png"),
        radial-gradient(circle at 50% 0%, #020617 0, #000 55%);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(18px);
      background: linear-gradient(
        to right,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.92),
        rgba(15, 23, 42, 0.98)
      );
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 900;
      font-size: 1.4rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .logo span {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #38bdf8, #a855f7, #22c55e, #38bdf8);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #020617;
      box-shadow: 0 0 25px rgba(56, 189, 248, 0.8);
    }

    .wallet {
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.6rem 1.3rem;
      border-radius: 999px;
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.4), rgba(15, 23, 42, 0.96));
      border: 1px solid rgba(56, 189, 248, 0.5);
      cursor: pointer;
      box-shadow: 0 10px 35px rgba(15, 23, 42, 0.8);
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }

    .wallet:hover {
      transform: translateY(-1px);
      border-color: rgba(56, 189, 248, 0.8);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.95);
    }

    .wallet svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .wallet-balance {
      font-weight: 800;
      font-size: 1.15rem;
    }

    .wallet-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.1em;
    }

    main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.75rem 1.25rem 3rem;
    }

    .hero {
      text-align: center;
      padding: 2.5rem 1rem 2rem;
      margin-bottom: 2rem;
    }

    .hero h1 {
      font-size: 2.6rem;
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(120deg, #e5e7eb, #38bdf8, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 45px rgba(56, 189, 248, 0.6));
      margin-bottom: 0.75rem;
    }

    .hero p {
      max-width: 600px;
      margin: 0.2rem auto 0;
      color: var(--muted);
      font-size: 0.98rem;
    }

    .section {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 1.6rem 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-soft);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(18px);
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--muted);
    }

    .section-title span {
      width: 8px;
      height: 24px;
      border-radius: 999px;
      background: linear-gradient(180deg, #38bdf8, #a855f7);
    }

    .section-title strong {
      color: var(--text);
      font-weight: 700;
    }

    .layout-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .layout-card {
      padding: 0.9rem 0.8rem;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.08), rgba(15, 23, 42, 0.9));
      text-align: center;
      cursor: pointer;
      transition: border-color 0.17s ease, background 0.17s ease, transform 0.17s ease, box-shadow 0.17s ease;
    }

    .layout-card:hover {
      border-color: rgba(56, 189, 248, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
    }

    .layout-card.active {
      border-color: rgba(56, 189, 248, 0.95);
      background: radial-gradient(circle at 10% -20%, rgba(56, 189, 248, 0.25), rgba(15, 23, 42, 0.95));
    }

    .layout-icon {
      font-size: 1.6rem;
      margin-bottom: 0.2rem;
    }

    .layout-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .workspace {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .canvas-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 520px;
      background:
        radial-gradient(circle at 10% 10%, rgba(56, 189, 248, 0.17), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(168, 85, 247, 0.18), transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 1), rgba(2, 6, 23, 1));
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid rgba(15, 23, 42, 0.9);
      position: relative;
      overflow: hidden;
    }

    .canvas-wrap::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(148, 163, 184, 0.15) 1px, transparent 1px),
        linear-gradient(90deg, rgba(148, 163, 184, 0.12) 1px, transparent 1px);
      background-size: 26px 26px;
      opacity: 0.4;
      pointer-events: none;
    }

    #c {
      box-shadow: 0 22px 70px rgba(0, 0, 0, 0.95);
      border-radius: 6px;
      background-color: #ffffff;
    }

    .canvas-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      justify-content: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.2rem;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .btn-primary {
      background: linear-gradient(120deg, #38bdf8, #0ea5e9);
      color: #020617;
      box-shadow: 0 12px 35px rgba(56, 189, 248, 0.5);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(56, 189, 248, 0.8);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, 0.9);
      box-shadow: 0 14px 35px rgba(15, 23, 42, 0.9);
    }

    .btn-accent {
      background: linear-gradient(120deg, #a855f7, #6366f1);
      color: #020617;
      box-shadow: 0 12px 35px rgba(99, 102, 241, 0.65);
    }

    .btn-danger {
      background: linear-gradient(120deg, #fb7185, #f97316);
      color: #020617;
      box-shadow: 0 10px 30px rgba(248, 113, 113, 0.6);
    }

    button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    input,
    select,
    textarea {
      padding: 0.6rem 0.7rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.86rem;
      font-family: "Roboto", sans-serif;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .char-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .char-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.45);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      background: radial-gradient(circle at 50% 0%, rgba(56, 189, 248, 0.12), rgba(15, 23, 42, 0.96));
    }

    .char-card:hover {
      transform: translateY(-2px);
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
    }

    .char-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .char-overlay {
      position: absolute;
      inset: auto 0 0 0;
      padding: 0.4rem;
      display: flex;
      gap: 0.3rem;
      justify-content: center;
      background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.85));
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }

    .char-card:hover .char-overlay {
      transform: translateY(0);
    }

    .chat-box {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 0.75rem;
    }

    .chat-msg {
      margin-bottom: 0.55rem;
      font-size: 0.85rem;
      line-height: 1.5;
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
    }

    .chat-msg.user {
      background: rgba(56, 189, 248, 0.12);
      border-left: 3px solid #38bdf8;
      margin-left: 1.2rem;
    }

    .chat-msg.bot {
      background: rgba(148, 163, 184, 0.15);
      border-left: 3px solid #a855f7;
      margin-right: 1.2rem;
    }

    .chat-input-row {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.4rem;
    }

    .chat-input-row input {
      flex: 1;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.25), transparent 55%),
        radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.25), transparent 60%),
        rgba(2, 6, 23, 0.98);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1300;
      backdrop-filter: blur(18px);
    }

    .modal.active {
      display: flex;
    }

    .scene {
      width: 420px;
      height: 620px;
      perspective: 2000px;
      margin-bottom: 1.5rem;
    }

    .book3d {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transform: rotateY(-24deg) rotateX(16deg);
      transition: transform 0.8s ease;
    }

    .face3d {
      position: absolute;
      background-size: cover;
      background-position: center;
      background-color: #0f172a;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
    }

    .front3d {
      width: 360px;
      height: 560px;
      transform: translateZ(18px);
      border-radius: 6px 3px 3px 6px;
    }

    .back3d {
      width: 360px;
      height: 560px;
      transform: rotateY(180deg) translateZ(18px);
      left: 0;
      border-radius: 3px 6px 6px 3px;
    }

    .spine3d {
      width: 36px;
      height: 560px;
      left: -18px;
      transform: rotateY(-90deg) translateZ(18px);
      background: radial-gradient(circle at 0 50%, rgba(56, 189, 248, 0.5), #020617);
    }

    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 1.5rem;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 10px;
      padding: 0.75rem 1.1rem;
      font-size: 0.85rem;
      border-left: 3px solid var(--primary);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.95);
      transform: translateX(140%);
      transition: transform 0.25s ease;
      max-width: 340px;
      z-index: 1500;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 10% 10%, rgba(56, 189, 248, 0.15), transparent 60%),
        radial-gradient(circle at 90% 90%, rgba(168, 85, 247, 0.2), transparent 55%),
        rgba(2, 6, 23, 0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1400;
      backdrop-filter: blur(12px);
    }

    .auth-box {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 2rem 2.25rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      max-width: 420px;
      width: 92%;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.9);
    }

    .auth-box h2 {
      text-align: center;
      margin-bottom: 0.4rem;
      font-size: 1.6rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .auth-subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 1.6rem;
    }

    .auth-btn {
      width: 100%;
      padding: 0.7rem 1rem;
      border-radius: 999px;
      border: none;
      margin-bottom: 0.6rem;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .auth-google {
      background: #ffffff;
      color: #111827;
    }

    .auth-twitter {
      background: #0ea5e9;
      color: #020617;
    }

    .auth-divider {
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
      margin: 0.8rem 0;
      position: relative;
    }

    .auth-divider::before,
    .auth-divider::after {
      content: "";
      position: absolute;
      top: 50%;
      width: 38%;
      height: 1px;
      background: rgba(148, 163, 184, 0.5);
    }

    .auth-divider::before {
      left: 0;
    }

    .auth-divider::after {
      right: 0;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 900px) {
      main {
        padding: 1.5rem 0.9rem 3rem;
      }

      header {
        flex-direction: column;
        gap: 0.6rem;
        align-items: flex-start;
      }

      .scene {
        width: 320px;
        height: 500px;
      }

      .front3d,
      .back3d {
        width: 280px;
        height: 440px;
      }

      .spine3d {
        height: 440px;
      }
    }
  </style>
</head>
<body>
  <!-- AUTH -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <h2>Elvion Studio</h2>
      <p class="auth-subtitle">Sign in to unlock your cover workspace.</p>

      <button class="auth-btn auth-google" onclick="signIn('google')">
        <span>G</span> Continue with Google
      </button>
      <button class="auth-btn auth-twitter" onclick="signIn('twitter')">
        <span>ùïè</span> Continue with Twitter
      </button>

      <div class="auth-divider">OR</div>

      <div class="form-group">
        <input id="authEmail" type="email" placeholder="Email address" />
      </div>
      <div class="form-group">
        <input id="authPassword" type="password" placeholder="Password (min 6 chars)" />
      </div>
      <button class="auth-btn btn-primary" style="background: linear-gradient(120deg,#38bdf8,#0ea5e9); color:#020617" onclick="signIn('email')">
        Email sign in / register
      </button>
      <p id="authError" style="color: var(--danger); font-size: 0.8rem; margin-top: 0.6rem;"></p>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

  <!-- 3D MODAL -->
  <div id="mockupModal" class="modal">
    <h3 style="text-transform: uppercase; letter-spacing: 0.18em; font-size: 0.9rem; margin-bottom: 0.8rem;">
      3D Book Preview
    </h3>
    <div class="scene">
      <div id="book3d" class="book3d">
        <div id="faceFront" class="face3d front3d"></div>
        <div id="faceSpine" class="face3d spine3d"></div>
        <div id="faceBack" class="face3d back3d"></div>
      </div>
    </div>
    <div style="display:flex; gap:0.6rem; flex-wrap:wrap;">
      <button class="btn-secondary" onclick="rotateBook('front')">Front</button>
      <button class="btn-secondary" onclick="rotateBook('spine')">Spine</button>
      <button class="btn-secondary" onclick="rotateBook('full')">Full</button>
      <button class="btn-danger" onclick="closeMockup()">Close</button>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="logo">
      <span>Œ¶</span>
      <div>
        ELVION<br />
        <small style="font-size:0.7rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted);">
          Cover Studio
        </small>
      </div>
    </div>
    <div class="wallet" onclick="fundWallet()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="5" width="18" height="14" rx="2"></rect>
        <path d="M3 10h18"></path>
        <circle cx="17" cy="13" r="1.2"></circle>
      </svg>
      <div>
        <div class="wallet-balance" id="creditDisplay">--</div>
        <div class="wallet-label">Credits</div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main id="mainContent">
    <section class="hero">
      <h1>Author Cover Forge</h1>
      <p>Generate, edit, and mock up professional book covers in one continuous Elvion-inspired workspace.</p>
    </section>

    <!-- CANVAS / LAYOUT -->
    <section class="section">
      <div class="section-title">
        <span></span><strong>Design Canvas</strong>
      </div>

      <div class="layout-row">
        <div class="layout-card active" data-mode="front" onclick="setCanvasMode('front', this)">
          <div class="layout-icon">üìï</div>
          <div class="layout-label">Front Cover 600√ó900</div>
        </div>
        <div class="layout-card" data-mode="full" onclick="setCanvasMode('full', this)">
          <div class="layout-icon">üìò</div>
          <div class="layout-label">Full Wrap 1300√ó900</div>
        </div>
      </div>

      <div class="workspace">
        <div class="canvas-wrap">
          <canvas id="c"></canvas>
        </div>
        <div class="canvas-actions">
          <button class="btn-primary" onclick="addText()">Ôºã Text</button>
          <button class="btn-secondary" onclick="toggleBrush()">Brush / Erase</button>
          <button class="btn-secondary" onclick="removeBackground()">Remove BG</button>
          <button class="btn-accent" onclick="openMockup()">3D Preview</button>
          <button class="btn-secondary" onclick="saveProject()">Save</button>
          <button class="btn-secondary" onclick="downloadCover()">Download</button>
          <button class="btn-danger" onclick="clearCanvas()">Clear</button>
        </div>
      </div>
    </section>

    <!-- TEXT TOOLS -->
    <section class="section">
      <div class="section-title">
        <span></span><strong>Typography</strong>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Font Family</label>
          <select id="fontFamily" onchange="updateText('fontFamily', this.value)">
            <option value="Cinzel">Cinzel</option>
            <option value="Playfair Display">Playfair Display</option>
            <option value="Bebas Neue">Bebas Neue</option>
            <option value="Great Vibes">Great Vibes</option>
            <option value="Oswald">Oswald</option>
            <option value="Orbitron">Orbitron</option>
            <option value="Roboto">Roboto</option>
            <option value="Anton">Anton</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Merriweather">Merriweather</option>
            <option value="Lato">Lato</option>
            <option value="Dancing Script">Dancing Script</option>
            <option value="Times New Roman">Times New Roman</option>
            <option value="Courier Prime">Courier Prime</option>
          </select>
        </div>
        <div class="form-group">
          <label>Font Size</label>
          <input id="fontSizeRange" type="range" min="10" max="200" value="60" oninput="updateText('fontSize', parseInt(this.value))" />
        </div>
        <div class="form-group">
          <label>Fill Color</label>
          <input type="color" value="#ffffff" onchange="updateText('fill', this.value)" />
        </div>
        <div class="form-group">
          <label>Stroke Color</label>
          <input type="color" value="#000000" onchange="updateText('stroke', this.value)" />
        </div>
        <div class="form-group">
          <label>Stroke Width</label>
          <input id="strokeRange" type="range" min="0" max="15" value="0" oninput="updateText('strokeWidth', parseInt(this.value))" />
        </div>
      </div>
      <div style="margin-top:0.7rem; display:flex; gap:0.6rem; flex-wrap:wrap;">
        <button class="btn-secondary" onclick="bringToFront()">Bring Front</button>
        <button class="btn-secondary" onclick="sendToBack()">Send Back</button>
        <button class="btn-danger" onclick="deleteSelected()">Delete Selected</button>
      </div>
    </section>

    <!-- AI GENERATION -->
    <section class="section">
      <div class="section-title">
        <span></span><strong>AI Cover Generation</strong>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Model</label>
          <select id="aiModel">
            <option value="v6">Thena V6 (High Quality)</option>
            <option value="photoreal">Photoreal</option>
            <option value="movie">Cinematic</option>
            <option value="illustration">Illustration</option>
            <option value="anime_core">Anime Core</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Describe your cover</label>
        <textarea id="genPrompt" placeholder="Example: A worship-themed cover with a praying figure, deep green light beams, dark background, elegant serif title, cinematic lighting."></textarea>
      </div>
      <div style="display:flex; gap:0.6rem; flex-wrap:wrap; margin-bottom:0.6rem;">
        <button class="btn-secondary" onclick="requestPromptIdea()">Prompt Idea</button>
        <button id="btnGenCover" class="btn-primary" onclick="generateCover()">Generate Cover (20 credits)</button>
      </div>
      <div style="font-size:0.8rem; color:var(--muted);">
        <span id="coverLimitStatus">Covers today: --/2</span>
      </div>
    </section>

    <!-- CHARACTERS -->
    <section class="section">
      <div class="section-title">
        <span></span><strong>Persistent Characters</strong>
      </div>
      <div id="charGrid" class="char-grid">
        <p style="grid-column:1/-1; text-align:center; color:var(--muted); font-size:0.85rem;">
          No characters yet. Generate one and reuse across covers.
        </p>
      </div>
      <button class="btn-accent" style="margin-top:0.8rem; width:100%;" onclick="generateCharacter()">
        New Character (10 credits)
      </button>
      <div style="font-size:0.8rem; color:var(--muted); margin-top:0.5rem;">
        <span id="charLimitStatus">Characters saved: 0</span>
      </div>
    </section>

    <!-- CHAT -->
    <section class="section">
      <div class="section-title">
        <span></span><strong>Bobby Assistant</strong>
      </div>
      <div id="chatBox" class="chat-box">
        <div class="chat-msg bot">
          Bobby: Hi! Ask me for prompt ideas, layout suggestions, or cover feedback.
        </div>
      </div>
      <div class="chat-input-row">
        <input id="chatInput" type="text" placeholder="Ask Bobby anything..." onkeypress="if(event.key==='Enter'){sendChat()}" />
        <button class="btn-primary" onclick="sendChat()">Send</button>
      </div>
    </section>
  </main>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const API_URL = "https://web-production-9a18.up.railway.app";
    const SUPER_ADMIN_EMAIL = "Koladhino@gmail.com";

    let currentUser = null;
    let authToken = null;
    let credits = 0;
    let canvas;
    let isBrushMode = false;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        authToken = await user.getIdToken();
        document.getElementById("authOverlay").classList.add("hidden");
        await fetchCredits();
        initCanvas();
        loadProject();
        loadCharacters();
        updateLimits();
      } else {
        currentUser = null;
        authToken = null;
        document.getElementById("authOverlay").classList.remove("hidden");
      }
    });

    async function signIn(method) {
      const errEl = document.getElementById("authError");
      errEl.textContent = "";
      try {
        if (method === "google") {
          await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
        } else if (method === "twitter") {
          await auth.signInWithPopup(new firebase.auth.TwitterAuthProvider());
        } else if (method === "email") {
          const email = document.getElementById("authEmail").value.trim();
          const pw = document.getElementById("authPassword").value.trim();
          if (!email || !pw || pw.length < 6) {
            throw new Error("Enter valid email and password (min 6 chars)");
          }
          try {
            await auth.signInWithEmailAndPassword(email, pw);
          } catch (e) {
            if (e.code === "auth/user-not-found") {
              await auth.createUserWithEmailAndPassword(email, pw);
              showToast("Account created, signed in.", "success");
            } else {
              throw e;
            }
          }
        }
      } catch (e) {
        errEl.textContent = e.message.replace("Firebase: ", "");
      }
    }

    async function fetchWithAuth(endpoint, options = {}) {
      if (!currentUser) {
        showToast("Please sign in first", "error");
        return null;
      }
      authToken = await currentUser.getIdToken(true);
      const headers = {
        "X-Firebase-Token": authToken,
        ...(options.headers || {}),
      };
      if (options.body && !(options.body instanceof FormData)) {
        headers["Content-Type"] = "application/json";
        options.body = JSON.stringify(options.body);
      }

      const res = await fetch(API_URL + endpoint, { ...options, headers });
      if (!res.ok) {
        let err;
        try {
          err = await res.json();
        } catch {
          err = { detail: "Unknown error" };
        }
        throw new Error(err.detail || `Error ${res.status}`);
      }
      return res.json();
    }

    async function fetchCredits() {
      try {
        const data = await fetchWithAuth("/api/user/keys-and-balance");
        if (data && typeof data.balance === "number") {
          credits = data.balance;
          document.getElementById("creditDisplay").textContent = credits.toLocaleString();
        }
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    function initCanvas() {
      if (canvas) return;
      canvas = new fabric.Canvas("c", {
        width: 600,
        height: 900,
        backgroundColor: "#ffffff",
        preserveObjectStacking: true,
      });

      canvas.on("object:modified", saveProject);
      canvas.on("object:added", saveProject);
      canvas.on("object:removed", saveProject);
    }

    function setCanvasMode(mode, cardEl) {
      if (!canvas) return;
      document.querySelectorAll(".layout-card").forEach((el) => el.classList.remove("active"));
      if (cardEl) cardEl.classList.add("active");

      if (mode === "full") {
        canvas.setWidth(1300);
        canvas.setHeight(900);
      } else {
        canvas.setWidth(600);
        canvas.setHeight(900);
      }
      canvas.renderAll();
      saveProject();
    }

    function addText() {
      if (!canvas) return;
      const text = new fabric.IText("Book Title", {
        left: 80,
        top: 120,
        fontFamily: "Cinzel",
        fontSize: 60,
        fill: "#ffffff",
        stroke: "#000000",
        strokeWidth: 2,
        shadow: "rgba(0,0,0,0.6) 3px 3px 8px",
      });
      canvas.add(text);
      canvas.setActiveObject(text);
      canvas.renderAll();
    }

    function updateText(prop, value) {
      if (!canvas) return;
      const obj = canvas.getActiveObject();
      if (!obj || (obj.type !== "i-text" && obj.type !== "text")) return;
      obj.set(prop, value);
      canvas.renderAll();
      saveProject();
    }

    function toggleBrush() {
      if (!canvas) return;
      isBrushMode = !isBrushMode;
      canvas.isDrawingMode = isBrushMode;
      if (isBrushMode) {
        canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
        canvas.freeDrawingBrush.color = canvas.backgroundColor || "#ffffff";
        canvas.freeDrawingBrush.width = 30;
        showToast("Brush mode ON (erases with background color)", "info");
      } else {
        showToast("Brush mode OFF", "info");
      }
    }

    function bringToFront() {
      if (!canvas) return;
      const obj = canvas.getActiveObject();
      if (obj) canvas.bringToFront(obj);
    }

    function sendToBack() {
      if (!canvas) return;
      const obj = canvas.getActiveObject();
      if (obj) canvas.sendToBack(obj);
    }

    function deleteSelected() {
      if (!canvas) return;
      const obj = canvas.getActiveObject();
      if (obj) {
        canvas.remove(obj);
        canvas.renderAll();
        saveProject();
      }
    }

    function clearCanvas() {
      if (!canvas) return;
      if (!confirm("Clear entire canvas?")) return;
      canvas.clear();
      canvas.setBackgroundColor("#ffffff", canvas.renderAll.bind(canvas));
      saveProject();
    }

    function saveProject() {
      if (!currentUser || !canvas) return;
      const json = canvas.toJSON();
      localStorage.setItem("cover_project_" + currentUser.uid, JSON.stringify(json));
    }

    function loadProject() {
      if (!currentUser || !canvas) return;
      const raw = localStorage.getItem("cover_project_" + currentUser.uid);
      if (!raw) return;
      try {
        canvas.loadFromJSON(JSON.parse(raw), () => {
          canvas.renderAll();
        });
      } catch (e) {
        console.error(e);
      }
    }

    function downloadCover() {
      if (!canvas) return;
      const a = document.createElement("a");
      a.href = canvas.toDataURL({ format: "png", quality: 1.0 });
      a.download = "elvion_cover.png";
      a.click();
    }

    async function removeBackground() {
      if (!canvas) return;
      const obj = canvas.getActiveObject();
      if (!obj || obj.type !== "image") {
        showToast("Select an image layer first", "warning");
        return;
      }
      showToast("Removing background...", "info");
      const dataUrl = obj.toDataURL({ format: "png" });
      const blob = await (await fetch(dataUrl)).blob();
      const fd = new FormData();
      fd.append("file", blob, "image.png");
      try {
        const res = await fetch(API_URL + "/api/tools/remove-background", {
          method: "POST",
          body: fd,
        });
        if (!res.ok) throw new Error("remove.bg failed");
        const outBlob = await res.blob();
        const reader = new FileReader();
        reader.onload = (e) => {
          fabric.Image.fromURL(e.target.result, (img) => {
            img.left = obj.left;
            img.top = obj.top;
            img.scaleX = obj.scaleX;
            img.scaleY = obj.scaleY;
            canvas.remove(obj);
            canvas.add(img);
            canvas.setActiveObject(img);
            canvas.renderAll();
            saveProject();
            showToast("Background removed", "success");
          });
        };
        reader.readAsDataURL(outBlob);
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    function updateLimits() {
      if (!currentUser) return;
      const today = new Date().toDateString();
      const coverCount = parseInt(localStorage.getItem("covers_" + currentUser.uid + "_" + today) || "0", 10);
      const chars = JSON.parse(localStorage.getItem("chars_" + currentUser.uid) || "[]");
      const isAdmin = currentUser.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase();
      document.getElementById("coverLimitStatus").textContent = isAdmin
        ? "Admin: unlimited covers"
        : `Covers today: ${coverCount}/2`;
      document.getElementById("charLimitStatus").textContent = `Characters saved: ${chars.length}`;
    }

    async function generateCover() {
      if (!canvas || !currentUser) return;
      const today = new Date().toDateString();
      const key = "covers_" + currentUser.uid + "_" + today;
      let count = parseInt(localStorage.getItem(key) || "0", 10);
      const isAdmin = currentUser.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase();

      if (!isAdmin && count >= 2) {
        showToast("Daily limit reached (2 covers)", "error");
        return;
      }
      if (!isAdmin && credits < 20) {
        if (confirm("Insufficient credits. Fund wallet?")) fundWallet();
        return;
      }

      const prompt = document.getElementById("genPrompt").value.trim();
      if (!prompt) {
        showToast("Enter a description for your cover", "warning");
        return;
      }

      const btn = document.getElementById("btnGenCover");
      const original = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loader"></span> Generating...';

      try {
        // IMPORTANT: match ThenaImageRequest + use_minimax=False
        const result = await fetchWithAuth("/generate-image", {
          method: "POST",
          body: {
            prompt,
            model: document.getElementById("aiModel").value,
            creative: false,
            width: 768, // use Thena optimal then scale into canvas
            height: 1024,
            fastMode: false,
            denseMode: false,
            use_minimax: false,
          },
        });

        if (result && result.image_b64) {
          const url = "data:image/png;base64," + result.image_b64;
          fabric.Image.fromURL(url, (img) => {
            const maxW = canvas.getWidth() * 0.95;
            const maxH = canvas.getHeight() * 0.95;
            const scale = Math.min(maxW / img.width, maxH / img.height, 1);
            img.scale(scale);
            img.left = (canvas.getWidth() - img.getScaledWidth()) / 2;
            img.top = (canvas.getHeight() - img.getScaledHeight()) / 2;
            canvas.add(img);
            canvas.sendToBack(img);
            canvas.renderAll();
            saveProject();
          });
          if (!isAdmin) {
            credits -= 20;
            document.getElementById("creditDisplay").textContent = credits.toLocaleString();
            count += 1;
            localStorage.setItem(key, String(count));
          }
          updateLimits();
          showToast("Cover generated", "success");
        } else {
          throw new Error("No image returned");
        }
      } catch (e) {
        showToast(e.message, "error");
      } finally {
        btn.disabled = false;
        btn.innerHTML = original;
      }
    }

    async function generateCharacter() {
      if (!currentUser) return;
      const isAdmin = currentUser.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase();
      if (!isAdmin && credits < 10) {
        if (confirm("Insufficient credits. Fund wallet?")) fundWallet();
        return;
      }
      const basePrompt = document.getElementById("genPrompt").value.trim() || "a detailed fantasy character, full body, plain background";
      showToast("Generating character...", "info");
      try {
        const result = await fetchWithAuth("/generate-image", {
          method: "POST",
          body: {
            prompt: basePrompt + ", character sheet, full body, white background, high detail",
            model: "anime_core",
            creative: false,
            width: 576,
            height: 1024,
            fastMode: false,
            denseMode: false,
            use_minimax: false,
          },
        });
        if (result && result.image_b64) {
          const chars = JSON.parse(localStorage.getItem("chars_" + currentUser.uid) || "[]");
          chars.push({ b64: result.image_b64, prompt: basePrompt, ts: Date.now() });
          localStorage.setItem("chars_" + currentUser.uid, JSON.stringify(chars));
          loadCharacters();
          const isAdminNow = currentUser.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase();
          if (!isAdminNow) {
            credits -= 10;
            document.getElementById("creditDisplay").textContent = credits.toLocaleString();
          }
          updateLimits();
          showToast("Character saved", "success");
        } else {
          throw new Error("No image returned");
        }
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    function loadCharacters() {
      if (!currentUser) return;
      const grid = document.getElementById("charGrid");
      const chars = JSON.parse(localStorage.getItem("chars_" + currentUser.uid) || "[]");
      if (chars.length === 0) {
        grid.innerHTML =
          '<p style="grid-column:1/-1; text-align:center; color:var(--muted); font-size:0.85rem;">No characters yet. Generate one above.</p>';
        return;
      }
      grid.innerHTML = "";
      chars.forEach((c, idx) => {
        const card = document.createElement("div");
        card.className = "char-card";
        const img = document.createElement("img");
        img.src = "data:image/png;base64," + c.b64;
        card.appendChild(img);
        const overlay = document.createElement("div");
        overlay.className = "char-overlay";
        const useBtn = document.createElement("button");
        useBtn.className = "btn-primary";
        useBtn.style.fontSize = "0.7rem";
        useBtn.textContent = "Use";
        useBtn.onclick = (ev) => {
          ev.stopPropagation();
          fabric.Image.fromURL("data:image/png;base64," + c.b64, (imgObj) => {
            imgObj.scaleToWidth(320);
            canvas.add(imgObj);
            canvas.renderAll();
            saveProject();
          });
        };
        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger";
        delBtn.style.fontSize = "0.7rem";
        delBtn.textContent = "Delete";
        delBtn.onclick = (ev) => {
          ev.stopPropagation();
          if (!confirm("Delete this character?")) return;
          chars.splice(idx, 1);
          localStorage.setItem("chars_" + currentUser.uid, JSON.stringify(chars));
          loadCharacters();
          updateLimits();
        };
        overlay.appendChild(useBtn);
        overlay.appendChild(delBtn);
        card.appendChild(overlay);
        grid.appendChild(card);
      });
    }

    async function requestPromptIdea() {
      const current = document.getElementById("genPrompt").value.trim();
      if (!current) {
        showToast("Write a short idea first", "warning");
        return;
      }
      addChatMessage("You: refine prompt for - " + current, "user");
      try {
        const res = await fetchWithAuth("/api/llama/chat", {
          method: "POST",
          body: {
            prompt:
              'Turn this into a detailed, cinematic book cover prompt, focusing on lighting, style and composition: "' +
              current +
              '"',
            systemPrompt:
              "You are a professional AI image prompt engineer specialised in book covers. Respond with only the prompt.",
          },
        });
        const text = res?.content || res?.response || "";
        if (text) {
          document.getElementById("genPrompt").value = text;
          addChatMessage("Bobby: Here is a refined prompt for you.", "bot");
          showToast("Prompt refined", "success");
        }
      } catch (e) {
        addChatMessage("Bobby: " + e.message, "bot");
      }
    }

    async function sendChat() {
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      addChatMessage("You: " + text, "user");
      try {
        const res = await fetchWithAuth("/api/llama/chat", {
          method: "POST",
          body: {
            prompt: text,
            systemPrompt:
              "You are Bobby, a friendly assistant inside Elvion Cover Studio. Help with prompts and design advice.",
          },
        });
        const reply = res?.content || res?.response || "No response.";
        addChatMessage("Bobby: " + reply, "bot");
      } catch (e) {
        addChatMessage("Bobby: " + e.message, "bot");
      }
    }

    function addChatMessage(text, type) {
      const box = document.getElementById("chatBox");
      const div = document.createElement("div");
      div.className = "chat-msg " + type;
      div.textContent = text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function openMockup() {
      if (!canvas) return;
      const dataUrl = canvas.toDataURL({ format: "png", quality: 1.0 });
      document.getElementById("faceFront").style.backgroundImage = "url(" + dataUrl + ")";
      // spine/back default to plain if no specific images
      document.getElementById("faceSpine").style.backgroundImage =
        "linear-gradient(180deg, #020617, #0f172a)";
      document.getElementById("faceBack").style.backgroundImage =
        "linear-gradient(135deg, #020617, #020617)";
      document.getElementById("mockupModal").classList.add("active");
      rotateBook("front");
    }

    function closeMockup() {
      document.getElementById("mockupModal").classList.remove("active");
    }

    function rotateBook(view) {
      const book = document.getElementById("book3d");
      if (view === "front") {
        book.style.transform = "rotateY(-24deg) rotateX(16deg)";
      } else if (view === "spine") {
        book.style.transform = "rotateY(-90deg) rotateX(10deg)";
      } else {
        book.style.transform = "rotateY(-40deg) rotateX(22deg)";
      }
    }

    async function fundWallet() {
      if (!currentUser) {
        showToast("Sign in first", "warning");
        return;
      }
      const amountStr = prompt("Fund wallet (NGN). Minimum 100:", "1000");
      if (!amountStr) return;
      const amount = parseInt(amountStr, 10);
      if (isNaN(amount) || amount < 100) {
        showToast("Minimum is ‚Ç¶100", "warning");
        return;
      }
      try {
        const init = await fetchWithAuth("/api/payments/initiate", {
          method: "POST",
          body: { amount },
        });
        if (!init?.checkout_url) throw new Error("No payment link");
        const win = window.open(init.checkout_url, "_blank");
        const ref = init.transaction_ref;
        const interval = setInterval(async () => {
          if (win.closed) {
            clearInterval(interval);
            showToast("Verifying payment...", "info");
            try {
              const v = await fetchWithAuth("/api/payments/verify?transaction_ref=" + ref);
              if (v?.status === "success") {
                credits = v.new_balance;
                document.getElementById("creditDisplay").textContent = credits.toLocaleString();
                showToast("Payment verified. Credits added.", "success");
              } else if (v?.status === "failed") {
                showToast("Payment failed.", "error");
              } else {
                showToast("Payment pending. Try refresh later.", "warning");
              }
            } catch (e) {
              showToast(e.message, "error");
            }
          }
        }, 3000);
      } catch (e) {
        showToast(e.message, "error");
      }
    }

    function showToast(msg, type = "info") {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.className = "toast show " + type;
      setTimeout(() => {
        t.classList.remove("show");
      }, 3200);
    }
  </script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
¬† window.dataLayer = window.dataLayer || [];
¬† function gtag(){dataLayer.push(arguments);}
¬† gtag('js', new Date()); 

¬† gtag('config', 'G-J1YTKP10ZX');
</script>
