<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Philadelphia AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
  <style>
:root {
  /* This is the new default "Galaxy" theme, inspired by your image */
  --cyan: #00c3ff;
  --blue: #007bff;
  --dark-bg: #0a0f1e;
  --fade-blue: rgba(19, 30, 60, 0.5);
  --gradient-1: rgba(25, 38, 67, 0.7); /* AI "Glass" Bubble */
  --gradient-user: linear-gradient(135deg, #007bff 0%, #00c3ff 100%); /* User Blue Gradient Bubble */
  --bubble-glow: 0 4px 15px rgba(0, 195, 255, 0.15);
  --user-glow: 0 4px 20px rgba(0, 123, 255, 0.25);
  --header-glass: rgba(17, 29, 47, 0.75);
  --code-bg: rgba(10, 25, 47, 0.9);
  --code-border: rgba(0, 195, 255, 0.3);
  --code-text: #a6faff;
  --main-text: #e1f5fe;
  --link-text: #00c3ff;
  --input-bg: rgba(10, 25, 47, 0.85);
  --body-bg: radial-gradient(ellipse at 70% 30%, #112250 0%, #060e1e 60%, #030010 100%) fixed;
  --body-blend-mode: normal;
  --panel-bg: linear-gradient(118deg, rgba(19, 22, 66, 0.95) 80%, rgba(22, 41, 175, 0.95) 200%);
  --panel-border: rgba(0, 251, 255, 0.4);
  --panel-shadow: 0 0 42px rgba(37, 248, 255, 0.15);
  --submit-bg: linear-gradient(94deg, #00c3ff, #007bff 90%);
  --submit-text: #ffffff;
  --submit-hover-bg: #0069d9;
  --submit-hover-text: #fff;
  --header-text-glow: 0 0 8px rgba(0, 224, 255, 0.5);
  --header-text-anim-glow-1: 0 0 10px rgba(0, 231, 255, 0.3), 0 0 20px rgba(11, 143, 255, 0.2);
  --header-text-anim-glow-2: 0 0 15px rgba(0, 255, 233, 0.6), 0 0 30px rgba(49, 210, 255, 0.3);
  --header-text-fill: linear-gradient(90deg, #a6faff, #00b4ff 40%, #ffffff 59%, #1093f1 89%, #24e0fa 100%);
}
html, body {
  height: 100vh; width: 100vw; margin: 0; padding: 0;
  color: var(--main-text);
  background: var(--body-bg);
  background-blend-mode: var(--body-blend-mode);
  font-family: 'Inter', 'Roboto', system-ui, -apple-system, Segoe UI, sans-serif;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
  transition: background 0.3s ease;
}
body { overflow: hidden; min-height: 100vh; width: 100vw; }
#stars-container {
  pointer-events: none;
  position: fixed; left:0; top:0;right:0;bottom:0;
  width:100vw; height:100vh; z-index:1;
  overflow: hidden;
}
.star {
  position:absolute;
  background: var(--cyan);
  box-shadow: 0 0 8px var(--cyan), 0 0 14px var(--cyan);
  opacity: 0.23;
  border-radius: 50%;
  pointer-events: none;
  animation: star-twinkle 2.7s infinite alternate;
}
@keyframes star-twinkle {
  0% { opacity:.18; }
  41% { opacity:.88; }
  100%{ opacity:.09;}
}
.header-bar {
  position: fixed; top: 0; left: 0; width: 100vw;
  display: flex; align-items: center; justify-content: space-between;
  background: var(--header-glass);
  backdrop-filter: blur(10px);
  z-index: 1003;
  padding: 0;
  box-shadow: 0 7px 48px rgba(0, 170, 255, 0.1), 0 3px 41px rgba(9, 252, 254, 0.05);
  border-bottom: 1px solid rgba(0, 195, 255, 0.2);
  border-radius: 0;
  height: 70px;
  transition: background 0.3s ease, box-shadow 0.3s ease;
}
.menu-btn {
  background: none; border: none;
  color: var(--cyan); font-size: 2em; cursor: pointer;
  border-radius: 14px; margin-left: 17px; margin-right: 3px;
  padding: 7px 11px;
}
.menu-btn:hover { background: rgba(0, 234, 255, 0.15); color: #fff; }
#themeBtn { font-size: 1.6em; padding: 7px 12px; margin-left: -10px; }
.site-heading {
  font-family: 'Orbitron',sans-serif;
  font-size: 1.28em; font-weight: 700;
  text-align: center; flex: 1;
  letter-spacing: .27px;
  white-space:nowrap;
  background: var(--header-text-fill);
  background-size: 250% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: neonglow 4.2s ease-in-out infinite alternate;
  text-shadow: var(--header-text-glow);
  user-select: none; margin-left: 8px; margin-right: 10px;
}
@keyframes neonglow {
  0% { text-shadow: var(--header-text-anim-glow-1);}
  100% { text-shadow: var(--header-text-anim-glow-2);}
}
.header-welcome {
  color: #68e6fd; font-size: .97em; margin: -2px 0 .7em 0; text-align: center;
  text-shadow: 0 0 14px rgba(0, 188, 180, 0.67);
}
.main-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow-y: hidden;
    position: relative;
    padding-top: 70px;
    padding-bottom: 86px;
    box-sizing: border-box;
}
.chat-box {
  flex: 1 1 0px; 
  overflow-y: auto;
  overflow-x: hidden;
  width: 100vw; max-width: 635px; margin: 0 auto;
  box-sizing: border-box;
  padding: 15px 8px;
  position: relative;
  z-index:3;
  scroll-behavior: smooth;
  display: flex;
  flex-direction: column;
}
#typing-status {
  display: none;
  max-width: 635px;
  margin: 0 auto;
  padding: 0 8px;
  width: 100vw;
  box-sizing: border-box;
  flex-shrink: 0;
  min-height: 20px;
  padding-bottom: 10px;
}
.chat-message {
  width: 100%; display: flex; gap:9px; align-items: flex-end;
  margin: 8px 0; max-width:100vw;
  flex-shrink: 0;
  animation: fadeIn 0.4s ease-out;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.chat-message .msg {
  font-size: 1.01em; line-height: 1.58;
  max-width: 62vw; min-width:0; 
  padding: 11px 16px 12px 15px;
  border-radius: 18px;
  word-break: break-word; white-space: pre-wrap; overflow-x: auto;
  background: var(--gradient-1); color: var(--main-text);
  backdrop-filter: blur(8px);
  text-shadow: 0 0 3px rgba(35, 216, 255, 0.1);
  box-shadow: var(--bubble-glow);
  margin-right: auto; margin-left: 0;
  border: 1.2px solid rgba(0, 144, 255, 0.25); position:relative;
  transition:background .3s, color .3s, box-shadow .3s;
  border-radius: 18px 18px 18px 4px;
}
.chat-message.user { justify-content: flex-end; }
.chat-message.user .msg {
  background: var(--gradient-user);
  color: var(--submit-text); font-weight: 500;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  margin-left: auto; margin-right: 0;
  box-shadow: var(--user-glow);
  border: none;
  border-radius: 18px 18px 4px 18px;
  max-width: 68vw;
}
@media (max-width:790px) {
  .chat-box { max-width:100vw; padding: 15px 4px; }
  #typing-status { padding: 0 4px 10px 4px; }
  .chat-message .msg { font-size: .97em; padding:9px 4vw 10px 5vw; max-width:80vw;}
  .chat-message.user .msg { max-width: 83vw; }
}
.typing-bubble {
  display: inline-flex;
  align-items: center;
  height: 28px;
  padding: 4px 12px;
  margin: 6px 4px;
  border-radius: 15px;
  background: linear-gradient(90deg, rgba(10, 68, 119, 0.8) 30%, rgba(14, 191, 255, 0.4) 95%);
  box-shadow: 0 2px 12px rgba(13, 252, 255, 0.15);
  border: 1px solid rgba(0, 255, 255, 0.1);
}
.dot-anim {
  display:inline-block;
  width: 8px; height: 8px;
  margin:0 3px; 
  background: var(--cyan);
  border-radius: 50%;
  opacity: 0.85;
  animation: typing-blink 1.4s infinite both;
  box-shadow: 0 0 6px var(--cyan);
}
.dot-anim:nth-child(2){animation-delay:.3s;}
.dot-anim:nth-child(3){animation-delay:.6s;}
@keyframes typing-blink {
  0%,100% {opacity:.25; transform: scale(0.8);}
  25%  {opacity:.95; transform: scale(1.1);}
  50%  {opacity:1; transform: scale(1.2);}
  75%  {opacity:.65; transform: scale(1);}
}
pre, code {
  font-family: 'JetBrains Mono','Fira Mono','Menlo',monospace;
  font-size: .99em;
  background: var(--code-bg);
  border-radius: 11px;
  border: 1.7px solid var(--code-border);
  color: var(--code-text);
  box-shadow: 0 0 19px rgba(0, 234, 255, 0.1), 0 0 48px rgba(11, 190, 255, 0.1) inset;
  transition: background 0.3s, border-color 0.3s, color 0.3s;
}
pre {
  overflow-x: auto;
  padding: 1.18em 1.3em 1.16em 1.13em;
  margin: 1.15em 0 1em 0; position: relative;
}
pre:before {
  content: "CODE";
  color: var(--cyan);
  font-size: 0.82em;
  font-family: 'Orbitron', monospace;
  position: absolute; top: 5px; right: 29px; opacity: 0.17;
  letter-spacing: 0.13em; pointer-events: none;
}
.copy-btn {
  position: absolute; top: 10px; right: 13px; z-index: 3;
  border-radius: 8px; border: none; padding: 3px 15px;
  background: linear-gradient(95deg, #0cf3ff 40%, #0980ff 120%);
  color: #06182f; font-size: .98em; font-family: 'Inter'; font-weight: bold;
  box-shadow: 0 2px 9px rgba(24, 227, 255, 0.5),0 0 7px rgba(0, 255, 215, 0.4);
  transition: background .15s, color .15s;
  cursor: pointer; outline: none; border: 1px solid rgba(12, 243, 255, 0.2);
}
.copy-btn:hover { background: #008cee; color: #fff; }
.inline-copy-btn, .inline-share-btn, .regen-btn, .inline-edit-btn {
  padding:4px 10px; border-radius:7px; border:none;
  background:var(--submit-bg);
  color:var(--submit-text); font-family:'Inter',Arial,sans-serif; font-size:.96em;
  font-weight:600; display:inline-flex; align-items:center; gap:4px; 
  margin-top:6px; margin-right: 3px; cursor:pointer;
  box-shadow:0 2px 7px rgba(23, 246, 254, 0.15);transition:background .14s,color .13s;
}
.inline-copy-btn:hover, .inline-share-btn:hover, .regen-btn:hover, .inline-edit-btn:hover{background:var(--submit-hover-bg); color:var(--submit-hover-text);}
/* --- IMPROVED KEYBOARD FIT --- */
.chat-input-row {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 0;
  display: flex;
  align-items: stretch;
  gap: 8px;
  background: rgba(17, 29, 47, 0.8);
  backdrop-filter: blur(12px);
  border-top: 1.5px solid rgba(26, 248, 255, 0.15);
  width: 95vw;
  max-width: 900px;
  padding: 9px 12px 10px 13px;
  box-shadow: 0 0 39px rgba(0, 127, 255, 0.1), 0 11px 33px rgba(0, 255, 240, 0.05);
  z-index: 1003;
}
@media (max-width: 920px) {
  .chat-input-row { width: 100vw; max-width: 100%; border-radius: 0; }
}
.chat-input-row textarea{
  flex:1 1 auto;resize:none;min-height:36px;max-height:120px;
  background: var(--input-bg);color: var(--main-text);font-size:1em;
  padding:10px 12px;border: 1px solid rgba(0, 242, 255, 0.15);border-radius:11px;
  box-shadow:0 1px 6px rgba(0, 242, 255, 0.1);
  transition: background 0.3s, color 0.3s, border-color 0.2s;
}
.chat-input-row textarea:focus {
  border-color: var(--cyan);
  box-shadow: 0 0 8px rgba(0, 242, 255, 0.25);
  outline: none;
}
.chat-input-row button, .chat-input-row label{
  background:none;border:none;color:var(--cyan);font-size:1.21em;
  cursor:pointer;border-radius:10px;transition:color .13s,background .15s;padding:0;
  display:flex;align-items:center;justify-content:center;min-width:33px;
}
.chat-input-row button:hover, .chat-input-row label:hover{color:#fff;background:rgba(0, 205, 242, 0.2);}
#stopBtn {
  background: #ff4d4d;
  color: white;
  font-size: 1.2em;
  border-radius: 10px;
  padding: 0;
  min-width: 33px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
  transition: background .1s, color .1s;
}

#stopBtn:hover { background: #ff7777; }

/* --- OTHER STYLES (MOSTLY UNCHANGED) --- */
.file-attachments { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; max-width: 100%; }
.chat-media-preview { max-width: 100%; max-height: 250px; border-radius: 12px; display: block; }
.image-preview-thumb, .video-preview-thumb { border: 2px solid var(--cyan); box-shadow: 0 0 10px var(--cyan); }
.chat-message.ai .msg img.chat-media-preview { cursor: zoom-in; }
.audio-preview-thumb { width: 90%; min-height: 40px; border-radius: 10px; }
.file-link, .file-placeholder { display: inline-block; padding: 8px 12px; background: #0b2447; border: 1px solid rgba(26, 248, 255, 0.3); border-radius: 10px; color: var(--cyan); text-decoration: none; font-size: 0.9em; font-weight: bold; }
.file-link i, .file-placeholder i { margin-right: 5px; }
.file-preview{ display:none; background:rgba(15,36,65,0.98); border-radius:12px;color:#c4f2ff;font-size:.98em; box-shadow:0 3px 15px rgba(0, 170, 192, 0.7); margin:0 auto 10px auto;width:94vw;max-width:520px; padding:10px 14px 10px 15px; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 1002; border: 1.5px solid rgba(0, 255, 255, 0.25); }
.file-preview img, .file-preview video { max-width:58px;max-height:41px;border-radius:6px;margin-right:6px;vertical-align: middle; }
.file-preview audio { width:52px; margin-right:7px; }
.remove-file-btn { color: #fff !important; background:#d23 !important; border:none !important; border-radius:50% !important; padding:2px 6px !important; cursor:pointer !important; font-size:1.2em !important; font-weight:bold !important; margin-left:8px !important; transition: background .16s, color .16s !important; min-width: 24px !important; height: 24px !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; }
.remove-file-btn:hover { background:#ff4444 !important; color:#fff !important; transform: scale(1.1) !important; }
#emojiPanel { display:none; position: fixed; left:10px; bottom:110px; z-index:2222; background: rgba(5, 31, 70, 0.98); backdrop-filter: blur(8px); border-radius: 15px; padding: 16px 15px 12px 15px; box-shadow: 0 5px 22px rgba(0, 255, 241, 0.3); border: 1px solid rgba(0, 255, 255, 0.2); }
.emoji-pick { font-size:1.23em; cursor:pointer; padding:4px 8px; border-radius:10px; transition:background .13s; user-select:none; }
.emoji-pick:hover { background:rgba(53, 205, 253, 0.4); }
.status-message{padding:6px 13px;color:#12ffc7;font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;}
.panel-bg { display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(13,20,52,0.86);z-index:1200; }
.panel-bg.active{display:block;}
.side-panel{position:absolute;top:0;left:0;height:100vh;width:325px; background: var(--panel-bg); backdrop-filter: blur(10px); border-right:2.5px solid var(--panel-border); box-shadow: var(--panel-shadow); z-index:1212; padding:18px 16px 20px 15px;overflow-y:auto;border-radius:0 24px 32px 0; transition: background 0.3s, border-color 0.3s, box-shadow 0.3s; }
.side-panel .panel-header{text-align:center;margin:18px 0 13px 0;}
.side-panel img{width:56px;height:56px;border-radius:53%;margin-bottom:8px;border:2px solid rgba(49, 246, 255, 0.9);}
.side-panel .username{font-weight:700;font-size:1.11em;color:#08d0fe;font-family:'Orbitron',sans-serif;text-shadow:0 0 8px rgba(0, 234, 255, 0.7);}
.side-panel .email{font-size:.97em;color:#a8eaff;}
.panel-links a{color: var(--link-text);text-decoration:none;font-weight:500;font-size:1.08em;padding:8px 4px;display:flex;align-items:center;gap:12px;border-radius:9px;transition:background .14s;}
.panel-links a:hover{background:rgba(0, 234, 255, 0.2);color:#f4fdff;}
.panel-links a i { width: 20px; text-align: center; }
#chatsList button{background:none;border:none;cursor:pointer;outline:none;font-size:1.11em;margin:0 5px;vertical-align:middle;border-radius:7px;padding:3px 5px;}
#chatsList .fa-pen{color:#0fe0ee;transition:color .13s;}
#chatsList .fa-pen:hover{color:#ffd800;}
#chatsList .fa-trash{color:#ff244e;transition:color .10s;}
#chatsList .fa-trash:hover{color:#fff900;}
#chatsList .fa-play{color:#04ea70;font-size:1.2em;}
#chatsList .fa-play:hover{color:#31adff;}
.edit-form label{display:block;margin-top:10px;font-size:.99em;color:#38e4ff;text-shadow:0 1px 14px rgba(17, 170, 255, 0.4);}
.edit-form input, .edit-form textarea, .edit-form select{ width:99%;padding:7px 11px;margin-top:5px; border:1.7px solid rgba(19, 240, 255, 0.6);border-radius:9px;background:#071f35;color:#fff;font-size:1.02em; box-shadow:0 0 8px rgba(4, 246, 253, 0.5) inset;transition:border-color .17s,box-shadow .17s;}
.edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus{border-color:#27eeff;background:#273f5d;color:#fff;}
.edit-form textarea { resize:vertical; min-height: 80px; }
.submit-btn{ margin-top:14px; padding:10px 20px; background: var(--submit-bg); border:none; border-radius:10px; color: var(--submit-text); font-weight:bold; cursor:pointer; font-size:1.11em; box-shadow:0 2px 13px rgba(0, 255, 242, 0.3); transition:background .14s,color .13s;}
.submit-btn:hover{background: var(--submit-hover-bg);color: var(--submit-hover-text);}
#lightbox { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center; }
#lightbox.active { display: flex; }
#lightbox img { max-width: 90vw; max-height: 90vh; border: 2px solid var(--cyan); border-radius: 10px; box-shadow: 0 0 50px var(--cyan); }
.spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0, 255, 247, 0.3); border-radius: 50%; border-top-color: var(--cyan); animation: spin 1s ease-in-out infinite; margin-right: 8px; }
@keyframes spin { to { transform: rotate(360deg); } }
/* Call Modal and other elements remain largely unchanged */
#callModal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--dark-bg); z-index: 4000; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
#callModal.active { display: flex; }
#callHeader { color: var(--cyan); font-family: 'Orbitron', sans-serif; font-size: 1.5em; text-shadow: 0 0 10px var(--cyan); margin-bottom: 20px; }
#botImageContainer { margin-top: 20px; position: relative; }
#botImageContainer img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--cyan); box-shadow: 0 0 30px var(--cyan); transition: transform 0.3s ease; }
@keyframes head-nod { 0% { transform: translateY(0); } 50% { transform: translateY(-3px); } 100% { transform: translateY(0); } }
@keyframes glow-spread { 0% { box-shadow: 0 0 10px #00ff00; opacity: 0.7; } 50% { box-shadow: 0 0 30px #00ff00, 0 0 50px #00ff0088; opacity: 1; } 100% { box-shadow: 0 0 10px #00ff00; opacity: 0.7; } }
#botImageContainer.speaking img { border-color: #00ff00; box-shadow: 0 0 30px #00ff00; transform: scale(1.05); animation: head-nod 1.2s infinite ease-in-out; }
#botSpeakingIndicator { position: absolute; top: -5px; left: -5px; width: 160px; height: 160px; border-radius: 50%; border: 5px solid transparent; box-shadow: 0 0 20px var(--cyan); animation: pulse 1s infinite; display: none; z-index: -1; }
#botImageContainer.speaking #botSpeakingIndicator { box-shadow: 0 0 30px #00ff00; border-color: #00ff00; display: block; animation: glow-spread 1.7s infinite ease-in-out; }
#callStatusMessage { color: var(--cyan); font-size: 1.1em; margin-top: 15px; height: 30px; text-align: center; font-style: italic; text-shadow: 0 0 5px #00aaff; }
#tapToTalk { color: #ff00ff; font-size: 1.2em; margin-top: 5px; text-shadow: 0 0 8px #ff00ff; animation: neon-pulse 1.5s infinite alternate; display: none; }
@keyframes neon-pulse { from { opacity: 0.7; transform: scale(1.0); } to { opacity: 1.0; transform: scale(1.02); } }
@keyframes pulse { 0% { opacity: 0; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0; transform: scale(1); } }
#callConversation { flex-grow: 1; width: 100%; max-width: 600px; overflow-y: auto; margin: 20px 0; border: 1px solid var(--fade-blue); border-radius: 10px; padding: 10px; background: rgba(0, 0, 0, 0.2); }
.call-msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 10px; line-height: 1.5; word-break: break-word; }
.call-msg.user { background: var(--gradient-user); color: var(--submit-text); text-align: right; margin-left: auto; max-width: 80%; }
.call-msg.bot { background: var(--gradient-1); color: var(--main-text); margin-right: auto; max-width: 80%; }
.call-msg.status { text-align: center; color: #888; font-style: italic; background: none; }
#callControls { display: flex; gap: 20px; padding-bottom: 20px; margin-top: auto; }
#endCallBtn, #muteCallBtn { background: #d23; color: white; font-size: 1.2em; padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 0 10px #d2388; transition: background .1s, box-shadow .1s; }
#endCallBtn:hover, #muteCallBtn:hover { background: #ff7777; box-shadow: 0 0 15px #ff7777aa; }
#muteCallBtn { background: #007bff; box-shadow: 0 0 10px #007bff88; }
#muteCallBtn.muted { background: #555; box-shadow: none; }
#muteCallBtn.muted:hover { background: #777; }
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="main-content">
    
    <div class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <div class="header-titles">
        <span class="site-heading">ðŸ¦…Philadelphia AIðŸ¦…</span>
        <div class="header-welcome" id="headerWelcome"></div>
      </div>
      <button class="menu-btn" id="themeBtn" aria-label="Change theme"><i class="fa-solid fa-moon"></i></button>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </div>

    <div class="chat-box" id="chatBox"></div>
    
    <div id="typing-status" class="chat-message ai" style="display: none;"></div>

    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <button type="button" id="emojiBtn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
      <label for="chatFile" class="file-upload-btn" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
      <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none">
      <textarea id="chatInput" placeholder="Type hereâ€¦ (Shift+Enter = new line)"></textarea>
      <button type="button" id="callBtn" title="Start Voice Call"><i class="fa-solid fa-phone"></i></button>
      <button type="button" id="toolBtn" title="Philadelphia Tools" aria-controls="toolMenu" aria-expanded="false"><i class="fa-solid fa-wrench"></i></button>
      <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
    </form>
  </div>
  
  <div id="emojiPanel"></div>
  <div class="status-message" id="statusMsg"></div>
  <div id="filePreview" class="file-preview"></div>
  
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:1.17em;font-weight:700;color:#00ffff;margin:18px 0 0 13px;">Chats</span>
        <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="profileMenuBg.classList.remove('active');">&times;</button>
      </div>
      <div id="chatsList" style="margin:7px 0 8px 6px;max-height:161px;overflow-y:auto;">
        <div class="spinner" style="margin: 20px auto; display: block;"></div>
      </div>
      <button id="newChatBtn" class="submit-btn" style="margin:0 0 12px 11px;"><i class="fa-solid fa-plus"></i> New Chat</button>
      <hr style="width:91%;margin:11px 0 7px 3%;border:1px solid rgba(0, 255, 240, 0.2);">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 6px;">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Paste image link">
        <span style="font-size:0.83em;color:#aae;display:block;margin:5px 0 7px 2px;">
          Tip: <a href="https://postimg.cc/" target="_blank" style="color:#19fcff;">Upload at postimg.cc</a>
        </span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">Logout</button>
    </nav>
  </div>
  
  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:100px;max-width:320px;background:rgba(25, 26, 38, 0.9);backdrop-filter:blur(8px);padding:12px;border-radius:17px;box-shadow:0 2px 19px rgba(0, 255, 242, 0.4);">
    <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
    <div id="ai-image-container"></div>
    <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px rgba(0, 255, 242, 0.5);cursor:pointer;font-weight:bold;">Download</button>
  </div>
  
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Philadelphia logo">
        <div class="username">Philadelphia AI</div>
      </div>
      <div class="panel-links">
        <a href="philadelphia.html"><i class="fa-solid fa-home"></i>Philadelphia Homepage</a>
        <a href="index.html"><i class="fa-solid fa-home"></i>Elvion Homepage</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About US</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Try Telegram Version</a>
      </div>
    </nav>
  </div>

  <div class="panel-bg" id="toolsMenuBg">
    <nav class="side-panel" id="toolsMenu">
        <div class="panel-header" style="text-align:left;">
            <div class="username" style="font-size:1.2em;margin-left:-8px;text-align:center;">Philadelphia AI Tools</div>
        </div>
        <div class="panel-links">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Creative Suite</h3>
            <a href="#" class="tool-link" data-tool="image"><i class="fa-solid fa-image"></i> Generate Image</a>
            <a href="#" class="tool-link" data-tool="edit-photo"><i class="fa-solid fa-wand-magic-sparkles"></i> Edit Photo</a>
            <a href="#" class="tool-link" data-tool="remove-bg"><i class="fa-solid fa-scissors"></i> Remove Background</a>
            <a href="#" class="tool-link" data-tool="comic"><i class="fa-solid fa-book-open"></i> Create Comic</a>
            <hr style="border-color: rgba(0, 234, 255, 0.2); margin: 10px 0;">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Audio & Video</h3>
            <a href="#" class="tool-link" data-tool="voice-gen"><i class="fa-solid fa-microphone-lines"></i> Voice Generation</a>
            <a href="#" class="tool-link" data-tool="audio-narration"><i class="fa-solid fa-file-audio"></i> Audio Narration</a>
            <a href="#" class="tool-link" data-tool="video-text"><i class="fa-solid fa-film"></i> Text-to-Video</a>
            <a href="#" class="tool-link" data-tool="video-image"><i class="fa-solid fa-photo-film"></i> Image-to-Video</a>
            <a href="#" class="tool-link" data-tool="music"><i class="fa-solid fa-music"></i> Generate Music</a>
            <hr style="border-color: rgba(0, 234, 255, 0.2); margin: 10px 0;">
            <h3 style="color:#00aaff;margin:10px 0 5px 4px;font-size:0.9em;text-transform:uppercase;">Web & Research</h3>
            <a href="#" class="tool-link" data-tool="website"><i class="fa-solid fa-globe"></i> Create Website</a>
            <a href="#" class="tool-link" data-tool="edit-website"><i class="fa-solid fa-pen-ruler"></i> Edit Last Website</a>
            <a href="#" class="tool-link" data-tool="my-sites"><i class="fa-solid fa-list-check"></i> My Websites</a>
            <a href="#" class="tool-link" data-tool="research-report"><i class="fa-solid fa-flask-vial"></i> Research Report</a>
        </div>
        <button class="submit-btn" style="margin-top:17px;" onclick="closeToolMenu();">Close</button>
    </nav>
  </div>

  <div class="panel-bg" id="toolFormModalBg">
    <nav class="side-panel" id="toolFormModal">
      <div class="panel-header">
        <div class="username" id="toolFormTitle">Tool Title</div>
      </div>
      <form class="edit-form" id="toolForm" style="padding:0 6px;"></form>
      <button id="toolFormBackBtn" class="submit-btn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">
          <i class="fa-solid fa-arrow-left"></i> Back to Tools
      </button>
      <div class="status-message" id="toolStatusMsg"></div>
    </nav>
  </div>

  <div id="lightbox">
    <img src="" alt="Lightbox image">
  </div>

  <div id="callModal">
    <div id="callHeader">Philadelphia AI - Live Call</div>
    <div id="botImageContainer">
      <img src="https://i.postimg.cc/XqL63yM9/IMG-20250824-133336-309.jpg" alt="Bot">
      <div id="botSpeakingIndicator"></div>
    </div>
    <div id="callStatusMessage">Connecting...</div>
    <div id="tapToTalk">Tap Anywhere to Speak</div>
    <div id="callConversation">
      <div class="call-msg status">Waiting for connection...</div>
    </div>
    <div id="callControls">
      <button id="muteCallBtn" class="submit-btn"><i class="fa-solid fa-microphone"></i> Mute Microphone</button>
      <button id="endCallBtn" class="submit-btn" style="background: #d23;"><i class="fa-solid fa-phone-slash"></i> End Call</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script type="module">
// --- START OF FULLY REVAMPED & FIRESTORE-INTEGRATED JAVASCRIPT ---

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, doc, onSnapshot, addDoc, setDoc, deleteDoc, 
         query, orderBy, serverTimestamp, getDocs, writeBatch 
       } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
const API_BASE_URL = 'https://web-production-9a18.up.railway.app';

let chats = [];
let currentChatId = null;
let currentMessages = [];
let uploadedFiles = [];
let currentUser = null;
let currentController = null;

let chatsUnsubscribe = null;
let messagesUnsubscribe = null;

window.addEventListener('DOMContentLoaded', () => {
  const starsContainer = $('stars-container');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const toolsMenuBg = $('toolsMenuBg');
  const toolsMenu = $('toolsMenu');
  const toolBtn = $('toolBtn');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  const emojiBtn = $('emojiBtn');
  const toolFormModalBg = $('toolFormModalBg');
  const toolForm = $('toolForm');
  const toolFormTitle = $('toolFormTitle');
  const toolFormBackBtn = $('toolFormBackBtn');
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');
  const themeBtn = $('themeBtn');
  const lightbox = $('lightbox');
  const callBtn = $('callBtn');
  const callModal = $('callModal');
  const endCallBtn = $('endCallBtn');
  const muteCallBtn = $('muteCallBtn');
  const callConversation = $('callConversation');
  const botImageContainer = $('botImageContainer');
  const callStatusMessage = $('callStatusMessage');
  const tapToTalk = $('tapToTalk');
  const typingStatus = $('typing-status'); 

  if (!chatForm || !chatBox || !toolsMenu || !typingStatus) {
    console.error("Essential UI elements are missing. App functionality will be limited.");
    return;
  }

  // --- UI Initializers & Event Handlers ---
  if (starsContainer) {
    starsContainer.innerHTML = '';
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  // ... (Most other UI handlers like emoji, panel management, etc. remain the same)
  // [NOTE: All other event handlers from the previous code are assumed to be here, unchanged, for brevity]
    if (chatInput) {
        const autoResize = () => { chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px'; };
        chatInput.addEventListener('input', autoResize);
        chatInput.addEventListener('keydown', e => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault();
                chatForm.requestSubmit();
            } else if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                const start = chatInput.selectionStart;
                const end = chatInput.selectionEnd;
                chatInput.value = chatInput.value.substring(0, start) + "\n" + chatInput.value.substring(end);
                chatInput.selectionStart = chatInput.selectionEnd = start + 1;
                autoResize();
            }
        });
        autoResize();
    }
    const emojis = ["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ¥°","ðŸ˜Ž","ðŸ‘","ðŸ™","ðŸ”¥","ðŸ’¯","ðŸŽ‰","ðŸ˜‡","ðŸ¤–","ðŸ‘€"];
    if (emojiBtn && emojiPanel && chatInput) {
        emojiBtn.addEventListener('click', (e) => {
        emojiPanel.innerHTML = emojis.map(em => `<span class="emoji-pick" role="button">${em}</span>`).join('');
        emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
        try {
            const rect = emojiBtn.getBoundingClientRect();
            emojiPanel.style.left = `${Math.max(8, rect.left)}px`;
        } catch (e) { /* ignore positioning errors */ }
        emojiPanel.querySelectorAll('.emoji-pick').forEach(span => {
            span.addEventListener('click', function () {
            const text = this.textContent || '';
            const start = chatInput.selectionStart || 0;
            const end = chatInput.selectionEnd || 0;
            chatInput.value = chatInput.value.slice(0, start) + text + chatInput.value.slice(end);
            chatInput.focus();
            chatInput.selectionStart = chatInput.selectionEnd = start + text.length;
            emojiPanel.style.display = 'none';
            chatInput.dispatchEvent(new Event('input'));
            });
        });
        });
        document.addEventListener('click', e => {
        if (emojiPanel && !emojiPanel.contains(e.target) && e.target !== emojiBtn) {
            emojiPanel.style.display = 'none';
        }
        });
    }
    if (chatFile) { chatFile.addEventListener('change', function() { uploadedFiles = Array.from(this.files || []); renderFilePreview(); }); }
    if (aiPrevClose) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; });
    if (aiPrevDLBtn) aiPrevDLBtn.addEventListener('click', () => { const img = aiPrevImgBox.querySelector('img'); if (img) { const a = document.createElement('a'); a.href = img.src; a.download = 'philadelphia_ai_image.png'; a.click(); } });
    if (lightbox) { lightbox.addEventListener('click', () => lightbox.classList.remove('active')); }
    if (chatBox) { chatBox.addEventListener('click', e => { if (e.target.tagName === 'IMG' && e.target.closest('.chat-message.ai .msg')) { e.preventDefault(); const lbImg = lightbox.querySelector('img'); if (lbImg) { lbImg.src = e.target.src; lightbox.classList.add('active'); } } }); }
    window.closeToolMenu = () => { if (toolsMenuBg) toolsMenuBg.classList.remove('active'); };
    window.openToolMenu = () => { if (toolsMenuBg) toolsMenuBg.classList.add('active'); };
    if (profileMenuBg) { $('openProfileMenu').addEventListener('click', () => profileMenuBg.classList.add('active')); profileMenuBg.addEventListener('click', e => { if (e.target === profileMenuBg) profileMenuBg.classList.remove('active'); }); }
    if (linkMenuBg) { $('openLinksMenu').addEventListener('click', () => linkMenuBg.classList.add('active')); linkMenuBg.addEventListener('click', e => { if (e.target === linkMenuBg) linkMenuBg.classList.remove('active'); }); }
    if (toolBtn) toolBtn.addEventListener('click', openToolMenu);
    if (toolsMenuBg) toolsMenuBg.addEventListener('click', e => { if (e.target === toolsMenuBg) closeToolMenu(); });
    if (toolFormBackBtn) { toolFormBackBtn.addEventListener('click', () => { toolFormModalBg.classList.remove('active'); openToolMenu(); }); }
    if (toolFormModalBg) toolFormModalBg.addEventListener('click', e => { if (e.target === toolFormModalBg) toolFormModalBg.classList.remove('active'); });
    if (logoutBtn) logoutBtn.addEventListener('click', () => { auth.signOut(); window.location.href = 'signup-login.html'; });


  // --- Authentication & Profile Management ---
  onAuthStateChanged(auth, user => {
    if (!user) {
      try { window.location.href = "signup-login.html"; } catch (e) {}
      return;
    }
    currentUser = user;
    if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]);
    if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
    if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
    if (editName) editName.value = user.displayName || "";
    if (editPhoto) editPhoto.value = user.photoURL || "";
    if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
    loadUserChats(user.uid);
  });
  if (profileForm) {
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const status = $('profileStatusMsg');
      if (status) status.textContent = 'Saving...';
      try {
        await updateProfile(currentUser, { displayName: editName.value, photoURL: editPhoto.value });
        if (auth.currentUser) await auth.currentUser.reload();
        if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; }
        setTimeout(() => { profileMenuBg?.classList.remove('active'); }, 800);
        if (headerWelcome) headerWelcome.textContent = "Welcome, " + (auth.currentUser?.displayName || 'User');
      } catch (err) {
        if (status) { status.textContent = err.message; status.style.color = "#ffd700"; }
      }
    });
  }

  // --- Firestore Chat Logic (Unchanged) ---
  async function loadUserChats(userId) { if (chatsUnsubscribe) chatsUnsubscribe(); const chatsCol = collection(db, 'users', userId, 'chats'); const q = query(chatsCol, orderBy('createdAt', 'desc')); chatsUnsubscribe = onSnapshot(q, async (snapshot) => { if (snapshot.empty) { await createNewChat(userId); return; } chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderChatsListSidebar(); if (!currentChatId || !chats.find(c => c.id === currentChatId)) { currentChatId = chats[0].id; } subscribeToMessages(userId, currentChatId); }, (error) => { console.error("Error fetching chats: ", error); chatsListEl.innerHTML = `<div style="color: #f44;">Error loading chats.</div>`; }); }
  async function createNewChat(userId) { if (!userId) userId = currentUser?.uid; if (!userId) return; const chatsCol = collection(db, 'users', userId, 'chats'); try { const newChatDoc = await addDoc(chatsCol, { name: "New Chat", createdAt: serverTimestamp() }); currentChatId = newChatDoc.id; } catch (e) { console.error("Error creating new chat: ", e); } }
  function subscribeToMessages(userId, chatId) { if (messagesUnsubscribe) messagesUnsubscribe(); if (!userId || !chatId) { renderChatBox([]); return; } const messagesCol = collection(db, 'users', userId, 'chats', chatId, 'messages'); const q = query(messagesCol, orderBy('createdAt')); messagesUnsubscribe = onSnapshot(q, (snapshot) => { currentMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderChatBox(currentMessages); }, (error) => { console.error("Error fetching messages: ", error); chatBox.innerHTML = `<div style="color: #f44; text-align: center; margin-top: 20px;">Error loading messages.</div>`; }); }
  if (newChatBtn) { newChatBtn.addEventListener('click', () => createNewChat(currentUser.uid)); }
  function renderChatsListSidebar() { if (!chatsListEl) return; chatsListEl.innerHTML = ''; if (chats.length === 0) { chatsListEl.innerHTML = `<div style="padding: 10px; color: #a8eaff;">No chats yet.</div>`; return; } chats.forEach((chat) => { const container = document.createElement('div'); container.style.cssText = `display:flex; align-items:center; margin-bottom:6px; border-radius:8px; background:${chat.id === currentChatId ? 'rgba(0, 234, 255, 0.15)' : 'transparent'};`; const titleSpan = document.createElement('span'); titleSpan.textContent = chat.name || `Chat`; titleSpan.style.cssText = `flex:1; cursor:pointer; padding:8px 5px;`; titleSpan.onclick = () => { currentChatId = chat.id; subscribeToMessages(currentUser.uid, currentChatId); renderChatsListSidebar(); profileMenuBg?.classList.remove('active'); }; const renameBtn = document.createElement('button'); renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>'; renameBtn.title = 'Rename'; renameBtn.style.margin = '0 6px 0 8px'; renameBtn.onclick = async (e) => { e.stopPropagation(); const newName = prompt("Rename chat:", chat.name); if (newName && newName.trim()) { const chatDoc = doc(db, 'users', currentUser.uid, 'chats', chat.id); await setDoc(chatDoc, { name: newName.trim() }, { merge: true }); } }; const delBtn = document.createElement('button'); delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>'; delBtn.title = 'Delete'; delBtn.style.marginLeft = '6px'; delBtn.onclick = async (e) => { e.stopPropagation(); if (!confirm(`Delete "${chat.name}"?`)) return; const messagesCol = collection(db, 'users', currentUser.uid, 'chats', chat.id, 'messages'); const messagesSnap = await getDocs(messagesCol); const batch = writeBatch(db); messagesSnap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); const chatDoc = doc(db, 'users', currentUser.uid, 'chats', chat.id); await deleteDoc(chatDoc); if (currentChatId === chat.id) { currentChatId = null; } }; container.appendChild(titleSpan); container.appendChild(renameBtn); container.appendChild(delBtn); chatsListEl.appendChild(container); }); }
  
  // --- Chat Rendering Logic (Unchanged from previous except renderChatBox scroll fix) ---
  const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
  function inlineMarkdown(t = '') { let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`); s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>'); s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>'); s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'); return s.replace(/\n/g, '<br>'); }
  function renderMarkdown(text = '') { const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g; let html = ''; let lastIndex = 0; text = text || ''; text.replace(codeBlockRegex, (match, lang, code, offset) => { const before = text.slice(lastIndex, offset); html += inlineMarkdown(before); const language = (lang || '').toLowerCase().trim(); const safe = escapeHTML(code); html += `<pre><button class="copy-btn">Copy</button><code class="language-${language || 'plaintext'}">${safe}</code></pre>`; lastIndex = offset + match.length; return match; }); html += inlineMarkdown(text.slice(lastIndex)); return { html }; }
  function enhanceCodeBlocks(container) { if (!container) return; container.querySelectorAll('pre').forEach(pre => { const codeEl = pre.querySelector('code'); if (window.hljs && codeEl) { try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ } } const btn = pre.querySelector('.copy-btn'); if (btn && codeEl) { btn.addEventListener('click', async () => { try { await navigator.clipboard.writeText(codeEl.innerText); const prev = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = prev, 800); } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); } }); } }); }
  function renderChatBox(messages = []) { if (!chatBox) return; chatBox.innerHTML = ''; (messages || []).forEach((msg) => { const div = document.createElement('div'); div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'ai'); div.setAttribute('data-message-id', msg.id); let innerHtml = ''; if (msg.role === 'user') { const fileHtml = (msg.files || []).map(file => { let icon = 'fa-file'; if (file.type.startsWith('image/')) icon = 'fa-file-image'; else if (file.type.startsWith('video/')) icon = 'fa-file-video'; else if (file.type.startsWith('audio/')) icon = 'fa-file-audio'; else if (file.type === 'application/pdf') icon = 'fa-file-pdf'; return `<div class="file-placeholder"><i class="fa-solid ${icon}"></i> ${escapeHTML(file.name)}</div>`; }).join(''); innerHtml = `<div class="msg">${fileHtml ? `<div class="file-attachments">${fileHtml}</div>` : ''}${escapeHTML(msg.text || '')}<div class="user-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;"><button class="inline-edit-btn" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button><button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button></div></div>`; } else { let content; if (msg.text && (msg.text.includes('<img') || msg.text.includes('<audio') || msg.text.includes('<video'))) { content = msg.text; } else { content = renderMarkdown(msg.text || '').html; } innerHtml = `<div class="msg">${content}<div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;"><button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button><button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button><button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button></div></div>`; } div.innerHTML = innerHtml; chatBox.appendChild(div); }); enhanceCodeBlocks(chatBox); hookAiMsgControls(); hookUserMsgControls(); setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 50); }

  // --- Message Controls & Typing Indicators (Unchanged) ---
  // [NOTE: All functions like hookAiMsgControls, showTypingAtNext, etc. are assumed to be here, unchanged, for brevity]
    async function deleteMessagesFrom(messageId) { if (!currentChatId || !currentUser) return; const msgIndex = currentMessages.findIndex(m => m.id === messageId); if (msgIndex === -1) return; const batch = writeBatch(db); const messagesCol = collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages'); for (let i = msgIndex; i < currentMessages.length; i++) { const msgToDel = currentMessages[i]; const docRef = doc(messagesCol, msgToDel.id); batch.delete(docRef); } try { await batch.commit(); } catch (e) { console.error("Error deleting messages: ", e); } }
    function hookAiMsgControls() { if (!chatBox) return; chatBox.querySelectorAll('.chat-message.ai').forEach(div => { const messageId = div.getAttribute('data-message-id'); const msg = currentMessages.find(m => m.id === messageId); if (!msg) return; const controls = div.querySelector('.ai-msg-controls'); if (!controls) return; const copyBtn = controls.querySelector('.inline-copy-btn'); const shareBtn = controls.querySelector('.inline-share-btn'); const regenBtn = controls.querySelector('.regen-btn'); if (copyBtn) copyBtn.onclick = () => { try { const tempDiv = document.createElement('div'); tempDiv.innerHTML = msg.text; const textToCopy = tempDiv.textContent || tempDiv.innerText || ''; navigator.clipboard.writeText(textToCopy); copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!"; setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950); } catch (e) {} }; if (shareBtn) shareBtn.onclick = () => { try { const url = window.location.origin; const tempDiv = document.createElement('div'); tempDiv.innerHTML = msg.text; const plainText = tempDiv.textContent || tempDiv.innerText || ''; const shareText = `${plainText}\n\nShared via Philadelphia AI: ${url}`; if (navigator.share) navigator.share({ title: "Philadelphia AI", text: shareText, url }).catch(()=>{}); else prompt("Copy and share manually:", shareText); } catch (e) {} }; if (regenBtn) regenBtn.onclick = async () => { const msgIndex = currentMessages.findIndex(m => m.id === messageId); if (msgIndex < 1) return; const userMsg = currentMessages[msgIndex - 1]; if (userMsg.role !== 'user') return; await deleteMessagesFrom(messageId); chatInput.value = userMsg.text; chatInput.style.height = 'auto'; chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px'; uploadedFiles = []; renderFilePreview(); showTypingAtNext(); const historyForRegen = currentMessages.slice(0, msgIndex - 1).map(m => ({ role: m.role, content: m.text || '' })); try { const res = await fetch(`${API_BASE_URL}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: userMsg.text, history: historyForRegen, user_id: currentUser?.uid || "user" }) }); const data = await res.json(); if (!res.ok) throw new Error(data.error || "Server error."); removeTyping(); await startTypewriter(data.response, false); } catch (err) { removeTyping(); await startTypewriter(`âŒ Regeneration error: ${err.message}`, false); } }; }); }
    function hookUserMsgControls() { if (!chatBox) return; chatBox.querySelectorAll('.chat-message.user').forEach(div => { const messageId = div.getAttribute('data-message-id'); const msg = currentMessages.find(m => m.id === messageId); if (!msg) return; const controls = div.querySelector('.user-msg-controls'); if (!controls) return; const copyBtn = controls.querySelector('.inline-copy-btn'); const editBtn = controls.querySelector('.inline-edit-btn'); if (copyBtn) copyBtn.onclick = () => { try { const tempDiv = document.createElement('div'); tempDiv.innerHTML = msg.text; const textToCopy = tempDiv.textContent || tempDiv.innerText || ''; navigator.clipboard.writeText(textToCopy); copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!"; setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950); } catch (e) {} }; if (editBtn) editBtn.onclick = async () => { try { if (!msg.text) return; chatInput.value = msg.text; chatInput.focus(); await deleteMessagesFrom(messageId); } catch (e) {} }; }); }
    function showTypingAtNext() { if (!typingStatus) return; typingStatus.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`; typingStatus.style.display = 'flex'; chatBox.scrollTop = chatBox.scrollHeight; }
    function showTypingWithText(text) { if (!typingStatus) return; typingStatus.innerHTML = `<div class="msg" style="display:flex;align-items:center;"><span class="spinner"></span> <span style="margin-left:8px; color:var(--main-text); font-style:italic;">${text}</span></div>`; typingStatus.style.display = 'flex'; chatBox.scrollTop = chatBox.scrollHeight; }
    function removeTyping() { if (!typingStatus) return; typingStatus.style.display = 'none'; typingStatus.innerHTML = ''; }

  
  // --- *** NEW & IMPROVED TYPEWRITER FUNCTION *** ---
  async function startTypewriter(text, saveToDb = true) {
    if (text && (text.includes('<img') || text.includes('<audio') || text.includes('<video'))) {
      if (saveToDb) { await addMessageToChat('ai', text); } 
      else {
        const tempDiv = document.createElement('div');
        tempDiv.className = "chat-message ai";
        tempDiv.innerHTML = `<div class="msg">${text}</div>`;
        chatBox.appendChild(tempDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        await addMessageToChat('ai', text); // Also save regen to DB
      }
      return;
    }

    const div = document.createElement('div');
    div.className = "chat-message ai";
    const msgdiv = document.createElement('div');
    msgdiv.className = 'msg';
    div.appendChild(msgdiv);
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;

    let currentIndex = 0;
    let accumulatedHtml = '';
    let inCodeBlock = false;
    const CHUNK_SIZE = 3; // Process text in small chunks for performance

    function renderNextChunk() {
        if (currentIndex >= text.length || currentController?.signal.aborted) {
            finalizeMessage();
            return;
        }

        const nextCodeBlockStart = text.indexOf('```', currentIndex);
        let chunk;

        if (inCodeBlock) {
            // If we are inside a code block, find the end
            const endBlock = text.indexOf('```', currentIndex);
            if (endBlock !== -1) {
                chunk = text.substring(currentIndex, endBlock + 3);
                inCodeBlock = false;
            } else {
                chunk = text.substring(currentIndex); // Rest of the text
            }
        } else if (nextCodeBlockStart !== -1 && nextCodeBlockStart < currentIndex + CHUNK_SIZE) {
            // If a code block is about to start, process text until it begins
            chunk = text.substring(currentIndex, nextCodeBlockStart);
            inCodeBlock = true;
        } else {
            // Standard text chunk
            chunk = text.substring(currentIndex, currentIndex + CHUNK_SIZE);
        }
        
        currentIndex += chunk.length;
        accumulatedHtml += chunk;
        msgdiv.innerHTML = renderMarkdown(accumulatedHtml).html;
        chatBox.scrollTop = chatBox.scrollHeight;

        requestAnimationFrame(renderNextChunk);
    }

    renderNextChunk();

    async function finalizeMessage() {
        const finalRenderText = currentController?.signal.aborted ? accumulatedHtml : text;
        msgdiv.innerHTML = renderMarkdown(finalRenderText).html + `
          <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
              <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
              <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button>
              <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
          </div>
        `;
        enhanceCodeBlocks(msgdiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        if (saveToDb) {
            try {
                await addMessageToChat('ai', finalRenderText);
            } catch (e) {
                console.error("Error saving final AI message: ", e);
                msgdiv.innerHTML += "<br><small style='color: #f44;'>Failed to save message.</small>";
            }
        }
    }
  }

  // --- File Previews and Message Saving (Unchanged) ---
  function renderFilePreview() { if (!filePreview) return; if (!uploadedFiles.length) { filePreview.style.display = 'none'; filePreview.innerHTML = ''; return; } filePreview.style.display = 'block'; filePreview.innerHTML = uploadedFiles.map((file, idx) => { let preview = ''; if (file.type.startsWith('image/')) { preview = `<img src="${URL.createObjectURL(file)}" style="max-width:58px;max-height:41px;vertical-align:middle;border-radius:8px;margin-right:6px;">`; } else if (file.type.startsWith('video/')) { preview = `<video src="${URL.createObjectURL(file)}" controls style="max-width:58px;height:41px;vertical-align:middle;border-radius:8px;margin-right:7px;"></video>`; } else if (file.type.startsWith('audio/')) { preview = `<audio controls src="${URL.createObjectURL(file)}" style="vertical-align:middle;width:52px;margin-right:7px;"></audio>`; } else if (file.type === 'application/pdf') { preview = `<span style="font-size:1.25em;margin-right:7px;">ðŸ“„</span>`; } return `<div style="display:flex;align-items:center;gap:7px;margin-bottom:1px;">${preview}<span style="color:#aee;font-size:.99em;">${escapeHTML(file.name)}</span><button type="button" data-idx="${idx}" class="remove-file-btn" aria-label="Remove file">&times;</button></div>`; }).join(''); filePreview.querySelectorAll('.remove-file-btn').forEach(btn => { btn.addEventListener('click', () => { const idx = parseInt(btn.getAttribute('data-idx')); uploadedFiles.splice(idx, 1); if (!uploadedFiles.length && chatFile) chatFile.value = ''; renderFilePreview(); }); }); }
  function showAIImagePreview(base64, caption = '') { if (!aiPrevBox || !aiPrevImgBox) return; aiPrevImgBox.innerHTML = `<img src="data:image/png;base64,${base64}" alt="AI generated image" style="max-width:210px;max-height:210px;border-radius:12px;display:block;">` + `<div style="color:#aee;font-size:.95em;margin-top:3px;text-align:center;">${caption}</div>`; aiPrevBox.style.display = 'block'; }
  async function addMessageToChat(role, text, files = []) { if (!currentChatId || !currentUser) return; const messagesCol = collection(db, 'users', currentUser.uid, 'chats', currentChatId, 'messages'); try { await addDoc(messagesCol, { role, text, files, createdAt: serverTimestamp() }); } catch (e) { console.error("Error adding message to Firestore: ", e); } }
  
  // --- Tool Definitions, Handlers, and Chat Submit Logic (Unchanged) ---
  // [NOTE: The entire 'toolDefinitions' object and the 'chatForm.addEventListener('submit', ...)' function are assumed to be here, unchanged, for brevity]
    function blobToBase64(blob) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); }); }
    async function handleVideoGeneration(payload, isImageToVideo = false) { showTypingWithText('Submitting video generation job...'); try { const endpoint = isImageToVideo ? '/api/tools/generate-video-from-image' : '/api/tools/generate-video-from-text'; const commonPayload = { model: "MiniMax-Hailuo-02", duration: payload.duration || 6, resolution: payload.resolution || "1080P" }; let options; if (isImageToVideo) { payload.append('model', commonPayload.model); payload.append('duration', commonPayload.duration); payload.append('resolution', commonPayload.resolution); options = { method: 'POST', body: payload }; } else { const finalPayload = { ...payload, ...commonPayload }; options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalPayload) }; } const startRes = await fetch(API_BASE_URL + endpoint, options); const startData = await startRes.json(); if (!startRes.ok || !startData.task_id) throw new Error(startData.detail || 'Failed to start video task.'); removeTyping(); await startTypewriter(`âœ… Video job submitted! Task ID: \`${startData.task_id}\`. I'll notify you when it's ready. This can take a few minutes. Do not leave this page or send another message or task.`); const pollInterval = setInterval(async () => { try { const statusRes = await fetch(`${API_BASE_URL}/api/tools/video-status?task_id=${startData.task_id}`); const statusData = await statusRes.json(); if (statusRes.ok && statusData.url) { clearInterval(pollInterval); const videoHtml = `ðŸŽ‰ Your video is ready! <br><video controls src="${statusData.url}" class="chat-media-preview video-preview-thumb"></video>`; await addMessageToChat('ai', videoHtml); } else if (!statusRes.ok || statusData.status?.toLowerCase().includes('fail')) { clearInterval(pollInterval); await startTypewriter(`âŒ Video generation failed. Reason: ${statusData.error || 'Unknown error'}`); } } catch (pollErr) { clearInterval(pollInterval); await startTypewriter(`âŒ Error checking video status.`); } }, 20000); } catch (err) { removeTyping(); await startTypewriter(`âŒ Could not start video generation: ${err.message}`); } }
    const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
    const toolDefinitions = { /* The entire large toolDefinitions object goes here, unchanged */ };
    if (toolsMenu) { toolsMenu.addEventListener('click', async (e) => { const toolLink = e.target.closest('.tool-link'); if (!toolLink) return; e.preventDefault(); const toolKey = toolLink.getAttribute('data-tool'); const tool = toolDefinitions[toolKey]; if (!tool) return; closeToolMenu(); if (tool.isAction) { const result = await tool.runAction(); removeTyping(); if(result) await startTypewriter(result); } else { displayToolForm(toolKey); } }); }
    function displayToolForm(toolKey) { const tool = toolDefinitions[toolKey]; if (!tool || !toolFormModalBg) return; toolFormTitle.textContent = tool.title; const descriptionHtml = tool.description ? `<div style="color:#a8eaff;font-size:.9em;margin-bottom:12px;">${tool.description}</div>` : ''; toolForm.innerHTML = descriptionHtml + tool.buildForm(); if (typeof tool.onFormReady === 'function') tool.onFormReady(); toolForm.onsubmit = async (e) => { e.preventDefault(); const submitButton = toolForm.querySelector('button[type="submit"]'); const originalButtonContent = submitButton.innerHTML; submitButton.innerHTML = `<div class="spinner"></div> Processing...`; submitButton.disabled = true; toolFormModalBg.classList.remove('active'); const resultText = await tool.handleSubmit(toolForm); if (resultText) { removeTyping(); await startTypewriter(resultText); } submitButton.innerHTML = originalButtonContent; submitButton.disabled = false; }; toolFormModalBg.classList.add('active'); }
    chatForm.addEventListener('submit', async function (e) { e.preventDefault(); if (!currentChatId) { alert("Please select a chat or create a new one."); return; } const msgText = chatInput.value.trim(); if (!msgText && uploadedFiles.length === 0) return; const stopButton = document.createElement('button'); stopButton.type = 'button'; stopButton.id = 'stopBtn'; stopButton.innerHTML = '<i class="fa-solid fa-stop"></i>'; sendBtn.replaceWith(stopButton); currentController = new AbortController(); const signal = currentController.signal; let finalResponse = ''; stopButton.addEventListener('click', () => { if (currentController) { currentController.abort(); } }); const filesForHistory = uploadedFiles.map(file => ({ name: file.name, type: file.type })); await addMessageToChat('user', msgText, filesForHistory); const localUploadedFiles = [...uploadedFiles]; chatInput.value = ''; uploadedFiles = []; renderFilePreview(); chatInput.style.height = 'auto'; if (localUploadedFiles.length > 0) { showTypingWithText('Analyzing your file(s)...'); let endpoint = ''; const file = localUploadedFiles[0]; if (file.type.startsWith('image/')) endpoint = '/understand-image'; else if (file.type === 'application/pdf') endpoint = '/understand-pdf'; else if (file.type.startsWith('audio/')) endpoint = '/understand-audio'; else if (file.type.startsWith('video/')) endpoint = '/understand-video'; else { removeTyping(); finalResponse = "Sorry, I can't analyze that file type."; } try { if(endpoint) { const fd = new FormData(); fd.append('prompt', msgText || `Describe this ${file.type.split('/')[0]}`); fd.append('file', file); const res = await fetch(API_BASE_URL + endpoint, { method: 'POST', body: fd, signal }); const data = await res.json(); if (!res.ok) throw new Error(data.error || "Analysis failed."); finalResponse = data.response; } } catch (err) { finalResponse = err.name === 'AbortError' ? 'âŒ File analysis stopped.' : `âŒ File analysis failed: ${err.message}`; } } else if (msgText) { showTypingAtNext(); try { const history = currentMessages.map(m => ({ role: m.role, content: m.text || '' })); const res = await fetch(`${API_BASE_URL}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msgText, history, user_id: currentUser?.uid || "user" }), signal }); const data = await res.json(); if (!res.ok) throw new Error(data.error || "Server error."); finalResponse = data.response; } catch (err) { finalResponse = err.name === 'AbortError' ? 'âŒ Response stopped.' : `âŒ An error occurred: ${err.message}`; } } removeTyping(); if (finalResponse) { await startTypewriter(finalResponse); } stopButton.replaceWith(sendBtn); currentController = null; });
  

  // --- Theme Switcher Logic (Updated with new 'galaxy' theme as default) ---
  const themes = {
    galaxy: { /* The new theme variables defined in the <style> tag */ },
    cyber: { '--cyan': '#00fff7', '--blue': '#0a8afe', '--dark-bg': '#070b1a', '--fade-blue': '#133c8b', '--gradient-1': 'linear-gradient(120deg, #000a2e 39%, #04336a 68%, #10bfff 97%)', '--gradient-user': 'linear-gradient(120deg, #0857ee 32%, #00fff0 89%)', '--bubble-glow': '0 0 13px #00d8ffb1, 0 0 24px #0197ff40', '--user-glow': '0 0 22px #0fffd555, 0 0 14px #36f9ff70', '--header-glass': 'rgba(17,29,47,0.92)', '--code-bg': 'linear-gradient(92deg,#031d39 79%,#092ff8 120%)', '--code-border': '#15faff', '--code-text': '#17fafd', '--main-text': '#e1fafe', '--link-text': '#13efff', '--input-bg': '#09284c', '--body-bg': 'radial-gradient(circle at 60% 45%, #112250 37%, #060e1e 88%, #1e0942 100%) fixed, repeating-linear-gradient(100deg,#061c4c 0 9%,#080e20 16% 19%,#030721 30% 41%,#052650 44% 62%,#050b16 74% 89%,#041048 99% 100%)', '--body-blend-mode': 'lighten, color-dodge', '--panel-bg': 'linear-gradient(118deg,#131642 80%,#1629af 200%)', '--panel-border': '#00fbffcb', '--panel-shadow': '0 0 42px #25f8ffc9', '--submit-bg': 'linear-gradient(94deg,#00ffff,#0090ff 90%)', '--submit-text': '#102649', '--submit-hover-bg': '#008cff', '--submit-hover-text': '#fff', '--header-text-glow': '0 0 12px #00ffe0cc, 0 0 27px #178fcf88', '--header-text-anim-glow-1': '0 0 17px #00e7ff70,0 0 30px #0b8fff44', '--header-text-anim-glow-2': '0 0 29px #00ffe9ee,0 0 44px #31d2ff82', '--header-text-fill': 'linear-gradient(90deg,#00fff1,#00b4ff 40%,#fff 59%,#1093f1 89%,#24e0fa 100%)' },
    // ... other themes can be added here
  };
  // Pre-fill the default 'galaxy' theme from the stylesheet
  themes.galaxy = { '--cyan': '#00c3ff', '--blue': '#007bff', '--dark-bg': '#0a0f1e', '--fade-blue': 'rgba(19, 30, 60, 0.5)', '--gradient-1': 'rgba(25, 38, 67, 0.7)', '--gradient-user': 'linear-gradient(135deg, #007bff 0%, #00c3ff 100%)', '--bubble-glow': '0 4px 15px rgba(0, 195, 255, 0.15)', '--user-glow': '0 4px 20px rgba(0, 123, 255, 0.25)', '--header-glass': 'rgba(17, 29, 47, 0.75)', '--code-bg': 'rgba(10, 25, 47, 0.9)', '--code-border': 'rgba(0, 195, 255, 0.3)', '--code-text': '#a6faff', '--main-text': '#e1f5fe', '--link-text': '#00c3ff', '--input-bg': 'rgba(10, 25, 47, 0.85)', '--body-bg': 'radial-gradient(ellipse at 70% 30%, #112250 0%, #060e1e 60%, #030010 100%) fixed', '--body-blend-mode': 'normal', '--panel-bg': 'linear-gradient(118deg, rgba(19, 22, 66, 0.95) 80%, rgba(22, 41, 175, 0.95) 200%)', '--panel-border': 'rgba(0, 251, 255, 0.4)', '--panel-shadow': '0 0 42px rgba(37, 248, 255, 0.15)', '--submit-bg': 'linear-gradient(94deg, #00c3ff, #007bff 90%)', '--submit-text': '#ffffff', '--submit-hover-bg': '#0069d9', '--submit-hover-text': '#fff', '--header-text-glow': '0 0 8px rgba(0, 224, 255, 0.5)', '--header-text-anim-glow-1': '0 0 10px rgba(0, 231, 255, 0.3), 0 0 20px rgba(11, 143, 255, 0.2)', '--header-text-anim-glow-2': '0 0 15px rgba(0, 255, 233, 0.6), 0 0 30px rgba(49, 210, 255, 0.3)', '--header-text-fill': 'linear-gradient(90deg, #a6faff, #00b4ff 40%, #ffffff 59%, #1093f1 89%, #24e0fa 100%)'};
  let currentThemeIdx = 0; const themeKeys = Object.keys(themes);
  function applyTheme(themeName) { const theme = themes[themeName]; if (!theme) return; for (const key in theme) { document.documentElement.style.setProperty(key, theme[key]); } localStorage.setItem('philadelphia-theme', themeName); const icon = themeName === 'cyber' ? 'fa-bolt' : 'fa-star'; themeBtn.innerHTML = `<i class="fa-solid ${icon}"></i>`; }
  themeBtn.addEventListener('click', () => { currentThemeIdx = (currentThemeIdx + 1) % themeKeys.length; applyTheme(themeKeys[currentThemeIdx]); });
  const savedTheme = localStorage.getItem('philadelphia-theme'); if (savedTheme && themes[savedTheme]) { currentThemeIdx = themeKeys.indexOf(savedTheme); applyTheme(savedTheme); } else { applyTheme('galaxy'); }

  // --- Voice Call Logic (Unchanged) ---
  // [NOTE: The entire voice call logic is assumed to be here, unchanged, for brevity]
    let speechRecognition; let isCallActive = false; let callHistory = []; let botIsSpeaking = false; let userSaidSomething = false; let currentAudio = null; let isMuted = false; const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (SpeechRecognition) { speechRecognition = new SpeechRecognition(); speechRecognition.continuous = true; speechRecognition.interimResults = true; speechRecognition.lang = 'en-US'; speechRecognition.onresult = (event) => { let interimTranscript = ''; let finalTranscript = ''; userSaidSomething = true; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) { finalTranscript += event.results[i][0].transcript; } else { interimTranscript += event.results[i][0].transcript; } } let userMsgEl = callConversation.querySelector('.call-msg.user.interim'); if (!userMsgEl) { userMsgEl = document.createElement('div'); userMsgEl.className = 'call-msg user interim'; callConversation.appendChild(userMsgEl); } userMsgEl.textContent = finalTranscript || interimTranscript; callConversation.scrollTop = callConversation.scrollHeight; callStatusMessage.textContent = finalTranscript ? 'User Speaking (Final)' : 'User Speaking...'; tapToTalk.style.display = 'none'; }; speechRecognition.onend = () => { if (!isCallActive) return; if (isMuted) { callStatusMessage.textContent = 'Microphone Muted.'; tapToTalk.style.display = 'none'; return; } let finalTranscript = ''; const userMsgEl = callConversation.querySelector('.call-msg.user.interim'); if (userMsgEl) { finalTranscript = userMsgEl.textContent.trim(); userMsgEl.classList.remove('interim'); } if (botIsSpeaking) {} else if (finalTranscript && userSaidSomething) { userSaidSomething = false; callHistory.push({ role: 'user', content: finalTranscript }); handleCallBotResponse(); } else { if (isCallActive && !isMuted) { callStatusMessage.textContent = 'Listening... (Tap to Speak)'; tapToTalk.style.display = 'block'; try { speechRecognition.start(); } catch(e) {} } } }; speechRecognition.onerror = (event) => { if (event.error === 'no-speech' && isCallActive && !isMuted) { userSaidSomething = false; speechRecognition.stop(); } else if (event.error === 'network' && isCallActive) { callStatusMessage.textContent = 'Network error. Attempting restart...'; speechRecognition.stop(); } else if (event.error === 'not-allowed' || event.error === 'permission-denied') { callStatusMessage.textContent = 'Microphone permission denied.'; endCall(); } }; } else { callBtn.style.display = 'none'; }
    function addCallMessage(role, text) { const msgEl = document.createElement('div'); msgEl.className = `call-msg ${role}`; msgEl.textContent = text; callConversation.appendChild(msgEl); callConversation.scrollTop = callConversation.scrollHeight; }
    async function handleCallBotResponse() { if (!isCallActive) return; callStatusMessage.textContent = 'Philadelphia AI is thinking...'; tapToTalk.style.display = 'none'; const historyForBot = callHistory.map(m => m); const userMessage = historyForBot.length > 0 ? historyForBot[historyForBot.length - 1].content : ""; try { speechRecognition.stop(); const res = await fetch(`${API_BASE_URL}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: userMessage, history: historyForBot.slice(0, -1), user_id: currentUser?.uid || "user" }) }); const data = await res.json(); if (!res.ok) throw new Error(data.error || "Server error."); const botResponse = data.response; callHistory.push({ role: 'ai', content: botResponse }); addCallMessage('bot', botResponse); speakBotResponse(botResponse); } catch (err) { const errorMsg = `âŒ Call error: ${err.message}`; addCallMessage('bot', errorMsg); if (isCallActive && !isMuted) { callStatusMessage.textContent = 'Listening... (Tap to Speak)'; tapToTalk.style.display = 'block'; try { speechRecognition.start(); } catch(e) {} } } }
    async function speakBotResponse(text) { if (!isCallActive) return; botIsSpeaking = true; botImageContainer.classList.add('speaking'); callStatusMessage.textContent = 'Philadelphia AI is speaking...'; try { const res = await fetch(`${API_BASE_URL}/api/tools/text-to-speech`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text: text, voice_id: 'elder' }) }); if (!res.ok) throw new Error(await res.text()); const blob = await res.blob(); const url = URL.createObjectURL(blob); const audio = new Audio(url); currentAudio = audio; audio.onended = audio.onerror = () => { botIsSpeaking = false; botImageContainer.classList.remove('speaking'); currentAudio = null; if (isCallActive && !isMuted) { callStatusMessage.textContent = 'Listening... (Tap to Speak)'; tapToTalk.style.display = 'block'; try { speechRecognition.start(); } catch(e) {} } else if (isMuted) { callStatusMessage.textContent = 'Microphone Muted.'; tapToTalk.style.display = 'none'; } }; audio.play(); } catch (err) { botIsSpeaking = false; botImageContainer.classList.remove('speaking'); if (isCallActive && !isMuted) { callStatusMessage.textContent = 'Listening (Voice Failed)...'; tapToTalk.style.display = 'block'; try { speechRecognition.start(); } catch(e) {} } else if (isMuted) { callStatusMessage.textContent = 'Microphone Muted.'; tapToTalk.style.display = 'none'; } } }
    function stopBotSpeakingAndStartListening() { if (!isCallActive || !botIsSpeaking) return; if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; } botIsSpeaking = false; botImageContainer.classList.remove('speaking'); if (!isMuted) { callStatusMessage.textContent = 'Listening... (Tap to Speak)'; tapToTalk.style.display = 'block'; try { speechRecognition.stop(); speechRecognition.start(); } catch(e) {} } else { callStatusMessage.textContent = 'Microphone Muted.'; tapToTalk.style.display = 'none'; } const userMsgEl = callConversation.querySelector('.call-msg.user.interim'); if (userMsgEl) userMsgEl.textContent = ''; }
    callModal.addEventListener('mousedown', stopBotSpeakingAndStartListening); callModal.addEventListener('touchstart', stopBotSpeakingAndStartListening);
    callBtn.addEventListener('click', () => { if (!SpeechRecognition) { alert("Sorry, your browser doesn't support this feature."); return; } isCallActive = true; isMuted = false; muteCallBtn.classList.remove('muted'); muteCallBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> Mute Microphone'; callModal.classList.add('active'); callConversation.innerHTML = ''; addCallMessage('status', 'Connecting...'); callStatusMessage.textContent = 'Calling...'; tapToTalk.style.display = 'none'; callHistory = []; setTimeout(() => { if (!isCallActive) return; addCallMessage('status', 'Connected. Speak when ready.'); callStatusMessage.textContent = 'Listening... (Tap to Speak)'; tapToTalk.style.display = 'block'; try { speechRecognition.start(); } catch(e) { callStatusMessage.textContent = 'Microphone error.'; } }, 1500); });
    function endCall() { isCallActive = false; botIsSpeaking = false; if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; } callModal.classList.remove('active'); try { speechRecognition.stop(); } catch(e) {} botImageContainer.classList.remove('speaking'); tapToTalk.style.display = 'none'; callStatusMessage.textContent = 'Call Ended.'; }
    endCallBtn.addEventListener('click', endCall);
    if (muteCallBtn) { muteCallBtn.addEventListener('click', () => { isMuted = !isMuted; if (isMuted) { muteCallBtn.classList.add('muted'); muteCallBtn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i> Unmute'; speechRecognition.stop(); callStatusMessage.textContent = 'Microphone Muted.'; tapToTalk.style.display = 'none'; } else { muteCallBtn.classList.remove('muted'); muteCallBtn.innerHTML = '<i class="fa-solid fa-microphone"></i> Mute'; if (isCallActive && !botIsSpeaking) { callStatusMessage.textContent = 'Listening... (Tap to Speak)'; tapToTalk.style.display = 'block'; try { speechRecognition.start(); } catch(e) {} } else if (isCallActive && botIsSpeaking) { callStatusMessage.textContent = 'Philadelphia AI is speaking...'; tapToTalk.style.display = 'none'; } } }); }


  // Final initial render
  if(chatInput) chatInput.focus();
  
}); // end DOMContentLoaded
</script>
</body>
  </html>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
Â  window.dataLayer = window.dataLayer || [];
Â  function gtag(){dataLayer.push(arguments);}
Â  gtag('js', new Date()); 

Â  gtag('config', 'G-J1YTKP10ZX');
</script>

