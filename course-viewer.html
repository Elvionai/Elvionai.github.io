<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Viewer | Elvion University</title>
  <meta name="description" content="Learn with interactive courses at Elvion University. Mandatory quizzes ensure mastery before progression.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- VARIABLES & BASE STYLES --- */
    :root {
      --dark-navy: #00001a;
      --black-bg: #000000;
      --cyan-glow: #00ffff;
      --light-blue-glow: #00aaff;
      --text-color: #e0e0e0;
      --heading-color: #ffffff;
      --gradient-start: #0a1128;
      --gradient-end: #121a30;
      --card-bg: rgba(18, 26, 48, 0.85);
      --border-glow: 0 0 10px var(--cyan-glow), 0 0 20px var(--light-blue-glow);
      --hover-glow: 0 0 15px var(--cyan-glow), 0 0 30px var(--light-blue-glow);
      --button-bg: linear-gradient(45deg, var(--cyan-glow), var(--light-blue-glow));
      --button-text-color: var(--black-bg);
      --star-color: rgba(255, 255, 255, 0.7);
      --sidebar-width: 300px;
      --success-color: #4ade80;
      --warning-color: #fbbf24;
      --error-color: #f87171;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', sans-serif; background-color: var(--black-bg); color: var(--text-color); line-height: 1.7; overflow-x: hidden; position: relative; min-height: 100vh; }
    h1, h2, h3, h4, h5, h6 { font-family: 'Orbitron', sans-serif; color: var(--heading-color); margin-top: 0; }
    a { color: var(--cyan-glow); text-decoration: none; }

    /* --- LAYOUT --- */
    .course-viewer-container { display: flex; min-height: 100vh; position: relative; z-index: 1; }
    .course-sidebar { 
        width: var(--sidebar-width); background: var(--card-bg); backdrop-filter: blur(10px); 
        border-right: 1px solid rgba(0, 255, 255, 0.2); position: fixed; height: 100vh; 
        overflow-y: auto; z-index: 100; transition: transform 0.3s ease;
    }
    .content-area { 
        flex: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column; 
        min-height: 100vh; width: calc(100% - var(--sidebar-width));
    }
    .main-content { 
        flex: 1; padding: 2rem; background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    }
    .content-header { 
        display: flex; justify-content: space-between; align-items: center; 
        padding: 1.5rem 2rem; background: var(--card-bg); backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 255, 255, 0.1); 
        position: sticky; top: 0; z-index: 60;
    }
    .content-header h1 { font-size: 2rem; color: var(--cyan-glow); }
    .lesson-meta span { margin-right: 1.5rem; opacity: 0.8; font-size: 0.9rem; }
    .lesson-meta i { color: var(--light-blue-glow); }

    /* --- SIDEBAR COMPONENTS --- */
    .course-sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(0, 255, 255, 0.1); }
    .course-info { text-align: center; margin-top: 1rem; }
    .course-info h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .course-info p { opacity: 0.7; font-size: 0.9rem; }
    .course-icon-large { font-size: 2.5rem; color: var(--cyan-glow); margin-bottom: 0.5rem; }
    .back-btn { display: flex; align-items: center; gap: 0.5rem; color: var(--cyan-glow); font-weight: 600; }

    .overall-progress { margin-top: 1rem; }
    .progress-bar-container { background: rgba(255, 255, 255, 0.1); border-radius: 5px; height: 8px; margin: 0.3rem 0; overflow: hidden; }
    .progress-bar-fill { height: 100%; width: 0%; background: var(--button-bg); transition: width 0.5s ease-in-out; }
    .progress-text { font-size: 0.8rem; text-align: right; color: var(--success-color); }

    .lessons-header { padding: 0 1.5rem 0.5rem 1.5rem; font-size: 1.1rem; color: var(--heading-color); }
    .lesson-item { 
        display: flex; align-items: center; gap: 1rem; padding: 0.8rem 1.5rem; cursor: pointer; 
        transition: all 0.3s ease; border-left: 3px solid transparent; 
    }
    .lesson-item:hover { background: rgba(0, 255, 255, 0.05); }
    .lesson-item.active { background: rgba(0, 255, 255, 0.15); border-left-color: var(--cyan-glow); }
    .lesson-status { 
        width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; 
        justify-content: center; font-size: 0.8rem; font-weight: 700; color: var(--heading-color); 
        background: rgba(255, 255, 255, 0.2); 
    }
    .lesson-status.current { background: var(--cyan-glow); color: var(--black-bg); }
    .lesson-status.completed { background: var(--success-color); color: var(--black-bg); }
    .lesson-status.locked i { color: var(--text-color); }

    /* --- CONTENT CARDS & TYPOGRAPHY --- */
    .content-card {
      background: var(--card-bg); border-radius: 15px; padding: 2rem;
      box-shadow: 0 0 5px rgba(0, 255, 255, 0.1); backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 255, 0.1); margin-bottom: 2rem;
    }
    .lesson-content { line-height: 1.8; font-size: 1.1rem; }
    .lesson-content h2 { color: var(--cyan-glow); margin: 2rem 0 1rem 0; font-size: 1.8rem; }
    .lesson-content h3 { color: var(--heading-color); margin: 1.5rem 0 0.8rem 0; font-size: 1.3rem; }
    .lesson-content pre {
      background: #0d1a26; padding: 1.5rem; border-radius: 8px; 
      border-left: 4px solid var(--cyan-glow); overflow-x: auto; margin: 1.5rem 0; 
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
    }
    .lesson-content pre code { background: none; padding: 0; color: #9cdcfe; display: block; font-size: 0.95rem; line-height: 1.5; }
    .lesson-content ol, .lesson-content ul { padding-left: 1.5rem; margin-bottom: 1rem; }
    
    /* --- NAVIGATION & BUTTONS --- */
    .lesson-navigation {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1.5rem 2rem; background: var(--card-bg); backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 255, 255, 0.1); position: sticky;
      bottom: 0; z-index: 50;
    }
    .nav-buttons { display: flex; gap: 1rem; }
    .action-btn {
      padding: 0.8rem 1.5rem; background: var(--button-bg); color: var(--button-text-color);
      border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
      font-family: 'Inter', sans-serif; display: flex; align-items: center; gap: 0.5rem;
      text-transform: uppercase;
    }
    .action-btn:hover { box-shadow: var(--hover-glow); transform: scale(1.02); }
    .action-btn:disabled { 
        opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; 
        background: rgba(0, 255, 255, 0.1); border: none; color: var(--text-color); 
    }
    .action-btn.secondary { background: transparent; border: 2px solid var(--cyan-glow); color: var(--cyan-glow); }
    .action-btn.secondary:hover { background: var(--cyan-glow); color: var(--black-bg); box-shadow: var(--border-glow); }

    /* --- QUIZ/ASSIGNMENT STYLES --- */
    .quiz-container, .assignment-form-container {
        background: rgba(18, 26, 48, 0.95);
        border-radius: 15px; padding: 2rem; margin: 2rem 0;
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        border: 2px solid var(--warning-color);
    }
    .quiz-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 1.5rem; border-bottom: 1px dashed rgba(255, 215, 0, 0.5); padding-bottom: 0.5rem;
    }
    .quiz-header h2 { color: var(--warning-color); font-size: 1.5rem; }
    .quiz-timer { color: var(--error-color); font-weight: 700; font-family: 'Orbitron', sans-serif; }
    .quiz-question { margin-bottom: 1.5rem; padding: 1rem; background: rgba(0, 0, 0, 0.2); border-radius: 8px; }
    .quiz-question p { margin-bottom: 0.8rem; font-weight: 600; }
    .quiz-options label {
        display: block; padding: 0.7rem; margin-bottom: 0.5rem; cursor: pointer;
        background: rgba(255, 255, 255, 0.05); border-radius: 6px; transition: background 0.2s;
    }
    .quiz-options label:hover { background: rgba(255, 255, 255, 0.15); }
    .quiz-options input[type="radio"] { margin-right: 10px; }
    .quiz-options input[type="radio"]:checked + span { color: var(--cyan-glow); font-weight: 600; }
    
    .quiz-feedback { margin-top: 1.5rem; padding: 1rem; border-radius: 8px; font-weight: 600; }
    .quiz-feedback.pass { background: rgba(74, 222, 128, 0.2); border: 1px solid var(--success-color); color: var(--success-color); }
    .quiz-feedback.fail { background: rgba(248, 113, 113, 0.2); border: 1px solid var(--error-color); color: var(--error-color); }

    /* --- CERTIFICATE FORM STYLES --- */
    .certificate-form label { display: block; margin-top: 1rem; font-weight: 600; color: var(--cyan-glow); }
    .certificate-form input[type="text"], .certificate-form input[type="email"] {
        width: 100%; padding: 0.75rem; margin-top: 0.5rem; border-radius: 6px;
        border: 1px solid rgba(0, 255, 255, 0.3); background-color: rgba(0, 0, 0, 0.4);
        color: var(--text-color); font-size: 1rem; transition: border-color 0.3s ease;
        outline: none;
    }
    .certificate-form p.info { font-size: 0.85rem; color: var(--warning-color); margin-top: 1rem; }
    .certificate-form h2 { color: var(--success-color); text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }

    /* --- COMPLETION MODAL --- */
    .completion-modal { 
        display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; 
        background-color: rgba(0, 0, 0, 0.9); justify-content: center; align-items: center;
    }
    .completion-content {
        background: var(--gradient-start); border: 2px solid var(--success-color); border-radius: 15px; 
        padding: 3rem; max-width: 500px; width: 90%; text-align: center; box-shadow: 0 0 30px rgba(74, 222, 128, 0.5);
    }
    .completion-icon { font-size: 3rem; color: var(--success-color); margin-bottom: 1rem; }
    .completion-title { color: var(--heading-color); margin-bottom: 0.5rem; }
    .points-earned { font-size: 1.2rem; color: var(--warning-color); margin: 1rem 0; font-weight: 600; }

    /* --- RESPONSIVE ADJUSTMENTS --- */
    @media (max-width: 992px) {
      .course-sidebar { transform: translateX(-100%); width: 250px; }
      .course-sidebar.active { transform: translateX(0); }
      .content-area { margin-left: 0; width: 100%; }
      .mobile-menu-toggle { 
        display: block; position: fixed; top: 15px; left: 15px; z-index: 101;
        background: rgba(0, 0, 0, 0.8); color: var(--cyan-glow); border: 1px solid var(--cyan-glow);
        padding: 0.5rem 1rem; border-radius: 8px; font-size: 1.2rem; cursor: pointer;
      }
      .main-content { padding: 1rem; padding-top: 5rem; }
      .content-header { flex-direction: column; align-items: flex-start; }
      .lesson-navigation { padding: 1rem; flex-direction: column; gap: 1rem; }
      .nav-buttons { width: 100%; justify-content: stretch; }
      .nav-buttons .action-btn { flex: 1; justify-content: center; }
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>
  
  <button class="mobile-menu-toggle" id="mobileMenuToggle" style="display: none;">
    <i class="fas fa-bars"></i>
  </button>

  <div class="course-viewer-container">
    <aside class="course-sidebar" id="courseSidebar">
      <div class="course-sidebar-header">
        <a href="studyingatelvion.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        
        <div class="course-info">
          <i id="courseIconLarge" class="course-icon-large fas fa-laptop-code"></i>
          <h2 id="courseTitle" class="course-title">Loading...</h2>
          <p id="courseSubtitle" class="course-subtitle">Please wait...</p>
          
          <div class="overall-progress">
            <div class="progress-label">Overall Progress</div>
            <div class="progress-bar-container">
              <div id="overallProgressBar" class="progress-bar-fill" style="width: 0%"></div>
            </div>
            <div id="overallProgressText" class="progress-text">0% Complete</div>
          </div>
        </div>
      </div>

      <div class="lessons-list">
        <div class="lessons-header">Course Lessons</div>
        <div id="lessonsContainer">
          </div>
      </div>
    </aside>

    <main class="content-area">
      <div class="loading-container" id="loadingContainer" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; font-size: 1.5rem;">
        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--cyan-glow); margin-bottom: 1rem;"></i>
        <p class="loading-text">Initializing Secure Connection and Course Content...</p>
      </div>

      <header class="content-header" id="contentHeader" style="display: none;">
        <div class="lesson-info">
          <h1 id="lessonTitle">Lesson Title</h1>
          <div class="lesson-meta">
            <span><i class="fas fa-clock"></i> <span id="lessonDuration">45 min</span></span>
            <span><i class="fas fa-book"></i> Lesson <span id="currentLessonNumber">1</span> of <span id="totalLessons">8</span></span>
            <span><i class="fas fa-star"></i> <span id="lessonPoints">10</span> Points</span>
          </div>
        </div>
      </header>

      <section class="main-content" id="mainContent" style="display: none;">
        <div class="video-player" id="videoPlayer" style="background: rgba(0, 0, 0, 0.4); height: 350px; display: flex; align-items: center; justify-content: center; border-radius: 10px; margin-bottom: 2rem;">
          <div class="video-placeholder" style="text-align: center; color: rgba(255, 255, 255, 0.5);">
            <i class="fas fa-play-circle" style="font-size: 4rem;"></i>
            <p style="margin-top: 10px;">Instructional video content here</p>
          </div>
        </div>

        <div class="content-card">
          <div id="lessonContent" class="lesson-content">
            </div>
        </div>

        <div id="assessmentContainer">
            </div>
      </section>

      <nav class="lesson-navigation" id="lessonNavigation" style="display: none;">
        <div class="nav-info">
          <div class="lesson-indicator">
            Lesson <span id="navCurrentLesson">1</span> of <span id="navTotalLessons">8</span>
          </div>
          <span><i class="fas fa-trophy"></i> <span id="totalPointsEarned">0</span> Points Earned</span>
        </div>
        <div class="nav-buttons">
          <button id="prevLessonBtn" class="action-btn secondary">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button id="nextLessonBtn" class="action-btn" disabled>
            Next Lesson
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </nav>
    </main>
  </div>

  <div id="completionModal" class="completion-modal">
    <div class="completion-content">
      <i class="fas fa-trophy completion-icon"></i>
      <h2 class="completion-title" id="modalTitle">Lesson Complete!</h2>
      <p class="completion-message" id="modalMessage">
        Congratulations! You've successfully passed the assessment and completed this lesson.
      </p>
      <div class="points-earned">
        <i class="fas fa-star"></i>
        You earned <span id="pointsEarned">10</span> points!
      </div>
      
      <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button id="continueBtn" class="action-btn" style="flex: 1;">
          Continue Learning
        </button>
        <button id="backToDashboardBtn" class="action-btn secondary" style="flex: 1;">
          Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- FIREBASE PLACEHOLDER MODULE IMPORTS ---
    // Note: These imports are required for the code to run correctly in a module context,
    // but the functionality is mocked since the user has not provided a live Firebase setup.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", // Replace
      authDomain: "YOUR_AUTH_DOMAIN", // Replace
      projectId: "YOUR_PROJECT_ID", // Replace
      storageBucket: "YOUR_STORAGE_BUCKET", // Replace
      messagingSenderId: "YOUR_SENDER_ID", // Replace
      appId: "YOUR_APP_ID" // Replace
    };

    // Initialize Firebase (The code will rely on the mock data below if this fails)
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) {
        console.warn("Firebase initialization failed. Running in DEMO MODE with mock data. Actual user data won't be saved.");
    }
    
    // --- TEMPLATE CONTENT & MOCK DATA ---
    const certificateLesson = { 
        id: 99,
        title: 'Course Completion & Final Project', 
        duration: '20 min', 
        isCertificate: true,
        content: `
            <h2>Claim Your Certificate of Participation & Submit Project</h2>
            <p>Congratulations on completing the foundational knowledge portion of this course! Elvion University awards **Certificates of Participation** to recognize your dedication to pre-degree learning. These certificates are not for academic credit but attest to your commitment.</p>
            
            <h3>Final Project Submission</h3>
            <p>To finalize your certificate and receive a project result assessment, please send your completed **Final Project** (as outlined in the previous lesson) and any supporting documentation to our labs:</p>
            <p style="font-size: 1.2rem; font-weight: 700; color: var(--success-color); margin: 1rem 0;">Email your project to: <a href="mailto:elvionailabs@gmail.com" style="color: var(--success-color);">elvionailabs@gmail.com</a></p>
            <p>Use the subject line: **[Course Name] Final Project Submission - [Your Name]**</p>
        `,
        assignmentContent: (courseId, courseTitle) => `
            <div class="assignment-form-container">
                <h2>Certificate Information Submission</h2>
                <p style="margin-bottom: 1.5rem; color: var(--text-color); opacity: 0.9;">Please fill out your details to receive your personalized Certificate of Participation via email. **This form must be submitted before emailing your project.**</p>
                <form class="certificate-form" action="https://formspree.io/f/mldrbpwo" method="post">
                    <label for="full-name"><i class="fas fa-user-circle"></i> Full Name (as it should appear on certificate)</label>
                    <input type="text" id="full-name" name="Full Name" placeholder="e.g., Jane C. Doe" required>

                    <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="email" name="Email" placeholder="jane.doe@example.com" required>
                    
                    <input type="hidden" name="Course ID" value="${courseId}">
                    <input type="hidden" name="Course Title" value="${courseTitle}">

                    <p class="info"><i class="fas fa-exclamation-triangle"></i> Note: This certificate is for personal recognition only and does not award official academic credit. You will receive it by mail upon successful submission of this form and your final project.</p>

                    <button type="submit" class="action-btn" style="width: 100%; margin-top: 2rem;">
                        <i class="fas fa-award"></i> Submit & Initiate Certificate Process
                    </button>
                </form>
            </div>
        `
    };

    const quizTemplate = (lessonNumber, courseName) => `
        <div class="quiz-container" id="quizContainer">
            <div class="quiz-header">
                <h2>Mandatory Assessment: Lesson ${lessonNumber} Mastery Check</h2>
                <div class="quiz-timer" id="quizTimer">Time Left: 05:00</div>
            </div>
            <p style="margin-bottom: 1rem; color: var(--text-color);">You must correctly answer all questions below to unlock the next lesson. This is a crucial step in ensuring your foundational knowledge is solid. **You get one attempt per load!**</p>
            
            <form id="quizForm">
                <div class="quiz-question">
                    <p>1. Which of the following is a primary principle of the ${courseName} field?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q1" value="A"> <span>A. Sequential Data Storage</span></label>
                        <label><input type="radio" name="q1" value="B"> <span>B. Constitutional Hierarchy</span></label>
                        <label><input type="radio" name="q1" value="C"> <span>C. Curvature of Spacetime</span></label>
                        <label><input type="radio" name="q1" value="D"> <span>D. Inverted Pyramid Structure</span></label>
                    </div>
                </div>

                <div class="quiz-question">
                    <p>2. What time complexity does Hashing or Dictionary/Object access generally provide?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q2" value="A"> <span>A. O(n)</span></label>
                        <label><input type="radio" name="q2" value="B"> <span>B. O(1)</span></label>
                        <label><input type="radio" name="q2" value="C"> <span>C. O(log n)</span></label>
                        <label><input type="radio" name="q2" value="D"> <span>D. O(n^2)</span></label>
                    </div>
                </div>

                <div class="quiz-question">
                    <p>3. In the context of this lesson's topic, what is a key concept for structure or design?</p>
                    <div class="quiz-options">
                        <label><input type="radio" name="q3" value="A"> <span>A. The Big Freeze Theory</span></label>
                        <label><input type="radio" name="q3" value="B"> <span>B. Foreign Key Constraints</span></label>
                        <label><input type="radio" name="q3" value="C"> <span>C. The Rule of Thirds</span></label>
                        <label><input type="radio" name="q3" value="D"> <span>D. The Doctrine of Precedent</span></label>
                    </div>
                </div>
                
                <div class="quiz-feedback" id="quizFeedback" style="display:none;"></div>

                <button type="button" class="action-btn" id="submitQuizBtn" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-paper-plane"></i> Submit Assessment
                </button>
            </form>
        </div>
    `;

    const genericLessonContent = (courseName, lessonTitle) => `
        <h2>${courseName}: ${lessonTitle}</h2>
        <p>This section is currently under development but will contain a deep dive into the practical aspects of ${lessonTitle}. Expect detailed explanations, case studies, and code snippets or illustrative diagrams.</p>
        
        <h3>Key Concept: Placeholder</h3>
        <p>We believe in learning by doing. The content here will use industry-relevant examples to illustrate complex theories, ensuring you can immediately apply the knowledge you gain.</p>
        <pre><code>// Placeholder for a relevant code snippet or formula
function practicalExample() {
    console.log("Learning is best when it's practical!");
}
// This block will be replaced with detailed, colored code examples.</code></pre>
        
        <p>Continue to the bottom of the page to complete the **Mandatory Assessment** to unlock the next lesson and test your understanding.</p>
    `;

    // --- COURSE DATABASE ---
    const coursesDatabase = {
      'science-tech': {
        facultyName: 'Faculty of Science & Technology',
        courses: [
          {
            id: 'cs101',
            title: 'Computer Science: Fundamentals & Logic',
            description: 'Fundamentals of computing, programming, and algorithms',
            icon: 'fas fa-laptop-code',
            quizAnswers: { q1: 'A', q2: 'B', q3: 'B' }, // Example Answers for CS Quiz (based on content)
            lessons: [
              { id: 1, title: 'Introduction to Programming & Data Types', duration: '45 min', content: `
                  <h2>The Core of Computation: Variables and Types</h2><p>In all programming, the most fundamental concept is the **variable**—a named storage location that holds a value. Consider this as defining the raw material we use to build software logic.</p><h3>Practical Example: Defining Primitive Types (Python)</h3><p>In Python, you don't explicitly declare the type, but the type is assigned dynamically. Let’s look at the four core primitive types:</p><pre><code># Integer (Whole numbers)\nstudent_count = 358\n\n# Float (Decimal numbers)\npi_value = 3.14159265\n\n# String (Text data, always wrapped in quotes)\nuser_greeting = "Welcome to Elvion University!"\n\n# Boolean (True or False logic)\nis_enrolled = True</code></pre><p>Understanding these types is essential because different data types occupy different amounts of memory and support different operations.</p>`},
              { id: 2, title: 'Data Structures: Lists, Dictionaries, and Hashing', duration: '60 min', content: `
                  <h2>Organizing Data: Arrays vs. Dictionaries</h2><p>When you have thousands of data points, storing them in individual variables is impossible. **Data Structures** provide a blueprint for how data is related and accessed.</p><h3>1. Lists (Dynamic Arrays) - Sequential Access</h3><p>A list is a sequence of items, indexed by their position (starting at 0). It's great when order matters.</p><pre><code># Python List Example\ncourse_modules = ["Intro", "Data Types", "OOP", "Databases"]</code></pre><h3>2. Dictionaries (Hash Maps) - Keyed Access</h3><p>A dictionary stores data in **key-value pairs**. It's crucial for quick lookups, as the key is *hashed* to immediately find the value, making it much faster than searching a list (**O(1)** time complexity).</p><pre><code># Python Dictionary Example\nstudent_record = {"student_id": "ELV90210", "name": "Alexia Vane"}</code></pre>`},
              { id: 3, title: 'Object-Oriented Programming (OOP) in Action', duration: '55 min', content: genericLessonContent('Computer Science', 'Object-Oriented Programming')},
              { id: 4, title: 'Relational Databases and SQL Mastery', duration: '50 min', content: genericLessonContent('Computer Science', 'Relational Databases and SQL')},
              { id: 5, title: 'Final Project: Authentication System Design', duration: '120 min', isProject: true, content: `
                  <h2>Final Project: Authentication & Security System</h2><p>For your final project, you will design the core of any modern application: a secure user **Authentication System**. Your project should cover the following:</p><h3>Key Security Requirements</h3><ol><li>**Database Schema:** Sketch the SQL structure for a <code>Users</code> table (ID, Username, HashedPassword, Email).</li><li>**Password Hashing:** Explain the importance of one-way hashing (e.g., using **bcrypt**) and why plaintext storage is unacceptable.</li><li>**Login Flow:** Outline the step-by-step logic from a user submitting a password to the system verifying it against the stored hash.</li></ol><p>**Your project is to prepare a 500-word report and a database diagram outlining this system, ready to be emailed to Elvion Labs after the next step.**</p>`},
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
          {
            id: 'swe201',
            title: 'Software Engineering: Advanced Design',
            description: 'Mastering design patterns, testing, and modern development cycles.',
            icon: 'fas fa-cogs',
            quizAnswers: { q1: 'A', q2: 'B', q3: 'B' },
            lessons: [
              { id: 1, title: 'Introduction to Agile and Scrum', duration: '40 min', content: genericLessonContent('Software Engineering', 'Agile and Scrum Methodologies') },
              { id: 2, title: 'Design Patterns: Factory and Singleton', duration: '60 min', content: genericLessonContent('Software Engineering', 'Design Patterns: Factory and Singleton') },
              { id: 3, title: 'Test-Driven Development (TDD) and CI/CD', duration: '55 min', content: genericLessonContent('Software Engineering', 'Test-Driven Development (TDD) and CI/CD') },
              { id: 4, title: 'Microservices vs. Monolithic Architecture', duration: '50 min', content: genericLessonContent('Software Engineering', 'Microservices vs. Monolithic Architecture') },
              { id: 5, title: 'Final Project: Architectural Design Document', duration: '120 min', isProject: true, content: `<h2>Final Project: Architectural Design Document</h2><p>Your task is to prepare an Architectural Design Document (ADD) for a large-scale e-commerce application. The document should define the system's structure, technologies, and deployment strategy.</p><p>This project will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`},
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
          // Added Astrophysics based on previous request details
          {
            id: 'astro101',
            title: 'Astrophysics & Cosmography',
            description: 'The study of the universe, celestial bodies, and cosmic phenomena.',
            icon: 'fas fa-rocket',
            quizAnswers: { q1: 'C', q2: 'B', q3: 'A' }, // Example Answers for Astro Quiz
            lessons: [
              { id: 1, title: 'The Stellar Forge: Birth, Life, and Death of Stars', duration: '40 min', content: `
                  <h2>Nuclear Fusion: The Engine of the Universe</h2><p>Stars are colossal fusion reactors, primarily converting **hydrogen into helium** in their cores through the **Proton-Proton Chain Reaction**. This process releases energy ($E$) due to a tiny difference in mass ($\Delta m$), as described by Einstein's equation, $E = \Delta m c^2$.</p><h3>Observable Effects of GR</h3><ul><li>**Gravitational Lensing:** Light bends around massive objects.</li><li>**Time Dilation:** Clocks run slower near massive objects.</li></ul>`},
              { id: 2, title: 'The Fabric of Spacetime: General Relativity', duration: '50 min', content: genericLessonContent('Astrophysics', 'General Relativity')},
              { id: 3, title: 'Black Holes, Singularities, and Event Horizons', duration: '45 min', content: genericLessonContent('Astrophysics', 'Black Holes')},
              { id: 4, title: 'Cosmological Models: Big Bang and Expansion', duration: '60 min', content: genericLessonContent('Astrophysics', 'Big Bang and Expansion')},
              { id: 5, title: 'Final Project: Exoplanet Detection Report', duration: '120 min', isProject: true, content: `<h2>Final Project: Exoplanet Detection Report</h2><p>Your task is to write a detailed, 750-word report on one of the primary methods for discovering exoplanets: the **Radial Velocity Method** or the **Transit Method**. Report on the physical principle and limitations.</p><p>This report will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`},
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
        ]
      },
      'law-arts-management': {
        facultyName: 'Other Faculties',
        courses: [
          {
            id: 'law101',
            title: 'Law (LLB): Constitutional & Legal Practice',
            description: 'Study of legal principles, constitutional law, and legal practice.',
            icon: 'fas fa-gavel',
            quizAnswers: { q1: 'B', q2: 'B', q3: 'D' }, // Example Answers for Law Quiz
            lessons: [
              { id: 1, title: 'Introduction to Legal Systems and Jurisprudence', duration: '40 min', content: genericLessonContent('Law (LLB)', 'Legal Systems and Jurisprudence') },
              { id: 2, title: 'Constitutional Law: Principles of Federalism', duration: '60 min', content: genericLessonContent('Law (LLB)', 'Constitutional Law') },
              { id: 3, title: 'Criminal Law: Elements of a Crime and Defenses', duration: '55 min', content: genericLessonContent('Law (LLB)', 'Criminal Law') },
              { id: 4, title: 'Contract Law: Offer, Acceptance, and Consideration', duration: '50 min', content: genericLessonContent('Law (LLB)', 'Contract Law') },
              { id: 5, title: 'Final Project: Case Study Analysis', duration: '120 min', isProject: true, content: `<h2>Final Project: Case Study Analysis</h2><p>Your final project is to prepare a detailed legal brief (5-7 pages) analyzing a landmark case in either Constitutional Law or Criminal Law. The brief must outline the facts, the issue, the holding, and the reasoning of the court.</p><p>This analysis will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`},
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
          {
            id: 'mass101',
            title: 'Mass Communication: Digital & Media Ethics',
            description: 'Journalism, public relations, broadcasting, and digital media communication.',
            icon: 'fas fa-broadcast-tower',
            quizAnswers: { q1: 'D', q2: 'B', q3: 'C' }, // Example Answers for Mass Comm Quiz
            lessons: [
              { id: 1, title: 'Theories of Mass Communication & Media Effects', duration: '40 min', content: genericLessonContent('Mass Communication', 'Media Effects') },
              { id: 2, title: 'News Writing: Inverted Pyramid & Objectivity', duration: '60 min', content: genericLessonContent('Mass Communication', 'News Writing') },
              { id: 3, title: 'Digital Public Relations & Crisis Management', duration: '55 min', content: genericLessonContent('Mass Communication', 'Public Relations') },
              { id: 4, title: 'Media Law and Ethics: Defamation and Privacy', duration: '50 min', content: genericLessonContent('Mass Communication', 'Media Ethics') },
              { id: 5, title: 'Final Project: Digital Media Campaign', duration: '120 min', isProject: true, content: `<h2>Final Project: Digital Media Campaign Strategy</h2><p>Your task is to design a complete digital media campaign for a hypothetical non-profit organization. The plan must include a target audience analysis, social media strategy, content creation pipeline, and a crisis communication strategy. Prepare a 10-slide presentation or a 1000-word report.</p><p>This strategy will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`},
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
        ]
      },
      'creative-arts': {
        facultyName: 'Faculty of Creative Arts', // New Faculty
        courses: [
          {
            id: 'visart101',
            title: 'Digital Animation & Visual Arts',
            description: 'Mastering 2D/3D animation, digital painting, and visual storytelling.',
            icon: 'fas fa-palette',
            quizAnswers: { q1: 'A', q2: 'B', q3: 'C' }, // Example Answers for Visual Arts Quiz
            lessons: [
              { 
                id: 1, 
                title: 'Foundations of Digital Drawing and Composition', 
                duration: '40 min', 
                content: `
                  <h2>The 12 Principles of Animation</h2><p>Digital animation is built upon a set of fundamental principles developed by Disney animators. Mastering these allows for the creation of believable, dynamic, and appealing motion. The key principles are **Squash and Stretch** (for mass and weight) and **Anticipation** (to prepare the audience for an action).</p><h3>Color Theory and Digital Painting</h3><p>We will explore the use of color palettes to evoke specific moods and guide the viewer's eye. This involves understanding the **color wheel** and concepts like **Value** (lightness/darkness) and **Saturation** (intensity). Composition often relies on principles like the **Rule of Thirds**.</p>`
              },
              { id: 2, title: 'Character Design and Storyboarding', duration: '60 min', content: genericLessonContent('Digital Animation', 'Character Design') },
              { id: 3, title: 'Introduction to 3D Modeling (Mesh and Textures)', duration: '55 min', content: genericLessonContent('Digital Animation', '3D Modeling') },
              { id: 4, title: 'Rendering, Lighting, and Post-Production', duration: '50 min', content: genericLessonContent('Digital Animation', 'Rendering and Lighting') },
              { 
                id: 5, 
                title: 'Final Project: 15-Second Animated Short', 
                duration: '120 min', 
                isProject: true,
                content: `<h2>Final Project: 15-Second Animated Short</h2><p>Your final project is to create a 15-second animated short film (2D or 3D) that demonstrates at least three of the 12 principles of animation. You must provide the final video file (or link to it) and a storyboard detailing your key frames and principles used.</p><p>This short film will be the basis for your certificate assessment. Prepare the document and submit it via email after the next step.</p>`
              },
              certificateLesson
            ].map((lesson, index) => ({...lesson, id: index + 1})),
          },
        ]
      }
    };
    
    // Final mapping and setup for all courses
    Object.values(coursesDatabase).forEach(faculty => {
        faculty.courses.forEach(course => {
            const lastId = course.lessons.length;
            course.totalLessons = lastId;
            // Ensure certificate lesson is properly structured
            course.lessons[lastId - 1].assignmentContent = certificateLesson.assignmentContent(course.id, course.title);
            course.lessons[lastId - 1].id = lastId;
        });
    });


    let currentUser = {uid: 'demo-user-123'}; // Mock user for DEMO MODE
    let userData = {
        enrolledCourses: [
            // Mock enrollment for Computer Science, assuming the user is up to Lesson 3
            { courseId: 'cs101', progress: 50, currentLesson: 3, completedLessons: [1, 2] }
        ],
        totalPoints: 20
    };
    
    let currentCourse = null;
    let currentLesson = 1;
    let totalLessons = 0;
    let quizInterval = null;
    const QUIZ_TIME_LIMIT = 5 * 60; // 5 minutes

    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('courseId') || 'cs101'; // Default to CS if none specified
    const lessonParam = urlParams.get('lesson');

    // --- UTILITY FUNCTIONS ---

    function generateStars(numStars = 100) {
      const starsContainer = document.getElementById('stars-container');
      for (let i = 0; i < numStars; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = `${1 + Math.random() * 2}px`;
        star.style.height = star.style.width;
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 4}s`;
        starsContainer.appendChild(star);
      }
    }
    
    function findCourseById(courseId) {
      for (const facultyKey in coursesDatabase) {
        const course = coursesDatabase[facultyKey].courses.find(c => c.id === courseId);
        if (course) return course;
      }
      return null;
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      generateStars();
      
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const courseSidebar = document.getElementById('courseSidebar');

      mobileMenuToggle.addEventListener('click', () => {
        courseSidebar.classList.toggle('active');
        mobileMenuToggle.innerHTML = courseSidebar.classList.contains('active') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
      });
      
      if (window.innerWidth <= 992) {
          mobileMenuToggle.style.display = 'block';
      }
      
      // Attempt to load user data and initialize course (Mocked if Firebase fails)
      // The onAuthStateChanged call is handled by the module import, but the
      // actual execution relies on a user being present.
      // Since we mock currentUser, we call init directly for the demo.
      if (app && auth) {
          onAuthStateChanged(auth, (user) => {
              if (user) {
                  currentUser = user;
                  loadUserData().then(initializeCourseViewer);
              } else {
                  // Redirect if not logged in (standard procedure)
                  window.location.href = 'enroll.html';
              }
          });
      } else {
          // DEMO MODE: skip auth check and load mock data
          initializeCourseViewer();
      }
    });

    async function loadUserData() {
      // MOCK LOGIC: If Firebase is working, this will override the mock data
      if (db && currentUser) {
        try {
          const userDocRef = doc(db, 'users', currentUser.uid);
          const userDoc = await getDoc(userDocRef);
          if (userDoc.exists()) {
            userData = userDoc.data();
          }
        } catch (error) {
          console.error('Error loading user data from Firebase:', error);
        }
      }
    }

    async function initializeCourseViewer() {
      currentCourse = findCourseById(courseId);
      if (!currentCourse) {
        alert('Course not found. Redirecting to dashboard.');
        window.location.href = 'studyingatelvion.html';
        return;
      }

      totalLessons = currentCourse.totalLessons;
      
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const accessibleLesson = enrolledCourse?.currentLesson || 1;
      
      let lessonToLoad = parseInt(lessonParam) || accessibleLesson;
      currentLesson = Math.min(lessonToLoad, accessibleLesson);
      currentLesson = Math.max(currentLesson, 1);
      
      setupCourseInterface();
      renderLessonsList();
      loadLesson(currentLesson);
      
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('contentHeader').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('lessonNavigation').style.display = 'flex';
    }

    function setupCourseInterface() {
      document.getElementById('courseIconLarge').className = `course-icon-large ${currentCourse.icon}`;
      document.getElementById('courseTitle').textContent = currentCourse.title;
      document.getElementById('courseSubtitle').textContent = currentCourse.description;
      updateOverallProgress();
    }

    function updateOverallProgress() {
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const progress = enrolledCourse?.progress || 0;
      const completedLessons = enrolledCourse?.completedLessons?.length || 0;
      const academicLessons = totalLessons - 1; // Exclude the certificate lesson
      
      document.getElementById('overallProgressBar').style.width = `${progress}%`;
      document.getElementById('overallProgressText').textContent = `${progress}% Complete (${completedLessons}/${academicLessons} Academic Lessons)`;
      document.getElementById('totalPointsEarned').textContent = userData.totalPoints || 0;
    }

    function renderLessonsList() {
      const container = document.getElementById('lessonsContainer');
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const completedLessons = enrolledCourse?.completedLessons || [];
      const accessibleLesson = enrolledCourse?.currentLesson || 1;
      
      container.innerHTML = '';
      
      currentCourse.lessons.forEach((lesson, index) => {
        const lessonNumber = index + 1;
        const isCompleted = completedLessons.includes(lessonNumber);
        const isCurrent = lessonNumber === currentLesson;
        const isAccessible = lessonNumber <= accessibleLesson;
        
        const lessonItem = document.createElement('div');
        lessonItem.className = `lesson-item ${isCurrent ? 'active' : ''}`;
        
        let statusIcon, statusClass;
        if (isCompleted) {
          statusIcon = '<i class="fas fa-check"></i>';
          statusClass = 'completed';
        } else if (isAccessible) {
          statusIcon = lesson.isCertificate ? '<i class="fas fa-award"></i>' : lessonNumber;
          statusClass = 'current';
        } else {
          statusIcon = '<i class="fas fa-lock"></i>';
          statusClass = 'locked';
        }
        
        lessonItem.innerHTML = `
          <div class="lesson-status ${statusClass}">${statusIcon}</div>
          <div class="lesson-details">
            <div class="lesson-title">${lesson.title}</div>
            <div class="lesson-duration">${lesson.duration}</div>
          </div>
        `;
        
        if (isAccessible) {
          lessonItem.style.cursor = 'pointer';
          lessonItem.addEventListener('click', () => {
            if (lessonNumber !== currentLesson) {
              loadLesson(lessonNumber);
            }
          });
        } else {
          lessonItem.style.opacity = '0.5';
          lessonItem.style.cursor = 'not-allowed';
        }
        
        container.appendChild(lessonItem);
      });
    }

    function loadLesson(lessonNumber) {
      clearInterval(quizInterval);
      const lesson = currentCourse.lessons[lessonNumber - 1];
      if (!lesson) return;
      
      currentLesson = lessonNumber;
      
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('lesson', lessonNumber);
      window.history.pushState({}, '', newUrl);
      
      document.getElementById('courseSidebar').classList.remove('active');
      document.getElementById('mobileMenuToggle').innerHTML = '<i class="fas fa-bars"></i>';
      
      // Update header
      document.getElementById('lessonTitle').textContent = lesson.title;
      document.getElementById('lessonDuration').textContent = lesson.duration;
      document.getElementById('currentLessonNumber').textContent = lessonNumber;
      document.getElementById('totalLessons').textContent = totalLessons;
      document.getElementById('lessonPoints').textContent = lesson.isCertificate || lesson.isProject ? '0' : '10';

      
      // Update navigation
      document.getElementById('navCurrentLesson').textContent = lessonNumber;
      document.getElementById('navTotalLessons').textContent = totalLessons;
      
      // Update content
      document.getElementById('lessonContent').innerHTML = lesson.content;
      
      const assessmentContainer = document.getElementById('assessmentContainer');
      const nextBtn = document.getElementById('nextLessonBtn');
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const isCompleted = enrolledCourse?.completedLessons?.includes(lessonNumber);
      
      
      if (lesson.isCertificate) {
          // Certificate/Final Project Lesson
          assessmentContainer.innerHTML = lesson.assignmentContent;
          nextBtn.disabled = true;
          nextBtn.textContent = 'End of Course';
      } else if (isCompleted) {
          // Lesson is completed: show passed message, enable next
          assessmentContainer.innerHTML = `<div class="quiz-feedback pass">Assessment Passed! You are ready for the next lesson.</div>`;
          nextBtn.disabled = currentLesson === totalLessons;
          nextBtn.textContent = (currentLesson === totalLessons - 1) ? 'Go to Certificate' : 'Next Lesson';
      } else {
          // Normal Lesson: show mandatory quiz
          assessmentContainer.innerHTML = quizTemplate(lessonNumber, currentCourse.title);
          nextBtn.disabled = true;
          nextBtn.textContent = 'Next Lesson';
          startQuizTimer();
          document.getElementById('submitQuizBtn').addEventListener('click', handleSubmitQuiz);
      }
      
      document.getElementById('prevLessonBtn').disabled = lessonNumber === 1;
      
      renderLessonsList();
      window.scrollTo(0, 0);
    }
    
    // --- QUIZ LOGIC ---
    let timeLeft = QUIZ_TIME_LIMIT;

    function startQuizTimer() {
        timeLeft = QUIZ_TIME_LIMIT;
        const timerElement = document.getElementById('quizTimer');

        const updateTimer = () => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `Time Left: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 60) {
                timerElement.style.color = 'var(--error-color)';
            }

            if (timeLeft <= 0) {
                clearInterval(quizInterval);
                timerElement.textContent = 'Time Up!';
                handleSubmitQuiz(true);
            }
            timeLeft--;
        };

        clearInterval(quizInterval);
        quizInterval = setInterval(updateTimer, 1000);
        updateTimer();
    }

    function handleSubmitQuiz(isTimedOut = false) {
        clearInterval(quizInterval);
        const form = document.getElementById('quizForm');
        const feedback = document.getElementById('quizFeedback');
        const nextBtn = document.getElementById('nextLessonBtn');
        const submitBtn = document.getElementById('submitQuizBtn');
        
        // Get the correct answers for the current course
        const correctAnswers = currentCourse.quizAnswers || { q1: 'A', q2: 'B', q3: 'B' }; 
        
        const answers = {
            q1: form.elements['q1']?.value,
            q2: form.elements['q2']?.value,
            q3: form.elements['q3']?.value,
        };
        
        let score = 0;
        let totalQuestions = 3;
        
        for (const q in correctAnswers) {
            if (answers[q] === correctAnswers[q]) {
                score++;
            }
        }
        
        const passMark = totalQuestions;
        const isPassed = score === passMark;
        
        feedback.style.display = 'block';
        submitBtn.disabled = true;

        if (isTimedOut) {
             feedback.className = 'quiz-feedback fail';
             feedback.innerHTML = `<i class="fas fa-times-circle"></i> **Time Up!** Score: ${score}/${totalQuestions}. You must reload the page to restart the assessment.`;
             return;
        }

        if (isPassed) {
            feedback.className = 'quiz-feedback pass';
            feedback.innerHTML = `<i class="fas fa-check-circle"></i> **PASS!** Score: ${score}/${totalQuestions}. Mastery achieved. Click 'Next Lesson' to continue.`;
            markLessonComplete();
            nextBtn.disabled = false;
            nextBtn.textContent = (currentLesson === totalLessons - 1) ? 'Go to Certificate' : 'Next Lesson';
        } else {
            feedback.className = 'quiz-feedback fail';
            feedback.innerHTML = `<i class="fas fa-times-circle"></i> **FAIL!** Score: ${score}/${totalQuestions}. You must get all answers correct. Please refresh the page and study the content again before re-attempting.`;
        }
    }
    
    // --- EVENT LISTENERS ---
    document.getElementById('prevLessonBtn').addEventListener('click', () => {
      if (currentLesson > 1) {
        loadLesson(currentLesson - 1);
      }
    });

    document.getElementById('nextLessonBtn').addEventListener('click', () => {
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const isNextAccessible = (currentLesson + 1) <= (enrolledCourse?.currentLesson || 1);
      
      if (currentLesson < totalLessons && isNextAccessible) {
        loadLesson(currentLesson + 1);
      }
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
      document.getElementById('completionModal').style.display = 'none';
      if (currentLesson < totalLessons) {
        loadLesson(currentLesson + 1);
      } else {
          window.location.href = 'studyingatelvion.html';
      }
    });

    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
      window.location.href = 'studyingatelvion.html';
    });
    
    // --- FIREBASE/MOCK UPDATE LOGIC ---
    async function markLessonComplete() {
      const enrolledCourseIndex = userData.enrolledCourses.findIndex(c => c.courseId === courseId);
      if (enrolledCourseIndex === -1) {
          // If not found, add a new entry (MOCK fallback)
          userData.enrolledCourses.push({
              courseId: courseId, progress: 0, currentLesson: 1, completedLessons: []
          });
          const newIndex = userData.enrolledCourses.length - 1;
          return markLessonComplete(newIndex); // Re-call with index
      }
        
      const enrolledCourse = userData.enrolledCourses[enrolledCourseIndex];
      const currentLessonObj = currentCourse.lessons[currentLesson - 1];
      const pointsToAward = 10;
      
      if (!enrolledCourse.completedLessons?.includes(currentLesson)) {
        if (!enrolledCourse.completedLessons) {
          enrolledCourse.completedLessons = [];
        }
        enrolledCourse.completedLessons.push(currentLesson);
        
        enrolledCourse.currentLesson = Math.max(enrolledCourse.currentLesson || 1, currentLesson + 1);
        
        const academicLessons = totalLessons - 1;
        const completedAcademicCount = enrolledCourse.completedLessons.filter(id => id < totalLessons).length;
        enrolledCourse.progress = Math.round((completedAcademicCount / academicLessons) * 100);
        
        userData.totalPoints = (userData.totalPoints || 0) + pointsToAward;
        
        // --- FIREBASE SAVE ---
        if (db && currentUser) {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    enrolledCourses: userData.enrolledCourses,
                    totalPoints: userData.totalPoints
                });
            } catch (error) {
                console.error('FIREBASE SAVE ERROR: Progress not saved to cloud.', error);
            }
        }
        
        // Update UI
        updateOverallProgress();
        renderLessonsList();
        
        // Show completion modal
        document.getElementById('pointsEarned').textContent = pointsToAward;
        document.getElementById('modalTitle').textContent = currentLessonObj.isProject ? 'Project Knowledge Complete!' : 'Lesson Complete!';
        document.getElementById('modalMessage').textContent = currentLessonObj.isProject ? `You have studied the final project requirements. Now, submit your work to elvionailabs@gmail.com.` : `Congratulations! You've successfully passed the assessment and completed this lesson.`;
        
        document.getElementById('completionModal').style.display = 'flex';
        
        if (currentLesson === totalLessons - 1) {
            document.getElementById('continueBtn').textContent = 'Go to Certificate';
        } else {
            document.getElementById('continueBtn').textContent = 'Continue Learning';
        }
      }
    }
  </script>
</body>
</html>
