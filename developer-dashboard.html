<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Developer Dashboard | Elvion AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate and manage your API keys for Elvion AI.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cyan: #00ffff;
      --blue: #0090ff;
      --red: #ff4d4d;
      --green: #28a745;
      --card-bg: rgba(18,26,48,0.97);
      --border-glow: 0 0 11px var(--cyan), 0 0 24px var(--blue);
      --radius: 16px;
      --text: #e0e0e0;
      --white: #fff;
      --muted: #b3b3b3;
    }
    html, body { height: 100%; margin: 0; }
    body {
      min-height: 100vh; font-family: 'Inter', sans-serif;
      background: radial-gradient(circle, #23233a 65%, #0a1128 100%);
      color: var(--text); display: flex; align-items: center; justify-content: center;
      position: relative; padding: 20px;
    }
    #stars-container {
      position: fixed; width: 100vw; height: 100vh; top: 0; left: 0; z-index: 0; pointer-events: none;
    }
    .star {
      position: absolute; background: rgba(255,255,255,0.7); border-radius: 50%;
      opacity: 0; animation: twinkle 4.5s infinite linear;
    }
    @keyframes twinkle { 0%,100%{opacity:0.16;} 52%{opacity:1;}}
    .dashboard-card {
      background: var(--card-bg); border-radius: var(--radius);
      box-shadow: var(--border-glow); padding: 28px; width: 100%;
      max-width: 800px; z-index: 1; animation: fadeIn .7s;
    }
    @keyframes fadeIn {from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);}}
    .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .logo-img {
      width: 46px; height: 46px; border-radius: 50%;
      object-fit:cover; background:#fff; animation: logoPulse 3.3s infinite alternate;
      box-shadow: 0 0 0 #00ffff;
    }
    @keyframes logoPulse {0%{box-shadow: 0 0 11px #00e2ff,0 0 24px #70fff7;}100%{box-shadow:0 0 19px #007c97,0 0 33px #00ceff60;}}
    .site-heading {
      font-family:'Orbitron',sans-serif; font-size:1.3em; font-weight:800;
      background: linear-gradient(90deg, var(--cyan), #fff, var(--blue));
      background-size:200% auto; -webkit-background-clip:text;
      -webkit-text-fill-color:transparent; animation: shine 4s linear infinite;
      text-shadow: var(--border-glow);
    }
    @keyframes shine {to{background-position:200% center;}}
    .welcome-message { color: #aee; font-size: 1.1em; margin: -15px 0 25px 0; border-bottom: 1px solid rgba(0, 255, 255, 0.2); padding-bottom: 20px; }
    .submit-btn {
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      color: #102040; border: none; border-radius: 10px; padding: 12px 20px;
      font-size: 1em; font-family: 'Orbitron',sans-serif; font-weight: 700;
      cursor: pointer; box-shadow: var(--border-glow); transition: all .15s;
      text-transform: uppercase; letter-spacing:.04em;
    }
    .submit-btn:hover:not(:disabled) { transform: scale(1.03); }
    .submit-btn:disabled { cursor: not-allowed; background: #555; box-shadow: none; transform: none; }
    
    .section-header { font-family:'Orbitron',sans-serif; color: var(--cyan); margin-top: 30px; border-bottom: 1px solid rgba(0,255,255,0.1); padding-bottom: 10px; }
    
    #new-key-section { background: #18181f; padding: 20px; border-radius: 10px; margin-top: 15px; border: 1px solid #23233a;}
    .api-key-container { display: none; align-items: center; background: #101018; border: 1.3px solid #23233a; border-radius: 10px; padding: 5px 5px 5px 15px; margin-top: 15px; }
    #api-key-display { flex-grow: 1; font-family: monospace; color: #f5f5f5; font-size: 1em; overflow-wrap: break-word; }
    #copy-key-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1.1em; padding: 10px; transition: all 0.2s; }
    #copy-key-btn:hover { color: var(--cyan); transform: scale(1.2); }
    
    .status-message { font-size: .97em; margin-top: 15px; min-height: 19px; transition: color 0.3s; }
    
    #key-list-info { color: var(--muted); margin: 15px 0; }
    #api-key-list { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .key-item { display: flex; align-items: center; justify-content: space-between; background: #18181f; padding: 10px 15px; border-radius: 8px; border: 1px solid #23233a; }
    .key-details span { display: block; }
    .key-string { font-family: monospace; color: var(--white); }
    .key-date { font-size: 0.85em; color: var(--muted); margin-top: 4px; }
    .key-status { font-size: 0.8em; font-weight: 600; padding: 4px 8px; border-radius: 5px; text-transform: uppercase; }
    .key-status.active { background-color: rgba(40, 167, 69, 0.2); color: var(--green); }
    .key-status.revoked { background-color: rgba(255, 77, 77, 0.2); color: var(--red); }
    .revoke-btn { background: none; border: 1px solid var(--red); color: var(--red); font-size: 0.85em; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
    .revoke-btn:hover { background: var(--red); color: var(--white); }
    
    .loader { width: 24px; height: 24px; border: 3px solid var(--cyan); border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; margin: 20px auto; display: block; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .nav-container { position: fixed; top: 20px; right: 20px; z-index: 10; display: flex; align-items: center; gap: 20px; }
    #logout-btn { background: none; border: none; cursor: pointer; font-family: 'Inter', sans-serif; padding: 0; color: var(--cyan); text-decoration: none; font-size: 1em; transition: all 0.2s; }
    #logout-btn:hover { color: var(--white); text-shadow: 0 0 5px var(--cyan); }
  </style>
</head>
<body>
<div id="stars-container"></div>

<div class="nav-container">
    <button id="logout-btn">Log Out &rarr;</button>
</div>

<div class="dashboard-card">
    <div class="header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" class="logo-img" alt="Elvion AI Logo">
        <h1 class="site-heading">Developer Dashboard</h1>
    </div>
    <p id="welcome-message" class="welcome-message">Authenticating...</p>
    
    <h3 class="section-header">Generate New Key</h3>
    <div id="new-key-section">
        <p>Generate a new API key to integrate Elvion AI's powerful models into your applications.</p>
        <button id="generate-key-btn" class="submit-btn">Generate API Key</button>
        <div class="status-message" id="generation-status"></div>
        <div class="api-key-container" id="new-key-container">
            <code id="api-key-display"></code>
            <button id="copy-key-btn" title="Copy to clipboard"><i class="far fa-copy"></i></button>
        </div>
        <p style="font-size: 0.9em; color: var(--muted); margin-top: 10px;" id="new-key-warning" hidden><small>Store this key securely. For security reasons, you will not be able to see it again after you leave this page.</small></p>
    </div>

    <h3 class="section-header">Your API Keys</h3>
    <p id="key-list-info">Loading your keys...</p>
    <div id="api-key-list">
        <div class="loader"></div>
    </div>
</div>

<script type="module">
  // STAR ANIMATION
  document.addEventListener('DOMContentLoaded',()=>{
    const starsContainer = document.getElementById('stars-container');
    const numStars = 80, minSize=1, maxSize=2.5;
    for(let i=0; i<numStars; i++) {
      const star=document.createElement('div');
      star.className='star';
      const size = Math.random()*(maxSize-minSize)+minSize;
      star.style.width=size+'px'; star.style.height=size+'px';
      star.style.left=Math.random()*100+'%'; star.style.top=Math.random()*100+'%';
      star.style.animationDelay=(Math.random()*3.5)+'s';
      star.style.animationDuration=(2+Math.random()*1.3)+'s';
      starsContainer.appendChild(star);
    }
  });

  // FIREBASE IMPORTS
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  
  const BACKEND_URL = "https://web-production-9a18.up.railway.app"; 
  
  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // --- ELEMENTS ---
  const welcomeMessage = document.getElementById('welcome-message');
  const generateKeyButton = document.getElementById('generate-key-btn');
  const apiKeyDisplay = document.getElementById('api-key-display');
  const newKeyContainer = document.getElementById('new-key-container');
  const newKeyWarning = document.getElementById('new-key-warning');
  const copyKeyButton = document.getElementById('copy-key-btn');
  const generationStatus = document.getElementById('generation-status');
  const logoutButton = document.getElementById('logout-btn');
  const keyListInfo = document.getElementById('key-list-info');
  const apiKeyListDiv = document.getElementById('api-key-list');

  let currentUser, userToken;

  // --- MAIN AUTH GATEKEEPER ---
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      welcomeMessage.textContent = `Authenticated as ${user.email}`;
      user.getIdToken().then(token => {
        userToken = token;
        fetchAndDisplayApiKeys();
      });
    } else {
      window.location.href = 'developer-login.html'; 
    }
  });

  // --- FUNCTIONS ---

  async function fetchAndDisplayApiKeys() {
    apiKeyListDiv.innerHTML = '<div class="loader"></div>';
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/user/api-keys`, {
        headers: { 'X-Firebase-Token': userToken }
      });
      if (!response.ok) throw new Error('Failed to fetch keys.');
      
      const data = await response.json();
      apiKeyListDiv.innerHTML = ''; // Clear loader

      keyListInfo.textContent = `You have generated ${data.keys.length} API key(s).`;

      if (data.keys.length === 0) {
        apiKeyListDiv.innerHTML = '<p style="color: var(--muted);">You have not generated any API keys yet.</p>';
        return;
      }
      
      data.keys.forEach(key => {
        const keyItem = document.createElement('div');
        keyItem.className = 'key-item';
        
        const keyStringShort = `${key.api_key.substring(0, 8)}...${key.api_key.substring(key.api_key.length - 4)}`;
        const formattedDate = new Date(key.created_at).toLocaleString();

        const isActive = key.is_active === 1;

        let actionButtonHTML = '';
        if (isActive) {
            actionButtonHTML = `<button class="revoke-btn" data-key="${key.api_key}">Revoke</button>`;
        }

        keyItem.innerHTML = `
          <div class="key-details">
            <span class="key-string">${keyStringShort}</span>
            <span class="key-date">Created: ${formattedDate}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 15px;">
            <span class="key-status ${isActive ? 'active' : 'revoked'}">${isActive ? 'Active' : 'Revoked'}</span>
            ${actionButtonHTML}
          </div>
        `;
        apiKeyListDiv.appendChild(keyItem);
      });

    } catch (error) {
      apiKeyListDiv.innerHTML = `<p style="color: var(--red);">Error: Could not load your API keys. Please try again later.</p>`;
      console.error('Error fetching API keys:', error);
    }
  }

  async function handleRevokeKey(apiKey) {
    if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone and will immediately disable the key.')) {
        return;
    }

    try {
        const response = await fetch(`${BACKEND_URL}/api/user/revoke-api-key`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Firebase-Token': userToken
            },
            body: JSON.stringify({ api_key: apiKey })
        });

        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.detail || 'Failed to revoke key.');
        }

        generationStatus.textContent = 'Key successfully revoked.';
        generationStatus.style.color = 'var(--green)';
        fetchAndDisplayApiKeys(); // Refresh the list

    } catch (error) {
        generationStatus.textContent = `Error: ${error.message}`;
        generationStatus.style.color = 'var(--red)';
        console.error('Error revoking key:', error);
    }
  }
  
  // --- EVENT LISTENERS ---

  generateKeyButton.addEventListener('click', async () => {
    generateKeyButton.disabled = true;
    generateKeyButton.textContent = 'GENERATING...';
    generationStatus.textContent = 'Contacting server...';
    generationStatus.style.color = 'var(--cyan)';
    newKeyContainer.style.display = 'none';
    newKeyWarning.hidden = true;
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/user/create-api-key`, {
        method: 'POST',
        headers: { 'X-Firebase-Token': userToken }
      });
      
      const data = await response.json();
      if (!response.ok) throw new Error(data.detail || 'An unknown error occurred.');

      apiKeyDisplay.textContent = data.api_key;
      newKeyContainer.style.display = 'flex';
      newKeyWarning.hidden = false;
      generationStatus.textContent = 'Key generated successfully! Copy it now.';
      generationStatus.style.color = 'var(--green)';
      
      fetchAndDisplayApiKeys(); // Refresh the list of keys

    } catch (error) {
      console.error('Error generating API key:', error);
      generationStatus.textContent = `Error: ${error.message}`;
      generationStatus.style.color = 'var(--red)';
    } finally {
      generateKeyButton.disabled = false;
      generateKeyButton.textContent = 'Generate New API Key';
    }
  });

  copyKeyButton.addEventListener('click', () => {
    const key = apiKeyDisplay.textContent;
    if (key) {
      navigator.clipboard.writeText(key).then(() => {
        copyKeyButton.innerHTML = '<i class="fas fa-check"></i>';
        generationStatus.textContent = 'API Key copied to clipboard!';
        generationStatus.style.color = 'var(--green)';
        setTimeout(() => {
            copyKeyButton.innerHTML = '<i class="far fa-copy"></i>';
        }, 2500);
      });
    }
  });

  apiKeyListDiv.addEventListener('click', function(event) {
    if (event.target && event.target.classList.contains('revoke-btn')) {
        const keyToRevoke = event.target.getAttribute('data-key');
        handleRevokeKey(keyToRevoke);
    }
  });

  logoutButton.addEventListener('click', () => {
    signOut(auth);
  });
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
