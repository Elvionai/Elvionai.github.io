<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Elvion LMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Your Elvion University learning dashboard. Track progress, access courses, and update your profile." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ---------------------- 1. THEME & GLOBALS ---------------------- */
    :root {
      --cyan: #00ffff;
      --blue: #0090ff;
      --dark-blue: #0a1128;
      --card-bg: rgba(18,26,48,0.97);
      --header-bg: rgba(18,26,48,0.99);
      --border-glow: 0 0 11px var(--cyan), 0 0 24px var(--blue);
      --radius: 15px;
      --bg: #0a1128;
      --text: #e0e0e0;
      --muted: #a7b2c3;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(120deg, #181d32 50%, #132142 100%);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      transition: margin-left .3s; /* For sidebar integration */
    }
    
    /* ---------------------- 2. HEADER & PROFILE ---------------------- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 24px 4vw 8px 4vw; background: var(--header-bg); 
      box-shadow: var(--border-glow); border-radius:0 0 28px 28px;
      position: sticky; top: 0; z-index: 100; /* Sticky header for better UX */
    }
    .title { font-family:Orbitron,sans-serif; font-size:1.63em; color:var(--cyan); text-shadow:var(--border-glow);}
    .profile {
      display:flex; align-items:center; gap:13px; 
      background: #181e36; border-radius:12px; padding:8px 17px;
      box-shadow: 0 0 16px 2px #00ffff07;
    }
    .profile-img {
      width:52px; height:52px; border-radius:50%; background:#232857;
      object-fit:cover; border:2px solid var(--cyan);
    }
    .profile-info b { color:var(--cyan);}
    .prof-actions { margin-left:14px; display: flex; gap: 7px;}
    .prof-actions button {
      background: none; border:none; color:var(--cyan); cursor:pointer;
      font-size:1.25em; opacity:.85; transition: opacity .2s;
      vertical-align: middle;
    }
    .prof-actions button:hover { opacity: 1; text-shadow: 0 0 5px var(--cyan);}
    
    /* ---------------------- 3. MAIN CONTENT & GRID ---------------------- */
    main { max-width:1060px; margin:28px auto 0 auto; padding:20px;}
    h2 { font-family:Orbitron,sans-serif; color:var(--cyan); margin-bottom:20px; }
    .courses-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:2em;
      margin-bottom:28px;
    }
    .course-card {
      background: var(--card-bg); border-radius:var(--radius); padding:20px 16px;
      box-shadow: var(--border-glow);
      display: flex; flex-direction:column; gap:13px;
      cursor: pointer; transition: box-shadow .17s, transform .19s, border .17s;
      border:2.1px solid #131b30;
      position: relative;
    }
    .course-card.locked { 
        cursor: not-allowed;
        opacity: 0.6;
        box-shadow: 0 0 5px #ff0000;
        border-color: #ff0000;
    }
    .course-card.locked:hover {
        box-shadow: 0 0 5px #ff0000;
        border-color: #ff0000;
        transform: none;
    }
    .course-card:hover {
      box-shadow: 0 0 22px var(--cyan),0 0 44px #00c2ff49;
      border:2.1px solid var(--cyan);
      transform: scale(1.02);
      z-index:4;
    }
    .course-card.completed { border-color: #00ff88; box-shadow: 0 0 10px #00ff8855; }

    .course-header { display: flex; align-items: center; justify-content: space-between; }
    .course-title {font-size:1.19em; font-weight:700; color:#fff; font-family:Orbitron,sans-serif; }
    .course-icon { font-size: 1.5em; color: var(--cyan); }
    .course-intro {font-size:.97em; color:var(--muted); flex-grow: 1;}
    .course-meta { font-size:.92em; color:var(--cyan);}
    
    /* PROGRESS BAR STYLES */
    .progress-container {
      height: 7px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
      margin-bottom: 7px;
    }
    .progress-bar {
      height: 100%;
      width: 0%; /* Dynamic via JS */
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      transition: width 0.5s ease-out;
      box-shadow: 0 0 5px var(--cyan);
    }
    .progress-text {
      font-size: 0.9em;
      font-weight: 600;
      color: var(--cyan);
      text-align: right;
      font-family: Orbitron, sans-serif;
    }

    /* START BUTTON */
    .start-btn {
      margin-top:9px;
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      color: #161d28; border: none; border-radius: 12px; padding: 8px 0;
      font-size: 1em; font-family:'Orbitron',sans-serif; font-weight:700; cursor:pointer;
      box-shadow: 0 0 13px #00c3ff99;
      text-transform:uppercase;
      letter-spacing:.04em;
      transition: background .11s, transform .10s;
    }
    .start-btn:hover { background: var(--blue); color:#fff; transform:scale(1.02);}
    .start-btn:active { transform:scale(0.99);}
    .start-btn:disabled {
        background: #333;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        color: #999;
    }
    
    /* ---------------------- 4. COURSE DETAILS & MODAL ---------------------- */
    /* Course Details (Now used for module breakdown) */
    .course-details {
      padding:23px 19px 11px 19px; margin:20px auto; background:rgba(15,32,60,0.91);
      border-radius:14px; box-shadow:0 0 19px #0090ff18;
      max-width:600px; display:none; animation:fadeInDetail .85s;
    }
    /* Modal styles remain the same */
    .edit-modal-bg {
      position: fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(5,19,38,.69); display:none; align-items:center; justify-content:center; z-index:5000;
    }
    .edit-modal {
      background:rgba(18,27,38,0.99); color:#e0e0e0; border-radius:14px; padding:27px 21px; min-width:320px;
      box-shadow:0 0 30px #00fff2,0 0 12px #0071cf55; position:relative; max-width:98vw;
    }
    .edit-modal label {color:var(--cyan);font-family:Orbitron,sans-serif;font-size:.97em;margin-bottom:3px;display:block;}
    .edit-modal input,.edit-modal textarea{
      width:100%; max-width:400px; padding:7px 10px; border-radius:8px; border:1.5px solid #274355;
      background:#131c2c; color:#f5f5f5; font-size:1em; font-family:Inter,sans-serif;margin-bottom:13px;
    }   
    .edit-modal .btns { text-align:right;margin-top:7px;}
    .edit-modal .btns button {
      background:var(--cyan); color:#222; border:none; border-radius:7px; font-family:Orbitron,sans-serif;
      padding:7.2px 26px; margin-left:7px; font-weight:700; text-transform:uppercase; font-size: 1em; letter-spacing:.04em;
      box-shadow:0 0 4px #0fffff60; cursor:pointer;
      transition:background .11s;
    }
    .edit-modal .btns button.cancel {background:#19243c; color:#aee;}
    .edit-close {position:absolute;right:14px;top:14px;font-size:1.7em;color:#00ffff;cursor:pointer;}
    
    /* ---------------------- 5. RESPONSIVENESS & STARS ---------------------- */
    @media (max-width:650px){ header,main{padding:13px!important;} .course-details{padding:12px 7px;}}
    @media (max-width:410px){ .profile-img{width:38px;height:38px;} .edit-modal{padding:4vw;}}

    /* STAR BG STYLES (Simple for demo) */
    #stars-container {position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;}
    .star {
      position: absolute; background: #fff; border-radius: 50%; 
      box-shadow: 0 0 4px 1px var(--cyan);
      opacity: 0; animation: blink 2s infinite alternate;
    }
    @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; }}

  </style>
</head>
<body>
<div id="stars-container"></div>
<header>
  <span class="title">ELVION LMS</span>
  <div class="profile">
    <img id="profile-img" src="https://i.pravatar.cc/150?img=12" class="profile-img" alt="profile image" />
    <div class="profile-info">
      <div><b id="displayName">User Name</b></div>
      <small style="color:#aee;" id="user-email">user@elvion.edu</small>
    </div>
    <div class="prof-actions">
      <button title="Notifications"><i class="fa fa-bell"></i></button>
      <button title="Edit profile" id="edit-profile-btn"><i class="fa fa-user-edit"></i></button>
      <button title="Logout" id="logout-btn"><i class="fa fa-sign-out-alt"></i></button>
    </div>
  </div>
</header>
<main>
  <h2>My Computer Science Learning Path</h2>
  <p style="color:var(--muted); margin-bottom: 25px;">Progress is sequential. You must complete the current course before moving to the next one.</p>

  <div class="courses-grid" id="courses-grid"></div>
  
  <div class="course-details" id="course-details"></div>

  <section id="study-screen" style="display: none; padding: 25px 20px; background: var(--card-bg); border-radius: var(--radius); max-width: 800px; margin: 20px auto; box-shadow: var(--border-glow);">
    <button id="back-to-dashboard" style="background: none; border: none; color: var(--cyan); font-size: 1em; cursor: pointer; margin-bottom: 20px;"><i class="fa fa-arrow-left"></i> Back to Dashboard</button>
    <h2 id="study-course-title" style="margin-top: 0;"></h2>
    <h3 id="study-module-title" style="color: var(--blue);"></h3>
    
    <audio id="tts-audio" style="width: 100%; display: none;" controls></audio>

    <div id="study-content" style="background: #181d32; padding: 20px; border-radius: 10px; border: 1px solid #00ffff33; margin-bottom: 20px; line-height: 1.6;">
        <p style="color: var(--muted);">Content loading...</p>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button id="audio-toggle-btn" class="start-btn" style="width: 48%; margin: 0; background: #19243c; color: var(--cyan); box-shadow: none;">
            <i class="fa fa-volume-up"></i> Enable Audio Read
        </button>
        <button id="mark-as-complete-btn" class="start-btn" style="width: 48%; margin: 0;">
            <i class="fa fa-check"></i> Mark Day Complete
        </button>
    </div>
  </section>
</main>

<div class="edit-modal-bg" id="edit-modal-bg">
  <form class="edit-modal" id="edit-modal" onsubmit="return false;">
    <span class="edit-close" id="modal-close-btn">&times;</span>
    <h3 style="color:var(--cyan);text-align:center;margin-top:0">Edit Profile</h3>
    <label for="edit-name">Name</label>
    <input type="text" id="edit-name" required>
    <label for="edit-photo">Photo URL</label>
    <input type="url" id="edit-photo" placeholder="https://link.to/photo.jpg">
    <label for="edit-dob">Date of Birth</label>
    <input type="date" id="edit-dob">
    <label for="edit-bio">Bio/About Me</label>
    <textarea id="edit-bio" rows="2" placeholder="A few words about you"></textarea>
    <div class="btns">
      <button type="button" id="save-profile-btn">Save</button>
      <button type="button" class="cancel" id="cancel-profile-btn">Cancel</button>
    </div>
  </form>
</div>

<script type="module">
  // STAR BG (Simplified for efficiency)
  document.addEventListener('DOMContentLoaded', () => {
    const starsContainer = document.getElementById('stars-container');
    const numStars = 45, minSize = 1, maxSize = 2.5;
    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * (maxSize - minSize) + minSize;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 4) + 's';
      star.style.animationDuration = (2.4 + Math.random() * 1.8) + 's';
      starsContainer.appendChild(star);
    }
  });

  // ----------------- FIREBASE SETUP (PLACEHOLDERS) -----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.firebasestorage.app",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  let userProgress = {}; // Stores user's course progress data from Firestore

  // -------- NEW SEQUENTIAL COURSE LIST (Computer Science Path)
  // Each course contains a list of 'weeks' (or days/modules)
  const csPath = [
    { key: "csc101", title: "Introduction to Programming", code: "CSC 101", intro: "Foundations of software, programming, and digital algorithms.", icon: "fa-laptop-code", weeks: [
      { title: "Day 1: What is Code? & Setup", content: "<p>Welcome to programming! Today we learn what code is and how to install our tools. Code is a set of instructions a computer follows. Think of it as a recipe.</p><p><b>Task:</b> Install Python and a code editor like VS Code.</p>" },
      { title: "Day 2: Variables & Data Types", content: "<p>A <b>variable</b> is a container for data. Data types include numbers (integers, floats) and text (strings).</p><p><b>Example:</b> <code>age = 25</code> (integer), <code>name = \"Elvion\"</code> (string).</p>" },
      { title: "Day 3: Basic Input and Output", content: "<p>The <code>print()</code> function displays information to the user. The <code>input()</code> function gets information from the user.</p><p><b>Example:</b> <code>print(\"Hello\")</code> or <code>user_name = input(\"What is your name?\")</code></p>" },
      { title: "Day 4: Assignment (Quiz)", content: "<p>You have completed the first week! Take this short quiz to test your knowledge.</p><p><b>Note:</b> In a real LMS, this would link to an external quiz interface.</p>" }
    ]},
    { key: "csc102", title: "Data Structures", code: "CSC 102", intro: "Organizing and managing data efficiently for algorithms.", icon: "fa-sitemap", weeks: [
      { title: "Day 1: Arrays & Lists", content: "<p>Arrays (or Lists in Python) store a collection of items in a specific order.</p>" },
      { title: "Day 2: Stacks & Queues", content: "<p>Stacks are LIFO (Last-In, First-Out). Queues are FIFO (First-In, First-Out).</p>" }
    ]},
    { key: "csc201", title: "Object-Oriented Programming", code: "CSC 201", intro: "Designing software using 'objects' that bundle data and methods.", icon: "fa-cubes" , weeks: [
        { title: "Day 1: Classes & Objects", content: "<p>An object is an instance of a class. A class is a blueprint for creating objects.</p>" }
    ]},
    { key: "csc202", title: "Database Systems", code: "CSC 202", intro: "Relational theory, SQL, and database management.", icon: "fa-database" , weeks: [
        { title: "Day 1: SQL Basics", content: "<p>SQL is the standard language for relational database management systems.</p>" }
    ]},
    { key: "csc301", title: "Software Engineering", code: "CSC 301", intro: "Systematic approach to software design, development, and maintenance.", icon: "fa-rocket" , weeks: [{ title: "Day 1: Agile & Scrum", content: "<p>Agile is an iterative approach to project management. Scrum is a framework within Agile.</p>" }]},
    { key: "csc302", title: "Computer Networks", code: "CSC 302", intro: "Concepts of networking, protocols, and the internet architecture.", icon: "fa-network-wired" , weeks: [{ title: "Day 1: OSI Model", content: "<p>The OSI Model has 7 layers, from Physical to Application.</p>" }]},
    { key: "csc401", title: "Artificial Intelligence", code: "CSC 401", intro: "Machine learning, neural networks, and intelligent systems.", icon: "fa-brain" , weeks: [{ title: "Day 1: Neural Networks", content: "<p>Neural networks are a series of algorithms that recognize relationships in a set of data.</p>" }]},
    { key: "csc402", title: "Final Year Project", code: "CSC 402", intro: "Capstone project to apply all learned concepts.", icon: "fa-trophy" , weeks: [{ title: "Day 1: Proposal Phase", content: "<p>Define your problem, scope, and proposed solution.</p>" }]}
  ];

  let currentCourseKey = null; // Key of the course currently being studied

  // ----------------- CORE LMS FUNCTIONS -----------------
  
  // Calculates overall progress for a course based on completed weeks/days
  function calculateCourseProgress(courseKey) {
    const course = csPath.find(c => c.key === courseKey);
    if (!course) return 0;
    const totalDays = course.weeks.length;
    const completedDays = userProgress[courseKey]?.completedDays || 0;
    return Math.floor((completedDays / totalDays) * 100);
  }

  // Find the key for the next module/day to study in a course
  function findNextModule(courseKey) {
      const course = csPath.find(c => c.key === courseKey);
      if (!course) return null;
      const completedDays = userProgress[courseKey]?.completedDays || 0;
      
      // If completedDays is less than total days, return the next one
      if (completedDays < course.weeks.length) {
          return {
              moduleIndex: completedDays,
              moduleData: course.weeks[completedDays]
          };
      }
      return null; // Course is fully completed
  }


  // Populate course grid with progress bars and dynamic buttons
  function renderCourses() {
    const cg = document.getElementById("courses-grid");
    cg.innerHTML = ""; // Clear existing content
    let isPreviousCompleted = true; // Sequential check flag
    
    csPath.forEach((c, index) => {
        const overallProgress = calculateCourseProgress(c.key);
        const isCompleted = overallProgress >= 100;
        const isNextCourse = isPreviousCompleted && !isCompleted;
        const isLocked = !isPreviousCompleted;

        // Determine status and button text
        let statusClass = isCompleted ? 'completed' : (isLocked ? 'locked' : (overallProgress > 0 ? 'in-progress' : 'new'));
        let buttonText = isCompleted ? 'Review Course' : (overallProgress > 0 ? 'Continue Studying' : 'Start Studying');
        
        // Lock the button if it's not the current course in the sequence
        const buttonDisabled = isLocked ? 'disabled' : '';

        const card = document.createElement('div');
        card.className = `course-card ${statusClass}`;
        card.dataset.key = c.key;

        // Hide course details if another course is being studied, or if this course is locked.
        const courseDetailsHandler = isLocked 
            ? `alert('Prerequisite not met. Please complete ${csPath[index-1]?.code || 'previous course'} first.');` 
            : `selectCourse('${c.key}');`;
            
        card.onclick = isLocked ? () => {} : (e) => {
            if (e.target.closest('.start-btn')) return;
            selectCourse(c.key);
        };

        // Determine intro/module status
        const nextModule = findNextModule(c.key);
        let currentStatusText = "";
        if (isCompleted) {
            currentStatusText = "COMPLETED! ✅";
        } else if (overallProgress > 0) {
            currentStatusText = `Next: ${nextModule.moduleData.title} (${nextModule.moduleIndex + 1}/${c.weeks.length})`;
        } else if (!isLocked) {
             currentStatusText = "Not Started. Ready to Begin.";
        } else {
             currentStatusText = "LOCKED: Complete prerequisite first.";
        }


        card.innerHTML = `
            <div class="course-header">
                <div class="course-title">${c.title}</div>
                <i class="fa ${c.icon || 'fa-graduation-cap'} course-icon" title="${c.code}"></i>
            </div>
            <div class="course-meta">${c.code} &middot; ${c.meta}</div>
            <div class="progress-text">${isCompleted ? '100% Completed' : overallProgress + '% Progress'}</div>
            <div class="progress-container">
                <div class="progress-bar" style="width: ${overallProgress}%;"></div>
            </div>
            <div class="course-intro" style="font-style: italic;">${currentStatusText}</div>
            <button class="start-btn" data-key="${c.key}" ${buttonDisabled} onclick="event.stopPropagation(); startStudying('${c.key}');">${buttonText}</button>
        `;
        
        cg.appendChild(card);
        
        // Update sequential flag for the next iteration
        isPreviousCompleted = isCompleted;
    });

    // Reset the sequential check flag so all future courses are locked if the last one isn't finished.
    // This is implicitly handled by the forEach loop's state.
  }

  // Course Details Display (now shows module breakdown)
  function selectCourse(key) {
    const c = csPath.find(x => x.key === key);
    if (!c) return;
    const cont = document.getElementById('course-details');
    const overallProgress = calculateCourseProgress(c.key);
    const completedDays = userProgress[key]?.completedDays || 0;
    
    let modulesHtml = `<ul style="list-style: none; padding: 0; font-size: 0.95em;">`;
    c.weeks.forEach((module, index) => {
        const isCompleted = index < completedDays;
        const isCurrent = index === completedDays;
        const icon = isCompleted ? 'fa-check-circle' : (isCurrent ? 'fa-arrow-circle-right' : 'fa-circle');
        const color = isCompleted ? '#00ff88' : (isCurrent ? 'var(--cyan)' : 'var(--muted)');
        
        modulesHtml += `
            <li style="margin-bottom: 8px;">
                <i class="fa ${icon}" style="color:${color}; margin-right: 5px;"></i> ${module.title}
                <span style="float:right; color:${isCompleted ? '#00ff88' : 'var(--muted)'};">${isCompleted ? 'Completed' : (isCurrent ? 'Next' : 'Pending')}</span>
            </li>`;
    });
    modulesHtml += `</ul>`;

    cont.innerHTML = `
      <h3 style="color:var(--cyan);margin-top:0">${c.title} Module Breakdown</h3>
      <div style="color:var(--cyan); font-size:1.1em; margin-bottom:10px;">${c.code} &middot; ${c.intro}</div>
      <div class="progress-container" style="height: 10px;">
        <div class="progress-bar" style="width: ${overallProgress}%;"></div>
      </div>
      <div class="progress-text" style="text-align: left; margin-bottom: 20px;">${overallProgress}% Overall Progress</div>
      
      ${modulesHtml}
      
      <button class="start-btn" style="margin-top:2em;" onclick="startStudying('${c.key}');">
        ${overallProgress >= 100 ? 'Review Course' : (overallProgress > 0 ? 'Continue Studying' : 'Begin Study')}
      </button>
    `;
    cont.style.display = "block";
    window.scrollTo({ top: cont.offsetTop - 100, behavior: "smooth" });
  }

  // The new 'Learning Screen' logic
  function startStudying(key) {
    const course = csPath.find(x => x.key === key);
    if (!course) return;

    const nextModule = findNextModule(key);
    if (!nextModule) {
        alert(`Course ${course.code} is already completed! You can proceed to the next course.`);
        return;
    }
    
    currentCourseKey = key; // Set global state

    // Hide dashboard and show study screen
    document.querySelector('main h2').style.display = 'none';
    document.querySelector('main > p').style.display = 'none';
    document.getElementById('courses-grid').style.display = 'none';
    document.getElementById('course-details').style.display = 'none';
    const studyScreen = document.getElementById('study-screen');
    studyScreen.style.display = 'block';

    document.getElementById('study-course-title').textContent = `${course.code}: ${course.title}`;
    document.getElementById('study-module-title').textContent = nextModule.moduleData.title;
    document.getElementById('study-content').innerHTML = nextModule.moduleData.content;
    
    // Setup completion button
    const completeBtn = document.getElementById('mark-as-complete-btn');
    completeBtn.textContent = `Mark Day ${nextModule.moduleIndex + 1} Complete`;
    completeBtn.onclick = () => markDayComplete(key, nextModule.moduleIndex);
    
    // Scroll to the top of the study screen
    window.scrollTo({ top: studyScreen.offsetTop - 100, behavior: "smooth" });
    
    // Initialize Text-to-Speech
    initTTS(nextModule.moduleData.content);
  }

  // TTS Logic
  let isAudioOn = false;
  let synth = window.speechSynthesis;
  let utterance = null;
  const audioBtn = document.getElementById('audio-toggle-btn');
  const ttsAudio = document.getElementById('tts-audio');

  function initTTS(text) {
    if (!synth) {
        audioBtn.textContent = "Audio Not Supported";
        audioBtn.disabled = true;
        return;
    }
    
    // Clean content for speaking (remove HTML tags)
    const cleanedText = text.replace(/<[^>]*>/g, '').replace(/&middot;/g, '').replace(/&nbsp;/g, ' ');

    // Check if the browser supports SpeechSynthesisUtterance
    if ('SpeechSynthesisUtterance' in window) {
      utterance = new SpeechSynthesisUtterance(cleanedText);
      utterance.rate = 0.9;
      utterance.pitch = 1.0;
      utterance.voice = synth.getVoices().find(voice => voice.name.includes('Google') || voice.lang.startsWith('en')); // Try to find a good voice
      
      // Stop any previous speech
      if (synth.speaking) synth.cancel();
      isAudioOn = false;
      audioBtn.textContent = 'Enable Audio Read';
    } else {
        // Fallback for browsers without direct SpeechSynthesisUtterance (like older iOS)
        audioBtn.textContent = "Audio Fallback Active";
        audioBtn.disabled = true;
        // Since we can't reliably speak, we won't toggle the button state.
    }
  }

  audioBtn.onclick = () => {
    if (!utterance) return;
    
    if (isAudioOn) {
        synth.pause();
        audioBtn.textContent = '<i class="fa fa-volume-up"></i> Enable Audio Read (Paused)';
    } else {
        synth.resume();
        if (!synth.speaking) {
            synth.speak(utterance);
        }
        audioBtn.textContent = '<i class="fa fa-volume-down"></i> Disable Audio Read (Playing)';
    }
    isAudioOn = !isAudioOn;
  };

  // Back button logic
  document.getElementById('back-to-dashboard').addEventListener('click', () => {
    if (synth.speaking) synth.cancel();
    isAudioOn = false;
    document.getElementById('study-screen').style.display = 'none';
    document.querySelector('main h2').style.display = 'block';
    document.querySelector('main > p').style.display = 'block';
    document.getElementById('courses-grid').style.display = 'grid';
    document.getElementById('course-details').style.display = 'none'; // Hide details again
    renderCourses(); // Re-render to update status
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Function to save and advance progress
  async function markDayComplete(courseKey, completedIndex) {
    const course = csPath.find(x => x.key === courseKey);
    const totalDays = course.weeks.length;

    // Check if we are marking the correct module as complete
    if (completedIndex !== (userProgress[courseKey]?.completedDays || 0)) {
        alert("Error: Progress state mismatch. Refresh and try again.");
        return;
    }

    const nextCompletedDays = completedIndex + 1;
    const isCourseCompleted = nextCompletedDays >= totalDays;

    // 1. Update local state
    userProgress[courseKey] = { completedDays: nextCompletedDays };
    
    // 2. Update Firestore (if a real user)
    if (currentUser.uid !== "demo-user") {
        try {
            await setDoc(doc(db, "user-progress", currentUser.uid), {
                [courseKey]: { completedDays: nextCompletedDays, completed: isCourseCompleted, lastUpdated: new Date() }
            }, { merge: true });
        } catch(e) {
            console.error("Error updating progress in Firestore: ", e);
            alert("Warning: Could not save progress to the server.");
        }
    }
    
    // 3. User Feedback and Redirection
    if (isCourseCompleted) {
        alert(`Congratulations! You have completed ${course.code}. You can now proceed to the next course in the path.`);
    } else {
        alert(`Day ${nextCompletedDays} marked complete! Moving to the next day.`);
    }
    
    // Stop audio
    if (synth.speaking) synth.cancel();

    // Re-render the dashboard to show the updated progress
    document.getElementById('back-to-dashboard').click();
  }


  // ----------------- PROFILE & AUTH FUNCTIONS -----------------
  let currentUser = null;
  let userDocRef = null;

  onAuthStateChanged(auth, async user => {
    if (!user) {
      // Failsafe for demo: use placeholder data if user is null
      currentUser = { uid: "demo-user", displayName: "A. Student", email: "demo@elvion.edu", photoURL: 'https://i.pravatar.cc/150?img=12' };
    } else {
      currentUser = user;
      userDocRef = doc(db, "users", user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const extra = snap.data();
        document.getElementById('edit-dob').value = extra.dob || "";
        document.getElementById('edit-bio').value = extra.bio || "";
      }
    }
    
    // Load progress data for the demo user
    if (currentUser.uid === "demo-user") {
        // DEMO PERSISTENCE: Use Local Storage for progress
        const localProgress = localStorage.getItem('elvion-progress');
        userProgress = localProgress ? JSON.parse(localProgress) : {};
        
        // Ensure all courses are initialized in userProgress if not present
        csPath.forEach(c => {
             if (!userProgress[c.key]) {
                userProgress[c.key] = { completedDays: 0, completed: false };
             }
        });
        
    } else {
        // REAL USER: Load from Firestore (Placeholder code)
        const progressDocRef = doc(db, "user-progress", currentUser.uid);
        const progressSnap = await getDoc(progressDocRef);
        userProgress = progressSnap.exists() ? progressSnap.data() : {};
    }
    
    // Override markDayComplete for demo user to save to local storage
    if (currentUser.uid === "demo-user") {
        window.markDayComplete = async (courseKey, completedIndex) => {
            const course = csPath.find(x => x.key === courseKey);
            const totalDays = course.weeks.length;

            if (completedIndex !== (userProgress[courseKey]?.completedDays || 0)) {
                alert("Error: Progress state mismatch. Refresh and try again.");
                return;
            }

            const nextCompletedDays = completedIndex + 1;
            const isCourseCompleted = nextCompletedDays >= totalDays;
            
            // Update local state
            userProgress[courseKey] = { completedDays: nextCompletedDays, completed: isCourseCompleted };
            
            // Save to Local Storage
            localStorage.setItem('elvion-progress', JSON.stringify(userProgress));

            // User Feedback and Redirection
            if (isCourseCompleted) {
                alert(`Congratulations! You have completed ${course.code}. You can now proceed to the next course in the path.`);
            } else {
                alert(`Day ${nextCompletedDays} marked complete! Moving to the next day.`);
            }

            if (synth.speaking) synth.cancel();
            document.getElementById('back-to-dashboard').click();
        };
    } else {
        window.markDayComplete = markDayComplete; // Use the real function
    }


    document.getElementById("displayName").textContent = currentUser.displayName || currentUser.email.split('@')[0];
    document.getElementById("user-email").textContent = currentUser.email || "";
    document.getElementById("profile-img").src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||currentUser.email||'EV')}&background=190021&color=fff&bold=true&rounded=true&size=128`;
    
    // Expose core functions globally so they can be called from inline HTML (or keep using event listeners)
    window.selectCourse = selectCourse;
    window.startStudying = startStudying;

    renderCourses(); // Render courses once we have the user context
  });

  document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
    // Clear demo progress on logout
    localStorage.removeItem('elvion-progress');
    alert("Logged out! (Demo mode - Progress cleared)");
    location.reload(); 
  });

  // Modal logic (remains the same)
  const modalBg = document.getElementById('edit-modal-bg');
  const editName = document.getElementById('edit-name');
  const editPhoto = document.getElementById('edit-photo');

  function openEditModal() {
    modalBg.style.display = "flex";
    editName.value = currentUser.displayName || "";
    editPhoto.value = currentUser.photoURL || "";
    editName.focus(); // Accessibility: set focus to the first input
  }
  function closeEditModal() {
    modalBg.style.display = "none";
  }

  document.getElementById('edit-profile-btn').addEventListener('click', openEditModal);
  document.getElementById('modal-close-btn').addEventListener('click', closeEditModal);
  document.getElementById('cancel-profile-btn').addEventListener('click', closeEditModal);

  document.getElementById('save-profile-btn').addEventListener('click', async () => {
    const name = editName.value.trim();
    const photo = editPhoto.value.trim();
    const dob = document.getElementById('edit-dob').value;
    const bio = document.getElementById('edit-bio').value.trim();
    
    const saveButton = document.getElementById('save-profile-btn');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    try {
      // 1. Update Firebase Auth (if real user)
      if (currentUser.uid !== "demo-user") {
          await updateProfile(currentUser, {
              displayName: name || currentUser.displayName,
              photoURL: photo || currentUser.photoURL
          });
          // 2. Update Firestore (if real user)
          await setDoc(userDocRef, { 
              name, dob, bio, photoURL: photo, email: currentUser.email, updatedAt: new Date()
          }, { merge: true });
      }

      // Update UI
      currentUser.displayName = name; // Update local currentUser object for immediate use
      currentUser.photoURL = photo;
      document.getElementById('displayName').textContent = name;
      document.getElementById('user-email').textContent = currentUser.email;
      document.getElementById('profile-img').src = photo || document.getElementById('profile-img').src;

      closeEditModal();
      alert('Profile saved successfully!');
    } catch(error) {
        console.error("Error saving profile:", error);
        alert("Failed to save profile. Check console for details.");
    } finally {
        saveButton.textContent = 'Save';
        saveButton.disabled = false;
    }
  });

</script>
</body>
</html>
