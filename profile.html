<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Philadelphia AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css"/>
  <style>
:root {
  --cyan: #00fff7;
  --blue: #0a8afe;
  --dark-bg: #070b1a;
  --fade-blue: #133c8b;
  --gradient-1: linear-gradient(120deg, #000a2e 39%, #04336a 68%, #10bfff 97%);
  --gradient-user: linear-gradient(120deg, #0857ee 32%, #00fff0 89%);
  --glass: rgba(25, 38, 67, 0.82);
  --bubble-glow: 0 0 13px #00d8ffb1, 0 0 24px #0197ff40;
  --user-glow: 0 0 22px #0fffd555, 0 0 14px #36f9ff70;
  --header-glass: rgba(17,29,47,0.92);
  --code-bg: linear-gradient(92deg,#031d39 79%,#092ff8 120%);
  --code-border: #15faff;
  --code-text: #17fafd;
}
/* -- BG & Star Layer -- */
html, body {
  height: 100vh; width: 100vw; margin: 0; padding: 0;
  color: #e1fafe;
  background:
    radial-gradient(circle at 60% 45%, #112250 37%, #060e1e 88%, #1e0942 100%) fixed,
    repeating-linear-gradient(100deg,#061c4c 0 9%,#080e20 16% 19%,#030721 30% 41%,#052650 44% 62%,#050b16 74% 89%,#041048 99% 100%);
  background-blend-mode: lighten, color-dodge;
  font-family: 'Roboto','Inter',system-ui,-apple-system,Segoe UI,sans-serif;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}
body { overflow: hidden; min-height: 100vh; width: 100vw; }
#stars-container {
  pointer-events: none;
  position: fixed; left:0; top:0;right:0;bottom:0;
  width:100vw; height:100vh; z-index:1;
  overflow: hidden;
}
.star {
  position:absolute;
  background: #08ecff;
  box-shadow:0 0 12px #00fff9cc,0 0 22px #1bf2f2cc;
  opacity: 0.23;
  border-radius: 50%;
  pointer-events: none;
  animation: star-twinkle 2.7s infinite alternate;
}
@keyframes star-twinkle {
  0% { opacity:.18; }
  41% { opacity:.88; }
  100%{ opacity:.09;}
}

/* -- Neon Header/Sticky Keyboard -- */
.header-bar {
  position: fixed; top: 0; left: 0; width: 100vw;
  display: flex; align-items: center; justify-content: space-between;
  background: var(--header-glass);
  z-index: 1003;
  padding: 0 0 0 0;
  box-shadow: 0 7px 48px #00aaff27, 0 3px 41px #09fcfe15;
  border-radius: 0 0 22px 22px;
  height: 70px;
}
.menu-btn {
  background: none; border: none;
  color: var(--cyan); font-size: 2em; cursor: pointer;
  border-radius: 14px; margin-left: 17px; margin-right: 3px;
  padding: 7px 11px;
}
.menu-btn:hover { background: #00eaff28; color: #fff; }
.site-heading {
  font-family: 'Orbitron',sans-serif;
  font-size: 1.28em; font-weight: 700;
  text-align: center; flex: 1;
  letter-spacing: .27px;
  white-space:nowrap;
  background: linear-gradient(90deg,#00fff1,#00b4ff 40%,#fff 59%,#1093f1 89%,#24e0fa 100%);
  background-size: 250% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: neonglow 4.2s ease-in-out infinite alternate;
  text-shadow: 0 0 12px #00ffe0cc, 0 0 27px #178fcf88;
  user-select: none; margin-left: 8px; margin-right: 10px;
}
@keyframes neonglow {
  0% { text-shadow: 0 0 17px #00e7ff70,0 0 30px #0b8fff44;}
  100% { text-shadow: 0 0 29px #00ffe9ee,0 0 44px #31d2ff82;}
}
.header-welcome {
  color: #68e6fd; font-size: .97em; margin: -2px 0 .7em 0; text-align: center;
  text-shadow: 0 0 14px #00bcb4a8;
}

/* New: Main content area to hold everything else */
.main-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    overflow-y: hidden;
    position: relative;
    padding-top: 70px; /* Space for the header */
    padding-bottom: 86px; /* Space for the footer */
    box-sizing: border-box;
}
.card-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100vw;
    height: 100%;
    min-height: 100%;
    background: transparent;
    box-sizing: border-box;
    position: relative;
}

/* -- Chat area FIXED SCROLLING -- */
.chat-box {
  flex: 1 1 0px; 
  overflow-y: auto;
  overflow-x: hidden;
  width: 100vw; max-width: 635px; margin: 0 auto;
  box-sizing: border-box;
  padding: 15px 8px 40px 8px;
  position: relative;
  z-index:3;
  scroll-behavior: smooth;
  /* FORCE SCROLL TO BOTTOM */
  display: flex;
  flex-direction: column;
}
.chat-message {
  width: 100%; display: flex; gap:9px; align-items: flex-end;
  margin: 8px 0; max-width:100vw;
  flex-shrink: 0;
}
.chat-message .msg {
  font-size: 1.01em; line-height: 1.58;
  max-width: 62vw; min-width:0; 
  padding: 11px 16px 12px 15px;
  border-radius: 16px 14px 11px 12px;
  word-break: break-word; white-space: pre-wrap; overflow-x: auto;
  background: var(--gradient-1); color: #e1fafe;
  text-shadow: 0 0 3px #23d8ff15;
  box-shadow: var(--bubble-glow);
  margin-right: auto; margin-left: 0;
  border: 1.2px solid #0090ffa0; position:relative;
  transition:background .15s;
}
.chat-message.user { justify-content: flex-end; }
.chat-message.user .msg {
  background: var(--gradient-user);
  color: #141825; font-weight: 700;
  text-shadow: 0 0 5px #00e0ff77, 0 0 2px #00ffe033;
  border-radius: 17px 13px 15px 11px;
  margin-left: auto; margin-right: 0;
  box-shadow: var(--user-glow);
  border: 1.2px solid #04eef4c9;
  max-width: 68vw;
}
@media (max-width:790px) {
  .chat-box { max-width:100vw; padding: 15px 4px 40px 4px; }
  .chat-message .msg { font-size: .97em; padding:9px 4vw 10px 5vw; max-width:80vw;}
  .chat-message.user .msg { max-width: 83vw; }
}

/* -- ENHANCED Typing Dots (MORE VISIBLE) -- */
.typing-bubble {
  display: inline-flex;
  align-items: center;
  height: 28px;
  padding: 4px 12px;
  margin: 6px 4px;
  border-radius: 15px;
  background: linear-gradient(90deg,#0a4477dd 30%,#0ebfff88 95%);
  box-shadow: 0 2px 12px #0dfcff77;
  border: 1px solid #00ffff55;
}
.dot-anim {
  display:inline-block;
  width: 8px; height: 8px;
  margin:0 3px; 
  background: #05fff9;
  border-radius: 50%;
  opacity: 0.85;
  animation: typing-blink 1.4s infinite both;
  box-shadow: 0 0 6px #05fff9aa;
}
.dot-anim:nth-child(2){animation-delay:.3s;}
.dot-anim:nth-child(3){animation-delay:.6s;}
@keyframes typing-blink {
  0%,100% {opacity:.25; transform: scale(0.8);}
  25%  {opacity:.95; transform: scale(1.1);}
  50%  {opacity:1; transform: scale(1.2);}
  75%  {opacity:.65; transform: scale(1);}
}

/* -- Code block glow, copy button -- */
pre, code {
  font-family: 'JetBrains Mono','Fira Mono','Menlo',monospace;
  font-size: .99em;
  background: var(--code-bg);
  border-radius: 11px;
  border: 1.7px solid var(--code-border);
  color: var(--code-text);
  box-shadow: 0 0 19px #00eaff38, 0 0 48px #0beaff38 inset;
}
pre {
  overflow-x: auto;
  padding: 1.18em 1.3em 1.16em 1.13em;
  margin: 1.15em 0 1em 0; position: relative;
}
pre:before {
  content: "CODE";
  color: #07eefb;
  font-size: 0.82em;
  font-family: 'Orbitron', monospace;
  position: absolute; top: 5px; right: 29px; opacity: 0.17;
  letter-spacing: 0.13em; pointer-events: none;
}
.copy-btn {
  position: absolute; top: 10px; right: 13px; z-index: 3;
  border-radius: 8px; border: none; padding: 3px 15px;
  background: linear-gradient(95deg,#0cf3ff 40%,#0980ff 120%);
  color: #06182f; font-size: .98em; font-family: 'Inter'; font-weight: bold;
  box-shadow: 0 2px 9px #18e3ffc5,0 0 7px #00ffd7a4;
  transition: background .15s, color .15s;
  cursor: pointer; outline: none; border: 1px solid #0cf3ff35;
}
.copy-btn:hover { background: #008cee; color: #fff; }

/* -- Chat controls ALWAYS VISIBLE -- */
.inline-copy-btn, .inline-share-btn, .regen-btn, .inline-edit-btn {
  padding:4px 10px; border-radius:7px; border:none;
  background:linear-gradient(94deg,#00fff6,#0090ff 97%);
  color:#0f1a31; font-family:'Inter',Arial,sans-serif; font-size:.96em;
  font-weight:600; display:inline-flex; align-items:center; gap:4px; 
  margin-top:6px; margin-right: 3px; cursor:pointer;
  box-shadow:0 2px 7px #17f6fe51;transition:background .14s,color .13s;
}
.inline-copy-btn:hover, .inline-share-btn:hover, .regen-btn:hover, .inline-edit-btn:hover{background:#009cff;color:#fff;}

/* --- ENHANCED File Preview with X Button --- */
.file-preview{
  display:none;
  background:rgba(15,36,65,0.98);
  border-radius:12px;color:#c4f2ff;font-size:.98em;
  box-shadow:0 3px 15px #00aac0bb;
  margin:0 auto 10px auto;width:94vw;max-width:520px;
  padding:10px 14px 10px 15px;
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  z-index: 1002;
  border: 1.5px solid #00ffff44;
}
.file-preview img, .file-preview video {
  max-width:58px;max-height:41px;border-radius:6px;margin-right:6px;vertical-align: middle;
}
.file-preview audio { width:52px; margin-right:7px; }
.remove-file-btn {
  color: #fff !important; 
  background:#d23 !important;
  border:none !important; 
  border-radius:50% !important;
  padding:2px 6px !important; 
  cursor:pointer !important;
  font-size:1.2em !important; 
  font-weight:bold !important;
  margin-left:8px !important;
  transition: background .16s, color .16s !important;
  min-width: 24px !important;
  height: 24px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
}
.remove-file-btn:hover { 
  background:#ff4444 !important; 
  color:#fff !important;
  transform: scale(1.1) !important;
}

/* -- Sticky Footer/Keyboard -- */
.chat-input-row {
  position: fixed; left: 0; bottom: 0;
  display: flex; align-items: stretch; gap: 8px;
  background: rgba(17,29,47,0.94); backdrop-filter: blur(8px);
  border: 1.5px solid #1af8ff51; border-radius: 23px 23px 0 0;
  width: 100vw; max-width: 635px;
  margin: 0 auto;
  padding: 9px 12px 10px 13px; box-shadow: 0 0 39px #007fff22, 0 11px 33px #00fff014;
  z-index: 1003;
}
.chat-input-row textarea{
  flex:1 1 auto;resize:none;min-height:36px;max-height:80px;
  background:#09284c;color:#f5ffff;font-size:1em;
  padding:10px 12px;border:none;border-radius:11px;
  box-shadow:0 1px 6px #00f2ff27;
}
.chat-input-row button, .chat-input-row label{
  background:none;border:none;color:#07eaff;font-size:1.21em;
  cursor:pointer;border-radius:10px;transition:color .13s,background .15s;padding:0 0;
  display:flex;align-items:center;justify-content:center;min-width:33px;
  box-shadow: 0 0 3px #00eaff20;
}
.chat-input-row button:hover, .chat-input-row label:hover{color:#fff;background:#00cdf247;}
.file-upload-btn{cursor:pointer;}
.file-upload-btn:hover{color:#00ffdf;background:#08d3ce9a;}

/* -- Emoji panel (ABOVE INPUT) -- */
#emojiPanel {
  display:none;
  position: fixed;
  left:10px;
  bottom:110px;
  z-index:2222;
  background: #051f46f9;
  border-radius: 15px;
  padding: 16px 15px 12px 15px;
  box-shadow: 0 5px 22px #00fff194;
  border: 1px solid #00ffff66;
}
.emoji-pick {
  font-size:1.23em;
  cursor:pointer;
  padding:4px 8px;
  border-radius:10px;
  transition:background .13s;
  user-select:none;
}
.emoji-pick:hover { background:#35cdfd66; }

/* -- Status message -- */
.status-message{padding:6px 13px;color:#12ffc7;font-size:.98em;min-height:17px;text-align:center;margin:4px auto 0 auto;max-width:430px;word-break:break-word;}

/* -- Modal/panel, sharp -- */
.panel-bg {
  display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(13,20,52,0.86);z-index:1200;
}
.panel-bg.active{display:block;}
.side-panel{position:absolute;top:0;left:0;height:100vh;width:325px;background:linear-gradient(118deg,#131642 80%,#1629af 200%);border-right:2.5px solid #00fbffcb;box-shadow:0 0 42px #25f8ffc9;z-index:1212;
  padding:18px 16px 20px 15px;overflow-y:auto;border-radius:0 24px 32px 0;}
.side-panel .panel-header{text-align:center;margin:18px 0 13px 0;}
.side-panel img{width:56px;height:56px;border-radius:53%;margin-bottom:8px;border:2px solid #31f6ffea;}
.side-panel .username{font-weight:700;font-size:1.11em;color:#08d0fe;font-family:'Orbitron',sans-serif;text-shadow:0 0 8px #00eaffbb;}
.side-panel .email{font-size:.97em;color:#a8eaff;}
.panel-links a{color:#13efff;text-decoration:none;font-weight:500;font-size:1.08em;padding:8px 4px;display:block;border-radius:9px;transition:background .14s;}
.panel-links a:hover{background:#00eaff55;color:#f4fdff;}

#chatsList button{background:none;border:none;cursor:pointer;outline:none;font-size:1.11em;margin:0 5px;vertical-align:middle;border-radius:7px;padding:3px 5px;}
#chatsList .fa-pen{color:#0fe0ee;transition:color .13s;}
#chatsList .fa-pen:hover{color:#ffd800;}
#chatsList .fa-trash{color:#ff244e;transition:color .10s;}
#chatsList .fa-trash:hover{color:#fff900;}
#chatsList .fa-play{color:#04ea70;font-size:1.2em;}
#chatsList .fa-play:hover{color:#31adff;}
.edit-form label{display:block;margin-top:10px;font-size:.99em;color:#38e4ff;text-shadow:0 1px 14px #11aaff71;}
.edit-form input{
  width:99%;padding:7px 11px;margin-top:5px;
  border:1.7px solid #13f0ff95;border-radius:9px;background:#071f35;color:#fff;font-size:1.02em;
  box-shadow:0 0 8px #04f6fd81 inset;transition:border-color .17s,box-shadow .17s;}
.edit-form input:focus{border-color:#27eeff;background:#273f5d;color:#fff;}
.submit-btn{
  margin-top:14px; padding:10px 20px;
  background:linear-gradient(94deg,#00ffff,#0090ff 90%);
  border:none; border-radius:10px;
  color:#102649; font-weight:bold; cursor:pointer; font-size:1.11em;
  box-shadow:0 2px 13px #00fff292; transition:background .14s,color .13s;}
.submit-btn:hover{background:#008cff;color:#fff;}
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <div class="main-content">
    
    <div class="header-bar">
      <button class="menu-btn" id="openProfileMenu" aria-label="Open profile menu"><i class="fa-solid fa-user"></i></button>
      <div class="header-titles">
        <span class="site-heading">ðŸ¦…Philadelphia AIðŸ¦…</span>
        <div class="header-welcome" id="headerWelcome"></div>
      </div>
      <button class="menu-btn" id="openLinksMenu" aria-label="Open links menu"><i class="fa-solid fa-link"></i></button>
    </div>

    <div class="chat-box" id="chatBox"></div>

    <form class="chat-input-row" id="chatForm" autocomplete="off">
      <button type="button" id="emojiBtn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
      <label for="chatFile" class="file-upload-btn" title="Attach file"><i class="fa-solid fa-paperclip"></i></label>
      <input type="file" id="chatFile" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none">
      <textarea id="chatInput" placeholder="Type hereâ€¦ (Shift+Enter = new line)"></textarea>
      <button type="button" id="toolBtn" title="Philadelphia Tools" aria-controls="toolMenu" aria-expanded="false"><i class="fa-solid fa-gear"></i></button>
      <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
    </form>

  </div>
  
  <div id="emojiPanel"></div>
  <div class="status-message" id="statusMsg"></div>

  <div id="filePreview" class="file-preview"></div>
  
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:1.17em;font-weight:700;color:#00ffff;margin:18px 0 0 13px;">Chats</span>
        <button style="font-size:1.55em;color:#f44;background:transparent;border:none;margin:13px 11px 0 0;cursor:pointer;border-radius:7px;"
          onclick="profileMenuBg.classList.remove('active');">&times;</button>
      </div>
      <div id="chatsList" style="margin:7px 0 8px 6px;max-height:161px;overflow-y:auto;"></div>
      <button id="newChatBtn" class="submit-btn" style="margin:0 0 12px 11px;"><i class="fa-solid fa-plus"></i> New Chat</button>
      <hr style="width:91%;margin:11px 0 7px 3%;border:1px solid #00fff031;">
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail">email@example.com</div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 6px;">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Paste image link">
        <span style="font-size:0.83em;color:#aae;display:block;margin:5px 0 7px 2px;">
          Tip: <a href="https://postimg.cc/" target="_blank" style="color:#19fcff;">Upload at postimg.cc</a>
        </span>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <button class="submit-btn" id="logoutBtn" style="background:#10213b;color:#00eefd;margin:7px 7px 17px 7px;">Logout</button>
    </nav>
  </div>
  
  <div id="ai-image-preview" style="display:none;position:fixed;z-index:1210;right:22px;bottom:100px;max-width:320px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;">
    <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
    <div id="ai-image-container"></div>
    <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
  </div>
  
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel" id="linkMenu">
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
        <div class="username">Elvion AI</div>
      </div>
      <div class="panel-links">
        <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </nav>
  </div>

  <div class="panel-bg" id="toolsMenuBg">
    <nav class="side-panel" id="toolsMenu">
        <div class="panel-header" style="text-align:left;">
            <div class="username" style="font-size:1.2em;margin-left:-8px;text-align:center;">Philadelphia AI Tools</div>
        </div>
        <div class="panel-links">
            <a href="#" class="tool-link" data-tool="image"><i class="fa-solid fa-image"></i> Generate Image</a>
            <a href="#" class="tool-link" data-tool="comic"><i class="fa-solid fa-book-open"></i> Create Comic</a>
            <a href="#" class="tool-link" data-tool="website"><i class="fa-solid fa-globe"></i> Create Website</a>
            <a href="#" class="tool-link" data-tool="research"><i class="fa-solid fa-magnifying-glass"></i> Research</a>
            <a href="#" class="tool-link" data-tool="remove-bg"><i class="fa-solid fa-cut"></i> Remove Background</a>
            <a href="#" class="tool-link" data-tool="voice-gen"><i class="fa-solid fa-microphone-lines"></i> Generate Voice</a>
            <a href="#" class="tool-link" data-tool="audio-narration"><i class="fa-solid fa-file-audio"></i> Audio Narration</a>
        </div>
        <button class="submit-btn" style="margin-top:17px;" onclick="closeToolMenu();">Close</button>
    </nav>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Short helper
const $ = id => document.getElementById(id);

// ---------- Global chat storage (now with Firebase) ----------
let chats = [];
let currentChatId = null;
let currentChatHistory = [];
let userUnsubscribe = null;
let chatUnsubscribe = null;

const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
let pendingToolAction = null;

// Keep file/upload state
let uploadedFiles = [];
let uploadData = null;

// Helper to remove any pending subscriptions
function unsubscribeAll() {
  if (userUnsubscribe) userUnsubscribe();
  if (chatUnsubscribe) chatUnsubscribe();
}

// Function to save a new message to Firestore
async function saveMessage(role, text) {
  if (!currentUser || !currentChatId) return;
  try {
    const docRef = await addDoc(collection(db, `users/${currentUser.uid}/chats/${currentChatId}/messages`), {
      role,
      text,
      timestamp: new Date(),
    });
  } catch (e) {
    console.error("Error adding document: ", e);
  }
}

// Function to update the chat history from a snapshot
function updateChatHistory(docs) {
  currentChatHistory = docs.map(d => d.data());
  renderChatBox(currentChatHistory);
  renderChatsListSidebar();
}

// ---------- DOM & wiring ----------
window.addEventListener('DOMContentLoaded', () => {
  /* ---------- Elements (may be null) ---------- */
  const starsContainer = $('stars-container');
  const mainContainer = $('mainContainer') || $('main-container') || document.body;
  const fullscreenBtn = $('fullscreenBtn') || $('fullscreen-btn');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const toolsMenuBg = $('toolsMenuBg');
  const toolsMenu = $('toolsMenu');
  const toolBtn = $('toolBtn');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatSelector = $('chatSelector');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const voiceInputBtn = $('voiceInputBtn'); // declared once
  const addChatBtn = $('addChatBtn');
  const removeChatBtn = $('removeChatBtn');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  const emojiBtn = $('emojiBtn'); // FIX: ensure emojiBtn is grabbed
  const imageBtnHtml = $('imageBtn'); // may be present in HTML
  const voiceBtnHtml = $('voiceBtn'); // may be present in HTML

  // Defensive: if essential elements missing, still continue but warn
  if (!chatForm) console.warn('chatForm not found in DOM. Chat submission disabled until element added.');
  if (!chatBox) console.warn('chatBox not found in DOM. Chat rendering disabled until element added.');

  /* ---------- Emoji ---------- */
  const emojis = ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜‚","ðŸ¤£","ðŸ˜","ðŸ¥°","ðŸ˜Ž","ðŸ‘","ðŸ™","ðŸ”¥","ðŸ’¯","ðŸŽ‰","ðŸ˜‡","ðŸ«¶","ðŸ˜œ","ðŸ¤–","ðŸ‘€"];
  if (emojiBtn && emojiPanel && chatInput) {
    emojiBtn.addEventListener('click', function (e) {
      // toggle panel content
      emojiPanel.innerHTML = emojis.map(em => `<span class="emoji-pick" role="button" tabindex="0" aria-label="emoji">${em}</span>`).join('');
      emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
      // position it near button
      try {
        const rect = emojiBtn.getBoundingClientRect();
        emojiPanel.style.left = `${Math.max(8, rect.left)}px`;
      } catch (e) { /* ignore positioning errors */ }
      // wire picks
      emojiPanel.querySelectorAll('.emoji-pick').forEach(span => {
        span.addEventListener('click', function () {
          const text = this.textContent || '';
          const start = chatInput.selectionStart || 0;
          const end = chatInput.selectionEnd || 0;
          chatInput.value = chatInput.value.slice(0, start) + text + chatInput.value.slice(end);
          chatInput.focus();
          chatInput.selectionStart = chatInput.selectionEnd = start + text.length;
          emojiPanel.style.display = 'none';
          chatInput.dispatchEvent(new Event('input'));
        });
      });
    });
    // click outside to close
    document.addEventListener('click', e => {
      if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
        emojiPanel.style.display = 'none';
      }
    });
  }

  /* ---------- Stars ---------- */
  if (starsContainer) {
    starsContainer.innerHTML = '';
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  /* ---------- Fullscreen toggle ---------- */
  if (fullscreenBtn && mainContainer) {
    let isFull = false;
    fullscreenBtn.addEventListener('click', () => {
      isFull = !isFull;
      mainContainer.classList.toggle('fullscreen', isFull);
      try { fullscreenBtn.innerHTML = isFull ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>'; } catch (e) {}
    });
  }

  /* ---------- Panels/Modals ---------- */
  window.closeToolMenu = () => {
    if (toolsMenuBg) toolsMenuBg.classList.remove('active');
  };
  window.openToolMenu = () => {
    if (toolsMenuBg) toolsMenuBg.classList.add('active');
  };

  if (profileMenuBg && profileMenu && $('openProfileMenu')) {
    $('openProfileMenu').addEventListener('click', () => {
      profileMenuBg.classList.add('active');
      setTimeout(() => profileMenu.classList.add('active'), 10);
    });
    profileMenuBg.addEventListener('click', e => {
      if (e.target === profileMenuBg) {
        profileMenu.classList.remove('active');
        setTimeout(() => profileMenuBg.classList.remove('active'), 110);
      }
    });
  }
  if (linkMenuBg && linkMenu && $('openLinksMenu')) {
    $('openLinksMenu').addEventListener('click', () => {
      linkMenuBg.classList.add('active');
      setTimeout(() => linkMenu.classList.add('active'), 10);
    });
    linkMenuBg.addEventListener('click', e => {
      if (e.target === linkMenuBg) {
        linkMenu.classList.remove('active');
        setTimeout(() => linkMenuBg.classList.remove('active'), 110);
      }
    });
  }

  // Handle new tool button logic
  if (toolBtn) {
    toolBtn.addEventListener('click', () => {
      openToolMenu();
    });
    if (toolsMenuBg) toolsMenuBg.addEventListener('click', e => {
      if (e.target === toolsMenuBg) {
        closeToolMenu();
      }
    });
  }

  if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = 'signup-login.html');

  /* ---------- Firebase auth (profile only) ---------- */
  let currentUser = null;

  onAuthStateChanged(auth, user => {
    unsubscribeAll(); // Clean up previous listeners
    if (!user) {
      try { signOut(auth); window.location.href = "signup-login.html"; } catch (e) {}
      return;
    }
    currentUser = user;

    // populate profile UI if present
    if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]);
    if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
    if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
    if (editName) editName.value = user.displayName || "";
    if (editPhoto) editPhoto.value = user.photoURL || "";
    if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

    // Firestore Listener for User's Chats
    const q = query(collection(db, `users/${user.uid}/chats`), orderBy("timestamp", "desc"));
    userUnsubscribe = onSnapshot(q, (snapshot) => {
      chats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Select the first chat if none is selected
      if (!currentChatId && chats.length > 0) {
        currentChatId = chats[0].id;
        // Start listening to messages for the first chat
        subscribeToChatMessages(currentChatId);
      } else if (!currentChatId && chats.length === 0) {
        // Create a new default chat if no chats exist
        createNewChat("Chat 1");
      } else {
        // Find the current chat in the new list to handle re-ordering or deletion
        const found = chats.find(c => c.id === currentChatId);
        if (!found) { // If the current chat was deleted, switch to the latest one
          currentChatId = chats.length > 0 ? chats[0].id : null;
          subscribeToChatMessages(currentChatId);
        }
      }
      renderChatsListSidebar();
      renderChatSelector(); // Re-render the dropdown (if you add it back)
    });
  });

  async function createNewChat(name) {
    if (!currentUser) return;
    try {
      const chatRef = await addDoc(collection(db, `users/${currentUser.uid}/chats`), {
        name,
        timestamp: new Date(),
      });
      currentChatId = chatRef.id;
      subscribeToChatMessages(currentChatId);
      renderChatBox([]);
    } catch (e) {
      console.error("Error creating new chat: ", e);
    }
  }

  function subscribeToChatMessages(chatId) {
    if (chatUnsubscribe) chatUnsubscribe(); // Unsubscribe from old chat
    if (!chatId) {
      updateChatHistory([]);
      return;
    }
    const q = query(collection(db, `users/${currentUser.uid}/chats/${chatId}/messages`), orderBy("timestamp"));
    chatUnsubscribe = onSnapshot(q, (snapshot) => {
      const newMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      updateChatHistory(newMessages);
    });
  }

  /* ---------- Profile form submit (update Firebase profile) ---------- */
  if (profileForm) {
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const status = $('profileStatusMsg');
      if (status) status.textContent = '';
      const name = editName ? editName.value.trim() : '';
      const photoURL = editPhoto ? editPhoto.value.trim() : '';
      try {
        await updateProfile(currentUser, { displayName: name, photoURL });
        if (auth.currentUser && typeof auth.currentUser.reload === 'function') await auth.currentUser.reload();
        if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; }
        setTimeout(() => { profileMenu?.classList.remove('active'); profileMenuBg?.classList.remove('active'); }, 650);
        if (headerWelcome) headerWelcome.textContent = "Welcome, " + (auth.currentUser?.displayName || (auth.currentUser?.email || '').split('@')[0]);
      } catch (err) {
        if (status) { status.textContent = err.message || "Update failed"; status.style.color = "#ffd700"; }
      }
    });
  }

  /* ---------- Sidebar / Chats list ---------- */
  function renderChatsListSidebar() {
    if (!chatsListEl) return;
    chatsListEl.innerHTML = '';
    chats.forEach((chat, idx) => {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.marginBottom = '6px';

      const titleSpan = document.createElement('span');
      titleSpan.textContent = chat.name || `Chat ${idx + 1}`;
      titleSpan.style.flex = '1';
      titleSpan.style.cursor = 'pointer';
      titleSpan.onclick = () => {
        currentChatId = chat.id;
        subscribeToChatMessages(currentChatId);
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      const renameBtn = document.createElement('button');
      renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
      renameBtn.title = 'Rename';
      renameBtn.style.margin = '0 6px 0 8px';
      renameBtn.onclick = (e) => {
        e.stopPropagation();
        const newName = prompt("Rename chat:", chat.name || `Chat ${idx + 1}`);
        if (newName) {
          const chatRef = doc(db, `users/${currentUser.uid}/chats/${chat.id}`);
          updateDoc(chatRef, { name: newName.trim() });
        }
      };

      const delBtn = document.createElement('button');
      delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.title = 'Delete';
      delBtn.style.marginLeft = '6px';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (!confirm("Delete this chat?")) return;
        const chatRef = doc(db, `users/${currentUser.uid}/chats/${chat.id}`);
        deleteDoc(chatRef);
      };

      const openBtn = document.createElement('button');
      openBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
      openBtn.title = 'Open Chat';
      openBtn.onclick = (e) => {
        e.stopPropagation();
        currentChatId = chat.id;
        subscribeToChatMessages(currentChatId);
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      container.appendChild(titleSpan);
      container.appendChild(renameBtn);
      container.appendChild(delBtn);
      container.appendChild(openBtn);
      chatsListEl.appendChild(container);
    });
  }

  if (newChatBtn) {
    newChatBtn.addEventListener('click', () => {
      createNewChat("Chat " + (chats.length + 1));
    });
  }

  /* ---------- Chat selector (dropdown) ---------- */
  function renderChatSelector() {
    if (!chatSelector) return;
    chatSelector.innerHTML = '';
    chats.forEach((chat, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = chat.name || (chat.history?.[0]?.text?.slice(0, 24) || "Untitled");
      chatSelector.appendChild(option);
    });
    if (!chats.length) {
      chats = [{ name: 'Chat 1', history: [] }];
      currentChatId = 0;
    }
  }

  if (chatSelector) {
    chatSelector.addEventListener('change', function () {
      currentChatId = parseInt(this.value) || 0;
      subscribeToChatMessages(currentChatId);
    });
  }

  if (addChatBtn) {
    addChatBtn.addEventListener('click', () => {
      createNewChat("Chat " + (chats.length + 1));
    });
  }

  if (removeChatBtn) {
    removeChatBtn.addEventListener('click', () => {
      if (!chats.length) return;
      if (!confirm("Delete this chat?")) return;
      const chatRef = doc(db, `users/${currentUser.uid}/chats/${currentChatId}`);
      deleteDoc(chatRef);
    });
  }

  /* ---------- Markdown/render helpers ---------- */
  const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

  function inlineMarkdown(t = '') {
    let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`);
    s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
    s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return s.replace(/\n/g, '<br>');
  }

  function renderMarkdown(text = '') {
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    text = text || '';
    text.replace(codeBlockRegex, (match, lang, code, offset) => {
      const before = text.slice(lastIndex, offset);
      html += inlineMarkdown(before);
      const language = (lang || '').toLowerCase().trim();
      const safe = escapeHTML(code);
      const blockId = 'code_' + Math.random().toString(36).slice(2);
      html += `<pre data-block-id="${blockId}">\n  <button class="copy-btn" data-copy="${blockId}">Copy</button>\n  <code class="language-${language || 'plaintext'}">${safe}</code>\n</pre>`;
      lastIndex = offset + match.length;
      return match;
    });
    html += inlineMarkdown(text.slice(lastIndex));
    return { html };
  }

  function enhanceCodeBlocks(container) {
    if (!container) return;
    container.querySelectorAll('pre').forEach(pre => {
      const codeEl = pre.querySelector('code');
      if (window.hljs && codeEl) {
        try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ }
      }
      const btn = pre.querySelector('.copy-btn');
      if (btn && codeEl) {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(codeEl.innerText);
            const prev = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = prev, 800);
          } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); }
        });
      }
    });
  }

  /* ---------- Chat rendering & controls ---------- */
function renderChatBox(messages = []) {
  if (!chatBox) return;
  chatBox.innerHTML = '';
  (messages || []).forEach((msg, idx) => {
    const div = document.createElement('div');
    div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'ai');
    
    // Handle image/video/audio messages
    if (msg.role === 'user' && msg.text.startsWith('[File Upload]')) {
      const fileName = msg.text.match(/File: (.+?)\)/)?.[1] || '';
      const fileType = msg.text.match(/Type: (.+?)\)/)?.[1] || '';
      const fileUrl = msg.text.match(/URL: (.+?)]/)?.[1] || '';
      let mediaHtml = '';
      if (fileType.startsWith('image')) mediaHtml = `<img src="${fileUrl}" style="max-width:100%;border-radius:12px;margin:8px 0;box-shadow:0 0 10px #00eaff33;">`;
      else if (fileType.startsWith('video')) mediaHtml = `<video controls src="${fileUrl}" style="max-width:100%;border-radius:12px;margin:8px 0;box-shadow:0 0 10px #00eaff33;"></video>`;
      else if (fileType.startsWith('audio')) mediaHtml = `<audio controls src="${fileUrl}" style="width:100%;margin:8px 0;"></audio>`;
      else if (fileType === 'application/pdf') mediaHtml = `<a href="${fileUrl}" target="_blank" style="color:#00fff6;text-decoration:underline;">ðŸ“„ View PDF: ${fileName}</a>`;

      div.innerHTML = `<div class="msg" style="word-wrap: break-word;">File Upload: **${fileName}**<br>${mediaHtml}</div>`;
      
    } else if (msg.text && (msg.text.includes('research.pdf') || msg.text.includes('website.html'))) {
      // Handle special tool outputs like Research and Website
      const url = msg.text.match(/]\((.*?)\)/)?.[1] || '#';
      const type = msg.text.includes('research.pdf') ? 'Research Report' : 'Website';
      div.innerHTML = `<div class="msg">
        âœ… Your **${type}** is ready!<br>
        <a href="${url}" target="_blank" rel="noopener noreferrer" style="display:inline-block;margin-top:10px;padding:8px 14px;background:#00c0ff;border-radius:8px;color:#fff;text-decoration:none;">
          <i class="fa-solid fa-download"></i> Download ${type}
        </a>
      </div>`;

    } else if (msg.role === 'ai') {
      const { html } = renderMarkdown(msg.text || '');
      div.innerHTML = `<div class="msg">${html}
        <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
          <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
          <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button>
          <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
        </div>
      </div>`;
    } else { // User message with new controls
      div.innerHTML = `<div class="msg">${escapeHTML(msg.text || '')}
        <div class="user-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
          <button class="inline-edit-btn" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
        </div>
      </div>`;
    }
    chatBox.appendChild(div);
  });
  enhanceCodeBlocks(chatBox);
  hookAiMsgControls();
  hookUserMsgControls();
  setTimeout(() => {
    const last = chatBox.lastElementChild;
    if (last) last.scrollIntoView({behavior: "smooth", block: "end"});
    chatBox.scrollTop = chatBox.scrollHeight + 200;
  }, 20);
}

function hookAiMsgControls() {
  if (!chatBox) return;
  chatBox.querySelectorAll('.chat-message.ai').forEach(div => {
    const aiIdx = Number(div.getAttribute('data-aiidx'));
    const controls = div.querySelector('.ai-msg-controls');
    if (!controls) return;
    const copyBtn = controls.querySelector('.inline-copy-btn');
    const shareBtn = controls.querySelector('.inline-share-btn');
    const regenBtn = controls.querySelector('.regen-btn');

    if (copyBtn) copyBtn.onclick = () => {
      try {
        const aiOnly = (currentChatHistory || []).filter(m => m.role === "ai") || [];
        const text = aiOnly[aiIdx]?.text || "";
        navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
        copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
        setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950);
      } catch (e) { console.warn('copy failed', e); }
    };

    if (shareBtn) shareBtn.onclick = () => {
      try {
        const aiOnly = (currentChatHistory || []).filter(m => m.role === "ai") || [];
        const text = aiOnly[aiIdx]?.text || "";
        const url = window.location.origin;
        const shareText = `${text.replace(/<\/?[^>]+(>|$)/g, "")}\n\nShared via Philadelphia AI: ${url}`;
        if (navigator.share) navigator.share({ title: "Philadelphia AI", text: shareText, url }).catch(()=>{});
        else prompt("Copy and share manually:", shareText);
      } catch (e) { console.warn('share failed', e); }
    };

    if (regenBtn) regenBtn.onclick = async () => {
      try {
        let aiMsgCount = 0, aiMsgIndexInHistory = -1;
        const history = currentChatHistory || [];
        for (let i = 0; i < history.length; i++) {
          if (history[i].role === "ai") {
            if (aiMsgCount === aiIdx) { aiMsgIndexInHistory = i; break; }
            aiMsgCount++;
          }
        }
        const userMsgObj = history[aiMsgIndexInHistory - 1];
        const userMsg = (userMsgObj?.role === "user" ? userMsgObj.text : "");
        if (!userMsg) {
          regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i> Err";
          setTimeout(() => regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i>", 900);
          return;
        }
        if (aiMsgIndexInHistory >= 0) {
          const messageRef = doc(db, `users/${currentUser.uid}/chats/${currentChatId}/messages/${history[aiMsgIndexInHistory].id}`);
          deleteDoc(messageRef);
        }
        showTypingAtNext();
        try {
          let res = await fetch('https://web-production-9a18.up.railway.app/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMsg, user_id: currentUser?.uid || "user", history: [] })
          });
          let data;
          try { data = await res.json(); } catch (e) { data = {}; }
          removeTyping();
          if (data && data.response) {
            await saveMessage('ai', data.response);
          } else {
            await saveMessage('ai', 'âŒ No response from server.');
          }
        } catch (err) {
          removeTyping();
          await saveMessage('ai', "âŒ Retry Error: " + (err.message || ''));
        }
      } catch (err) {
        console.warn('regen error', err);
      }
    };
  });
}

function hookUserMsgControls() {
  if (!chatBox) return;
  chatBox.querySelectorAll('.chat-message.user').forEach(div => {
    const userIdx = Number(div.getAttribute('data-useridx'));
    const controls = div.querySelector('.user-msg-controls');
    if (!controls) return;
    const copyBtn = controls.querySelector('.inline-copy-btn');
    const editBtn = controls.querySelector('.inline-edit-btn');

    if (copyBtn) copyBtn.onclick = () => {
      try {
        const text = currentChatHistory?.[userIdx]?.text || "";
        navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
        copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
        setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950);
      } catch (e) { console.warn('copy failed', e); }
    };
    if (editBtn) editBtn.onclick = () => {
      try {
        const text = currentChatHistory?.[userIdx]?.text || "";
        if (!text) return;
        chatInput.value = text;
        chatInput.focus();
        // Remove the original user message and its corresponding AI response (if any)
        const chatRef = doc(db, `users/${currentUser.uid}/chats/${currentChatId}`);
        const userMsgRef = doc(collection(chatRef, 'messages'), currentChatHistory[userIdx].id);
        deleteDoc(userMsgRef);
        if (currentChatHistory[userIdx + 1]?.role === 'ai') {
          const aiMsgRef = doc(collection(chatRef, 'messages'), currentChatHistory[userIdx + 1].id);
          deleteDoc(aiMsgRef);
        }
      } catch (e) { console.warn('edit failed', e); }
    };
  });
}

  /* ---------- Typing / typewriter ---------- */
let typingNode = null;
function showTypingAtNext() {
  removeTyping();
  if (!chatBox) return;
  typingNode = document.createElement('div');
  typingNode.className = 'chat-message ai';
  typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`;
  chatBox.appendChild(typingNode);
  setTimeout(() => {
    typingNode.scrollIntoView({ behavior: "smooth", block: "end" });
  }, 20);
}

function removeTyping() {
  if (typingNode && typingNode.parentNode) {
    typingNode.parentNode.removeChild(typingNode);
    typingNode = null;
  }
}

  /* ---------- File preview helpers ---------- */
function renderFilePreview() {
  if (!filePreview) return;
  if (!uploadedFiles.length) {
    filePreview.style.display = 'none';
    filePreview.innerHTML = '';
    return;
  }
  filePreview.style.display = 'block';
  filePreview.innerHTML = uploadedFiles.map((file, idx) => {
    let preview = '';
    if (file.type.startsWith('image/')) {
      preview = `<img src="${URL.createObjectURL(file)}" style="max-width:58px;max-height:41px;vertical-align:middle;border-radius:8px;margin-right:6px;">`;
    } else if (file.type.startsWith('video/')) {
      preview = `<video src="${URL.createObjectURL(file)}" controls style="max-width:58px;height:41px;vertical-align:middle;border-radius:8px;margin-right:7px;"></video>`;
    } else if (file.type.startsWith('audio/')) {
      preview = `<audio controls src="${URL.createObjectURL(file)}" style="vertical-align:middle;width:52px;margin-right:7px;"></audio>`;
    } else if (file.type === 'application/pdf') {
      preview = `<span style="font-size:1.25em;margin-right:7px;">ðŸ“„</span>`;
    }
    return `
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:1px;">
      ${preview}
      <span style="color:#aee;font-size:.99em;">${escapeHTML(file.name)}</span>
      <button type="button" data-idx="${idx}" class="remove-file-btn" aria-label="Remove file">&times;</button>
    </div>`;
  }).join('');
  filePreview.querySelectorAll('.remove-file-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-idx'));
      uploadedFiles.splice(idx, 1);
      uploadData = uploadedFiles[0] || null;
      if (!uploadedFiles.length && chatFile) chatFile.value = '';
      renderFilePreview();
    });
  });
}
if (chatFile) {
  chatFile.addEventListener('change', function () {
    const files = Array.from(this.files || []);
    uploadedFiles = files;
    uploadData = files[0] || null;
    renderFilePreview();
  });
}

  /* ---------- Voice input via Web Speech ---------- */
  if (voiceInputBtn && chatInput) {
    let recognition = null;
    voiceInputBtn.addEventListener('click', function () {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const R = window.webkitSpeechRecognition || window.SpeechRecognition;
        recognition = new R();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
        recognition.onresult = (e) => {
          chatInput.value += (chatInput.value ? ' ' : '') + e.results[0][0].transcript;
          chatInput.dispatchEvent(new Event('input'));
          voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        };
        recognition.onend = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
        recognition.onerror = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
        recognition.start();
      } else alert('Speech recognition not supported in your browser.');
    });
  }

  /* ---------- Textarea auto-resize ---------- */
  if (chatInput) {
    function autoResizeTextarea() {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px';
    }
    chatInput.addEventListener('input', autoResizeTextarea);
    autoResizeTextarea();
    chatInput.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBtn?.click(); }
    });
  }

  /* ---------- NEW: TOOL-BASED CHAT HANDLING ---------- */
  
  document.querySelectorAll('.tool-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const tool = link.getAttribute('data-tool');
      closeToolMenu();
      handleToolPrompt(tool);
    });
  });

  async function handleToolPrompt(tool) {
    let responseText = '';
    
    // Clear any pending actions
    pendingToolAction = { tool };
    
    // Add an initial message from the AI to guide the user
    switch(tool) {
      case 'image':
        const modelNames = thenaModels.map(m => `**${m}**`).join(', ');
        responseText = `What's your image prompt? You can also specify a model by typing a style name before your prompt (e.g., \`anime a cybernetic cat\`). Available models are: ${modelNames}`;
        break;
      case 'comic':
        const comicStyles = ["manga", "anime", "american"].map(m => `**${m}**`).join(', ');
        responseText = `Ready to create a comic! What style would you like? Choose from: ${comicStyles}`;
        break;
      case 'website':
        responseText = `What kind of website do you want? Describe the content, style, and purpose.`;
        break;
      case 'research':
        responseText = `What topic would you like me to research? I'll provide a detailed report in a downloadable PDF.`;
        break;
      case 'remove-bg':
        responseText = `Ready to remove a background. Please upload an image using the paperclip icon and press send.`;
        pendingToolAction = { tool, state: 'awaiting_file' };
        break;
      case 'voice-gen':
        const voiceStyles = ["podcast", "cinematic", "upbeat", "soft", "dramatic"].map(m => `**${m}**`).join(', ');
        responseText = `I can generate a voice from your text. What style would you like? Choose from: ${voiceStyles}`;
        break;
      case 'audio-narration':
        const narrationStyles = ["podcast", "cinematic", "upbeat", "soft", "dramatic"].map(m => `**${m}**`).join(', ');
        responseText = `I can narrate a document for you. First, please upload a file using the paperclip icon. You can also specify a style. For example: \`upbeat\`. Available styles are: ${narrationStyles}`;
        pendingToolAction = { tool, state: 'awaiting_file' };
        break;
      default:
        responseText = 'âŒ Tool not implemented yet.';
        pendingToolAction = null;
    }

    if (responseText) {
      await saveMessage('ai', responseText);
      renderChatBox(currentChatHistory);
    }
  }

  /* ---------- Chat submit handler (main) ---------- */
   if (chatForm) {
  chatForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!currentChatId) {
      await createNewChat("New Chat");
    }

    const msgText = chatInput ? chatInput.value.trim() : '';
    
    // --- NEW: Handle pending tool actions conversationally ---
    if (pendingToolAction) {
        if (!msgText && !uploadedFiles.length) return; // Wait for user input
        
        const tool = pendingToolAction.tool;
        const state = pendingToolAction.state;
        let userInput = msgText;
        let file = uploadedFiles[0];
        
        // Reset the pending action
        pendingToolAction = null;

        // Save the user's message to chat history
        if (msgText) await saveMessage('user', msgText);
        if (uploadedFiles.length) {
          const fileUrl = URL.createObjectURL(file);
          await saveMessage('user', `[File Upload] (File: ${file.name}, Type: ${file.type}, URL: ${fileUrl})`);
        }
        renderChatBox(currentChatHistory);
        chatInput.value = '';
        chatInput.dispatchEvent(new Event('input'));
        
        showTypingAtNext();

        let botResponse = 'An unknown tool error occurred.';
        
        try {
          // Logic for tools that require a file upload first
          if (state === 'awaiting_file') {
            if (!file) throw new Error('No file uploaded.');
            
            if (tool === 'remove-bg') {
              const fd = new FormData(); fd.append('file', file);
              const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/remove-background', { method: 'POST', body: fd });
              if (!res.ok) throw new Error(res.statusText);
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              botResponse = `âœ… Background removed! ![Image with background removed](${url})`;
            }
            if (tool === 'audio-narration') {
                const narrationStyles = ["podcast", "cinematic", "upbeat", "soft", "dramatic"];
                const selectedStyle = userInput.toLowerCase();
                const style = narrationStyles.includes(selectedStyle) ? selectedStyle : 'podcast';

                const fd = new FormData(); fd.append('file', file); fd.append('style', style);
                const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/audio-narration', { method: 'POST', body: fd });
                if (!res.ok) throw new Error(res.statusText);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                botResponse = `ðŸ—£ï¸ Narration generated in **${style}** style! ![Audio Narration](${url})`;
            }

          } else { // Logic for tools that require a text prompt
            if (!msgText) throw new Error('No text prompt provided.');

            if (tool === 'image') {
              const [style, ...promptParts] = userInput.split(/\s+/)
              const prompt = promptParts.join(' ');
              const model = thenaModels.includes(style.toLowerCase()) ? style.toLowerCase() : 'photoreal';
              
              const res = await fetch('https://web-production-9a18.up.railway.app/generate-image', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt || userInput, model })
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || res.statusText);
              showAIImagePreview(`data:image/png;base64,${data.image_b64}`, `Generated with model: **${model}**`);
              botResponse = 'âœ… Image generated! Check the floating image box to view or download.';
            }
            if (tool === 'comic') {
              const [style, ...storyParts] = userInput.split(/\s+/)
              const story = storyParts.join(' ');
              const comicStyles = ["manga", "anime", "american"];
              const selectedStyle = comicStyles.includes(style.toLowerCase()) ? style.toLowerCase() : 'manga';

              const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/generate-comic', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ story: story || userInput, style: selectedStyle, panels: 3, user: currentUser?.displayName || "User" })
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || res.statusText);
              const imagesHtml = data.images.map(img => `<img src="data:image/png;base64,${img}" alt="Comic Panel" style="max-width:100%;border-radius:12px;margin-bottom:15px;box-shadow:0 0 8px #00fff2c7;">`).join('');
              botResponse = `ðŸ–¼ï¸ Comic created in **${selectedStyle}** style! ${imagesHtml}`;
            }
            if (tool === 'website') {
              const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/create-website', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: userInput, user_id: currentUser?.uid || "user" })
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || res.statusText);
              botResponse = `ðŸŒ Website deployed successfully! [View here](${data.url})`;
            }
            if (tool === 'research') {
              // This is the new research tool!
              const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/research', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic: userInput })
              });
              if (!res.ok) throw new Error(res.statusText);
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              botResponse = `âœ… Your research report is ready! [Download research.pdf](${url})`;
            }
            if (tool === 'voice-gen') {
                const voiceStyles = ["podcast", "cinematic", "upbeat", "soft", "dramatic"];
                const [style, ...textParts] = userInput.split(/\s+/);
                const text = textParts.join(' ');
                const selectedStyle = voiceStyles.includes(style.toLowerCase()) ? style.toLowerCase() : 'podcast';
                
                const fd = new FormData(); fd.append('text', text || userInput); fd.append('style', selectedStyle);
                const res = await fetch('https://web-production-9a18.up.railway.app/voicegen', { method: 'POST', body: fd });
                if (!res.ok) throw new Error(res.statusText);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                botResponse = `ðŸ—£ï¸ Voice generated in **${selectedStyle}** style! ![Audio Narration](${url})`;
            }
          }
        } catch (err) {
          botResponse = `âŒ Tool failed: ${err.message}`;
        }

        removeTyping();
        await saveMessage('ai', botResponse);
        return;
    }

    // Regular text chat
    if (msgText) {
      if (!currentChatId || chats.length === 0) {
        await createNewChat(msgText.slice(0, 25) + "...");
      } else {
         const currentChatRef = doc(db, `users/${currentUser.uid}/chats/${currentChatId}`);
         await updateDoc(currentChatRef, { name: msgText.slice(0, 25) + "..." });
      }

      await saveMessage('user', msgText);
      chatInput.value = '';
      chatInput.dispatchEvent(new Event('input'));
      
      showTypingAtNext();
      try {
        const history = (currentChatHistory || []).map(m => ({ role: m.role, content: m.text }));
        const res = await fetch('https://web-production-9a18.up.railway.app/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msgText, user_id: currentUser?.uid || 'user', history }) });
        const data = await res.json();
        const botResponse = data?.response || 'ðŸ¤– Error. Try sending the text again.';
        removeTyping();
        await saveMessage('ai', botResponse);
      } catch (err) {
        removeTyping();
        await saveMessage('ai', 'âŒ An error occurred: ' + (err.message || 'Please check your connection.'));
      }
    }
  });
}

  /* ---------- AI Image preview UI ---------- */
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');

  if (aiPrevClose && aiPrevBox && aiPrevImgBox) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; aiPrevImgBox.innerHTML = ''; });
  if (aiPrevDLBtn && aiPrevImgBox) aiPrevDLBtn.addEventListener('click', () => {
    const img = aiPrevImgBox.querySelector('img'); if (img) { const url = img.src; const a = document.createElement('a'); a.href = url; a.download = 'generated_image.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
  });

  function showAIImagePreview(srcUrlOrBase64, caption = '') {
    if (!aiPrevBox || !aiPrevImgBox) return;
    
    // Check if the input is a URL (blob) or a Base64 string
    let src;
    if (typeof srcUrlOrBase64 === 'string' && (srcUrlOrBase64.startsWith('data:image/') || srcUrlOrBase64.startsWith('blob:'))) {
        src = srcUrlOrBase64;
    } else {
        src = 'data:image/png;base64,' + srcUrlOrBase64;
    }

    aiPrevImgBox.innerHTML = `<img src="${src}" alt="AI generated image" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;">` + (caption ? ' <div style="color:#aee;font-size:.95em;margin-top:3px;text-align:center;">' + caption + '</div>' : '');
    aiPrevBox.style.display = 'block';
}


  // initial UI small setup
  // NOTE: removed auto-inserting of /image into input
  if (chatInput) { chatInput.focus(); }

  // final initial render
  try { renderChatsListSidebar(); } catch (e) {}
  try { renderChatSelector(); } catch (e) {}
  try { renderChatBox(currentChatHistory || []); } catch (e) {}

}); // end DOMContentLoaded
</script>
</body>
</html>
