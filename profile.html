<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philadelphia AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <link rel="icon" href="https://i.ibb.co/tPg5B3b/philly-ai.png" type="image/x-icon">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f1c2d, #000);
            color: #fff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        #stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 4s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1); }
        }

        #main-container {
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            max-height: 800px;
            background: rgba(15, 28, 45, 0.7);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        #main-container.fullscreen {
            width: 100vw;
            max-width: 100vw;
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 10;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            box-shadow: 0 0 15px #00ffff;
            animation: pulse 2.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 15px #00ffff; }
            50% { box-shadow: 0 0 25px #00ffff, 0 0 35px #00eaff; }
            100% { box-shadow: 0 0 15px #00ffff; }
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
            background: linear-gradient(45deg, #00ffff, #00eaff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-right button {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .header-right button:hover {
            color: #00ffff;
        }

        #chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        #chat-box::-webkit-scrollbar {
            width: 8px;
        }
        #chat-box::-webkit-scrollbar-track {
            background: transparent;
        }
        #chat-box::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        #chat-box::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .chat-message {
            max-width: 85%;
            display: flex;
            flex-direction: column;
        }
        
        .chat-message.user {
            align-self: flex-end;
            margin-right: 0;
        }

        .chat-message.ai {
            align-self: flex-start;
            margin-left: 0;
        }

        .chat-message .msg {
            padding: 15px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-out;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chat-message.user .msg {
            background: linear-gradient(135deg, #00ffff, #00aaff);
            color: #1a1a1a;
            border-bottom-right-radius: 5px;
        }

        .chat-message.ai .msg {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-bottom-left-radius: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        code {
            font-family: 'Courier New', Courier, monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 6px;
            color: #00ffff;
        }
        
        .chat-message.user code {
            color: #000;
            background: rgba(0, 0, 0, 0.1);
        }

        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
            overflow-x: auto;
            position: relative;
            margin-top: 10px;
        }
        
        pre .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3e4451;
            color: #abb2bf;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s ease;
        }
        
        pre .copy-btn:hover {
            background: #4b5260;
        }

        .chat-form-container {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 28, 45, 0.7);
        }
        
        #filePreview {
            padding: 5px 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
            display: none;
            color: #aee;
        }

        #filePreview .remove-file-btn {
            background: none;
            border: none;
            color: #ff5555;
            font-size: 1.2rem;
            cursor: pointer;
            line-height: 1;
        }

        #chatForm {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        #chatInput {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 12px 20px;
            color: #fff;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 168px;
            transition: border-color 0.3s;
        }

        #chatInput:focus {
            outline: none;
            border-color: #00ffff;
        }
        
        #sendBtn, .icon-btn {
            background: linear-gradient(45deg, #00ffff, #00eaff);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: #1a1a1a;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .icon-btn.active {
            box-shadow: 0 0 15px #00ffff;
        }

        #sendBtn:hover, .icon-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        .footer-logo {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }

        .chat-message .file-attachments {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .chat-message .chat-media-preview {
            max-width: 100px;
            height: auto;
            border-radius: 8px;
        }
        
        .chat-message .file-link {
            color: #00ffff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-message .file-link:hover {
            text-decoration: underline;
        }
        
        .chat-message .file-link i {
            color: #fff;
        }
        
        /* Modal / Profile / Links */
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .modal-bg.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: #1a2a40;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
            position: relative;
        }
        
        .modal-content.active {
            transform: scale(1);
            opacity: 1;
        }

        .modal-content h2 {
            text-align: center;
            color: #00ffff;
            margin-bottom: 20px;
        }
        
        .modal-content .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-content input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
        }
        
        .modal-content button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #00ffff, #00eaff);
            color: #1a1a1a;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .modal-content button[type="submit"]:hover {
            transform: translateY(-2px);
        }

        #profilePicPreview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: block;
            margin: 0 auto 15px;
            object-fit: cover;
            border: 3px solid #00ffff;
        }
        
        .link-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .link-list li {
            margin-bottom: 10px;
        }
        
        .link-list a {
            display: block;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            color: #fff;
            text-decoration: none;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .link-list a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .link-list a i {
            font-size: 1.5rem;
            color: #00ffff;
        }

        .chat-box-footer {
            padding: 10px 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        .chat-box-footer a {
            color: #00ffff;
            text-decoration: none;
        }
        
        .chat-box-footer a:hover {
            text-decoration: underline;
        }

        #chatSelector {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        #chatSelector option {
            background: #1a2a40;
            color: #fff;
        }

        .chat-controls-bottom {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-controls-bottom button {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .chat-controls-bottom button:hover {
            color: #00ffff;
        }
        
        .chat-controls-bottom input[type="file"] {
            display: none;
        }
        
        #ai-image-preview {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(15, 28, 45, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 9;
        }

        #ai-image-preview button {
            background: #00ffff;
            color: #1a1a1a;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        #ai-image-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .typing-bubble {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }

        .dot-anim {
            width: 8px;
            height: 8px;
            background-color: #00ffff;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .dot-anim:nth-child(1) { animation-delay: -0.32s; }
        .dot-anim:nth-child(2) { animation-delay: -0.16s; }
        .dot-anim:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* NEW: Tool menu styling */
        .tools-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tools-modal.active {
            display: block;
            opacity: 1;
        }

        .tools-panel {
            position: absolute;
            top: 0;
            left: -350px;
            width: 320px;
            height: 100%;
            background: #1a2a40;
            box-shadow: 5px 0 25px rgba(0, 255, 255, 0.3);
            transition: left 0.3s ease;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .tools-modal.active .tools-panel {
            left: 0;
        }

        .tools-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #00ffff;
            padding-bottom: 10px;
        }

        .tools-header h2 {
            margin: 0;
            font-size: 1.6rem;
            color: #00ffff;
            font-weight: 600;
        }

        .tools-close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .tools-close-btn:hover {
            color: #ff00ff;
        }
        
        .tool-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
            overflow-y: auto;
        }

        .tool-list::-webkit-scrollbar { width: 8px; }
        .tool-list::-webkit-scrollbar-track { background: transparent; }
        .tool-list::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .tool-list::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.2); }

        .tool-item a {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            color: #fff;
            text-decoration: none;
            transition: background 0.2s ease, transform 0.2s ease;
            border: 1px solid transparent;
        }

        .tool-item a:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            border-color: #00ffff;
        }

        .tool-item i {
            font-size: 2rem;
            color: #00ffff;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .tool-details {
            display: flex;
            flex-direction: column;
        }

        .tool-details h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .tool-details p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .file-upload-btn.glow {
            animation: glow-pulse 1.2s infinite alternate;
        }
        
        @keyframes glow-pulse {
            from { box-shadow: 0 0 5px #00ffff; }
            to { box-shadow: 0 0 15px #00ffff; }
        }
        
        .inline-copy-btn, .inline-share-btn, .regen-btn, .inline-edit-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 0.9em;
            cursor: pointer;
            transition: color 0.2s ease;
            padding: 2px;
        }
        
        .inline-copy-btn:hover, .inline-share-btn:hover, .regen-btn:hover, .inline-edit-btn:hover {
            color: #00ffff;
        }
    </style>
</head>
<body>
    <div id="stars-container"></div>
    <div id="main-container">
        <header class="header">
            <div class="header-left">
                <img src="https://i.ibb.co/tPg5B3b/philly-ai.png" alt="Philadelphia AI Logo" class="logo-img">
                <h1>Philadelphia AI</h1>
            </div>
            <div class="header-right">
                <button id="toolBtn" title="AI Tools"><i class="fa-solid fa-wrench"></i></button>
                <button id="fullscreenBtn" title="Toggle Fullscreen"><i class="fa-solid fa-expand"></i></button>
                <button id="openLinksMenu" title="Links"><i class="fa-solid fa-link"></i></button>
                <button id="openProfileMenu" title="Profile"><i class="fa-solid fa-user"></i></button>
            </div>
        </header>

        <main id="chat-box">
            <div class="chat-message ai">
                <div class="msg">
                    <p>Hello! I am a general-purpose AI, but I can do some very specific things with my tools. Click the **wrench** icon to get started.</p>
                </div>
            </div>
        </main>

        <div class="chat-form-container">
            <div id="filePreview"></div>
            <form id="chatForm">
                <label for="chatFile" class="icon-btn file-upload-btn" title="Upload File">
                    <i class="fa-solid fa-paperclip"></i>
                </label>
                <input type="file" id="chatFile" multiple>
                <button type="button" class="icon-btn" id="voiceInputBtn" title="Voice Input"><i class="fa-solid fa-microphone"></i></button>
                <button type="button" class="icon-btn" id="emojiBtn" title="Emojis"><i class="fa-solid fa-face-smile"></i></button>
                <textarea id="chatInput" placeholder="Type your message..." rows="1"></textarea>
                <button type="submit" id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
            <div id="emojiPanel" style="display: none; position: absolute; bottom: 80px; left: 10px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px; backdrop-filter: blur(10px); z-index: 100;"></div>
        </div>

    </div>

    <div id="ai-image-preview">
        <button id="ai-image-close" aria-label="Close">&times;</button>
        <h4>Generated Image</h4>
        <div id="ai-image-container"></div>
        <button id="ai-image-dl">Download</button>
    </div>

    <div id="profileMenuBg" class="modal-bg">
        <div id="profileMenu" class="modal-content">
            <button class="close-btn" onclick="this.parentNode.parentNode.classList.remove('active')">&times;</button>
            <h2>My Profile</h2>
            <form id="profileForm">
                <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile Picture">
                <div id="headerWelcome" style="text-align:center;margin-bottom:10px;font-size:1.1em;color:#fff;">Welcome</div>
                <div id="profileMenuUser" style="text-align:center;font-weight:bold;font-size:1.2em;color:#00ffff;"></div>
                <div id="profileMenuEmail" style="text-align:center;font-size:0.9em;color:#aaa;margin-bottom:20px;"></div>
                <label for="edit-name">Display Name</label>
                <input type="text" id="edit-name" placeholder="Enter new name">
                <label for="edit-photo">Photo URL</label>
                <input type="text" id="edit-photo" placeholder="Enter photo URL">
                <button type="submit">Update Profile</button>
                <p id="profileStatusMsg" style="text-align:center;margin-top:10px;font-size:0.9em;"></p>
                <button id="logoutBtn" type="button" style="background:#555;margin-top:10px;">Logout</button>
            </form>
        </div>
    </div>

    <div id="linkMenuBg" class="modal-bg">
        <div id="linkMenu" class="modal-content">
            <button class="close-btn" onclick="this.parentNode.parentNode.classList.remove('active')">&times;</button>
            <h2>Important Links</h2>
            <ul class="link-list">
                <li><a href="https://github.com/your-repo" target="_blank"><i class="fa-brands fa-github"></i><span>GitHub Repository</span></a></li>
                <li><a href="mailto:support@philly.ai" target="_blank"><i class="fa-solid fa-envelope"></i><span>Contact Support</span></a></li>
                <li><a href="https://your-website.com/docs" target="_blank"><i class="fa-solid fa-file-alt"></i><span>Documentation</span></a></li>
                <li><a href="https://www.linkedin.com/in/elvion-ekong-6804a8220" target="_blank"><i class="fa-brands fa-linkedin"></i><span>Elvion Ekong</span></a></li>
            </ul>
        </div>
    </div>
    
    <div id="toolsMenuBg" class="tools-modal">
        <div id="toolsMenu" class="tools-panel">
            <div class="tools-header">
                <h2>Philadelphia AI Tools</h2>
                <button onclick="closeToolMenu()" class="tools-close-btn">&times;</button>
            </div>
            <ul class="tool-list">
                <li class="tool-item"><a href="#" data-tool="image" class="tool-link"><i class="fa-solid fa-image"></i><div class="tool-details"><h4>Generate Image</h4><p>Create an image from a text prompt.</p></div></a></li>
                <li class="tool-item"><a href="#" data-tool="comic" class="tool-link"><i class="fa-solid fa-book-open"></i><div class="tool-details"><h4>Create Comic</h4><p>Turn a story into a multi-panel comic.</p></div></a></li>
                <li class="tool-item"><a href="#" data-tool="website" class="tool-link"><i class="fa-solid fa-globe"></i><div class="tool-details"><h4>Create Website</h4><p>Generate HTML/CSS/JS for a website.</p></div></a></li>
                <li class="tool-item"><a href="#" data-tool="remove-bg" class="tool-link"><i class="fa-solid fa-cut"></i><div class="tool-details"><h4>Remove Background</h4><p>Upload an image and get it back with a transparent background.</p></div></a></li>
                <li class="tool-item"><a href="#" data-tool="voice-gen" class="tool-link"><i class="fa-solid fa-microphone-lines"></i><div class="tool-details"><h4>Generate Voice</h4><p>Create audio narration from text.</p></div></a></li>
                <li class="tool-item"><a href="#" data-tool="audio-narration" class="tool-link"><i class="fa-solid fa-file-audio"></i><div class="tool-details"><h4>Audio Narration</h4><p>Transcribe or narrate a document or audio file.</p></div></a></li>
                <li class="tool-item"><a href="#" data-tool="research-report" class="tool-link"><i class="fa-solid fa-flask-vial"></i><div class="tool-details"><h4>Research Report</h4><p>Generate a detailed research report on a topic.</p></div></a></li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Short helper
const $ = id => document.getElementById(id);

// ---------- Global chat storage ----------
let chats = JSON.parse(localStorage.getItem("elvion_chats") || "[]");
let currentChatIdx = (typeof localStorage !== 'undefined' && localStorage.getItem('elvion_current_idx') !== null)
  ? Number(localStorage.getItem('elvion_current_idx')) : (chats.length - 1 >= 0 ? chats.length - 1 : 0);

function saveChats() {
  try {
    let sanitized = JSON.parse(JSON.stringify(chats));
    sanitized.forEach(chat => {
      (chat.history || []).forEach(msg => {
        if (msg.text && typeof msg.text === 'string' && msg.text.includes("data:image")) {
          msg.text = "[image omitted]";
        }
      });
    });
    localStorage.setItem("elvion_chats", JSON.stringify(sanitized));
    localStorage.setItem('elvion_current_idx', String(currentChatIdx));
  } catch (e) { console.warn('saveChats failed', e); }
}

// Keep file/upload state
let uploadedFiles = [];
let uploadData = null;

// ---------- DOM & wiring ----------
window.addEventListener('DOMContentLoaded', () => {
  /* ---------- Elements (may be null) ---------- */
  const starsContainer = $('stars-container');
  const mainContainer = $('mainContainer') || $('main-container') || document.body;
  const fullscreenBtn = $('fullscreenBtn') || $('fullscreen-btn');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const toolsMenuBg = $('toolsMenuBg');
  const toolsMenu = $('toolsMenu');
  const toolBtn = $('toolBtn');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatSelector = $('chatSelector');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const voiceInputBtn = $('voiceInputBtn'); // declared once
  const addChatBtn = $('addChatBtn');
  const removeChatBtn = $('removeChatBtn');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  const emojiBtn = $('emojiBtn');
  const imageBtnHtml = $('imageBtn');
  const voiceBtnHtml = $('voiceBtn');
  
  if (!chatForm) console.warn('chatForm not found in DOM. Chat submission disabled until element added.');
  if (!chatBox) console.warn('chatBox not found in DOM. Chat rendering disabled until element added.');
  
  let pendingToolAction = null;
  let toolPromptState = {};
  
  const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore"];
  
  /* ---------- Emoji ---------- */
  const emojis = ["😀","😃","😂","🤣","😍","🥰","😎","👍","🙏","🔥","💯","🎉","😇","🫶","😜","🤖","👀"];
  if (emojiBtn && emojiPanel && chatInput) {
    emojiBtn.addEventListener('click', function (e) {
      emojiPanel.innerHTML = emojis.map(em => `<span class="emoji-pick" role="button" tabindex="0" aria-label="emoji">${em}</span>`).join('');
      emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
      try {
        const rect = emojiBtn.getBoundingClientRect();
        emojiPanel.style.left = `${Math.max(8, rect.left)}px`;
      } catch (e) { }
      emojiPanel.querySelectorAll('.emoji-pick').forEach(span => {
        span.addEventListener('click', function () {
          const text = this.textContent || '';
          const start = chatInput.selectionStart || 0;
          const end = chatInput.selectionEnd || 0;
          chatInput.value = chatInput.value.slice(0, start) + text + chatInput.value.slice(end);
          chatInput.focus();
          chatInput.selectionStart = chatInput.selectionEnd = start + text.length;
          emojiPanel.style.display = 'none';
          chatInput.dispatchEvent(new Event('input'));
        });
      });
    });
    document.addEventListener('click', e => {
      if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
        emojiPanel.style.display = 'none';
      }
    });
  }

  /* ---------- Stars ---------- */
  if (starsContainer) {
    starsContainer.innerHTML = '';
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  /* ---------- Fullscreen toggle ---------- */
  if (fullscreenBtn && mainContainer) {
    let isFull = false;
    fullscreenBtn.addEventListener('click', () => {
      isFull = !isFull;
      mainContainer.classList.toggle('fullscreen', isFull);
      try { fullscreenBtn.innerHTML = isFull ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>'; } catch (e) {}
    });
  }

  /* ---------- Panels/Modals ---------- */
  window.closeToolMenu = () => {
    if (toolsMenuBg) toolsMenuBg.style.display = 'none';
  };
  window.openToolMenu = () => {
    if (toolsMenuBg) toolsMenuBg.style.display = 'block';
  };

  if (profileMenuBg && profileMenu && $('openProfileMenu')) {
    $('openProfileMenu').addEventListener('click', () => {
      profileMenuBg.classList.add('active');
      setTimeout(() => profileMenu.classList.add('active'), 10);
    });
    profileMenuBg.addEventListener('click', e => {
      if (e.target === profileMenuBg) {
        profileMenu.classList.remove('active');
        setTimeout(() => profileMenuBg.classList.remove('active'), 110);
      }
    });
  }
  if (linkMenuBg && linkMenu && $('openLinksMenu')) {
    $('openLinksMenu').addEventListener('click', () => {
      linkMenuBg.classList.add('active');
      setTimeout(() => linkMenu.classList.add('active'), 10);
    });
    linkMenuBg.addEventListener('click', e => {
      if (e.target === linkMenuBg) {
        linkMenu.classList.remove('active');
        setTimeout(() => linkMenuBg.classList.remove('active'), 110);
      }
    });
  }
  
  if (toolBtn) {
    toolBtn.addEventListener('click', openToolMenu);
    if (toolsMenuBg) toolsMenuBg.addEventListener('click', e => {
      if (e.target === toolsMenuBg) {
        closeToolMenu();
      }
    });
  }

  if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = 'signup-login.html');

  /* ---------- Firebase auth (profile only) ---------- */
  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      try { window.location.href = "signup-login.html"; } catch (e) {}
      return;
    }
    currentUser = user;
    if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]);
    if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
    if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
    if (editName) editName.value = user.displayName || "";
    if (editPhoto) editPhoto.value = user.photoURL || "";
    if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

    if (!Array.isArray(chats) || chats.length === 0) {
      chats = [{ name: 'Chat 1', history: [] }];
      currentChatIdx = 0;
      saveChats();
    }
    try { renderChatsListSidebar(); } catch (e) { console.warn('renderChatSelector error', e); }
    try { renderChatBox((chats[currentChatIdx] || {}).history || []); } catch (e) { console.warn('renderChatBox error', e); }
  });

  /* ---------- Profile form submit (update Firebase profile) ---------- */
  if (profileForm) {
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const status = $('profileStatusMsg');
      if (status) status.textContent = '';
      const name = editName ? editName.value.trim() : '';
      const photoURL = editPhoto ? editPhoto.value.trim() : '';
      try {
        await updateProfile(currentUser, { displayName: name, photoURL });
        if (auth.currentUser && typeof auth.currentUser.reload === 'function') await auth.currentUser.reload();
        if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; }
        setTimeout(() => { profileMenu?.classList.remove('active'); profileMenuBg?.classList.remove('active'); }, 650);
        if (headerWelcome) headerWelcome.textContent = "Welcome, " + (auth.currentUser?.displayName || (auth.currentUser?.email || '').split('@')[0]);
      } catch (err) {
        if (status) { status.textContent = err.message || "Update failed"; status.style.color = "#ffd700"; }
      }
    });
  }

  /* ---------- Sidebar / Chats list ---------- */
  function renderChatsListSidebar() {
    if (!chatsListEl) return;
    chatsListEl.innerHTML = '';
    chats.forEach((chat, idx) => {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.marginBottom = '6px';

      const titleSpan = document.createElement('span');
      titleSpan.textContent = chat.name || `Chat ${idx + 1}`;
      titleSpan.style.flex = '1';
      titleSpan.style.cursor = 'pointer';
      titleSpan.onclick = () => {
        currentChatIdx = idx;
        saveChats();
        renderChatBox(chat.history || []);
        if (chatSelector) chatSelector.value = idx;
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      const renameBtn = document.createElement('button');
      renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
      renameBtn.title = 'Rename';
      renameBtn.style.margin = '0 6px 0 8px';
      renameBtn.onclick = (e) => {
        e.stopPropagation();
        const newName = prompt("Rename chat:", chat.name || `Chat ${idx + 1}`);
        if (newName) {
          chat.name = newName.trim();
          saveChats();
          renderChatsListSidebar();
          renderChatSelector();
        }
      };

      const delBtn = document.createElement('button');
      delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.title = 'Delete';
      delBtn.style.marginLeft = '6px';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (!confirm("Delete this chat?")) return;
        chats.splice(idx, 1);
        if (currentChatIdx >= chats.length) currentChatIdx = chats.length - 1;
        if (!chats.length) { chats.push({ name: 'Chat 1', history: [] }); currentChatIdx = 0; }
        saveChats();
        renderChatsListSidebar();
        renderChatSelector();
        renderChatBox(chats[currentChatIdx]?.history || []);
      };

      const openBtn = document.createElement('button');
      openBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
      openBtn.title = 'Open Chat';
      openBtn.onclick = (e) => {
        e.stopPropagation();
        currentChatIdx = idx;
        renderChatBox(chat.history || []);
        if (chatSelector) chatSelector.value = idx;
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      container.appendChild(titleSpan);
      container.appendChild(renameBtn);
      container.appendChild(delBtn);
      container.appendChild(openBtn);
      chatsListEl.appendChild(container);
    });
  }

  if (newChatBtn) {
    newChatBtn.addEventListener('click', () => {
      chats.push({ name: "Chat " + (chats.length + 1), history: [] });
      currentChatIdx = chats.length - 1;
      saveChats();
      renderChatsListSidebar();
      renderChatSelector();
      renderChatBox(chats[currentChatIdx]?.history || []);
    });
  }

  /* ---------- Chat selector (dropdown) ---------- */
  function renderChatSelector() {
    if (!chatSelector) return;
    chatSelector.innerHTML = '';
    chats.forEach((chat, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = chat.name || (chat.history?.[0]?.text?.slice(0, 24) || "Untitled");
      chatSelector.appendChild(option);
    });
    if (!chats.length) {
      chats = [{ name: 'Chat 1', history: [] }];
      currentChatIdx = 0;
      saveChats();
      return renderChatSelector();
    }
    if (typeof currentChatIdx === 'number') {
      currentChatIdx = Math.min(Math.max(0, currentChatIdx), Math.max(0, chats.length - 1));
      chatSelector.value = currentChatIdx;
    }
  }

  if (chatSelector) {
    chatSelector.addEventListener('change', function () {
      currentChatIdx = parseInt(this.value) || 0;
      saveChats();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  if (addChatBtn) {
    addChatBtn.addEventListener('click', () => {
      chats.push({ name: "Chat " + (chats.length + 1), history: [] });
      currentChatIdx = chats.length - 1;
      saveChats();
      renderChatSelector();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  if (removeChatBtn) {
    removeChatBtn.addEventListener('click', () => {
      if (!chats.length) return;
      if (!confirm("Delete this chat?")) return;
      chats.splice(currentChatIdx, 1);
      currentChatIdx = Math.max(0, currentChatIdx - 1);
      if (!chats.length) { chats.push({ name: 'Chat 1', history: [] }); currentChatIdx = 0; }
      saveChats();
      renderChatSelector();
      renderChatBox((chats[currentChatIdx]?.history || []) || []);
    });
  }

  /* ---------- Markdown/render helpers ---------- */
  const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

  function inlineMarkdown(t = '') {
    let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`);
    s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
    s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return s.replace(/\n/g, '<br>');
  }

  function renderMarkdown(text = '') {
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    text = text || '';
    text.replace(codeBlockRegex, (match, lang, code, offset) => {
      const before = text.slice(lastIndex, offset);
      html += inlineMarkdown(before);
      const language = (lang || '').toLowerCase().trim();
      const safe = escapeHTML(code);
      const blockId = 'code_' + Math.random().toString(36).slice(2);
      html += `<pre data-block-id="${blockId}">\n  <button class="copy-btn" data-copy="${blockId}">Copy</button>\n  <code class="language-${language || 'plaintext'}">${safe}</code>\n</pre>`;
      lastIndex = offset + match.length;
      return match;
    });
    html += inlineMarkdown(text.slice(lastIndex));
    return { html };
  }

  function enhanceCodeBlocks(container) {
    if (!container) return;
    container.querySelectorAll('pre').forEach(pre => {
      const codeEl = pre.querySelector('code');
      if (window.hljs && codeEl) {
        try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ }
      }
      const btn = pre.querySelector('.copy-btn');
      if (btn && codeEl) {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(codeEl.innerText);
            const prev = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = prev, 800);
          } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); }
        });
      }
    });
  }

  /* ---------- Chat rendering & controls ---------- */
function renderChatBox(messages = []) {
    if (!chatBox) return;
    chatBox.innerHTML = '';
    let aiMsgIdx = 0;

    (messages || []).forEach((msg, idx) => {
      const div = document.createElement('div');
      div.className = 'chat-message ' + (msg.role === 'user' ? 'user' : 'ai');

      let innerHtml = '';
      if (msg.role === 'user') {
        const fileHtml = (msg.files || [])
          .map(file => {
            if (file.type.startsWith('image/')) {
              return `<img src="${file.url}" alt="${file.name}" class="chat-media-preview image-preview-thumb">`;
            } else if (file.type.startsWith('video/')) {
              return `<video src="${file.url}" controls class="chat-media-preview video-preview-thumb"></video>`;
            } else if (file.type.startsWith('audio/')) {
              return `<audio src="${file.url}" controls class="chat-media-preview audio-preview-thumb"></audio>`;
            } else {
              return `<a href="${file.url}" target="_blank" class="chat-media-preview file-link"><i class="fa-solid fa-file"></i> ${escapeHTML(file.name)}</a>`;
            }
          })
          .join('');
        
        innerHtml = `<div class="msg">
          ${fileHtml ? `<div class="file-attachments">${fileHtml}</div>` : ''}
          ${escapeHTML(msg.text || '')}
          <div class="user-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
            <button class="inline-edit-btn" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
            <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
          </div>
        </div>`;
        div.setAttribute('data-useridx', idx);
      } else { // AI message
        const { html } = renderMarkdown(msg.text || '');
        innerHtml = `<div class="msg">${html}
          <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
            <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
            <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button>
            <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
          </div>
        </div>`;
        div.setAttribute('data-aiidx', aiMsgIdx++);
      }
      
      div.innerHTML = innerHtml;
      chatBox.appendChild(div);
    });
    enhanceCodeBlocks(chatBox);
    hookAiMsgControls();
    hookUserMsgControls();
    setTimeout(() => {
      const last = chatBox.lastElementChild;
      if (last) last.scrollIntoView({ behavior: "smooth", block: "end" });
    }, 20);
}

function hookAiMsgControls() {
  if (!chatBox) return;
  chatBox.querySelectorAll('.chat-message.ai').forEach(div => {
    const aiIdx = Number(div.getAttribute('data-aiidx'));
    const controls = div.querySelector('.ai-msg-controls');
    if (!controls) return;
    const copyBtn = controls.querySelector('.inline-copy-btn');
    const shareBtn = controls.querySelector('.inline-share-btn');
    const regenBtn = controls.querySelector('.regen-btn');

    if (copyBtn) copyBtn.onclick = () => {
      try {
        const aiOnly = (chats[currentChatIdx]?.history || []).filter(m => m.role === "ai") || [];
        const text = aiOnly[aiIdx]?.text || "";
        navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
        copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
        setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950);
      } catch (e) { console.warn('copy failed', e); }
    };

    if (shareBtn) shareBtn.onclick = () => {
      try {
        const aiOnly = (chats[currentChatIdx]?.history || []).filter(m => m.role === "ai") || [];
        const text = aiOnly[aiIdx]?.text || "";
        const url = window.location.origin;
        const shareText = `${text.replace(/<\/?[^>]+(>|$)/g, "")}\n\nShared via Philadelphia AI: ${url}`;
        if (navigator.share) navigator.share({ title: "Philadelphia AI", text: shareText, url }).catch(()=>{});
        else prompt("Copy and share manually:", shareText);
      } catch (e) { console.warn('share failed', e); }
    };

    if (regenBtn) regenBtn.onclick = async () => {
      try {
        let aiMsgCount = 0, aiMsgIndexInHistory = -1;
        const history = chats[currentChatIdx]?.history || [];
        for (let i = 0; i < history.length; i++) {
          if (history[i].role === "ai") {
            if (aiMsgCount === aiIdx) { aiMsgIndexInHistory = i; break; }
            aiMsgCount++;
          }
        }
        const userMsgObj = history[aiMsgIndexInHistory - 1];
        const userMsg = (userMsgObj?.role === "user" ? userMsgObj.text : "");
        if (!userMsg) {
          regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i> Err";
          setTimeout(() => regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i>", 900);
          return;
        }
        if (aiMsgIndexInHistory >= 0) history.splice(aiMsgIndexInHistory, 1);
        saveChats();
        renderChatBox(history);
        showTypingAtNext();
        try {
          let res = await fetch('https://web-production-9a18.up.railway.app/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMsg, user_id: currentUser?.uid || "user", history: [] })
          });
          let data;
          try { data = await res.json(); } catch (e) { data = {}; }
          removeTyping();
          if (data && data.response) {
            history.push({ role: 'ai', text: data.response });
            saveChats();
            renderChatBox(history);
          } else {
            history.push({ role: 'ai', text: '❌ No response from server.' });
            saveChats();
            renderChatBox(history);
          }
        } catch (err) {
          removeTyping();
          history.push({ role: 'ai', text: "❌ Retry Error: " + (err.message || '') });
          saveChats();
          renderChatBox(history);
        }
      } catch (err) {
        console.warn('regen error', err);
      }
    };
  });
}

function hookUserMsgControls() {
  if (!chatBox) return;
  chatBox.querySelectorAll('.chat-message.user').forEach(div => {
    const userIdx = Number(div.getAttribute('data-useridx'));
    const controls = div.querySelector('.user-msg-controls');
    if (!controls) return;
    const copyBtn = controls.querySelector('.inline-copy-btn');
    const editBtn = controls.querySelector('.inline-edit-btn');

    if (copyBtn) copyBtn.onclick = () => {
      try {
        const text = chats[currentChatIdx]?.history?.[userIdx]?.text || "";
        navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
        copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
        setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950);
      } catch (e) { console.warn('copy failed', e); }
    };
    if (editBtn) editBtn.onclick = () => {
      try {
        const text = chats[currentChatIdx]?.history?.[userIdx]?.text || "";
        if (!text) return;
        chatInput.value = text;
        chatInput.focus();
        chats[currentChatIdx].history = chats[currentChatIdx].history.slice(0, userIdx);
        saveChats();
        renderChatBox(chats[currentChatIdx].history);
      } catch (e) { console.warn('edit failed', e); }
    };
  });
}

  /* ---------- Typing / typewriter ---------- */
let typingNode = null;
function showTypingAtNext() {
  removeTyping();
  if (!chatBox) return;
  typingNode = document.createElement('div');
  typingNode.className = 'chat-message ai';
  typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`;
  chatBox.appendChild(typingNode);
  setTimeout(() => {
    typingNode.scrollIntoView({ behavior: "smooth", block: "end" });
  }, 20);
}

function removeTyping() {
  if (typingNode && typingNode.parentNode) {
    typingNode.parentNode.removeChild(typingNode);
    typingNode = null;
  }
}

async function typeBotMessage(text) {
  removeTyping();
  if (!chatBox) return;
  const div = document.createElement('div');
  div.className = "chat-message ai";
  const msgdiv = document.createElement('div');
  msgdiv.className = 'msg';
  div.appendChild(msgdiv);
  chatBox.appendChild(div);
  let sofar = '';
  const words = text.split(' ');
  for (const word of words) {
    sofar += word + ' ';
    msgdiv.innerHTML = renderMarkdown(sofar).html;
    chatBox.scrollTop = chatBox.scrollHeight;
    await new Promise(res => setTimeout(res, 35 + Math.random() * 20));
  }
  msgdiv.innerHTML = renderMarkdown(text).html + `
    <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
        <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
        <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button>
        <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
    </div>
  `;
  enhanceCodeBlocks(msgdiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  chats[currentChatIdx].history.push({ role: 'ai', text: text });
  saveChats();
  renderChatSelector();
  hookAiMsgControls();
}

  /* ---------- File preview helpers ---------- */
function renderFilePreview() {
  if (!filePreview) return;
  if (!uploadedFiles.length) {
    filePreview.style.display = 'none';
    filePreview.innerHTML = '';
    return;
  }
  filePreview.style.display = 'block';
  filePreview.innerHTML = uploadedFiles.map((file, idx) => {
    let preview = '';
    if (file.type.startsWith('image/')) {
      preview = `<img src="${URL.createObjectURL(file)}" style="max-width:58px;max-height:41px;vertical-align:middle;border-radius:8px;margin-right:6px;">`;
    } else if (file.type.startsWith('video/')) {
      preview = `<video src="${URL.createObjectURL(file)}" controls style="max-width:58px;height:41px;vertical-align:middle;border-radius:8px;margin-right:7px;"></video>`;
    } else if (file.type.startsWith('audio/')) {
      preview = `<audio controls src="${URL.createObjectURL(file)}" style="vertical-align:middle;width:52px;margin-right:7px;"></audio>`;
    } else if (file.type === 'application/pdf') {
      preview = `<span style="font-size:1.25em;margin-right:7px;">📄</span>`;
    }
    return `
    <div style="display:flex;align-items:center;gap:7px;margin-bottom:1px;">
      ${preview}
      <span style="color:#aee;font-size:.99em;">${escapeHTML(file.name)}</span>
      <button type="button" data-idx="${idx}" class="remove-file-btn" aria-label="Remove file">&times;</button>
    </div>`;
  }).join('');
  filePreview.querySelectorAll('.remove-file-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const idx = parseInt(btn.getAttribute('data-idx'));
      uploadedFiles.splice(idx, 1);
      uploadData = uploadedFiles[0] || null;
      if (!uploadedFiles.length && chatFile) chatFile.value = '';
      renderFilePreview();
    });
  });
}
if (chatFile) {
  chatFile.addEventListener('change', function () {
    const files = Array.from(this.files || []);
    uploadedFiles = files;
    uploadData = files[0] || null;
    renderFilePreview();
  });
}

  /* ---------- Voice input via Web Speech ---------- */
  if (voiceInputBtn && chatInput) {
    let recognition = null;
    voiceInputBtn.addEventListener('click', function () {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const R = window.webkitSpeechRecognition || window.SpeechRecognition;
        recognition = new R();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
        recognition.onresult = (e) => {
          chatInput.value += (chatInput.value ? ' ' : '') + e.results[0][0].transcript;
          chatInput.dispatchEvent(new Event('input'));
          voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        };
        recognition.onend = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
        recognition.onerror = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
        recognition.start();
      } else alert('Speech recognition not supported in your browser.');
    });
  }

  /* ---------- Textarea auto-resize ---------- */
  if (chatInput) {
    function autoResizeTextarea() {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px';
    }
    chatInput.addEventListener('input', autoResizeTextarea);
    autoResizeTextarea();
    chatInput.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBtn?.click(); }
    });
  }

  /* ---------- NEW: TOOL-BASED CHAT HANDLING ---------- */
  async function callImageApi(prompt, model) {
    try {
      const res = await fetch('https://web-production-9a18.up.railway.app/generate-image', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, model })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || res.statusText);
      showAIImagePreview(data.image_b64, `Generated with model: **${model}**`);
      return '✅ Image generated! Check the floating image box to view or download.';
    } catch (err) {
      return `❌ Image generation failed: ${err.message}`;
    }
  }

  async function callComicApi(story, style, panels) {
      try {
          const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/generate-comic', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ story, style, panels, user: currentUser?.displayName || "User" })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || res.statusText);
          const imagesHtml = data.images.map((img, idx) => `<img src="data:image/png;base64,${img}" alt="Comic Panel ${idx+1}" style="max-width:100%;border-radius:12px;margin-bottom:15px;box-shadow:0 0 8px #00fff2c7;">`).join('');
          return `🖼️ Comic successfully created! ${imagesHtml}`;
      } catch (err) {
          return `❌ Comic generation failed: ${err.message}`;
      }
  }

  async function callWebsiteApi(prompt) {
      try {
          const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/create-website', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt, user_id: currentUser?.uid || "user" })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || res.statusText);
          return `🌐 Website deployed successfully! [View here](${data.url})`;
      } catch (err) {
          return `❌ Website creation failed: ${err.message}`;
      }
  }

  async function callVoiceGenApi(text, style) {
      try {
          const fd = new FormData(); fd.append('text', text); fd.append('style', style);
          const res = await fetch('https://web-production-9a18.up.railway.app/voicegen', { method: 'POST', body: fd });
          if (!res.ok) throw new Error(res.statusText);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const audioPlayer = `<audio controls src="${url}" style="width:99%;margin:8px 0 3px 0;border-radius:14px;"></audio>`;
          return `🗣️ Voice generated in *${style}* style:<br>${audioPlayer}`;
      } catch (err) {
          return `❌ Voice generation failed: ${err.message}`;
      }
  }

  async function callResearchApi(topic) {
    try {
      const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/research', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic })
      });
      if (!res.ok) throw new Error(res.statusText);
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const downloadLink = `<a href="${url}" download="research.pdf" style="color:#00eaff;font-weight:bold;text-decoration:none;">Download PDF Report</a>`;
      return `✅ Research report on **${topic}** is ready! ${downloadLink}`;
    } catch (err) {
      return `❌ Research report failed: ${err.message}`;
    }
  }
  
  if (toolsMenu) {
    toolsMenu.querySelectorAll('.tool-link').forEach(link => {
      link.addEventListener('click', async (e) => {
        e.preventDefault();
        const tool = link.getAttribute('data-tool');
        closeToolMenu();
        let responseText = '';
        let userText = `Used the **${link.textContent.trim()}** tool.`;
        
        switch (tool) {
          case 'image':
            pendingToolAction = { type: 'image_prompt' };
            responseText = "What's the image prompt and style? Please format your message like this: `[prompt] style: [style name]`";
            break;
          case 'comic':
            pendingToolAction = { type: 'comic_story' };
            responseText = "Tell me the story for your comic. Use `[INSTRUCTION]`, `[DIALOGUE]`, and `[NARRATION]` to define panels.";
            break;
          case 'website':
            pendingToolAction = { type: 'website_prompt' };
            responseText = "What kind of website do you want? Give me a detailed description.";
            break;
          case 'remove-bg':
            pendingToolAction = { type: 'remove_background_file' };
            responseText = "Okay, I'm ready to remove the background. Please upload the image using the paperclip icon.";
            break;
          case 'voice-gen':
            pendingToolAction = { type: 'voice_style' };
            responseText = "What voice style do you want? You can choose from: `podcast`, `cinematic`, `upbeat`, `soft`, `dramatic`.";
            break;
          case 'audio-narration':
            pendingToolAction = { type: 'audio_file' };
            responseText = "Please upload the document (PDF/text) or audio file you want to narrate using the paperclip icon.";
            break;
          case 'research-report':
            pendingToolAction = { type: 'research_topic' };
            responseText = "What topic would you like me to research and create a PDF report on?";
            break;
          default:
            pendingToolAction = null;
            responseText = "That tool is not yet implemented. Please choose another.";
            userText = `Attempted to use unknown tool: ${tool}`;
        }
        
        if (chats[currentChatIdx].history.length === 1) {
          chats[currentChatIdx].name = userText.slice(0, 25) + "...";
        }
        chats[currentChatIdx].history.push({ role: 'user', text: userText });
        renderChatBox(chats[currentChatIdx].history);
        showTypingAtNext();
        
        await typeBotMessage(responseText);
        saveChats();
        
        if (['remove-bg', 'audio-narration'].includes(tool)) {
          // Highlight the paperclip button to guide the user
          document.querySelector('.file-upload-btn').classList.add('glow');
        }
      });
    });
  }

   if (chatForm) {
  chatForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    if (currentChatIdx < 0 || !chats.length) {
      chats.push({ name: 'Chat 1', history: [] });
      currentChatIdx = 0;
      saveChats();
    }

    const msgText = chatInput ? chatInput.value.trim() : '';
    document.querySelector('.file-upload-btn')?.classList.remove('glow');
    
    // Check for pending tool action
    if (pendingToolAction) {
      let responseText = '';
      let userMsg = { role: 'user', text: msgText };
      if (uploadedFiles.length) {
          userMsg.files = uploadedFiles.map(file => ({
            name: file.name,
            type: file.type,
            url: URL.createObjectURL(file)
          }));
      }

      chats[currentChatIdx].history.push(userMsg);
      renderChatBox(chats[currentChatIdx]?.history || []);
      chatInput.value = '';
      chatInput.dispatchEvent(new Event('input'));
      uploadedFiles = [];
      renderFilePreview();
      showTypingAtNext();
      
      try {
        switch (pendingToolAction.type) {
          case 'image_prompt':
            const promptRegex = /(.+)\s+style:\s+(.+)/i;
            const match = msgText.match(promptRegex);
            if (match) {
              const prompt = match[1].trim();
              const style = match[2].trim().toLowerCase();
              if (thenaModels.includes(style)) {
                responseText = await callImageApi(prompt, style);
                pendingToolAction = null;
              } else {
                responseText = `Invalid style: **${style}**. Please choose from: ${thenaModels.join(', ')}.`;
              }
            } else {
              responseText = "Invalid format. Please use: `[prompt] style: [style name]`";
            }
            break;
          case 'remove_background_file':
            const file = uploadedFiles[0];
            if (!file || !file.type.startsWith('image/')) {
              responseText = "Please upload an image for background removal.";
            } else {
              const fd = new FormData(); fd.append('file', file);
              const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/remove-background', { method: 'POST', body: fd });
              const blob = await res.blob();
              const url = URL.createObjectURL(blob);
              const imageHtml = `<img src="${url}" alt="Image with background removed" style="max-width:100%;border-radius:12px;box-shadow:0 0 8px #00fff2c7;">`;
              responseText = `✅ Background removed! ${imageHtml}`;
              pendingToolAction = null;
            }
            break;
          case 'audio_file':
              const audioFile = uploadedFiles[0];
              if (!audioFile) {
                responseText = "Please upload a document or audio file for narration.";
              } else {
                const fd = new FormData(); fd.append('file', audioFile); fd.append('style', 'podcast');
                const res = await fetch('https://web-production-9a18.up.railway.app/api/tools/audio-narration', { method: 'POST', body: fd });
                if (!res.ok) throw new Error(res.statusText);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const audioPlayer = `<audio controls src="${url}" style="width:99%;margin:8px 0 3px 0;border-radius:14px;"></audio>`;
                responseText = `🗣️ Narration generated! ${audioPlayer}`;
                pendingToolAction = null;
              }
              break;
          case 'voice_style':
            const validStyles = ["podcast", "cinematic", "upbeat", "soft", "dramatic"];
            const style = msgText.toLowerCase().trim();
            if (validStyles.includes(style)) {
              pendingToolAction = { type: 'voice_text', style };
              responseText = "Great! Now, please type the text you want me to read aloud.";
            } else {
              responseText = "Invalid style. Please choose from: " + validStyles.join(', ');
            }
            break;
          case 'voice_text':
            responseText = await callVoiceGenApi(msgText, pendingToolAction.style);
            pendingToolAction = null;
            break;
          case 'research_topic':
            responseText = await callResearchApi(msgText);
            pendingToolAction = null;
            break;
          default:
            responseText = "I'm not sure how to handle that. Please select a tool again from the menu.";
            pendingToolAction = null;
        }
      } catch (err) {
        responseText = `❌ An error occurred: ${err.message || 'Please check your connection and try again.'}`;
        pendingToolAction = null;
      }
      
      removeTyping();
      await typeBotMessage(responseText);
      saveChats();
      return;
    }

    // Regular text chat
    if (msgText || uploadedFiles.length) {
      if (chats[currentChatIdx].history.length === 1) {
        chats[currentChatIdx].name = msgText.slice(0, 25) + "...";
      }
      const filesForHistory = uploadedFiles.map(file => ({
        name: file.name,
        type: file.type,
        url: URL.createObjectURL(file)
      }));
      chats[currentChatIdx].history.push({ role: 'user', text: msgText, files: filesForHistory });
      renderChatBox(chats[currentChatIdx]?.history || []);
      chatInput.value = '';
      chatInput.dispatchEvent(new Event('input'));
      uploadedFiles = [];
      renderFilePreview();
      
      showTypingAtNext();
      try {
        const history = (chats[currentChatIdx].history || []).map(m => ({ role: m.role, content: m.text }));
        const res = await fetch('https://web-production-9a18.up.railway.app/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msgText, user_id: currentUser?.uid || 'user', history }) });
        const data = await res.json();
        const botResponse = data?.response || '🤖 Error. Try sending the text again.';
        await typeBotMessage(botResponse);
      } catch (err) {
        removeTyping();
        const userMessage = { role: 'user', text: msgText };
        chats[currentChatIdx].history.push(userMessage);
        chats[currentChatIdx].history.push({ role: 'ai', text: '❌ An error occurred: ' + (err.message || 'Please check your connection.') });
        saveChats();
        renderChatSelector();
        renderChatBox(chats[currentChatIdx]?.history || []);
      }
    }
  });
}

  /* ---------- AI Image preview UI ---------- */
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');

  if (aiPrevClose && aiPrevBox && aiPrevImgBox) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; aiPrevImgBox.innerHTML = ''; });
  if (aiPrevDLBtn && aiPrevImgBox) aiPrevDLBtn.addEventListener('click', () => {
    const img = aiPrevImgBox.querySelector('img'); if (img) { const url = img.src; const a = document.createElement('a'); a.href = url; a.download = 'generated_image.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
  });

  function showAIImagePreview(srcUrlOrBase64, caption = '') {
    if (!aiPrevBox || !aiPrevImgBox) return;
    let src;
    if (typeof srcUrlOrBase64 === 'string' && (srcUrlOrBase64.startsWith('data:image/') || srcUrlOrBase64.startsWith('blob:'))) {
        src = srcUrlOrBase64;
    } else {
        src = 'data:image/png;base64,' + srcUrlOrBase64;
    }
    aiPrevImgBox.innerHTML = `<img src="${src}" alt="AI generated image" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;">` + (caption ? ' <div style="color:#aee;font-size:.95em;margin-top:3px;text-align:center;">' + caption + '</div>' : '');
    aiPrevBox.style.display = 'block';
}


  if (chatInput) { chatInput.focus(); }
  try { renderChatsListSidebar(); } catch (e) {}
  try { renderChatSelector(); } catch (e) {}
  try { renderChatBox(chats[currentChatIdx]?.history || []); } catch (e) {}
}); // end DOMContentLoaded
    </script>

</body>
</html>
