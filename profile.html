<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --cyan: #00ffff; --blue: #0090ff; --bg: #191a26; --card: #181e2e; --radius: 18px; --text: #e0e0e0;
      --muted: #b3b3b3; --shadow: 0 0 31px #00fff2a4;
    }
    html, body {width:100vw;height:100vh;margin:0;padding:0;font-family:'Inter',sans-serif;background:radial-gradient(circle, #23233a 66%,#0a1128 100%);color:var(--text);}
    body {display:flex;align-items:center;justify-content:center;overflow:hidden;}
    #stars-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;}
    .star{position:absolute;background:rgba(255,255,255,.7);border-radius:50%;opacity:0;animation:twinkle 4.9s infinite linear;}
    @keyframes twinkle{0%,100%{opacity:.13;}54%{opacity:.97;}}
    .card-container {
      background: var(--card); border-radius: var(--radius); max-width: 425px; width:97vw; height: 75vh; min-height:440px; max-height:92vh;
      margin:0 auto;padding:0;display:flex;flex-direction:column;align-items:center;box-shadow:var(--shadow);transition:all .20s;
      position:relative; z-index:2;
    }
    .fullscreen {
      position:fixed;top:0;left:0;width:100vw;height:100vh;min-height:100dvh;max-width:none;max-height:none;padding:0;border-radius:0;z-index:10;box-shadow:none;
    }
    .header-bar {
      width:99%;display:flex;align-items:center;justify-content:space-between;padding:14px 14px 10px 6px;flex-shrink:0;
    }
    .menu-btn {background:none;border:none;color:var(--cyan);font-size:2em;cursor:pointer;padding:0 11px;}
    .fullscreen-btn{background:none;border:none;color:var(--cyan);font-size:1.19em;cursor:pointer;margin-left:11px;}
    .fullscreen-btn:hover,.menu-btn:hover{background:var(--cyan);color:#23233a;}
    .site-heading{font-family:'Orbitron',sans-serif;font-size:1.03em;font-weight:700;letter-spacing:.38px;background:linear-gradient(90deg,#00ffff,#fff,#0090ff);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shine 4s linear infinite;text-shadow:0 0 13px #00ffff43;}
    @keyframes shine{to{background-position:200% center;}}
    .profile-greet{color:#aee;font-size:.97em;margin:.3em auto;text-align:center;max-width:70vw;}
    #chatSwitchBar{width:97%;display:flex;align-items:center;gap:6px;margin:0 auto 7px auto;}
    #chatSelector{padding:8px 7px;border-radius:10px 9px 9px 10px;border:1.3px solid #00ffff;font-size:1em;background:var(--bg);color:var(--text);}
    #newChatBtn, .delChatBtn{padding:4px 10px 5px 10px;border-radius:13px;border:none;cursor:pointer;background:linear-gradient(95deg,#00ffff 69%,#0090ff 100%);font-family:'Orbitron';font-size:.98em;color:#23233a;font-weight:600;box-shadow:0 0 11px #00fff2c7;}
    .delChatBtn{background:none;color:#ffd500a7;}
    .delChatBtn:hover{color:#ff3131;background:#23233a;}
    .chat-box{flex:1;min-height:0;overflow-y:auto;max-height:99%;width:95%;margin:0 auto 1px auto;border-radius:13px;padding:9px 7px 8px 9px;display:flex;flex-direction:column;gap:10px;}
    .chat-message{display:flex;align-items:flex-end;gap:12px;}
    .chat-message.user{justify-content:flex-end;}
    .chat-message .msg{background:linear-gradient(90deg,#23233a 91%,#23233a 100%);color:#e0e0e0;padding:9px 15px;border-radius:13px 14px 7px 13px;max-width:77%;font-size:1.04em;}
    .chat-message.user .msg{background:linear-gradient(90deg,#00ffff 49%,#0090ff 100%);color:#23233a;border-radius:13px 12px 13px 7px;font-weight:700;}
    .chat-message img,.chat-message video{max-width:120px;max-height:110px;border-radius:7px;background:#fff;}
    .file-preview{width:94%;margin:11px auto 0 auto;border-radius:8px;overflow:hidden;background:rgba(35,35,58,.7);border:1px solid rgba(255,255,255,0.20);}
    .file-preview img,.file-preview video{max-width:96%;max-height:100px;display:block;margin:0 auto;}
    .file-preview .file-info{padding:7px;display:flex;align-items:center;font-size:.98em;color:var(--muted);}
    .file-preview .file-info i{margin-right:7px;}
    .chat-input-row{width:92%;display:flex;gap:7px;align-items:center;background:#23233a;border-radius:9px;padding:8px 9px;border:1.1px solid #00ffff21;box-shadow:0 2px 9px #00fff215;margin:3px auto 7px auto;}
    .chat-input-row input[type="file"]{display:none;}
    .chat-input-row label{cursor:pointer;color:var(--cyan);font-size:1.15em;padding:0 5px;}
    .chat-input-row label:hover{color:var(--blue);}
    .chat-input-row input[type="text"]{flex:1;padding:7px 7px;border-radius:8px;border:1.1px solid #23233a;background:#242b3f;color:#e0e0e0;font-size:1em;}
    .chat-input-row input[type="text"]:focus{border:1.15px solid var(--cyan);}
    .chat-input-row button{background:linear-gradient(90deg,#00ffff,#0090ff);color:#23233a;border:none;border-radius:8px;padding:7px 11px 7px 11px;font-size:1.07em;font-weight:700;cursor:pointer;box-shadow:0 2px 7px #00ffff33;}
    .chat-input-row button:hover{background:#0090ff;color:#fff;}
    .chat-typing{color:#00ffff;font-size:1.08em;display:flex;align-items:center;gap:5px;margin:.21em 0 2px .3em;}
    .typing-bounce{display:inline-block;height:17px;}
    .dot-anim{display:inline-block;width:12px;height:12px;margin-right:2.5px;background:#00ffff;border-radius:50%;animation:bounceDot .95s infinite;}
    .dot-anim:nth-child(2){animation-delay:.11s;}
    .dot-anim:nth-child(3){animation-delay:.2s;}
    @keyframes bounceDot{0%,100%{transform:translateY(0);}55%{transform:translateY(-9px);}}
    .status-message{color:#ffd700;font-size:.94em;text-align:center;min-height:16px;}
    /* Modal panels */
    .panel-bg{display:none;position:fixed;z-index:221;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.59);}
    .panel-bg.active{display:flex;}
    .side-panel{background:var(--card);width:99vw;max-width:320px;height:100vh;box-shadow:-2px 0 26px #00ffffcf;display:flex;flex-direction:column;transition:transform .17s;overflow-y:auto;transform:translateX(340px);}
    .side-panel.active{transform:translateX(0);}
    .panel-header{display:flex;flex-direction:column;align-items:center;padding:24px 0 10px 0;}
    .panel-header img{width:42px;height:42px;border-radius:55%;object-fit:cover;}
    .panel-header .username{font-weight:800;font-size:1em;color:var(--cyan);}
    .panel-header .email{font-size:.93em;color:var(--muted);}
    .edit-form{display:flex;flex-direction:column;gap:10px;}
    .edit-form label{color:#00ffff;font-size:.92em;margin-bottom:2px;}
    .edit-form input{border:none;border-bottom:2px solid #23233a;background:#181d2c;color:#eee;font-size:.98em;padding:7px 4px 7px 9px;margin-bottom:3px;border-radius:8px;}
    .edit-form input:focus{border-color:#00ffff;}
    .profile-photo-tip{color:#b3b3b3;font-size:.91em;margin-bottom:4px;}
    .panel-links{display:flex;flex-direction:column;gap:1px;margin-top:11px;align-items:flex-start;}
    .panel-links a{color:var(--text);text-decoration:none;font-weight:700;font-size:1.02em;padding:8px 15px 8px 13px;border-radius:0 11px 11px 0;transition:background .14s;}
    .panel-links a:hover{background:var(--cyan);color:#23233a;}
    @media(max-width:600px){
      .card-container{max-width:99vw;width:100vw;min-height:97vw;height:95vh;}
      .chat-input-row{width:99vw;}
    }
    @media(max-width:400px){
      .card-container{max-width:100vw;width:100vw;}
      .chat-input-row{width:99vw;}
      .chat-box{font-size:.97em;}
    }
  </style>
</head>
<body>
<div id="stars-container"></div>
<div class="card-container" id="mainContainer">
  <div class="header-bar">
    <button class="menu-btn" id="openProfileMenu"><i class="fa-solid fa-user"></i></button>
    <span class="site-heading" style="flex:1;text-align:center;">Elvion AI</span>
    <button class="fullscreen-btn" id="fullscreenBtn"><i class="fa-solid fa-expand"></i></button>
    <button class="menu-btn" id="openLinksMenu"><i class="fa-solid fa-link"></i></button>
  </div>
  <div class="profile-greet" id="greetMsg">Welcome!</div>
  <div id="chatSwitchBar">
    <select id="chatSelector"></select>
    <button id="newChatBtn" title="New chat"><i class="fa-solid fa-plus"></i></button>
    <button class="delChatBtn" id="delChatBtn" title="Delete"><i class="fa-solid fa-trash"></i></button>
  </div>
  <div class="chat-box" id="chatBox"></div>
  <div id="typingMsg" class="chat-typing" style="display:none;">
    <span class="typing-bounce">
      <span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span>
    </span>
  </div>
  <div id="filePreview" class="file-preview" style="display:none;"></div>
  <form class="chat-input-row" id="chatForm" autocomplete="off">
    <label for="chatFile"><i class="fa-solid fa-paperclip"></i></label>
    <input type="file" id="chatFile" accept="*">
    <input type="text" id="chatInput" placeholder="Type or record...">
    <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
    <button type="button" id="voiceInputBtn" title="Record voice"><i class="fa-solid fa-microphone"></i></button>
  </form>
  <div class="status-message" id="statusMsg"></div>
</div>

<!-- Profile Menu Modal -->
<div class="panel-bg" id="profileMenuBg">
  <nav class="side-panel" id="profileMenu">
    <div class="panel-header">
      <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
      <div class="username" id="profileMenuUser">User</div>
      <div class="email" id="profileMenuEmail">email@example.com</div>
    </div>
    <form class="edit-form" id="profileForm" autocomplete="off" style="padding:0 18px;">
      <label for="edit-name">Name</label>
      <input type="text" id="edit-name" required>
      <label for="edit-photo">Photo URL</label>
      <input type="url" id="edit-photo" placeholder="Paste image link">
      <span class="profile-photo-tip">For photo, <a href="https://postimg.cc/" target="_blank" style="color:#00ffff;">upload at postimg.cc</a> and paste link here.</span>
      <button type="submit" class="submit-btn">Save</button>
      <div class="status-message" id="profileStatusMsg"></div>
    </form>
    <button class="submit-btn" id="logoutBtn" style="background:#19192a;color:#00ffff;">Logout</button>
  </nav>
</div>
<!-- Link Menu Modal -->
<div class="panel-bg" id="linkMenuBg">
  <nav class="side-panel" id="linkMenu">
    <div class="panel-header">
      <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Elvion logo">
      <div class="username">Elvion AI Links</div>
    </div>
    <div class="panel-links">
      <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
      <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
      <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
      <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
      <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
    </div>
  </nav>
</div>
<script>
// --- Animating Star BG ---
document.addEventListener('DOMContentLoaded',()=>{
  const starsContainer=document.getElementById('stars-container');
  for(let i=0;i<34;i++){const s=document.createElement('div');s.className='star';
    const z=Math.random()*2.1+1;s.style.width=z+'px';s.style.height=z+'px';s.style.left=Math.random()*100+'%';s.style.top=Math.random()*100+'%';
    s.style.animationDelay=(Math.random()*3.69)+'s';s.style.animationDuration=(2.2+Math.random()*1.1)+'s';
    starsContainer.appendChild(s);}
});

// --- Fullscreen toggle ---
const mainContainer=document.getElementById('mainContainer');
const fullscreenBtn=document.getElementById('fullscreenBtn');
let isFull=false;
fullscreenBtn.onclick=function(){
  isFull=!isFull;
  if(isFull){
    mainContainer.classList.add('fullscreen');
    fullscreenBtn.innerHTML='<i class="fa-solid fa-compress"></i>';
  }else{
    mainContainer.classList.remove('fullscreen');
    fullscreenBtn.innerHTML='<i class="fa-solid fa-expand"></i>';
  }
}

// --- Modal menu triggers ---
const profileMenuBg=document.getElementById('profileMenuBg'),profileMenu=document.getElementById('profileMenu');
const linkMenuBg=document.getElementById('linkMenuBg'),linkMenu=document.getElementById('linkMenu');
document.getElementById('openProfileMenu').onclick=()=>{profileMenuBg.classList.add('active');setTimeout(()=>profileMenu.classList.add('active'),10);}
profileMenuBg.onclick=e=>{if(e.target===profileMenuBg){profileMenu.classList.remove('active');setTimeout(()=>profileMenuBg.classList.remove('active'),130);}};
document.getElementById('openLinksMenu').onclick=()=>{linkMenuBg.classList.add('active');setTimeout(()=>linkMenu.classList.add('active'),10);}
linkMenuBg.onclick=e=>{if(e.target===linkMenuBg){linkMenu.classList.remove('active');setTimeout(()=>linkMenuBg.classList.remove('active'),130);}};

// --- Firebase/Profile logic ---
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {getAuth,onAuthStateChanged,updateProfile} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
const firebaseConfig={apiKey:"AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",authDomain:"elvionai.firebaseapp.com",projectId:"elvionai",storageBucket:"elvionai.firebasestorage.app",messagingSenderId:"161078300830",appId:"1:161078300830:web:f460df8591704eb0e96b8f"};
const app=initializeApp(firebaseConfig);const auth=getAuth(app);
let currentUser;
onAuthStateChanged(auth, user=>{
  if(!user)window.location.href="signup-login.html";
  else{
    currentUser=user;
    document.getElementById("greetMsg").textContent="Welcome, "+(user.displayName||user.email.split('@')[0])+"!";
    document.getElementById("profileMenuUser").textContent=user.displayName||"User";
    document.getElementById("profileMenuEmail").textContent=user.email;
    document.getElementById("edit-name").value=user.displayName||"";
    document.getElementById("edit-photo").value=user.photoURL||"";
    document.getElementById("profilePicPreview").src=user.photoURL||"https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
  }
});
document.getElementById("edit-photo").oninput=function(){
  document.getElementById("profilePicPreview").src=this.value||"https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
};
document.getElementById("profileForm").onsubmit=async function(e){
  e.preventDefault(); if(!currentUser)return;
  const status=document.getElementById("profileStatusMsg"); status.textContent='';
  const name=document.getElementById("edit-name").value.trim();
  const photoURL=document.getElementById("edit-photo").value.trim();
  try{
    await updateProfile(currentUser,{displayName:name,photoURL});
    await auth.currentUser.reload();
    status.textContent="Profile updated!";
    status.style.color="#00ffff";
    setTimeout(()=>{profileMenu.classList.remove('active');profileMenuBg.classList.remove('active');}, 650);
    document.getElementById("greetMsg").textContent="Welcome, "+(auth.currentUser.displayName||auth.currentUser.email.split('@')[0])+"!";
  }catch(err){
    status.textContent=err.message||"Update failed";
    status.style.color="#ffd700";
  }
};
document.getElementById("logoutBtn").onclick=()=>window.location.href='signup-login.html';

// --- Multi-chat logic ---
let chats=JSON.parse(localStorage.getItem("elvion_chats")||"[]");
let currentChatIdx=chats.length-1>=0?chats.length-1:0;
function saveChats(){localStorage.setItem("elvion_chats",JSON.stringify(chats));}
function renderChatSelector(){
  const chatSelector=document.getElementById("chatSelector");
  chatSelector.innerHTML="";
  chats.forEach((chat,idx)=>{
    const option=document.createElement("option");
    option.value=idx;option.textContent=chat.name||(chat.history?.[0]?.text?.slice(0,25)||"Untitled");
    chatSelector.appendChild(option);
  });
  chatSelector.value=currentChatIdx;
}
document.getElementById("chatSelector").onchange=function(){currentChatIdx=parseInt(this.value)||0;renderChatBox(chats[currentChatIdx]?.history);}
function loadChat(idx){currentChatIdx=idx||0;renderChatBox(chats[idx]?.history);}
function renderChatBox(messages){
  const chatBox=document.getElementById("chatBox");chatBox.innerHTML="";
  (messages||[]).forEach(msg=>{
    const div=document.createElement('div');
    div.className="chat-message "+(msg.role==="user"?"user":"ai");
    if(msg.text&&/^(\[File\]|image:)/.test(msg.text)){div.innerHTML=msg.text.replace('image:','');}
    else div.innerHTML=`<div class="msg">${msg.text}</div>`;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop=chatBox.scrollHeight;
}
document.getElementById("newChatBtn").onclick=function(){
  const name="Chat "+(chats.length+1);
  chats.push({name,history:[]});
  currentChatIdx=chats.length-1;
  saveChats();renderChatSelector();loadChat(currentChatIdx);
};
// Delete current chat
document.getElementById("delChatBtn").onclick=function(){
  if(!chats.length)return;
  if(!confirm("Delete this chat?"))return;
  chats.splice(currentChatIdx,1);
  if(currentChatIdx>=chats.length)currentChatIdx=chats.length-1;
  saveChats();renderChatSelector();loadChat(currentChatIdx);
};
// Typing animation
function showTyping(on){document.getElementById("typingMsg").style.display=on?"":"none";}

// --- File preview logic ---
let uploadData=null;
document.getElementById("chatFile").onchange = function(){
  const file=this.files[0],fp=document.getElementById("filePreview");
  uploadData=null;if(!file){fp.style.display="none";fp.innerHTML="";return;}
  fp.style.display='block';uploadData=file;
  if(file.type.startsWith("image/")){
    const reader=new FileReader();
    reader.onload=e=>{fp.innerHTML=`<img src="${e.target.result}">`;};
    reader.readAsDataURL(file);
  }else if(file.type.startsWith("video/")){
    const reader=new FileReader();
    reader.onload=e=>{fp.innerHTML=`<video src="${e.target.result}" controls></video>`;};
    reader.readAsDataURL(file);
  }else{
    fp.innerHTML=`<div class="file-info"><i class="fa-solid fa-file"></i> ${file.name}</div>`;
  }
};

// --- Voice input (speech-to-text) ---
let recognition;
document.getElementById("voiceInputBtn").onclick=function(){
  if('webkitSpeechRecognition'in window){
    recognition=new webkitSpeechRecognition();
    recognition.continuous=false;recognition.interimResults=false;recognition.lang='en-US';
    document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone-lines"></i>';
    recognition.onresult=function(e){
      document.getElementById('chatInput').value+=e.results[0][0].transcript;
      document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone"></i>';
    };
    recognition.onend=function(){document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone"></i>';};
    recognition.onerror=function(){document.getElementById("voiceInputBtn").innerHTML='<i class="fa-solid fa-microphone"></i>';};
    recognition.start();
  }else{
    alert("Speech recognition not supported in your browser.");
  }
};

// --- Chat send logic (file preview POST, then message POST) ---
document.getElementById("chatForm").onsubmit=async function(e){
  e.preventDefault();
  let file = uploadData, fp=document.getElementById("filePreview");
  let chatInput=document.getElementById("chatInput");
  let msgText=chatInput.value.trim();
  if(currentChatIdx<0){chats.push({name:"Chat 1",history:[]});currentChatIdx=0;}
  showTyping(true);
  if(file){
    const formData=new FormData();
    formData.append("file",file);
    formData.append("message",msgText);
    formData.append("user_id","user");
    try{
      const res=await fetch("https://web-production-9a18.up.railway.app/upload-file",{method:"POST",body:formData});
      const data=await res.json();
      let isImg = /^image\//.test(file.type);
      let isVid = /^video\//.test(file.type);
      let bubble = isImg ? `<img src='${URL.createObjectURL(file)}'>` : isVid ? `<video src='${URL.createObjectURL(file)}' controls></video>` : `<div class="msg">[File] ${msgText||file.name}</div>`;
      chats[currentChatIdx].history.push({role:"user",text:"image:"+bubble});
      chats[currentChatIdx].history.push({role:"ai",text:data.response||"ðŸ¤– Bot file reply."});
    }catch(err){
      chats[currentChatIdx].history.push({role:"ai",text:"[File upload failed] "+(err.message||'no net')});
    }
    chatInput.value="";document.getElementById("chatFile").value="";fp.style.display="none";fp.innerHTML="";uploadData=null;
    saveChats();renderChatSelector();renderChatBox(chats[currentChatIdx].history);showTyping(false);return;
  }
  if(msgText){
    chats[currentChatIdx].history.push({role:"user",text:msgText});
    if(chats[currentChatIdx].history.length===1){
      chats[currentChatIdx].name=msgText.slice(0,25)+"..."; renderChatSelector();
    }
    renderChatBox(chats[currentChatIdx].history);saveChats();showTyping(true);
    try{
      const history=chats[currentChatIdx].history.map(m=>({role:m.role,content:m.text}));
      const res=await fetch("https://web-production-9a18.up.railway.app/chat",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msgText,user_id:"user",history})});
      const data=await res.json();
      chats[currentChatIdx].history.push({role:"ai",text:data.response||"ðŸ¤– Bot replied."});
      saveChats();renderChatSelector();renderChatBox(chats[currentChatIdx].history);showTyping(false);
    }catch(err){
      showTyping(false);
      chats[currentChatIdx].history.push({role:"ai",text:"Sorry, bot error: "+err.message});
      renderChatBox(chats[currentChatIdx].history);saveChats();
    }
  }
  chatInput.value="";
};
// Initial render
renderChatSelector();loadChat(currentChatIdx);
</script>
</body>
</html>
