<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Nexus Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Confetti for Success -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root {
      --bg-deep: #02040a;
      --bg-panel: rgba(10, 15, 30, 0.65);
      --primary: #00f3ff; /* Cyan */
      --secondary: #7000ff; /* Purple */
      --fire: #ff0055; /* Fiery Pink/Red */
      --success: #00ff9d;
      --text-main: #ffffff;
      --text-muted: #8b9bb4;
      --border-glass: 1px solid rgba(255, 255, 255, 0.08);
      --glow-blue: 0 0 20px rgba(0, 243, 255, 0.2);
      --glow-fire: 0 0 20px rgba(255, 0, 85, 0.3);
      --sidebar-width: 260px;
    }

    * { box-sizing: border-box; outline: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-deep);
      color: var(--text-main);
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(112, 0, 255, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(0, 243, 255, 0.1) 0%, transparent 40%);
    }

    /* --- LAYOUT --- */
    .app-container { display: flex; min-height: 100vh; }
    
    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar-width);
      background: rgba(5, 8, 16, 0.9);
      border-right: var(--border-glass);
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
      padding: 30px 20px;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 50px;
      padding-bottom: 20px;
      border-bottom: var(--border-glass);
    }
    .brand img { width: 45px; height: 45px; border-radius: 10px; border: 1px solid var(--primary); box-shadow: var(--glow-blue); }
    .brand h1 { font-family: 'Rajdhani'; font-size: 1.6rem; margin: 0; background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .nav-links { list-style: none; padding: 0; display: flex; flex-direction: column; gap: 10px; flex-grow: 1; }
    .nav-item a {
      display: flex; align-items: center; gap: 15px;
      padding: 12px 15px;
      border-radius: 12px;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      border: 1px solid transparent;
    }
    .nav-item a:hover, .nav-item a.active {
      background: rgba(0, 243, 255, 0.05);
      color: var(--primary);
      border-color: rgba(0, 243, 255, 0.2);
      box-shadow: var(--glow-blue);
      transform: translateX(5px);
    }
    .nav-item i { width: 20px; text-align: center; }

    .user-mini {
      margin-top: auto;
      background: rgba(255,255,255,0.03);
      padding: 15px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: space-between;
      border: var(--border-glass);
    }
    .logout-btn { background: none; border: none; color: var(--fire); cursor: pointer; font-size: 1.1rem; }
    .logout-btn:hover { transform: scale(1.2); text-shadow: var(--glow-fire); }

    /* MAIN CONTENT */
    .main-content {
      margin-left: var(--sidebar-width);
      flex-grow: 1;
      padding: 40px;
    }

    /* HEADER & STATS */
    .top-bar { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px; }
    .page-title h2 { font-family: 'Rajdhani'; font-size: 2.5rem; margin: 0; line-height: 1; }
    .page-title p { color: var(--text-muted); margin: 5px 0 0 0; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px; }
    
    .glass-card {
      background: var(--bg-panel);
      border: var(--border-glass);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    .glass-card::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      opacity: 0.5;
    }
    .glass-card:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.15); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); }

    .balance-card { background: linear-gradient(145deg, rgba(0, 243, 255, 0.05), rgba(0,0,0,0)); border-color: rgba(0, 243, 255, 0.2); }
    .balance-title { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
    .balance-val { font-family: 'Rajdhani'; font-size: 3.5rem; font-weight: 700; color: #fff; margin: 10px 0; text-shadow: 0 0 30px rgba(0, 243, 255, 0.2); }
    
    /* BUTTONS */
    .btn-group { display: flex; gap: 10px; margin-top: 15px; }
    .btn {
      padding: 12px 24px; border-radius: 8px; border: none;
      font-family: 'Rajdhani'; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
      position: relative; overflow: hidden;
    }
    .btn-primary {
      background: var(--primary); color: #000;
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    }
    .btn-primary:hover { background: #fff; box-shadow: 0 0 30px rgba(0, 243, 255, 0.6); }

    .btn-glass {
      background: rgba(255, 255, 255, 0.05); color: #fff; border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .btn-glass:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--primary); color: var(--primary); }

    .btn-danger-soft { background: rgba(255, 0, 85, 0.1); color: var(--fire); border: 1px solid rgba(255, 0, 85, 0.2); padding: 8px 16px; font-size: 0.8rem; }
    .btn-danger-soft:hover { background: var(--fire); color: #fff; }

    /* ADMIN SECTION */
    #admin-panel { display: none; margin-bottom: 40px; border: 1px solid var(--secondary); box-shadow: 0 0 30px rgba(112, 0, 255, 0.1); }
    .admin-header { display: flex; align-items: center; gap: 10px; color: var(--secondary); margin-bottom: 20px; }
    
    /* TABLES */
    .table-container { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { text-align: left; color: var(--text-muted); padding: 15px; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.05); }
    td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(255,255,255,0.02); }

    .key-display { font-family: 'Courier New', monospace; color: var(--success); background: rgba(0, 255, 157, 0.05); padding: 5px 10px; border-radius: 4px; border: 1px solid rgba(0, 255, 157, 0.2); }
    
    /* MODALS */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 999; display: none; align-items: center; justify-content: center; opacity: 0; animation: fadeIn 0.3s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
    
    .modal-content {
      background: #0a0f18;
      border: 1px solid var(--primary);
      box-shadow: 0 0 50px rgba(0, 243, 255, 0.15);
      width: 90%; max-width: 450px;
      padding: 30px; border-radius: 20px;
      position: relative;
      transform: scale(0.9); animation: zoomIn 0.3s forwards;
    }
    @keyframes zoomIn { to { transform: scale(1); } }

    .input-group label { display: block; color: var(--primary); margin-bottom: 8px; font-size: 0.85rem; font-weight: 600; }
    .input-group input {
      width: 100%; background: #151a25; border: 1px solid rgba(255,255,255,0.1);
      color: #fff; padding: 14px; border-radius: 8px; font-size: 1rem;
    }
    .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }

    /* TOAST NOTIFICATIONS */
    #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      background: rgba(10, 15, 25, 0.95);
      backdrop-filter: blur(10px);
      border-left: 4px solid;
      padding: 16px 20px;
      border-radius: 8px;
      color: #fff;
      min-width: 300px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: flex; align-items: center; gap: 15px;
      transform: translateX(100%); animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes slideIn { to { transform: translateX(0); } }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--fire); }
    .toast.info { border-color: var(--primary); }
    .toast-icon { font-size: 1.2rem; }

    /* Loader */
    .loader { width: 18px; height: 18px; border: 2px solid rgba(0,0,0,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s infinite linear; display: none; }
    .btn.loading .loader { display: block; }
    .btn.loading span { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Verified Box Animation */
    #verify-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; border-radius: 20px; z-index: 10; }
    .pulse-text { color: var(--primary); animation: pulse 1.5s infinite; font-weight: bold; }
    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.active { transform: translateX(0); }
      .main-content { margin-left: 0; padding: 20px; }
      .top-bar { flex-direction: column; align-items: flex-start; gap: 20px; }
      #mobile-toggle { display: block; position: fixed; top: 20px; right: 20px; z-index: 200; background: var(--bg-panel); border: 1px solid var(--primary); color: var(--primary); padding: 10px; border-radius: 8px; }
    }
    #mobile-toggle { display: none; }
  </style>
</head>
<body>

<!-- Mobile Menu Button -->
<button id="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

<!-- SIDEBAR -->
<nav class="sidebar" id="sidebar">
  <div class="brand">
    <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Logo">
    <div>
      <h1>ELVION AI</h1>
      <span style="font-size: 0.7rem; color: var(--primary); letter-spacing: 2px; text-transform: uppercase;">Nexus Console</span>
    </div>
  </div>

  <ul class="nav-links">
    <li class="nav-item"><a href="https://elvionai.com.ng" target="_blank"><i class="fas fa-globe"></i> Website Home</a></li>
    <li class="nav-item"><a href="#" class="active"><i class="fas fa-th-large"></i> Dashboard</a></li>
    <li class="nav-item"><a href="https://elvionai.com.ng/api.html" target="_blank"><i class="fas fa-book"></i> API Docs</a></li>
    <li class="nav-item"><a href="https://elvionai.com.ng/philadelphia.html" target="_blank"><i class="fas fa-comments"></i> Chat with Philadelphia</a></li>
  </ul>

  <div class="user-mini">
    <div>
      <div style="font-size:0.75rem; color:var(--text-muted); text-transform:uppercase;">Logged in as</div>
      <div id="user-email" style="font-size:0.85rem; font-weight:600; color:#fff; overflow:hidden; text-overflow:ellipsis; max-width:160px;">...</div>
    </div>
    <button class="logout-btn" onclick="logout()" title="Sign Out"><i class="fas fa-power-off"></i></button>
  </div>
</nav>

<!-- MAIN CONTENT -->
<main class="main-content">
  
  <div class="top-bar">
    <div class="page-title">
      <h2>Developer Console</h2>
      <p>Manage your API keys, credits, and integrations.</p>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
      <span style="width:10px; height:10px; background:var(--success); border-radius:50%; box-shadow:0 0 10px var(--success);"></span>
      <span style="font-size:0.9rem; color:var(--text-muted);">System Operational</span>
    </div>
  </div>

  <!-- ADMIN SECTION (Hidden by default) -->
  <div class="glass-card" id="admin-panel">
    <div class="admin-header"><i class="fas fa-user-shield fa-2x"></i> <h3>Administrator Command Center</h3></div>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
      <div>
        <label style="color:var(--secondary); font-size:0.8rem; display:block; margin-bottom:5px;">Self Maintenance</label>
        <button class="btn btn-glass" style="width:100%; border-color:var(--secondary); color:var(--secondary);" onclick="adminGrantSelf()"><i class="fas fa-bolt"></i> Grant 100k Credits</button>
      </div>
      <div>
        <label style="color:var(--secondary); font-size:0.8rem; display:block; margin-bottom:5px;">Gift User</label>
        <div style="display:flex; gap:10px;">
          <input type="email" id="gift-email" placeholder="User Email" style="background:rgba(0,0,0,0.3); border:1px solid var(--secondary); color:#fff; padding:10px; border-radius:6px; width:60%;">
          <input type="number" id="gift-amount" placeholder="Amt" style="background:rgba(0,0,0,0.3); border:1px solid var(--secondary); color:#fff; padding:10px; border-radius:6px; width:40%;">
        </div>
        <button class="btn btn-glass" style="width:100%; margin-top:10px; border-color:var(--secondary);" onclick="adminGift()">Send Gift</button>
      </div>
    </div>
  </div>

  <div class="stats-grid">
    <!-- BALANCE CARD -->
    <div class="glass-card balance-card">
      <div class="balance-title">Available Credits</div>
      <div class="balance-val" id="balance-display">---</div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="openModal('payment-modal')"><i class="fas fa-plus"></i> Fund Wallet</button>
        <button class="btn btn-glass" onclick="openModal('transfer-modal')"><i class="fas fa-paper-plane"></i> Transfer</button>
      </div>
      <!-- Verification Overlay -->
      <div id="verify-overlay">
        <div style="text-align:center;">
          <div class="loader" style="display:inline-block; border-color:rgba(0,243,255,0.3); border-top-color:var(--primary); width:40px; height:40px;"></div>
          <div class="pulse-text" style="margin-top:10px;">Verifying Payment...</div>
        </div>
      </div>
    </div>

    <!-- METRICS CARD -->
    <div class="glass-card">
      <div class="balance-title" style="color:var(--primary);"><i class="fas fa-server"></i> API Usage</div>
      <div style="display:flex; justify-content:space-between; margin-top:20px;">
        <div>
          <div style="font-size:2rem; font-weight:700;" id="active-keys-display">0</div>
          <div style="color:var(--text-muted); font-size:0.8rem;">Active Keys</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:2rem; font-weight:700;" id="total-calls-display">0</div>
          <div style="color:var(--text-muted); font-size:0.8rem;">Total Requests</div>
        </div>
      </div>
      <div style="margin-top:20px;">
        <button class="btn btn-glass" style="width:100%;" id="gen-key-btn" onclick="generateKey()"><span><i class="fas fa-key"></i> Generate New Key</span><div class="loader"></div></button>
        <div style="text-align:center; margin-top:8px; font-size:0.75rem; color:var(--text-muted);">Cost: 100 Credits / Key</div>
      </div>
    </div>
  </div>

  <div style="display:grid; grid-template-columns: 1fr; gap: 30px; margin-top:40px;">
    
    <!-- API KEYS SECTION -->
    <div class="glass-card">
      <h3 style="margin:0; font-family:'Rajdhani'; color:var(--primary);"><i class="fas fa-fingerprint"></i> API Keys Management</h3>
      <table class="table-container">
        <thead>
          <tr>
            <th>Key Identifier</th>
            <th>Created Date</th>
            <th style="text-align:right;">Action</th>
          </tr>
        </thead>
        <tbody id="key-list">
          <tr><td colspan="3" style="text-align:center; padding:30px; color:var(--text-muted);">Loading keys...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- HISTORY SECTION -->
    <div class="glass-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; font-family:'Rajdhani'; color:#fff;"><i class="fas fa-history"></i> Transaction History</h3>
        <button class="btn-glass" style="padding:5px 10px;" onclick="loadData()"><i class="fas fa-sync-alt"></i></button>
      </div>
      <table class="table-container">
        <thead>
          <tr>
            <th>Activity</th>
            <th>Details / Source</th>
            <th style="text-align:right;">Amount</th>
            <th style="text-align:right;">Date</th>
          </tr>
        </thead>
        <tbody id="usage-list">
          <tr><td colspan="4" style="text-align:center; padding:30px; color:var(--text-muted);">Loading history...</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- MODAL: FUND WALLET -->
<div id="payment-modal" class="modal-backdrop">
  <div class="modal-content">
    <button style="position:absolute; top:15px; right:15px; background:none; border:none; color:#fff; cursor:pointer;" onclick="closeModal('payment-modal')"><i class="fas fa-times fa-lg"></i></button>
    <div style="text-align:center; margin-bottom:20px;">
      <i class="fas fa-wallet fa-3x" style="color:var(--primary); text-shadow:var(--glow-blue);"></i>
      <h3 style="margin:10px 0 0; font-family:'Rajdhani';">Fund Your Wallet</h3>
    </div>
    <div class="input-group">
      <label>Amount (NGN)</label>
      <input type="number" id="pay-amount" value="1000" min="100">
    </div>
    <div style="margin-top:20px;">
      <button class="btn btn-primary" style="width:100%;" id="pay-btn" onclick="initiatePayment()"><span>Proceed to Payment</span><div class="loader"></div></button>
    </div>
  </div>
</div>

<!-- MODAL: TRANSFER -->
<div id="transfer-modal" class="modal-backdrop">
  <div class="modal-content">
    <button style="position:absolute; top:15px; right:15px; background:none; border:none; color:#fff; cursor:pointer;" onclick="closeModal('transfer-modal')"><i class="fas fa-times fa-lg"></i></button>
    <div style="text-align:center; margin-bottom:20px;">
      <i class="fas fa-paper-plane fa-3x" style="color:var(--success);"></i>
      <h3 style="margin:10px 0 0; font-family:'Rajdhani';">Send Credits</h3>
    </div>
    <div class="input-group" style="margin-bottom:15px;">
      <label>Receiver Email</label>
      <input type="email" id="trans-email" placeholder="friend@elvionai.com">
    </div>
    <div class="input-group">
      <label>Amount</label>
      <input type="number" id="trans-amount" placeholder="500">
    </div>
    <div style="margin-top:20px;">
      <button class="btn btn-primary" style="width:100%; background:var(--success); box-shadow:0 0 20px rgba(0,255,157,0.3);" id="trans-btn" onclick="transferCredits()"><span>Send Credits</span><div class="loader"></div></button>
    </div>
  </div>
</div>

<!-- MODAL: NEW KEY -->
<div id="key-modal" class="modal-backdrop">
  <div class="modal-content" style="text-align:center;">
    <button style="position:absolute; top:15px; right:15px; background:none; border:none; color:#fff; cursor:pointer;" onclick="closeModal('key-modal')"><i class="fas fa-times fa-lg"></i></button>
    <i class="fas fa-check-circle fa-4x" style="color:var(--success); margin-bottom:15px;"></i>
    <h3 style="font-family:'Rajdhani';">Key Generated Successfully!</h3>
    <p style="color:var(--text-muted); font-size:0.9rem;">Keep this key safe. It allows access to your quota.</p>
    
    <div id="new-key" style="background:rgba(0,0,0,0.5); border:1px dashed var(--primary); padding:15px; border-radius:8px; font-family:'Courier New'; color:var(--primary); margin:20px 0; word-break:break-all;">
      elv_sec_xxxxxxxxxxxx
    </div>
    
    <button class="btn btn-glass" style="width:100%;" onclick="copyKey()"><i class="fas fa-copy"></i> Copy to Clipboard</button>
  </div>
</div>

<script type="module">
  const API_URL = "https://web-production-9a18.up.railway.app";
  const ADMIN_EMAIL = "koladhino@gmail.com";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  });

  const auth = getAuth(app);
  let token = null;

  // --- UI HELPERS ---
  window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
  window.logout = () => signOut(auth);
  window.openModal = (id) => document.getElementById(id).style.display = 'flex';
  window.closeModal = (id) => document.getElementById(id).style.display = 'none';
  
  window.copyKey = () => {
    navigator.clipboard.writeText(document.getElementById('new-key').innerText);
    showToast('Key copied to clipboard!', 'success');
    closeModal('key-modal');
  };

  // --- TOAST SYSTEM ---
  function showToast(msg, type='info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon = 'info-circle';
    if(type === 'success') icon = 'check-circle';
    if(type === 'error') icon = 'exclamation-triangle';
    
    toast.innerHTML = `<i class="fas fa-${icon} toast-icon"></i> <span>${msg}</span>`;
    container.appendChild(toast);
    
    // Play sound for success
    if(type === 'success') {
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
        audio.volume = 0.2;
        audio.play().catch(e=>{});
    }

    setTimeout(() => {
        toast.style.transform = 'translateX(120%)';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // --- AUTH STATE ---
  onIdTokenChanged(auth, async (user) => {
    if (user) {
      token = await user.getIdToken(true);
      document.getElementById('user-email').innerText = user.email;
      
      if(user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
        document.getElementById('admin-panel').style.display = 'block';
      }
      
      await loadData();
      
      // CHECK PAYMENT URL PARAMETERS
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('reference') || params.get('trxref');
      if(ref) {
          window.history.replaceState({}, document.title, window.location.pathname);
          startVerificationLoop(ref);
      }
    } else {
      window.location.href = 'developer-login.html'; // Assuming you have this
    }
  });

  // --- API WRAPPER ---
  async function req(endpoint, method='GET', body=null) {
    try {
        const opts = { method, headers: { 'Content-Type': 'application/json', 'X-Firebase-Token': token } };
        if(body) opts.body = JSON.stringify(body);
        const res = await fetch(`${API_URL}${endpoint}`, opts);
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || 'Request failed');
        return data;
    } catch(e) {
        showToast(e.message, 'error');
        throw e;
    }
  }

  // --- DATA LOADING ---
  window.loadData = async () => {
    try {
        // 1. Balance & Keys
        const d = await req('/api/user/keys-and-balance');
        
        // Animate Balance Number
        const balanceEl = document.getElementById('balance-display');
        const currentBal = parseInt(balanceEl.innerText.replace(/,/g, '') || 0);
        const targetBal = d.balance;
        animateValue(balanceEl, isNaN(currentBal) ? 0 : currentBal, targetBal, 1000);
        
        document.getElementById('active-keys-display').innerText = d.keys.filter(k=>k.is_active).length;

        // Render Keys Table
        const kList = document.getElementById('key-list');
        kList.innerHTML = d.keys.map(k => `
            <tr style="opacity:${k.is_active?1:0.5}">
                <td><span class="key-display"><i class="fas fa-key"></i> ...${k.api_key.slice(-8)}</span></td>
                <td>${k.created_at.split('T')[0]}</td>
                <td style="text-align:right;">
                    ${k.is_active 
                      ? `<button class="btn-danger-soft" onclick="revoke('${k.api_key}')"><i class="fas fa-trash-alt"></i> Delete/Revoke</button>` 
                      : '<span style="color:var(--fire); font-size:0.8rem;">INACTIVE</span>'}
                </td>
            </tr>
        `).join('') || '<tr><td colspan="3" style="text-align:center; padding:30px;">No keys found</td></tr>';

        // 2. History
        const h = await req('/api/user/usage-history');
        document.getElementById('total-calls-display').innerText = h.logs.length;
        
        const hList = document.getElementById('usage-list');
        hList.innerHTML = h.logs.map(l => {
            let icon = 'code';
            let color = 'var(--text-muted)';
            let sign = '-';
            let detail = 'Usage';

            // Smart Parsing for "Who sent it"
            if (l.type === 'funding') { 
                icon = 'bolt'; color = 'var(--success)'; sign = '+'; detail = 'Wallet Funding';
            } else if (l.type === 'gift') {
                icon = 'gift'; color = 'var(--secondary)'; sign = '+'; 
                // Try to extract sender from description
                detail = l.endpoint || "Gift Received"; 
            } else if (l.endpoint.includes('Transfer')) {
                 detail = l.endpoint; // Shows "Transfer to email..."
            } else {
                 detail = l.endpoint; // Default endpoint usage
            }

            return `
            <tr>
                <td><i class="fas fa-${icon}" style="color:${color}; width:20px;"></i> ${l.type.toUpperCase()}</td>
                <td style="color:#ccc;">${detail}</td>
                <td style="text-align:right; font-family:'Rajdhani'; font-weight:700; color:${color};">${sign} ${l.cost}</td>
                <td style="text-align:right; font-size:0.8rem; color:#666;">${new Date(l.timestamp).toLocaleDateString()} ${new Date(l.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            </tr>`;
        }).join('') || '<tr><td colspan="4" style="text-align:center; padding:30px;">No history records found</td></tr>';

    } catch(e) { console.error(e); }
  };

  // --- ACTIONS ---
  window.initiatePayment = async () => {
      const btn = document.getElementById('pay-btn');
      btn.classList.add('loading');
      try {
          const amt = document.getElementById('pay-amount').value;
          const res = await req('/api/payments/initiate', 'POST', { amount: parseInt(amt) });
          window.location.href = res.checkout_url;
      } catch(e) { btn.classList.remove('loading'); }
  };

  window.generateKey = async () => {
      const btn = document.getElementById('gen-key-btn');
      btn.classList.add('loading');
      try {
          const res = await req('/api/user/create-api-key', 'POST');
          document.getElementById('new-key').innerText = res.api_key;
          openModal('key-modal');
          loadData();
      } catch(e) {} finally { btn.classList.remove('loading'); }
  };

  window.transferCredits = async () => {
      const btn = document.getElementById('trans-btn');
      btn.classList.add('loading');
      try {
          const email = document.getElementById('trans-email').value;
          const amt = document.getElementById('trans-amount').value;
          const res = await req('/api/user/transfer-credits', 'POST', { receiver_email: email, amount: parseInt(amt) });
          showToast(res.message, 'success');
          closeModal('transfer-modal');
          loadData();
      } catch(e) {} finally { btn.classList.remove('loading'); }
  };

  window.revoke = async (key) => { 
      if(confirm('Are you sure you want to delete/revoke this key? Access will stop immediately.')) {
          try { 
              await req('/api/user/revoke-api-key', 'POST', { api_key: key }); 
              showToast('Key successfully revoked.', 'success');
              loadData(); 
          } catch(e){} 
      }
  };

  // Admin Actions
  window.adminGrantSelf = async () => { try { await req('/api/admin/grant-credits', 'POST'); loadData(); showToast('Power overwhelming! Credits granted.', 'success'); } catch(e){} };
  window.adminGift = async () => { try { await req('/api/admin/gift-credits', 'POST', { target_email: document.getElementById('gift-email').value, amount: parseInt(document.getElementById('gift-amount').value) }); showToast('Gift sent successfully.', 'success'); } catch(e){} };

  // --- ANIMATION & UTILS ---
  function animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
      if (progress < 1) { window.requestAnimationFrame(step); }
    };
    window.requestAnimationFrame(step);
  }

  // --- PAYMENT VERIFICATION ---
  async function startVerificationLoop(ref) {
      document.getElementById('verify-overlay').style.display = 'flex';
      
      for(let i=0; i<20; i++) { // Loop for 60 seconds
          try {
              const res = await req(`/api/payments/verify?transaction_ref=${ref}`);
              if(res.status === 'success' || res.status === 'already_credited') {
                  document.getElementById('verify-overlay').style.display = 'none';
                  triggerConfetti(); // FIREWORKS!
                  showToast(`Payment Verified! +${res.credits_added} Credits`, 'success');
                  loadData();
                  return;
              } else if (res.status === 'failed') {
                  document.getElementById('verify-overlay').style.display = 'none';
                  showToast('Payment Failed.', 'error');
                  return;
              }
          } catch(e) {}
          await new Promise(r => setTimeout(r, 3000));
      }
      document.getElementById('verify-overlay').style.display = 'none';
      showToast('Verification timed out. Please check history.', 'error');
  }

  function triggerConfetti() {
      var duration = 3 * 1000;
      var animationEnd = Date.now() + duration;
      var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

      function randomInOut(min, max) { return Math.random() * (max - min) + min; }

      var interval = setInterval(function() {
        var timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        var particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.7, 0.9), y: Math.random() - 0.2 } }));
      }, 250);
  }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
