<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Philadelphia AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Brand Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- Highlight.js (blue-themed) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.hljs) hljs.configure({ignoreUnescapedHTML:true});
    });
  </script>
  <style>
:root {
  --cyan:#00ffff; --blue:#0090ff; --bg:#141827; --card:#1c2232; --radius:20px;
  --muted:#bbfcff; --text:#e8faff; --glow:#00fff0; --border:#00fff255;
}
html, body {
  margin:0; padding:0; width:100vw; height:100vh;
  font-family:'Roboto','Inter',sans-serif;
  background: radial-gradient(ellipse 67% 80% at 60% 50%, #161b2b 75%, #001524 100%);
  color:var(--text); overflow:hidden;
}
body { min-height:100dvh;}

#stars-container{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:0;pointer-events:none;}
.star{position:absolute;background:rgba(255,255,255,.74);border-radius:50%;opacity:0;animation:twinkle 4.7s infinite linear;}
@keyframes twinkle{0%,100%{opacity:.12;}54%{opacity:.93;}}

.card-center {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:5;
}
.brand-glow {
  font-family:'Orbitron',sans-serif;
  font-size:1.25em;font-weight:700;letter-spacing:.38px;text-align:center;margin:3.1vh 0 1.1vh 0;
  background:linear-gradient(90deg,#00ffff 30%,#fff 60%,#0090ff 100%);
  background-size:200% auto;
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  animation:shine 4s linear infinite;
  text-shadow:0 0 21px #00fff142,0 0 2px #00fff095;
}
@keyframes shine{to{background-position:200% center;}}

#main-wave {
  margin:5vh 0 3.5vh 0;
  width:90px;height:80px;background:transparent;
  display:flex; align-items:center; justify-content:center;
  animation:pulse-glow 2.7s infinite;
}
@keyframes pulse-glow {
  0% { filter:drop-shadow(0 0 0px #00fff077); }
  50% { filter:drop-shadow(0 0 35px #00fff0cc);}
  100% { filter:drop-shadow(0 0 0px #00fff077);}
}
.wave-svg{
  width:70px;height:60px;stroke:#00ffff;opacity:.39; animation:wave-bounce 2.8s infinite;
}
@keyframes wave-bounce{
  0%{transform:translateY(0);}
  25%{transform:translateY(8px);}
  50%{transform:translateY(0);}
  75%{transform:translateY(-8px);}
  100%{transform:translateY(0);}
}

input,textarea{font-family:inherit;}
/* Prompt Bar */
.prompt-row{
  width:98vw;max-width:560px;display:flex;align-items:flex-end;
  gap:5px;background:rgba(28,34,50,0.98);border-radius:16px;
  box-shadow:0 2.3px 26px #00fff215;margin:0 auto 1.1vh auto;
  padding:11px 9px;border:1.6px solid var(--border);position:relative;
}

/* Controls Row */
.controls-row{
  display:flex;gap:13px;margin:0 0 10px 0;justify-content:center;align-items:center;
}
.action-btn, .plus-btn, .agent-btn {
  display:flex;align-items:center;gap:6px;border:none;outline:none;cursor:pointer;
  font-size:1.09em;font-weight:700;background:none;
  border-radius:13px;transition:background .16s,color .15s;
  padding:7px 21px;margin:0 2px;
}
.action-btn.selected, .action-btn:hover, .agent-btn.selected, .agent-btn:hover{
  background:linear-gradient(87deg,#00ffffC1,#0090ffB9 90%);
  color:#10121f !important;box-shadow:0 0 12px #00fff233;
}
.plus-btn{font-size:1.37em;padding:0 17px;}
.agent-btn{
  background:linear-gradient(90deg,#161f29,#31394f 80%);
  color:#00ffff;width:auto;min-width:100px;display:flex;align-items:center;gap:9px;margin-left:4px;
  border-radius:23px;font-weight:700;font-size:1.13em;padding:8px 19px;
  border:1.6px solid #00ffff55;box-shadow:0 1px 17px #00fff227;transition:.15s;}
.agent-btn i{font-size:1.32em;color:#0ef;margin-right:3px;}
/* Input area */
.emoji-btn{
  background:none;border:none;font-size:1.26em;padding:4px 5px 2px 2px;cursor:pointer;color:#00fcffc9;
  border-radius:9px;transition:.12s;
}
.emoji-btn:hover{background:rgba(0,255,255,.09);}
.prompt-inp{
  flex:1;min-height:46px;padding:9px 13px;border-radius:11px;border:none;
  background:rgba(16,21,34,.96);color:#e0f8ff;font-size:1.09em;resize:none;
  outline:none;box-shadow:none;transition:.12s;
}
.prompt-inp:focus{outline:1.3px solid #00ffff;}
.send-btn{
  background:linear-gradient(90deg,#00ffff 45%,#0090ff 100%);
  border:none;border-radius:32px;width:38px;height:38px;
  color:#141d28;font-size:1.3em;display:flex;align-items:center;justify-content:center;
  box-shadow:0 2.3px 8px #00fff218;margin-left:1px;
  transition:.17s;
}
.send-btn:hover{background:#0090ff;color:#fff;}
/* Ai message controls */
.ai-msg-controls{
  display:flex;gap:13px;justify-content:end;margin-top:7px;
}
.msg-btn{
  background:none;border:none;outline:none;cursor:pointer;font-size:1.19em;
  color:#00ffffd4;border-radius:11px;padding:6px 8px;transition:background .16s;
}
.msg-btn:hover{background:rgba(0,255,255,0.15);color:#0090ff;}
/* Panels (side modals) */
.panel-bg{display:none;position:fixed;z-index:2000;inset:0;background:rgba(0,0,0,0.6);}
.panel-bg.active{display:flex;}
.side-panel {
  background:var(--card);width:96vw;max-width:335px; height:100vh;
  box-shadow:-2px 0 27px #00ffffbf; display:flex;flex-direction:column;
  transition:transform .17s; overflow-y:auto;
  transform:translateX(390px); position:fixed;top:0;left:0;z-index:4000;
}
.side-panel.active{transform:translateX(0);}
.side-panel.right{left:auto;right:0;transform:translateX(-390px);}
.side-panel.right.active{transform:translateX(0);}
.panel-header{display:flex;align-items:center;padding:24px 0 10px;}
.panel-header img{width:51px;height:51px;border-radius:55%;object-fit:cover;box-shadow:0 0 9px #00fff066;}
.panel-header .username{font-weight:800;font-size:1.22em;color:var(--cyan);}
.panel-header .email{font-size:0.97em;color:var(--muted);}
.edit-form{display:flex;flex-direction:column;gap:10px;width:94%;}
.edit-form label{color:#00ffff;font-size:0.96em;margin-bottom:1px;margin-top:8px;}
.edit-form input{border:none;border-bottom:2px solid #23233a;background:#181d2c;color:#eee;font-size:.99em;padding:8px 4px 7px 9px;margin-bottom:3px;border-radius:8px;}
.edit-form input:focus{border-color:#00ffff;}
.profile-photo-tip{color:#b3b3b3;font-size:.92em;margin-bottom:4px;margin-top:8px;}
.panel-links{display:flex;flex-direction:column;gap:6px;margin:16px 0 14px 0;align-items:flex-start;}
.panel-links a{color:var(--text);text-decoration:none;font-weight:700;font-size:1.10em;padding:8px 15px 8px 13px;border-radius:0 11px 11px 0;transition:background .14s;}
.panel-links a:hover{background:var(--cyan);color:#23233a;}
.panel-titlebar{width:100%;display:flex;align-items:center;justify-content:space-between;}
.panel-title{font-size:1.26em;font-weight:700;color:#00fff0;padding:9px 7px 9px 12px;}
.panel-close-btn{border:none;background:none;font-size:1.7em;color:#ff4444;cursor:pointer;}

/* Chat area and Highlight.js code styling */
.chat-box { box-sizing:border-box;padding-bottom:10px;}
.chat-box pre code { font-size:1.01em !important;background:#161d2c !important;}

@media(max-width:690px){
  .card-center, .side-panel, .side-panel.right{max-width:100vw;width:100vw;}
  .prompt-row{max-width:99vw;}
  .side-panel{max-width:100vw;}
  .side-panel.right{max-width:100vw;}
}
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <!-- Main Center Chat/Card -->
  <div class="card-center" id="mainContainer">
    <div class="brand-glow" id="brandGreeting">Philadelphia AI</div>
    <div id="main-wave">
      <svg class="wave-svg" viewBox="0 0 64 54" fill="none" stroke-width="5" stroke-linecap="round"><path d="M5 27 Q18 9 22 27 Q27 45 32 27 Q37 9 41 27 Q46 45 59 27"/></svg>
    </div>
    <div id="welcomePrompt" style="margin-bottom:7vh;text-align:center;font-size:1.27em;color:#b5bdff;font-weight:600;letter-spacing:.04em;">How can I help you today?</div>

    <!-- Controls row (Search/Think/Agent) -->
    <div class="controls-row">
      <button class="action-btn" id="searchBtn"><i class="fa-solid fa-globe"></i>Search</button>
      <button class="action-btn" id="thinkBtn"><i class="fa-solid fa-bolt"></i>Think</button>
      <button class="plus-btn" id="plusBtn">+</button>
      <button class="agent-btn" id="agentBtn"><i class="fa-brands fa-connectdevelop"></i>Agent</button>
    </div>

    <!-- Chat area (scrollable) -->
    <div class="chat-box" id="chatBox" style="height:41vh;min-height:220px;max-height:41vh;width:97.5%;margin:11px 0 7px 0;padding-bottom:8px;overflow-y:auto;border-radius:11px;background:rgba(16,21,34,0.64);"></div>

    <!-- Prompt and input row -->
    <form class="prompt-row" id="chatForm" autocomplete="off">
      <button class="emoji-btn" id="emojiBtn" type="button" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
      <!-- Space for dynamic controls -->
      <textarea id="chatInput" class="prompt-inp" placeholder="Type here‚Ä¶"></textarea>
      <button type="submit" id="sendBtn" class="send-btn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
    </form>
    <div style="color:var(--muted);font-size:0.97em;margin:0 auto 5px auto;">Terms of Service &nbsp;¬∑&nbsp; Privacy Policy</div>
  </div>

  <!-- Profile Modal (left) -->
  <div class="panel-bg" id="profileMenuBg">
    <nav class="side-panel" id="profileMenu">
      <div class="panel-titlebar">
        <span class="panel-title">Profile & Chats</span>
        <button class="panel-close-btn" id="closeProfilePanel">&times;</button>
      </div>
      <div class="panel-header">
        <img id="profilePicPreview" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile photo">
        <div>
          <div class="username" id="profileMenuUser">User Name</div>
          <div class="email" id="profileMenuEmail">email@email.com</div>
        </div>
      </div>
      <form class="edit-form" id="profileForm" autocomplete="off">
        <label for="edit-name">Name</label>
        <input type="text" id="edit-name" required>
        <label for="edit-photo">Photo URL</label>
        <input type="url" id="edit-photo" placeholder="Image link">
        <div class="profile-photo-tip">
          <a href="https://postimg.cc/" target="_blank" style="color:#00ffff;">Upload photo</a> and paste the link.
        </div>
        <button type="submit" class="submit-btn">Save</button>
        <div class="status-message" id="profileStatusMsg"></div>
      </form>
      <hr style="width:95%;border:0.5px solid #00fff043;margin:24px 0 12px 0;">
      <div style="font-size:.97em;color:#0ff;font-weight:600;margin-left:13px;margin-bottom:5px;">Chats</div>
      <div id="chatsList" style="max-height:180px;overflow-y:auto;margin-bottom:14px;"></div>
      <button id="newChatBtn" class="action-btn" style="margin:0 0 18px 8px;"><i class="fa-solid fa-plus"></i> New Chat</button>
      <button class="action-btn" id="logoutBtn" style="background:#19192a;color:#00ffff;width:93%;">Logout</button>
    </nav>
  </div>

  <!-- Info/Links Modal (right) -->
  <div class="panel-bg" id="linkMenuBg">
    <nav class="side-panel right" id="linkMenu">
      <div class="panel-titlebar">
        <span class="panel-title">Menu</span>
        <button class="panel-close-btn" id="closeLinkPanel">&times;</button>
      </div>
      <div class="panel-header">
        <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Logo">
        <div><div class="username">Philadelphia AI</div></div>
      </div>
      <div class="panel-links">
        <a href="index.html"><i class="fa-solid fa-home"></i> Home</a>
        <a href="about.html"><i class="fa-solid fa-circle-info"></i> About</a>
        <a href="privacy.html"><i class="fa-solid fa-shield-halved"></i> Privacy Policy</a>
        <a href="terms.html"><i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank"><i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </nav>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

window.addEventListener('DOMContentLoaded', () => {
  // ------- DOM Shortcuts -------
  const $ = id => document.getElementById(id);

  /* ========== Glowing Stars ========== */
  const starsContainer = $('stars-container');
  if (starsContainer) {
    for (let i = 0; i < 38; i++) {
      const s = document.createElement('div');
      s.className = 'star';
      const z = Math.random() * 2.1 + 1;
      s.style.width = z + 'px';
      s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%';
      s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.7) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.35) + 's';
      starsContainer.appendChild(s);
    }
  }

  /* ========== Fullscreen ========== */
  const fullscreenBtn = $('fullscreenBtn'), mainContainer = $('mainContainer');
  if (fullscreenBtn && mainContainer) {
    let isFull = false;
    fullscreenBtn.onclick = () => {
      isFull = !isFull;
      mainContainer.classList.toggle('fullscreen', isFull);
      fullscreenBtn.innerHTML = isFull ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>';
    }
  }

  /* ========== Side Panels/Modals ========== */
  $('openProfileMenu')?.addEventListener('click', () => {
    $('profileMenuBg').classList.add('active');
    setTimeout(()=>$('profileMenu').classList.add('active'),10);
  });
  $('openLinksMenu')?.addEventListener('click', () => {
    $('linkMenuBg').classList.add('active');
    setTimeout(()=>$('linkMenu').classList.add('active'),10);
  });
  $('closeProfilePanel')?.addEventListener('click', () => {
    $('profileMenu').classList.remove('active');
    setTimeout(()=>$('profileMenuBg').classList.remove('active'),120);
  });
  $('profileMenuBg')?.addEventListener('click', e=>{if(e.target===$('profileMenuBg'))$('closeProfilePanel').click();});
  $('closeLinkPanel')?.addEventListener('click', () => {
    $('linkMenu').classList.remove('active');
    setTimeout(()=>$('linkMenuBg').classList.remove('active'),120);
  });
  $('linkMenuBg')?.addEventListener('click', e=>{if(e.target===$('linkMenuBg'))$('closeLinkPanel').click();});
  $('logoutBtn')?.addEventListener('click', () => window.location.href="signup-login.html");

  /* ========== Profile / Auth ========== */
  let currentUser = null;
  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href = "signup-login.html"; return; }
    currentUser = user;
    $('brandGreeting').textContent = "Philadelphia AI";
    $('welcomePrompt').innerHTML = `<span style="color:#0ff;font-size:0.96em;">üôÇ</span> How can I help you today, <b>${user.displayName||user.email.split('@')[0]}</b>?`;
    $('profileMenuUser').textContent = user.displayName||"User";
    $('profileMenuEmail').textContent = user.email;
    $('edit-name').value = user.displayName || "";
    $('edit-photo').value = user.photoURL || "";
    $('profilePicPreview').src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
    renderChatsList();
    renderChatBox(chats[currentChatIdx]?.history||[]);
  });
  $('edit-photo')?.addEventListener('input', function () {
    $('profilePicPreview').src = this.value || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
  });
  $('profileForm')?.addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!currentUser) return;
    try {
      await updateProfile(currentUser, {
        displayName: $('edit-name').value.trim(),
        photoURL: $('edit-photo').value.trim()
      });
      await auth.currentUser.reload();
      $('profileStatusMsg').textContent = "Profile updated!";
      setTimeout(() => {
        $('profileMenu').classList.remove('active');
        $('profileMenuBg').classList.remove('active'); 
      }, 700);
      $('brandGreeting').textContent = "Philadelphia AI";
      $('profileMenuUser').textContent = $('edit-name').value.trim() || "User";
      $('profilePicPreview').src = $('edit-photo').value.trim() || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";
    } catch (err) {
      $('profileStatusMsg').textContent = err.message || "Update failed";
    }
  });

  /* ========== Chat State & Management ========== */
  let chats = JSON.parse(localStorage.getItem("elvion_chats")||"[]");
  let currentChatIdx = chats.length-1 >= 0 ? chats.length-1 : 0;
  function saveChats() {localStorage.setItem("elvion_chats", JSON.stringify(chats));}
  function renderChatsList() {
    const chatsList = $('chatsList');
    chatsList.innerHTML = "";
    chats.forEach((chat, i) => {
      let wrap = document.createElement('div');
      wrap.style = "display:flex;align-items:center;gap:7px;margin-bottom:2px;padding:3px 0 3px 2px;background:" + (i===currentChatIdx ? '#00ffff12':'none');
      let title = document.createElement('input');
      title.value = chat.name || `Chat ${i+1}`;
      title.readOnly=true;title.style = "background:none;border:none;font-weight:600;color:#fff;font-size:1em;width:90px;border-radius:5px;padding:3px 6px;";
      let editBtn = document.createElement('button'); editBtn.className="msg-btn"; editBtn.innerHTML="‚úè";
      editBtn.onclick = ()=>{
        title.readOnly=false;title.focus();title.setSelectionRange(title.value.length,title.value.length);
      };
      title.onblur = ()=>{title.readOnly=true};
      title.addEventListener('change',()=>{
        chat.name = title.value.trim()||`Chat ${i+1}`;
        saveChats(); renderChatsList();
      });
      let selBtn = document.createElement("button");
      selBtn.className="msg-btn"; selBtn.innerHTML="‚ñ∂";
      selBtn.onclick = ()=>{ currentChatIdx = i; saveChats(); renderChatsList(); renderChatBox(chats[i]?.history||[]); };
      let delBtn = document.createElement("button");
      delBtn.className="msg-btn"; delBtn.innerHTML="üóëÔ∏è";
      delBtn.onclick = ()=>{
        if (confirm("Delete this chat?")) {
          chats.splice(i,1); if(currentChatIdx>=chats.length) currentChatIdx=chats.length-1;
          saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx]?.history||[]);
        }
      };
      wrap.appendChild(selBtn); wrap.appendChild(title); wrap.appendChild(editBtn); wrap.appendChild(delBtn);
      chatsList.appendChild(wrap);
    });
  }
  $('newChatBtn')?.addEventListener('click',()=> {
    chats.push({name:`Chat ${chats.length+1}`,history:[]});
    currentChatIdx=chats.length-1;saveChats();renderChatsList();renderChatBox([]);
  });

  /* ========== Markdown, Code, Copy/Share/Regenerate ========== */
  const escapeHTML = (str = '') => String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  const codeBlockRegex = /``````/g;
  function renderMarkdown(text = '') {
    // Correct code block: ``````
    text = text.replace(codeBlockRegex, (match, lang, code) => {
      const language = lang || "plaintext";
      const escaped = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      return `<pre><code class="language-${language}">${escaped}</code></pre>`;
    });
    text = text.replace(/`([^`]+?)`/g, (_,a)=>`<code>${escapeHTML(a)}</code>`);
    text = text.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
    text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return text.replace(/\n/g, '<br>');
  }
  function enhanceCodeBlocks(container) {
    if (!container) return;
    container.querySelectorAll('pre code').forEach(codeEl => {
      if (window.hljs) try { hljs.highlightElement(codeEl); } catch (e) {}
    });
    container.querySelectorAll('.copy-btn').forEach(btn => {
      const codeEl = btn.parentNode.querySelector('code');
      if (codeEl) {
        btn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(codeEl.innerText);
            const prev = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = prev, 800);
          } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); }
        };
      }
    });
  }
  function renderChatBox(messages=[]) {
    $('chatBox').innerHTML = "";
    messages.forEach((msg, i) => {
      let bubble = document.createElement('div');
      bubble.className = "chat-message " + (msg.role==="user"?"user":"ai");
      let content = "";
      if (msg.role==="ai") {
        const html = renderMarkdown(msg.text||'');
        content = `<div class="msg">${html}
          <div class="ai-msg-controls">
            <button class="msg-btn copy" title="Copy"><i class="fa-solid fa-copy"></i></button>
            <button class="msg-btn share" title="Share"><i class="fa-solid fa-share-nodes"></i></button>
            <button class="msg-btn regen" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
          </div>
        </div>`;
      } else {
        content = `<div class="msg">${escapeHTML(msg.text||'')}</div>`;
      }
      bubble.innerHTML = content;
      $('chatBox').appendChild(bubble);

      if (msg.role === "ai") {
        const copyBtn = bubble.querySelector('.copy');
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(msg.text.replace(/<\/?[^>]+(>|$)/g,""));
          copyBtn.style.color="#0ff"; setTimeout(()=>copyBtn.style.color="",700);
        };
        const shareBtn = bubble.querySelector('.share');
        shareBtn.onclick = () => {
          const url = window.location.href.split("#")[0];
          const shareText = `ü§ñ Philadelphia AI says:\n\n${msg.text.replace(/<\/?[^>]+(>|$)/g,"")}\n\nTry it: ${url}`;
          if (navigator.share) navigator.share({ title:"Philadelphia AI", text:shareText, url });
          else prompt("Copy to share:", shareText);
        };
        const regenBtn = bubble.querySelector('.regen');
        regenBtn.onclick = async () => {
          showTypingAtNext();
          let prompt = chats[currentChatIdx]?.history?.[i-1]?.text || '';
          let res = await fetch('https://web-production-9a18.up.railway.app/chat', {
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({message:prompt, user_id:"regenerate", history:[]})
          });
          let data = await res.json();
          removeTyping();
          if (data && data.response) {
            chats[currentChatIdx].history.push({ role:'ai', text:data.response });
            saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx]?.history||[]);
          }
        };
      }
    });
    enhanceCodeBlocks($('chatBox'));
    $('chatBox').scrollTop = $('chatBox').scrollHeight;
  }

  /* ========== Typing Animation ========== */
  let typingNode = null;
  function showTypingAtNext(){
    removeTyping();
    typingNode = document.createElement('div');
    typingNode.className = 'chat-message ai';
    typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`;
    $('chatBox').appendChild(typingNode);
    $('chatBox').scrollTop = $('chatBox').scrollHeight;
  }
  function removeTyping(){if(typingNode && typingNode.parentNode){typingNode.parentNode.removeChild(typingNode);typingNode=null;}}

  /* ========== Emoji Panel ========== */
  let emojiPanel = null;
  $('emojiBtn').addEventListener('click',e=>{
    if(!emojiPanel){
      emojiPanel=document.createElement('div');
      emojiPanel.style.cssText = 'position:absolute;bottom:55px;left:8px;background:#23233a;padding:12px 14px;border-radius:14px;box-shadow:0 2px 11px #00fff244;z-index:9500;display:grid;grid-template-columns:repeat(8,1fr);gap:7px;';
      emojiPanel.tabIndex = -1;
      let emojiSet = ['üòÄ','üòÇ','üòç','ü•≤','üòÖ','ü§î','üôå','üëè','üòé','ü•≥','‚ù§Ô∏è','üî•','üëç','üëÄ','üí°','ü§ñ','üéâ','ü§ó','üòá','üò≥','üß†','üåü','üò∫','üí≠','üò¥','üò±','ü§Ø','üöÄ','üé®','üêæ'];
      emojiSet.forEach(ej=>{
        let btn=document.createElement('button');btn.type='button';btn.className='emoji-btn';btn.innerText=ej;btn.style.fontSize='1.3em';
        btn.onclick=()=>{$('chatInput').value+=[ej];$('chatInput').focus();emojiPanel.style.display='none';}
        emojiPanel.appendChild(btn);
      });
      emojiPanel.addEventListener('blur',()=>{emojiPanel.style.display='none';});
      $('chatForm').appendChild(emojiPanel);
    }
    emojiPanel.style.display = emojiPanel.style.display==='none'?'grid':'grid';
    setTimeout(()=>emojiPanel.focus(),10);
  });

  /* ========== File Preview, Attach/Remove ========== */
  let uploadedFiles = [], uploadData = null;
  const filePreview = document.createElement("div");
  filePreview.className = "file-preview";
  filePreview.style.display = "none";
  $('chatForm').parentNode.insertBefore(filePreview, $('chatForm'));
  function renderFilePreview() {
    if (!uploadedFiles.length) { filePreview.style.display = 'none'; filePreview.innerHTML = ''; return; }
    filePreview.style.display = 'block';
    filePreview.innerHTML = uploadedFiles.map((file, idx) => {
      let icon = file.type.startsWith('image/') ? 'üñºÔ∏è' : (file.type === 'application/pdf' ? 'üìÑ' : file.type.startsWith('audio/') ? 'üéµ' : file.type.startsWith('video/') ? 'üé¨' : 'üìÅ');
      return `<div style="display:flex;align-items:center;gap:10px;border-radius:7px;margin-bottom:2px;">
        <span style="font-size:1.25em;">${icon}</span>
        <span style="color:#aee;font-size:.99em;">${file.name}</span>
        <button type="button" data-idx="${idx}" class="remove-file-btn" style="color:#fff;background:#d23;border:none;border-radius:12px;padding:0 9px;cursor:pointer;font-weight:bold;font-size:1.18em;">&times;</button>
        </div>`;
    }).join("");
    filePreview.querySelectorAll('.remove-file-btn').forEach(btn => {
      btn.onclick = () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        uploadedFiles.splice(idx, 1);
        uploadData = uploadedFiles[0] || null;
        renderFilePreview();
      }
    });
  }
  const chatFile = document.createElement("input");
  chatFile.type = "file";
  chatFile.accept = "application/pdf,image/*,audio/*,video/*";
  chatFile.multiple = true;
  chatFile.style.display = "none";
  $('chatForm').appendChild(chatFile);
  const attachLabel = document.createElement("label");
  attachLabel.htmlFor = chatFile.id = "chatFileJSATTACH";
  attachLabel.title = "Attach File";
  attachLabel.innerHTML='<i class="fa-solid fa-paperclip"></i>';
  $('chatForm').insertBefore(attachLabel, $('chatForm').firstChild);

  attachLabel.onclick = ()=> chatFile.click();
  chatFile.onchange = function(){
    uploadedFiles = Array.from(this.files||[]);
    uploadData = uploadedFiles[0] || null;
    renderFilePreview();
  };

  /* ========== Image, Voice Gen, Voice Input Btns ========== */
  const imageBtn = document.createElement('button');
  imageBtn.type='button'; imageBtn.className='emoji-btn'; imageBtn.title='Generate Image';
  const imageStyles = ["photoreal","ultrarealistic","anime","deepanime","dreamcore"];
  let imageIdx = 0;
  function setImageBtnIcon(idx){ imageBtn.innerHTML=['<i class="fa-solid fa-image"></i>','<i class="fa-brands fa-envira"></i>','<i class="fa-solid fa-palette"></i>','<i class="fa-solid fa-fire"></i>','<i class="fa-solid fa-star"></i>'][idx%5]; }
  setImageBtnIcon(0);
  imageBtn.onclick = ()=>{
    imageIdx=(imageIdx+1)%imageStyles.length;
    setImageBtnIcon(imageIdx);
    $('chatInput').placeholder = `Prompt for ${imageStyles[imageIdx]} AI art...`;
  };
  $('chatForm').insertBefore(imageBtn, $('chatInput'));

  const voiceBtn = document.createElement('button');
  voiceBtn.type="button"; voiceBtn.className='emoji-btn'; voiceBtn.title="Generate Voice";
  voiceBtn.innerHTML='<i class="fa-solid fa-microphone-lines"></i>';
  $('chatForm').insertBefore(voiceBtn, $('chatInput'));

  const voiceInputBtn = document.createElement("button");
  voiceInputBtn.type = "button";
  voiceInputBtn.className = 'emoji-btn';
  voiceInputBtn.title = "Voice Input";
  voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
  $('chatForm').appendChild(voiceInputBtn);
  let recognition=null;
  voiceInputBtn.onclick=function(){
    if('webkitSpeechRecognition'in window){
      recognition=new webkitSpeechRecognition();
      recognition.continuous=false; recognition.interimResults=false; recognition.lang='en-US';
      this.innerHTML='<i class="fa-solid fa-microphone-lines"></i>';
      recognition.onresult=(e)=>{
        $('chatInput').value += ($('chatInput').value ? ' ' : '') + e.results[0][0].transcript;
        this.innerHTML='<i class="fa-solid fa-microphone"></i>';
      };
      recognition.onend=()=>{this.innerHTML='<i class="fa-solid fa-microphone"></i>';};
      recognition.onerror=()=>{this.innerHTML='<i class="fa-solid fa-microphone"></i>';};
      recognition.start();
    } else alert("Speech recognition not supported.");
  };

  /* ========== AI Image Preview Modal ========== */
  let imgPrevBox = document.createElement("div");
  imgPrevBox.id = "ai-image-preview";
  imgPrevBox.style = "display:none;position:fixed;z-index:1210;right:22px;bottom:85px;max-width:350px;background:#191a26e9;padding:12px;border-radius:17px;box-shadow:0 2px 19px #00fff2b8;";
  imgPrevBox.innerHTML = `
    <button id="ai-image-close" style="float:right;background:#23233a;border:none;border-radius:7px;color:#00ffff;font-size:1.5em;cursor:pointer;margin-left:5px;">&times;</button>
    <div id="ai-image-container"></div>
    <button id="ai-image-dl" style="margin-top:9px;padding:7px 20px;background:linear-gradient(90deg,#00ffff,#0090ff);color:#222;border:none;border-radius:8px;box-shadow:0 2px 7px #00fff2c7;cursor:pointer;font-weight:bold;">Download</button>
  `;
  document.body.appendChild(imgPrevBox);
  const imgPrevClose = imgPrevBox.querySelector("#ai-image-close");
  const imgPrevDL = imgPrevBox.querySelector("#ai-image-dl");
  const imgPrevImgBox = imgPrevBox.querySelector("#ai-image-container");
  imgPrevClose.onclick = ()=>{ imgPrevBox.style.display="none"; imgPrevImgBox.innerHTML=""; };
  imgPrevDL.onclick = ()=>{
    const img = imgPrevImgBox.querySelector('img');
    if(img){
      const url = img.src; const a=document.createElement('a');
      a.href=url;a.download='generated_image.png';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
    }
  }
  function showAIImagePreview(srcOrB64, caption=""){
    imgPrevImgBox.innerHTML = `<img src="${srcOrB64.startsWith('data')||srcOrB64.startsWith('blob')?srcOrB64:'data:image/png;base64,'+srcOrB64}" alt="AI image" style="max-width:210px;max-height:210px;border-radius:11px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;">` + (caption?'<div style="color:#aee;font-size:.96em;margin-top:3px;text-align:center;">'+caption+'</div>':'');
    imgPrevBox.style.display="block";
  }

  /* ========== Submit Handler: File, Text, Image, Voice Gen ========== */
  $('chatForm').onsubmit = async function(e){
    e.preventDefault();
    let msgText = $('chatInput').value.trim(), file = uploadData;
    if (!msgText && !file) return;
    if (currentChatIdx < 0 || !chats.length) {
      chats=[{name:"Chat 1",history:[]}];currentChatIdx=0;
    }
    // Image Generation
    if(/^\/imagine\s+|^\/image|^image:/i.test(msgText)){
      let prompt=msgText.replace(/^\/imagine\s+|^\/image\s*\w*\s*|^image:/i, '').trim();
      const fd = new FormData();
      fd.append("prompt", prompt || msgText);
      if(uploadedFiles.length && /^image\//.test(uploadedFiles[0].type))
        fd.append("file", uploadedFiles[0]);
      showTypingAtNext();
      try{
        const res = await fetch('https://web-production-9a18.up.railway.app/imagine', {method:'POST',body:fd});
        if(!res.ok) throw new Error('Image gen failed');
        let blob=await res.blob();
        let url=URL.createObjectURL(blob);
        showAIImagePreview(url,"Your new Philadelphia AI image! (Download or Close)");
        removeTyping();
        chats[currentChatIdx].history.push({role:"user",text:msgText});
        chats[currentChatIdx].history.push({role:"ai",text:'‚úÖ Image generated! (Use the floating image box below to view or download.)'});
        saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx].history);
      }catch(err){
        removeTyping(); chats[currentChatIdx].history.push({role:"ai",text:"‚ùå Image generation failed."});
        saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx].history);
      }
      chatFile.value='';uploadedFiles=[];uploadData=null;renderFilePreview();return;
    }
    // File upload logic (PDF, image, audio, video)
    if(uploadedFiles&&uploadedFiles.length){
      // PDF handler/sample; extend as needed
      const file = uploadedFiles[0];
      if(file.type==='application/pdf'){
        const fd = new FormData();
        fd.append("files",file);
        fd.append("prompt",msgText||"Summarize the PDF");
        showTypingAtNext();
        try{
          let res=await fetch('https://web-production-9a18.up.railway.app/understand-pdf',{method:'POST',body:fd});
          let data = await res.json();
          removeTyping();
          chats[currentChatIdx].history.push({role:"user",text:msgText});
          chats[currentChatIdx].history.push({role:"ai",text:data.response||"‚ùå Could not process PDF."});
          saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx].history);
        }catch(err){
          removeTyping(); chats[currentChatIdx].history.push({role:"ai",text:"‚ùå File error."});
          saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx].history);
        }
        chatFile.value='';uploadedFiles=[];uploadData=null;renderFilePreview();return;
      }
      // Other file types: omit/extend as needed
    }

    chats[currentChatIdx].history.push({role:"user",text:msgText});
    renderChatBox(chats[currentChatIdx].history);
    showTypingAtNext();
    try {
      let res = await fetch('https://web-production-9a18.up.railway.app/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          message:msgText,
          user_id:currentUser?.uid||"user",
          history:chats[currentChatIdx].history.map(m=>({role:m.role,content:m.text}))
        })
      });
      let data = await res.json();
      removeTyping();
      if(data&&data.response){
        chats[currentChatIdx].history.push({role:"ai",text:data.response});
      } else {
        chats[currentChatIdx].history.push({role:"ai",text:"ü§ñ No response."});
      }
      saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx].history);
    } catch (err) {
      removeTyping(); chats[currentChatIdx].history.push({role:"ai",text:"Sorry, bot error: "+err.message});
      saveChats(); renderChatsList(); renderChatBox(chats[currentChatIdx].history);
    }
  };

  /* ========== Voice Generation ========== */
  voiceBtn.onclick = async function () {
    let msgText = $('chatInput').value.trim();
    if (!msgText) { $('chatInput').focus(); return; }
    showTypingAtNext();
    try {
      let fd = new FormData();
      fd.append("text", msgText);
      fd.append("style", "podcast");
      let res = await fetch("https://web-production-9a18.up.railway.app/voicegen", { method: "POST", body: fd });
      if (!res.ok) { removeTyping(); chats[currentChatIdx].history.push({role:"ai",text:"‚ùå Voice generation failed."});saveChats(); renderChatBox(chats[currentChatIdx].history); return;}
      let blob = await res.blob();
      let url = URL.createObjectURL(blob);
      let audioPlayer = `<audio controls src="${url}" style="width:99%;margin:8px 0 3px 0;border-radius:14px;"></audio>`;
      removeTyping();
      chats[currentChatIdx].history.push({
        role: "ai",
        text: `üó£Ô∏è Voice generated:<br>${audioPlayer}`
      });
      saveChats(); renderChatBox(chats[currentChatIdx].history);
    } catch (err) {
      removeTyping();
      chats[currentChatIdx].history.push({role:"ai",text:"‚ùå Voice API/network error"});
      saveChats(); renderChatBox(chats[currentChatIdx].history);
    }
  };

  // Load last chat box on refresh
  renderChatsList();
  renderChatBox(chats[currentChatIdx]?.history||[]);
});
</script>
</body>
</html>
