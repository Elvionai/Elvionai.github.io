<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Elvion AI | Developer Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary: #00ffff;
      --secondary: #ff00ff;
      --bg-dark: #050a14;
      --glass-bg: rgba(16, 24, 45, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --success: #00e676;
      --danger: #ff1744;
      --warning: #ffae42;
    }

    * { box-sizing: border-box; outline: none; }
    
    body { 
      margin: 0; 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg-dark); 
      color: var(--text-main); 
      min-height: 100vh; 
      overflow-x: hidden;
    }

    /* BACKGROUND STARS ANIMATION */
    #stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle var(--duration) linear infinite; opacity: 0; }
    @keyframes twinkle { 0% { opacity: 0; } 50% { opacity: 0.8; } 100% { opacity: 0; } }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* HEADER */
    header { display: flex; justify-content: space-between; align-items: center; padding: 25px 0; margin-bottom: 30px; border-bottom: 1px solid var(--glass-border); }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand img { width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--glass-border); }
    .brand h1 { font-family: 'Orbitron'; font-size: 1.5rem; margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .user-info { display: flex; align-items: center; gap: 15px; background: var(--glass-border); padding: 8px 16px; border-radius: 30px; backdrop-filter: blur(5px); }
    .user-email { font-size: 0.9rem; color: #ccc; }
    .logout-btn { background: none; border: none; color: var(--danger); cursor: pointer; transition: 0.3s; font-size: 1.1rem; }
    .logout-btn:hover { transform: scale(1.1); text-shadow: 0 0 10px var(--danger); }

    /* CARDS */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
    .card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; padding: 25px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); transition: transform 0.2s; }
    .card:hover { border-color: rgba(255, 255, 255, 0.2); }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--primary); margin: 0; display: flex; align-items: center; gap: 10px; }

    /* BALANCE */
    .balance-wrapper { text-align: center; padding: 10px 0; }
    .balance-amount { font-family: 'Orbitron'; font-size: 3rem; font-weight: 700; color: white; margin: 5px 0 20px 0; text-shadow: 0 0 20px rgba(0, 255, 255, 0.3); }

    /* BUTTONS */
    .btn { background: linear-gradient(135deg, var(--primary), #00cccc); color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 800; font-family: 'Inter'; cursor: pointer; transition: all 0.3s; width: 100%; text-transform: uppercase; letter-spacing: 1px; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
    
    .btn-secondary { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid var(--glass-border); font-weight: 600; }
    .btn-secondary:hover { border-color: var(--primary); color: var(--primary); background: rgba(0, 255, 255, 0.05); }
    
    .btn-danger { background: rgba(255, 23, 68, 0.15); color: var(--danger); border: 1px solid var(--danger); padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }

    /* TABLES */
    .table-container { overflow-x: auto; max-height: 400px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; color: #888; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.3); }
    td { padding: 15px; border-bottom: 1px solid var(--glass-border); color: #eee; font-size: 0.9rem; }
    
    .cost-pos { color: var(--success); font-family: 'Orbitron'; }
    .cost-neg { color: var(--danger); font-family: 'Orbitron'; }

    /* MODALS & INPUTS - FIXED */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal { background: #0f1623; border: 1px solid var(--primary); padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; position: relative; box-shadow: 0 0 30px rgba(0, 255, 255, 0.2); }
    
    /* THE INPUT FIX */
    input { 
      background: #ffffff !important; 
      color: #000000 !important; 
      border: 2px solid #ccc; 
      padding: 12px; 
      border-radius: 6px; 
      width: 100%; 
      font-size: 1.1rem; 
      font-weight: 600;
      margin-top: 5px;
      margin-bottom: 15px;
    }
    input:focus { border-color: var(--primary); outline: none; }
    label { color: var(--primary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

    .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }

    /* TOAST */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: #111; border-left: 4px solid var(--primary); padding: 15px 20px; border-radius: 4px; color: white; min-width: 280px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: slideIn 0.3s; display: flex; align-items: center; gap: 10px; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

    .loader { width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: none; margin-left: 10px; }
    .btn.loading .loader { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Responsive */
    @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } header { flex-direction: column; gap: 15px; } }
  </style>
</head>
<body>

<div id="stars"></div>
<div id="toast-container"></div>

<div class="container">
  <!-- Header -->
  <header>
    <div class="brand">
      <img src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Logo">
      <div>
        <h1>Elvion AI</h1>
        <span style="font-size:0.7rem; color:var(--primary); letter-spacing:2px;">DEVELOPER CONSOLE</span>
      </div>
    </div>
    <div class="user-info">
      <i class="fas fa-user-circle" style="color:var(--primary);"></i>
      <span id="user-email">Loading...</span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <div class="dashboard-grid">
    <!-- Wallet -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-wallet"></i> Balance</h3>
        <button class="btn-secondary" onclick="loadData()" style="padding:5px 10px; width:auto;"><i class="fas fa-sync"></i></button>
      </div>
      <div class="balance-wrapper">
        <div class="balance-amount"><span id="balance-display">---</span> <span style="font-size:1rem; color:#888;">Cr</span></div>
      </div>
      <button class="btn" onclick="openModal('payment-modal')"><i class="fas fa-bolt"></i> Fund Wallet</button>
      
      <!-- Verification Status Box -->
      <div id="verify-box" style="display:none; margin-top:15px; background:rgba(255, 174, 66, 0.1); padding:10px; border-radius:8px; border:1px solid var(--warning); text-align:center;">
        <p style="color:var(--warning); font-size:0.85rem; margin:0 0 5px 0;"><i class="fas fa-spinner fa-spin"></i> Verifying Transaction...</p>
        <div style="font-size:0.75rem; color:#aaa;">Please wait, syncing with bank.</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-rocket"></i> Actions</h3></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <button class="btn-secondary" onclick="openModal('transfer-modal')"><i class="fas fa-paper-plane"></i> Transfer</button>
        <button class="btn-secondary" id="gen-key-btn" onclick="generateKey()"><span><i class="fas fa-key"></i> New Key</span><div class="loader"></div></button>
      </div>
      <p style="text-align:center; color:#666; font-size:0.8rem; margin-top:20px;">API Key Cost: <strong>100 Credits</strong></p>
    </div>

    <!-- Stats -->
    <div class="card">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-chart-line"></i> Overview</h3></div>
      <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <div>
          <div style="color:#888; font-size:0.8rem;">Active Keys</div>
          <div style="font-family:'Orbitron'; font-size:1.8rem;" id="active-keys-display">0</div>
        </div>
        <div>
          <div style="color:#888; font-size:0.8rem;">Total Calls</div>
          <div style="font-family:'Orbitron'; font-size:1.8rem;" id="total-calls-display">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- History Table -->
  <div class="card">
    <div class="card-header"><h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3></div>
    <div class="table-container">
      <table>
        <thead><tr><th>Action</th><th style="text-align:right">Amount</th><th style="text-align:right">Time (UTC)</th></tr></thead>
        <tbody id="usage-list"><tr><td colspan="3" style="text-align:center; padding:30px;">Loading history...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- API Keys Table -->
  <div class="card" style="margin-top:20px;">
    <div class="card-header"><h3 class="card-title"><i class="fas fa-code"></i> Active Keys</h3></div>
    <div class="table-container">
      <table>
        <thead><tr><th>Key ID</th><th>Created</th><th style="text-align:right">Manage</th></tr></thead>
        <tbody id="key-list"><tr><td colspan="3" style="text-align:center; padding:30px;">Loading keys...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="card" id="admin-panel" style="margin-top:20px; display:none; border:1px solid var(--warning);">
    <div class="card-header"><h3 class="card-title" style="color:var(--warning);">Admin Controls</h3></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <div>
            <label>Self Grant</label>
            <button class="btn" style="background:var(--warning); color:black;" onclick="adminGrantSelf()">Set 100k</button>
        </div>
        <div>
            <label>Gift User</label>
            <input type="email" id="gift-email" placeholder="user@email.com">
            <input type="number" id="gift-amount" placeholder="Amount">
            <button class="btn-secondary" onclick="adminGift()">Send Gift</button>
        </div>
    </div>
  </div>

</div>

<!-- MODALS -->
<div id="payment-modal" class="modal-overlay">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('payment-modal')">&times;</button>
    <div style="text-align:center;">
        <i class="fas fa-wallet" style="font-size:3rem; color:var(--primary); margin-bottom:15px;"></i>
        <h3>Fund Wallet</h3>
    </div>
    <label>Amount (NGN)</label>
    <input type="number" id="pay-amount" value="1000" min="100">
    <button class="btn" id="pay-btn" onclick="initiatePayment()"><span>Pay Now</span><div class="loader"></div></button>
  </div>
</div>

<div id="transfer-modal" class="modal-overlay">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('transfer-modal')">&times;</button>
    <div style="text-align:center;">
        <i class="fas fa-paper-plane" style="font-size:3rem; color:var(--secondary); margin-bottom:15px;"></i>
        <h3>Transfer Credits</h3>
    </div>
    <label>Receiver Email</label>
    <input type="email" id="trans-email" placeholder="developer@example.com">
    <label>Amount</label>
    <input type="number" id="trans-amount" placeholder="500">
    <button class="btn" id="trans-btn" onclick="transferCredits()"><span>Send</span><div class="loader"></div></button>
  </div>
</div>

<div id="key-modal" class="modal-overlay">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('key-modal')">&times;</button>
    <div style="text-align:center;">
        <i class="fas fa-check-circle" style="font-size:3rem; color:var(--success); margin-bottom:15px;"></i>
        <h3>Key Generated</h3>
    </div>
    <div id="new-key" style="background:black; color:var(--success); padding:15px; border-radius:8px; font-family:monospace; word-break:break-all; text-align:center; border:1px dashed var(--glass-border);"></div>
    <button class="btn-secondary" style="margin-top:15px; width:100%;" onclick="copyKey()">Copy to Clipboard</button>
  </div>
</div>

<script type="module">
  const API_URL = "https://web-production-9a18.up.railway.app";
  const ADMIN_EMAIL = "koladhino@gmail.com";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onIdTokenChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.appspot.com",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  });

  const auth = getAuth(app);
  let token = null;

  window.logout = () => signOut(auth);
  window.openModal = (id) => document.getElementById(id).style.display = 'flex';
  window.closeModal = (id) => document.getElementById(id).style.display = 'none';
  window.copyKey = () => { navigator.clipboard.writeText(document.getElementById('new-key').innerText); toast('Copied!', 'success'); closeModal('key-modal'); };

  onIdTokenChanged(auth, async (user) => {
    if (user) {
      token = await user.getIdToken(true);
      document.getElementById('user-email').innerText = user.email;
      if(user.email.toLowerCase() === ADMIN_EMAIL) document.getElementById('admin-panel').style.display = 'block';
      
      loadData();
      
      // AUTO-VERIFY PAYMENT LOGIC
      const params = new URLSearchParams(window.location.search);
      const ref = params.get('reference') || params.get('trxref');
      if(ref) {
          // Clean URL immediately
          window.history.replaceState({}, document.title, window.location.pathname);
          startVerificationLoop(ref);
      }
    } else {
      window.location.href = 'developer-login.html';
    }
  });

  async function req(endpoint, method='GET', body=null) {
    try {
        const opts = { method, headers: { 'Content-Type': 'application/json', 'X-Firebase-Token': token } };
        if(body) opts.body = JSON.stringify(body);
        const res = await fetch(`${API_URL}${endpoint}`, opts);
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || 'Request failed');
        return data;
    } catch(e) {
        toast(e.message, 'error');
        throw e;
    }
  }

  window.loadData = async () => {
    try {
        const d = await req('/api/user/keys-and-balance');
        document.getElementById('balance-display').innerText = d.balance.toLocaleString();
        document.getElementById('active-keys-display').innerText = d.keys.filter(k=>k.is_active).length;

        const kList = document.getElementById('key-list');
        kList.innerHTML = d.keys.map(k => `<tr><td style="font-family:monospace; color:var(--primary);">...${k.api_key.slice(-8)}</td><td>${k.created_at.split('T')[0]}</td><td style="text-align:right;">${k.is_active ? `<button class="btn-danger" onclick="revoke('${k.api_key}')">Revoke</button>` : 'Revoked'}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;">No keys found</td></tr>';

        const h = await req('/api/user/usage-history');
        document.getElementById('total-calls-display').innerText = h.logs.length;
        const hList = document.getElementById('usage-list');
        hList.innerHTML = h.logs.map(l => {
            const isPos = l.type === 'funding' || l.type === 'gift';
            return `<tr><td>${l.endpoint}</td><td style="text-align:right;" class="${isPos ? 'cost-pos' : 'cost-neg'}">${isPos?'+':'-'} ${l.cost}</td><td style="text-align:right; color:#888;">${new Date(l.timestamp).toLocaleString()}</td></tr>`;
        }).join('') || '<tr><td colspan="3" style="text-align:center;">No history found</td></tr>';
    } catch(e) {}
  };

  // --- SMART PAYMENT LOOP ---
  async function startVerificationLoop(ref) {
      document.getElementById('verify-box').style.display = 'block';
      toast('Payment detected. Verifying...', 'warning');

      // Loop 20 times (approx 60 seconds)
      for(let i=0; i<20; i++) {
          try {
              const res = await req(`/api/payments/verify?transaction_ref=${ref}`);
              if(res.status === 'success' || res.status === 'already_credited') {
                  document.getElementById('verify-box').style.display = 'none';
                  toast(`Success! +${res.credits_added} Credits`, 'success');
                  loadData();
                  return; // Stop checking
              } else if (res.status === 'failed') {
                  document.getElementById('verify-box').style.display = 'none';
                  toast('Payment Failed.', 'error');
                  return;
              }
              // If 'pending', wait and loop again
          } catch(e) { console.log(e); }
          
          await new Promise(r => setTimeout(r, 3000)); // Wait 3 seconds
      }
      
      document.getElementById('verify-box').style.display = 'none';
      toast('Verification timed out. Check usage history.', 'error');
  }

  // --- ACTIONS ---
  window.initiatePayment = async () => {
      const btn = document.getElementById('pay-btn');
      btn.classList.add('loading');
      try {
          const amt = document.getElementById('pay-amount').value;
          const res = await req('/api/payments/initiate', 'POST', { amount: parseInt(amt) });
          window.location.href = res.checkout_url;
      } catch(e) { btn.classList.remove('loading'); }
  };

  window.generateKey = async () => {
      const btn = document.getElementById('gen-key-btn');
      btn.classList.add('loading');
      try {
          const res = await req('/api/user/create-api-key', 'POST');
          document.getElementById('new-key').innerText = res.api_key;
          openModal('key-modal');
          loadData();
      } catch(e) {} finally { btn.classList.remove('loading'); }
  };

  window.transferCredits = async () => {
      const btn = document.getElementById('trans-btn');
      btn.classList.add('loading');
      try {
          const email = document.getElementById('trans-email').value;
          const amt = document.getElementById('trans-amount').value;
          const res = await req('/api/user/transfer-credits', 'POST', { receiver_email: email, amount: parseInt(amt) });
          toast(res.message, 'success');
          closeModal('transfer-modal');
          loadData();
      } catch(e) {} finally { btn.classList.remove('loading'); }
  };

  window.revoke = async (key) => { if(confirm('Revoke key?')) try { await req('/api/user/revoke-api-key', 'POST', { api_key: key }); loadData(); } catch(e){} };
  window.adminGrantSelf = async () => { try { await req('/api/admin/grant-credits', 'POST'); loadData(); toast('Granted', 'success'); } catch(e){} };
  window.adminGift = async () => { try { await req('/api/admin/gift-credits', 'POST', { target_email: document.getElementById('gift-email').value, amount: parseInt(document.getElementById('gift-amount').value) }); toast('Gifted', 'success'); } catch(e){} };

  function toast(msg, type) {
      const d = document.createElement('div');
      d.className = 'toast';
      d.style.borderColor = type === 'success' ? '#00e676' : (type==='warning' ? '#ffae42' : '#ff1744');
      d.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
      document.getElementById('toast-container').appendChild(d);
      setTimeout(() => d.remove(), 4000);
  }

  // Background Stars Init
  const stars = document.getElementById('stars');
  for(let i=0; i<80; i++) { const s = document.createElement('div'); s.className = 'star'; s.style.left = Math.random()*100+'%'; s.style.top = Math.random()*100+'%'; s.style.width = Math.random()*2+'px'; s.style.height = s.style.width; s.style.animationDuration = (Math.random()*3+2)+'s'; s.style.animationDelay = (Math.random()*5)+'s'; stars.appendChild(s); }
</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
