<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philadelphia Studio | Elvion AI</title>
    
    <!-- Core Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cosmic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Cinzel:wght@400;700&family=Playfair+Display:wght@700;900&family=Roboto:wght@300;400;900&family=Bebas+Neue&family=Dancing+Script:wght@700&family=Anton&family=Courier+Prime&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --cosmic-purple: #6366f1;
            --nebula-pink: #ec4899;
            --deep-space: #0b061a;
            --panel-bg: rgba(20, 15, 45, 0.7);
            --starlight: #e0e7ff;
            --accent-cyan: #06b6d4;
            --danger: #ff4757;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--deep-space);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            color: var(--starlight);
            height: 100vh;
            overflow: hidden;
        }

        /* --- AUTH OVERLAY --- */
        #authOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(11, 6, 26, 0.98);
            z-index: 5000; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(15px);
        }
        .auth-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 3rem; border-radius: 24px; width: 400px;
            border: 1px solid var(--cosmic-purple);
            text-align: center; box-shadow: 0 0 50px rgba(99, 102, 241, 0.3);
        }
        .auth-btn {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 50px;
            border: none; font-weight: bold; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 10px;
            font-family: 'Orbitron'; transition: 0.3s;
        }
        .google-btn { background: #fff; color: #333; }
        .twitter-btn { background: #1da1f2; color: #fff; }
        .email-btn { background: var(--cosmic-purple); color: #fff; }

        /* --- APP LAYOUT --- */
        .studio-grid {
            display: grid;
            grid-template-columns: 350px 1fr 320px;
            height: 100vh;
        }

        .sidebar {
            background: var(--panel-bg);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(99, 102, 241, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .main-canvas-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: radial-gradient(circle, #1a1235 0%, #0b061a 100%);
            position: relative;
        }

        /* --- UI COMPONENTS --- */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px; padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wallet-card {
            background: linear-gradient(135deg, var(--cosmic-purple), var(--nebula-pink));
            padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .credits-num { font-size: 32px; font-weight: 900; font-family: 'Orbitron'; }

        input, select, textarea {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--cosmic-purple); border-radius: 10px;
            color: white; margin-top: 5px; font-family: 'Roboto'; font-size: 13px;
        }
        
        textarea { resize: vertical; min-height: 80px; }

        .btn-action {
            background: var(--cosmic-purple); color: white;
            padding: 12px; border: none; border-radius: 10px;
            font-family: 'Orbitron'; font-weight: bold; cursor: pointer;
            width: 100%; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-action:hover { background: var(--nebula-pink); transform: translateY(-2px); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* --- CANVAS --- */
        canvas {
            border-radius: 5px;
            box-shadow: 0 0 40px rgba(0,0,0,0.8), 0 0 20px rgba(99, 102, 241, 0.2);
        }

        /* --- CHARACTERS --- */
        .char-scroll {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-height: 250px; overflow-y: auto;
        }
        .char-thumb {
            width: 100%; aspect-ratio: 1; border-radius: 10px;
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
            object-fit: cover; position: relative;
        }
        .char-thumb:hover { border-color: var(--accent-cyan); transform: scale(1.05); }

        /* --- BOBBY CHAT --- */
        .bobby-box {
            background: rgba(0,0,0,0.4); border-radius: 15px;
            height: 150px; overflow-y: auto; padding: 10px;
            font-size: 13px; border: 1px solid rgba(6, 182, 212, 0.3);
            margin-bottom: 10px;
        }
        .msg-user { color: var(--accent-cyan); margin-bottom: 5px; }
        .msg-bot { color: #fff; margin-bottom: 10px; }

        /* --- 3D MODAL --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 4000;
            align-items: center; justify-content: center; flex-direction: column;
        }
        .scene { width: 300px; height: 450px; perspective: 1000px; }
        .book-3d { 
            width: 100%; height: 100%; position: relative; 
            transform-style: preserve-3d; transition: 1s;
            transform: rotateY(-30deg);
        }
        .face { 
            position: absolute; width: 300px; height: 450px; 
            background-size: cover; border: 1px solid #000;
        }
        .front { transform: translateZ(25px); }
        .spine { 
            width: 50px; transform: rotateY(-90deg) translateZ(25px); 
            left: -25px; background: #222;
        }
        .back { transform: rotateY(180deg) translateZ(25px); background: #111; }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 15px 25px; background: var(--nebula-pink); color: white;
            border-radius: 10px; transform: translateX(200%);
            transition: 0.5s; z-index: 6000; font-family: 'Orbitron'; font-size: 12px;
        }
        #toast.show { transform: translateX(0); }
        
        .loading-ring {
            display: none; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- AUTH -->
<div id="authOverlay">
    <div class="auth-card">
        <h2 style="font-family: 'Orbitron'; margin-bottom: 10px; font-size: 24px;">PHILADELPHIA STUDIO</h2>
        <p style="margin-bottom: 20px; font-size: 12px; opacity: 0.7; letter-spacing: 1px;">ELVION AI AUTHORING SUITE</p>
        
        <button class="auth-btn google-btn" onclick="authAction('google')"><i class="fab fa-google"></i> Google</button>
        <button class="auth-btn twitter-btn" onclick="authAction('twitter')"><i class="fab fa-twitter"></i> Twitter</button>
        
        <div style="margin: 15px 0; opacity: 0.5; font-size: 10px;">OR EMAIL</div>
        <input type="email" id="email" placeholder="Email Address">
        <input type="password" id="pass" placeholder="Password">
        <button class="auth-btn email-btn" onclick="authAction('email')">ENTER STUDIO</button>
    </div>
</div>

<!-- TOAST -->
<div id="toast">Message here</div>

<!-- 3D PREVIEW -->
<div id="mockupModal" class="modal">
    <h2 style="font-family: 'Orbitron'; margin-bottom: 30px;">3D VISUALIZATION</h2>
    <div class="scene">
        <div class="book-3d" id="book-3d">
            <div class="face front" id="m-front"></div>
            <div class="face spine" id="m-spine"></div>
            <div class="face back" id="m-back"></div>
        </div>
    </div>
    <div style="margin-top: 50px; display: flex; gap: 10px;">
        <button class="btn-action" style="width: auto;" onclick="rotateBook('front')">Front</button>
        <button class="btn-action" style="width: auto;" onclick="rotateBook('side')">Spine</button>
        <button class="btn-action" style="width: auto;" onclick="rotateBook('open')">Dynamic</button>
        <button class="btn-action" style="background:var(--danger); width: auto;" onclick="closeMockup()">Close</button>
    </div>
</div>

<!-- MAIN APP -->
<div class="studio-grid">
    
    <!-- LEFT: GENERATOR -->
    <aside class="sidebar">
        <!-- WALLET -->
        <div class="wallet-card">
            <div style="font-size: 10px; letter-spacing: 2px;">CREDIT BALANCE</div>
            <div class="credits-num" id="creditDisplay">--</div>
            <button onclick="fundWallet()" style="background:rgba(0,0,0,0.2); border:none; color:white; padding:5px 15px; border-radius:20px; cursor:pointer; margin-top:5px; font-size: 10px; font-weight: bold;">+ FUND WALLET</button>
        </div>

        <!-- GENERATOR -->
        <div class="glass-card">
            <h4 style="font-family: 'Orbitron'; font-size: 12px; margin-bottom: 10px; color: var(--accent-cyan);">PHILADELPHIA ENGINE</h4>
            
            <label style="font-size: 10px; opacity: 0.7;">MODEL SELECTION</label>
            <select id="modelKey">
                <!-- Values match bot.py keys exactly -->
                <option value="v6">Philadelphia V6 (Masterpiece)</option>
                <option value="photoreal">Philadelphia Photoreal</option>
                <option value="movie">Philadelphia Cinematic</option>
                <option value="anime_core">Philadelphia Anime</option>
                <option value="illustration">Philadelphia Illustration</option>
            </select>
            
            <label style="font-size: 10px; opacity: 0.7; margin-top: 5px; display: block;">PROMPT</label>
            <textarea id="prompt" placeholder="A mysterious book cover with a glowing rune..."></textarea>
            
            <button class="btn-action" id="genBtn" onclick="generate('cover')" style="margin-top: 10px;">
                <span id="genText">GENERATE COVER (20c)</span>
                <div class="loading-ring" id="genLoader"></div>
            </button>
        </div>

        <!-- CHARACTERS -->
        <div class="glass-card" style="flex-grow: 1; display: flex; flex-direction: column;">
            <h4 style="font-family: 'Orbitron'; font-size: 12px; margin-bottom: 10px; color: var(--accent-cyan);">PERSISTENT CHARACTERS</h4>
            <div class="char-scroll" id="charGrid">
                <!-- Char items injected here -->
            </div>
            <button class="btn-action" onclick="generate('char')" style="background:var(--accent-cyan); margin-top: auto;">CREATE CHARACTER (10c)</button>
        </div>
    </aside>

    <!-- CENTER: CANVAS -->
    <main class="main-canvas-area">
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <button class="btn-action" style="width:auto; padding:8px 20px; font-size: 10px;" onclick="setMode('front')">FRONT ONLY</button>
            <button class="btn-action" style="width:auto; padding:8px 20px; background:#444; font-size: 10px;" onclick="setMode('full')">FULL WRAP</button>
        </div>
        <div style="position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
            <canvas id="c"></canvas>
        </div>
    </main>

    <!-- RIGHT: TOOLS -->
    <aside class="sidebar" style="border-right: none; border-left: 1px solid rgba(99, 102, 241, 0.3);">
        
        <!-- TEXT TOOLS -->
        <div class="glass-card">
            <h4 style="font-family: 'Orbitron'; font-size: 12px; margin-bottom: 10px; color: var(--accent-cyan);">TYPOGRAPHY</h4>
            <button class="btn-action" onclick="addText()" style="margin-bottom: 10px;">+ ADD TEXT</button>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <select onchange="updateText('fontFamily', this.value)">
                    <option value="Cinzel">Cinzel</option>
                    <option value="Orbitron">Orbitron</option>
                    <option value="Playfair Display">Playfair</option>
                    <option value="Bebas Neue">Bebas</option>
                    <option value="Dancing Script">Script</option>
                    <option value="Courier Prime">Typewriter</option>
                    <option value="Anton">Anton</option>
                    <option value="Roboto">Roboto</option>
                </select>
                <input type="number" value="60" onchange="updateText('fontSize', parseInt(this.value))">
            </div>
            <input type="color" value="#ffffff" onchange="updateText('fill', this.value)" style="height: 30px;">
        </div>

        <!-- IMAGE TOOLS -->
        <div class="glass-card">
            <h4 style="font-family: 'Orbitron'; font-size: 12px; margin-bottom: 10px; color: var(--accent-cyan);">MAGIC TOOLS</h4>
            <button class="btn-action" style="background:#444; margin-bottom: 5px;" onclick="removeBG()">
                <i class="fas fa-magic"></i> &nbsp; REMOVE BG
            </button>
            <button class="btn-action" style="background:#444; margin-bottom: 5px;" onclick="toggleBrush()">
                <i class="fas fa-paint-brush"></i> &nbsp; BRUSH / ERASE
            </button>
            <button class="btn-action" style="background:var(--danger);" onclick="deleteObj()">
                <i class="fas fa-trash"></i> &nbsp; DELETE
            </button>
        </div>

        <!-- BOBBY & EXPORT -->
        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
            <div class="glass-card">
                <h4 style="font-family: 'Orbitron'; font-size: 12px; margin-bottom: 5px; color: var(--accent-cyan);">BOBBY ASSISTANT</h4>
                <div class="bobby-box" id="chat">
                    <div class="msg-bot">Bobby: I can write your prompt. Just give me a vague idea!</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="chatIn" placeholder="E.g. A cyberpunk samurai...">
                    <button onclick="askBobby()" style="background:var(--cosmic-purple); border:none; padding:0 15px; border-radius:10px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <button class="btn-action" onclick="openMockup()" style="background:var(--accent-cyan); color:#000;">
                <i class="fas fa-cube"></i> &nbsp; 3D MOCKUP
            </button>
            <button class="btn-action" onclick="download()" style="background:var(--starlight); color:#000;">
                <i class="fas fa-download"></i> &nbsp; DOWNLOAD
            </button>
        </div>
    </aside>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    const API_URL = "https://web-production-9a18.up.railway.app";
    const SUPER_ADMIN = "koladhino@gmail.com"; // Case insensitive check later

    let canvas, userToken;
    let credits = 0;
    let isBrushMode = false;

    // --- 2. AUTHENTICATION ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userToken = await user.getIdToken();
            document.getElementById('authOverlay').style.display = 'none';
            initStudio();
            notify(`Welcome, ${user.email}`);
        } else {
            document.getElementById('authOverlay').style.display = 'flex';
        }
    });

    async function authAction(type) {
        try {
            if(type === 'google') await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            if(type === 'twitter') await auth.signInWithPopup(new firebase.auth.TwitterAuthProvider());
            if(type === 'email') {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                await auth.signInWithEmailAndPassword(e, p).catch(() => auth.createUserWithEmailAndPassword(e, p));
            }
        } catch(err) { alert(err.message); }
    }

    // --- 3. STUDIO INITIALIZATION ---
    function initStudio() {
        canvas = new fabric.Canvas('c', {
            width: 600, height: 900, backgroundColor: '#ffffff', preserveObjectStacking: true
        });
        
        loadCredits();
        loadHistory();
        
        // Auto Save
        canvas.on('object:modified', saveProject);
        canvas.on('object:added', saveProject);
    }

    // --- 4. DATA & CREDITS ---
    async function loadCredits() {
        try {
            const res = await fetch(`${API_URL}/api/user/keys-and-balance`, {
                headers: { 'X-Firebase-Token': userToken }
            });
            const data = await res.json();
            
            if(auth.currentUser.email.toLowerCase() === SUPER_ADMIN.toLowerCase()) {
                credits = 999999;
                document.getElementById('creditDisplay').innerText = "UNLIMITED";
            } else {
                credits = data.balance || 0;
                document.getElementById('creditDisplay').innerText = credits.toLocaleString();
            }
        } catch(e) { console.error("Credit load error", e); }
    }

    // --- 5. IMAGE GENERATION (FIXED) ---
    async function generate(type) {
        const cost = type === 'cover' ? 20 : 10;
        
        // Check Credits
        if(credits < cost) return notify("Insufficient Credits. Please fund wallet.");

        const prompt = document.getElementById('prompt').value;
        const model = document.getElementById('modelKey').value; // v6, photoreal, etc.
        
        if(!prompt) return notify("Please enter a description!");

        // UI State
        const btn = type === 'cover' ? document.getElementById('genBtn') : null;
        if(btn) {
            document.getElementById('genLoader').style.display = 'block';
            document.getElementById('genText').style.display = 'none';
            btn.disabled = true;
        }

        try {
            // THE FIX: Sending strict integers for width/height and correct payload structure
            const payload = {
                prompt: type === 'char' ? `Character sheet, white background, ${prompt}` : prompt,
                model: model, // This matches bot.py keys exactly
                width: 600, // INTEGER
                height: 900, // INTEGER
                use_minimax: false,
                creative: false
            };

            const res = await fetch(`${API_URL}/generate-image`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Firebase-Token': userToken
                },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if(!res.ok) throw new Error(data.detail || "Generation failed");

            // Handle Success
            if(data.image_b64) {
                if(type === 'cover') {
                    fabric.Image.fromURL('data:image/png;base64,' + data.image_b64, (img) => {
                        img.scaleToWidth(600);
                        canvas.add(img);
                        canvas.sendToBack(img);
                        saveProject();
                    });
                } else {
                    saveCharacter(data.image_b64);
                }
                
                // Update Local Credits (Backend handles actual deduction, this is for UI speed)
                if(auth.currentUser.email.toLowerCase() !== SUPER_ADMIN.toLowerCase()) {
                    credits -= cost;
                    document.getElementById('creditDisplay').innerText = credits.toLocaleString();
                }
                notify("Philadelphia Generation Successful!");
            }

        } catch(e) {
            console.error(e);
            notify(`Error: ${e.message}`);
        } finally {
            if(btn) {
                document.getElementById('genLoader').style.display = 'none';
                document.getElementById('genText').style.display = 'block';
                btn.disabled = false;
            }
        }
    }

    // --- 6. CANVAS TOOLS ---
    function addText() {
        const text = new fabric.IText('TITLE', {
            left: 100, top: 100,
            fontFamily: 'Cinzel',
            fill: '#ffffff',
            fontSize: 80,
            shadow: 'rgba(0,0,0,0.8) 5px 5px 10px'
        });
        canvas.add(text);
        canvas.setActiveObject(text);
    }

    function updateText(prop, val) {
        const obj = canvas.getActiveObject();
        if(obj) { obj.set(prop, val); canvas.renderAll(); saveProject(); }
    }

    async function removeBG() {
        const obj = canvas.getActiveObject();
        if(!obj || obj.type !== 'image') return notify("Select an image first!");
        
        notify("Removing background...");
        
        // Use FormData as per bot.py
        const dataURL = obj.toDataURL({format: 'png'});
        const blob = await (await fetch(dataURL)).blob();
        const fd = new FormData();
        fd.append('file', blob, 'image.png');

        try {
            const res = await fetch(`${API_URL}/api/tools/remove-background`, {
                method: 'POST',
                body: fd
                // No headers needed for FormData, browser sets boundary
                // API Key handled on backend
            });

            if(!res.ok) throw new Error("BG Removal Failed");

            const resBlob = await res.blob();
            const reader = new FileReader();
            reader.onload = (e) => {
                fabric.Image.fromURL(e.target.result, (img) => {
                    img.set({ left: obj.left, top: obj.top, scaleX: obj.scaleX, scaleY: obj.scaleY });
                    canvas.remove(obj);
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    notify("Background Removed!");
                });
            };
            reader.readAsDataURL(resBlob);

        } catch(e) { notify("Error removing BG"); }
    }

    function toggleBrush() {
        isBrushMode = !isBrushMode;
        canvas.isDrawingMode = isBrushMode;
        if(isBrushMode) {
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = "white"; // Simulates erasing on white canvas or brushing effects
            canvas.freeDrawingBrush.width = 20;
            notify("Brush Mode: ON");
        } else {
            notify("Brush Mode: OFF");
        }
    }

    function deleteObj() {
        const obj = canvas.getActiveObject();
        if(obj) canvas.remove(obj);
    }

    function setMode(mode) {
        if(mode === 'full') {
            canvas.setWidth(1300); // 600 back + 100 spine + 600 front
            // Draw guides
            canvas.add(new fabric.Line([600, 0, 600, 900], { stroke: '#06b6d4', strokeDashArray: [5, 5], selectable: false }));
            canvas.add(new fabric.Line([700, 0, 700, 900], { stroke: '#06b6d4', strokeDashArray: [5, 5], selectable: false }));
        } else {
            canvas.setWidth(600);
        }
        canvas.renderAll();
    }

    // --- 7. PERSISTENCE ---
    function saveCharacter(b64) {
        const grid = document.getElementById('charGrid');
        const div = document.createElement('div');
        div.innerHTML = `<img src="data:image/png;base64,${b64}" class="char-thumb" onclick="addCharToCanvas(this.src)">`;
        grid.prepend(div);
        
        // LocalStorage logic
        const saved = JSON.parse(localStorage.getItem('elv_chars') || "[]");
        saved.push(b64);
        localStorage.setItem('elv_chars', JSON.stringify(saved));
    }

    function addCharToCanvas(src) {
        fabric.Image.fromURL(src, (img) => {
            img.scaleToWidth(300);
            canvas.add(img);
            canvas.setActiveObject(img);
        });
    }

    function loadHistory() {
        const saved = JSON.parse(localStorage.getItem('elv_chars') || "[]");
        saved.forEach(b64 => {
            const grid = document.getElementById('charGrid');
            const div = document.createElement('div');
            div.innerHTML = `<img src="data:image/png;base64,${b64}" class="char-thumb" onclick="addCharToCanvas(this.src)">`;
            grid.appendChild(div);
        });
        
        const proj = localStorage.getItem('elv_project');
        if(proj) canvas.loadFromJSON(proj);
    }

    function saveProject() {
        localStorage.setItem('elv_project', JSON.stringify(canvas.toJSON()));
    }

    // --- 8. BOBBY & UTILS ---
    async function askBobby() {
        const inp = document.getElementById('chatIn');
        const q = inp.value;
        if(!q) return;
        
        const box = document.getElementById('chat');
        box.innerHTML += `<div class="msg-user">You: ${q}</div>`;
        inp.value = "";

        try {
            const res = await fetch(`${API_URL}/api/llama/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: `User wants a book cover: "${q}". Write a detailed stable diffusion prompt for it.`,
                    systemPrompt: "You are Bobby, an expert art director."
                })
            });
            const data = await res.json();
            const reply = data.response || data.content;
            
            box.innerHTML += `<div class="msg-bot">Bobby: ${reply}</div>`;
            box.scrollTop = box.scrollHeight;
            
            // Auto-fill prompt
            document.getElementById('prompt').value = reply;
        } catch(e) { notify("Bobby is sleeping..."); }
    }

    function openMockup() {
        const data = canvas.toDataURL();
        document.getElementById('mockupModal').style.display = 'flex';
        const isFull = canvas.width > 1000;
        
        const front = document.getElementById('m-front');
        const back = document.getElementById('m-back');
        const spine = document.getElementById('m-spine');

        front.style.backgroundImage = `url(${data})`;
        
        if(isFull) {
            front.style.backgroundPosition = "100% 0"; // Right side
            back.style.backgroundImage = `url(${data})`;
            back.style.backgroundPosition = "0 0"; // Left side
            spine.style.backgroundImage = `url(${data})`;
            spine.style.backgroundPosition = "50% 0"; // Center
        } else {
            front.style.backgroundPosition = "center";
            back.style.background = "#222";
            spine.style.background = "#111";
        }
    }

    function rotateBook(view) {
        const b = document.getElementById('book-3d');
        if(view === 'front') b.style.transform = "rotateY(-20deg) rotateX(10deg)";
        if(view === 'side') b.style.transform = "rotateY(-100deg)";
        if(view === 'open') b.style.transform = "rotateY(-30deg) rotateX(15deg) scale(0.9)";
    }

    function closeMockup() { document.getElementById('mockupModal').style.display = 'none'; }

    function download() {
        const a = document.createElement('a');
        a.download = 'Elvion_Cover.png';
        a.href = canvas.toDataURL({format:'png', quality:1});
        a.click();
    }

    function notify(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function fundWallet() {
        const amt = prompt("Enter amount (NGN) to fund:");
        if(amt && amt >= 100) {
            // Redirect to your payment flow (handled by bot.py logic usually)
            // Simulating flow for frontend
            alert("Redirecting to Secure Payment Gateway (Korapay)...");
            
            // This replicates the initiate call from frontend side logic
            fetch(`${API_URL}/api/payments/initiate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Firebase-Token': userToken },
                body: JSON.stringify({ amount: parseInt(amt) })
            })
            .then(r => r.json())
            .then(d => {
                if(d.checkout_url) window.open(d.checkout_url, '_blank');
                else notify("Payment Error");
            });
        }
    }
</script>
</body>
</html>
