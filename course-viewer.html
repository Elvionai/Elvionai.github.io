<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Viewer | Elvion University</title>
  <meta name="description" content="Learn with interactive courses at Elvion University">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --dark-navy: #00001a;
      --black-bg: #000000;
      --cyan-glow: #00ffff;
      --light-blue-glow: #00aaff;
      --text-color: #e0e0e0;
      --heading-color: #ffffff;
      --gradient-start: #0a1128;
      --gradient-end: #121a30;
      --card-bg: rgba(18, 26, 48, 0.85);
      --border-glow: 0 0 10px var(--cyan-glow), 0 0 20px var(--light-blue-glow);
      --hover-glow: 0 0 15px var(--cyan-glow), 0 0 30px var(--light-blue-glow);
      --button-bg: linear-gradient(45deg, var(--cyan-glow), var(--light-blue-glow));
      --button-text-color: var(--black-bg);
      --star-color: rgba(255, 255, 255, 0.7);
      --sidebar-width: 300px;
      --success-color: #4ade80;
      --warning-color: #fbbf24;
      --error-color: #f87171;
      --primary-color: var(--cyan-glow);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--black-bg);
      color: var(--text-color);
      line-height: 1.7;
      overflow-x: hidden;
      position: relative;
      min-height: 100vh;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Orbitron', sans-serif;
      color: var(--heading-color);
      margin-top: 0;
    }

    /* Stars Animation */
    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .star {
      position: absolute;
      background-color: var(--star-color);
      border-radius: 50%;
      opacity: 0;
      animation: twinkle 4s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1); }
    }

    /* Main Layout */
    .course-viewer-container {
      display: flex;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Course Sidebar */
    .course-sidebar {
      width: var(--sidebar-width);
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(0, 255, 255, 0.2);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .course-sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--cyan-glow);
      text-decoration: none;
      font-weight: 600;
      padding: 0.8rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      margin-bottom: 1rem;
    }

    .back-btn:hover {
      background: rgba(0, 255, 255, 0.1);
    }

    .course-info {
      text-align: center;
    }

    .course-icon-large {
      font-size: 3rem;
      color: var(--cyan-glow);
      text-shadow: var(--border-glow);
      margin-bottom: 1rem;
    }

    .course-title {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: var(--heading-color);
    }

    .course-subtitle {
      font-size: 0.9rem;
      color: var(--text-color);
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .overall-progress {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .progress-label {
      font-size: 0.85rem;
      color: var(--text-color);
      margin-bottom: 0.5rem;
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(0, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--button-bg);
      border-radius: 10px;
      transition: width 0.8s ease;
      box-shadow: 0 0 10px var(--cyan-glow);
    }

    .progress-text {
      font-size: 0.85rem;
      color: var(--cyan-glow);
      font-weight: 600;
    }

    /* Lessons List */
    .lessons-list {
      padding: 1rem 0;
    }

    .lessons-header {
      padding: 0 1.5rem 1rem 1.5rem;
      font-size: 1.1rem;
      color: var(--heading-color);
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
    }

    .lesson-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .lesson-item:hover {
      background: rgba(0, 255, 255, 0.05);
    }

    .lesson-item.active {
      background: rgba(0, 255, 255, 0.1);
      border-left-color: var(--cyan-glow);
    }

    .lesson-item.completed {
      opacity: 0.8;
    }

    .lesson-status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .lesson-status.completed {
      background: var(--success-color);
      color: var(--black-bg);
    }

    .lesson-status.current {
      background: var(--cyan-glow);
      color: var(--black-bg);
    }

    .lesson-status.locked {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
    }

    .lesson-details {
      flex: 1;
    }

    .lesson-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--heading-color);
      margin-bottom: 0.3rem;
    }

    .lesson-duration {
      font-size: 0.8rem;
      color: var(--text-color);
      opacity: 0.7;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 101;
      background: var(--card-bg);
      border: 1px solid var(--cyan-glow);
      border-radius: 8px;
      padding: 0.5rem 0.8rem;
      color: var(--cyan-glow);
      cursor: pointer;
      box-shadow: var(--border-glow);
    }

    /* Content Area */
    .content-area {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .content-header {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .lesson-info h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .lesson-meta {
      display: flex;
      gap: 1.5rem;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .lesson-meta span {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .content-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .action-btn {
      padding: 0.8rem 1.5rem;
      background: var(--button-bg);
      color: var(--button-text-color);
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .action-btn:hover {
      box-shadow: var(--hover-glow); /* Changed to hover-glow for better effect */
      transform: scale(1.05);
    }

    .action-btn.secondary {
      background: transparent;
      border: 2px solid var(--cyan-glow);
      color: var(--cyan-glow);
    }

    .action-btn.secondary:hover {
      background: var(--cyan-glow);
      color: var(--black-bg);
      box-shadow: none; /* Removed shadow on secondary hover to differentiate */
      transform: scale(1.05);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    }

    .content-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--border-glow);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 255, 0.1);
      margin-bottom: 2rem;
      max-width: 900px; /* Fitting to page constraint */
      margin-left: auto;
      margin-right: auto;
    }

    .lesson-content {
      line-height: 1.8;
      font-size: 1.1rem;
    }

    .lesson-content h2 {
      color: var(--cyan-glow);
      margin: 2rem 0 1rem 0;
      font-size: 1.6rem; /* Slightly larger */
    }

    .lesson-content h3 {
      color: var(--heading-color);
      margin: 1.5rem 0 0.8rem 0;
      font-size: 1.3rem;
    }
    
    .lesson-content h4 {
        color: var(--warning-color);
        margin: 1rem 0 0.5rem 0;
        font-size: 1.1rem;
    }

    .lesson-content p {
      margin-bottom: 1.2rem;
    }

    .lesson-content ul, .lesson-content ol {
      margin: 1rem 0 1rem 2rem;
      padding-left: 1rem;
    }

    .lesson-content li {
      margin-bottom: 0.5rem;
    }
    
    /* Code block styling for practical examples */
    .lesson-content code {
      background: rgba(0, 255, 255, 0.1);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: var(--cyan-glow);
      font-family: 'Courier New', monospace;
      font-weight: 700; /* Bolder code */
    }

    .lesson-content pre {
      background: rgba(0, 0, 0, 0.5);
      padding: 1.5rem;
      border-radius: 8px;
      border-left: 4px solid var(--cyan-glow);
      overflow-x: auto;
      margin: 1.5rem 0;
      box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
      position: relative;
    }

    .lesson-content pre code {
      background: none;
      padding: 0;
      color: var(--success-color); /* Code in pre blocks is bright green */
      display: block;
      white-space: pre-wrap;
      word-break: break-all;
      font-weight: normal;
    }

    /* Interactive Code/Markdown Area Simulation */
    .interactive-code-area {
        background: #1e1e2d;
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        padding: 1rem;
        margin: 1.5rem 0;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
    .interactive-code-area textarea {
        width: 100%;
        min-height: 100px; /* Smaller default height */
        background: transparent;
        color: var(--success-color);
        border: none;
        resize: vertical;
        padding: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        outline: none;
    }
    .interactive-code-area .output {
        border-top: 1px dashed rgba(255, 255, 255, 0.2);
        padding-top: 0.5rem;
        color: var(--warning-color);
        font-size: 0.9rem;
        min-height: 30px;
        margin-top: 0.5rem;
    }
    .interactive-code-area .area-header {
        font-size: 0.8rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    /* Video Player Placeholder */
    .media-player {
      width: 100%;
      height: 400px;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
      border: 1px solid rgba(0, 255, 255, 0.2);
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .media-placeholder {
      text-align: center;
      color: var(--text-color);
    }

    .media-placeholder i {
      font-size: 4rem;
      color: var(--cyan-glow);
      margin-bottom: 1rem;
      display: block;
    }

    /* Navigation Controls */
    .lesson-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 255, 255, 0.1);
    }

    .nav-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .lesson-indicator {
      background: rgba(0, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid rgba(0, 255, 255, 0.3);
    }

    .nav-buttons {
      display: flex;
      gap: 1rem;
    }

    /* Quiz/Assessment Styles */
    .quiz-container {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 2rem;
      box-shadow: var(--border-glow);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 255, 255, 0.1);
      margin-bottom: 2rem;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .quiz-question-wrapper {
        background: rgba(0, 0, 0, 0.3);
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(0, 255, 255, 0.1);
        transition: transform 0.3s ease; /* Animation wrapper */
    }
    
    .quiz-question-wrapper:hover {
        transform: translateY(-3px);
    }

    .quiz-question {
      font-size: 1.2rem;
      color: var(--heading-color);
      margin-bottom: 1.5rem;
      border-bottom: 1px solid rgba(0, 255, 255, 0.1);
      padding-bottom: 1rem;
      font-weight: 600;
    }

    .quiz-options {
      display: grid;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .quiz-option {
      padding: 1rem 1.5rem;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-color);
      position: relative;
    }

    .quiz-option:hover {
      border-color: var(--cyan-glow);
      background: rgba(0, 255, 255, 0.05);
    }

    .quiz-option.selected {
      border-color: var(--cyan-glow);
      background: rgba(0, 255, 255, 0.1);
      color: var(--cyan-glow);
    }
    
    /* Correct/Incorrect state styling with simple animation */
    .quiz-option.correct {
      border-color: var(--success-color) !important;
      background: rgba(74, 222, 128, 0.1) !important;
      color: var(--success-color) !important;
      font-weight: bold;
      animation: flash-correct 0.4s ease-in-out;
    }

    .quiz-option.incorrect {
      border-color: var(--error-color) !important;
      background: rgba(248, 113, 113, 0.1) !important;
      color: var(--error-color) !important;
      animation: shake 0.5s;
    }
    
    /* Visual indicator on correctness */
    .quiz-option.correct::before {
      content: '✓';
      margin-right: 10px;
    }
    .quiz-option.incorrect::before {
      content: '✗';
      margin-right: 10px;
    }
    
    @keyframes flash-correct {
        0% { transform: scale(1); opacity: 0.5; }
        50% { transform: scale(1.02); opacity: 1; }
        100% { transform: scale(1); }
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }


    .quiz-feedback {
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
    }

    .quiz-feedback.correct {
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      color: var(--success-color);
      display: block;
      font-weight: 600;
    }

    .quiz-feedback.incorrect {
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.3);
      color: var(--error-color);
      display: block;
      font-weight: 600;
    }
    
    /* Completion Modal Adjustments */
    .completion-modal .completion-icon {
        font-size: 4rem;
        color: var(--success-color);
        text-shadow: 0 0 10px var(--success-color);
        margin-bottom: 1rem;
        animation: pulse 1s infinite alternate;
    }
    
    .completion-modal .points-earned {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--cyan-glow);
        margin: 1.5rem 0;
        padding: 0.5rem 1rem;
        background: rgba(0, 255, 255, 0.1);
        border-radius: 8px;
        display: inline-block;
        border: 1px solid var(--cyan-glow);
    }
    
    @keyframes pulse {
        from { transform: scale(1); opacity: 0.8; }
        to { transform: scale(1.05); opacity: 1; }
    }


    /* Certificate Form & Final Page Styles */
    .final-page-content {
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
    }
    .certificate-form-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 3rem;
      box-shadow: var(--hover-glow);
      border: 1px solid var(--primary-color);
      text-align: left;
      margin-top: 2rem;
    }
    .certificate-form-card h2 {
      color: var(--success-color);
      text-shadow: 0 0 10px var(--success-color);
      margin-bottom: 1.5rem;
    }
    .certificate-form-card label {
      display: block;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-color);
    }
    .certificate-form-card input[type="text"],
    .certificate-form-card input[type="email"] {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: var(--text-color);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    .certificate-form-card input:focus {
      border-color: var(--cyan-glow);
      box-shadow: 0 0 5px var(--cyan-glow);
      outline: none;
    }
    .certificate-form-card .submit-btn {
      width: 100%;
      margin-top: 2rem;
    }

    /* Comment Section Styles */
    .comment-section {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 1.5rem;
        margin-top: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .comment-section textarea {
        width: 100%;
        min-height: 100px;
        padding: 1rem;
        border-radius: 8px;
        border: 2px solid rgba(0, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
        color: var(--text-color);
        font-size: 1rem;
        resize: vertical;
        outline: none;
        transition: border-color 0.3s ease;
    }
    .comment-section textarea:focus {
        border-color: var(--cyan-glow);
        box-shadow: 0 0 5px var(--cyan-glow);
    }
    .comment-section .comment-btn {
        margin-top: 1rem;
        padding: 0.6rem 1.2rem;
        font-weight: 500;
        float: right;
    }

    /* Completion Modal */
    .completion-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .completion-content {
      background: var(--card-bg);
      padding: 3rem;
      border-radius: 15px;
      text-align: center;
      max-width: 500px;
      box-shadow: var(--hover-glow);
      border: 1px solid rgba(0, 255, 255, 0.3);
    }
    
    /* Loading State */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(0, 255, 255, 0.1);
      border-top-color: var(--cyan-glow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 1rem;
      color: var(--text-color);
      font-size: 1.1rem;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .course-sidebar {
        transform: translateX(-100%);
      }

      .course-sidebar.active {
        transform: translateX(0);
      }

      .content-area {
        margin-left: 0;
      }

      .mobile-menu-toggle {
        display: block;
      }

      .main-content {
        padding: 1rem;
        padding-top: 4rem;
      }

      .content-header {
        padding: 1rem;
        flex-direction: column;
        align-items: flex-start;
      }

      .content-actions {
        width: 100%;
        justify-content: stretch;
      }

      .action-btn {
        flex: 1;
        justify-content: center;
      }

      .lesson-navigation {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }

      .nav-buttons {
        width: 100%;
        justify-content: stretch;
      }

      .nav-buttons .action-btn {
        flex: 1;
      }
    }

    @media (max-width: 768px) {
      .media-player {
        height: 250px;
      }

      .content-card {
        padding: 1.5rem;
      }

      .completion-content {
        margin: 1rem;
        padding: 2rem;
      }

      .quiz-option {
        padding: 0.8rem 1rem;
      }
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>

  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </button>

  <div class="course-viewer-container">
    <aside class="course-sidebar" id="courseSidebar">
      <div class="course-sidebar-header">
        <a href="studyingatelvion.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        
        <div class="course-info">
          <i id="courseIconLarge" class="course-icon-large"></i>
          <h2 id="courseTitle" class="course-title">Loading...</h2>
          <p id="courseSubtitle" class="course-subtitle">Please wait...</p>
          
          <div class="overall-progress">
            <div class="progress-label">Overall Progress</div>
            <div class="progress-bar-container">
              <div id="overallProgressBar" class="progress-bar-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text"><span id="overallProgressText">0% Complete</span></div>
            <div class="progress-text" style="margin-top: 0.5rem;"><i class="fas fa-trophy"></i> Total Points: <span id="totalPointsEarnedSidebar">0</span></div>
          </div>
        </div>
      </div>

      <div class="lessons-list">
        <div class="lessons-header">Course Lessons</div>
        <div id="lessonsContainer">
          </div>
      </div>
    </aside>

    <main class="content-area">
      <div class="loading-container" id="loadingContainer">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading course content...</p>
      </div>

      <header class="content-header" id="contentHeader" style="display: none;">
        <div class="lesson-info">
          <h1 id="lessonTitle">Lesson Title</h1>
          <div class="lesson-meta">
            <span><i class="fas fa-clock"></i> <span id="lessonDuration">45 min</span></span>
            <span><i class="fas fa-book"></i> Lesson <span id="currentLessonNumber">1</span> of <span id="totalLessons">8</span></span>
            <span><i class="fas fa-star"></i> <span id="lessonPoints">10</span> Points</span>
          </div>
        </div>
        <div class="content-actions">
          <button id="markCompleteBtn" class="action-btn" style="display: none;">
            <i class="fas fa-check"></i>
            Mark Complete
          </button>
        </div>
      </header>

      <section class="main-content" id="mainContent" style="display: none;">
        
        <div id="finalCoursePage" style="display: none;" class="final-page-content">
            <h1 style="color: var(--success-color); text-shadow: var(--hover-glow);">Course Completed!</h1>
            <p class="lead" style="margin-bottom: 2rem;">
                Congratulations! You have completed all lessons and earned your GP! The final step is to request your certificate.
            </p>
            
            <div class="overall-progress" style="margin-bottom: 3rem; background: var(--black-bg); border: 2px solid var(--success-color);">
                <div class="progress-label" style="font-size: 1.1rem; color: var(--success-color);">Your Final Course Grade Point (GP)</div>
                <div class="progress-text" style="font-size: 2rem; color: var(--success-color); font-weight: 800;"><span id="finalTotalPoints">0</span> Points</div>
                <p style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.8;">(Based on 10 points per successfully completed lesson quiz)</p>
            </div>

            <div class="certificate-form-card">
                <h2>Certificate & Project Submission</h2>
                <p style="margin-bottom: 1.5rem; color: var(--warning-color);">
                    To receive your certificate, please fill in your details below. For courses with a mandatory project (**Computer Science, Software Engineering, Visual Arts, Business Admin**), please **email your Final Project** (as outlined in the last lesson) to: <strong style="color: var(--cyan-glow);">elvionailabs@gmail.com</strong>.
                </p>
                <form id="certificateForm" action="https://formspree.io/f/mldrbpwo" method="post">
                    <input type="hidden" name="_subject" id="formSubject">
                    <input type="hidden" name="Course Completed" id="completedCourseName">
                    <input type="hidden" name="Total Points Earned" id="formTotalPoints">
                    
                    <label for="fullName">Full Name (for Certificate):</label>
                    <input type="text" id="fullName" name="Full Name" required>

                    <label for="email">Email Address (for delivery):</label>
                    <input type="email" id="email" name="Email" required>

                    <label for="studentId">Elvion Student ID (Optional):</label>
                    <input type="text" id="studentId" name="Student ID">

                    <button type="submit" class="action-btn submit-btn">
                        <i class="fas fa-certificate"></i> Request Certificate
                    </button>
                </form>

                <div class="comment-section">
                    <h4>Feedback & Questions</h4>
                    <form>
                        <textarea placeholder="Share your experience, ask a question, or send a thank you note to Elvion!"></textarea>
                        <button type="submit" class="action-btn comment-btn secondary" style="background: var(--dark-navy); color: var(--cyan-glow);">Submit Feedback</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="media-player" id="mediaPlayer">
          <div class="media-placeholder">
            <i class="fas fa-play-circle"></i>
            <p id="mediaPlaceholderText">Video/Media content coming soon</p>
            <p style="font-size: 0.9rem; opacity: 0.7;">For now, please read the lesson content below</p>
          </div>
        </div>

        <div class="content-card">
          <div id="lessonContent" class="lesson-content">
            </div>
        </div>

        <div id="quizContainer" class="quiz-container" style="display: none;">
          <h3 style="margin-bottom: 1.5rem; color: var(--warning-color);"><i class="fas fa-clipboard-check"></i> Mandatory Quiz: Pass to Proceed</h3>
          <p style="margin-bottom: 2rem; border-bottom: 1px solid rgba(0, 255, 255, 0.1); padding-bottom: 1rem;">
            You must correctly answer all questions below before the 'Next' lesson button is enabled.
          </p>
          <div id="quizQuestions">
            </div>
          <button id="submitQuizBtn" class="action-btn" style="width: 100%; margin-top: 2rem;">
            <i class="fas fa-paper-plane"></i> Submit Answers
          </button>
          <div id="quizResult" style="margin-top: 1rem;"></div>
        </div>
      </section>

      <nav class="lesson-navigation" id="lessonNavigation" style="display: none;">
        <div class="nav-info">
          <div class="lesson-indicator">
            Lesson <span id="navCurrentLesson">1</span> of <span id="navTotalLessons">8</span>
          </div>
          <span><i class="fas fa-trophy"></i> GP: <span id="totalPointsEarnedNav">0</span> Points</span>
        </div>
        <div class="nav-buttons">
          <button id="prevLessonBtn" class="action-btn secondary">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <button id="nextLessonBtn" class="action-btn">
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </nav>
    </main>
  </div>

  <div id="completionModal" class="completion-modal">
    <div class="completion-content">
      <i class="fas fa-trophy completion-icon"></i>
      <h2 class="completion-title">Lesson Complete!</h2>
      <p class="completion-message">
        Congratulations! You've successfully completed the quiz and this lesson.
      </p>
      <div class="points-earned">
        <i class="fas fa-star"></i>
        You earned <span id="pointsEarned">10</span> points!
      </div>
      <div style="display: flex; gap: 1rem;">
        <button id="continueBtn" class="action-btn" style="flex: 1;">
          Continue Learning
        </button>
        <button id="backToDashboardBtn" class="action-btn secondary" style="flex: 1;">
          Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // IMPORTANT: Replace with your actual Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
      authDomain: "elvionai.firebaseapp.com",
      projectId: "elvionai",
      storageBucket: "elvionai.firebasestorage.app",
      messagingSenderId: "161078300830",
      appId: "1:161078300830:web:f460df8591704eb0e96b8f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- FALLBACK/DEFAULT LESSON & QUIZ FOR NEW COURSES ---
    const defaultLessonContent = (coursePrefix) => `
        <h2>Welcome to Your ${coursePrefix} Course!</h2>
        <p>This is the first lesson of your ${coursePrefix} course. Here you will learn the foundational concepts.</p>
        
        <h3>Elvion University Philosophy</h3>
        <p>Elvion University is dedicated to **providing free, quality pre-degree knowledge and certificates** to empower future students globally. Your commitment to completing this course is your most valuable credential.</p>
        
        <div class="interactive-code-area" style="background: rgba(18, 26, 48, 0.85); border-color: var(--warning-color);">
            <div class="area-header" style="color: var(--warning-color);"><span>Course Focus</span></div>
            <p>Please remember to focus on the core concepts of this subject. You will be tested on the content to ensure you grasp the fundamentals before moving to the next lesson.</p>
        </div>
        
        <h4>Lesson Objectives:</h4>
        <ul>
            <li>Understand the scope of ${coursePrefix}.</li>
            <li>Identify key theoretical models in the field.</li>
            <li>Learn the course structure and grading system.</li>
        </ul>
    `;
    
    // Helper to generate default lessons for other courses
    const generateDefaultLessons = (count, coursePrefix, isProject) => {
        return Array(count).fill(0).map((_, i) => {
            let lessonTitle = `Lesson ${i+1}: Foundational ${coursePrefix} Concepts`;
            let content = defaultLessonContent(coursePrefix);
            
            if (i === 0) {
                // Keep a specific introductory quiz for the first lesson
                const introQuiz = [
                    { type: 'mcq', question: 'What is the main purpose of Elvion University?', options: ['Awarding accredited degrees', 'Providing free pre-degree knowledge and certificates', 'Replacing traditional universities', 'Offering high-cost private education'], answer: 'Providing free pre-degree knowledge and certificates' },
                    { type: 'mcq', question: 'How is student progress measured in this course viewer?', options: ['Monthly Exams', 'Lesson by lesson mandatory quizzes', 'Instructor approval only', 'Number of videos watched'], answer: 'Lesson by lesson mandatory quizzes' },
                ];
                return {
                    id: i + 1,
                    title: `${coursePrefix} Introduction`,
                    duration: '40 min',
                    content: content,
                    quiz: introQuiz,
                };
            }
            
            if (i === count - 1) {
                lessonTitle = isProject ? `Lesson ${i+1}: Final Project / Capstone` : `Lesson ${i+1}: Conclusion & Next Steps`;
                content = `<h2>${lessonTitle}</h2>
                    <p>Congratulations on reaching the final lesson of the ${coursePrefix} course!</p>
                    <p>This course's final requirement is a **Project Submission** (if the course has one) or a final reflection. Proceed to the Certificate page once you pass the final quiz.</p>
                    <p style="color: var(--cyan-glow);">For ${coursePrefix}, please **submit your final deliverable** to: <strong style="color: var(--warning-color);">elvionailabs@gmail.com</strong> after requesting your certificate.</p>
                `;
            } else {
                lessonTitle = `Lesson ${i+1}: Core Topic in ${coursePrefix}`;
                content = content.replace('Welcome to Your Course!', lessonTitle); // Simple content adjustment
            }
            
            // Simplified, universal quiz for placeholder lessons after the first one
            const simpleQuiz = [
                { type: 'mcq', question: 'Which phase of the ${coursePrefix} learning process is most critical?', options: ['Memorizing names', 'Active application of concepts', 'Skipping lessons', 'Only watching videos'], answer: 'Active application of concepts' },
                { type: 'mcq', question: 'The total number of lessons for this course is:', options: ['1', '5', '8', count.toString()], answer: count.toString() },
            ];

            return {
                id: i + 1,
                title: lessonTitle,
                duration: `${40 + Math.floor(Math.random() * 20)} min`, // Varied duration
                content: content,
                quiz: simpleQuiz,
            };
        });
    };
    
    // --- DETAILED COMPUTER SCIENCE COURSE CONTENT (CS101) ---
    const cs101Lessons = [
        { 
            id: 1, 
            title: 'Introduction to Programming', 
            duration: '45 min', 
            content: `
                <h2>The Foundation: Logic and Code</h2>
                <p>Programming is the art of giving a computer a set of precise instructions. In this lesson, we'll establish the key elements of computational thinking.</p>
                
                <h3>Algorithms and Pseudocode</h3>
                <p>An <strong>algorithm</strong> is a finite sequence of well-defined, computer-implementable instructions. Before coding, we often use **pseudocode** (a plain language description of the steps).</p>
                <p><strong>Example: Pseudocode to Check a User's Age:</strong></p>
                <pre><code>1. FUNCTION checkAge(age):
2.    IF age >= 18 THEN
3.       PRINT "Access Granted"
4.    ELSE
5.       PRINT "Access Denied"
6.    END IF
7. END FUNCTION</code></pre>

                <h3>Variables and Fundamental Data Types</h3>
                <p>Variables store data. Data types define the constraints on that data. **Integer** ($1, 2, 3$), **Float** ($3.14$), **Boolean** (True/False), and **String** ($\text{"text"}$) are essential.</p>
                <pre><code># Python Example: Variable Assignment
user_name = "Elvion Student" # String
score = 95                   # Integer
is_eligible = (score >= 90)  # Boolean</code></pre>
                
                <h3>Control Flow: If/Else</h3>
                <p>The **if/else** statement allows the program to make decisions based on conditions. This is the simplest form of control flow, directing the execution path.</p>
            `,
            quiz: [
                { type: 'mcq', question: 'What is Pseudocode primarily used for?', options: ['Writing final executable code', 'A high-level, human-readable description of an algorithm', 'Encrypting data', 'Generating binary files'], answer: 'A high-level, human-readable description of an algorithm' },
                { type: 'mcq', question: 'Which data type is best suited to represent a whole number of items?', options: ['String', 'Float', 'Boolean', 'Integer'], answer: 'Integer' },
            ]
        },
        { 
            id: 2, 
            title: 'Looping and Iteration', 
            duration: '60 min', 
            content: `
                <h2>Repeating Actions: Loops</h2>
                <p>Loops are fundamental to programming, allowing a set of instructions to be executed repeatedly. This saves time and makes code efficient.</p>

                <h3>For Loops</h3>
                <p>A **For Loop** is typically used when you know the number of iterations in advance (e.g., iterating over a list of items).</p>
                <pre><code># Python For Loop Example
fruits = ["apple", "banana", "cherry"]
for item in fruits:
    print("I like " + item)

# Output:
# I like apple
# I like banana
# I like cherry</code></pre>

                <h3>While Loops</h3>
                <p>A **While Loop** executes as long as a specified condition is true. It is critical to ensure the condition eventually becomes false to prevent an **infinite loop**.</p>
                <pre><code># Python While Loop Example
count = 0
while count < 3:
    print("Count is:", count)
    count = count + 1 # Crucial step to avoid infinite loop</code></pre>

                <h3>Nested Loops</h3>
                <p>Using one loop inside another is called a **nested loop**. This is common for working with 2D data structures like matrices or drawing patterns.</p>
            `,
            quiz: [
                { type: 'mcq', question: 'Which type of loop should you use when you know exactly how many times you need to repeat an action?', options: ['Infinite Loop', 'While Loop', 'For Loop', 'Conditional Loop'], answer: 'For Loop' },
                { type: 'mcq', question: 'What is the term for a loop that never terminates because its condition remains true?', options: ['Nested Loop', 'Endless Execution', 'Infinite Loop', 'Break Loop'], answer: 'Infinite Loop' },
            ]
        },
        { 
            id: 3, 
            title: 'Data Structures: Lists and Dictionaries', 
            duration: '55 min', 
            content: `
                <h2>Organizing Data for Efficiency</h2>
                <p>Effective programming requires more than variables; it requires organized storage. **Data Structures** provide this organization.</p>
                
                <h3>Lists (Arrays)</h3>
                <p>Lists are ordered, changeable collections of items, accessed by a numerical **index** starting at **0**. They are excellent for sequences.</p>
                <pre><code># Python List Example
names = ["Alice", "Bob", "Charlie"]
print(names[0]) # Output: Alice
names.append("David") # Adds David to the end</code></pre>

                <h3>Dictionaries (Key-Value Pairs)</h3>
                <p>Dictionaries store data in **key-value pairs**, which allows for extremely fast lookups using the key. They are unordered collections.</p>
                <pre><code># Python Dictionary Example
student_info = {
    "id": 101,
    "course": "CS101",
    "grade": "A"
}
print(student_info["course"]) # Output: CS101</code></pre>
                
                <h3>Comparing Structures</h3>
                <div class="interactive-code-area">
                    <div class="area-header"><span>List vs. Dictionary</span></div>
                    <p>A list is best for a collection of *similar* items where order matters (e.g., a queue). A dictionary is best for storing *attributes* of a single entity (e.g., a user's profile).</p>
                    <div class="output">Concept: Choose the right tool for the data!</div>
                </div>
            `,
            quiz: [
                { type: 'mcq', question: 'Which data structure allows you to look up data using a descriptive name instead of an index number?', options: ['List', 'Array', 'String', 'Dictionary'], answer: 'Dictionary' },
                { type: 'mcq', question: 'What is the index of the very first element in most programming language arrays/lists?', options: ['1', '0', '-1', 'The length of the list'], answer: '0' },
            ]
        },
        { 
            id: 4, 
            title: 'Functions and Modularity', 
            duration: '50 min', 
            content: `
                <h2>Building Blocks of Programs: Functions</h2>
                <p>A **function** is a block of organized, reusable code that is used to perform a single, related action. They are key to writing clean, modular code.</p>

                <h3>Defining and Calling Functions</h3>
                <p>A function must be **defined** (given a name and body) before it can be **called** (executed).</p>
                <pre><code># Python Function Definition
def greet(name):
    return "Hello, " + name + "!"

# Function Call
message = greet("Elvion")
print(message) # Output: Hello, Elvion!</code></pre>

                <h3>Parameters and Return Values</h3>
                <p>Functions can accept **parameters** (inputs) and can produce a **return value** (output). Functions that don't explicitly return a value usually return a default $\text{null}$ or $\text{None}$ value.</p>
                
                <h3>Modularity</h3>
                <p>Modularity means breaking a large program into smaller, manageable, independent functions. This makes the code easier to test, debug, and reuse.</p>
            `,
            quiz: [
                { type: 'mcq', question: 'What is the main benefit of using functions in programming?', options: ['Increasing file size', 'Making the code harder to read', 'Writing reusable and modular code', 'Removing variables'], answer: 'Writing reusable and modular code' },
                { type: 'mcq', question: 'A value given to a function when it is called is known as a:', options: ['Return Value', 'Variable Type', 'Parameter', 'Global State'], answer: 'Parameter' },
            ]
        },
        { 
            id: 5, 
            title: 'Object-Oriented Programming (OOP) I', 
            duration: '60 min', 
            content: `
                <h2>OOP: Classes and Objects</h2>
                <p>Object-Oriented Programming (OOP) is a paradigm centered around **objects**, which are instances of **classes**. This approach mimics the real world, where objects have attributes and behaviors.</p>

                <h3>Classes vs. Objects</h3>
                <ul>
                    <li>**Class:** The blueprint or template (e.g., the concept of a "Car").</li>
                    <li>**Object:** A specific instance of a class (e.g., a "Red Toyota Yaris" made in 2023).</li>
                </ul>
                <pre><code># Python Class Example
class Student:
    # Constructor/Initializer
    def __init__(self, name, id):
        self.name = name # Attribute
        self.id = id     # Attribute
        
    # Method (Behavior)
    def get_details(self):
        return f"{self.name}, ID: {self.id}"

# Creating an Object (Instantiation)
student1 = Student("Alex", 550)
print(student1.get_details()) # Output: Alex, ID: 550</code></pre>

                <h3>Encapsulation</h3>
                <p>Encapsulation is the principle of bundling the data (attributes) and the methods (behaviors) that operate on the data into a single unit (the class). This is often used to hide the internal state of an object from the outside world.</p>
            `,
            quiz: [
                { type: 'mcq', question: 'In OOP, what is a specific instance created from a class template?', options: ['Method', 'Blueprint', 'Object', 'Function'], answer: 'Object' },
                { type: 'mcq', question: 'The principle of combining data and the methods that act on the data is known as:', options: ['Polymorphism', 'Inheritance', 'Abstraction', 'Encapsulation'], answer: 'Encapsulation' },
            ]
        },
        { 
            id: 6, 
            title: 'OOP II: Inheritance and Polymorphism', 
            duration: '50 min', 
            content: `
                <h2>The Pillars of Advanced OOP</h2>
                <p>Two more core concepts of OOP are **Inheritance** (creating a hierarchy) and **Polymorphism** (allowing different objects to respond to the same message in their own way).</p>

                <h3>Inheritance</h3>
                <p>Inheritance allows a new class (the **child** or **subclass**) to inherit properties and methods from an existing class (the **parent** or **superclass**). This promotes code reuse and creates an "is-a" relationship (e.g., a $\text{Dog}$ is a type of $\text{Animal}$).</p>
                <pre><code>class Animal:
    def speak(self):
        pass # Base method

class Dog(Animal):
    def speak(self):
        return "Woof!" # Dog overrides the base method</code></pre>

                <h3>Polymorphism (Many Forms)</h3>
                <p>Polymorphism means 'many forms.' It allows a single interface or method to be used for different data types or classes. The example above, where `speak()` is used differently by `Animal` and `Dog`, is a basic form of polymorphism (method overriding).</p>
                
                <h3>Abstraction</h3>
                <p>Abstraction is hiding the complex implementation details and only showing the necessary information to the user.</p>
            `,
            quiz: [
                { type: 'mcq', question: 'Which OOP concept allows a subclass to take on the attributes and methods of a parent class?', options: ['Polymorphism', 'Encapsulation', 'Inheritance', 'Abstraction'], answer: 'Inheritance' },
                { type: 'mcq', question: 'The concept of "Polymorphism" literally translates to:', options: ['Single Form', 'Many Forms', 'Hidden Form', 'Encapsulated Form'], answer: 'Many Forms' },
            ]
        },
        { 
            id: 7, 
            title: 'The Role of Databases in Computing', 
            duration: '40 min', 
            content: `
                <h2>Persistent Data Storage</h2>
                <p>For data to persist beyond a program's execution, it must be stored in a **Database**. We focus on **Relational Databases (SQL)**, which organize data into structured tables.</p>

                <h3>Structured Query Language (SQL)</h3>
                <p>SQL is the standard language for managing relational databases. You must master the basic operations: $\text{SELECT}$ (Read), $\text{INSERT}$ (Create), $\text{UPDATE}$ (Update), and $\text{DELETE}$ (Delete).</p>
                <pre><code>-- SQL Example: Retrieving Data
SELECT name, course_grade 
FROM Students 
WHERE course = 'CS101' 
ORDER BY course_grade DESC;</code></pre>

                <h3>NoSQL vs. SQL</h3>
                <ul>
                    <li>**SQL (Relational):** Strict schema, best for complex transactions and data integrity (e.g., banking systems).</li>
                    <li>**NoSQL (Non-Relational):** Flexible schema, better for massive scale and fast retrieval of unstructured data (e.g., social media feeds).</li>
                </ul>
            `,
            quiz: [
                { type: 'mcq', question: 'Which SQL command is used to retrieve data from a table?', options: ['UPDATE', 'INSERT', 'CREATE', 'SELECT'], answer: 'SELECT' },
                { type: 'mcq', question: 'The main characteristic of a NoSQL database is:', options: ['Strict adherence to tables and rows', 'Flexible, non-relational schema', 'The use of the Python language', 'Slow data retrieval'], answer: 'Flexible, non-relational schema' },
            ]
        },
        { 
            id: 8, 
            title: 'Final Year Project & Degree Path', 
            duration: '120 min', 
            content: `
                <h2>Final Project: Putting It All Together</h2>
                <p class="lead" style="color: var(--warning-color);">This lesson prepares you for your final project, which must be submitted to Elvion to receive your certificate.</p>
                
                <h3>The Project Goal: Simple To-Do Application</h3>
                <p>Your goal is to build a complete, functional software solution (using a language like Python) for a **Simple Command-Line To-Do List Application** that demonstrates the concepts learned in lessons 1-7.</p>
                
                <h4>Required Concepts to Implement:</h4>
                <ul>
                    <li>**Functions (Lesson 4):** Define functions to $\text{add\_task}$, $\text{view\_tasks}$, and $\text{mark\_complete}$.</li>
                    <li>**Data Structure (Lesson 3):** Use a Python $\text{List}$ to store the tasks and use a $\text{Dictionary}$ to represent each task (e.g., $\text{\{"title": "Task A", "done": False\}}$).</li>
                    <li>**Control Flow (Lesson 2):** Use $\text{while}$ loops for the main application menu and $\text{if/else}$ for user input validation.</li>
                    <li>**Modularity (Lesson 4):** Structure your code logically into separate functions.</li>
                </ul>

                <h3>Submission Guidelines (Crucial)</h3>
                <ol>
                    <li>**The Code:** The complete source code (in a GitHub repository or a single .zip file).</li>
                    <li>**The Documentation:** A 1-page PDF or Markdown file detailing the project goal, which concepts you implemented, and a **brief reflection** on what you learned in the course.</li>
                </ol>
                <p style="color: var(--cyan-glow); font-weight: bold;">**Submit BOTH of these items to: elvionailabs@gmail.com** after filling out the certificate form on the next page. Use the subject line: "CS101 Final Project: [Your Name]".</p>
            `,
            quiz: [
                { type: 'mcq', question: 'The CS101 final project requires using a List for tasks and a Dictionary for each task entry. What is the benefit of this combination?', options: ['Speeding up the computer', 'Combining ordered storage (List) with key-based lookup (Dictionary)', 'Only learning one data structure', 'It is only for web apps'], answer: 'Combining ordered storage (List) with key-based lookup (Dictionary)' },
                { type: 'text', question: 'What is the email address to which you must submit your project for certificate review? (Enter exactly)', answer: 'elvionailabs@gmail.com' },
            ]
        }
    ];
    
    // --- NEW DETAILED SOFTWARE ENGINEERING COURSE CONTENT (SE101) ---
    const se101Lessons = [
        {
            id: 1, 
            title: 'Foundations of Software Engineering', 
            duration: '50 min', 
            content: `
                <h2>The Difference: Programming vs. Engineering</h2>
                <p><strong>Software Engineering (SE)</strong> is the discipline for building and maintaining software systems that are reliable, efficient, and scalable. It is about applying established engineering principles to software development, especially for large teams and projects.</p>
                
                <h3>The Software Development Life Cycle (SDLC)</h3>
                <p>The SDLC is the backbone of all major projects. It defines the stages from initial idea to maintenance.</p>
                <ol>
                    <li>**Planning:** Defining scope, resources, and goals.</li>
                    <li>**Analysis (Requirements):** Gathering and documenting functional and non-functional needs.</li>
                    <li>**Design:** Defining architecture, modules, interfaces, and data.</li>
                    <li>**Implementation (Coding):** Writing the software.</li>
                    <li>**Testing:** Verifying the product meets the requirements.</li>
                    <li>**Deployment & Maintenance:** Releasing and supporting the software.</li>
                </ol>

                <h3>Functional vs. Non-Functional Requirements</h3>
                <ul>
                    <li>**Functional:** What the system *must* do (e.g., $\text{The system must allow a user to log in}$).</li>
                    <li>**Non-Functional:** How the system *should* be (e.g., $\text{The system must load pages in under 2 seconds}$ - a **Performance** requirement).</li>
                </ul>
            `,
            quiz: [
                { type: 'mcq', question: 'Which type of requirement defines a constraint on the system, such as its security or speed?', options: ['Functional', 'Business', 'Non-Functional', 'Design'], answer: 'Non-Functional' },
                { type: 'mcq', question: 'In the SDLC, what is the stage where the architecture and modules are defined?', options: ['Planning', 'Implementation', 'Design', 'Testing'], answer: 'Design' },
            ]
        },
        { 
            id: 2, 
            title: 'Software Development Methodologies', 
            duration: '65 min', 
            content: `
                <h2>How Teams Build Software: Agile and Waterfall</h2>
                <p>Choosing the right development model is crucial for project success. Methodologies are frameworks for managing the SDLC.</p>
                
                <h3>The Waterfall Model (Sequential)</h3>
                <p>Each phase must be 100% complete before the next phase begins. It is rigid, making it simple to manage but extremely poor at handling requirement changes late in the cycle.</p>

                <h3>Agile Methodologies (Iterative)</h3>
                <p>Agile is a set of principles prioritizing flexibility, customer collaboration, and delivering working software frequently. **Scrum** and **Kanban** are the most popular frameworks based on Agile principles.</p>
                <ul>
                    <li>**Scrum:** Uses short cycles called **Sprints** (usually 2-4 weeks). Includes daily **Scrum meetings** (daily standups) and a **Product Backlog** (prioritized features list).</li>
                    <li>**Kanban:** A visual system focusing on continuous delivery and limiting **Work In Progress (WIP)** to maintain flow.</li>
                </ul>
                <pre><code>// Agile Manifesto Principle:
// Working software over comprehensive documentation.</code></pre>
            `,
            quiz: [
                { type: 'mcq', question: 'In the Scrum framework, what is the term for a short, fixed-length period during which a specific set of work is completed?', options: ['Marathon', 'Sprint', 'Standup', 'Phase'], answer: 'Sprint' },
                { type: 'mcq', question: 'The biggest risk of using the Waterfall model is:', options: ['The code is too fast', 'Difficulty in accommodating changes after requirements are frozen', 'Lack of documentation', 'Too many meetings'], answer: 'Difficulty in accommodating changes after requirements are frozen' },
            ]
        },
        { 
            id: 3, 
            title: 'Design Principles and Patterns', 
            duration: '50 min', 
            content: `
                <h2>Building Maintainable and Flexible Code</h2>
                <p>Software design is about anticipating change. **Design Principles** and **Design Patterns** help us create resilient architectures.</p>

                <h3>SOLID Principles (The Five Pillars)</h3>
                <p>The SOLID principles are a mnemonic acronym for five design principles intended to make software designs more understandable, flexible, and maintainable:</p>
                <ol>
                    <li>**S**ingle-Responsibility Principle (SRP): A class should have only one reason to change.</li>
                    <li>**O**pen-Closed Principle (OCP): Software entities should be open for extension, but closed for modification.</li>
                    <li>**L**iskov Substitution Principle (LSP).</li>
                    <li>**I**nterface Segregation Principle (ISP).</li>
                    <li>**D**ependency Inversion Principle (DIP).</li>
                </ol>

                <h3>Common Design Patterns</h3>
                <ul>
                    <li>**Singleton:** Ensures only one instance of a class exists (useful for global configuration managers).</li>
                    <li>**Factory:** Provides a centralized way to create objects without specifying their exact class.</li>
                </ul>
            `,
            quiz: [
                { type: 'mcq', question: 'Which SOLID principle states that a class should have only one reason to change?', options: ['OCP', 'LSP', 'SRP', 'DIP'], answer: 'SRP' },
                { type: 'mcq', question: 'A Design Pattern is best described as:', options: ['A final code block ready to copy-paste', 'A reusable solution template for a common design problem', 'A type of operating system', 'A programming language feature'], answer: 'A reusable solution template for a common design problem' },
            ]
        },
        { 
            id: 4, 
            title: 'Testing and Deployment', 
            duration: '45 min', 
            content: `
                <h2>Verifying Quality and Going Live</h2>
                <p>Testing ensures the software works as intended and is critical for quality. **Deployment** is the process of making the system available for use.</p>

                <h3>Testing Hierarchy</h3>
                <ol>
                    <li>**Unit Testing:** Tests individual components (functions/methods).</li>
                    <li>**Integration Testing:** Tests how components interact with each other and external systems (like a database).</li>
                    <li>**System Testing:** Tests the complete and integrated software against the requirements.</li>
                    <li>**User Acceptance Testing (UAT):** The client/end-user confirms the system meets their business needs.</li>
                </ol>
                
                <h3>Version Control (Git)</h3>
                <p>**Git** is the industry standard for version control. It allows multiple developers to work on the same code without conflicts and tracks every change. The core cycle is: $\text{git pull}$, $\text{code}$, $\text{git add}$, $\text{git commit}$, $\text{git push}$.</p>
            `,
            quiz: [
                { type: 'mcq', question: 'Which phase of testing is performed by the end-user or client to validate the system against their needs?', options: ['Unit Testing', 'System Testing', 'Integration Testing', 'User Acceptance Testing (UAT)'], answer: 'User Acceptance Testing (UAT)' },
                { type: 'mcq', question: 'In the Git version control system, what is the purpose of the "commit" operation?', options: ['To download code from the server', 'To push code to the server', 'To record a snapshot of the changes to the local repository', 'To fix a bug'], answer: 'To record a snapshot of the changes to the local repository' },
            ]
        },
        { 
            id: 5, 
            title: 'Final Project: SE Design Document', 
            duration: '90 min', 
            content: `
                <h2>Software Engineering Capstone</h2>
                <p class="lead" style="color: var(--warning-color);">The final lesson requires the creation of a **Design Document Project**. This is the non-coding deliverable mandatory for your certificate.</p>
                
                <h3>Project Goal: Create a Software Design Document (SDD)</h3>
                <p>You will **design** the solution for a new software product (e.g., a simple peer-to-peer file sharing application). The focus is on the *engineering* and documentation process, not the coding.</p>
                
                <h4>Required Sections in Your Document (PDF or Markdown):</h4>
                <ol>
                    <li>**Requirements:** List at least 5 Functional and 3 Non-Functional Requirements (Lesson 1).</li>
                    <li>**Methodology:** State and justify your choice of SDLC methodology (Agile/Scrum or Waterfall) (Lesson 2).</li>
                    <li>**Architecture/Design:** Describe the major components and name at least two **Design Patterns** you would use, explaining why (Lesson 3).</li>
                    <li>**Testing Plan:** Outline the approach for Unit Testing and UAT, including key test scenarios (Lesson 4).</li>
                </ol>

                <h3>Submission Guidelines (Crucial)</h3>
                <p style="color: var(--cyan-glow); font-weight: bold;">**Submit your Final Design Document to: elvionailabs@gmail.com** after filling out the certificate form on the next page. Use the subject line: "SE101 Final Project: [Your Name]".</p>
            `,
            quiz: [
                { type: 'mcq', question: 'For the SE101 Final Project, what is the core deliverable that proves your understanding of SE principles?', options: ['A fully deployed application', 'A detailed Software Design Document', 'A recorded video presentation', '1000 lines of bug-free code'], answer: 'A detailed Software Design Document' },
                { type: 'text', question: 'What is the subject line required for your final project submission email to Elvion? (Enter exactly, use "Jane Doe" as a placeholder name)', answer: 'SE101 Final Project: Jane Doe' },
            ]
        }
    ];

    
    // Assembling all courses
    const allCourses = [
      { id: 'cs101', title: 'Computer Science', description: 'Fundamentals of computing, programming, and algorithms. (Project Required)', icon: 'fas fa-laptop-code', totalLessons: 8, estimatedHours: 120, mediaType: 'video', lessons: cs101Lessons },
      // NEW SOFTWARE ENGINEERING COURSE
      { id: 'se101', title: 'Software Engineering', description: 'Design, develop, and maintain large-scale software systems. (Project Required)', icon: 'fas fa-cogs', totalLessons: 5, estimatedHours: 80, mediaType: 'video', lessons: se101Lessons },
      // OTHER COURSES WITH GENERATED PLACEHOLDERS
      { id: 'law101', title: 'Law (LLB)', description: 'Comprehensive study of legal principles and practice.', icon: 'fas fa-balance-scale', totalLessons: 6, estimatedHours: 90, mediaType: 'video', lessons: generateDefaultLessons(6, 'LAW', false) },
      { id: 'eng101', title: 'English & Literary Studies', description: 'Study of English language, literature, and critical analysis.', icon: 'fas fa-pen-nib', totalLessons: 4, estimatedHours: 60, mediaType: 'audio', lessons: generateDefaultLessons(4, 'ENG', false) },
      { id: 'his101', title: 'History & Strategic Studies', description: 'World history, Nigerian history, and strategic studies.', icon: 'fas fa-globe-africa', totalLessons: 5, estimatedHours: 75, mediaType: 'audio', lessons: generateDefaultLessons(5, 'HIS', false) },
      { id: 'bus101', title: 'Business Administration', description: 'Principles of management, marketing, finance, and entrepreneurship. (Project Required)', icon: 'fas fa-chart-line', totalLessons: 7, estimatedHours: 100, mediaType: 'audio', lessons: generateDefaultLessons(7, 'BUS', true) },
      { id: 'mass101', title: 'Mass Communication', description: 'Journalism, public relations, broadcasting, and digital media communication.', icon: 'fas fa-bullhorn', totalLessons: 6, estimatedHours: 90, mediaType: 'audio', lessons: generateDefaultLessons(6, 'MASS', false) },
      { id: 'mated101', title: 'Mathematics Education', description: 'Methods and strategies for teaching mathematics.', icon: 'fas fa-calculator', totalLessons: 5, estimatedHours: 70, mediaType: 'audio', lessons: generateDefaultLessons(5, 'MATED', false) },
      { id: 'adulte101', title: 'Adult Education', description: 'Teaching and learning strategies for adult learners.', icon: 'fas fa-chalkboard-teacher', totalLessons: 4, estimatedHours: 60, mediaType: 'audio', lessons: generateDefaultLessons(4, 'ADULT', false) },
      { 
          id: 'visuarts101', 
          title: 'Visual Arts & Digital Media', 
          description: 'A study of animation, painting, graphic design, and digital art. (Project Required)', 
          icon: 'fas fa-palette', 
          totalLessons: 6, 
          estimatedHours: 95, 
          mediaType: 'video', 
          lessons: generateDefaultLessons(6, 'VA', true) 
      },
    ];

    let currentUser = null;
    let userData = null;
    let currentCourse = null;
    let currentLesson = 1;
    let totalLessons = 0;
    let quizPassed = false; // New state to track if quiz is passed for navigation

    // URL Parameters
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('courseId');
    const lessonParam = urlParams.get('lesson');

    // ... (DOM Content Loaded and Star Animation code remains the same)

    // Mobile Menu Toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const courseSidebar = document.getElementById('courseSidebar');

    mobileMenuToggle.addEventListener('click', () => {
      courseSidebar.classList.toggle('active');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 992) {
        if (!courseSidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) {
          courseSidebar.classList.remove('active');
        }
      }
    });

    // Auth State Management
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
        await initializeCourseViewer();
      } else {
        // FIXED REDIRECT: Redirect to enrollment page if not logged in
        window.location.href = 'enroll.html'; 
      }
    });

    async function loadUserData() {
      try {
        const userDocRef = doc(db, 'users', currentUser.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          userData = userDoc.data();
          // Ensure totalPoints exists for new users
          if (userData.totalPoints === undefined) {
              userData.totalPoints = 0;
              await updateDoc(userDocRef, { totalPoints: 0 });
          }
        } else {
          // FIXED REDIRECT: Redirect to dashboard (or enrollment flow) if user data is missing
          window.location.href = 'studyingatelvion.html'; 
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        alert('Error loading user data. Please try again.');
      }
    }

    async function initializeCourseViewer() {
      if (!courseId) {
        alert('No course specified');
        // FIXED REDIRECT
        window.location.href = 'studyingatelvion.html';
        return;
      }

      currentCourse = findCourseById(courseId);
      if (!currentCourse) {
        alert('Course not found');
        // FIXED REDIRECT
        window.location.href = 'studyingatelvion.html';
        return;
      }

      totalLessons = currentCourse.totalLessons;
      currentLesson = parseInt(lessonParam) || 1;

      // Check if user is enrolled
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      if (!enrolledCourse) {
        alert('You are not enrolled in this course');
        // FIXED REDIRECT
        window.location.href = 'studyingatelvion.html';
        return;
      }

      setupCourseInterface();
      renderLessonsList();
      loadLesson(currentLesson);
      
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('contentHeader').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'block';
      document.getElementById('lessonNavigation').style.display = 'flex';
    }

    function findCourseById(courseId) {
      return allCourses.find(c => c.id === courseId);
    }

    function setupCourseInterface() {
      document.getElementById('courseIconLarge').className = `course-icon-large ${currentCourse.icon}`;
      document.getElementById('courseTitle').textContent = currentCourse.title;
      document.getElementById('courseSubtitle').textContent = currentCourse.description;
      
      // Populate Certificate Form details
      document.getElementById('formSubject').value = `Certificate Request: ${currentCourse.title}`;
      document.getElementById('completedCourseName').value = currentCourse.title;

      updateOverallProgress();
    }

    function updateOverallProgress() {
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const progress = enrolledCourse?.progress || 0;
      const completedLessons = enrolledCourse?.completedLessons?.length || 0;
      
      document.getElementById('overallProgressBar').style.width = `${progress}%`;
      document.getElementById('overallProgressText').textContent = `${progress}% Complete (${completedLessons}/${totalLessons} lessons)`;
      
      // Update Total Points for GP (sidebar and nav)
      document.getElementById('totalPointsEarnedSidebar').textContent = userData.totalPoints || 0;
      document.getElementById('totalPointsEarnedNav').textContent = userData.totalPoints || 0;
      document.getElementById('formTotalPoints').value = userData.totalPoints || 0;
      document.getElementById('finalTotalPoints').textContent = userData.totalPoints || 0;
    }

    function renderLessonsList() {
      const container = document.getElementById('lessonsContainer');
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const completedLessons = enrolledCourse?.completedLessons || [];
      
      container.innerHTML = '';
      
      currentCourse.lessons.forEach((lesson) => {
        const lessonNumber = lesson.id;
        const isCompleted = completedLessons.includes(lessonNumber);
        const isCurrent = lessonNumber === currentLesson;
        const isAccessible = lessonNumber <= (enrolledCourse?.currentLesson || 1);
        
        const lessonItem = document.createElement('div');
        lessonItem.className = `lesson-item ${isCurrent ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
        
        let statusIcon, statusClass;
        if (isCompleted) {
          statusIcon = '<i class="fas fa-check"></i>';
          statusClass = 'completed';
        } else if (isCurrent) {
          statusIcon = lessonNumber;
          statusClass = 'current';
        } else if (isAccessible) {
          statusIcon = lessonNumber;
          statusClass = ''; // Accessible but not current/completed
        } else {
          statusIcon = '<i class="fas fa-lock"></i>';
          statusClass = 'locked';
        }
        
        lessonItem.innerHTML = `
          <div class="lesson-status ${statusClass}">${statusIcon}</div>
          <div class="lesson-details">
            <div class="lesson-title">${lesson.title}</div>
            <div class="lesson-duration">${lesson.duration}</div>
          </div>
        `;
        
        if (isAccessible) {
          lessonItem.style.cursor = 'pointer';
          lessonItem.addEventListener('click', () => {
            if (lessonNumber !== currentLesson) {
              loadLesson(lessonNumber);
              courseSidebar.classList.remove('active'); // Close on mobile navigation
            }
          });
        } else {
          lessonItem.style.opacity = '0.5';
          lessonItem.style.cursor = 'not-allowed';
        }
        
        container.appendChild(lessonItem);
      });
      
      // Add the final certificate page link
      if (enrolledCourse?.progress === 100) {
          const finalItem = document.createElement('div');
          finalItem.className = `lesson-item ${currentLesson === totalLessons + 1 ? 'active' : ''}`;
          finalItem.style.borderLeftColor = 'var(--success-color)';
          finalItem.innerHTML = `
            <div class="lesson-status completed" style="background: var(--success-color);"><i class="fas fa-certificate"></i></div>
            <div class="lesson-details">
                <div class="lesson-title" style="color: var(--success-color); font-weight: 700;">Final Exam/Certificate</div>
                <div class="lesson-duration">Your Course GP is Ready</div>
            </div>
          `;
          finalItem.style.cursor = 'pointer';
          finalItem.addEventListener('click', () => {
             loadLesson(totalLessons + 1);
             courseSidebar.classList.remove('active'); // Close on mobile navigation
          });
          container.appendChild(finalItem);
      }
    }

    function loadLesson(lessonNumber) {
      currentLesson = lessonNumber;
      // Re-check quiz passed state from user data, or set to false if not completed
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const isCompleted = enrolledCourse?.completedLessons?.includes(currentLesson);
      quizPassed = isCompleted || false; 
      
      // Update URL without reloading
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('lesson', lessonNumber);
      window.history.pushState({}, '', newUrl);
      
      // Hide all main content elements first
      document.getElementById('finalCoursePage').style.display = 'none';
      document.getElementById('contentHeader').style.display = 'flex';
      document.getElementById('lessonNavigation').style.display = 'flex';
      const contentCard = document.querySelector('.content-card');
      const quizContainer = document.getElementById('quizContainer');
      const mediaPlayer = document.getElementById('mediaPlayer');
      
      contentCard.style.display = 'block';
      mediaPlayer.style.display = 'flex';
      
      if (currentLesson === totalLessons + 1) {
          // Final Page Logic
          document.getElementById('contentHeader').style.display = 'none';
          document.getElementById('lessonNavigation').style.display = 'none';
          document.getElementById('finalCoursePage').style.display = 'block';
          contentCard.style.display = 'none';
          quizContainer.style.display = 'none';
          mediaPlayer.style.display = 'none';
          
          updateOverallProgress(); // Refresh GP
      } else {
          // Lesson Page Logic
          const lesson = currentCourse.lessons.find(l => l.id === lessonNumber);
          if (!lesson) return;

          // Update header
          document.getElementById('lessonTitle').textContent = lesson.title;
          document.getElementById('lessonDuration').textContent = lesson.duration;
          document.getElementById('currentLessonNumber').textContent = lessonNumber;
          document.getElementById('totalLessons').textContent = totalLessons;
          document.getElementById('lessonPoints').textContent = '10'; 
          document.getElementById('markCompleteBtn').style.display = 'none'; 
          
          // Update navigation
          document.getElementById('navCurrentLesson').textContent = lessonNumber;
          document.getElementById('navTotalLessons').textContent = totalLessons;
          
          // Update content
          document.getElementById('lessonContent').innerHTML = lesson.content;

          // Update media player
          const mediaPlaceholderText = document.getElementById('mediaPlaceholderText');
          const mediaIcon = mediaPlayer.querySelector('i');
          
          // Simple logic to show video or audio controls
          if (currentCourse.mediaType === 'audio') {
            mediaPlayer.innerHTML = `
                <audio controls style="width:90%; height: 50px; outline:none; border-radius:10px; box-shadow:0 0 8px var(--cyan-glow); background: rgba(0, 0, 0, 0.5);">
                    <source src="university/generic_audio.mp3" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            `;
          } else { 
            mediaPlayer.innerHTML = `
              <div class="media-placeholder">
                <i class="fas fa-play-circle"></i>
                <p id="mediaPlaceholderText">Video content coming soon</p>
                <p style="font-size: 0.9rem; opacity: 0.7;">For now, please read the lesson content below</p>
              </div>
            `;
          }

          // Render Quiz
          if (lesson.quiz && lesson.quiz.length > 0) {
            quizContainer.style.display = 'block';
            renderQuiz(lesson.quiz);
          } else {
            quizContainer.style.display = 'none';
          }
      }
      
      // Update navigation buttons and state
      updateNavigationControls();
      
      // Update sidebar
      renderLessonsList();
      
      // Scroll to top
      window.scrollTo(0, 0);
    }

    function updateNavigationControls() {
      const prevBtn = document.getElementById('prevLessonBtn');
      const nextBtn = document.getElementById('nextLessonBtn');
      const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
      const isCompleted = enrolledCourse?.completedLessons?.includes(currentLesson);
      const isCourseFullyCompleted = enrolledCourse?.progress === 100;

      // Previous Button Logic
      prevBtn.disabled = currentLesson <= 1;
      
      // Next Button Logic
      if (currentLesson === totalLessons) {
          nextBtn.textContent = 'Final Exam/Certificate';
          // Enable only if all lessons are completed (progress 100%)
          nextBtn.disabled = !isCourseFullyCompleted; 
      } else if (currentLesson === totalLessons + 1) {
          // On Final Page, next is always disabled
          nextBtn.textContent = 'Course Completed';
          nextBtn.disabled = true;
      } else if (isCompleted || quizPassed) {
          nextBtn.textContent = 'Next Lesson';
          nextBtn.disabled = false;
      } else {
          nextBtn.textContent = 'Pass Quiz to Unlock';
          nextBtn.disabled = true;
      }
    }
    
    // --- QUIZ LOGIC (With Animation and Per-Question Feedback) ---

    function renderQuiz(quizData) {
        const quizQuestionsContainer = document.getElementById('quizQuestions');
        quizQuestionsContainer.innerHTML = '';
        document.getElementById('quizResult').innerHTML = ''; // Clear result area
        document.getElementById('submitQuizBtn').style.display = 'block';
        
        const isLessonCompleted = userData.enrolledCourses?.find(c => c.courseId === courseId)?.completedLessons?.includes(currentLesson);
        
        quizData.forEach((q, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'quiz-question-wrapper';
            
            let optionsHtml = '';
            if (q.type === 'mcq') {
                optionsHtml = q.options.map(option => {
                    // Disable clicks if already completed to prevent class changes
                    return `<div class="quiz-option" data-answer="${option}" ${isLessonCompleted ? 'style="pointer-events: none; opacity: 0.7;"' : ''}>${option}</div>`;
                }).join('');
            } else if (q.type === 'text') {
                optionsHtml = `<input type="text" class="text-input-answer" placeholder="Type your answer here..." style="width: 100%; padding: 1rem; border-radius: 8px; border: 2px solid rgba(0, 255, 255, 0.3); background: rgba(0, 0, 0, 0.5); color: var(--text-color); font-size: 1rem;" ${isLessonCompleted ? 'disabled' : ''}>`;
            }

            questionElement.innerHTML = `
                <div class="quiz-question">Question ${index + 1}: ${q.question}</div>
                <div class="quiz-options" data-question-index="${index}">
                    ${optionsHtml}
                </div>
            `;
            quizQuestionsContainer.appendChild(questionElement);
        });

        // Add event listeners for MCQ selection only if not completed
        if (!isLessonCompleted) {
            quizQuestionsContainer.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    const optionsGroup = this.closest('.quiz-options');
                    // Deselect all others in the group, and clear feedback classes
                    optionsGroup.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
                    // Select the clicked one
                    this.classList.add('selected');
                });
            });
        }
        
        // Hide submit button if already passed
        if (isLessonCompleted) {
            document.getElementById('submitQuizBtn').style.display = 'none';
            document.getElementById('quizResult').innerHTML = `
                <div class="quiz-feedback correct">
                    <i class="fas fa-check-circle"></i> **Lesson Already Completed!** You earned the points for this lesson.
                </div>
            `;
        }
    }

    document.getElementById('submitQuizBtn').addEventListener('click', () => {
        const lesson = currentCourse.lessons.find(l => l.id === currentLesson);
        const quizData = lesson.quiz;
        let allCorrect = true;
        let score = 0;
        
        // Reset and evaluate
        quizData.forEach((q, index) => {
            const optionsGroup = document.querySelector(`.quiz-options[data-question-index="${index}"]`);
            let isCorrect = false;

            if (q.type === 'mcq') {
                const selectedOption = optionsGroup.querySelector('.quiz-option.selected');
                
                // Clear all result classes first
                optionsGroup.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('correct', 'incorrect'));

                if (selectedOption) {
                    if (selectedOption.dataset.answer === q.answer) {
                        isCorrect = true;
                        selectedOption.classList.add('correct');
                    } else {
                        selectedOption.classList.add('incorrect');
                        // Highlight the correct answer
                        optionsGroup.querySelector(`.quiz-option[data-answer="${q.answer}"]`)?.classList.add('correct');
                    }
                } else {
                    // User did not select an answer, fail and highlight correct answer
                    allCorrect = false; // Missing selection counts as incorrect
                    optionsGroup.querySelector(`.quiz-option[data-answer="${q.answer}"]`)?.classList.add('correct');
                }
            } else if (q.type === 'text') {
                const input = optionsGroup.querySelector('.text-input-answer');
                const userAnswer = input.value.trim().toLowerCase().replace(/[\s\.]/g, ''); // Normalise answer
                let correctAnswer = q.answer.trim().toLowerCase().replace(/[\s\.]/g, '');

                // Special case for project submission subject line: replace placeholder name before comparing
                if (q.question.includes('subject line required')) {
                    const placeholder = 'janedoe';
                    const actualNameInput = document.getElementById('fullName').value.trim().toLowerCase().replace(/\s/g, '');
                    // Compare with the expected format using a common placeholder
                    correctAnswer = correctAnswer.replace('janedoe', actualNameInput || 'janedoe');
                }
                
                if (userAnswer === correctAnswer) {
                    isCorrect = true;
                    input.style.border = `2px solid var(--success-color)`;
                } else {
                    input.style.border = `2px solid var(--error-color)`;
                    allCorrect = false;
                }
            }

            if (isCorrect) {
                score++;
            } else {
                allCorrect = false;
            }
        });

        const quizResultElement = document.getElementById('quizResult');
        const totalQuestions = quizData.length;
        
        if (allCorrect) {
            quizResultElement.innerHTML = `
                <div class="quiz-feedback correct">
                    <i class="fas fa-check-circle"></i> **Perfect Score!** You got ${score}/${totalQuestions} correct. Lesson unlocked!
                </div>
            `;
            // All correct! Mark lesson complete and show modal.
            markLessonComplete();
            document.getElementById('submitQuizBtn').style.display = 'none'; // Hide submit after passing
        } else {
            quizResultElement.innerHTML = `
                <div class="quiz-feedback incorrect">
                    <i class="fas fa-times-circle"></i> **Incorrect Answers.** Score: ${score}/${totalQuestions}. Please review the lesson and try again.
                </div>
            `;
            // Disable navigation controls if quiz failed
            quizPassed = false;
            updateNavigationControls();
        }
    });

    // --- END QUIZ LOGIC ---


    // Event Listeners
    document.getElementById('prevLessonBtn').addEventListener('click', () => {
      if (currentLesson === totalLessons + 1) {
          loadLesson(totalLessons); // Back from final page to last lesson
      } else if (currentLesson > 1) {
        loadLesson(currentLesson - 1);
      }
    });

    document.getElementById('nextLessonBtn').addEventListener('click', () => {
      if (currentLesson < totalLessons) {
        // This is only enabled if the lesson is completed/quiz is passed
        loadLesson(currentLesson + 1);
      } else if (currentLesson === totalLessons) {
          // Go to final page (Only enabled if progress is 100)
          const enrolledCourse = userData.enrolledCourses?.find(c => c.courseId === courseId);
          if (enrolledCourse?.progress === 100) {
              loadLesson(currentLesson + 1);
          }
      }
    });

    document.getElementById('continueBtn').addEventListener('click', () => {
      document.getElementById('completionModal').style.display = 'none';
      if (currentLesson < totalLessons) {
        loadLesson(currentLesson + 1);
      } else if (currentLesson === totalLessons) {
          loadLesson(currentLesson + 1); // Go to the final certificate page
      }
    });

    // FIXED REDIRECT: Corrected Dashboard Redirect
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
      window.location.href = 'studyingatelvion.html';
    });

    async function markLessonComplete() {
      try {
        const enrolledCourseIndex = userData.enrolledCourses.findIndex(c => c.courseId === courseId);
        if (enrolledCourseIndex === -1) return;
        
        const enrolledCourse = userData.enrolledCourses[enrolledCourseIndex];
        
        // Check for double completion (to prevent point inflation)
        let pointsEarned = 10;
        if (enrolledCourse.completedLessons?.includes(currentLesson)) {
            pointsEarned = 0; // Already earned points
        }

        // Add to completed lessons
        if (!enrolledCourse.completedLessons) {
            enrolledCourse.completedLessons = [];
        }
        if (pointsEarned > 0) {
            enrolledCourse.completedLessons.push(currentLesson);
        }
        
        // Update current lesson access: currentLesson + 1
        enrolledCourse.currentLesson = Math.max(enrolledCourse.currentLesson || 1, currentLesson + 1);
        
        // Calculate progress
        const completedCount = enrolledCourse.completedLessons.length;
        enrolledCourse.progress = Math.round((completedCount / totalLessons) * 100);
        
        // Update user data: GP/Points logic is here
        userData.enrolledCourses[enrolledCourseIndex] = enrolledCourse;
        if (pointsEarned > 0) {
            userData.completedLessons = (userData.completedLessons || 0) + 1;
            userData.totalPoints = (userData.totalPoints || 0) + pointsEarned; // 10 points per lesson
        }
        
        // Save to database
        await updateDoc(doc(db, 'users', currentUser.uid), {
          enrolledCourses: userData.enrolledCourses,
          completedLessons: userData.completedLessons,
          totalPoints: userData.totalPoints
        });
        
        // Update UI
        updateOverallProgress();
        renderLessonsList();
        
        // Mark Quiz as passed for this session
        quizPassed = true; 
        updateNavigationControls();
        
        // Show completion modal
        document.getElementById('pointsEarned').textContent = pointsEarned.toString();
        if (pointsEarned === 0) {
             document.getElementById('pointsEarned').textContent = '0 (Already earned)';
        }
        document.getElementById('completionModal').style.display = 'flex';
        
      } catch (error) {
        console.error('Error marking lesson complete:', error);
        alert('Error updating progress. Please try again.');
      }
    }

    // Initialize stars (outside of DOMContentLoaded to be safe with module imports)
    document.addEventListener('DOMContentLoaded', () => {
        const starsContainer = document.getElementById('stars-container');
        const numStars = 100;
        const minSize = 1;
        const maxSize = 3;
        for (let i = 0; i < numStars; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            const size = Math.random() * (maxSize - minSize) + minSize;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.left = `${Math.random() * 100}%`;
            star.style.top = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 4}s`;
            star.style.animationDuration = `${3 + Math.random() * 2}s`;
            starsContainer.appendChild(star);
        }
    });

  </script>
</body>
  </html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date()); 

  gtag('config', 'G-J1YTKP10ZX');
</script>
