<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Elvion AI ‚Äî Neon Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Highlight.js (optional for code blocks) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    /* =========================
       THEME + VARIABLES
       ========================= */
    :root{
      --fiery-cyan: #00f6ff;   /* bright cyan */
      --deep-blue: #0066ff;    /* saturated blue */
      --mid-blue: #0077cc;
      --bg-dark: #051020;
      --card: linear-gradient(180deg, rgba(8,18,36,0.85), rgba(6,10,20,0.9));
      --muted: #9fb6c8;
      --glass: rgba(255,255,255,0.03);
      --radius: 14px;
      --maxw: 980px;
      --shadow-neon: 0 6px 28px rgba(0,150,255,0.12);
    }

    /* =========================
       BASE LAYOUT
       ========================= */
    html,body{height:100%;width:100%;margin:0;padding:0;background:#020617;font-family:Roboto,Inter,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;color:#e6f6ff; -webkit-font-smoothing:antialiased;}
    body {display:flex;flex-direction:column;min-height:100vh;overflow:hidden;}

    /* Canvas starfield full-screen behind UI */
    #starfield { position:fixed; inset:0; z-index:0; display:block; }

    /* main wrapper */
    .app {
      position:relative;
      z-index:1;
      width:100%;
      height:100vh;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:flex-start;
      background: var(--card);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow-neon);
    }

    /* header */
    .header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      gap:8px;
      z-index:5;
    }
    .header .left {
      display:flex; align-items:center; gap:8px;
    }
    .icon-btn {
      background:transparent; border: none; color:var(--fiery-cyan); padding:8px; font-size:1.4rem; border-radius:10px; cursor:pointer;
    }
    .icon-btn:hover { background: rgba(0,246,255,0.07); color:#002; transform:translateY(-1px); }
    .brand {
      font-family:Orbitron, sans-serif; font-weight:700; letter-spacing:0.4px;
      background: linear-gradient(90deg,var(--fiery-cyan),#fff,var(--deep-blue));
      -webkit-background-clip:text; color:transparent; font-size:1.1rem;
      text-shadow:0 6px 24px rgba(0,246,255,0.05);
    }
    .header-sub { text-align:center; color:var(--muted); font-size:0.95rem; margin-top:2px; }

    /* center column: chat area + floating input */
    .main {
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      flex:1 1 auto; width:100%; overflow:hidden; position:relative;
    }

    /* chat scroll area */
    .chat-scroll {
      flex:1 1 auto;
      width:100%;
      max-width:var(--maxw);
      margin:0 auto;
      padding:20px 18px 160px; /* bottom space for fixed input */
      box-sizing:border-box;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      z-index:3;
    }

    /* message row */
    .msg-row{ display:flex; width:100%; margin:10px 0; align-items:flex-end; gap:12px; }
    .msg-row.ai { justify-content:flex-start; }
    .msg-row.user { justify-content:flex-end; }

    /* bubble styles */
    .bubble {
      max-width:86%;
      padding:10px 12px;
      border-radius:12px;
      color: #071b2b;
      font-size:0.98rem;
      line-height:1.45;
      box-shadow: 0 6px 24px rgba(1,80,150,0.06);
      word-break:break-word;
      white-space:pre-wrap;
    }

    /* AI bubble - bluish glow */
    .bubble.ai {
      background: linear-gradient(180deg, rgba(0,246,255,0.12), rgba(0,120,255,0.08));
      color:#031e31;
      border: 1px solid rgba(0,246,255,0.12);
      box-shadow: 0 8px 30px rgba(0,120,255,0.09), 0 0 12px rgba(0,246,255,0.06) inset;
    }

    /* user bubble - lighter fiery cyan */
    .bubble.user {
      background: linear-gradient(180deg, rgba(0,200,255,0.18), rgba(0,140,255,0.12));
      color:#021425;
      border: 1px solid rgba(0,200,255,0.08);
      box-shadow: 0 6px 22px rgba(0,140,255,0.08);
      font-weight:600;
    }

    /* bubble bottom controls container */
    .bubble-controls { display:flex; gap:8px; margin-top:8px; justify-content:flex-end; }

    /* action buttons (copy/share/regen) - unified style */
    .act-btn {
      background: linear-gradient(90deg,var(--fiery-cyan),var(--deep-blue));
      border:none; color:#021425; padding:7px 10px; border-radius:9px; font-weight:700; cursor:pointer;
      display:inline-flex; gap:8px; align-items:center; font-size:0.9rem;
      box-shadow: 0 6px 22px rgba(0,140,255,0.08);
    }
    .act-btn:hover { filter:brightness(.95); color:#fff; background:var(--deep-blue); }

    /* typing bubble (dots) */
    .typing {
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; background:linear-gradient(180deg, rgba(0,10,20,0.55), rgba(1,20,30,0.35)); color:var(--fiery-cyan);
      box-shadow: 0 6px 24px rgba(0,0,0,0.5), 0 0 14px rgba(0,246,255,0.06) inset;
    }
    .typing .dot { width:8px; height:8px; border-radius:50%; background:var(--fiery-cyan); opacity:.6; animation:dot 1s infinite ease-in-out; }
    .typing .dot:nth-child(2){ animation-delay:.15s; }
    .typing .dot:nth-child(3){ animation-delay:.3s; }
    @keyframes dot { 0%{ transform:translateY(0); opacity:.5 } 50%{ transform:translateY(-6px); opacity:1 } 100%{ transform:translateY(0); opacity:.5 } }

    /* stop button (square) */
    .stop-btn { margin-left:8px; background:#ff6b6b;color:#fff;border:none;padding:6px 9px;border-radius:8px;font-weight:700; cursor:pointer; }

    /* file preview */
    .file-preview { display:none; width:100%; max-width:var(--maxw); margin:10px auto; background:rgba(255,255,255,0.02); padding:8px; border-radius:10px; box-shadow:var(--shadow-neon); }

    /* bottom input bar (fixed) - glass / fiery accent */
    .input-bar {
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; width:calc(100% - 32px); max-width:var(--maxw); z-index:6;
      display:flex; align-items:center; gap:8px; padding:10px; border-radius:14px;
      background: linear-gradient(180deg, rgba(6,12,22,0.84), rgba(5,8,16,0.9));
      border: 1px solid rgba(0,246,255,0.06);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
    }
    .input-bar textarea {
      flex:1; min-height:44px; max-height:120px; resize:none; border-radius:10px; padding:10px 12px; border:none; outline:none; background:rgba(3,14,20,0.5); color:var(--fiery-cyan); font-size:1rem;
    }
    .input-actions { display:flex; gap:6px; align-items:center; }
    .square-btn { background:transparent;border:none;color:var(--fiery-cyan); padding:10px; border-radius:10px; font-size:1.05rem; cursor:pointer; }
    .square-btn:hover { background: rgba(0,246,255,0.06); color:#fff; transform:translateY(-1px); }

    /* emoji panel */
    .emoji-panel { position:fixed; bottom:90px; left:26px; z-index:9; display:none; background:linear-gradient(180deg, rgba(6,10,18,0.95), rgba(8,14,22,0.92)); padding:8px; border-radius:12px; box-shadow:var(--shadow-neon); }

    /* side panels (profile & links) - slide in */
    .panel-bg { position:fixed; inset:0; z-index:12; display:none; background:rgba(0,0,0,0.55); }
    .panel-bg.active { display:block; }
    .panel {
      position:fixed; top:0; bottom:0; width:320px; max-width:92%;
      background: linear-gradient(180deg, rgba(3,16,30,0.96), rgba(6,10,18,0.98)); color:var(--fiery-cyan);
      padding:18px; box-shadow: 0 30px 90px rgba(0,0,0,0.6);
      z-index:13;
      display:flex; flex-direction:column; gap:10px;
    }
    .panel.left { left:0; transform:translateX(-100%); transition:transform .28s ease; border-radius:0 12px 12px 0; }
    .panel.right { right:0; transform:translateX(100%); transition:transform .28s ease; border-radius:12px 0 0 12px; }
    .panel-bg.active .panel.left { transform:translateX(0); }
    .panel-bg.active .panel.right { transform:translateX(0); }

    .panel .avatar { width:78px; height:78px; border-radius:50%; object-fit:cover; box-shadow:0 8px 30px rgba(0,246,255,0.06); border:2px solid rgba(0,246,255,0.06); }
    .panel h3{ margin:8px 0 0 0; color:var(--fiery-cyan); font-size:1.05rem; }

    .chats-list { display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:34vh; padding-right:6px; }
    .chat-item { display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; background:rgba(255,255,255,0.02); color:var(--muted); }
    .chat-item .title { flex:1; font-weight:600; color:var(--fiery-cyan); cursor:pointer; }
    .chat-item button { background: linear-gradient(90deg,var(--fiery-cyan),var(--deep-blue)); border:none; color:#031425; padding:6px 8px; border-radius:8px; font-weight:700; cursor:pointer; }
    .chat-item button:hover { filter:brightness(.95); color:#fff; background:var(--deep-blue); }

    /* form inputs in panel */
    .panel input[type="text"], .panel input[type="url"] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:rgba(2,8,12,0.45); color:var(--muted); }

    /* responsive tweaks */
    @media (max-width:640px){
      .panel { width:92%; }
      .input-bar { width:calc(100% - 20px); left:50%; transform:translateX(-50%); bottom:10px; }
      .chat-scroll { padding-bottom:220px; }
    }
  </style>
</head>
<body>
  <!-- Canvas starfield background -->
  <canvas id="starfield"></canvas>

  <div class="app" aria-live="polite">
    <header class="header">
      <div class="left">
        <button id="openProfileMenu" class="icon-btn" title="Open profile"><i class="fa-solid fa-user"></i></button>
        <div style="display:flex;flex-direction:column;">
          <div class="brand">Philadelphia AI</div>
          <div class="header-sub" id="headerWelcome">Welcome</div>
        </div>
      </div>
      <div>
        <button id="openLinksMenu" class="icon-btn" title="Open links"><i class="fa-solid fa-link"></i></button>
      </div>
    </header>

    <section class="main">
      <div id="chatScroll" class="chat-scroll" role="log" aria-live="polite"></div>
      <div id="filePreview" class="file-preview" aria-hidden="true"></div>
    </section>

    <!-- Input bar (fixed) -->
    <form id="chatForm" class="input-bar" autocomplete="off" aria-label="Chat input form">
      <div class="input-actions" style="display:flex;align-items:center;gap:8px;">
        <button type="button" id="emojiBtn" class="square-btn" title="Emoji"><i class="fa-regular fa-face-smile"></i></button>
        <label for="chatFile" class="square-btn" title="Attach file" style="cursor:pointer;"><i class="fa-solid fa-paperclip"></i></label>
        <input id="chatFile" type="file" accept="application/pdf,image/*,audio/*,video/*" multiple style="display:none;">
      </div>

      <textarea id="chatInput" placeholder="Type here... (Shift+Enter = new line)" aria-label="Message input"></textarea>

      <div class="input-actions">
        <button type="button" id="voiceInputBtn" class="square-btn" title="Voice"><i class="fa-solid fa-microphone"></i></button>
        <button type="button" id="imageBtn" class="square-btn" title="Image AI"><i class="fa-solid fa-image"></i></button>
        <button type="submit" id="sendBtn" class="square-btn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </form>
  </div>

  <!-- PROFILE PANEL (left) -->
  <div id="profilePanelBg" class="panel-bg" aria-hidden="true">
    <aside class="panel left" id="profilePanel" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="profileTitle">Chats</h3>
        <button class="square-btn" id="closeProfilePanel" title="Close">√ó</button>
      </div>

      <div class="chats-list" id="chatsList"></div>

      <button id="newChatBtn" class="act-btn" style="width:100%;margin-top:6px;"><i class="fa-solid fa-plus"></i> New Chat</button>

      <hr style="border:none;border-top:1px solid rgba(0,246,255,0.04);margin:10px 0;">

      <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
        <img id="profilePicPreview" class="avatar" src="https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg" alt="Profile">
        <div class="username" id="profileMenuUser">User</div>
        <div class="email" id="profileMenuEmail" style="color:var(--muted)">email@example.com</div>
      </div>

      <form id="profileForm" style="margin-top:8px;">
        <label style="color:var(--muted);font-weight:600;margin-top:6px">Name</label>
        <input id="edit-name" type="text" placeholder="Your name">

        <label style="color:var(--muted);font-weight:600;margin-top:6px">Photo URL</label>
        <input id="edit-photo" type="url" placeholder="https://...">

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button type="submit" class="act-btn" style="flex:1">Save</button>
          <button type="button" id="logoutBtn" class="square-btn" style="background:transparent;color:var(--fiery-cyan);border:1px solid rgba(0,246,255,0.04);">Logout</button>
        </div>
        <div id="profileStatusMsg" style="color:var(--muted);margin-top:8px;font-size:0.9rem;"></div>
      </form>
    </aside>
  </div>

  <!-- LINKS PANEL (right) -->
  <div id="linksPanelBg" class="panel-bg" aria-hidden="true">
    <aside class="panel right" id="linksPanel" role="dialog" aria-modal="true" aria-labelledby="linksTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="linksTitle">Elvion AI</h3>
        <button class="square-btn" id="closeLinksPanel" title="Close">√ó</button>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px;margin-top:6px;">
        <a href="index.html" style="color:var(--muted);text-decoration:none;padding:10px;border-radius:8px;"> <i class="fa-solid fa-home"></i> Home</a>
        <a href="about.html" style="color:var(--muted);text-decoration:none;padding:10px;border-radius:8px;"> <i class="fa-solid fa-circle-info"></i> About</a>
        <a href="privacy.html" style="color:var(--muted);text-decoration:none;padding:10px;border-radius:8px;"> <i class="fa-solid fa-shield-halved"></i> Privacy</a>
        <a href="terms.html" style="color:var(--muted);text-decoration:none;padding:10px;border-radius:8px;"> <i class="fa-solid fa-file-contract"></i> Terms</a>
        <a href="https://t.me/writingurubot" target="_blank" style="color:var(--muted);text-decoration:none;padding:10px;border-radius:8px;"> <i class="fab fa-telegram"></i> Telegram Bot</a>
      </div>
    </aside>
  </div>

  <!-- AI image preview floating -->
  <div id="ai-image-preview" style="display:none;position:fixed;right:18px;bottom:120px;z-index:20;background:linear-gradient(180deg,#061224,#021323);padding:10px;border-radius:12px;box-shadow:0 20px 60px rgba(0,120,255,0.06);">
    <button id="ai-image-close" class="square-btn" style="float:right">√ó</button>
    <div id="ai-image-container" style="min-width:180px;min-height:120px;"></div>
    <div style="text-align:center;margin-top:8px;">
      <button id="ai-image-dl" class="act-btn">Download</button>
    </div>
  </div>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
  authDomain: "elvionai.firebaseapp.com",
  projectId: "elvionai",
  storageBucket: "elvionai.appspot.com",
  messagingSenderId: "161078300830",
  appId: "1:161078300830:web:f460df8591704eb0e96b8f"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Short helper
const $ = id => document.getElementById(id);

// ---------- Global chat storage ----------
let chats = JSON.parse(localStorage.getItem("elvion_chats") || "[]");
let currentChatIdx = (typeof localStorage !== 'undefined' && localStorage.getItem('elvion_current_idx') !== null)
  ? Number(localStorage.getItem('elvion_current_idx')) : (chats.length - 1 >= 0 ? chats.length - 1 : 0);

function saveChats() {
  try {
    let sanitized = JSON.parse(JSON.stringify(chats));
    sanitized.forEach(chat => {
      (chat.history || []).forEach(msg => {
        if (msg.text && typeof msg.text === 'string' && msg.text.includes("data:image")) {
          msg.text = "[image omitted]";
        }
      });
    });
    localStorage.setItem("elvion_chats", JSON.stringify(sanitized));
    localStorage.setItem('elvion_current_idx', String(currentChatIdx));
  } catch (e) { console.warn('saveChats failed', e); }
}

// Keep file/upload state
let uploadedFiles = [];
let uploadData = null;

// ---------- DOM & wiring ----------
window.addEventListener('DOMContentLoaded', () => {
  /* ---------- Elements (may be null) ---------- */
  const starsContainer = $('stars-container');
  const mainContainer = $('mainContainer') || $('main-container') || document.body;
  const fullscreenBtn = $('fullscreenBtn') || $('fullscreen-btn');
  const profileMenuBg = $('profileMenuBg');
  const profileMenu = $('profileMenu');
  const linkMenuBg = $('linkMenuBg');
  const linkMenu = $('linkMenu');
  const logoutBtn = $('logoutBtn');
  const headerWelcome = $('headerWelcome');
  const profileMenuUser = $('profileMenuUser');
  const profileMenuEmail = $('profileMenuEmail');
  const editName = $('edit-name');
  const editPhoto = $('edit-photo');
  const profilePicPreview = $('profilePicPreview');
  const profileForm = $('profileForm');
  const chatBox = $('chatBox');
  const chatSelector = $('chatSelector');
  const chatForm = $('chatForm');
  const chatInput = $('chatInput');
  const sendBtn = $('sendBtn');
  const chatFile = $('chatFile');
  const filePreview = $('filePreview');
  const voiceInputBtn = $('voiceInputBtn'); // declared once
  const addChatBtn = $('addChatBtn');
  const removeChatBtn = $('removeChatBtn');
  const newChatBtn = $('newChatBtn');
  const chatsListEl = $('chatsList');
  const emojiPanel = $('emojiPanel');
  const emojiBtn = $('emojiBtn'); // FIX: ensure emojiBtn is grabbed
  const imageBtnHtml = $('imageBtn'); // may be present in HTML
  const voiceBtnHtml = $('voiceBtn'); // may be present in HTML

  // Defensive: if essential elements missing, still continue but warn
  if (!chatForm) console.warn('chatForm not found in DOM. Chat submission disabled until element added.');
  if (!chatBox) console.warn('chatBox not found in DOM. Chat rendering disabled until element added.');

  /* ---------- Emoji ---------- */
  const emojis = ["üòÄ","üòÉ","üòÇ","ü§£","üòç","ü•∞","üòé","üëç","üôè","üî•","üíØ","üéâ","üòá","ü´∂","üòú","ü§ñ","üëÄ"];
  if (emojiBtn && emojiPanel && chatInput) {
    emojiBtn.addEventListener('click', function (e) {
      // toggle panel content
      emojiPanel.innerHTML = emojis.map(em => `<span class="emoji-pick" role="button" tabindex="0" aria-label="emoji">${em}</span>`).join('');
      emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
      // position it near button
      try {
        const rect = emojiBtn.getBoundingClientRect();
        emojiPanel.style.left = `${Math.max(8, rect.left)}px`;
      } catch (e) { /* ignore positioning errors */ }
      // wire picks
      emojiPanel.querySelectorAll('.emoji-pick').forEach(span => {
        span.addEventListener('click', function () {
          const text = this.textContent || '';
          const start = chatInput.selectionStart || 0;
          const end = chatInput.selectionEnd || 0;
          chatInput.value = chatInput.value.slice(0, start) + text + chatInput.value.slice(end);
          chatInput.focus();
          chatInput.selectionStart = chatInput.selectionEnd = start + text.length;
          emojiPanel.style.display = 'none';
          chatInput.dispatchEvent(new Event('input'));
        });
      });
    });
    // click outside to close
    document.addEventListener('click', e => {
      if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
        emojiPanel.style.display = 'none';
      }
    });
  }

  /* ---------- Stars ---------- */
  if (starsContainer) {
    starsContainer.innerHTML = '';
    for (let i = 0; i < 34; i++) {
      const s = document.createElement('div'); s.className = 'star';
      const z = Math.random() * 2.1 + 1; s.style.width = z + 'px'; s.style.height = z + 'px';
      s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%';
      s.style.animationDelay = (Math.random() * 3.69) + 's';
      s.style.animationDuration = (2.2 + Math.random() * 1.1) + 's';
      starsContainer.appendChild(s);
    }
  }

  /* ---------- Fullscreen toggle ---------- */
  if (fullscreenBtn && mainContainer) {
    let isFull = false;
    fullscreenBtn.addEventListener('click', () => {
      isFull = !isFull;
      mainContainer.classList.toggle('fullscreen', isFull);
      try { fullscreenBtn.innerHTML = isFull ? '<i class="fa-solid fa-compress"></i>' : '<i class="fa-solid fa-expand"></i>'; } catch (e) {}
    });
  }

  /* ---------- Panels/Modals ---------- */
  if (profileMenuBg && profileMenu && $('openProfileMenu')) {
    $('openProfileMenu').addEventListener('click', () => {
      profileMenuBg.classList.add('active');
      setTimeout(() => profileMenu.classList.add('active'), 10);
    });
    profileMenuBg.addEventListener('click', e => {
      if (e.target === profileMenuBg) {
        profileMenu.classList.remove('active');
        setTimeout(() => profileMenuBg.classList.remove('active'), 110);
      }
    });
  }
  if (linkMenuBg && linkMenu && $('openLinksMenu')) {
    $('openLinksMenu').addEventListener('click', () => {
      linkMenuBg.classList.add('active');
      setTimeout(() => linkMenu.classList.add('active'), 10);
    });
    linkMenuBg.addEventListener('click', e => {
      if (e.target === linkMenuBg) {
        linkMenu.classList.remove('active');
        setTimeout(() => linkMenuBg.classList.remove('active'), 110);
      }
    });
  }
  if (logoutBtn) logoutBtn.addEventListener('click', () => window.location.href = 'signup-login.html');

  /* ---------- Firebase auth (profile only) ---------- */
  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (!user) {
      // if not logged in, redirect to login
      try { window.location.href = "signup-login.html"; } catch (e) {}
      return;
    }
    currentUser = user;

    // populate profile UI if present
    if (headerWelcome) headerWelcome.textContent = "Welcome, " + (user.displayName || (user.email || '').split('@')[0]);
    if (profileMenuUser) profileMenuUser.textContent = user.displayName || "User";
    if (profileMenuEmail) profileMenuEmail.textContent = user.email || "";
    if (editName) editName.value = user.displayName || "";
    if (editPhoto) editPhoto.value = user.photoURL || "";
    if (profilePicPreview) profilePicPreview.src = user.photoURL || "https://i.ibb.co/YTkKPfvf/IMG-20250715-102103-129.jpg";

    // ensure at least one chat
    if (!Array.isArray(chats) || chats.length === 0) {
      chats = [{ name: 'Chat 1', history: [] }];
      currentChatIdx = 0;
      saveChats();
    }
    // initial render
    try { renderChatSelector(); } catch (e) { console.warn('renderChatSelector error', e); }
    try { renderChatBox((chats[currentChatIdx] || {}).history || []); } catch (e) { console.warn('renderChatBox error', e); }
  });

  /* ---------- Profile form submit (update Firebase profile) ---------- */
  if (profileForm) {
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const status = $('profileStatusMsg');
      if (status) status.textContent = '';
      const name = editName ? editName.value.trim() : '';
      const photoURL = editPhoto ? editPhoto.value.trim() : '';
      try {
        await updateProfile(currentUser, { displayName: name, photoURL });
        if (auth.currentUser && typeof auth.currentUser.reload === 'function') await auth.currentUser.reload();
        if (status) { status.textContent = "Profile updated!"; status.style.color = "#00ffff"; }
        setTimeout(() => { profileMenu?.classList.remove('active'); profileMenuBg?.classList.remove('active'); }, 650);
        if (headerWelcome) headerWelcome.textContent = "Welcome, " + (auth.currentUser?.displayName || (auth.currentUser?.email || '').split('@')[0]);
      } catch (err) {
        if (status) { status.textContent = err.message || "Update failed"; status.style.color = "#ffd700"; }
      }
    });
  }

  /* ---------- Sidebar / Chats list ---------- */
  function renderChatsListSidebar() {
    if (!chatsListEl) return;
    chatsListEl.innerHTML = '';
    chats.forEach((chat, idx) => {
      const container = document.createElement('div');
      container.style.display = 'flex';
      container.style.alignItems = 'center';
      container.style.marginBottom = '6px';

      const titleSpan = document.createElement('span');
      titleSpan.textContent = chat.name || `Chat ${idx + 1}`;
      titleSpan.style.flex = '1';
      titleSpan.style.cursor = 'pointer';
      titleSpan.onclick = () => {
        currentChatIdx = idx;
        saveChats();
        renderChatBox(chat.history || []);
        if (chatSelector) chatSelector.value = idx;
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      const renameBtn = document.createElement('button');
      renameBtn.innerHTML = '<i class="fa-solid fa-pen"></i>';
      renameBtn.title = 'Rename';
      renameBtn.style.margin = '0 6px 0 8px';
      renameBtn.onclick = (e) => {
        e.stopPropagation();
        const newName = prompt("Rename chat:", chat.name || `Chat ${idx + 1}`);
        if (newName) {
          chat.name = newName.trim();
          saveChats();
          renderChatsListSidebar();
          renderChatSelector();
        }
      };

      const delBtn = document.createElement('button');
      delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.title = 'Delete';
      delBtn.style.marginLeft = '6px';
      delBtn.onclick = (e) => {
        e.stopPropagation();
        if (!confirm("Delete this chat?")) return;
        chats.splice(idx, 1);
        if (currentChatIdx >= chats.length) currentChatIdx = chats.length - 1;
        if (!chats.length) { chats.push({ name: 'Chat 1', history: [] }); currentChatIdx = 0; }
        saveChats();
        renderChatsListSidebar();
        renderChatSelector();
        renderChatBox(chats[currentChatIdx]?.history || []);
      };

      const openBtn = document.createElement('button');
      openBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
      openBtn.title = 'Open Chat';
      openBtn.onclick = (e) => {
        e.stopPropagation();
        currentChatIdx = idx;
        renderChatBox(chat.history || []);
        if (chatSelector) chatSelector.value = idx;
        profileMenu?.classList.remove('active');
        profileMenuBg?.classList.remove('active');
      };

      container.appendChild(titleSpan);
      container.appendChild(renameBtn);
      container.appendChild(delBtn);
      container.appendChild(openBtn);
      chatsListEl.appendChild(container);
    });
  }

  if (newChatBtn) {
    newChatBtn.addEventListener('click', () => {
      chats.push({ name: "Chat " + (chats.length + 1), history: [] });
      currentChatIdx = chats.length - 1;
      saveChats();
      renderChatsListSidebar();
      renderChatSelector();
      renderChatBox(chats[currentChatIdx]?.history || []);
    });
  }

  /* ---------- Chat selector (dropdown) ---------- */
  function renderChatSelector() {
    if (!chatSelector) return;
    chatSelector.innerHTML = '';
    chats.forEach((chat, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = chat.name || (chat.history?.[0]?.text?.slice(0, 24) || "Untitled");
      chatSelector.appendChild(option);
    });
    if (!chats.length) {
      chats = [{ name: 'Chat 1', history: [] }];
      currentChatIdx = 0;
      saveChats();
      return renderChatSelector();
    }
    if (typeof currentChatIdx === 'number') {
      currentChatIdx = Math.min(Math.max(0, currentChatIdx), Math.max(0, chats.length - 1));
      chatSelector.value = currentChatIdx;
    }
  }

  if (chatSelector) {
    chatSelector.addEventListener('change', function () {
      currentChatIdx = parseInt(this.value) || 0;
      saveChats();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  if (addChatBtn) {
    addChatBtn.addEventListener('click', () => {
      chats.push({ name: "Chat " + (chats.length + 1), history: [] });
      currentChatIdx = chats.length - 1;
      saveChats();
      renderChatSelector();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  if (removeChatBtn) {
    removeChatBtn.addEventListener('click', () => {
      if (!chats.length) return;
      if (!confirm("Delete this chat?")) return;
      chats.splice(currentChatIdx, 1);
      currentChatIdx = Math.max(0, currentChatIdx - 1);
      if (!chats.length) { chats.push({ name: 'Chat 1', history: [] }); currentChatIdx = 0; }
      saveChats();
      renderChatSelector();
      renderChatBox((chats[currentChatIdx] || {}).history || []);
    });
  }

  /* ---------- Markdown/render helpers ---------- */
  const escapeHTML = (str = '') => String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');

  function inlineMarkdown(t = '') {
    let s = String(t).replace(/`([^`]+?)`/g, (_, a) => `<code>${escapeHTML(a)}</code>`);
    s = s.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/(^|[\s(])\*([^*]+?)\*(?=[\s).,!?:;]|$)/g, '$1<em>$2</em>');
    s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return s.replace(/\n/g, '<br>');
  }

  function renderMarkdown(text = '') {
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let html = '';
    let lastIndex = 0;
    text = text || '';
    text.replace(codeBlockRegex, (match, lang, code, offset) => {
      const before = text.slice(lastIndex, offset);
      html += inlineMarkdown(before);
      const language = (lang || '').toLowerCase().trim();
      const safe = escapeHTML(code);
      const blockId = 'code_' + Math.random().toString(36).slice(2);
      html += `<pre data-block-id="${blockId}">\n  <button class="copy-btn" data-copy="${blockId}">Copy</button>\n  <code class="language-${language || 'plaintext'}">${safe}</code>\n</pre>`;
      lastIndex = offset + match.length;
      return match;
    });
    html += inlineMarkdown(text.slice(lastIndex));
    return { html };
  }

  function enhanceCodeBlocks(container) {
    if (!container) return;
    container.querySelectorAll('pre').forEach(pre => {
      const codeEl = pre.querySelector('code');
      if (window.hljs && codeEl) {
        try { hljs.highlightElement(codeEl); } catch (e) { /* ignore */ }
      }
      const btn = pre.querySelector('.copy-btn');
      if (btn && codeEl) {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(codeEl.innerText);
            const prev = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = prev, 800);
          } catch (e) { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 800); }
        });
      }
    });
  }

  /* ---------- Chat rendering & controls ---------- */
  function renderChatBox(messages = []) {
    if (!chatBox) return;
    chatBox.innerHTML = '';
    let aiMsgIdx = 0;
    (messages || []).forEach((msg) => {
      const div = document.createElement('div');
      div.className = "chat-message " + (msg.role === "user" ? "user" : "ai");
      if (msg.text && /^(\[File\]|image:)/.test(msg.text)) {
        div.innerHTML = msg.text.replace('image:', '');
      } else if (msg.role === "ai") {
        const { html } = renderMarkdown(msg.text || '');
        div.innerHTML = `<div class="msg">${html}
          <div class="ai-msg-controls" style="display:flex;justify-content:flex-end;gap:10px;margin-top:8px;">
            <button class="inline-copy-btn" title="Copy"><i class="fa-solid fa-copy"></i></button>
            <button class="inline-share-btn" title="Share"><i class="fa-solid fa-share"></i></button>
            <button class="regen-btn" title="Regenerate"><i class="fa-solid fa-rotate-right"></i></button>
          </div>
        </div>`;
        div.setAttribute('data-aiidx', aiMsgIdx++);
      } else {
        div.innerHTML = `<div class="msg">${escapeHTML(msg.text || '')}</div>`;
      }
      chatBox.appendChild(div);
    });
    enhanceCodeBlocks(chatBox);
    hookAiMsgControls();
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function hookAiMsgControls() {
    if (!chatBox) return;
    chatBox.querySelectorAll('.chat-message.ai').forEach(div => {
      const aiIdx = Number(div.getAttribute('data-aiidx'));
      const controls = div.querySelector('.ai-msg-controls');
      if (!controls) return;
      const copyBtn = controls.querySelector('.inline-copy-btn');
      const shareBtn = controls.querySelector('.inline-share-btn');
      const regenBtn = controls.querySelector('.regen-btn');

      if (copyBtn) copyBtn.onclick = () => {
        try {
          const aiOnly = (chats[currentChatIdx]?.history || []).filter(m => m.role === "ai") || [];
          const text = aiOnly[aiIdx]?.text || "";
          navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, ""));
          copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i> Copied!";
          setTimeout(() => copyBtn.innerHTML = "<i class='fa-solid fa-copy'></i>", 950);
        } catch (e) { console.warn('copy failed', e); }
      };

      if (shareBtn) shareBtn.onclick = () => {
        try {
          const aiOnly = (chats[currentChatIdx]?.history || []).filter(m => m.role === "ai") || [];
          const text = aiOnly[aiIdx]?.text || "";
          const url = window.location.origin;
          const shareText = `${text.replace(/<\/?[^>]+(>|$)/g, "")}\n\nShared via Philadelphia AI: ${url}`;
          if (navigator.share) navigator.share({ title: "Philadelphia AI", text: shareText, url }).catch(()=>{});
          else prompt("Copy and share manually:", shareText);
        } catch (e) { console.warn('share failed', e); }
      };

      if (regenBtn) regenBtn.onclick = async () => {
        try {
          let aiMsgCount = 0, aiMsgIndexInHistory = -1;
          const history = chats[currentChatIdx]?.history || [];
          for (let i = 0; i < history.length; i++) {
            if (history[i].role === "ai") {
              if (aiMsgCount === aiIdx) { aiMsgIndexInHistory = i; break; }
              aiMsgCount++;
            }
          }
          const userMsgObj = history[aiMsgIndexInHistory - 1];
          const userMsg = (userMsgObj?.role === "user" ? userMsgObj.text : "");
          if (!userMsg) {
            regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i> Err";
            setTimeout(() => regenBtn.innerHTML = "<i class='fa-solid fa-rotate-right'></i>", 900);
            return;
          }
          if (aiMsgIndexInHistory >= 0) history.splice(aiMsgIndexInHistory, 1);
          saveChats();
          renderChatBox(history);
          showTypingAtNext();
          try {
            let res = await fetch('https://web-production-9a18.up.railway.app/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: userMsg, user_id: currentUser?.uid || "user", history: [] })
            });
            let data;
            try { data = await res.json(); } catch (e) { data = {}; }
            removeTyping();
            if (data && data.response) {
              history.push({ role: 'ai', text: data.response });
              saveChats();
              renderChatBox(history);
            } else {
              history.push({ role: 'ai', text: '‚ùå No response from server.' });
              saveChats();
              renderChatBox(history);
            }
          } catch (err) {
            removeTyping();
            history.push({ role: 'ai', text: "‚ùå Retry Error: " + (err.message || '') });
            saveChats();
            renderChatBox(history);
          }
        } catch (err) {
          console.warn('regen error', err);
        }
      };
    });
  }

  /* ---------- Typing / typewriter ---------- */
  let typingNode = null;
  function showTypingAtNext() {
    removeTyping();
    if (!chatBox) return;
    typingNode = document.createElement('div');
    typingNode.className = 'chat-message ai';
    typingNode.innerHTML = `<div class="msg"><span class="typing-bubble"><span class="dot-anim"></span><span class="dot-anim"></span><span class="dot-anim"></span></span></div>`;
    chatBox.appendChild(typingNode);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  function removeTyping() {
    if (typingNode && typingNode.parentNode) {
      typingNode.parentNode.removeChild(typingNode);
      typingNode = null;
    }
  }

  async function typeBotMessage(text, onDone) {
    removeTyping();
    if (!chatBox) return;
    const div = document.createElement('div'); div.className = "chat-message ai";
    const msgdiv = document.createElement('div'); msgdiv.className = 'msg'; div.appendChild(msgdiv); chatBox.appendChild(div);
    let sofar = '';
    for (const ch of text) {
      sofar += ch;
      msgdiv.innerHTML = renderMarkdown(sofar).html;
      chatBox.scrollTop = chatBox.scrollHeight;
      await new Promise(res => setTimeout(res, 6 + Math.random() * 18));
    }
    msgdiv.innerHTML = renderMarkdown(text).html + `\n  <div style="display:flex;justify-content:end;gap:8px;margin-top:4px;">\n    <button class="inline-copy-btn" title="Copy whole AI response">‚ñ° Copy</button>\n    <button class="inline-share-btn" title="Share this reply"><i class="fa-solid fa-share"></i> Share</button>\n  </div>`;
    enhanceCodeBlocks(msgdiv);
    hookAiMsgControls();
    chatBox.scrollTop = chatBox.scrollHeight;

    const copyBtn = msgdiv.querySelector('.inline-copy-btn');
    if (copyBtn) copyBtn.onclick = () => {
      try { navigator.clipboard.writeText(text.replace(/<\/?[^>]+(>|$)/g, "")); copyBtn.textContent = "Copied!"; setTimeout(() => copyBtn.textContent = "‚ñ° Copy", 900); }
      catch (e) { /* ignore */ }
    };
    const shareBtn = msgdiv.querySelector('.inline-share-btn');
    if (shareBtn) shareBtn.onclick = async () => {
      if (navigator.share) { try { await navigator.share({ title: "Philadelphia AI", text }); } catch (e) { /* ignore */ } }
      else prompt("Copy and share:", text.replace(/<\/?[^>]+(>|$)/g, ""));
    };
    if (onDone) onDone();
  }

  /* ---------- File preview helpers ---------- */
  function renderFilePreview() {
    if (!filePreview) return;
    if (!uploadedFiles.length) {
      filePreview.style.display = 'none';
      filePreview.innerHTML = '';
      return;
    }
    filePreview.style.display = 'block';
    filePreview.innerHTML = uploadedFiles.map((file, idx) => {
      let preview = '';
      if (file.type.startsWith('image/')) {
        preview = `<img src="${URL.createObjectURL(file)}" style="max-width:92px;max-height:74px;vertical-align:middle;border-radius:8px;margin-right:6px;">`;
      } else if (file.type.startsWith('video/')) {
        preview = `<video src="${URL.createObjectURL(file)}" controls style="max-width:80px;height:42px;vertical-align:middle;border-radius:8px;margin-right:7px;"></video>`;
      } else if (file.type.startsWith('audio/')) {
        preview = `<audio controls src="${URL.createObjectURL(file)}" style="vertical-align:middle;width:90px;margin-right:7px;"></audio>`;
      } else if (file.type === 'application/pdf') {
        preview = `<span style="font-size:1.25em;margin-right:7px;">üìÑ</span>`;
      }
      return `
      <div style="display:flex;align-items:center;gap:7px;margin-bottom:5px;">
        ${preview}
        <span style="color:#aee;font-size:.99em;">${escapeHTML(file.name)}</span>
        <button type="button" data-idx="${idx}" class="remove-file-btn" style="color:#fff;background:#d23;border:none;border-radius:12px;padding:0 9px;cursor:pointer;font-weight:bold;font-size:1.18em;">&times;</button>
      </div>`;
    }).join('');
    filePreview.querySelectorAll('.remove-file-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-idx'));
        uploadedFiles.splice(idx, 1);
        uploadData = uploadedFiles[0] || null;
        if (!uploadedFiles.length && chatFile) chatFile.value = '';
        renderFilePreview();
      });
    });
  }

  if (chatFile) {
    chatFile.addEventListener('change', function () {
      const files = Array.from(this.files || []);
      uploadedFiles = files;
      uploadData = files[0] || null;
      if (filePreview && uploadData) {
        if (uploadData.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => { filePreview.style.display = 'block'; filePreview.innerHTML = `<img src="${e.target.result}" alt="Selected image" style="max-width:200px;border-radius:8px;">`; };
          reader.readAsDataURL(uploadData);
        } else if (uploadData.type.startsWith('video/')) {
          const reader = new FileReader();
          reader.onload = e => { filePreview.style.display = 'block'; filePreview.innerHTML = `<video src="${e.target.result}" controls style="max-width:200px;border-radius:8px;"></video>`; };
          reader.readAsDataURL(uploadData);
        } else {
          renderFilePreview();
        }
      } else renderFilePreview();
    });
  }

  /* ---------- Voice input via Web Speech ---------- */
  if (voiceInputBtn && chatInput) {
    let recognition = null;
    voiceInputBtn.addEventListener('click', function () {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const R = window.webkitSpeechRecognition || window.SpeechRecognition;
        recognition = new R();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';
        voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
        recognition.onresult = (e) => {
          chatInput.value += (chatInput.value ? ' ' : '') + e.results[0][0].transcript;
          chatInput.dispatchEvent(new Event('input'));
          voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
        };
        recognition.onend = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
        recognition.onerror = () => { voiceInputBtn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; };
        recognition.start();
      } else alert('Speech recognition not supported in your browser.');
    });
  }

  /* ---------- Textarea auto-resize ---------- */
  if (chatInput) {
    function autoResizeTextarea() {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 168) + 'px';
    }
    chatInput.addEventListener('input', autoResizeTextarea);
    autoResizeTextarea();
    chatInput.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); sendBtn?.click(); }
    });
  }

  /* ---------- IMAGE & VOICE (prefer HTML buttons, otherwise create) ---------- */
  const thenaModels = ["photoreal", "ultrarealistic", "anime", "deepanime", "animelegacy", "dreamcore", "gemini6"];
  let currentModelIdx = 0;

  // image button element: prefer HTML button if present
  let imageBtnEl = imageBtnHtml || null;
  if (!imageBtnEl && chatForm && sendBtn) {
    imageBtnEl = document.createElement('button');
    imageBtnEl.type = 'button';
    imageBtnEl.id = 'imageBtn';
    imageBtnEl.title = 'Generate image';
    imageBtnEl.innerHTML = '<i class="fa-solid fa-image"></i>';
    chatForm.insertBefore(imageBtnEl, sendBtn);
  }

  // voice-gen button element: prefer HTML if present
  let voiceGenBtnEl = voiceBtnHtml || null;
  if (!voiceGenBtnEl && chatForm && sendBtn) {
    voiceGenBtnEl = document.createElement('button');
    voiceGenBtnEl.type = 'button';
    voiceGenBtnEl.id = 'voiceBtn';
    voiceGenBtnEl.title = 'Generate voice';
    voiceGenBtnEl.innerHTML = '<i class="fa-solid fa-microphone-lines"></i>';
    chatForm.insertBefore(voiceGenBtnEl, sendBtn);
  }

  // Image model cycling ‚Äî inserts model prefix into text
  if (imageBtnEl) {
    imageBtnEl.addEventListener('click', function () {
      currentModelIdx = (currentModelIdx + 1) % thenaModels.length;
      const model = thenaModels[currentModelIdx];
      const prevInput = chatInput ? chatInput.value.replace(/^\/image\s+\w+\s*/i, "").replace(/^\/imagine\s*/i, "") : "";
      if (model === 'gemini6') {
        if (chatInput) chatInput.value = `/imagine ${prevInput}`.trim();
        imageBtnEl.innerHTML = '<i class="fa-brands fa-google"></i>';
      } else {
        if (chatInput) chatInput.value = `/image ${model} ${prevInput}`.trim();
        imageBtnEl.innerHTML = '<i class="fa-solid fa-image"></i>';
      }
      chatInput?.focus();
      setTimeout(() => { try { chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); } catch (_) {} }, 0);
    });
  }

  // Voice generation (TTS) ‚Äî posts to /voicegen
  if (voiceGenBtnEl) {
    voiceGenBtnEl.addEventListener('click', async function () {
      if (!chatInput) return;
      const msgText = chatInput.value.trim();
      if (!msgText) { chatInput.focus(); return; }
      const style = $('voiceStyle') ? $('voiceStyle').value : 'podcast';
      showTypingAtNext();
      try {
        const fd = new FormData(); fd.append('text', msgText); fd.append('style', style);
        const res = await fetch('https://web-production-9a18.up.railway.app/voicegen', { method: 'POST', body: fd });
        if (!res.ok) {
          let err = {}; try { err = await res.json(); } catch (_) {}
          removeTyping();
          await typeBotMessage('‚ùå Voice generation failed: ' + (err.error || res.statusText));
          chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Voice generation failed.' });
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const audioPlayer = `<audio controls src="${url}" style="width:99%;margin:8px 0 3px 0;border-radius:14px;"></audio>`;
        removeTyping();
        chats[currentChatIdx].history.push({ role: 'ai', text: `üó£Ô∏è Voice generated in *${style}* style:<br>${audioPlayer}` });
        saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
      } catch (err) {
        removeTyping();
        await typeBotMessage('‚ùå Voice API/network error');
        chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Voice API/network error' });
        saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
      }
    });
  }

  /* ---------- Chat submit handler (main) ---------- */
  if (chatForm) {
    chatForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const file = uploadData;
      let msgText = (chatInput ? chatInput.value.trim() : '');

      // Ensure at least one chat exists
      if (currentChatIdx < 0 || !chats.length) {
        chats.push({ name: 'Chat 1', history: [] });
        currentChatIdx = 0;
        saveChats();
      }
      if (!msgText && !file) return;
      if (chatInput) { chatInput.value = ''; chatInput.dispatchEvent(new Event('input')); }

      // --------- /imagine handler ----------
      if (/^\/imagine\s+/i.test(msgText)) {
        const imaginePrompt = msgText.replace(/^\/imagine\s+/i, '').trim();
        const fd = new FormData(); fd.append('prompt', imaginePrompt);
        if (uploadedFiles.length && /^image\//.test(uploadedFiles[0].type)) fd.append('file', uploadedFiles[0]);
        showTypingAtNext();
        try {
          const res = await fetch('https://web-production-9a18.up.railway.app/imagine', { method: 'POST', body: fd });
          if (!res.ok) {
            let err = {}; try { err = await res.json(); } catch (_) {}
            removeTyping();
            await typeBotMessage('‚ùå Image generation failed: ' + (err.error || res.statusText));
            chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Image generation failed.' });
            saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          } else {
            const blob = await res.blob(); const url = URL.createObjectURL(blob);
            showAIImagePreview(url, 'Your new Philadelphia AI image! (click Download if you like it)');
            removeTyping();
            chats[currentChatIdx].history.push({ role: 'ai', text: '‚úÖ Image generated! Use the floating image box below to view or download. (Not stored in chat history.)' });
            saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          }
        } catch (err) {
          removeTyping();
          await typeBotMessage('‚ùå Philadelphia image API/network error');
          chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Vision 6 image API/network error' });
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
        }
        // reset file state
        if (chatFile) chatFile.value = '';
        uploadedFiles = []; uploadData = null; renderFilePreview();
        return;
      }

      // --------- File upload logic (multiple) ----------
      if (uploadedFiles && uploadedFiles.length) {
        showTypingAtNext();
        try {
          const pdfs = uploadedFiles.filter(f => f.type === 'application/pdf');
          const images = uploadedFiles.filter(f => /^image\//.test(f.type));
          const audios = uploadedFiles.filter(f => /^audio\//.test(f.type));
          const videos = uploadedFiles.filter(f => /^video\//.test(f.type));

          if (pdfs.length) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : (pdfs.length > 1 ? 'Please summarize and compare these documents:' : 'Summarize this document.'));
            pdfs.forEach(f => fd.append('files', f));
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-pdf', { method: 'POST', body: fd });
            let txt = await res.text();
            let data;
            try { data = JSON.parse(txt); } catch (err) {
              removeTyping();
              chats[currentChatIdx].history.push({ role: 'user', text: `[PDF] ${pdfs.map(f => f.name).join(', ')}${msgText ? ': ' + msgText : ''}` });
              chats[currentChatIdx].history.push({ role: 'ai', text: `‚ùå PDF API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` });
              saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
              return;
            }
            removeTyping();
            chats[currentChatIdx].history.push({ role: 'user', text: `[PDF] ${pdfs.map(f => f.name).join(', ')}${msgText ? ': ' + msgText : ''}` });
            if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('‚ùå Could not process the PDF(s).'); chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Could not process the PDF(s).' }); }
          }

          for (const img of images) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Describe this image in detail.'); fd.append('file', img);
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-image', { method: 'POST', body: fd });
            let txt = await res.text(); let data;
            try { data = JSON.parse(txt); } catch (err) {
              chats[currentChatIdx].history.push({ role: 'user', text: `[Image] ${img.name}${msgText ? ': ' + msgText : ''}` });
              chats[currentChatIdx].history.push({ role: 'ai', text: `‚ùå Image API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` });
              continue;
            }
            chats[currentChatIdx].history.push({ role: 'user', text: `[Image] ${img.name}${msgText ? ': ' + msgText : ''}` });
            if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('‚ùå Could not process the image.'); chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Could not process the image.' }); }
          }

          for (const audio of audios) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Transcribe and summarize this audio file in simple English.'); fd.append('file', audio);
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-audio', { method: 'POST', body: fd });
            let txt = await res.text(); let data;
            try { data = JSON.parse(txt); } catch (err) {
              chats[currentChatIdx].history.push({ role: 'user', text: `[Audio] ${audio.name}${msgText ? ': ' + msgText : ''}` });
              chats[currentChatIdx].history.push({ role: 'ai', text: `‚ùå Audio API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` });
              continue;
            }
            chats[currentChatIdx].history.push({ role: 'user', text: `[Audio] ${audio.name}${msgText ? ': ' + msgText : ''}` });
            if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('‚ùå Could not process the audio.'); chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Could not process the audio.' }); }
          }

          for (const vid of videos) {
            let fd = new FormData(); fd.append('prompt', msgText ? msgText : 'Watch this video and explain what it‚Äôs about in simple English. Give a visual description and audio transcript if possible.'); fd.append('file', vid);
            let res = await fetch('https://web-production-9a18.up.railway.app/understand-video', { method: 'POST', body: fd });
            let txt = await res.text(); let data;
            try { data = JSON.parse(txt); } catch (err) {
              chats[currentChatIdx].history.push({ role: 'user', text: `[Video] ${vid.name}${msgText ? ': ' + msgText : ''}` });
              chats[currentChatIdx].history.push({ role: 'ai', text: `‚ùå Video API error. Server did not return JSON. Raw response:\n\n\`\`\`\n${txt}\n\`\`\`` });
              continue;
            }
            chats[currentChatIdx].history.push({ role: 'user', text: `[Video] ${vid.name}${msgText ? ': ' + msgText : ''}` });
            if (data && data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); } else { await typeBotMessage('‚ùå Could not process the video.'); chats[currentChatIdx].history.push({ role: 'ai', text: '‚ùå Could not process the video.' }); }
          }

          if (chatFile) chatFile.value = '';
          uploadedFiles = []; uploadData = null; renderFilePreview(); saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          return;
        } catch (err) {
          removeTyping();
          chats[currentChatIdx].history.push({ role: 'ai', text: '[File upload failed] ' + (err.message || 'no net') });
          if (chatFile) chatFile.value = '';
          uploadedFiles = []; uploadData = null;
          renderFilePreview();
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
          return;
        }
      }

      // --------- TEXT / COMMAND chat logic ----------
      // ensure the chat history array exists
      if (!chats[currentChatIdx]) chats[currentChatIdx] = { name: `Chat ${currentChatIdx + 1}`, history: [] };

      chats[currentChatIdx].history.push({ role: 'user', text: msgText });
      if (chats[currentChatIdx].history.length === 1) {
        chats[currentChatIdx].name = msgText.slice(0, 25) + "...";
        renderChatSelector();
      }
      renderChatBox(chats[currentChatIdx]?.history || []);
      showTypingAtNext();

      try {
        let res, data;
        if (/^\/image\s+/i.test(msgText)) {
          const imagePrompt = msgText.replace(/^\/image\s+/i, '');
          res = await fetch('https://web-production-9a18.up.railway.app/generate-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: imagePrompt })
          });
          try { data = await res.json(); } catch (_) { data = {}; }
          removeTyping();
          if (data.image_b64) {
            showAIImagePreview('data:image/png;base64,' + data.image_b64, '(Your image‚Äîdownload or close)');
            chats[currentChatIdx].history.push({ role: 'ai', text: '‚úÖ Image generated! (Use the floating preview box below to view or download. This image is NOT stored in chat history.)' });
          } else {
            chats[currentChatIdx].history.push({ role: 'ai', text: data.error || '‚ùå Image generation failed. Try another prompt.' });
          }
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
        } else {
          const history = (chats[currentChatIdx].history || []).map(m => ({ role: m.role, content: m.text }));
          res = await fetch('https://web-production-9a18.up.railway.app/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msgText, user_id: currentUser?.uid || 'user', history }) });
          try { data = await res.json(); } catch (_) { data = {}; }
          removeTyping();
          if (data.response) { await typeBotMessage(data.response); chats[currentChatIdx].history.push({ role: 'ai', text: data.response }); }
          else { await typeBotMessage('ü§ñ Bot replied (no response).'); chats[currentChatIdx].history.push({ role: 'ai', text: 'ü§ñ Bot replied (no response).' }); }
          saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
        }
      } catch (err) {
        removeTyping();
        await typeBotMessage('Sorry, bot error: ' + (err?.message || err));
        if (!chats[currentChatIdx]) chats[currentChatIdx] = { history: [] };
        chats[currentChatIdx].history.push({ role: 'ai', text: 'Sorry, bot error: ' + (err?.message || err) });
        saveChats(); renderChatSelector(); renderChatBox(chats[currentChatIdx]?.history || []);
      }
    });
  } // end chatForm

  /* ---------- AI Image preview UI ---------- */
  const aiPrevBox = $('ai-image-preview');
  const aiPrevClose = $('ai-image-close');
  const aiPrevDLBtn = $('ai-image-dl');
  const aiPrevImgBox = $('ai-image-container');

  if (aiPrevClose && aiPrevBox && aiPrevImgBox) aiPrevClose.addEventListener('click', () => { aiPrevBox.style.display = 'none'; aiPrevImgBox.innerHTML = ''; });
  if (aiPrevDLBtn && aiPrevImgBox) aiPrevDLBtn.addEventListener('click', () => {
    const img = aiPrevImgBox.querySelector('img'); if (img) { const url = img.src; const a = document.createElement('a'); a.href = url; a.download = 'generated_image.png'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
  });

  function showAIImagePreview(srcUrlOrBase64, caption = '') {
    if (!aiPrevBox || !aiPrevImgBox) return;
    let src = (typeof srcUrlOrBase64 === 'string' && (srcUrlOrBase64.startsWith('data:') || srcUrlOrBase64.startsWith('blob:'))) ? srcUrlOrBase64 : 'data:image/png;base64,' + srcUrlOrBase64;
    aiPrevImgBox.innerHTML = `<img src="${src}" alt="AI gen" style="max-width:210px;max-height:210px;border-radius:12px;box-shadow:0 0 8px #00fff2c7;margin:0 auto;display:block;">` + (caption ? ' <div style="color:#aee;font-size:.95em;margin-top:3px;text-align:center;">' + caption + '</div>' : '');
    aiPrevBox.style.display = 'block';
  }

  // initial UI small setup
  currentModelIdx = 0;
  if (chatInput) { chatInput.value = '/image photoreal '; chatInput.focus(); try { chatInput.setSelectionRange(chatInput.value.length, chatInput.value.length); } catch (_) {} }

  // final initial render
  try { renderChatsListSidebar(); } catch (e) {}
  try { renderChatSelector(); } catch (e) {}
  try { renderChatBox(chats[currentChatIdx]?.history || []); } catch (e) {}

}); // end DOMContentLoaded
</script>
</body>
</html>
