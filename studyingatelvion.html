<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Elvion LMS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Your Elvion University learning dashboard. Track progress, access courses, and update your profile." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ---------------------- 1. THEME & GLOBALS ---------------------- */
    :root {
      --cyan: #00ffff;
      --blue: #0090ff;
      --dark-blue: #0a1128;
      --card-bg: rgba(18,26,48,0.97);
      --header-bg: rgba(18,26,48,0.99);
      --border-glow: 0 0 11px var(--cyan), 0 0 24px var(--blue);
      --radius: 15px;
      --bg: #0a1128;
      --text: #e0e0e0;
      --muted: #a7b2c3;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(120deg, #181d32 50%, #132142 100%);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      transition: margin-left .3s; /* For sidebar integration */
    }

    /* ---------------------- 2. HEADER & PROFILE ---------------------- */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 24px 4vw 8px 4vw; background: var(--header-bg);
      box-shadow: var(--border-glow); border-radius:0 0 28px 28px;
    }
    .title { font-family:Orbitron,sans-serif; font-size:1.63em; color:var(--cyan); text-shadow:var(--border-glow);}
    .profile {
      display:flex; align-items:center; gap:13px;
      background: #181e36; border-radius:12px; padding:8px 17px;
      box-shadow: 0 0 16px 2px #00ffff07;
    }
    .profile-img {
      width:52px; height:52px; border-radius:50%; background:#232857;
      object-fit:cover; border:2px solid var(--cyan);
    }
    .profile-info b { color:var(--cyan);}
    .prof-actions { margin-left:14px; display: flex; gap: 7px;}
    .prof-actions button {
      background: none; border:none; color:var(--cyan); cursor:pointer;
      font-size:1.25em; opacity:.85; transition: opacity .2s;
      vertical-align: middle;
    }
    .prof-actions button:hover { opacity: 1; text-shadow: 0 0 5px var(--cyan);}

    /* ---------------------- 3. MAIN CONTENT & GRID ---------------------- */
    main { max-width:1060px; margin:28px auto 0 auto; padding:20px;}
    h2 { font-family:Orbitron,sans-serif; color:var(--cyan); margin-bottom:20px; }
    .courses-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:2em;
      margin-bottom:28px;
    }
    .course-card {
      background: var(--card-bg); border-radius:var(--radius); padding:20px 16px;
      box-shadow: var(--border-glow);
      display: flex; flex-direction:column; gap:13px;
      cursor: pointer; transition: box-shadow .17s, transform .19s, border .17s;
      border:2.1px solid #131b30;
      position: relative;
    }
    .course-card:hover {
      box-shadow: 0 0 22px var(--cyan),0 0 44px #00c2ff49;
      border:2.1px solid var(--cyan);
      transform: scale(1.02);
      z-index:4;
    }
    .course-card.completed { border-color: #00ff88; box-shadow: 0 0 10px #00ff8855; }

    .course-header { display: flex; align-items: center; justify-content: space-between; }
    .course-title {font-size:1.19em; font-weight:700; color:#fff; font-family:Orbitron,sans-serif; }
    .course-icon { font-size: 1.5em; color: var(--cyan); }
    .course-intro {font-size:.97em; color:var(--muted); flex-grow: 1;}
    .course-meta { font-size:.92em; color:var(--cyan);}

    /* PROGRESS BAR STYLES */
    .progress-container {
      height: 7px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      margin-top: 5px;
      overflow: hidden;
      margin-bottom: 7px;
    }
    .progress-bar {
      height: 100%;
      width: 0%; /* Dynamic via JS */
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      transition: width 0.5s ease-out;
      box-shadow: 0 0 5px var(--cyan);
    }
    .progress-text {
      font-size: 0.9em;
      font-weight: 600;
      color: var(--cyan);
      text-align: right;
      font-family: Orbitron, sans-serif;
    }

    /* START BUTTON */
    .start-btn {
      margin-top:9px;
      background: linear-gradient(90deg, var(--cyan), var(--blue));
      color: #161d28; border: none; border-radius: 12px; padding: 8px 0;
      font-size: 1em; font-family:'Orbitron',sans-serif; font-weight:700; cursor:pointer;
      box-shadow: 0 0 13px #00c3ff99;
      text-transform:uppercase;
      letter-spacing:.04em;
      transition: background .11s, transform .10s;
    }
    .start-btn:hover { background: var(--blue); color:#fff; transform:scale(1.02);}
    .start-btn:active { transform:scale(0.99);}

    /* ---------------------- 4. COURSE DETAILS & MODAL ---------------------- */
    .course-details {
      padding:23px 19px 11px 19px; margin:20px auto; background:rgba(15,32,60,0.91);
      border-radius:14px; box-shadow:0 0 19px #0090ff18;
      max-width:600px; display:none; animation:fadeInDetail .85s;
    }
    @keyframes fadeInDetail {from{opacity:0;transform:translateY(15px);}to{opacity:1; transform:translateY(0);}}
    .edit-modal-bg {
      position: fixed; left:0; top:0; width:100vw; height:100vh;
      background:rgba(5,19,38,.69); display:none; align-items:center; justify-content:center; z-index:5000;
    }
    .edit-modal {
      background:rgba(18,27,38,0.99); color:#e0e0e0; border-radius:14px; padding:27px 21px; min-width:320px;
      box-shadow:0 0 30px #00fff2,0 0 12px #0071cf55; position:relative; max-width:98vw;
    }
    .edit-modal label {color:var(--cyan);font-family:Orbitron,sans-serif;font-size:.97em;margin-bottom:3px;display:block;}
    /* Modal Inputs */
    .edit-modal input,.edit-modal textarea{
      width:100%; max-width:400px; padding:7px 10px; border-radius:8px; border:1.5px solid #274355;
      background:#131c2c; color:#f5f5f5; font-size:1em; font-family:Inter,sans-serif;margin-bottom:13px;
    }
    .edit-modal .btns { text-align:right;margin-top:7px;}
    .edit-modal .btns button {
      background:var(--cyan); color:#222; border:none; border-radius:7px; font-family:Orbitron,sans-serif;
      padding:7.2px 26px; margin-left:7px; font-weight:700; text-transform:uppercase; font-size: 1em; letter-spacing:.04em;
      box-shadow:0 0 4px #0fffff60; cursor:pointer;
      transition:background .11s;
    }
    .edit-modal .btns button.cancel {background:#19243c; color:#aee;}
    .edit-close {position:absolute;right:14px;top:14px;font-size:1.7em;color:#00ffff;cursor:pointer;}

    /* NEW: Lesson Viewer Styles */
    .lesson-viewer {
      padding:23px 19px 11px 19px; margin:20px auto; background:rgba(15,32,60,0.91);
      border-radius:14px; box-shadow:0 0 19px #0090ff18;
      max-width:800px; display:none; animation:fadeInDetail .85s; /* Keep fadeInDetail animation */
    }
    .lesson-viewer h3, .lesson-viewer h4 {
        font-family: Orbitron, sans-serif;
        color: var(--cyan);
        margin-top: 1.5em;
        margin-bottom: 0.8em;
    }
    .lesson-viewer p {
        font-size: 1em;
        line-height: 1.6;
        color: var(--text);
        margin-bottom: 1em;
    }
    .content-block {
        margin-bottom: 2em;
        padding: 15px;
        background: rgba(18, 26, 48, 0.7);
        border-radius: 10px;
        border: 1px solid #00ffff1a;
    }
    .code-snippet {
        background: #131c2c;
        border: 1px solid #274355;
        border-left: 5px solid var(--blue);
        padding: 15px;
        border-radius: 8px;
        font-family: 'Fira Code', 'Cascadia Code', monospace; /* Add a monospace font for code */
        font-size: 0.9em;
        overflow-x: auto;
        margin-top: 15px;
        color: #e0e0e0;
    }
    .code-snippet pre {
        margin: 0;
    }
    .audio-player-container, .video-player-container {
        margin-top: 15px;
        margin-bottom: 15px;
        text-align: center;
    }
    .audio-player-container audio, .video-player-container iframe {
        width: 100%;
        max-width: 560px; /* Standard video width */
        height: 80px; /* For audio */
        border-radius: 10px;
        background: #131c2c;
        border: none;
    }
    .video-player-container iframe {
        height: 315px; /* Standard video height */
    }
    .lesson-progress-indicator {
        text-align: center;
        margin-top: 20px;
        font-size: 0.95em;
        color: var(--muted);
    }
    .lesson-progress-indicator b {
        color: var(--cyan);
    }


    /* ---------------------- 5. RESPONSIVENESS & STARS ---------------------- */
    @media (max-width:650px){ header,main{padding:13px!important;} .course-details, .lesson-viewer{padding:12px 7px;}}
    @media (max-width:410px){ .profile-img{width:38px;height:38px;} .edit-modal{padding:4vw;}}

    /* STAR BG STYLES (Simple for demo) */
    #stars-container {position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1;}
    .star {
      position: absolute; background: #fff; border-radius: 50%;
      box-shadow: 0 0 4px 1px var(--cyan);
      opacity: 0; animation: blink 2s infinite alternate;
    }
    @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; }}

  </style>
</head>
<body>
<div id="stars-container"></div>
<header>
  <span class="title">ELVION LMS</span>
  <div class="profile">
    <img id="profile-img" src="https://i.pravatar.cc/150?img=12" class="profile-img" alt="profile image" />
    <div class="profile-info">
      <div><b id="displayName">User Name</b></div>
      <small style="color:#aee;" id="user-email">user@elvion.edu</small>
    </div>
    <div class="prof-actions">
      <button title="Notifications"><i class="fa fa-bell"></i></button>
      <button title="Edit profile" id="edit-profile-btn"><i class="fa fa-user-edit"></i></button>
      <button title="Logout" id="logout-btn"><i class="fa fa-sign-out-alt"></i></button>
    </div>
  </div>
</header>
<main>
  <h2>My Courses & Learning Path</h2>
  <div style="margin-bottom: 20px;">
    <input type="text" placeholder="Search courses by code or name..."
           style="width: 100%; max-width: 400px; padding: 10px; border-radius: 8px; border: 1px solid #00ffff55; background: #181d32; color: var(--text);">
  </div>

  <div class="courses-grid" id="courses-grid"></div>
  <div class="course-details" id="course-details"></div>

  <!-- NEW: Lesson Viewer Section -->
  <div class="lesson-viewer" id="lesson-viewer" style="display:none;">
    <button id="backToCoursesBtn" class="start-btn" style="margin-bottom:20px; width:fit-content; padding: 10px 25px;">
        <i class="fa fa-arrow-left"></i> Back to Courses
    </button>
    <div id="current-lesson-content">
      <!-- Specific day's content will be loaded here dynamically -->
    </div>
    <div id="lesson-navigation" style="display:flex; justify-content:space-between; margin-top:30px; gap: 10px;">
        <button id="prevDayBtn" class="start-btn" style="width:48%; display:none;"><i class="fa fa-chevron-left"></i> Previous Day</button>
        <button id="nextDayBtn" class="start-btn" style="width:48%; display:none;">Next Day <i class="fa fa-chevron-right"></i></button>
        <button id="markDayCompleteBtn" class="start-btn" style="width:100%; display:none; background:linear-gradient(90deg, #00ff88, #00cc66); box-shadow:0 0 13px #00ff8899;">Mark Day as Complete <i class="fa fa-check"></i></button>
    </div>
  </div>
</main>

<div class="edit-modal-bg" id="edit-modal-bg">
  <form class="edit-modal" id="edit-modal" onsubmit="return false;">
    <span class="edit-close" id="modal-close-btn">&times;</span>
    <h3 style="color:var(--cyan);text-align:center;margin-top:0">Edit Profile</h3>
    <label for="edit-name">Name</label>
    <input type="text" id="edit-name" required>
    <label for="edit-photo">Photo URL</label>
    <input type="url" id="edit-photo" placeholder="https://link.to/photo.jpg">
    <label for="edit-dob">Date of Birth</label>
    <input type="date" id="edit-dob">
    <label for="edit-bio">Bio/About Me</label>
    <textarea id="edit-bio" rows="2" placeholder="A few words about you"></textarea>
    <div class="btns">
      <button type="button" id="save-profile-btn">Save</button>
      <button type="button" class="cancel" id="cancel-profile-btn">Cancel</button>
    </div>
  </form>
</div>

<script type="module">
  // STAR BG (Simplified for efficiency)
  document.addEventListener('DOMContentLoaded', () => {
    const starsContainer = document.getElementById('stars-container');
    const numStars = 45, minSize = 1, maxSize = 2.5;
    for (let i = 0; i < numStars; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * (maxSize - minSize) + minSize;
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = Math.random() * 100 + '%';
      star.style.top = Math.random() * 100 + '%';
      star.style.animationDelay = (Math.random() * 4) + 's';
      star.style.animationDuration = (2.4 + Math.random() * 1.8) + 's';
      starsContainer.appendChild(star);
    }
  });

  // ----------------- FIREBASE SETUP -----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyROm0aBGjry6NUfhNM3e0qwPcCDoIqSk",
    authDomain: "elvionai.firebaseapp.com",
    projectId: "elvionai",
    storageBucket: "elvionai.firebasestorage.app",
    messagingSenderId: "161078300830",
    appId: "1:161078300830:web:f460df8591704eb0e96b8f"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // -------- COURSE LIST (with new icons and randomized progress)
  const courses = [
    { key: "cs", title: "Computer Science", intro: "Foundations of software, programming, and digital algorithms.", code: "CSC 101", meta: "Science & Tech", mediaType: "video", media: "https://www.youtube.com/embed/5Qwwjych21o", icon: "fa-laptop-code", progress: 0 }, // Progress will be dynamic
    { key: "law", title: "Law (ELV)", intro: "Active learning on constitutional law, contracts, legal writing, and advocacy.", code: "LAW 101", meta: "Faculty of Law", mediaType: "video", media: "https://www.youtube.com/embed/_c6iHL2Zd5o", icon: "fa-scale-balanced", progress: 0 },
    { key: "literature", title: "English & Literary Studies", intro: "Explore English structure, world literature, and creative writing.", code: "ENG 101", meta: "Arts & Humanities", mediaType: "audio", media: "/assets/intro-arts.mp3", icon: "fa-book-open-reader", progress: 0 },
    { key: "history", title: "History & Strategic Studies", intro: "Modern world history, strategy and global affairs.", code: "HIS 101", meta: "Arts & Humanities", mediaType: "audio", media: "/assets/intro-history.mp3", icon: "fa-landmark", progress: 0 },
    { key: "masscomm", title: "Mass Communication", intro: "Broadcasting, journalism, PR & media production.", code: "MASS 101", meta: "Social Sciences", mediaType: "audio", media: "/assets/intro-masscomm.mp3", icon: "fa-satellite-dish", progress: 0 },
    { key: "business", title: "Business Administration", intro: "Principles of management, entrepreneurship, and finance.", code: "BUS 101", meta: "Social Sciences", mediaType: "audio", media: "/assets/intro-business.mp3", icon: "fa-chart-line", progress: 0 },
    { key: "mathed", title: "Mathematics Education", intro: "Effective teaching and learning methods for math.", code: "MATED 101", meta: "Faculty of Education", mediaType: "audio", media: "/assets/intro-mathed.mp3", icon: "fa-calculator", progress: 0 },
    { key: "adulted", title: "Adult Education", intro: "How adults learn: strategies for teaching and community engagement.", code: "AED 101", meta: "Faculty of Education", mediaType: "audio", media: "/assets/intro-adulted.mp3", icon: "fa-user-graduate", progress: 0 }
  ];

  // --- NEW: DETAILED COURSE CONTENT STRUCTURE ---
  const detailedCourseContent = {
    "cs": { // Computer Science course key
      title: "Introduction to Programming (CSC 101)",
      totalDays: 7, // Total number of days for this course
      days: {
        1: {
          title: "Day 1: Introduction to Programming Concepts",
          content: `
            <p>Welcome to the exciting world of programming! Today, we'll lay the groundwork for your journey into creating software. 🦅</p>
            <div class="audio-player-container">
              <audio controls><source src="/assets/cs/csc101-day1-intro.mp3" type="audio/mpeg"></audio>
            </div>
            <div class="content-block">
              <h4>What is Programming?</h4>
              <p>At its core, programming is about giving instructions to a computer to perform specific tasks. Think of it like writing a recipe, but for a machine! Each instruction must be precise and unambiguous. Without programming, computers are just fancy calculators, *abi*?</p>
              <div class="video-player-container">
                <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe> <!-- Placeholder video -->
              </div>
            </div>
            <div class="content-block">
              <h4>Why Learn to Program?</h4>
              <p>Learning to program isn't just about becoming a developer; it's about developing problem-solving skills, logical thinking, and creativity. You learn to break down complex problems into smaller, manageable steps. It's like having a superpower to build anything you can imagine!</p>
            </div>
            <div class="content-block">
              <h4>Programming Languages: High-level vs. Low-level</h4>
              <p>Just like humans speak different languages, computers understand different programming languages. High-level languages (like Python, JavaScript) are easier for humans to read and write. Low-level languages (like Assembly) are closer to what the computer's hardware understands.</p>
            </div>
          `,
          media: {
            audio: "/assets/cs/csc101-day1-intro.mp3", // Placeholder
            video: "https://www.youtube.com/embed/dQw4w9WgXcQ" // Example video
          }
        },
        2: {
          title: "Day 2: Your First Program: Hello World!",
          content: `
            <p>Today, you'll write your very first program! It's a rite of passage for every programmer – the "Hello, World!" program. Get ready to make your computer say hi! 👋</p>
            <div class="content-block">
              <h4>Setting up a Development Environment (Conceptually)</h4>
              <p>While we won't install anything today, understanding what a development environment is crucial. It's the set of tools (like a text editor and a compiler/interpreter) that programmers use to write, test, and run their code.</p>
            </div>
            <div class="content-block">
              <h4>Syntax and Basic Structure (Python Example)</h4>
              <p>Every language has its rules. In Python, printing text is super simple!</p>
              <div class="code-snippet">
                <pre><code>print("Hello, World!")</code></pre>
              </div>
              <p>The <code>print()</code> function tells the computer to display whatever is inside the parentheses.</p>
            </div>
            <div class="content-block">
              <h4>Variables and Data Types</h4>
              <p>Variables are like containers for storing data. Data types define the kind of data a variable can hold (e.g., numbers, text).</p>
              <div class="code-snippet">
                <pre><code>message = "Hello, Elvion Learner!"  # 'message' is a variable, "Hello..." is a string data type
name = "Philly"
age = 30 # 'age' is an integer data type
is_student = True # 'is_student' is a boolean data type

print(message)
print("My name is", name, "and I am", age, "years old.")
                </code></pre>
              </div>
              <p>See? You just made your computer remember things! *E no hard at all!*</p>
            </div>
          `,
          media: {
            audio: "/assets/cs/csc101-day2-hello.mp3" // Placeholder
          }
        },
        // TODO: Add Day 3, Day 4, Day 5, Day 6, Day 7 content here for CSC 101
        // Example structure for Day 3:
        /*
        3: {
          title: "Day 3: Operators and Expressions",
          content: `
            <p>Today, we're diving into how computers perform calculations and make comparisons. Operators are the verbs of programming!</p>
            <div class="content-block">
              <h4>Arithmetic Operators</h4>
              <p>These are what you expect: addition (+), subtraction (-), multiplication (*), division (/), modulus (%), and exponentiation (**).</p>
              <div class="code-snippet">
                <pre><code>result = 10 + 5    # 15
remainder = 17 % 3 # 2
power = 2 ** 3     # 8
print(result, remainder, power)</code></pre>
              </div>
            </div>
            <div class="content-block">
              <h4>Relational Operators</h4>
              <p>Used for comparing values, they always return True or False. Think greater than (>), less than (<), equal to (==), not equal to (!=).</p>
              <div class="code-snippet">
                <pre><code>print(5 > 3)   # True
print(10 == 10) # True
print(7 != 7)  # False</code></pre>
              </div>
            </div>
          `,
          media: {
            audio: "/assets/cs/csc101-day3-operators.mp3"
          }
        },
        */
      }
    },
    // TODO: Add other detailed courses like "law", "literature", etc. here
    // For courses without detailed content yet, they'll just show the summary from 'courses' array
  };


  // ----------------- CORE LMS FUNCTIONS -----------------

  // NEW: Global variables for tracking current lesson state
  let currentCourseKey = null;
  let currentDay = 1;
  let userProgress = {}; // To store { courseKey: { currentDay: X, completedDays: [Y, Z] } }

  // Populate course grid with progress bars and dynamic buttons
  function renderCourses() {
    const cg = document.getElementById("courses-grid");
    cg.innerHTML = courses.map(c => {
      // NEW: Calculate progress based on detailedCourseContent and userProgress
      const courseUserProgress = userProgress[c.key] || { currentDay: 1, completedDays: [] };
      const totalDaysInCourse = detailedCourseContent[c.key] ? detailedCourseContent[c.key].totalDays : 1; // Default to 1 if no detailed content
      const completedCount = courseUserProgress.completedDays.length;
      const calculatedProgress = totalDaysInCourse > 0 ? Math.floor((completedCount / totalDaysInCourse) * 100) : 0;

      const isCompleted = calculatedProgress >= 100;
      const statusClass = isCompleted ? 'completed' : (calculatedProgress > 0 ? 'in-progress' : 'new');
      let buttonText = isCompleted ? 'Review Course' : 'Start Studying';
      if (calculatedProgress > 0 && !isCompleted) {
          buttonText = 'Continue Learning';
      }

      return `
        <div class="course-card ${statusClass}" data-key="${c.key}">
          <div class="course-header">
            <div class="course-title">${c.title}</div>
            <i class="fa ${c.icon} course-icon" title="${c.meta}"></i>
          </div>
          <div class="course-meta">${c.code} &middot; ${c.meta}</div>
          <div class="progress-text">${isCompleted ? 'Completed' : calculatedProgress + '% Progress'}</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${calculatedProgress}%;"></div>
          </div>
          <div class="course-intro">${c.intro}</div>
          <button class="start-btn" data-key="${c.key}">${buttonText}</button>
        </div>
      `;
    }).join('');

    // Attach event listeners after rendering (cleaner than inline onclick)
    document.querySelectorAll('.course-card').forEach(card => {
        card.addEventListener('click', (e) => {
            // Prevent card click when clicking the button
            if (e.target.closest('.start-btn')) return;
            selectCourse(card.dataset.key);
        });
    });
    document.querySelectorAll('.start-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevents card click event
            startStudying(btn.dataset.key);
        });
    });
  }

  // NEW: Function to load and display specific lesson content
  async function loadLesson(courseKey, dayNum) {
    const lessonViewer = document.getElementById('lesson-viewer');
    const currentLessonContent = document.getElementById('current-lesson-content');
    const lessonNav = document.getElementById('lesson-navigation');
    const prevBtn = document.getElementById('prevDayBtn');
    const nextBtn = document.getElementById('nextDayBtn');
    const markCompleteBtn = document.getElementById('markDayCompleteBtn');
    const coursesGrid = document.getElementById('courses-grid');

    const courseDetails = detailedCourseContent[courseKey];
    if (!courseDetails || !courseDetails.days[dayNum]) {
      currentLessonContent.innerHTML = `<p style="color:red;">Lesson content not found for Day ${dayNum}. Please check the detailedCourseContent object.</p>`;
      lessonNav.style.display = 'none';
      return;
    }

    currentCourseKey = courseKey;
    currentDay = dayNum;

    const dayContent = courseDetails.days[dayNum];
    currentLessonContent.innerHTML = `
      <h3 style="margin-top:0;">${dayContent.title}</h3>
      <div class="lesson-progress-indicator">
          <b>${courseDetails.title}</b> &mdash; Day ${currentDay} of ${courseDetails.totalDays}
      </div>
      ${dayContent.content}
    `;

    // Update navigation buttons
    prevBtn.style.display = dayNum > 1 ? 'block' : 'none';
    nextBtn.style.display = dayNum < courseDetails.totalDays ? 'block' : 'none';

    // Show mark complete button only if not already completed
    const progressForCourse = userProgress[courseKey] || { currentDay: 1, completedDays: [] };
    const isDayCompleted = progressForCourse.completedDays.includes(dayNum);
    markCompleteBtn.style.display = isDayCompleted ? 'none' : 'block';

    // Adjust button widths if only one nav button is visible
    if (prevBtn.style.display === 'none' && nextBtn.style.display === 'block') {
        nextBtn.style.width = '100%';
    } else if (prevBtn.style.display === 'block' && nextBtn.style.display === 'none') {
        prevBtn.style.width = '100%';
    } else {
        prevBtn.style.width = '48%';
        nextBtn.style.width = '48%';
    }

    // Hide main course grid and course details, show lesson viewer
    coursesGrid.style.display = 'none';
    document.getElementById('course-details').style.display = 'none';
    lessonViewer.style.display = 'block';
    window.scrollTo({ top: 0, behavior: "smooth" }); // Scroll to top
  }

  // NEW: Handles clicking "Start Studying" or "Continue Learning"
  function startStudying(key) {
    // Check if detailed content exists for this course
    if (detailedCourseContent[key]) {
      const progressForCourse = userProgress[key] || { currentDay: 1, completedDays: [] };
      loadLesson(key, progressForCourse.currentDay);
    } else {
      // Fallback for courses without detailed content yet (or redirect to external link)
      alert(`Course "${courses.find(c => c.key === key).title}" is not yet fully structured with daily lessons. Showing summary.`);
      selectCourse(key); // Show the summary card instead
    }
  }

  // Course Details Display (now only shows summary, not direct lesson)
  function selectCourse(key) {
    const c = courses.find(x => x.key === key);
    if (!c) return;
    const cont = document.getElementById('course-details');
    const lessonViewer = document.getElementById('lesson-viewer');
    const coursesGrid = document.getElementById('courses-grid');

    let mediaHtml = c.mediaType === "audio"
      ? `<audio controls class="course-audio" style="width:100%;margin-top:7px;"><source src="${c.media}" type="audio/mpeg"></audio>`
      : `<iframe src="${c.media}" frameborder="0" allowfullscreen style="width:100%;height:220px;border-radius:13px;"></iframe>`;

    // Calculate progress for summary card
    const courseUserProgress = userProgress[c.key] || { currentDay: 1, completedDays: [] };
    const totalDaysInCourse = detailedCourseContent[c.key] ? detailedCourseContent[c.key].totalDays : 1;
    const completedCount = courseUserProgress.completedDays.length;
    const calculatedProgress = totalDaysInCourse > 0 ? Math.floor((completedCount / totalDaysInCourse) * 100) : 0;
    const isCompleted = calculatedProgress >= 100;
    let buttonText = isCompleted ? 'Review Course' : 'Start Studying';
    if (calculatedProgress > 0 && !isCompleted) {
        buttonText = 'Continue Learning';
    }

    const progressBreakdown = `
        <div style="margin-top: 15px; border-top: 1px solid #00ffff10; padding-top: 15px;">
            <h4 style="color:var(--cyan); margin: 0 0 10px 0;">Your Progress: ${calculatedProgress}%</h4>
            <ul style="list-style: none; padding: 0; font-size: 0.95em;">
                <li style="margin-bottom: 5px;"><i class="fa fa-check-circle" style="color:#00ff88;"></i> Completed Days: ${completedCount}</li>
                <li style="margin-bottom: 5px;"><i class="fa fa-dot-circle" style="color:var(--cyan);"></i> Current Day: ${courseUserProgress.currentDay}</li>
            </ul>
        </div>
    `;

    cont.innerHTML = `
      <h3 style="color:var(--cyan);margin-top:0">${c.title}</h3>
      <div style="color:var(--cyan); font-size:1.1em; margin-bottom:6px;">${c.code} &middot; ${c.meta}</div>
      <div style="margin-bottom:1em;">${mediaHtml}</div>
      <div class="course-intro">${c.intro}</div>
      ${progressBreakdown}
      <button class="start-btn" style="margin-top:2em;" data-key="${c.key}">${buttonText}</button>
      <span class="course-meta" style="margin-top:10px;display:block">Duration: 1 Semester &nbsp; | &nbsp; Credits: 3.0 Cr</span>
    `;

    coursesGrid.style.display = 'none'; // Hide grid
    lessonViewer.style.display = 'none'; // Hide lesson viewer if open
    cont.style.display = "block"; // Show course details

    cont.querySelector('.start-btn').addEventListener('click', () => startStudying(c.key));
    window.scrollTo({ top: cont.offsetTop - 100, behavior: "smooth" });
  }


  // ----------------- PROFILE & AUTH FUNCTIONS -----------------
  let currentUser = null;
  let userDocRef = null;

  onAuthStateChanged(auth, async user => {
    if (!user) {
      // window.location.href = "enroll.html"; // Redirect to login
      // Failsafe for demo: use placeholder data if user is null
      currentUser = { uid: "demo-user", displayName: "A. Student", email: "demo@elvion.edu", photoURL: 'https://i.pravatar.cc/150?img=12' };
      // Demo user progress
      userProgress = {
          "cs": { currentDay: 1, completedDays: [] }, // Example: CS starts at Day 1
          "law": { currentDay: 1, completedDays: [] } // Example: Law starts at Day 1
      };
    } else {
      currentUser = user;
      userDocRef = doc(db, "users", user.uid);
      const snap = await getDoc(userDocRef);
      if(snap.exists()){
        const extra = snap.data();
        document.getElementById('edit-dob').value = extra.dob || "";
        document.getElementById('edit-bio').value = extra.bio || "";
        // NEW: Load user progress from Firestore
        userProgress = extra.progress || {};
      } else {
        // NEW: Initialize progress for new users in Firestore
        await setDoc(userDocRef, { progress: {} }, { merge: true });
        userProgress = {}; // Ensure userProgress is empty for new users
      }
    }

    document.getElementById("displayName").textContent = currentUser.displayName || currentUser.email.split('@')[0];
    document.getElementById("user-email").textContent = currentUser.email || "";
    document.getElementById("profile-img").src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||currentUser.email||'EV')}&background=190021&color=fff&bold=true&rounded=true&size=128`;

    renderCourses(); // Render courses once we have the user context and progress
  });

  document.getElementById('logout-btn').addEventListener('click', () => {
    signOut(auth);
    // window.location.href="enroll.html";
    alert("Logged out! (Demo mode)");
    location.reload();
  });

  // Modal logic using event listeners
  const modalBg = document.getElementById('edit-modal-bg');
  const editName = document.getElementById('edit-name');
  const editPhoto = document.getElementById('edit-photo');

  function openEditModal() {
    modalBg.style.display = "flex";
    editName.value = currentUser.displayName || "";
    editPhoto.value = currentUser.photoURL || "";
    editName.focus(); // Accessibility: set focus to the first input
  }
  function closeEditModal() {
    modalBg.style.display = "none";
  }

  document.getElementById('edit-profile-btn').addEventListener('click', openEditModal);
  document.getElementById('modal-close-btn').addEventListener('click', closeEditModal);
  document.getElementById('cancel-profile-btn').addEventListener('click', closeEditModal);

  document.getElementById('save-profile-btn').addEventListener('click', async () => {
    const name = editName.value.trim();
    const photo = editPhoto.value.trim();
    const dob = document.getElementById('edit-dob').value;
    const bio = document.getElementById('edit-bio').value.trim();

    const saveButton = document.getElementById('save-profile-btn');
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    try {
      // 1. Update Firebase Auth (if real user)
      if (currentUser.uid !== "demo-user") {
          await updateProfile(currentUser, {
              displayName: name || currentUser.displayName,
              photoURL: photo || currentUser.photoURL
          });
          // 2. Update Firestore (if real user)
          await setDoc(userDocRef, {
              name, dob, bio, photoURL: photo, email: currentUser.email, updatedAt: new Date()
          }, { merge: true });
      }

      // Update UI
      document.getElementById('displayName').textContent = name;
      document.getElementById('user-email').textContent = currentUser.email;
      document.getElementById('profile-img').src = photo || document.getElementById('profile-img').src;

      closeEditModal();
      alert('Profile saved successfully!');
    } catch(error) {
        console.error("Error saving profile:", error);
        alert("Failed to save profile. Check console for details.");
    } finally {
        saveButton.textContent = 'Save';
        saveButton.disabled = false;
    }
  });

  // NEW: Event Listeners for Lesson Navigation and Completion
  document.getElementById('backToCoursesBtn').addEventListener('click', () => {
    document.getElementById('lesson-viewer').style.display = 'none';
    document.getElementById('courses-grid').style.display = 'grid';
    document.getElementById('course-details').style.display = 'none'; // Ensure details are hidden
    renderCourses(); // Re-render to update progress bars on dashboard
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  document.getElementById('prevDayBtn').addEventListener('click', () => {
    if (currentCourseKey && currentDay > 1) {
      loadLesson(currentCourseKey, currentDay - 1);
    }
  });

  document.getElementById('nextDayBtn').addEventListener('click', () => {
    const courseDetails = detailedCourseContent[currentCourseKey];
    if (currentCourseKey && currentDay < courseDetails.totalDays) {
      loadLesson(currentCourseKey, currentDay + 1);
    }
  });

  document.getElementById('markDayCompleteBtn').addEventListener('click', async () => {
    if (!currentCourseKey || !currentUser) return;

    const progressForCourse = userProgress[currentCourseKey] || { currentDay: 1, completedDays: [] };
    if (!progressForCourse.completedDays.includes(currentDay)) {
        progressForCourse.completedDays.push(currentDay);
        progressForCourse.completedDays.sort((a, b) => a - b); // Keep completed days sorted

        // Advance to next day if this was the current day
        if (progressForCourse.currentDay === currentDay) {
            const courseDetails = detailedCourseContent[currentCourseKey];
            if (currentDay < courseDetails.totalDays) {
                progressForCourse.currentDay = currentDay + 1;
            } else {
                // If last day, stay on last day (or mark course as fully complete)
                progressForCourse.currentDay = currentDay;
            }
        }
        userProgress[currentCourseKey] = progressForCourse;

        // Save to Firebase (if not demo user)
        if (currentUser.uid !== "demo-user" && userDocRef) {
            await updateDoc(userDocRef, { progress: userProgress });
            alert(`Day ${currentDay} of ${currentCourseKey.toUpperCase()} marked as complete! Way to go! 🦅`);
        } else {
            alert(`Day ${currentDay} of ${currentCourseKey.toUpperCase()} marked as complete! (Demo Mode) You're crushing it!`);
        }

        loadLesson(currentCourseKey, currentDay); // Reload current day to update button state
        renderCourses(); // Re-render main dashboard to update progress bars
    } else {
        alert("This day is already marked as complete, my friend! You're a pro! 😉 No need to double-tap!");
    }
  });


</script>
</body>
</html>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J1YTKP10ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J1YTKP10ZX');
</script>
