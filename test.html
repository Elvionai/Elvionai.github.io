<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Language Assessment | Mr. Kola</title>
    
    <!-- Quill.js CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #005A9E;
            --secondary-color: #f0f8ff;
            --background-color: #f4f7f9;
            --text-color: #333333;
            --header-text: #ffffff;
            --container-bg: #ffffff;
            --border-color: #dee5e8;
            --button-text: #ffffff;
            --success-color: #28a745;
            --error-color: #dc3545;
            --font-heading: 'Lato', sans-serif;
            --font-body: 'Lora', serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            min-height: 100vh;
        }

        .assessment-container {
            width: 100%;
            max-width: 960px;
            background: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: var(--header-text);
            padding: 2rem;
            text-align: center;
        }

        header h1 {
            font-family: var(--font-heading);
            margin: 0;
            font-size: 2rem;
        }
        header p {
            margin: 5px 0 0;
            opacity: 0.9;
        }

        main {
            padding: 2rem;
        }

        #student-selection { text-align: center; padding: 3rem 0; }
        
        select, button {
            font-family: var(--font-heading);
            font-size: 1rem;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid var(--primary-color);
            transition: all 0.2s ease-in-out;
        }

        select {
            min-width: 250px;
            background-color: var(--container-bg);
            color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: var(--button-text);
        }

        button:hover {
            opacity: 0.85;
        }

        button:disabled {
            background-color: #a0a0a0;
            border-color: #a0a0a0;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        #timer-container {
            font-family: var(--font-heading);
            text-align: right;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .question-section, .writing-section {
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
        }
        .question-section h3, .writing-section h3 {
            font-family: var(--font-heading);
            color: var(--primary-color);
        }

        .mcq-option {
            margin: 0.8rem 0;
            line-height: 1.6;
        }

        /* Quill Editor Styling */
        #writing-editor-container { border: 1px solid var(--border-color); border-radius: 5px; }
        .ql-editor { font-family: 'Times New Roman', serif; font-size: 16px; height: 350px; }
        .ql-toolbar.ql-snow { border-radius: 5px 5px 0 0; border-color: var(--border-color); }
        .ql-container.ql-snow { border-radius: 0 0 5px 5px; border-color: var(--border-color); }


        #word-count-container {
            margin-top: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #ai-suggestions-box {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--container-bg);
            padding: 2.5rem;
            border-radius: 8px;
            max-width: 600px;
            text-align: center;
        }
        .modal-content h2 { font-family: var(--font-heading); color: var(--primary-color); }
        .modal-content ul { text-align: left; list-style-position: inside; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome to Your English Assessment</h2>
            <p>Please review the following rules before you begin:</p>
            <ul>
                <li>You will have <strong>45 minutes</strong> to complete the test.</li>
                <li>You must answer all multiple-choice questions and the writing prompt.</li>
                <li><strong>IMPORTANT:</strong> You cannot leave or switch tabs once the test begins. Doing so will immediately end your session and your access will be revoked.</li>
            </ul>
            <button id="agree-btn">I Understand and Agree</button>
        </div>
    </div>
    
    <div class="assessment-container">
        <header>
            <h1>English Language Assessment</h1>
            <p>Instructor: Mr. Kola</p>
        </header>

        <main>
            <div id="student-selection">
                <label for="student-name">Please select your name to begin:</label><br><br>
                <select id="student-name">
                    <option value="">-- Select Your Name --</option>
                    <option value="El Rohi">El Rohi</option>
                    <option value="Kingspraise">Kingspraise</option>
                </select>
            </div>
            
            <div id="assessment-content" class="hidden">
                <div id="timer-container">Time Remaining: <span id="time">45:00</span></div>

                <form id="assessment-form" action="https://formspree.io/f/mldrbpwo" method="POST">
                    <input type="hidden" id="student-name-hidden" name="student_name">
                    <input type="hidden" id="writing-content-hidden-text" name="writing_content_plain_text">

                    <!-- El Rohi's Assignment -->
                    <div id="el-rohi-assignment" class="hidden">
                        <h2>Section A: Argumentative Writing</h2>
                        <div class="question-section">
                            <h3>Multiple Choice Questions</h3>
                            <div class="mcq-option">1. What is the formal term for the topic of a debate?<br>
                                <input type="radio" name="elrohi_q1" value="a"> a) Argument <br>
                                <input type="radio" name="elrohi_q1" value="b"> b) Motion <br>
                                <input type="radio" name="elrohi_q1" value="c"> c) Stance
                            </div>
                            <!-- ... other MCQs for El Rohi ... -->
                             <div class="mcq-option">2. The "Vocative" in a debate refers to the:<br>
                                <input type="radio" name="elrohi_q2" value="a"> a) Main arguments <br>
                                <input type="radio" name="elrohi_q2" value="b"> b) Introduction <br>
                                <input type="radio" name="elrohi_q2" value="c"> c) Greeting
                            </div>
                        </div>
                        <div class="writing-section">
                            <h3>Section B: Writing Task</h3>
                            <p>Based on the lesson, write the introduction and two strong points for the **Opposing** side of the motion: "The Internet is a Better Source of Information than Textbooks". Your response must be at least 100 words.</p>
                        </div>
                    </div>

                    <!-- Kingspraise's Assignment -->
                    <div id="kingspraise-assignment" class="hidden">
                         <h2>Section A: Informal Letter Writing</h2>
                        <div class="question-section">
                            <h3>Multiple Choice Questions</h3>
                            <div class="mcq-option">1. An informal letter is typically written to:<br>
                                <input type="radio" name="kingspraise_q1" value="a"> a) A business manager <br>
                                <input type="radio" name="kingspraise_q1" value="b"> b) A government official <br>
                                <input type="radio" name="kingspraise_q1" value="c"> c) Friends and family
                            </div>
                            <!-- ... other MCQs for Kingspraise ... -->
                             <div class="mcq-option">2. Where is the writer's address and date placed in an informal letter?<br>
                                <input type="radio" name="kingspraise_q2" value="a"> a) Top left-hand corner <br>
                                <input type="radio" name="kingspraise_q2" value="b"> b) Top right-hand corner <br>
                                <input type="radio" name="kingspraise_q2" value="c"> c) Bottom of the page
                            </div>
                        </div>
                        <div class="writing-section">
                            <h3>Section B: Writing Task</h3>
                            <p>Prompt: A heavy rain recently destroyed parts of your house. Write a letter to your brother who lives in another state, telling him what happened and how he can assist the family. Your letter must be at least 150 words and include all the necessary parts of an informal letter.</p>
                        </div>
                    </div>

                    <div id="common-writing-area">
                        <div id="writing-editor-container"></div>
                        <div id="word-count-container">
                            <span>Word Count: <span id="word-count">0</span></span>
                            <button type="button" id="analyze-btn">Check Writing</button>
                        </div>
                        <div id="ai-suggestions-box" class="hidden"></div>
                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">
                        <div style="text-align: right;">
                            <button type="submit" id="submit-btn" disabled>Submit Final Assignment</button>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <!-- Quill.js Script -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // DOM Elements
        const agreeBtn = document.getElementById('agree-btn');
        const instructionsModal = document.getElementById('instructions-modal');
        const studentSelect = document.getElementById('student-name');
        const assessmentContent = document.getElementById('assessment-content');
        const elRohiAssignment = document.getElementById('el-rohi-assignment');
        const kingspraiseAssignment = document.getElementById('kingspraise-assignment');
        const wordCountDisplay = document.getElementById('word-count');
        const submitBtn = document.getElementById('submit-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const suggestionsBox = document.getElementById('ai-suggestions-box');
        const studentNameHidden = document.getElementById('student-name-hidden');
        const plainTextHidden = document.getElementById('writing-content-hidden-text');
        
        let pageLocked = false;
        let minWords = 100;

        // Initialize Quill Editor
        const quill = new Quill('#writing-editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'font': [] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'align': [] }],
                    ['blockquote', 'clean']
                ]
            }
        });

        // Event Listeners
        agreeBtn.addEventListener('click', () => {
            instructionsModal.classList.add('hidden');
        });

        studentSelect.addEventListener('change', () => {
            const selectedStudent = studentSelect.value;
            if (selectedStudent) {
                studentNameHidden.value = selectedStudent;
                document.getElementById('student-selection').classList.add('hidden');
                assessmentContent.classList.remove('hidden');

                if (selectedStudent === 'El Rohi') {
                    elRohiAssignment.classList.remove('hidden');
                    minWords = 100;
                } else if (selectedStudent === 'Kingspraise') {
                    kingspraiseAssignment.classList.remove('hidden');
                    minWords = 150;
                }
                
                startTimer(2700); // 45 minutes
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }
        });

        quill.on('text-change', () => {
            const text = quill.getText();
            plainTextHidden.value = text; // **Store clean text for submission**
            const words = text.trim().split(/\s+/).filter(Boolean);
            wordCountDisplay.textContent = words.length;
            submitBtn.disabled = words.length < minWords;
        });

        analyzeBtn.addEventListener('click', async () => {
            const text = quill.getText();
            if (!text.trim()) {
                suggestionsBox.innerHTML = 'Please write something before checking.';
                suggestionsBox.classList.remove('hidden');
                return;
            }

            suggestionsBox.innerHTML = 'Analyzing...';
            suggestionsBox.classList.remove('hidden');
            
            try {
                const response = await fetch('https://web-production-9a18.up.railway.app/api/llama/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: text,
                        systemPrompt: "You are a helpful AI writing assistant. Check the user's text for spelling and grammar errors. Provide suggestions for improvement but do not rewrite it for them. Start your response with 'Analysis:'."
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    suggestionsBox.innerHTML = data.content.replace(/\n/g, '<br>');
                } else {
                    suggestionsBox.innerHTML = 'Error: Could not analyze the text.';
                }
            } catch (error) {
                suggestionsBox.innerHTML = 'Error: Could not connect to the AI assistant.';
            }
        });

        // Functions
        function startTimer(duration) {
            let timer = duration;
            const timeDisplay = document.getElementById('time');
            const interval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timeDisplay.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    timeDisplay.textContent = "Time Expired!";
                    document.getElementById('assessment-form').submit();
                }
            }, 1000);
        }

        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden' && !pageLocked) {
                pageLocked = true;
                document.body.innerHTML = `<div style="text-align: center; padding-top: 15%;">
                                               <h1 style="font-family: var(--font-heading); color: var(--error-color);">ACCESS REVOKED</h1>
                                               <p>You have navigated away from the assessment page. Your session has been terminated.</p>
                                           </div>`;
            }
        }
    </script>
</body>
</html>
