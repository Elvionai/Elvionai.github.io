<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced English Language Assessment</title>
    <!-- Quill.js Stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-glow: #00ffcc;
            --secondary-glow: #ff00ff;
            --background-main: #121212;
            --text-color: #e0e0e0;
            --container-bg: #1e1e1e;
            --border-glow: rgba(0, 255, 204, 0.5);
            --error-color: #ff3366;
            --success-color: #33ff99;
            --font-main: 'Orbitron', sans-serif;
            --font-body: 'Roboto Mono', monospace;
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono&display=swap');

        body {
            font-family: var(--font-body);
            background-color: var(--background-main);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .assessment-container {
            width: 100%;
            max-width: 1000px;
            background: var(--container-bg);
            border: 2px solid var(--primary-glow);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 30px var(--border-glow), inset 0 0 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        header {
            text-align: center;
            border-bottom: 2px solid var(--secondary-glow);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        header h1 {
            font-family: var(--font-main);
            color: var(--primary-glow);
            margin: 0;
            font-size: 2.5rem;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        #instructions, #student-selection, #timer-container, .question-section, .writing-section {
            margin-bottom: 30px;
        }

        #instructions {
            background: rgba(255, 0, 255, 0.1);
            border: 1px solid var(--secondary-glow);
            padding: 20px;
            border-radius: 10px;
        }

        select, button {
            font-family: var(--font-body);
            background-color: transparent;
            color: var(--primary-glow);
            border: 2px solid var(--primary-glow);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        select:hover, button:hover {
            background-color: var(--primary-glow);
            color: var(--background-main);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: transparent !important;
            color: var(--primary-glow) !important;
            box-shadow: none !important;
        }

        .mcq-option { margin-bottom: 10px; }

        #writing-editor-container {
            background-color: #252525;
            color: var(--text-color);
            border: 1px solid var(--secondary-glow);
            border-radius: 5px;
        }
        .ql-toolbar, .ql-container {
            border-color: var(--secondary-glow) !important;
        }
        .ql-editor { height: 300px; font-family: var(--font-body); color: var(--text-color); }
        .ql-snow .ql-picker-label { color: var(--text-color) !important; }

        #ai-status-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
            background-color: var(--error-color);
            box-shadow: 0 0 10px var(--error-color);
            transition: all 0.5s ease;
        }

        #ai-suggestions-box {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed var(--secondary-glow);
            border-radius: 5px;
            min-height: 50px;
            background: rgba(0,0,0,0.2);
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="assessment-container">
        <header>
            <h1>English Language Assessment</h1>
            <p>Conducted by: Mr. Kola</p>
        </header>

        <div id="instructions">
            <h2>Instructions</h2>
            <p>Welcome, students. Please read the following instructions carefully before you begin:</p>
            <ul>
                <li>Select your name from the dropdown to load your specific assignment.</li>
                <li>You will have <strong>45 minutes</strong> to complete the entire assessment.</li>
                <li><strong>CRITICAL:</strong> Do not leave this page or switch to another tab. If you do, your session will terminate, and you will lose access permanently.</li>
                <li>Answer all multiple-choice questions and complete the writing task.</li>
                <li>Your writing task must meet the minimum word count before the 'Submit' button is enabled.</li>
                <li>You may use the AI Assistant to check for spelling and grammar, but it will not write for you.</li>
            </ul>
        </div>

        <div id="student-selection">
            <label for="student-name">Initiate Assessment Protocol. Identify Yourself:</label>
            <select id="student-name">
                <option value="">-- Select Operative --</option>
                <option value="El Rohi">El Rohi</option>
                <option value="Kingspraise">Kingspraise</option>
            </select>
        </div>

        <div id="timer-container" class="hidden">
            <h2>Time Remaining: <span id="time" style="color: var(--primary-glow);">45:00</span></h2>
        </div>

        <form id="assessment-form" action="https://formspree.io/f/mldrbpwo" method="POST">
            <input type="hidden" id="student-name-hidden" name="student_name">
            <input type="hidden" id="writing-content-hidden" name="writing_content">

            <!-- El Rohi's Assignment -->
            <div id="el-rohi-assignment" class="hidden">
                <h2>Module: Argumentative Writing</h2>
                <div class="question-section">
                    <h3>Multiple Choice Questions</h3>
                    <div class="mcq-option">1. What is the formal term for the topic of a debate?
                        <br><input type="radio" name="elrohi_q1" value="a"> a) Argument <br><input type="radio" name="elrohi_q1" value="b"> b) Motion <br><input type="radio" name="elrohi_q1" value="c"> c) Stance
                    </div>
                    <div class="mcq-option">2. The "Vocative" in a debate refers to the:
                        <br><input type="radio" name="elrohi_q2" value="a"> a) Main arguments <br><input type="radio" name="elrohi_q2" value="b"> b) Introduction <br><input type="radio" name="elrohi_q2" value="c"> c) Greeting
                    </div>
                    <div class="mcq-option">3. Which group should be addressed first in a formal debate greeting?
                        <br><input type="radio" name="elrohi_q3" value="a"> a) Fellow Students <br><input type="radio" name="elrohi_q3" value="b"> b) Co-debaters <br><input type="radio" name="elrohi_q3" value="c"> c) Mr. Chairman
                    </div>
                    <div class="mcq-option">4. Persuasive words like "Furthermore" and "In addition" belong in which part of the debate?
                        <br><input type="radio" name="elrohi_q4" value="a"> a) The Body <br><input type="radio" name="elrohi_q4" value="b"> b) The Conclusion <br><input type="radio" name="elrohi_q4" value="c"> c) The Vocative
                    </div>
                    <div class="mcq-option">5. What is the purpose of a "Rebuttal"?
                        <br><input type="radio" name="elrohi_q5" value="a"> a) To summarize your points <br><input type="radio" name="elrohi_q5" value="b"> b) To explain why the opposing side is wrong <br><input type="radio" name="elrohi_q5" value="c"> c) To politely say "Thank you"
                    </div>
                    <div class="mcq-option">6. The example debate argues that the internet is a better source of information than:
                        <br><input type="radio" name="elrohi_q6" value="a"> a) Libraries <br><input type="radio" name="elrohi_q6" value="b"> b) Teachers <br><input type="radio" name="elrohi_q6" value="c"> c) Textbooks
                    </div>
                     <div class="mcq-option">7. One argument for the internet's superiority in the example is its:
                        <br><input type="radio" name="elrohi_q7" value="a"> a) Constant updates <br><input type="radio" name="elrohi_q7" value="b"> b) Cost-effectiveness <br><input type="radio" name="elrohi_q7" value="c"> c) Creative design
                    </div>
                </div>
                <div class="writing-section">
                    <h3>Writing Task</h3>
                    <p>Based on the lesson, write the introduction and two strong points for the **Opposing** side of the motion: "The Internet is a Better Source of Information than Textbooks". Ensure your writing is at least 100 words. (Hint: Think about "Fake News" or "Reliability").</p>
                </div>
            </div>

            <!-- Kingspraise's Assignment -->
            <div id="kingspraise-assignment" class="hidden">
                <h2>Module: Informal Letter Writing</h2>
                <div class="question-section">
                    <h3>Multiple Choice Questions</h3>
                    <div class="mcq-option">1. An informal letter is typically written to:
                        <br><input type="radio" name="kingspraise_q1" value="a"> a) A business manager <br><input type="radio" name="kingspraise_q1" value="b"> b) A government official <br><input type="radio" name="kingspraise_q1" value="c"> c) Friends and family
                    </div>
                    <div class="mcq-option">2. Where is the writer's address and date placed in an informal letter?
                        <br><input type="radio" name="kingspraise_q2" value="a"> a) Top left-hand corner <br><input type="radio" name="kingspraise_q2" value="b"> b) Top right-hand corner <br><input type="radio" name="kingspraise_q2" value="c"> c) Bottom of the page
                    </div>
                    <div class="mcq-option">3. The salutation (greeting) in an informal letter usually starts with:
                        <br><input type="radio" name="kingspraise_q3" value="a"> a) "To Whom It May Concern," <br><input type="radio" name="kingspraise_q3" value="b"> b) "Dear" followed by a first name <br><input type="radio" name="kingspraise_q3" value="c"> c) The recipient's full name and title
                    </div>
                    <div class="mcq-option">4. Which part of an informal letter is for exchanging pleasantries?
                        <br><input type="radio" name="kingspraise_q4" value="a"> a) The Body <br><input type="radio" name="kingspraise_q4" value="b"> b) The Conclusion <br><input type="radio" name="kingspraise_q4" value="c"> c) The Introduction
                    </div>
                    <div class="mcq-option">5. Using contractions like "I'm" and "don't" is:
                        <br><input type="radio" name="kingspraise_q5" value="a"> a) Encouraged to sound natural <br><input type="radio" name="kingspraise_q5" value="b"> b) Discouraged as it is too formal <br><input type="radio" name="kingspraise_q5" value="c"> c) Forbidden in all forms of writing
                    </div>
                     <div class="mcq-option">6. The "Subscription" is the part of the letter that includes:
                        <br><input type="radio" name="kingspraise_q6" value="a"> a) The main message <br><input type="radio" name="kingspraise_q6" value="b"> b) The closing, like "Yours sincerely," <br><input type="radio" name="kingspraise_q6" value="c"> c) The address of the recipient
                    </div>
                    <div class="mcq-option">7. The example letter is about a student's feelings regarding:
                        <br><input type="radio" name="kingspraise_q7" value="a"> a) Moving to a new country <br><input type="radio" name="kingspraise_q7" value="b"> b) Starting secondary school <br><input type="radio" name="kingspraise_q7" value="c"> c) A recent family holiday
                    </div>
                    <div class="mcq-option">8. To show excitement in an informal letter, it is appropriate to use:
                        <br><input type="radio" name="kingspraise_q8" value="a"> a) Exclamation marks (!) <br><input type="radio" name="kingspraise_q8" value="b"> b) Only formal language <br><input type="radio" name="kingspraise_q8" value="c"> c) Complex sentence structures
                    </div>
                </div>
                <div class="writing-section">
                    <h3>Writing Task</h3>
                    <p>Prompt: A heavy rain recently destroyed parts of your house. Write a letter to your brother who lives in another state, telling him what happened and how he can assist the family. Your letter must be at least 150 words and include an address, salutation, a descriptive body paragraph, and a polite request for help.</p>
                </div>
            </div>

            <div id="common-writing-area" class="hidden">
                <div id="writing-editor-container">
                    <!-- Quill Editor will be initialized here -->
                </div>
                <p>Word Count: <span id="word-count" style="color: var(--primary-glow);">0</span></p>

                <div>
                    <button type="button" id="analyze-btn">Analyze Writing</button>
                    <div id="ai-status-light"></div>
                </div>
                <div id="ai-suggestions-box">
                    <p>AI Suggestions will appear here.</p>
                </div>

                <button type="submit" id="submit-btn" disabled>Submit Assessment</button>
            </div>
        </form>
    </div>

    <!-- Quill.js Script -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const studentSelect = document.getElementById('student-name');
        const timerContainer = document.getElementById('timer-container');
        const elRohiAssignment = document.getElementById('el-rohi-assignment');
        const kingspraiseAssignment = document.getElementById('kingspraise-assignment');
        const commonWritingArea = document.getElementById('common-writing-area');
        const wordCountDisplay = document.getElementById('word-count');
        const submitBtn = document.getElementById('submit-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const aiStatusLight = document.getElementById('ai-status-light');
        const suggestionsBox = document.getElementById('ai-suggestions-box');
        const studentNameHidden = document.getElementById('student-name-hidden');
        const writingContentHidden = document.getElementById('writing-content-hidden');
        const instructionsBox = document.getElementById('instructions');

        let pageLocked = false;
        let minWords = 100;

        // Initialize Quill editor
        const quill = new Quill('#writing-editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'font': [] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'align': [] }],
                    ['blockquote']
                ]
            }
        });

        studentSelect.addEventListener('change', () => {
            const selectedStudent = studentSelect.value;
            if (selectedStudent) {
                studentNameHidden.value = selectedStudent;
                instructionsBox.style.display = 'none';

                if (selectedStudent === 'El Rohi') {
                    elRohiAssignment.classList.remove('hidden');
                    minWords = 100;
                } else if (selectedStudent === 'Kingspraise') {
                    kingspraiseAssignment.classList.remove('hidden');
                    minWords = 150;
                }
                commonWritingArea.classList.remove('hidden');
                studentSelect.disabled = true;
                timerContainer.classList.remove('hidden');
                startTimer(2700); // 45 minutes
            }
        });

        quill.on('text-change', () => {
            const text = quill.getText();
            writingContentHidden.value = quill.root.innerHTML; // Store formatted content
            const words = text.trim().split(/\s+/).filter(Boolean);
            wordCountDisplay.textContent = words.length;
            submitBtn.disabled = words.length < minWords;
        });

        analyzeBtn.addEventListener('click', async () => {
            const text = quill.getText();
            if (!text.trim()) {
                suggestionsBox.innerHTML = '<p>Cannot analyze empty text field.</p>';
                return;
            }

            suggestionsBox.innerHTML = '<p>Initializing AI analysis protocol...</p>';
            aiStatusLight.style.backgroundColor = 'var(--error-color)';
            aiStatusLight.style.boxShadow = '0 0 10px var(--error-color)';


            try {
                const response = await fetch('https://web-production-9a18.up.railway.app/api/llama/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: text,
                        systemPrompt: "You are an advanced AI writing assistant. Your task is to identify spelling and grammar errors in the provided text. Provide clear, constructive suggestions for improvement. Do not rewrite the text for the user. Begin your response with 'Analysis Complete.' If there are no errors, state: 'Analysis Complete. All systems clear. Your writing is good to go!'"
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    suggestionsBox.innerHTML = `<p>${data.content.replace(/\n/g, '<br>')}</p>`;
                    if (data.content.includes('All systems clear')) {
                        aiStatusLight.style.backgroundColor = 'var(--success-color)';
                        aiStatusLight.style.boxShadow = '0 0 10px var(--success-color)';
                    }
                } else {
                    suggestionsBox.innerHTML = '<p>Error: Could not complete analysis. Please try again.</p>';
                }
            } catch (error) {
                suggestionsBox.innerHTML = '<p>Connection Error: Could not connect to the AI assistant mainframe.</p>';
            }
        });

        function startTimer(duration) {
            let timer = duration;
            const timeDisplay = document.getElementById('time');
            const interval = setInterval(() => {
                let minutes = parseInt(timer / 60, 10);
                let seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                timeDisplay.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(interval);
                    timeDisplay.textContent = "Time Expired!";
                    document.getElementById('assessment-form').submit();
                }
            }, 1000);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && !pageLocked && studentSelect.disabled) {
                pageLocked = true;
                document.body.innerHTML = `<div style="text-align: center; padding-top: 20%;">
                                               <h1 style="color: var(--error-color); font-family: var(--font-main);">ACCESS REVOKED</h1>
                                               <p>You have navigated away from the assessment page. The session has been terminated.</p>
                                           </div>`;
            }
        });
    </script>
</body>
</html>
